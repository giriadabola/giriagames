<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- *** IMPORTANT: Verify this is the correct title *** -->
    <title>Mitos e Lendas - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* --- Your existing CSS styles go here --- */
        @import url(https://fonts.googleapis.com/css?family=Lato:400,700,900);

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f1a 100%);
            font-family: 'Lato', 'Segoe UI', sans-serif;
            overflow-x: hidden;
            color: #9E9E9E;
        }

        /* Loading Screen Styles */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            display: flex; /* Keep flex to center content */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
            text-align: center;
            transition: opacity 0.5s ease-out; /* Added for smooth fade out */
        }

         #loading-screen.hidden { /* Style to hide loading screen */
            opacity: 0;
            pointer-events: none;
         }

        .loading-spinner {
            border: 16px solid #2a2a4a;
            border-top: 16px solid #6c63ff;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .rules-container {
            max-width: 600px;
            background: linear-gradient(145deg, #3b3b5c, #1f1f30);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px #6c63ff;
            margin-bottom: 20px;
            max-height: 60vh;
            overflow-y: auto;
            color: white;
        }

        .rules-container h2 {
            color: #6c63ff;
            margin-bottom: 15px;
            font-size: 24px;
            text-align: center;
        }

        .rules-container p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #9E9E9E;
        }

        .rules-container ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .rules-container li {
            margin-bottom: 8px;
            line-height: 1.5;
            color: #9E9E9E;
        }

        /* Bottom Menu Styles */
        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(145deg, #3b3b5c, #1f1f30);
            box-shadow: 0 -2px 10px rgba(108, 99, 255, 0.2);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #9E9E9E;
            transition: color 0.3s ease;
        }

        .menu-item:hover, .menu-item.active {
            color: #6c63ff;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #6c63ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(108, 99, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover, .menu-item.active .empire-icon {
            color: #5a52cc;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(108, 99, 255, 0.6));
        }

        /* Content Styles */
        .content {
            padding: 20px;
            margin-bottom: 80px; /* Make space for bottom menu */
            display: none; /* Initially hidden */
            opacity: 0; /* Start transparent */
            transition: opacity 0.5s ease-in; /* Smooth fade in */
        }

        .content.visible { /* Style to show content */
             display: block;
             opacity: 1;
        }

        .myths-header {
            text-align: center;
            margin-bottom: 30px;
            color: #6c63ff;
        }

        /* Pack and Card Styles */
        .glow {
            text-shadow: 0 0 10px #fff, 0 0 20px #6c63ff, 0 0 30px #6c63ff;
        }

        .pack-container {
            background: linear-gradient(145deg, #3b3b5c, #1f1f30);
            position: relative;
            width: 200px;
            height: 300px;
            cursor: pointer;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 0 10px #6c63ff;
            z-index: 10;
            transition: opacity 0.5s ease;
            margin: 0 auto; /* Center the pack */
        }

        .pack-top, .pack-bottom {
            background: transparent;
            width: 100%;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
            transition: transform 1s ease, opacity 1s ease, clip-path 0.5s ease;
            color: white;
        }

        .pack-top { top: 0; z-index: 10; }
        .pack-bottom { bottom: 0; }

        .separar .pack-top {
            clip-path: polygon(0 0, 100% 0, 100% 70%, 95% 68%, 90% 72%, 85% 68%, 80% 72%, 75% 68%, 70% 72%, 65% 68%, 60% 72%, 55% 68%, 50% 72%, 45% 68%, 40% 72%, 35% 68%, 30% 72%, 25% 68%, 20% 72%, 15% 68%, 10% 72%, 5% 68%, 0 70%);
            transform: translateY(-120%);
            opacity: 0;
        }

        .separar .pack-bottom {
            clip-path: polygon(0 30%, 5% 32%, 10% 28%, 15% 32%, 20% 28%, 25% 32%, 30% 28%, 35% 32%, 40% 28%, 45% 32%, 50% 28%, 55% 32%, 60% 28%, 65% 32%, 70% 28%, 75% 32%, 80% 28%, 85% 32%, 90% 28%, 95% 32%, 100% 30%, 100% 100%, 0 100%);
            transform: translateY(120%);
            opacity: 0;
        }

        .esconder-pack {
            opacity: 0;
            pointer-events: none;
        }

        .flash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.9), rgba(255,255,255,0));
            opacity: 0;
            pointer-events: none;
            z-index: 60;
        }

        .flash-overlay.active {
            animation: overlayFlash 1s ease-out forwards;
        }

        @keyframes overlayFlash {
            0% { opacity: 0; }
            20% { opacity: 1; }
            100% { opacity: 0; }
        }

        .card-reveal {
            width: 200px;
            height: 300px;
            position: absolute;
            /* Adjust positioning relative to pack if needed */
            top: 0; /* Match pack's top */
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: none; /* Start hidden */
            opacity: 0;
            transition: opacity 1s ease, transform 1s ease;
        }

        @keyframes cardAppear {
            0% {
                opacity: 0;
                transform: translateX(-50%) scale(0.5) rotateX(90deg);
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.05) rotateX(0deg);
            }
            100% {
                transform: translateX(-50%) scale(1) rotateX(0deg);
            }
        }

        .card-reveal.visible {
            display: block !important; /* Override display: none */
            opacity: 1 !important; /* Ensure visibility */
            animation: cardAppear 0.6s ease-out forwards;
        }

        .card-reveal::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.2) 40%, transparent 80%);
            opacity: 0;
            animation: cardFlash 1s ease-out forwards;
            z-index: 25;
            pointer-events: none;
            border-radius: 1rem;
        }

        @keyframes cardFlash {
            0% {
                opacity: 0;
                transform: scale(0.7) rotate(0deg);
            }
            40% {
                opacity: 1;
                transform: scale(1.2) rotate(5deg);
            }
            60% {
                opacity: 0.8;
                transform: scale(1.1) rotate(-3deg);
            }
            100% {
                opacity: 0;
                transform: scale(1) rotate(0deg);
            }
        }

        .clash-card {
            background: white;
            border-radius: 14px;
            position: relative;
            text-align: center;
            box-shadow: -1px 10px 20px -8px black;
            z-index: 1;
            user-select: none;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .clash-card__image {
            position: relative;
            height: 130px;
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
            flex-shrink: 0;
            overflow: hidden;
            z-index: 1;
        }

        /* --- Make sure image URLs are correct --- */
        .clash-card__image--barbarian {
            background: url('https://lh3.googleusercontent.com/pw/AP1GczNA063OCb5YBT5mK-fpMEDjHHKVUr6AzXf2GiB8DxLYXp6gwOmIJFcARm3nO2Uuf54iQAjPVelEFKwpz9CWQhNDgAQy7qhWUdoSV3716jH4T9XXi0-AyVncLgdOawTeku5nxk-In2b44GovI9blgHtO=w880-h880-s-no-gm?authuser=1'); /* Example Image - Verify */
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 60%, rgba(0, 0, 0, 0) 100%);
            -webkit-mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 60%, rgba(0, 0, 0, 0) 100%);
        }

        .character-image {
            position: absolute;
            width: 400px;
            top: -93px;
            left: 50%;
            transform: translateX(-50%) scale(0.6);
            z-index: 5;
            pointer-events: none;
            filter: brightness(1.8);
        }

        @keyframes wave {
            0% { transform: rotateZ(0deg) translate3d(0, 10%, 15px) rotateZ(0deg); }
            100% { transform: rotateZ(360deg) translate3d(0, 10%, 15px) rotateZ(-360deg); }
        }

        .background_image-smoke-cloud1,
        .background_image-smoke-cloud2,
        .background_image-smoke-cloud3 {
            position: absolute;
            opacity: 0.4;
            max-width: 70%;
            z-index: 2;
            pointer-events: none;
        }

        .background_image-smoke-cloud1 { animation: wave 8s 0.1s infinite linear; right: 40%; bottom: -10%; }
        .background_image-smoke-cloud2 { animation: wave 9s 0.1s infinite linear; left: -10%; bottom: -15%; }
        .background_image-smoke-cloud3 { animation: wave 10s 0.1s infinite linear; right: -10%; bottom: -25%; }

        .clash-card__image img.smoke-image { opacity: 0.7; max-width: 90%; }

        .fog {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            overflow: hidden;
            pointer-events: none;
            z-index: 3;
        }

        .fog span {
            position: absolute;
            bottom: 0;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
            filter: blur(10px);
            animation: fogRise 5s linear infinite;
            animation-delay: calc(-1s * var(--i));
            left: calc(var(--i) * 25%);
        }

        .fog span:nth-child(1) { --i: 1; }
        .fog span:nth-child(2) { --i: 2; }
        .fog span:nth-child(3) { --i: 3; }

        @keyframes fogRise {
            0% { transform: translateY(0) scale(1); opacity: 0.3; }
            50% { opacity: 0.5; }
            100% { transform: translateY(-80px) scale(1.4); opacity: 0; }
        }

        .clash-card__level {
            text-transform: uppercase;
            font-size: 10px;
            font-weight: 700;
            margin-bottom: 2px;
            padding-top: 5px;
            flex-shrink: 0;
        }

        .clash-card__level--barbarian {
            color: #003366;
        }

        .clash-card__unit-name {
            font-size: 18px;
            color: black;
            font-weight: 900;
            margin-bottom: 3px;
            flex-shrink: 0;
        }

        .clash-card__unit-description {
            font-size: 11px;
            padding: 5px 10px;
            margin-bottom: 5px;
            flex-grow: 1;
            overflow: hidden;
            color: #444;
        }

        .clash-card__unit-stats {
            position: relative;
            color: white;
            font-weight: 700;
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
            z-index: 2;
            flex-shrink: 0;
            margin-top: auto;
        }

        .clash-card__unit-stats--barbarian {
            background: linear-gradient(to bottom, #001a33, #003366);
        }

        .clash-card__unit-stats .one-quarter {
            width: 25%;
            float: left;
            padding: 8px 5px;
            border-right: 1px solid #004d99;
            text-align: center;
        }

        .clash-card__unit-stats .one-quarter.no-border {
            border-right: none;
        }

        .clash-card__unit-stats .one-quarter img {
            width: 28px;
            height: 28px;
            display: block;
            margin: 0 auto;
        }

        .clearfix:after {
            visibility: hidden;
            display: block;
            font-size: 0;
            content: " ";
            clear: both;
            height: 0;
        }

        /* Hide pack parts when animation starts */
        #pack.sumir-pack .pack-top,
        #pack.sumir-pack .pack-bottom {
            display: none !important;
        }

        .myths-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .myth-card {
            background: linear-gradient(145deg, #3b3b5c, #1f1f30);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px #6c63ff;
            transition: transform 0.3s ease;
        }

        .myth-card:hover {
            transform: translateY(-5px);
        }

        .myth-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .myth-content {
            padding: 15px;
        }

        .myth-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #6c63ff;
        }

        .myth-description {
            font-size: 14px;
            color: #9E9E9E;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .myth-familia {
            font-size: 14px;
            color: #6c63ff;
            font-weight: bold;
        }

        .myth-casta {
            font-size: 14px;
            color: #9E9E9E;
            font-style: italic;
        }

         /* Offline/Error Message Styling */
        .message-banner {
            background: linear-gradient(145deg, #5c3b3b, #301f1f); /* Reddish gradient for errors */
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .message-banner.offline {
             background: linear-gradient(145deg, #3b3b5c, #1f1f30); /* Original darker gradient for offline */
        }
        .message-banner h3 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #ff6b6b; /* Brighter red for error titles */
        }
        .message-banner.offline h3 {
             color: #6c63ff; /* Purple for offline title */
        }
        .message-banner p {
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
        }
        .message-banner button {
            padding: 0.5rem 1rem;
            background-color: #6c63ff;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .message-banner button:hover {
            background-color: #5a52cc;
        }
        .message-banner.offline button {
            background-color: #4a4a7a;
        }
         .message-banner.offline button:hover {
             background-color: #3a3a6a;
         }

    </style>
    <!-- Removed the first script block -->
</head>
<body class="text-white">
    <!-- Loading Screen with Rules -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="rules-container">
            <h2>Regras do Mitos e Lendas</h2>
            <p>Bem-vindo ao Mitos e Lendas...</p>
            <!-- Rest of rules content -->
             <ul>
                <li><strong>Famílias:</strong> Os mitos são organizados em famílias, que representam diferentes mitologias e lendas do mundo.</li>
                <li><strong>Castas:</strong> Dentro de cada família, existem diferentes castas que determinam a raridade e poder dos mitos.</li>
                <li><strong>Coleção:</strong> Colecione mitos para completar famílias e ganhar bônus especiais.</li>
                <li><strong>Pontos:</strong> Cada mito possui pontos que contribuem para sua classificação no ranking.</li>
                <li><strong>Batalhas:</strong> Use seus mitos em batalhas contra outros jogadores para ganhar recompensas.</li>
                <li><strong>Equipes:</strong> Forme equipes com mitos compatíveis para aumentar seu poder em batalhas.</li>
            </ul>
            <p>Explore o mundo dos mitos, descubra lendas raras e torne-se o maior colecionador do G EMPIRE!</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="content" id="main-content"> <!-- Added ID for easier selection -->
        <div class="myths-header">
            <h1 class="text-5xl font-bold glow">Mitos e Lendas</h1>
            <p class="mt-2 text-lg text-gray-300">Explore o mundo dos mitos e lendas, colecione e batalhe com criaturas míticas de diversas culturas.</p>
        </div>

        <!-- Pack and Card Section -->
        <section class="flex flex-col justify-start items-center h-[80vh] relative overflow-visible mb-10">
            <div class="pack-container" id="pack">
                 <!-- *** IMPORTANT: Verify background image URLs are correct *** -->
                <div class="pack-top" style="background: url('https://lh3.googleusercontent.com/pw/AP1GczMH8UvxqDwObtdJAz-fCT0v7EfKUrQzULQ9KlcMg3Mr4ZphFntPuH0I1D-3ONaMT79KMGX2mUdkKFNpZN_iOEy3Rhm5_sPMY-jvD2JC2cpxmTDY1fEm_Irsl406n5LI-aUf-8RPHYSTG_6weRa_fMxE=w1005-h880-s-no-gm?authuser=1') center/cover no-repeat;"></div>
                <div class="pack-bottom" style="background: url('https://lh3.googleusercontent.com/pw/AP1GczMEI-1B21mGHy90cqyjoOoYvT9vFK_ZMCd9P3KnluBCD8jaXIfrWSq8Sb5hbXucTkJihmW-PB9dNDiHur0QTtSB9N9_OkFkFJZemZKPrEd7q_4u6ihVD2u0TcccgAN9Yz-BK1zfo7cj8_A9mVrinw3L=w1005-h880-s-no-gm?authuser=1') center/cover no-repeat;"></div>
                <div class="flash-overlay" id="flashOverlay"></div>
            </div>

            <div class="card-reveal" id="cardReveal">
                <div class="clash-card barbarian">
                    <div class="clash-card__image clash-card__image--barbarian">
                        <!-- Smoke images -->
                        <img class="background_image-smoke-cloud1 smoke-image" alt="smoke-image1" src="https://oleksandrpavlyshch.github.io/mouse-move-parallax_demo/img/smoke1.png">
                        <img class="background_image-smoke-cloud2 smoke-image" alt="smoke-image2" src="https://oleksandrpavlyshch.github.io/mouse-move-parallax_demo/img/smoke2.png">
                        <img class="background_image-smoke-cloud3 smoke-image" alt="smoke-image3" src="https://oleksandrpavlyshch.github.io/mouse-move-parallax_demo/img/smoke3.png">
                        <div class="fog">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                     <!-- *** IMPORTANT: Verify character image URL is correct *** -->
                    <img class="character-image" src="https://lh3.googleusercontent.com/pw/AP1GczPUZxjjsZ6pv7IJPlquYN-JLrF_TV0R8UjCCj2oXFSeSADerByiUsbTVrW_V3h3OjCufazT1IojeZz7MBSsJfLDcfRoadQR_22HuZL84HInetcwMrpty9AJZZKyfjMSXl0v5GEUngR6NdGK9UDpSMsD=w587-h880-s-no-gm?authuser=1" alt="Character" />
                    <div class="clash-card__level clash-card__level--barbarian">Guulyn</div>
                    <div class="clash-card__unit-name">RAMA BOOWLY</div>
                    <div class="clash-card__unit-description">
                        Esta raça é conhecida pela astúcia e precisão na selva.
                    </div>
                    <div class="clash-card__unit-stats clash-card__unit-stats--barbarian clearfix">
                        <!-- *** IMPORTANT: Verify icon image URLs are correct *** -->
                        <div class="one-quarter"><img src="https://sortitoutsi.b-cdn.net/uploads/team/97207966.png" alt="Training Icon"></div>
                        <div class="one-quarter"><img src="https://sortitoutsi.b-cdn.net/uploads/team/5627098.png" alt="Speed Icon"></div>
                        <div class="one-quarter"><img src="https://sortitoutsi.b-cdn.net/uploads/team/23078012.png" alt="Cost Icon"></div>
                        <div class="one-quarter no-border"><img src="https://sortitoutsi.b-cdn.net/uploads/team/23199255.png" alt="Attack Icon"></div>
                    </div>
                </div> <!-- end clash-card barbarian -->
            </div> <!-- end card-reveal -->
        </section>

        <div class="myths-grid" id="myths-grid">
            <!-- Mitos serão carregados dinamicamente aqui -->
        </div>
    </main>

    <!-- Bottom Menu -->
    <nav class="bottom-menu">
        <a href="1x.html" class="menu-item"> <i class="fas fa-home"></i> </a>
        <a href="market.html" class="menu-item"> <i class="fas fa-shopping-cart"></i> </a>
        <a href="team.html" class="menu-item"> <i class="fas fa-users"></i> </a>
        <a href="empire.html" class="menu-item"> <i class="fas fa-landmark empire-icon"></i> </a>
        <a href="rankings.html" class="menu-item"> <i class="fas fa-list"></i> </a>
        <a href="profile.html" class="menu-item"> <i class="fas fa-user"></i> </a>
    </nav>

    <!-- Firebase Scripts -->
       <!-- Firebase Scripts -->
       <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getFirestore, collection, getDocs, doc, getDoc, query, where, enableIndexedDbPersistence, terminate
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // *** IMPORTANTE: VERIFIQUE SE ESTA É A CONFIGURAÇÃO CORRETA PARA O SEU PROJETO ***
        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0", // Da sua segunda script
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.appspot.com", // Verifique se é o nome correto do storage bucket
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD" // Opcional: Só se usar Analytics
        };

        let db;
        let auth;
        let app;

        try {
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // --- Habilitar Persistência Offline ---
            enableIndexedDbPersistence(db)
                .then(() => {
                    console.log("Persistência offline habilitada.");
                })
                .catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.warn("Persistência offline falhou: múltiplas abas abertas?");
                    } else if (err.code == 'unimplemented') {
                        console.warn("Persistência offline falhou: navegador não suportado.");
                    } else {
                         console.error("Erro ao habilitar persistência offline:", err);
                    }
                });

        } catch (error) {
            console.error("Erro Crítico ao Inicializar Firebase:", error);
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) loadingScreen.classList.add('hidden');
            if (db) {
                terminate(db).catch(e => console.error("Failed to terminate Firestore", e));
            }
        }

        // --- Dados de Fallback ---
        const mitosFallback = [
             { id: "fb1", nome: "Rama Boowly (Offline)", descricao: "Esta raça é conhecida pela astúcia e precisão na selva.", familia: "Guulyn", casta: "Lendário", imagem: "https://lh3.googleusercontent.com/pw/AP1GczNA063OCb5YBT5mK-fpMEDjHHKVUr6AzXf2GiB8DxLYXp6gwOmIJFcARm3nO2Uuf54iQAjPVelEFKwpz9CWQhNDgAQy7qhWUdoSV3716jH4T9XXi0-AyVncLgdOawTeku5nxk-In2b44GovI9blgHtO=w880-h880-s-no-gm" },
             { id: "fb2", nome: "Poseidon (Offline)", descricao: "Deus dos mares e terremotos na mitologia grega.", familia: "Olímpica", casta: "Divino", imagem: "https://lh3.googleusercontent.com/pw/AP1GczPUZxjjsZ6pv7IJPlquYN-JLrF_TV0R8UjCCj2oXFSeSADerByiUsbTVrW_V3h3OjCufazT1IojeZz7MBSsJfLDcfRoadQR_22HuZL84HInetcwMrpty9AJZZKyfjMSXl0v5GEUngR6NdGK9UDpSMsD=w587-h880-s-no-gm" },
             { id: "fb3", nome: "Thor (Offline)", descricao: "Deus do trovão na mitologia nórdica, conhecido por seu martelo Mjölnir.", familia: "Aesir", casta: "Divino", imagem: "https://lh3.googleusercontent.com/pw/AP1GczMH8UvxqDwObtdJAz-fCT0v7EfKUrQzULQ9KlcMg3Mr4ZphFntPuH0I1D-3ONaMT79KMGX2mUdkKFNpZN_iOEy3Rhm5_sPMY-jvD2JC2cpxmTDY1fEm_Irsl406n5LI-aUf-8RPHYSTG_6weRa_fMxE=w1005-h880-s-no-gm" }
        ];

        // --- Elementos do DOM ---
        const loadingScreen = document.getElementById('loading-screen');
        const content = document.getElementById('main-content');
        const mythsGrid = document.getElementById('myths-grid');
        const pack = document.getElementById('pack');
        const cardReveal = document.getElementById('cardReveal');
        const flashOverlay = document.getElementById('flashOverlay');

        // Elementos do menu inferior
        const bottomMenuHome = document.querySelector('a[href="1x.html"]');
        const bottomMenuMarket = document.querySelector('a[href="market.html"]');
        const bottomMenuTeam = document.querySelector('a[href="team.html"]');
        const bottomMenuEmpire = document.querySelector('a[href="empire.html"]');
        const bottomMenuRankings = document.querySelector('a[href="rankings.html"]');
        const bottomMenuProfile = document.querySelector('a[href="profile.html"]');


        // --- Funções Auxiliares ---

        // Função para pré-carregar imagens dentro de um elemento
        function preloadImages(containerElement) {
            const images = containerElement.querySelectorAll('img');
            const promises = [];

            if (images.length === 0) {
                 return Promise.resolve(); // Nenhuma imagem IMG para carregar
            }

            images.forEach(img => {
                const promise = new Promise((resolve) => { // Não precisamos de reject aqui
                    if (img.complete) {
                        // console.log(`Imagem já completa: ${img.src}`);
                        resolve();
                    } else {
                        img.onload = () => {
                            // console.log(`Imagem carregada: ${img.src}`);
                            resolve();
                        };
                        img.onerror = () => {
                            console.error(`Erro ao carregar imagem: ${img.src}`);
                            // Resolve mesmo com erro para não bloquear a UI
                            resolve();
                        };
                    }
                });
                promises.push(promise);
            });

            return Promise.all(promises);
        }


        // Função para criar um card de mito
        function createMythCard(mito) {
            const card = document.createElement('div');
            card.className = 'myth-card';
            const imageUrl = mito.imagem || 'placeholder.png';
            const nome = mito.nome || 'Nome Indisponível';
            const descricao = mito.descricao || 'Sem descrição.';
            const familia = mito.familia || 'Desconhecida';
            const casta = mito.casta || 'Comum';

            card.innerHTML = `
                <img src="${imageUrl}" alt="${nome}" class="myth-image" onerror="this.onerror=null; this.src='placeholder.png';">
                <div class="myth-content">
                    <h3 class="myth-title">${nome}</h3>
                    <p class="myth-description">${descricao}</p>
                    <p class="myth-familia">Família: ${familia}</p>
                    <p class="myth-casta">Casta: ${casta}</p>
                </div>
            `;
            return card;
        }

        // Função para carregar mitos do Firebase
        async function loadMitos() {
            if (!db) {
                 console.error("Firestore DB not initialized. Cannot load mitos.");
                 loadFallbackMitos("Base de dados indisponível.");
                 return;
            }
            if (!auth.currentUser) {
                console.warn("User not authenticated when trying to load mitos.");
                return;
            }

            mythsGrid.innerHTML = '<div class="loading-spinner mx-auto mt-10"></div>';

            try {
                const mitosRef = collection(db, 'mitos');
                const q = query(mitosRef, where('ativo', '==', true), where('visivel', '==', true));
                const snapshot = await getDocs(q);

                mythsGrid.innerHTML = ''; // Limpa o spinner

                if (snapshot.empty) {
                     console.info('Nenhum mito encontrado que corresponda aos critérios.');
                     // Nenhuma mensagem é exibida na grid aqui intencionalmente
                    return;
                }

                snapshot.forEach(doc => {
                    const mito = { id: doc.id, ...doc.data() };
                    const card = createMythCard(mito);
                    mythsGrid.appendChild(card);
                });
                 console.log("Mitos carregados do Firebase com sucesso.");

            } catch (error) {
                console.error('Erro ao carregar mitos do Firebase:', error);
                mythsGrid.innerHTML = ''; // Limpa o spinner/grid

                let reason = 'Erro desconhecido.';
                if (error.code === 'permission-denied') {
                    console.error('-> Permissão negada para acessar mitos.');
                    reason = 'Permissão negada.';
                } else if (error.code === 'unavailable') {
                     console.warn('-> Servidor indisponível. Tentando carregar dados offline...');
                    reason = 'Servidor indisponível / offline.';
                }

                loadFallbackMitos(`Exibindo dados de fallback devido a: ${reason}`);
            }
        }

        // Função para carregar mitos de fallback
        function loadFallbackMitos(reason) {
             console.warn(`Carregando mitos de fallback: ${reason}`);
             mythsGrid.innerHTML = ''; // Limpa a grid antes de adicionar fallback
             if (mitosFallback.length === 0) {
                 mythsGrid.innerHTML = '<p class="text-center text-gray-400 mt-4">Nenhum dado de fallback disponível.</p>';
                 return;
             }
             mitosFallback.forEach(mito => {
                 const card = createMythCard(mito);
                 mythsGrid.appendChild(card);
             });
        }

        // Função para carregar configurações do menu do Firebase
        async function loadMenuSettings(userId) {
            if (!db) {
                 console.error("Firestore DB not initialized for menu settings.");
                 return;
            }
            try {
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    console.log("Configurações do menu carregadas:", userData);

                    if (bottomMenuHome) bottomMenuHome.style.display = userData.menuHome ?? true ? 'flex' : 'none';
                    if (bottomMenuMarket) bottomMenuMarket.style.display = userData.menuMarket ?? true ? 'flex' : 'none';
                    if (bottomMenuTeam) bottomMenuTeam.style.display = userData.menuTeam ?? true ? 'flex' : 'none';
                    if (bottomMenuEmpire) bottomMenuEmpire.style.display = userData.menuEmpire ?? true ? 'flex' : 'none';
                    if (bottomMenuRankings) bottomMenuRankings.style.display = userData.menuRankings ?? true ? 'flex' : 'none';
                    if (bottomMenuProfile) bottomMenuProfile.style.display = userData.menuProfile ?? true ? 'flex' : 'none';
                } else {
                    console.warn("Documento de usuário não encontrado para configurações do menu. Usando padrões.");
                     if (bottomMenuHome) bottomMenuHome.style.display = 'flex';
                     if (bottomMenuMarket) bottomMenuMarket.style.display = 'flex';
                     if (bottomMenuTeam) bottomMenuTeam.style.display = 'flex';
                     if (bottomMenuEmpire) bottomMenuEmpire.style.display = 'flex';
                     if (bottomMenuRankings) bottomMenuRankings.style.display = 'flex';
                     if (bottomMenuProfile) bottomMenuProfile.style.display = 'flex';
                }
            } catch (error) {
                console.error('Erro ao carregar configurações do menu:', error);
            }
        }

        // Função para animar a revelação do pack
        function animatePackReveal() {
            if (!pack || !cardReveal || !flashOverlay) {
                 console.error("Elementos do pack/card não encontrados para animar.");
                 return;
             }

            // Inicia animações do pack e flash
            pack.classList.add('separar');
            flashOverlay.classList.add('active');

            // Atraso ANTES de começar a LÓGICA de exibição do card
            setTimeout(async () => { // Tornamos a função do setTimeout async
                pack.classList.add('sumir-pack'); // Faz o pack desaparecer

                // 1. Torna o container do card visível no layout (display: block)
                //    e garante que está invisível (opacity 0) antes da animação
                cardReveal.style.display = 'block';
                cardReveal.style.opacity = '0';

                try {
                    // 2. ESPERA pelo carregamento de todas as <img> dentro do cardReveal
                    // console.log("Iniciando pré-carregamento das imagens do card...");
                    await preloadImages(cardReveal);
                    // console.log("Pré-carregamento das imagens do card concluído.");

                    // 3. SÓ DEPOIS que todas as imagens carregaram (ou deram erro):
                    //    Adiciona a classe para iniciar a animação de aparecimento
                    requestAnimationFrame(() => {
                       cardReveal.style.opacity = ''; // Remove o override de opacidade
                       cardReveal.classList.add('visible');
                    });

                } catch (error) {
                    console.error("Erro inesperado durante o pré-carregamento de imagens:", error);
                    // Mesmo com erro, tenta mostrar o card
                     requestAnimationFrame(() => {
                       cardReveal.style.opacity = '';
                       cardReveal.classList.add('visible');
                    });
                }

                // Reset do flash (opcional)
                flashOverlay.classList.remove('active');
                // void flashOverlay.offsetWidth; // Necessário se for reativar a animação do flash
                // flashOverlay.classList.add('active');

            }, 500); // Atraso de 0.5s ANTES de iniciar o carregamento das imagens do card
        }

         // --- Inicialização e Lógica de Autenticação ---
         function initializeAppLogic() {
             if (!auth) {
                 console.error("Firebase Auth not initialized.");
                 if (loadingScreen) loadingScreen.classList.add('hidden');
                 return;
             }

             onAuthStateChanged(auth, (user) => {
                 if (user) {
                     // Utilizador está logado
                     console.log("Usuário autenticado:", user.uid);
                     loadMenuSettings(user.uid);
                     loadMitos();

                     if (loadingScreen) loadingScreen.classList.add('hidden');
                     if (content) content.classList.add('visible');

                 } else {
                     // Utilizador está deslogado
                     console.log("Nenhum usuário autenticado. Redirecionando para login...");
                     window.location.href = 'index.html'; // Certifique-se que 'index.html' é a sua página de login
                 }
             });

              // --- Event Listeners ---
              if (pack) {
                 pack.addEventListener('click', animatePackReveal);
              } else {
                 console.warn("Elemento #pack não encontrado para adicionar listener.");
              }
         }

        // Garante que o DOM está pronto antes de executar a lógica principal
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic();
        });

    </script>
</body>
</html>
