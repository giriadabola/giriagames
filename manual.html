<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual - Ggames</title>
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEiIbiLnCB/s320/soccer-ball-png.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; overflow-x: hidden; }
        .content-wrapper { padding-bottom: 80px; }
        .bottom-menu { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 32px; align-items: center; z-index: 1000; }
        .menu-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; }
        .menu-item.active { color: #2176ff; font-weight: bold; }
        .menu-item i { font-size: 24px; margin-bottom: 4px; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; display: flex; justify-content: center; align-items: center; z-index: 2001; }
        .loading-spinner { border: 16px solid #f3f3f3; border-top: 16px solid #3498db; border-radius: 50%; width: 120px; height: 120px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1100;
            display: flex;
            align-items: center;
            background-color: #fff;
            padding: 10px 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #menu-toggle-btn { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: #333; margin-right: 15px; }
        .main-header h1 { font-size: 1.5em; color: #333; margin: 0; cursor: pointer; }
        .manual-container { padding-top: 58px; display: flex; height: calc(100vh - 58px); }
        #manual-nav { flex: 0 0 300px; background: #fff; padding: 15px; overflow-y: auto; border-right: 1px solid #e0e0e0; transition: transform 0.3s ease-in-out; }
        #manual-nav ul { list-style: none; padding: 0; }
        #manual-nav ul ul { padding-left: 20px; }
        .list-item-header { display: flex; align-items: center; gap: 5px; padding: 10px; cursor: pointer; border-radius: 5px; }
        .toggle-icon { transition: transform 0.2s ease-in-out; width: 16px; text-align: center; }
        .list-item.collapsed > .list-item-header .toggle-icon { transform: rotate(-90deg); }
        .list-item.collapsed > ul { display: none; }
        .item-title { flex-grow: 1; }
        .nav-item.active { background-color: #e7f5ff !important; color: #2176ff; font-weight: bold; }
        .list-item-header:not(.active):hover { background-color: #f5f5f5; }
        #manual-content { flex: 1; padding: 25px; overflow-y: auto; background: #f9f9f9; }
        #content-body { line-height: 1.6; color: #333; }
        #content-body h1, #content-body h2, #content-body h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: #222; }
        #content-body p { margin-bottom: 1em; }
        #content-body img { max-width: 100%; height: auto; vertical-align: middle; margin: 0 0.3em; }
        manual-link { color: #2176ff; text-decoration: underline; cursor: pointer; font-weight: bold; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 15px; transition: background-color 0.3s ease; }
        .modal-backdrop.has-opaque-background { background-color: rgba(0,0,0,0.6); }
        .modal-backdrop.has-translucent-background { background-color: rgba(0,0,0,0.1); }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
        .modal-backdrop.is-underneath .modal-content { transform: scale(0.95); opacity: 0.3; }
        .topic-pickcards-container { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .topic-pickcards-container h4 { margin-top: 0; margin-bottom: 10px; font-size: 1em; color: #555; }
        .topic-pickcard { display: inline-block; background-color: #e7f5ff; color: #2176ff; padding: 8px 12px; border-radius: 20px; text-decoration: none; margin-right: 8px; margin-bottom: 8px; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease; }
        .topic-pickcard:hover { background-color: #d0eaff; }
        .topic-content-block { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .topic-content-block h3 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .element-content-block { border-left: 3px solid #e0eafc; padding-left: 15px; margin-top: 20px; margin-left: 5px; }
        .element-content-block h4 { margin-top: 0; margin-bottom: 10px; color: #333; }
        .search-bar-container { position: relative; margin: 25px 0; }
        .search-bar-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }
        #manual-search-input { width: 100%; padding: 12px 15px 12px 45px; font-size: 1em; border: 1px solid #ddd; border-radius: 25px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        #manual-search-input:focus { border-color: #2176ff; box-shadow: 0 0 0 3px rgba(33, 118, 255, 0.1); }
        #search-results-container { margin-top: 15px; }
        .search-result-item { background-color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0; cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s; }
        .search-result-item:hover { border-color: #2176ff; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .search-result-title { font-weight: bold; color: #2176ff; margin: 0 0 8px 0; }
        .search-result-snippet { font-size: 0.9em; color: #555; line-height: 1.5; }
        .search-highlight { background-color: #fff3cd; font-weight: bold; color: #664d03; border-radius: 3px; padding: 1px 3px; }
        #faq-container { margin-top: 40px; }
        #faq-container h3 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.4em; }
        .faq-item { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .faq-question { width: 100%; background: none; border: none; text-align: left; padding: 15px; font-size: 1.1em; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #333; }
        .faq-icon { transition: transform 0.3s ease; }
        .faq-item.active .faq-icon { transform: rotate(45deg); }
        .faq-answer { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #fafafa; }
        .faq-answer-content { padding: 0 20px 20px 20px; color: #555; line-height: 1.7; }
        
        @media (max-width: 768px) {
            body.modal-open { overflow: hidden; }
            .manual-container { display: block; height: auto; }
            #menu-toggle-btn { display: block; }
            #manual-nav { position: fixed; top: 0; left: 0; width: 280px; height: 100%; z-index: 1500; transform: translateX(-100%); border-right: 1px solid #ccc; }
            body.nav-open #manual-nav { transform: translateX(0); }
            body.nav-open .mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1400; }
            #manual-content { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="loading-screen"><div class="loading-spinner"></div></div>
    <div id="main-content-wrapper" style="display: none;">
        <div class="content-wrapper">
            <header class="main-header">
                <button id="menu-toggle-btn"><i class="fas fa-bars"></i></button>
                <h1>Manual</h1>
            </header>
            <div class="manual-container">
                <aside id="manual-nav"></aside>
                <main id="manual-content">
                    <!-- O conteúdo aqui será gerado dinamicamente -->
                </main>
            </div>
        </div>
        <div class="mobile-overlay" id="mobile-overlay"></div>
        <nav class="bottom-menu">
            <a href="1x.html" class="menu-item"><i class="fas fa-home"></i></a>
            <a href="market.html" class="menu-item"><i class="fas fa-shopping-cart"></i></a>
            <a href="team.html" class="menu-item"><i class="fas fa-users"></i></a>
            <a href="empire.html" class="menu-item"><i class="fas fa-landmark"></i></a>
            <a href="rankings.html" class="menu-item"><i class="fas fa-list"></i></a>
            <a href="profile.html" class="menu-item"><i class="fas fa-user"></i></a>
        </nav>
    </div>
    <div id="modal-template" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"></h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>

<script src="config.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loadingScreen = document.getElementById('loading-screen');
    const mainContentWrapper = document.getElementById('main-content-wrapper');
    const navContainer = document.getElementById('manual-nav');
    const manualContent = document.getElementById('manual-content');
    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const mobileOverlay = document.getElementById('mobile-overlay');
    
    let manualDataCache = new Map();
    let modalZIndex = 2000;
    let scrollObserver = null;

    async function getUserStatus(userId) { return getDoc(doc(db, 'users', userId)).then(d => d.exists() ? { estatuto: d.data().estatuto, aceite: d.data().aceite } : null); }
    async function loadMenuSettings() { return getDoc(doc(db, 'paineis', 'paineis menu')).then(d => d.exists() ? d.data() : {}); }
    function checkPageAccess(userStatus, menuSettings) { return (menuSettings['manual'] === 'on' || userStatus === 'ruler'); }
    function updateMenuVisibility(menuSettings) { document.querySelectorAll('.bottom-menu .menu-item').forEach(i => { const k = i.getAttribute('href').replace('.html', ''); if (menuSettings[k] === 'off') i.style.display = 'none'; }); }
    
    function buildSidebar() {
        const themes = []; const topicsByParent = new Map(); const elementsByParent = new Map();
        manualDataCache.forEach(data => {
            switch (data.type) {
                case 'Tema': themes.push(data); break;
                case 'Tópico':
                    if (!topicsByParent.has(data.parentId)) topicsByParent.set(data.parentId, []);
                    topicsByParent.get(data.parentId).push(data);
                    break;
                case 'Elemento':
                    if (!elementsByParent.has(data.topicParentId)) elementsByParent.set(data.topicParentId, []);
                    elementsByParent.get(data.topicParentId).push(data);
                    break;
            }
        });
        themes.sort((a, b) => a.title.localeCompare(b.title));
        const navUl = document.createElement('ul');
        themes.forEach(theme => {
            const topics = topicsByParent.get(theme.id) || [];
            topics.sort((a, b) => (a.posicao ?? Infinity) - (b.posicao ?? Infinity));
            const hasChildren = topics.length > 0;
            const themeLi = createListItem(theme, hasChildren);
            if (hasChildren) {
                const topicUl = document.createElement('ul');
                topics.forEach(topic => {
                    const elements = elementsByParent.get(topic.id) || [];
                    elements.sort((a,b) => a.title.localeCompare(b.title));
                    const topicHasChildren = elements.length > 0;
                    const topicLi = createListItem(topic, topicHasChildren);
                    if (topicHasChildren) {
                        const elementUl = document.createElement('ul');
                        elements.forEach(element => elementUl.appendChild(createListItem(element, false)));
                        topicLi.appendChild(elementUl);
                    }
                    topicUl.appendChild(topicLi);
                });
                themeLi.appendChild(topicUl);
            }
            navUl.appendChild(themeLi);
        });
        navContainer.innerHTML = '';
        navContainer.appendChild(navUl);
    }

    function createListItem(data, isCollapsible) {
        const li = document.createElement('li');
        li.className = 'list-item';
        if (isCollapsible) li.classList.add('collapsed');
        const header = document.createElement('div');
        header.className = 'list-item-header nav-item';
        header.dataset.id = data.id;
        header.dataset.type = data.type;
        let iconClass = isCollapsible ? 'fa-chevron-right' : 'fa-minus';
        header.innerHTML = `<i class="fas ${iconClass} toggle-icon"></i><span class="item-title">${data.title}</span>`;
        li.appendChild(header);
        return li;
    }

    function displayTopicContent(docId) {
        if (scrollObserver) scrollObserver.disconnect();
        if (!manualDataCache.has(docId)) return;
        const data = manualDataCache.get(docId);
        manualContent.innerHTML = `<h2 id="content-title">${data.title}</h2><div id="content-body">${data.content}</div>`;
    }
    
    function displayThemeContent(themeId) {
        if (scrollObserver) scrollObserver.disconnect();
        if (!manualDataCache.has(themeId)) return;
        const themeData = manualDataCache.get(themeId);
        const childTopics = Array.from(manualDataCache.values()).filter(item => item.type === 'Tópico' && item.parentId === themeId).sort((a, b) => (a.posicao ?? Infinity) - (b.posicao ?? Infinity));
        if (childTopics.length === 0) {
            manualContent.innerHTML = `<h2 id="content-title">${themeData.title}</h2><div id="content-body">${themeData.content || '<p>Este tema não possui tópicos visíveis.</p>'}</div>`;
            return;
        }
        let pickcardsHTML = '<div class="topic-pickcards-container"><h4>Tópicos:</h4>';
        childTopics.forEach(topic => pickcardsHTML += `<a href="#topic-${topic.id}" class="topic-pickcard">${topic.title}</a>`);
        pickcardsHTML += '</div>';
        let contentHTML = themeData.content ? `<div class="theme-intro">${themeData.content}</div>` : '';
        childTopics.forEach(topic => {
            contentHTML += `<div class="topic-content-block scroll-spy-target" data-type="Tópico" id="topic-${topic.id}"><h3>${topic.title}</h3><div>${topic.content}</div>`;
            const childElements = Array.from(manualDataCache.values()).filter(item => item.type === 'Elemento' && item.topicParentId === topic.id).sort((a, b) => a.title.localeCompare(b.title));
            if (childElements.length > 0) {
                childElements.forEach(element => {
                    contentHTML += `<div class="element-content-block scroll-spy-target" data-type="Elemento" id="element-${element.id}"><h4>${element.title}</h4><div>${element.content}</div></div>`;
                });
            }
            contentHTML += `</div>`;
        });
        manualContent.innerHTML = `<h2 id="content-title">${themeData.title}</h2><div id="content-body">${pickcardsHTML + contentHTML}</div>`;
        const sections = manualContent.querySelectorAll('.scroll-spy-target');
        const observerOptions = { root: manualContent, rootMargin: '0px 0px -60% 0px', threshold: 0 };
        const observerCallback = (entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id.replace(/^(topic-|element-)/, '');
                    navContainer.querySelectorAll('.nav-item.active').forEach(item => item.classList.remove('active'));
                    const activeNavItem = navContainer.querySelector(`.nav-item[data-id="${id}"]`);
                    if (activeNavItem) {
                        let current = activeNavItem;
                        while(current) {
                            current.classList.add('active');
                            const parentLi = current.closest('ul')?.closest('li.list-item');
                            current = parentLi ? parentLi.querySelector('.nav-item') : null;
                        }
                        activeNavItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        };
        scrollObserver = new IntersectionObserver(observerCallback, observerOptions);
        sections.forEach(section => scrollObserver.observe(section));
    }
    
    function displayFaqsOnHomePage() {
        const faqContainer = document.getElementById('faq-container');
        if (!faqContainer) return;
        const faqs = Array.from(manualDataCache.values()).filter(item => item.type === 'Pergunta').sort((a, b) => a.title.localeCompare(b.title));
        if (faqs.length === 0) {
            faqContainer.style.display = 'none';
            return;
        }
        let faqsHTML = `<h3>Perguntas Frequentes</h3>`;
        faqsHTML += faqs.map(faq => `
            <div class="faq-item">
                <button class="faq-question">
                    <span>${faq.title}</span>
                    <i class="fas fa-plus faq-icon"></i>
                </button>
                <div class="faq-answer">
                    <div class="faq-answer-content">${faq.content}</div>
                </div>
            </div>
        `).join('');
        faqContainer.innerHTML = faqsHTML;
    }

    function createAndShowModal(docId) {
        if (!manualDataCache.has(docId)) return;
        const data = manualDataCache.get(docId);
        const existingModals = document.querySelectorAll('.modal-backdrop:not(#modal-template)');
        existingModals.forEach(modal => {
            modal.classList.add('is-underneath');
            modal.classList.remove('has-opaque-background');
            modal.classList.add('has-translucent-background');
        });
        const template = document.getElementById('modal-template');
        const newModal = template.cloneNode(true);
        newModal.removeAttribute('id');
        newModal.style.zIndex = modalZIndex++;
        newModal.classList.add('has-opaque-background');
        newModal.querySelector('.modal-title').textContent = data.title;
        newModal.querySelector('.modal-body').innerHTML = data.content;
        document.body.appendChild(newModal);
        newModal.style.display = 'flex';
        if (window.innerWidth <= 768) document.body.classList.add('modal-open');
    }
    
    function closeTopmostModal() {
        const allModals = document.querySelectorAll('.modal-backdrop:not(#modal-template)');
        if (allModals.length === 0) return;
        const topModal = Array.from(allModals).reduce((a, b) => parseInt(a.style.zIndex) > parseInt(b.style.zIndex) ? a : b);
        if (topModal) { topModal.remove(); modalZIndex--; }
        const remainingModals = document.querySelectorAll('.modal-backdrop:not(#modal-template)');
        if (remainingModals.length === 0 && window.innerWidth <= 768) {
            document.body.classList.remove('modal-open');
        } else if (remainingModals.length > 0) {
            const newTopModal = Array.from(remainingModals).reduce((a, b) => parseInt(a.style.zIndex) > parseInt(b.style.zIndex) ? a : b);
            if (newTopModal) {
                newTopModal.classList.remove('is-underneath');
                newTopModal.classList.remove('has-translucent-background');
                newTopModal.classList.add('has-opaque-background');
            }
        }
    }
    
    function closeAllModals() {
        document.querySelectorAll('.modal-backdrop:not(#modal-template)').forEach(modal => modal.remove());
        modalZIndex = 2000;
        if (window.innerWidth <= 768) document.body.classList.remove('modal-open');
    }

    function navigateToManualItem(docId) {
        const navItem = navContainer.querySelector(`.nav-item[data-id="${docId}"]`);
        if (!navItem) return;
        navItem.click();
        let parentLi = navItem.closest('li.list-item');
        while(parentLi) {
            parentLi.classList.remove('collapsed');
            parentLi = parentLi.parentElement.closest('li.list-item');
        }
        navItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function createSnippet(content, query) {
        const lowerCaseContent = content.toLowerCase();
        const lowerCaseQuery = query.toLowerCase();
        const firstIndex = lowerCaseContent.indexOf(lowerCaseQuery);
        if (firstIndex === -1) {
            const cleanContent = content.replace(/<[^>]*>?/gm, ' ');
            return cleanContent.substring(0, 150) + (cleanContent.length > 150 ? '...' : '');
        }
        const start = Math.max(0, firstIndex - 40);
        const end = Math.min(content.length, firstIndex + query.length + 100);
        let snippet = content.substring(start, end).replace(/<[^>]*>?/gm, ' ');
        if (start > 0) snippet = '...' + snippet;
        if (end < content.length) snippet = snippet + '...';
        return snippet;
    }
    
    function displaySearchResults(results, query) {
        const resultsContainer = document.getElementById('search-results-container');
        if (!resultsContainer) return;
        if (results.length === 0) {
            resultsContainer.innerHTML = '<p style="text-align: center; color: #777;">Nenhum resultado encontrado.</p>';
            return;
        }
        const searchRegex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        resultsContainer.innerHTML = results.map(result => {
            const snippet = createSnippet(result.content, query);
            const highlightedSnippet = snippet.replace(searchRegex, `<mark class="search-highlight">$&</mark>`);
            return `
                <div class="search-result-item" data-id="${result.id}" data-type="${result.type}">
                    <h4 class="search-result-title">${result.title}</h4>
                    <p class="search-result-snippet">${highlightedSnippet}</p>
                </div>
            `;
        }).join('');
    }

    document.body.addEventListener('click', e => {
        const manualLink = e.target.closest('manual-link');
        if (manualLink && manualLink.dataset.id) {
            e.preventDefault();
            const docId = manualLink.dataset.id;
            if (manualDataCache.has(docId)) {
                const docType = manualDataCache.get(docId).type;
                if (docType === 'Tema' || docType === 'Tópico') {
                    navigateToManualItem(docId);
                    closeAllModals();
                } else {
                    createAndShowModal(docId);
                }
            }
            return; 
        }
        const closeButton = e.target.closest('.modal-close-btn');
        if (closeButton) { closeTopmostModal(); return; }
        if (e.target.classList.contains('modal-backdrop')) {
            if (parseInt(e.target.style.zIndex) === modalZIndex - 1) { closeTopmostModal(); }
        }
    });

   function performSearch(query, searchData) {
        if (query.length < 2) return [];

        const lowerCaseQuery = query.toLowerCase();
        const results = [];
        const searchRegex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        
        searchData.forEach(item => {
            let score = 0;
            if (!item.title) return;
            if (item.title.toLowerCase().includes(lowerCaseQuery)) { score += 5; }
            if (item.type && item.type.toLowerCase().includes(lowerCaseQuery)) { score += 2; }
            const contentMatches = (item.content || '').match(searchRegex);
            if (contentMatches) { score += contentMatches.length; }
            if (score > 0) { results.push({ id: item.id, title: item.title, type: item.type, content: item.content || '', score: score }); }
        });
        
        return results.sort((a, b) => b.score - a.score);
    }

    function initializeSearch(manualData) {
        const searchInput = document.getElementById('manual-search-input');
        const resultsContainer = document.getElementById('search-results-container');
        if (searchInput && resultsContainer) {
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query) {
                    const searchResults = performSearch(query, manualData);
                    displaySearchResults(searchResults, query);
                } else {
                    resultsContainer.innerHTML = '';
                }
            });
            resultsContainer.addEventListener('click', (e) => {
                const resultItem = e.target.closest('.search-result-item');
                if (resultItem) {
                    const docId = resultItem.dataset.id;
                    const docType = resultItem.dataset.type;
                    if (docType === 'Tema' || docType === 'Tópico' || docType === 'Elemento') {
                        navigateToManualItem(docId);
                    } else {
                        createAndShowModal(docId);
                    }
                    searchInput.value = '';
                    resultsContainer.innerHTML = '';
                }
            });
        }
    }

   function displayHomePage(manualData) {
        if (scrollObserver) scrollObserver.disconnect();
        
        manualContent.innerHTML = `
            <h2 id="content-title">Bem-vindo ao Manual</h2>
            <div id="content-body">
                <p>Selecione um tema ou tópico na barra de navegação à esquerda ou use a pesquisa abaixo para encontrar conteúdo.</p>
                <div class="search-bar-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="manual-search-input" placeholder="Pesquisar no manual..." autocomplete="off">
                </div>
                <div id="search-results-container"></div>
                <div id="faq-container"></div>
            </div>
        `;
        
        displayFaqsOnHomePage(); 
        initializeSearch(manualData);

        navContainer.querySelectorAll('.nav-item.active').forEach(el => el.classList.remove('active'));
    }

   function initializeAppManual(manualData) {
        manualDataCache = manualData; 
        
        buildSidebar();

        displayHomePage(manualData);
        
        const headerTitle = document.querySelector('.main-header h1');
        if (headerTitle) {
            headerTitle.addEventListener('click', () => displayHomePage(manualData));
        }

        navContainer.addEventListener('click', e => {
            const header = e.target.closest('.list-item-header');
            if (!header) return;

            const isToggleClick = e.target.classList.contains('toggle-icon');
            const parentLi = header.parentElement;
            
            if (isToggleClick) {
                if (parentLi.querySelector('ul')) { parentLi.classList.toggle('collapsed'); }
                return;
            }

            const id = header.dataset.id;
            const type = header.dataset.type;
            
            if (type === 'Tema') {
                parentLi.classList.remove('collapsed');
                parentLi.querySelectorAll('.list-item').forEach(subLi => subLi.classList.remove('collapsed'));
            }

            document.querySelectorAll('.nav-item.active').forEach(el => el.classList.remove('active'));
            header.classList.add('active');
            let current = header;
            while(current) {
                const parent = current.closest('ul')?.closest('li.list-item');
                current = parent ? parent.querySelector('.nav-item') : null;
                if(current) current.classList.add('active');
            }
            
            switch(type) {
                case 'Tema': displayThemeContent(id); break;
                case 'Tópico':
                case 'Elemento': displayTopicContent(id); break;
            }

            if (window.innerWidth <= 768) {
                document.body.classList.remove('nav-open');
            }
        });

        manualContent.addEventListener('click', e => {
            const question = e.target.closest('.faq-question');
            if (!question) return;

            const faqItem = question.parentElement;
            const answer = faqItem.querySelector('.faq-answer');
            const icon = question.querySelector('.faq-icon');

            const isActive = faqItem.classList.toggle('active');

            if (isActive) {
                answer.style.maxHeight = answer.scrollHeight + "px";
                icon.classList.replace('fa-plus', 'fa-minus');
            } else {
                answer.style.maxHeight = null;
                icon.classList.replace('fa-minus', 'fa-plus');
            }
        });

        menuToggleBtn.addEventListener('click', () => document.body.classList.toggle('nav-open'));
        mobileOverlay.addEventListener('click', () => document.body.classList.remove('nav-open'));
    }

  onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userInfo = await getUserStatus(user.uid);
            if (userInfo && userInfo.aceite && userInfo.aceite.toLowerCase() === "yes") {
                const menuSettings = await loadMenuSettings();
                if (checkPageAccess(userInfo.estatuto, menuSettings)) {
                    mainContentWrapper.style.display = 'block';
                    updateMenuVisibility(menuSettings);

                    const manualQuery = query(collection(db, "manual"), where("visible", "==", true));
                    const querySnapshot = await getDocs(manualQuery);
                    const initialVisibleCache = new Map();
                    querySnapshot.forEach(doc => initialVisibleCache.set(doc.id, {id: doc.id, ...doc.data()}));
                    
                    const isParentHierarchyVisible = (item, visibleCache) => {
                        if (item.parentId) {
                            if (!visibleCache.has(item.parentId)) { return false; }
                        }
                        if (item.topicParentId) {
                            const parentTopic = visibleCache.get(item.topicParentId);
                            if (!parentTopic) { return false; }
                            if (parentTopic.parentId && !visibleCache.has(parentTopic.parentId)) { return false; }
                        }
                        return true;
                    };

                    const finalFilteredCache = new Map();
                    for (const item of initialVisibleCache.values()) {
                        if (isParentHierarchyVisible(item, initialVisibleCache)) {
                            finalFilteredCache.set(item.id, item);
                        }
                    }
                    
                    initializeAppManual(finalFilteredCache);

                } else { window.location.href = '404.html'; }
            } else { window.location.href = 'index.html'; }
        } else { window.location.href = 'index.html'; }
        loadingScreen.style.display = 'none';
    });

</script>
</body>
</html>
