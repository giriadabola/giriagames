<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual - Ggames</title>
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEiIbiLnCB/s320/soccer-ball-png.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; overflow-x: hidden; }
        .content-wrapper { padding-bottom: 80px; }
        .bottom-menu { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 32px; align-items: center; z-index: 1000; }
        .menu-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; }
        .menu-item.active { color: #2176ff; font-weight: bold; }
        .menu-item i { font-size: 24px; margin-bottom: 4px; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; display: flex; justify-content: center; align-items: center; z-index: 2001; }
        .loading-spinner { border: 16px solid #f3f3f3; border-top: 16px solid #3498db; border-radius: 50%; width: 120px; height: 120px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .main-header { display: flex; align-items: center; background-color: #fff; padding: 10px 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #menu-toggle-btn { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: #333; margin-right: 15px; }
        .main-header h1 { font-size: 1.5em; color: #333; margin: 0; }
        .manual-container { display: flex; height: calc(100vh - 58px); }
        #manual-nav { flex: 0 0 300px; background: #fff; padding: 15px; overflow-y: auto; border-right: 1px solid #e0e0e0; transition: transform 0.3s ease-in-out; }
        #manual-nav ul { list-style: none; }
        .theme-item .theme-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; cursor: pointer; border-radius: 5px; }
        .theme-item .theme-header:hover { background-color: #f5f5f5; }
        .theme-item .theme-title { font-weight: bold; color: #333; flex-grow: 1; }
        .theme-item .toggle-icon { transition: transform 0.3s ease; }
        .theme-item.collapsed .toggle-icon { transform: rotate(-90deg); }
        .topic-list { max-height: 1000px; overflow: hidden; transition: max-height 0.5s ease-in-out; padding-left: 15px; }
        .theme-item.collapsed .topic-list { max-height: 0; }
        .topic-item { padding: 10px 15px; cursor: pointer; border-radius: 5px; color: #555; font-size: 0.95em; }
        .topic-item:hover { background-color: #f5f5f5; }
        .nav-item.active { background-color: #e7f5ff !important; color: #2176ff; font-weight: bold; }
        #manual-content { flex: 1; padding: 25px; overflow-y: auto; background: #f9f9f9; }
        #content-body { line-height: 1.6; color: #333; }
        #content-body h1, #content-body h2 { margin-top: 1.5em; margin-bottom: 0.5em; color: #222; }
        #content-body p { margin-bottom: 1em; }
        #content-body img { max-width: 100%; vertical-align: middle; margin: 0 0.3em; }
        manual-link { color: #2176ff; text-decoration: underline; cursor: pointer; font-weight: bold; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 15px; transition: background-color 0.3s ease; }
        .modal-backdrop.has-opaque-background { background-color: rgba(0,0,0,0.6); }
        .modal-backdrop.has-translucent-background { background-color: rgba(0,0,0,0.1); }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
        .topic-content-block { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .topic-content-block h3 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .modal-backdrop.is-underneath .modal-content { transform: scale(0.95); opacity: 0.3; }
        @media (max-width: 768px) {
            .manual-container { display: block; height: auto; }
            #menu-toggle-btn { display: block; }
            #manual-nav { position: fixed; top: 0; left: 0; width: 280px; height: 100%; z-index: 1500; transform: translateX(-100%); border-right: 1px solid #ccc; }
            body.nav-open #manual-nav { transform: translateX(0); }
            body.nav-open .mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1400; }
            #manual-content { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="loading-screen"><div class="loading-spinner"></div></div>
    <div id="main-content-wrapper" style="display: none;">
        <div class="content-wrapper">
            <header class="main-header">
                <button id="menu-toggle-btn"><i class="fas fa-bars"></i></button>
                <h1>Manual</h1>
            </header>
            <div class="manual-container">
                <aside id="manual-nav"></aside>
                <main id="manual-content">
                    <h2 id="content-title">Bem-vindo ao Manual</h2>
                    <div id="content-body"><p>Selecione um tema ou tópico na barra de navegação à esquerda para ver o seu conteúdo.</p></div>
                </main>
            </div>
        </div>
        <div class="mobile-overlay" id="mobile-overlay"></div>
        <nav class="bottom-menu">
            <a href="1x.html" class="menu-item"><i class="fas fa-home"></i></a>
            <a href="market.html" class="menu-item"><i class="fas fa-shopping-cart"></i></a>
            <a href="team.html" class="menu-item"><i class="fas fa-users"></i></a>
            <a href="empire.html" class="menu-item"><i class="fas fa-landmark"></i></a>
            <a href="rankings.html" class="menu-item"><i class="fas fa-list"></i></a>
            <a href="profile.html" class="menu-item"><i class="fas fa-user"></i></a>
        </nav>
    </div>
    <div id="modal-template" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"></h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>

<script src="config.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loadingScreen = document.getElementById('loading-screen');
    const mainContentWrapper = document.getElementById('main-content-wrapper');
    const navContainer = document.getElementById('manual-nav');
    const contentTitle = document.getElementById('content-title');
    const contentBody = document.getElementById('content-body');
    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const mobileOverlay = document.getElementById('mobile-overlay');
    
    let manualDataCache = new Map();
    let modalZIndex = 2000;

    async function getUserStatus(userId) { return getDoc(doc(db, 'users', userId)).then(d => d.exists() ? { estatuto: d.data().estatuto, aceite: d.data().aceite } : null); }
    async function loadMenuSettings() { return getDoc(doc(db, 'paineis', 'paineis menu')).then(d => d.exists() ? d.data() : {}); }
    function checkPageAccess(userStatus, menuSettings) { return (menuSettings['manual'] === 'on' || userStatus === 'ruler'); }
    function updateMenuVisibility(menuSettings) { document.querySelectorAll('.bottom-menu .menu-item').forEach(i => { const k = i.getAttribute('href').replace('.html', ''); if (menuSettings[k] === 'off') i.style.display = 'none'; }); }
    
    async function buildSidebar() {
        const themes = [];
        const topicsByParent = new Map();
        manualDataCache.forEach((data, id) => {
            if (data.type === 'Tema') themes.push({ id, ...data });
            else if (data.type === 'Tópico') {
                if (!topicsByParent.has(data.parentId)) topicsByParent.set(data.parentId, []);
                topicsByParent.get(data.parentId).push({ id, ...data });
            }
        });
        themes.sort((a, b) => a.title.localeCompare(b.title));
        let navHTML = '<ul>';
        for (const theme of themes) {
            navHTML += `<li class="theme-item collapsed" data-id="${theme.id}"><div class="theme-header nav-item"><span class="theme-title">${theme.title}</span><i class="fas fa-chevron-down toggle-icon"></i></div><ul class="topic-list">`;
            const topics = topicsByParent.get(theme.id) || [];
            topics.sort((a, b) => (a.posicao ?? Infinity) - (b.posicao ?? Infinity));
            for (const topic of topics) navHTML += `<li class="topic-item nav-item" data-id="${topic.id}">${topic.title}</li>`;
            navHTML += `</ul></li>`;
        }
        navHTML += '</ul>';
        navContainer.innerHTML = navHTML;
    }

    function displayTopicContent(docId) { if (!manualDataCache.has(docId)) return; const data = manualDataCache.get(docId); contentTitle.textContent = data.title; contentBody.innerHTML = data.content; }
    
    function displayThemeContent(themeId) { if (!manualDataCache.has(themeId)) return; const themeData = manualDataCache.get(themeId); contentTitle.textContent = themeData.title; const childTopics = []; manualDataCache.forEach((item) => { if (item.type === 'Tópico' && item.parentId === themeId) childTopics.push(item); }); childTopics.sort((a, b) => (a.posicao ?? Infinity) - (b.posicao ?? Infinity)); if (childTopics.length === 0) contentBody.innerHTML = '<p>Este tema não possui tópicos visíveis.</p>'; else { let contentHTML = ''; childTopics.forEach(topic => { contentHTML += `<div class="topic-content-block"><h3>${topic.title}</h3><div>${topic.content}</div></div>`; }); contentBody.innerHTML = contentHTML; } }
    
    function createAndShowModal(docId) {
        if (!manualDataCache.has(docId)) return;
        const data = manualDataCache.get(docId);

        // Usamos :not(#modal-template) para ignorar o template oculto
        const existingModals = document.querySelectorAll('.modal-backdrop:not(#modal-template)');
        
        existingModals.forEach(modal => {
            modal.classList.add('is-underneath');
            modal.classList.remove('has-opaque-background');
            modal.classList.add('has-translucent-background');
        });

        const template = document.getElementById('modal-template');
        const newModal = template.cloneNode(true);
        newModal.removeAttribute('id');
        newModal.style.zIndex = modalZIndex++;
        newModal.classList.add('has-opaque-background');
        newModal.querySelector('.modal-title').textContent = data.title;
        newModal.querySelector('.modal-body').innerHTML = data.content;
        document.body.appendChild(newModal);
        newModal.style.display = 'flex';
    }
    
    function closeTopmostModal() {
        // Usamos :not(#modal-template) aqui também para consistência
        const allModals = document.querySelectorAll('.modal-backdrop:not(#modal-template)');
        if (allModals.length === 0) return;

        const topModal = Array.from(allModals).reduce((a, b) => parseInt(a.style.zIndex) > parseInt(b.style.zIndex) ? a : b);
        if (topModal) {
            topModal.remove();
            modalZIndex--;
        }

        const remainingModals = document.querySelectorAll('.modal-backdrop:not(#modal-template)');
        if (remainingModals.length > 0) {
            const newTopModal = Array.from(remainingModals).reduce((a, b) => parseInt(a.style.zIndex) > parseInt(b.style.zIndex) ? a : b);
            if (newTopModal) {
                newTopModal.classList.remove('is-underneath');
                newTopModal.classList.remove('has-translucent-background');
                newTopModal.classList.add('has-opaque-background');
            }
        }
    }

    function initializeAppManual() {
        buildSidebar();
        navContainer.addEventListener('click', e => {
            const navItem = e.target.closest('.nav-item');
            if (!navItem) return;
            document.querySelectorAll('.nav-item.active').forEach(el => el.classList.remove('active'));
            navItem.classList.add('active');
            if (navItem.classList.contains('theme-header')) {
                const themeItem = navItem.closest('.theme-item');
                themeItem.classList.toggle('collapsed');
                displayThemeContent(themeItem.dataset.id); 
            } else if (navItem.classList.contains('topic-item')) {
                displayTopicContent(navItem.dataset.id); 
            }
            if (window.innerWidth <= 768) document.body.classList.remove('nav-open');
        });
        menuToggleBtn.addEventListener('click', () => document.body.classList.toggle('nav-open'));
        mobileOverlay.addEventListener('click', () => document.body.classList.remove('nav-open'));
    }

    document.body.addEventListener('click', e => {
        const manualLink = e.target.closest('manual-link');
        if (manualLink && manualLink.dataset.id) { e.preventDefault(); createAndShowModal(manualLink.dataset.id); return; }
        const closeButton = e.target.closest('.modal-close-btn');
        if (closeButton) { closeTopmostModal(); return; }
        if (e.target.classList.contains('modal-backdrop')) { if (parseInt(e.target.style.zIndex) === modalZIndex - 1) { closeTopmostModal(); } }
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userInfo = await getUserStatus(user.uid);
            if (userInfo && userInfo.aceite && userInfo.aceite.toLowerCase() === "yes") {
                const menuSettings = await loadMenuSettings();
                if (checkPageAccess(userInfo.estatuto, menuSettings)) {
                    mainContentWrapper.style.display = 'block';
                    updateMenuVisibility(menuSettings);
                    const manualQuery = query(collection(db, "manual"), where("visible", "==", true));
                    const querySnapshot = await getDocs(manualQuery);
                    querySnapshot.forEach(doc => manualDataCache.set(doc.id, {id: doc.id, ...doc.data()}));
                    initializeAppManual();
                } else { window.location.href = '404.html'; }
            } else { window.location.href = 'index.html'; }
        } else { window.location.href = 'index.html'; }
        loadingScreen.style.display = 'none';
    });
</script>
</body>
</html>
