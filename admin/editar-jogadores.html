<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Jogadores - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- 1. Adiciona o nosso guardião de segurança central. -->
    <script type="module" src="js/auth-guard.js"></script>

    <style>
        /* O seu CSS completo e original permanece aqui, sem alterações. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 14px; line-height: 1.4; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .menu-item i { font-size: 16px; }
        .content { padding: 80px 20px 20px; max-width: 1200px; margin: 0 auto; }
        .cards-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start; margin-top: 30px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); width: calc(33.33% - 14px); min-width: 300px; margin-bottom: 0; }
        h1 { color: #333; margin-bottom: 30px; text-align: center; }
        .search-container { position: relative; margin-bottom: 30px; }
        .search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 300px; overflow-y: auto; z-index: 1000; display: none; }
        .country-search-container { position: relative; margin-bottom: 20px; }
        .country-search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        .country-search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .country-result { padding: 10px; cursor: pointer; transition: background-color 0.2s; }
        .country-result:hover { background-color: #f5f5f5; }
        .player-result { display: flex; align-items: center; padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .player-result:hover { background-color: #f5f5f5; }
        .player-result img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .card-title { font-size: 18px; font-weight: 600; color: #2176ff; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #f0f0f0; }
        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.2s ease; }
        .form-control:focus { border-color: #2176ff; outline: none; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .mini-game-option { display: flex; align-items: center; gap: 10px; }
        .mini-game-price { display: none; }
        .mini-game-price-input { padding: 5px; border: 1px solid #ddd; border-radius: 4px; width: 80px; }
        .image-preview { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; margin-top: 10px; }
        .dropdown { position: relative; }
        .dropdown-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .dropdown-item { padding: 8px 12px; cursor: pointer; }
        .dropdown-item:hover { background-color: #f5f5f5; }
        .btn-edit { background-color: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; cursor: pointer; width: 100%; transition: background-color 0.3s ease; }
        .btn-edit:hover { background-color: #218838; }
        .coeficientes-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .coeficientes-table th, .coeficientes-table td { padding: 8px 12px; text-align: left; border: 1px solid #ddd; }
        .coeficientes-table th { background-color: #f2f2f2; font-weight: bold; color: #333; }
        .coeficientes-table tr:nth-child(even) { background-color: #f9f9f9; }
        .coeficientes-table tr:hover { background-color: #f0f7ff; }
    </style>
</head>
<body style="display: none;"> <!-- 2. O corpo da página está oculto por padrão -->
    
    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item"><i class="fas fa-home"></i></a>
        <a href="editar-gplayer.html" class="menu-item"><i class="fas fa-user"></i>EDITAR GPLAYER</a>
        <a href="editar-jogo.html" class="menu-item"><i class="fas fa-gamepad"></i>EDITAR JOGO</a>
        <a href="editar-jogadores.html" class="menu-item active"><i class="fas fa-users"></i>EDITAR JOGADORES</a>
        <a href="editar-clubes.html" class="menu-item"><i class="fas fa-shield-alt"></i>EDITAR CLUBES</a>
        <a href="editar-competicoes.html" class="menu-item"><i class="fas fa-trophy"></i>EDITAR COMPETIÇÕES</a>
        <a href="editar-pais.html" class="menu-item"><i class="fas fa-globe"></i>EDITAR PAIS</a>
        <a href="editar-mods.html" class="menu-item"><i class="fas fa-puzzle-piece"></i>EDITAR MODS</a>
    </nav>

    <div class="content">
        <a href="gerenciar-jogadores.html" class="menu-item"><i class="fas fa-users"></i> JOGADORES LIVE</a>
        <h1>Editar Jogadores</h1>
        <div class="search-container"><input type="text" class="search-input" placeholder="Pesquisar jogador..." id="playerSearch"><div class="search-results" id="searchResults"></div></div>
        <form id="editPlayerForm" class="cards-container">
            <div class="card">
                <div class="card-title">Informações Básicas</div>
                <div class="form-group"><label for="playerName">Nome do Jogador</label><input type="text" class="form-control" id="playerName" readonly></div>
                <div class="form-group"><label for="playerImage">Imagem do Jogador (URL)</label><input type="text" class="form-control" id="playerImage"><img src="" alt="Preview" class="image-preview" id="imagePreview"></div>
                <div class="form-group"><label for="playerCountry">País do Jogador</label><div class="dropdown"><input type="text" class="form-control" id="playerCountry"><div class="dropdown-results" id="countryResults"></div></div></div>
                <div class="form-group"><label for="playerClub">Clube do Jogador</label><div class="dropdown"><input type="text" class="form-control" id="playerClub"><div class="dropdown-results" id="clubResults"></div></div></div>
                <div class="form-group"><label for="playerPosition">Posição do Jogador</label><select class="form-control" id="playerPosition"><option value="">Selecione a posição</option><option value="Guarda-Redes">Guarda-Redes</option><option value="Defesa">Defesa</option><option value="Médio">Médio</option><option value="Avançado">Avançado</option></select></div>
            </div>
            <div class="card">
                <div class="card-title">Status do Jogador</div>
                <div class="form-group"><label for="playerOverall">Overall do Jogador</label><input type="number" class="form-control" id="playerOverall" step="0.1" min="0" max="1000"></div>
                <div class="form-group"><label for="playerTier">Casta do Jogador</label><select class="form-control" id="playerTier"><option value="Jogador Ouro">Jogador Ouro</option><option value="Jogador Prata">Jogador Prata</option><option value="Jogador Bronze">Jogador Bronze</option><option value="Jogador Platina">Jogador Platina</option></select></div>
                <div class="form-group"><label for="playerMarket">No Mercado?</label><select class="form-control" id="playerMarket"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                <div class="form-group"><label>Mini Games? (Opcional)</label><div class="checkbox-group"><div class="mini-game-option"><label><input type="checkbox" name="mini-games" value="world26" class="mini-game-checkbox"> World26</label><div class="mini-game-price" style="display: none;"><input type="text" name="world26-preco" maxlength="5" placeholder="Preço" class="mini-game-price-input"></div></div><div class="mini-game-option"><label><input type="checkbox" name="mini-games" value="whowins" class="mini-game-checkbox"> WhoWins</label><div class="mini-game-price" style="display: none;"><input type="text" name="whowins-preco" maxlength="5" placeholder="Preço" class="mini-game-price-input"></div></div></div></div>
                <button type="submit" class="btn-edit">Editar Jogador</button>
            </div>
            <div class="card">
                <div class="card-title">Informações de Mercado</div>
                <div class="form-group"><label for="playerPrice">Preço</label><input type="number" class="form-control" id="playerPrice" min="0" max="1000"></div>
                <div class="form-group"><label for="playerBuyer">Comprado por (Opcional)</label><select class="form-control" id="playerBuyer"><option value="">Ninguém</option></select></div>
                <div class="form-group"><label for="playerStats">Estatísticas (Opcional)</label><textarea class="form-control" id="playerStats" rows="5"></textarea></div>
                <div id="coeficientes-section" style="display: none;"><h3>Coeficientes</h3><div id="firebase-data-display"><div id="loading-indicator" style="display: none; text-align: center; margin-top: 10px;"><i class="fas fa-spinner fa-spin"></i> Carregando coeficientes...</div></div></div>
            </div>
        </form>
    </div>

    <!-- 3. O script específico da página foi limpo e corrigido com o DOMContentLoaded -->
    <script type="module">
        import { db } from '/js/auth-guard.js';
        import { collection, getDocs, query, where, doc, getDoc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        let selectedPlayerId = null;
        let originalClubName = null;

        async function fetchGPlayers() {
            const gplayersRef = collection(db, 'gplayers');
            const querySnapshot = await getDocs(gplayersRef);
            return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function displaySearchResults(players) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            if (players.length > 0) {
                players.forEach(player => {
                    const div = document.createElement('div');
                    div.className = 'player-result';
                    div.innerHTML = `<img src="${player.imagem || 'placeholder.jpg'}" alt="${player.nome}"><span>${player.nome}</span>`;
                    div.addEventListener('click', () => selectPlayer(player));
                    searchResults.appendChild(div);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }

        async function fetchOverallLimits() {
            const docRef = doc(db, 'paineis', 'paineis overall');
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? docSnap.data() : null;
        }

        function determineCastaFromOverall(overall, limits) {
            if (!limits) return "";
            const [platinaLimit] = limits.Platina || [null];
            const [ouroLower, ouroUpper] = limits.Ouro || [null, null];
            const [prataLower, prataUpper] = limits.Prata || [null, null];
            const [bronzeLimit] = limits.Bronze || [null];
            if (platinaLimit !== null && overall >= platinaLimit) return "Jogador Platina";
            if (ouroLower !== null && ouroUpper !== null && overall >= ouroLower && overall <= ouroUpper) return "Jogador Ouro";
            if (prataLower !== null && prataUpper !== null && overall >= prataLower && overall <= prataUpper) return "Jogador Prata";
            if (bronzeLimit !== null && overall <= bronzeLimit) return "Jogador Bronze";
            return "";
        }

        async function selectPlayer(player) {
            selectedPlayerId = player.id;
            document.getElementById('playerName').value = player.nome;
            document.getElementById('playerImage').value = player.imagem;
            document.getElementById('imagePreview').src = player.imagem;
            document.getElementById('playerPrice').value = player.preco || '';
            document.getElementById('playerBuyer').value = player.compradopor || '';
            originalClubName = player.clube;

            if (player.paisId) {
                const paisDoc = doc(collection(db, 'paises'), player.paisId);
                getDoc(paisDoc).then(docSnap => { document.getElementById('playerCountry').value = docSnap.exists() ? docSnap.data().nome : ''; });
            } else {
                document.getElementById('playerCountry').value = '';
            }

            document.getElementById('playerClub').value = player.clube || '';
            document.getElementById('playerOverall').value = player.overall;
            document.getElementById('playerTier').value = player.casta;
            document.getElementById('playerMarket').value = player.noMercado ? 'Sim' : 'Não';
            document.getElementById('playerStats').value = player.estatisticas || '';
            document.getElementById('playerPosition').value = player.posicao || '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('playerSearch').value = player.nome;

            const coeficientesSection = document.getElementById('coeficientes-section');
            if (player.posicao) {
                coeficientesSection.style.display = 'block';
                displayFirebaseData(player.posicao, player.casta, player.estatisticas || '');
            } else {
                coeficientesSection.style.display = 'none';
            }

            document.querySelectorAll('.mini-game-checkbox').forEach(checkbox => {
                const isChecked = player.miniGames?.includes(checkbox.value);
                checkbox.checked = isChecked;
                const priceDiv = checkbox.closest('.mini-game-option').querySelector('.mini-game-price');
                priceDiv.style.display = isChecked ? 'inline-block' : 'none';
                if (isChecked) priceDiv.querySelector('.mini-game-price-input').value = player[`${checkbox.value}preco`] || '';
            });

            const buyerSelect = document.getElementById('playerBuyer');
            buyerSelect.innerHTML = '<option value="">Ninguém</option>';
            const gplayers = await fetchGPlayers();
            gplayers.forEach(gplayer => {
                const option = document.createElement('option');
                option.value = gplayer.id;
                option.textContent = gplayer.nome;
                buyerSelect.appendChild(option);
            });
            if (player.compradopor) buyerSelect.value = player.compradopor;
        }

        function displayCountryResults(countries) {
            const countryResults = document.getElementById('countryResults');
            countryResults.innerHTML = '';
            if (countries.length > 0) {
                countries.forEach(country => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = country.nome;
                    div.addEventListener('click', () => {
                        document.getElementById('playerCountry').value = country.nome;
                        countryResults.style.display = 'none';
                    });
                    countryResults.appendChild(div);
                });
                countryResults.style.display = 'block';
            } else {
                countryResults.style.display = 'none';
            }
        }

        function displayClubResults(clubs) {
            const clubResults = document.getElementById('clubResults');
            clubResults.innerHTML = '';
            if (clubs.length > 0) {
                clubs.forEach(club => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = `${club.nome} (${club.pais?.nome || ''})`;
                    div.addEventListener('click', () => {
                        document.getElementById('playerClub').value = club.nome;
                        clubResults.style.display = 'none';
                    });
                    clubResults.appendChild(div);
                });
                clubResults.style.display = 'block';
            } else {
                clubResults.style.display = 'none';
            }
        }

        async function fetchPaineisCoefficients() {
            const paineisDoc = await getDoc(doc(db, 'paineis', 'paineis coeficiente'));
            return paineisDoc.exists() ? paineisDoc.data().paineis_coeficiente : null;
        }

        async function displayFirebaseData(selectedPosition, selectedCasta, estatisticasText) {
            const firebaseDataDisplay = document.getElementById('firebase-data-display');
            firebaseDataDisplay.innerHTML = '';
            if (!selectedPosition) return;

            const [paineisCoeficienteData, overallLimitsData] = await Promise.all([fetchPaineisCoefficients(), fetchOverallLimits()]);

            if (paineisCoeficienteData) {
                const table = document.createElement('table');
                table.className = 'coeficientes-table';
                table.innerHTML = '<thead><tr><th>Nome da Subcategoria</th><th>Coeficientes</th><th>Estatística</th></tr></thead>';
                const tbody = document.createElement('tbody');
                const rows = [];
                let totalSum = 0;

                for (const categoria in paineisCoeficienteData) {
                    for (const subcategoriaNome in paineisCoeficienteData[categoria]) {
                        const subcategoria = paineisCoeficienteData[categoria][subcategoriaNome];
                        if (subcategoria.tipo) {
                            for (const tipoItem of subcategoria.tipo) {
                                if (tipoItem.name === selectedPosition) {
                                    let firebaseValue = tipoItem.text || '-';
                                    let estatisticaValue = '-';
                                    let statisticNumber = 0;
                                    if (estatisticasText) {
                                        const lines = estatisticasText.split('\n');
                                        for (let i = 0; i < lines.length; i++) {
                                            if (lines[i].trim().toLowerCase().startsWith(subcategoriaNome.toLowerCase())) {
                                                const valueLine = lines[i + 1]?.trim() || '';
                                                const numberMatch = valueLine.match(/^(\d+(\.\d+)?)/);
                                                if (numberMatch) {
                                                    estatisticaValue = numberMatch[1];
                                                    statisticNumber = parseFloat(estatisticaValue.replace(',', '.'));
                                                }
                                                break;
                                            }
                                        }
                                    }
                                    totalSum += (parseFloat(firebaseValue.replace(',', '.')) * statisticNumber);
                                    const row = document.createElement('tr');
                                    row.innerHTML = `<td>${subcategoriaNome}</td><td>${firebaseValue}</td><td>${estatisticaValue}</td>`;
                                    rows.push(row);
                                    break;
                                }
                            }
                        }
                    }
                }

                rows.sort((a, b) => a.cells[0].textContent.localeCompare(b.cells[0].textContent)).forEach(row => tbody.appendChild(row));
                
                let castaFinal = selectedCasta;
                if (overallLimitsData && overallLimitsData[selectedPosition]) {
                    const castaDeterminada = determineCastaFromOverall(totalSum, overallLimitsData[selectedPosition]);
                    if (castaDeterminada) {
                        document.getElementById('playerTier').value = castaDeterminada;
                        castaFinal = castaDeterminada;
                    }
                }
                
                let coeficienteCastaValue = '-';
                if (paineisCoeficienteData?.['Coeficiente']?.['Coeficiente']?.casta) {
                    for (const castaItem of paineisCoeficienteData['Coeficiente']['Coeficiente'].casta) {
                        if (castaItem.name === castaFinal) {
                            coeficienteCastaValue = castaItem.text || '-';
                            break;
                        }
                    }
                }
                
                let coeficienteStatisticValue = '-';
                const totalStatistic = parseFloat(totalSum.toFixed(2));
                const coefficientValueForCalculation = parseFloat(coeficienteCastaValue.replace(',', '.'));
                if (!isNaN(coefficientValueForCalculation) && !isNaN(totalStatistic)) {
                    coeficienteStatisticValue = Math.round(coefficientValueForCalculation * totalStatistic);
                    document.getElementById('playerOverall').value = coeficienteStatisticValue;
                }
                tbody.innerHTML += `<tr style="font-weight: bold;"><td>Total</td><td>-</td><td>${totalSum.toFixed(2)}</td></tr><tr style="font-weight: bold;"><td>Coeficiente</td><td>${coeficienteCastaValue}</td><td>${coeficienteStatisticValue}</td></tr>`;
                table.appendChild(tbody);
                firebaseDataDisplay.appendChild(table);
            }
        }

        // CORREÇÃO: O código que interage com o HTML é envolvido pelo DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            const playerSearch = document.getElementById('playerSearch');
            const playerCountry = document.getElementById('playerCountry');
            const playerClub = document.getElementById('playerClub');

            playerSearch.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length < 1) {
                    document.getElementById('searchResults').style.display = 'none';
                    return;
                }
                const snapshot = await getDocs(collection(db, 'jogadores'));
                const players = [];
                snapshot.forEach(doc => { if (doc.data().nome.toLowerCase().includes(searchTerm)) players.push({ id: doc.id, ...doc.data() }); });
                displaySearchResults(players);
            });

            document.getElementById('playerImage').addEventListener('input', (e) => { document.getElementById('imagePreview').src = e.target.value; });

            document.getElementById('playerStats').addEventListener('input', async function() {
                let playerPosition = null;
                if (selectedPlayerId) {
                    const playerDoc = await getDoc(doc(db, 'jogadores', selectedPlayerId));
                    if (playerDoc.exists()) playerPosition = playerDoc.data().posicao;
                }
                if (playerPosition) displayFirebaseData(playerPosition, document.getElementById('playerTier').value, this.value);
            });

            document.querySelectorAll('.mini-game-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() { this.closest('.mini-game-option').querySelector('.mini-game-price').style.display = this.checked ? 'inline-block' : 'none'; });
            });

            playerCountry.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length < 1) { document.getElementById('countryResults').style.display = 'none'; return; }
                const snapshot = await getDocs(collection(db, 'paises'));
                const countries = [];
                snapshot.forEach(doc => { if (doc.data().nome.toLowerCase().includes(searchTerm)) countries.push(doc.data()); });
                displayCountryResults(countries);
            });

            playerClub.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length < 1) { document.getElementById('clubResults').style.display = 'none'; return; }
                const snapshot = await getDocs(collection(db, 'clubes'));
                const clubs = [];
                snapshot.forEach(doc => { if (doc.data().nome.toLowerCase().includes(searchTerm)) clubs.push(doc.data()); });
                displayClubResults(clubs);
            });

            document.getElementById('editPlayerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedPlayerId) return;
                try {
                    const countryName = document.getElementById('playerCountry').value;
                    const newClubName = document.getElementById('playerClub').value;
                    const playerRef = doc(db, 'jogadores', selectedPlayerId);
                    const oldClubName = (await getDoc(playerRef)).data()?.clube;
                    let paisId = null;
                    const paisSnapshot = await getDocs(query(collection(db, 'paises'), where('nome', '==', countryName)));
                    if (!paisSnapshot.empty) paisId = paisSnapshot.docs[0].id;

                    const miniGames = Array.from(document.querySelectorAll('input[name="mini-games"]:checked')).map(cb => cb.value);
                    const miniGamesPrices = {};
                    miniGames.forEach(game => {
                        const priceInput = document.querySelector(`input[name="${game}-preco"]`);
                        if (priceInput?.value) miniGamesPrices[`${game}preco`] = priceInput.value;
                    });

                    const playerData = {
                        nome: document.getElementById('playerName').value,
                        imagem: document.getElementById('playerImage').value,
                        pais: countryName, paisId: paisId, clube: newClubName,
                        posicao: document.getElementById('playerPosition').value,
                        overall: parseFloat(document.getElementById('playerOverall').value) || 0,
                        casta: document.getElementById('playerTier').value,
                        noMercado: document.getElementById('playerMarket').value === 'Sim',
                        preco: parseInt(document.getElementById('playerPrice').value) || null,
                        compradopor: document.getElementById('playerBuyer').value || null,
                        estatisticas: document.getElementById('playerStats').value,
                        miniGames: miniGames, ...miniGamesPrices,
                        ultimaAtualizacao: new Date().toISOString()
                    };
                    await updateDoc(playerRef, playerData);

                    if (originalClubName !== newClubName) {
                        if (oldClubName) {
                            const oldClubSnapshot = await getDocs(query(collection(db, 'clubes'), where('nome', '==', oldClubName)));
                            if (!oldClubSnapshot.empty) await deleteDoc(doc(db, 'clubes', oldClubSnapshot.docs[0].id, 'jogadores', selectedPlayerId));
                        }
                        if (newClubName) {
                            const newClubSnapshot = await getDocs(query(collection(db, 'clubes'), where('nome', '==', newClubName)));
                            if (!newClubSnapshot.empty) await setDoc(doc(db, 'clubes', newClubSnapshot.docs[0].id, 'jogadores', selectedPlayerId), playerData);
                        }
                    } else if (newClubName) {
                        const clubSnapshot = await getDocs(query(collection(db, 'clubes'), where('nome', '==', newClubName)));
                        if (!clubSnapshot.empty) await setDoc(doc(db, 'clubes', clubSnapshot.docs[0].id, 'jogadores', selectedPlayerId), playerData, { merge: true });
                    }
                    alert('Jogador atualizado com sucesso!');
                    document.getElementById('editPlayerForm').reset();
                    document.getElementById('imagePreview').src = "";
                    selectedPlayerId = null;
                    playerSearch.value = "";
                    document.getElementById('searchResults').style.display = 'none';
                    document.getElementById('coeficientes-section').style.display = 'none';
                } catch (error) { console.error('Erro ao atualizar jogador:', error); alert('Erro ao atualizar jogador'); }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) document.getElementById('searchResults').style.display = 'none';
                if (!e.target.closest('.dropdown')) {
                    document.getElementById('countryResults').style.display = 'none';
                    document.getElementById('clubResults').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
