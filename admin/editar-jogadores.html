<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Jogadores - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .top-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 24px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            line-height: 1.4;
        }

        .menu-item:hover, .menu-item.active {
            color: #2176ff;
            background-color: rgba(33, 118, 255, 0.1);
        }

        .menu-item i {
            font-size: 16px;
        }

        .content {
            padding: 80px 20px 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-container {
            position: relative;
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .country-search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .country-search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .country-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .country-result {
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .country-result:hover {
            background-color: #f5f5f5;
        }

        .player-result {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .player-result:hover {
            background-color: #f5f5f5;
        }

        .player-result img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 10px;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .btn-edit {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .btn-edit:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item">
            <i class="fas fa-home"></i>
        </a>
        <a href="editar-gplayer.html" class="menu-item">
            <i class="fas fa-user"></i>
            EDITAR GPLAYER
        </a>
        <a href="editar-jogo.html" class="menu-item">
            <i class="fas fa-gamepad"></i>
            EDITAR JOGO
        </a>
        <a href="editar-jogadores.html" class="menu-item active">
            <i class="fas fa-users"></i>
            EDITAR JOGADORES
        </a>
        <a href="editar-clubes.html" class="menu-item">
            <i class="fas fa-shield-alt"></i>
            EDITAR CLUBES
        </a>
        <a href="editar-competicoes.html" class="menu-item">
            <i class="fas fa-trophy"></i>
            EDITAR COMPETIÇÕES
        </a>
        <a href="editar-pais.html" class="menu-item">
            <i class="fas fa-globe"></i>
            EDITAR PAIS
        </a>
        <a href="editar-mods.html" class="menu-item">
            <i class="fas fa-puzzle-piece"></i>
            EDITAR MODS
        </a>
    </nav>
    <div class="content">
        <h1>Editar Jogadores</h1>

        <div class="search-container">
            <input type="text" class="search-input" placeholder="Pesquisar jogador..." id="playerSearch">
            <div class="search-results" id="searchResults"></div>
        </div>

        <form id="editPlayerForm">
            <div class="form-group">
                <label for="playerName">Nome do Jogador</label>
                <input type="text" class="form-control" id="playerName" readonly>
            </div>

            <div class="form-group">
                <label for="playerImage">Imagem do Jogador (URL)</label>
                <input type="text" class="form-control" id="playerImage">
                <img src="" alt="Preview" class="image-preview" id="imagePreview">
            </div>

            <div class="form-group">
                <label for="playerCountry">País do Jogador</label>
                <div class="dropdown">
                    <input type="text" class="form-control" id="playerCountry">
                    <div class="dropdown-results" id="countryResults"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="playerClub">Clube do Jogador</label>
                <div class="dropdown">
                    <input type="text" class="form-control" id="playerClub">
                    <div class="dropdown-results" id="clubResults"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="playerOverall">Overall do Jogador</label>
                <input type="number" class="form-control" id="playerOverall" step="0.1" min="0" max="1000">
            </div>

            <div class="form-group">
                <label for="playerTier">Casta do Jogador</label>
                <select class="form-control" id="playerTier">
                    <option value="Jogador Ouro">Jogador Ouro</option>
                    <option value="Jogador Prata">Jogador Prata</option>
                    <option value="Jogador Bronze">Jogador Bronze</option>
                    <option value="Jogador Platina">Jogador Platina</option>
                </select>
            </div>

            <div class="form-group">
                <label for="playerMarket">No Mercado?</label>
                <select class="form-control" id="playerMarket">
                    <option value="Sim">Sim</option>
                    <option value="Não">Não</option>
                </select>
            </div>

            <div class="form-group">
                <label for="playerPrice">Preço</label>
                <input type="number" class="form-control" id="playerPrice" min="0" max="1000">
            </div>

            <div class="form-group">
                <label for="playerBuyer">Comprado por (Opcional)</label>
                <select class="form-control" id="playerBuyer">
                    <option value="">Ninguém</option>
                </select>
            </div>

            <button type="submit" class="btn-edit">Editar Jogador</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.firebasestorage.app",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let selectedPlayerId = null;
        let originalClubName = null; // Variável para guardar o clube original

        // Function to fetch GPlayers for the dropdown
        async function fetchGPlayers() {
            const gplayersRef = collection(db, 'gplayers');
            const querySnapshot = await getDocs(gplayersRef);
            return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }


        // Player search functionality
        const playerSearch = document.getElementById('playerSearch');
        const searchResults = document.getElementById('searchResults');

        playerSearch.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length < 1) {
                searchResults.style.display = 'none';
                return;
            }

            const jogadoresRef = collection(db, 'jogadores');
            const snapshot = await getDocs(jogadoresRef);
            const players = [];

            snapshot.forEach(doc => {
                const player = doc.data();
                if (player.nome.toLowerCase().includes(searchTerm)) {
                    players.push({ id: doc.id, ...player });
                }
            });

            displaySearchResults(players);
        });

        function displaySearchResults(players) {
            searchResults.innerHTML = '';
            if (players.length > 0) {
                players.forEach(player => {
                    const div = document.createElement('div');
                    div.className = 'player-result';
                    div.innerHTML = `
                        <img src="${player.imagem || 'placeholder.jpg'}" alt="${player.nome}">
                        <span>${player.nome}</span>
                    `;
                    div.addEventListener('click', () => selectPlayer(player));
                    searchResults.appendChild(div);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }

        async function selectPlayer(player) {
            selectedPlayerId = player.id;
            document.getElementById('playerName').value = player.nome;
            document.getElementById('playerImage').value = player.imagem;
            document.getElementById('imagePreview').src = player.imagem;

            // Set default values from player data
            document.getElementById('playerPrice').value = player.preco || ''; // Default price
            document.getElementById('playerBuyer').value = player.compradopor || ''; // Default buyer

            console.log("Dados do jogador:", player);
            console.log("player.clube:", player.clube);
            console.log("player.overall:", player.overall);
            console.log("player.casta:", player.casta);
            console.log("player.preco:", player.preco); // Log price
            console.log("player.compradopor:", player.compradopor); // Log buyer

            originalClubName = player.clube; // Guarda o nome do clube original

            // Corrigido para usar player.paisId diretamente
            if (player.paisId) {
                console.log("paisId encontrado no jogador:", player.paisId);
                const paisesRef = collection(db, 'paises');
                const paisDoc = doc(paisesRef, player.paisId);
                getDoc(paisDoc).then(docSnap => {
                    if (docSnap.exists()) {
                        const paisData = docSnap.data();
                        console.log("Documento de país encontrado:", paisData);
                        document.getElementById('playerCountry').value = paisData.nome;
                    } else {
                        console.log("Documento de país NÃO encontrado para paisId:", player.paisId);
                        document.getElementById('playerCountry').value = '';
                    }
                }).catch(error => {
                    console.error('Erro ao buscar país:', error);
                    document.getElementById('playerCountry').value = '';
                });
            } else {
                console.log("paisId NÃO encontrado no jogador:", player);
                document.getElementById('playerCountry').value = '';
            }

            document.getElementById('playerClub').value = player.clube || ''; // CORREÇÃO AQUI
            document.getElementById('playerOverall').value = player.overall;
            document.getElementById('playerTier').value = player.casta;
            document.getElementById('playerMarket').value = player.noMercado ? 'Sim' : 'Não';
            searchResults.style.display = 'none';
            playerSearch.value = player.nome;

             // Populate GPlayers dropdown - moved here to be called after player is selected
            const buyerSelect = document.getElementById('playerBuyer');
            buyerSelect.innerHTML = '<option value="">Ninguém</option>'; // Reset dropdown
            try {
                const gplayers = await fetchGPlayers();
                gplayers.forEach(gplayer => {
                    const option = document.createElement('option');
                    option.value = gplayer.id; // Use ID as value
                    option.textContent = gplayer.nome;
                    buyerSelect.appendChild(option);
                });

                // Set selected buyer after populating dropdown
                if (player.compradopor) {
                    buyerSelect.value = player.compradopor; // Set selected value based on player data
                }
            } catch (error) {
                console.error('Erro ao buscar GPlayers:', error);
            }
        }

        // Image preview
        document.getElementById('playerImage').addEventListener('input', (e) => {
            document.getElementById('imagePreview').src = e.target.value;
        });

        // Country search - REMOVED
        const playerCountry = document.getElementById('playerCountry');
        const countryResults = document.getElementById('countryResults');

        playerCountry.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length < 1) {
                countryResults.style.display = 'none';
                return;
            }

            const paisesRef = collection(db, 'paises');
            const snapshot = await getDocs(paisesRef);
            const countries = [];

            snapshot.forEach(doc => {
                const country = doc.data();
                if (country.nome.toLowerCase().includes(searchTerm)) {
                    countries.push(country);
                }
            });

            displayCountryResults(countries);
        });

        function displayCountryResults(countries) {
            countryResults.innerHTML = '';
            if (countries.length > 0) {
                countries.forEach(country => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = country.nome;
                    div.addEventListener('click', () => {
                        playerCountry.value = country.nome;
                        countryResults.style.display = 'none';
                    });
                    countryResults.appendChild(div);
                });
                countryResults.style.display = 'block';
            } else {
                countryResults.style.display = 'none';
            }
        }

        // Club search
        const playerClub = document.getElementById('playerClub');
        const clubResults = document.getElementById('clubResults');

        playerClub.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length < 1) {
                clubResults.style.display = 'none';
                return;
            }

            const clubesRef = collection(db, 'clubes');
            const snapshot = await getDocs(clubesRef);
            const clubs = [];

            snapshot.forEach(doc => {
                const club = doc.data();
                if (club.nome.toLowerCase().includes(searchTerm)) {
                    clubs.push(club);
                }
            });

            displayClubResults(clubs);
        });

        function displayClubResults(clubs) {
            clubResults.innerHTML = '';
            if (clubs.length > 0) {
                clubs.forEach(club => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = `${club.nome} (${club.pais?.nome || ''})`;
                    div.addEventListener('click', () => {
                        playerClub.value = club.nome;
                        clubResults.style.display = 'none';
                    });
                    clubResults.appendChild(div);
                });
                clubResults.style.display = 'block';
            } else {
                clubResults.style.display = 'none';
            }
        }

        // Form submission
        document.getElementById('editPlayerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedPlayerId) return;

            try {
                // Get the country name and club name from inputs
                const countryName = document.getElementById('playerCountry').value;
                const newClubName = document.getElementById('playerClub').value;
                const newPrice = parseInt(document.getElementById('playerPrice').value) || null; // Get price value
                const newBuyerId = document.getElementById('playerBuyer').value || null; // Get buyer id


                // Get the player's current data to check for club changes
                const playerRef = doc(db, 'jogadores', selectedPlayerId);
                const playerSnapshot = await getDoc(playerRef);
                const currentPlayerData = playerSnapshot.data();
                const oldClubName = currentPlayerData?.clube;

                // Find the country document by name to get its ID
                const paisesRef = collection(db, 'paises');
                const paisQuery = query(paisesRef, where('nome', '==', countryName));
                const paisSnapshot = await getDocs(paisQuery);

                let paisId = null;
                if (!paisSnapshot.empty) {
                    paisId = paisSnapshot.docs[0].id;
                }

                // Update player data
                const playerData = {
                    nome: document.getElementById('playerName').value,
                    imagem: document.getElementById('playerImage').value,
                    pais: countryName,
                    paisId: paisId,
                    clube: newClubName,
                    overall: parseFloat(document.getElementById('playerOverall').value),
                    casta: document.getElementById('playerTier').value,
                    noMercado: document.getElementById('playerMarket').value === 'Sim',
                    preco: newPrice,
                    compradopor: newBuyerId
                };

                // Update player document
                await updateDoc(playerRef, playerData);

                // Conditional club update logic
                if (originalClubName !== newClubName) {
                    // Club changed: transfer player to new club
                    if (oldClubName) {
                        // Find old club and remove player
                        const oldClubQuery = query(collection(db, 'clubes'), where('nome', '==', oldClubName));
                        const oldClubSnapshot = await getDocs(oldClubQuery);
                        if (!oldClubSnapshot.empty) {
                            const oldClubDoc = oldClubSnapshot.docs[0];
                            const oldClubRef = doc(db, 'clubes', oldClubDoc.id, 'jogadores', selectedPlayerId);
                            await deleteDoc(oldClubRef);
                        }
                    }

                    // Add player to new club
                    if (newClubName) {
                        const newClubQuery = query(collection(db, 'clubes'), where('nome', '==', newClubName));
                        const newClubSnapshot = await getDocs(newClubQuery);
                        if (!newClubSnapshot.empty) {
                            const newClubDoc = newClubSnapshot.docs[0];
                            const newClubRef = doc(db, 'clubes', newClubDoc.id, 'jogadores', selectedPlayerId);
                            await setDoc(newClubRef, playerData); // Save all player data to new club
                        }
                    }
                } else {
                    // Club not changed: update player data in the *same* club subcollection
                    if (newClubName) { // Ensure there is a club name (player has a club)
                        const currentClubQuery = query(collection(db, 'clubes'), where('nome', '==', newClubName));
                        const currentClubSnapshot = await getDocs(currentClubQuery);
                        if (!currentClubSnapshot.empty) {
                            const currentClubDoc = currentClubSnapshot.docs[0];
                            const currentClubRef = doc(db, 'clubes', currentClubDoc.id, 'jogadores', selectedPlayerId);
                            await setDoc(currentClubRef, playerData, { merge: true }); // Merge update in existing club
                        }
                    }
                }


                alert('Jogador atualizado com sucesso!');
            } catch (error) {
                console.error('Erro ao atualizar jogador:', error);
                alert('Erro ao atualizar jogador');
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                searchResults.style.display = 'none';
            }
            if (!e.target.closest('.dropdown')) {
                countryResults.style.display = 'none';
                clubResults.style.display = 'none';
            }
        });
    </script>
</body>
</html>
