<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Jogadores - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .top-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 24px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            line-height: 1.4;
        }

        .menu-item:hover, .menu-item.active {
            color: #2176ff;
            background-color: rgba(33, 118, 255, 0.1);
        }

        .menu-item i {
            font-size: 16px;
        }

        .content {
            padding: 80px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: flex-start;
            margin-top: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: calc(33.33% - 14px);
            min-width: 300px;
            margin-bottom: 0;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-container {
            position: relative;
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .country-search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .country-search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .country-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .country-result {
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .country-result:hover {
            background-color: #f5f5f5;
        }

        .player-result {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .player-result:hover {
            background-color: #f5f5f5;
        }

        .player-result img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2176ff;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .form-control:focus {
            border-color: #2176ff;
            outline: none;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mini-game-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mini-game-price {
            display: none;
        }

        .mini-game-price-input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 80px;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 10px;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .btn-edit {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .btn-edit:hover {
            background-color: #218838;
        }

        /* Estilos para a tabela de coeficientes */
        .coeficientes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .coeficientes-table th,
        .coeficientes-table td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .coeficientes-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #333;
        }

        .coeficientes-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .coeficientes-table tr:hover {
            background-color: #f0f7ff;
        }
    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item">
            <i class="fas fa-home"></i>
        </a>
        <a href="editar-gplayer.html" class="menu-item">
            <i class="fas fa-user"></i>
            EDITAR GPLAYER
        </a>
        <a href="editar-jogo.html" class="menu-item">
            <i class="fas fa-gamepad"></i>
            EDITAR JOGO
        </a>
        <a href="editar-jogadores.html" class="menu-item active">
            <i class="fas fa-users"></i>
            EDITAR JOGADORES
        </a>
        <a href="editar-clubes.html" class="menu-item">
            <i class="fas fa-shield-alt"></i>
            EDITAR CLUBES
        </a>
        <a href="editar-competicoes.html" class="menu-item">
            <i class="fas fa-trophy"></i>
            EDITAR COMPETIÇÕES
        </a>
        <a href="editar-pais.html" class="menu-item">
            <i class="fas fa-globe"></i>
            EDITAR PAIS
        </a>
        <a href="editar-mods.html" class="menu-item">
            <i class="fas fa-puzzle-piece"></i>
            EDITAR MODS
        </a>
        
    </nav>



    <div class="content">
        <a href="gerenciar-jogadores.html" class="menu-item"><i class="fas fa-users"></i> JOGADORES LIVE</a>
        <h1>Editar Jogadores</h1>

        <div class="search-container">
            <input type="text" class="search-input" placeholder="Pesquisar jogador..." id="playerSearch">
            <div class="search-results" id="searchResults"></div>
        </div>

        <form id="editPlayerForm" class="cards-container">
            <div class="card">
                <div class="card-title">Informações Básicas</div>
                <div class="form-group">
                    <label for="playerName">Nome do Jogador</label>
                    <input type="text" class="form-control" id="playerName" readonly>
                </div>

                <div class="form-group">
                    <label for="playerImage">Imagem do Jogador (URL)</label>
                    <input type="text" class="form-control" id="playerImage">
                    <img src="" alt="Preview" class="image-preview" id="imagePreview">
                </div>

                <div class="form-group">
                    <label for="playerCountry">País do Jogador</label>
                    <div class="dropdown">
                        <input type="text" class="form-control" id="playerCountry">
                        <div class="dropdown-results" id="countryResults"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="playerClub">Clube do Jogador</label>
                    <div class="dropdown">
                        <input type="text" class="form-control" id="playerClub">
                        <div class="dropdown-results" id="clubResults"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="playerPosition">Posição do Jogador</label>
                    <select class="form-control" id="playerPosition">
                        <option value="">Selecione a posição</option>
                        <option value="Guarda-Redes">Guarda-Redes</option>
                        <option value="Defesa">Defesa</option>
                        <option value="Médio">Médio</option>
                        <option value="Avançado">Avançado</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Status do Jogador</div>
                <div class="form-group">
                    <label for="playerOverall">Overall do Jogador</label>
                    <input type="number" class="form-control" id="playerOverall" step="0.1" min="0" max="1000">
                </div>

                <div class="form-group">
                    <label for="playerTier">Casta do Jogador</label>
                    <select class="form-control" id="playerTier">
                        <option value="Jogador Ouro">Jogador Ouro</option>
                        <option value="Jogador Prata">Jogador Prata</option>
                        <option value="Jogador Bronze">Jogador Bronze</option>
                        <option value="Jogador Platina">Jogador Platina</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="playerMarket">No Mercado?</label>
                    <select class="form-control" id="playerMarket">
                        <option value="Sim">Sim</option>
                        <option value="Não">Não</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Mini Games? (Opcional)</label>
                    <div class="checkbox-group">
                        <div class="mini-game-option">
                            <label><input type="checkbox" name="mini-games" value="world26" class="mini-game-checkbox"> World26</label>
                            <div class="mini-game-price" style="display: none;">
                                <input type="text" name="world26-preco" maxlength="5" placeholder="Preço" class="mini-game-price-input">
                            </div>
                        </div>
                        <div class="mini-game-option">
                            <label><input type="checkbox" name="mini-games" value="whowins" class="mini-game-checkbox"> WhoWins</label>
                            <div class="mini-game-price" style="display: none;">
                                <input type="text" name="whowins-preco" maxlength="5" placeholder="Preço" class="mini-game-price-input">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-edit">Editar Jogador</button>
            </div>

            <div class="card">
                <div class="card-title">Informações de Mercado</div>
                <div class="form-group">
                    <label for="playerPrice">Preço</label>
                    <input type="number" class="form-control" id="playerPrice" min="0" max="1000">
                </div>

                <div class="form-group">
                    <label for="playerBuyer">Comprado por (Opcional)</label>
                    <select class="form-control" id="playerBuyer">
                        <option value="">Ninguém</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="playerStats">Estatísticas (Opcional)</label>
                <textarea class="form-control" id="playerStats" rows="5"></textarea>
            </div>

            <div id="coeficientes-section" style="display: none;">
                <h3>Coeficientes</h3>
                <div id="firebase-data-display">
                    <div id="loading-indicator" style="display: none; text-align: center; margin-top: 10px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando coeficientes...
                    </div>
                    <!-- A tabela de dados do Firebase será exibida aqui -->
                </div>
            </div>
        </form>
    </div>

    <script type="module">
                  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.firebasestorage.app",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let selectedPlayerId = null;
        let originalClubName = null; // Variável para guardar o clube original

        // Function to fetch GPlayers for the dropdown
        async function fetchGPlayers() {
            const gplayersRef = collection(db, 'gplayers');
            const querySnapshot = await getDocs(gplayersRef);
            return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }


        // Player search functionality
        const playerSearch = document.getElementById('playerSearch');
        const searchResults = document.getElementById('searchResults');

        playerSearch.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length < 1) {
                searchResults.style.display = 'none';
                return;
            }

            const jogadoresRef = collection(db, 'jogadores');
            const snapshot = await getDocs(jogadoresRef);
            const players = [];

            snapshot.forEach(doc => {
                const player = doc.data();
                if (player.nome.toLowerCase().includes(searchTerm)) {
                    players.push({ id: doc.id, ...player });
                }
            });

            displaySearchResults(players);
        });

        function displaySearchResults(players) {
            searchResults.innerHTML = '';
            if (players.length > 0) {
                players.forEach(player => {
                    const div = document.createElement('div');
                    div.className = 'player-result';
                    div.innerHTML = `
                        <img src="${player.imagem || 'placeholder.jpg'}" alt="${player.nome}">
                        <span>${player.nome}</span>
                    `;
                    div.addEventListener('click', () => selectPlayer(player));
                    searchResults.appendChild(div);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }

        async function selectPlayer(player) {
            selectedPlayerId = player.id;
            document.getElementById('playerName').value = player.nome;
            document.getElementById('playerImage').value = player.imagem;
            document.getElementById('imagePreview').src = player.imagem;

            // Set default values from player data
            document.getElementById('playerPrice').value = player.preco || ''; // Default price
            document.getElementById('playerBuyer').value = player.compradopor || ''; // Default buyer


            originalClubName = player.clube; // Guarda o nome do clube original

            // Corrigido para usar player.paisId diretamente
            if (player.paisId) {
                const paisesRef = collection(db, 'paises');
                const paisDoc = doc(paisesRef, player.paisId);
                getDoc(paisDoc).then(docSnap => {
                    if (docSnap.exists()) {
                        const paisData = docSnap.data();
                        document.getElementById('playerCountry').value = paisData.nome;
                    } else {
                        document.getElementById('playerCountry').value = '';
                    }
                }).catch(error => {
                    console.error('Erro ao buscar país:', error);
                    document.getElementById('playerCountry').value = '';
                });
            } else {
                document.getElementById('playerCountry').value = '';
            }

            document.getElementById('playerClub').value = player.clube || ''; // CORREÇÃO AQUI
            document.getElementById('playerOverall').value = player.overall;
            document.getElementById('playerTier').value = player.casta;
            document.getElementById('playerMarket').value = player.noMercado ? 'Sim' : 'Não';
            document.getElementById('playerStats').value = player.estatisticas || '';

            // Set default value for "Posição do Jogador" dropdown
            document.getElementById('playerPosition').value = player.posicao || '';

            searchResults.style.display = 'none';
            playerSearch.value = player.nome;

            // Show coeficientes section and display data if player has position
            const coeficientesSection = document.getElementById('coeficientes-section');
            if (player.posicao) {
                coeficientesSection.style.display = 'block';
                displayFirebaseData(player.posicao, player.casta, player.estatisticas || '');
            } else {
                coeficientesSection.style.display = 'none';
            }

            // Set Mini Games checkboxes and prices
            const miniGamesCheckboxes = document.querySelectorAll('.mini-game-checkbox');
            miniGamesCheckboxes.forEach(checkbox => {
                const miniGameValue = checkbox.value;
                const isChecked = player.miniGames && player.miniGames.includes(miniGameValue);
                checkbox.checked = isChecked;

                // Show/hide price input based on checkbox state
                const priceDiv = checkbox.closest('.mini-game-option').querySelector('.mini-game-price');
                priceDiv.style.display = isChecked ? 'inline-block' : 'none';

                // Set price value if available
                if (isChecked) {
                    const priceInput = priceDiv.querySelector('.mini-game-price-input');
                    const priceKey = `${miniGameValue}preco`;
                    if (player[priceKey]) {
                        priceInput.value = player[priceKey];
                    }
                }
            });

             // Populate GPlayers dropdown - moved here to be called after player is selected
            const buyerSelect = document.getElementById('playerBuyer');
            buyerSelect.innerHTML = '<option value="">Ninguém</option>'; // Reset dropdown
            try {
                const gplayers = await fetchGPlayers();
                gplayers.forEach(gplayer => {
                    const option = document.createElement('option');
                    option.value = gplayer.id; // Use ID as value
                    option.textContent = gplayer.nome;
                    buyerSelect.appendChild(option);
                });

                // Set selected buyer after populating dropdown
                if (player.compradopor) {
                    buyerSelect.value = player.compradopor; // Set selected value based on player data
                }
            } catch (error) {
                console.error('Erro ao buscar GPlayers:', error);
            }
        }

        // Image preview
        document.getElementById('playerImage').addEventListener('input', (e) => {
            document.getElementById('imagePreview').src = e.target.value;
        });

        // Add event listener to playerStats textarea to update coeficientes table when content changes
        document.getElementById('playerStats').addEventListener('input', async function() {


    let playerPosition = null;
    if (selectedPlayerId) {
        const playerRef = doc(db, 'jogadores', selectedPlayerId);
        const playerDoc = await getDoc(playerRef);
        if (playerDoc.exists()) {
            const playerData = playerDoc.data();
            playerPosition = playerData.posicao;
        } else {
            console.log("playerDoc DOES NOT exist for selectedPlayerId:", selectedPlayerId);
        }
    }


    // *** Correção: Obter playerCasta DENTRO do event listener ***
    const playerCasta = document.getElementById('playerTier').value; // Obter playerCasta do dropdown AQUI


    if (playerPosition && document.getElementById('coeficientes-section').style.display !== 'none') {
        displayFirebaseData(playerPosition, playerCasta, this.value);
    }
});


        // Add event listeners to mini game checkboxes to show/hide price inputs
        document.querySelectorAll('.mini-game-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const priceDiv = this.closest('.mini-game-option').querySelector('.mini-game-price');
                if (this.checked) {
                    priceDiv.style.display = 'inline-block';
                } else {
                    priceDiv.style.display = 'none';
                }
            });
        });

        // Country search - REMOVED
        const playerCountry = document.getElementById('playerCountry');
        const countryResults = document.getElementById('countryResults');

        playerCountry.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length < 1) {
                countryResults.style.display = 'none';
                return;
            }

            const paisesRef = collection(db, 'paises');
            const snapshot = await getDocs(paisesRef);
            const countries = [];

            snapshot.forEach(doc => {
                const country = doc.data();
                if (country.nome.toLowerCase().includes(searchTerm)) {
                    countries.push(country);
                }
            });

            displayCountryResults(countries);
        });

        function displayCountryResults(countries) {
            countryResults.innerHTML = '';
            if (countries.length > 0) {
                countries.forEach(country => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = country.nome;
                    div.addEventListener('click', () => {
                        playerCountry.value = country.nome;
                        countryResults.style.display = 'none';
                    });
                    countryResults.appendChild(div);
                });
                countryResults.style.display = 'block';
            } else {
                countryResults.style.display = 'none';
            }
        }

        // Club search
        const playerClub = document.getElementById('playerClub');
        const clubResults = document.getElementById('clubResults');

        playerClub.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length < 1) {
                clubResults.style.display = 'none';
                return;
            }

            const clubesRef = collection(db, 'clubes');
            const snapshot = await getDocs(clubesRef);
            const clubs = [];

            snapshot.forEach(doc => {
                const club = doc.data();
                if (club.nome.toLowerCase().includes(searchTerm)) {
                    clubs.push(club);
                }
            });

            displayClubResults(clubs);
        });

        function displayClubResults(clubs) {
            clubResults.innerHTML = '';
            if (clubs.length > 0) {
                clubs.forEach(club => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = `${club.nome} (${club.pais?.nome || ''})`;
                    div.addEventListener('click', () => {
                        playerClub.value = club.nome;
                        clubResults.style.display = 'none';
                    });
                    clubResults.appendChild(div);
                });
                clubResults.style.display = 'block';
            } else {
                clubResults.style.display = 'none';
            }
        }

        // Form submission
        document.getElementById('editPlayerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedPlayerId) return;

            console.log("Botão 'Editar Jogador' clicado!"); // LOG PARA O BOTÃO CLICADO

            try {
                // Get the country name and club name from inputs
                const countryName = document.getElementById('playerCountry').value;
                const newClubName = document.getElementById('playerClub').value;
                const newPrice = parseInt(document.getElementById('playerPrice').value) || null; // Get price value
                const newBuyerId = document.getElementById('playerBuyer').value || null; // Get buyer id

                // Get the player's current data to check for club changes
                const playerRef = doc(db, 'jogadores', selectedPlayerId);
                const playerSnapshot = await getDoc(playerRef);
                const currentPlayerData = playerSnapshot.data();
                const oldClubName = currentPlayerData?.clube;

                // Find the country document by name to get its ID
                const paisesRef = collection(db, 'paises');
                const paisQuery = query(paisesRef, where('nome', '==', countryName));
                const paisSnapshot = await getDocs(paisQuery);

                let paisId = null;
                if (!paisSnapshot.empty) {
                    paisId = paisSnapshot.docs[0].id;
                }

                // Get mini games selections
                const miniGamesCheckboxes = document.querySelectorAll('input[name="mini-games"]:checked');
                const miniGames = Array.from(miniGamesCheckboxes).map(checkbox => checkbox.value);

                // Get mini games prices
                const miniGamesPrices = {};
                miniGamesCheckboxes.forEach(checkbox => {
                    const miniGameValue = checkbox.value;
                    const priceInput = document.querySelector(`input[name="${miniGameValue}-preco"]`);
                    if (priceInput && priceInput.value) {
                        miniGamesPrices[`${miniGameValue}preco`] = priceInput.value;
                    }
                });

                // Update player data
                const playerData = {
                    nome: document.getElementById('playerName').value,
                    imagem: document.getElementById('playerImage').value,
                    pais: countryName,
                    paisId: paisId,
                    clube: newClubName,
                    posicao: document.getElementById('playerPosition').value,
                    overall: parseFloat(document.getElementById('playerOverall').value) || 0,
                    casta: document.getElementById('playerTier').value,
                    noMercado: document.getElementById('playerMarket').value === 'Sim',
                    preco: newPrice,
                    compradopor: newBuyerId,
                    estatisticas: document.getElementById('playerStats').value,
                    miniGames: miniGames.length > 0 ? miniGames : [],
                    ...miniGamesPrices,
                    ultimaAtualizacao: new Date().toISOString()
                };

                // Update player document
                await updateDoc(playerRef, playerData);

                // Conditional club update logic
                if (originalClubName !== newClubName) {
                    // Club changed: transfer player to new club
                    if (oldClubName) {
                        // Find old club and remove player
                        const oldClubQuery = query(collection(db, 'clubes'), where('nome', '==', oldClubName));
                        const oldClubSnapshot = await getDocs(oldClubQuery);
                        if (!oldClubSnapshot.empty) {
                            const oldClubDoc = oldClubSnapshot.docs[0];
                            const oldClubRef = doc(db, 'clubes', oldClubDoc.id, 'jogadores', selectedPlayerId);
                            await deleteDoc(oldClubRef);
                        }
                    }

                    // Add player to new club
                    if (newClubName) {
                        const newClubQuery = query(collection(db, 'clubes'), where('nome', '==', newClubName));
                        const newClubSnapshot = await getDocs(newClubQuery);
                        if (!newClubSnapshot.empty) {
                            const newClubDoc = newClubSnapshot.docs[0];
                            const newClubRef = doc(db, 'clubes', newClubDoc.id, 'jogadores', selectedPlayerId);
                            await setDoc(newClubRef, playerData); // Save all player data to new club
                        }
                    }
                } else {
                    // Club not changed: update player data in the *same* club subcollection
                    if (newClubName) { // Ensure there is a club name (player has a club)
                        const currentClubQuery = query(collection(db, 'clubes'), where('nome', '==', newClubName));
                        const currentClubSnapshot = await getDocs(currentClubQuery);
                        if (!currentClubSnapshot.empty) {
                            const currentClubDoc = currentClubSnapshot.docs[0];
                            const currentClubRef = doc(db, 'clubes', currentClubDoc.id, 'jogadores', selectedPlayerId);
                            await setDoc(currentClubRef, playerData, { merge: true }); // Merge update in existing club
                        }
                    }
                }

                alert('Jogador atualizado com sucesso!');

                // Reset the form here after successful update
                document.getElementById('editPlayerForm').reset();
                document.getElementById('imagePreview').src = ""; // Clear image preview
                selectedPlayerId = null; // Clear selected player ID
                playerSearch.value = ""; // Clear player search input
                document.getElementById('searchResults').style.display = 'none'; // Hide search results
                document.getElementById('coeficientes-section').style.display = 'none'; // Hide coeficientes section


            } catch (error) {
                console.error('Erro ao atualizar jogador:', error);
                alert('Erro ao atualizar jogador');
            }
        });

        // Function to fetch paineis coefficients data
        async function fetchPaineisCoefficients() {
            const paineisRef = doc(db, 'paineis', 'paineis coeficiente');
            const paineisDoc = await getDoc(paineisRef);

            if (paineisDoc.exists() && paineisDoc.data().paineis_coeficiente) {
                return paineisDoc.data().paineis_coeficiente;
            } else {
                console.log("No 'paineis coeficiente' data found.");
                return null;
            }
        }

        // Function to display firebase data in the coeficientes table
        async function displayFirebaseData(selectedPosition, selectedCasta, estatisticasText) {


const firebaseDataDisplay = document.getElementById('firebase-data-display');
    const loadingIndicator = document.getElementById('loading-indicator'); // *** Obter referência ao indicador de carregamento ***
    firebaseDataDisplay.innerHTML = '';

            if (!selectedPosition) {
                return;
            }

            const paineisCoeficienteData = await fetchPaineisCoefficients();

            if (paineisCoeficienteData) {
                // Create table structure
                const table = document.createElement('table');
                table.className = 'coeficientes-table';

                // Create table header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');

                const thSubcategoria = document.createElement('th');
                thSubcategoria.textContent = 'Nome da Subcategoria';

                const thCoeficiente = document.createElement('th');
                thCoeficiente.textContent = 'Coeficientes';

                const thEstatistica = document.createElement('th');
                thEstatistica.textContent = 'Estatística';

                headerRow.appendChild(thSubcategoria);
                headerRow.appendChild(thCoeficiente);
                headerRow.appendChild(thEstatistica);
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Create table body
                const tbody = document.createElement('tbody');
                const rows = []; // Array to hold data rows before sorting
                let totalSum = 0; // Initialize total sum


                // Process data and create rows (but don't append yet)
                for (const categoria in paineisCoeficienteData) {
                    const subcategorias = paineisCoeficienteData[categoria];
                    for (const subcategoriaNome in subcategorias) {
                        const subcategoria = subcategorias[subcategoriaNome];
                        if (subcategoria.tipo) {
                            for (const tipoItem of subcategoria.tipo) {
                                if (tipoItem.name === selectedPosition) {
                                    // Create table row
                                    const row = document.createElement('tr');

                                    // Firebase value (default display text) - Coefficient
                                    let firebaseValue = tipoItem.text || '-';
                                    const coefficientValue = parseFloat(firebaseValue.replace(',', '.')); // Parse coefficient

                                    // Initialize estatisticaValue
                                    let estatisticaValue = '-';
                                    let statisticNumber = 0; // Initialize statistic number

                                    if (estatisticasText) {
                                        const lines = estatisticasText.split('\n');
                                        for (let i = 0; i < lines.length; i++) {
                                            const line = lines[i].trim();
                                            if (line.toLowerCase().startsWith(subcategoriaNome.toLowerCase())) {
                                                let valueLine = lines[i + 1] ? lines[i + 1].trim() : '';
                                                if (valueLine) {
                                                    // Use regex to extract number at the start of the line
                                                    const numberMatch = valueLine.match(/^(\d+(\.\d+)?)/);
                                                    if (numberMatch) {
                                                        estatisticaValue = numberMatch[1]; // Extract the matched number (group 1)
                                                        statisticNumber = parseFloat(estatisticaValue.replace(',', '.')); // Parse statistic
                                                    } else {
                                                        estatisticaValue = '-'; // No number found at the start of the line
                                                        statisticNumber = 0;
                                                    }
                                                    break; // Stop after finding the value for this subcategory
                                                } else {
                                                    estatisticaValue = '-'; // No value line found
                                                    statisticNumber = 0;
                                                }
                                            }
                                        }
                                    } else {
                                        console.log("Caixa 'Estatísticas (Opcional)' está vazia."); // Log when textarea is empty
                                    }


                                    // Calculate row total and add to totalSum
                                    const rowTotal = coefficientValue * statisticNumber;
                                    totalSum += rowTotal;

                                    // Create table cells
                                    const tdSubcategoria = document.createElement('td');
                                    tdSubcategoria.textContent = subcategoriaNome;

                                    const tdCoeficiente = document.createElement('td');
                                    tdCoeficiente.textContent = firebaseValue;

                                    const tdEstatistica = document.createElement('td');
                                    tdEstatistica.textContent = estatisticaValue;

                                    // Add cells to row
                                    row.appendChild(tdSubcategoria);
                                    row.appendChild(tdCoeficiente);
                                    row.appendChild(tdEstatistica);

                                    rows.push(row); // Add row to the array for sorting

                                    break;
                                }
                            }
                        }
                    }
                }

                // Sort rows alphabetically by subcategory name (first cell text)
                rows.sort((rowA, rowB) => {
                    const subcategoriaA = rowA.cells[0].textContent.toLowerCase();
                    const subcategoriaB = rowB.cells[0].textContent.toLowerCase();
                    return subcategoriaA.localeCompare(subcategoriaB);
                });

                // Append sorted data rows to table body
                rows.forEach(row => {
                    tbody.appendChild(row);
                });

                // Create and append "Total" row
                const totalRow = document.createElement('tr');
                const tdTotalLabel = document.createElement('td');
                tdTotalLabel.textContent = 'Total';
                tdTotalLabel.style.fontWeight = 'bold'; // Make "Total" bold
                const tdTotalCoefficient = document.createElement('td');
                tdTotalCoefficient.textContent = '-'; // Or leave it empty
                const tdTotalStatistic = document.createElement('td'); // Changed name to avoid conflict
                tdTotalStatistic.textContent = totalSum.toFixed(2); // Display total sum, formatted to 2 decimal places
                tdTotalStatistic.style.fontWeight = 'bold'; // Make total sum bold

                totalRow.appendChild(tdTotalLabel);
                totalRow.appendChild(tdTotalCoefficient);
                totalRow.appendChild(tdTotalStatistic);
                tbody.appendChild(totalRow);

                // Create and append "Coeficiente" row
                const coeficienteRow = document.createElement('tr');
                const tdCoeficienteLabel = document.createElement('td');
                tdCoeficienteLabel.textContent = 'Coeficiente';
                tdCoeficienteLabel.style.fontWeight = 'bold';

                const tdCastaValue = document.createElement('td');
                let coeficienteCastaValue = '-'; // Default value if not found

                if (paineisCoeficienteData && paineisCoeficienteData['Coeficiente'] && paineisCoeficienteData['Coeficiente']['Coeficiente']) {
                    const coeficienteSubcategory = paineisCoeficienteData['Coeficiente']['Coeficiente'];
                    if (coeficienteSubcategory.casta) {
                        for (const castaItem of coeficienteSubcategory.casta) {
                            if (castaItem.name === selectedCasta) {
                                coeficienteCastaValue = castaItem.text || '-';
                                break; // Found the matching casta, exit loop
                            }
                        }
                    }
                }
                tdCastaValue.textContent = coeficienteCastaValue;
                tdCastaValue.style.fontWeight = 'bold';

                // Calculate and set the value for "Estatística" column in "Coeficiente" row
                let coeficienteStatisticValue = '-';
                const totalStatisticCell = totalRow.querySelector('td:nth-child(3)'); // Get the 3rd cell (Estatística) of the "Total" row
                if (totalStatisticCell) {
                    const totalStatistic = parseFloat(totalStatisticCell.textContent.replace(',', '.'));
                    const coefficientValueForCalculation = parseFloat(coeficienteCastaValue.replace(',', '.')); // Use the coefficient value itself
                    if (!isNaN(coefficientValueForCalculation) && !isNaN(totalStatistic)) {
                        coeficienteStatisticValue = Math.round(coefficientValueForCalculation * totalStatistic); // Rounded to nearest integer
                    }
                }

                const tdEmptyStatistic = document.createElement('td');
                tdEmptyStatistic.textContent = coeficienteStatisticValue;

                coeficienteRow.appendChild(tdCoeficienteLabel);
                coeficienteRow.appendChild(tdCastaValue);
                coeficienteRow.appendChild(tdEmptyStatistic);
                tbody.appendChild(coeficienteRow);

                // Update player overall value if available
                if (coeficienteStatisticValue !== '-') {
                    document.getElementById('playerOverall').value = coeficienteStatisticValue;
                }

                // Add table body to table
                table.appendChild(tbody);

                // Add table to display
                firebaseDataDisplay.appendChild(table);
            } else {
                console.log("No paineis coeficiente data found");
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                searchResults.style.display = 'none';
            }
            if (!e.target.closest('.dropdown')) {
                countryResults.style.display = 'none';
                clubResults.style.display = 'none';
            }
        });
    </script>
</body>
</html>
