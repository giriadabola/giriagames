<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar GPlayer - G EMPIRE</title>
    
    <!-- CSS Externo para ícones (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- 1. CSS EXTERNO: Ligação para os estilos do menu -->
    <link rel="stylesheet" href="css/menu-admin.css">

    <!-- Guardião de segurança -->
    <script type="module" src="js/auth-guard.js"></script>

    <!-- 2. CSS INTERNO: Estilos específicos para esta página (formulário, conteúdo, etc.) -->
    <style>
        /* --- ESTILOS GERAIS DA PÁGINA --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        .content { 
            padding: 80px 20px 20px; /* 80px no topo para compensar o menu fixo */
            max-width: 1200px; 
            margin: 0 auto; 
        }
        h1 { 
            color: #333; 
            margin-bottom: 30px; 
            text-align: center; 
        }

        /* --- ESTILOS DO FORMULÁRIO --- */
        .form-container { 
            max-width: 600px; 
            margin: 20px auto; 
            background-color: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            color: #555; 
            font-weight: bold; 
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 16px; 
        }
        .form-group select { 
            appearance: none; -webkit-appearance: none; -moz-appearance: none; 
            background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); 
            background-repeat: no-repeat; background-position-x: 98%; background-position-y: center; 
        }
        .submit-btn { 
            padding: 10px 20px; 
            width: 100%;
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            background-color: #28a745; 
            color: white; 
            transition: background-color 0.3s ease; 
        }
        .submit-btn:hover { 
            background-color: #218838; 
        }

        /* --- ESTILOS DAS MENSAGENS DE FEEDBACK --- */
        .message-box { 
            text-align: center; 
            margin-top: 15px; 
            padding: 10px; 
            border-radius: 4px; 
            display: none; 
        }
        .error-message { 
            background-color: #ffdddd; 
            color: #d8000c; 
            border: 1px solid #ff0000; 
        }
        .success-message { 
            background-color: #ddffdd; 
            color: #006400; 
            border: 1px solid #00aa00; 
        }
    </style>
</head>
<body style="display: none;">

    <!-- O menu é carregado aqui. Os seus estilos vêm do ficheiro css/menu-admin.css -->
    <nav id="menu-placeholder" class="top-menu"></nav>

    <div class="content">
        <h1>Criar Novo GPlayer</h1>
        <form id="createGPlayerForm" class="form-container">
            <!-- Credenciais de Acesso -->
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <!-- Dados do Perfil -->
            <div class="form-group">
                <label for="nomeDeUsuario">Nome de Utilizador</label>
                <input type="text" id="nomeDeUsuario" required>
            </div>
            <div class="form-group">
                <label for="nomeTabela">Nome na Tabela (opcional)</label>
                <input type="text" id="nomeTabela">
            </div>
            <div class="form-group">
                <label for="naTabela">Aparece na Tabela?</label>
                <select id="naTabela">
                    <option value="No" selected>No</option>
                    <option value="Yes">Yes</option>
                </select>
            </div>
            <div class="form-group">
                <label for="arena">Arena</label>
                <select id="arena">
                    <option value="" selected>Selecionar Arena</option>
                    <option value="Arena 1">Arena 1</option>
                    <option value="Arena 2">Arena 2</option>
                    <option value="Arena 3">Arena 3</option>
                    <option value="Arena 4">Arena 4</option>
                    <option value="Arena 5">Arena 5</option>
                    <option value="Arena 6">Arena 6</option>
                    <option value="Arena 7">Arena 7</option>
                    <option value="Arena 8">Arena 8</option>
                    <option value="Arena 9">Arena 9</option>
                    <option value="Arena 10">Arena 10</option>
                </select>
            </div>
            
            <!-- Permissões -->
            <div class="form-group">
                <label for="estatuto">Estatuto</label>
                <select id="estatuto">
                    <option value="gplayer" selected>gplayer</option>
                    <option value="ruler">ruler</option>
                    <option value="estafeta">estafeta</option>
                </select>
            </div>
            <div class="form-group">
                <label for="aceite">Conta Aceite?</label>
                <select id="aceite">
                    <option value="No">No</option>
                    <option value="Yes" selected>Yes</option>
                </select>
            </div>
            
            <button type="submit" class="submit-btn">Criar GPlayer</button>
            
            <div id="error-message" class="message-box error-message"></div>
            <div id="success-message" class="message-box success-message"></div>
        </form>
    </div>

    <!-- Script da página para criar o utilizador -->
    <script type="module">
        import { db, auth } from './js/auth-guard.js'; 
        import { createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const createGPlayerForm = document.getElementById('createGPlayerForm');
        const errorMessageDiv = document.getElementById('error-message');
        const successMessageDiv = document.getElementById('success-message');

        function showMessage(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 4000);
        }

        createGPlayerForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nomeDeUsuario = document.getElementById('nomeDeUsuario').value;
            const nomeTabela = document.getElementById('nomeTabela').value;
            const naTabela = document.getElementById('naTabela').value;
            const arena = document.getElementById('arena').value;
            const estatuto = document.getElementById('estatuto').value;
            const aceite = document.getElementById('aceite').value;

            if (!email || !password || !nomeDeUsuario) {
                showMessage(errorMessageDiv, "Email, Password e Nome de Utilizador são obrigatórios.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userDocRef = doc(db, 'users', user.uid);
                await setDoc(userDocRef, {
                    uid: user.uid, email: email, nomeDeUsuario: nomeDeUsuario, nometabela: nomeTabela,
                    natabela: naTabela, arena: arena, estatuto: estatuto, aceite: aceite,
                    createdAt: new Date()
                });

                showMessage(successMessageDiv, "GPlayer criado com sucesso!");
                createGPlayerForm.reset();

            } catch (error) {
                console.error("Erro ao criar utilizador:", error);
                let userMessage = "Ocorreu um erro ao criar o GPlayer.";
                if (error.code === 'auth/email-already-in-use') {
                    userMessage = "Este email já está a ser utilizado por outra conta.";
                } else if (error.code === 'auth/weak-password') {
                    userMessage = "A password deve ter pelo menos 6 caracteres.";
                }
                showMessage(errorMessageDiv, userMessage);
            }
        });
    </script>
    
    <!-- Script para carregar o menu de navegação -->
    <script src="js/menuadmin-loader.js"></script>

</body>
</html>
