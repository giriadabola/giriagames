<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Odds - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .top-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 24px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item:hover, .menu-item.active {
            color: #2176ff;
            background-color: rgba(33, 118, 255, 0.1);
        }

        .content { /* This class seems unused now, can be removed if form-container-wrapper is sufficient */
            padding: 80px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            width: 500px;
            max-width: 95%;
        }

        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .form-group select,
        .form-group input[type="text"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .select2-container {
            width: 100% !important;
        }

        .select2-container--default .select2-selection--multiple {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            box-sizing: border-box;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 3px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white;
            margin-right: 5px;
        }

        .select2-container--default .select2-search--inline .select2-search__field {
            margin-top: 3px;
        }

        .form-group select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position-x: calc(100% - 10px);
            background-position-y: center;
            padding-right: 30px;
        }

        .form-group input[type="number"] {
            -moz-appearance: textfield;
        }

        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        button:hover {
            background-color: #0056b3;
        }

        #categoriaNome,
        #subcategoriaNome,
        #terceiraCategoriaNome,
        #subcategoriaDropdown,
        #terceiraCategoriaDropdown,
        #terceiraCategoriaDropdownSubcategoria,
        #modosSection { /* Added modosSection here */
            display: none;
        }

        .form-container-wrapper {
            padding-top: 80px;
            padding-bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item"><i class="fas fa-home"></i></a>
        <a href="criar-gplayer.html" class="menu-item"><i class="fas fa-user"></i>CRIAR GPLAYER</a>
        <a href="criar-jogo.html" class="menu-item"><i class="fas fa-gamepad"></i>CRIAR JOGO</a>
        <a href="criar-jogadores.html" class="menu-item"><i class="fas fa-users"></i>CRIAR JOGADORES</a>
        <a href="criar-clubes.html" class="menu-item"><i class="fas fa-shield-alt"></i>CRIAR CLUBES</a>
        <a href="criar-competicoes.html" class="menu-item"><i class="fas fa-trophy"></i>CRIAR COMPETIÇÕES</a>
        <a href="criar-pais.html" class="menu-item"><i class="fas fa-globe"></i>CRIAR PAÍS</a>
        <a href="criar-mods.html" class="menu-item"><i class="fas fa-puzzle-piece"></i>CRIAR MODS</a>
        <a href="criar-odds.html" class="menu-item active"><i class="fas fa-percentage"></i>CRIAR ODDS</a>
    </nav>

    <div class="form-container-wrapper">
        <div class="container">
            <h1>Criar Odds</h1>
            <h2>Criar Categoria/Subcategoria/3ª Categoria</h2>
            <form id="categoriaForm">
                <div class="form-group">
                    <label for="tipoCategoria">Tipo de Categoria</label>
                    <select id="tipoCategoria" name="tipoCategoria">
                        <option value="">Selecione</option>
                        <option value="categoria">Categoria</option>
                        <option value="subcategoria">Subcategoria</option>
                        <option value="3cat">3ª Categoria</option>
                    </select>
                </div>

                <div class="form-group" id="categoriaNome">
                    <label for="nomeCategoriaInput">Nome da Categoria</label>
                    <input type="text" id="nomeCategoriaInput" name="nomeCategoriaInput">
                </div>

                <div class="form-group" id="subcategoriaDropdown">
                    <label for="categoriaPaiSubcategoria">Categoria Pai</label>
                    <select id="categoriaPaiSubcategoria" name="categoriaPaiSubcategoria">
                        <option value="">Selecione a Categoria Pai</option>
                    </select>
                </div>

                <div class="form-group" id="subcategoriaNome">
                    <label for="nomeSubcategoriaInput">Nome da Subcategoria</label>
                    <input type="text" id="nomeSubcategoriaInput" name="nomeSubcategoriaInput">
                </div>

                 <div class="form-group" id="terceiraCategoriaDropdown">
                    <label for="categoriaPaiTerceiraCategoria">Categoria Pai</label>
                    <select id="categoriaPaiTerceiraCategoria" name="categoriaPaiTerceiraCategoria">
                        <option value="">Selecione a Categoria Pai</option>
                    </select>
                </div>

                <div class="form-group" id="terceiraCategoriaDropdownSubcategoria">
                    <label for="subcategoriaPaiTerceiraCategoria">Subcategoria Pai</label>
                    <select id="subcategoriaPaiTerceiraCategoria" name="subcategoriaPaiTerceiraCategoria">
                        <option value="">Selecione a Subcategoria Pai</option>
                    </select>
                </div>

                <div class="form-group" id="terceiraCategoriaNome">
                    <label for="nomeTerceiraCategoriaInput">Nome da 3ª Categoria</label>
                    <input type="text" id="nomeTerceiraCategoriaInput" name="nomeTerceiraCategoriaInput">
                </div>

                <div class="form-group">
                    <label for="indiceIngles">Indice Inglês</label>
                    <input type="text" id="indiceIngles" name="indiceIngles" required>
                </div>

                <div class="form-group">
                    <label for="breveDescricao">Breve Descrição</label>
                    <input type="text" id="breveDescricao" name="breveDescricao" value="( )" required>
                </div>

                <div class="form-group">
                    <label for="ordem">Ordem</label> <span id="sugestaoOrdem" style="font-size: 0.9em; color: #777;"></span>
                    <input type="number" id="ordem" name="ordem" required>
                </div>

                <div class="form-group">
                    <label for="competicoes">Competições</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" id="selecionarTudo" style="width: auto; margin-right: 10px;">Selecionar Tudo</button>
                        <button type="button" id="limparSelecao" style="width: auto; background-color: #dc3545;">Tirar todas as seleções</button>
                    </div>
                    <select id="competicoes" name="competicoes" multiple>
                    </select>
                </div>

                <div class="form-group">
                    <label for="icon">Icon / Emoji</label>
                    <input type="text" id="icon" name="icon" placeholder="Insira a URL do ícone ou um Emoji" required>
                </div>

                <div class="form-group">
                    <label for="ativado">Ativado?</label>
                    <input type="checkbox" id="ativado" name="ativado" value="true"> <span style="font-size: 0.9em; color: #777;">(preencha a caixa para ativar)</span>
                </div>

                <!-- MODOS SECTION - START -->
                <div class="form-group" id="modosSection">
                    <label>Modos de Criação Automática</label>
                    <div>
                        <input type="checkbox" id="criarModoSimNao" name="criarModoSimNao">
                        <span style="font-size: 0.9em; color: #777;">Criar Modo Sim/Não</span>
                    </div>
                    <div style="margin-top: 5px;">
                        <input type="checkbox" id="criarModoVencedor" name="criarModoVencedor">
                        <span style="font-size: 0.9em; color: #777;">Criar Modo Win1/Draw/Win2/1X/12/X2</span>
                    </div>
                </div>
                <!-- MODOS SECTION - END -->


                <button type="submit">Criar Odd</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script type="module">
        // Initialize Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0", // KEEP YOUR ACTUAL API KEY
          authDomain: "g-games-8a8fc.firebaseapp.com",
          projectId: "g-games-8a8fc",
          storageBucket: "g-games-8a8fc.appspot.com",
          messagingSenderId: "689897349449",
          appId: "1:689897349449:web:536599794579901beb7a98",
          measurementId: "G-GTTPJ6G5MD"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);

        const tipoCategoriaSelect = document.getElementById('tipoCategoria');
        const competicoesSelect = $('#competicoes');
        const ordemInput = document.getElementById('ordem');
        const sugestaoOrdemSpan = document.getElementById('sugestaoOrdem');

        const categoriaNomeDiv = document.getElementById('categoriaNome');
        const subcategoriaDropdownDiv = document.getElementById('subcategoriaDropdown');
        const subcategoriaNomeDiv = document.getElementById('subcategoriaNome');
        const terceiraCategoriaDropdownDiv = document.getElementById('terceiraCategoriaDropdown');
        const terceiraCategoriaDropdownSubcategoriaDiv = document.getElementById('terceiraCategoriaDropdownSubcategoria');
        const terceiraCategoriaNomeDiv = document.getElementById('terceiraCategoriaNome');
        
        // MODOS SECTION ELEMENTS
        const modosSectionDiv = document.getElementById('modosSection');
        const criarModoSimNaoCheckbox = document.getElementById('criarModoSimNao');
        // NOVO ELEMENTO
        const criarModoVencedorCheckbox = document.getElementById('criarModoVencedor');

        const categoriaPaiSubcategoriaSelect = document.getElementById('categoriaPaiSubcategoria');
        const categoriaPaiTerceiraCategoriaSelect = document.getElementById('categoriaPaiTerceiraCategoria');
        const subcategoriaPaiTerceiraCategoriaSelect = document.getElementById('subcategoriaPaiTerceiraCategoria');
        const iconInput = document.getElementById('icon');

        competicoesSelect.select2({
            placeholder: 'Pesquisar e selecionar competições', allowClear: true, width: '100%', language: 'pt',
            theme: 'default', dropdownAutoWidth: true, dropdownParent: competicoesSelect.parent(),
            minimumInputLength: 0, templateResult: formatCompeticao, templateSelection: formatCompeticao,
            minimumResultsForSearch: -1, closeOnSelect: false,
        });

           async function preencherIconePelaCategoriaPai(categoriaId) {
            // Limpa o campo se nenhuma categoria for selecionada
            if (!categoriaId) {
                iconInput.value = '';
                return;
            }
            try {
                const docSnap = await db.collection('oddcategorias').doc(categoriaId).get();
                if (docSnap.exists) {
                    // Preenche o campo de ícone com o valor do documento pai
                    const iconValue = docSnap.data().icon;
                    if (iconValue) {
                        iconInput.value = iconValue;
                    } else {
                        iconInput.value = ''; // Limpa se o campo 'icon' não existir no pai
                    }
                } else {
                    iconInput.value = ''; // Limpa se o documento pai não for encontrado
                }
            } catch (error) {
                console.error("Erro ao buscar ícone da categoria pai:", error);
                iconInput.value = ''; // Limpa em caso de erro
            }
        }

        function formatCompeticao(competicao) {
            if (!competicao.id) return competicao.text;
            return $('<span><i class="fas fa-trophy" style="color: black;"></i> ' + competicao.text + '</span>');
        }

        async function carregarCompeticoes() {
            try {
                const competicoesSnapshot = await db.collection('competicoes').get();
                const paisesSnapshot = await db.collection('paises').get();
                const paisesMap = {};
                paisesSnapshot.forEach(doc => { paisesMap[doc.id] = doc.data().nome; });
                competicoesSelect.empty();
                const competicoesData = [];
                competicoesSnapshot.forEach(doc => {
                    const competicao = doc.data();
                    const paisNome = paisesMap[competicao.paisId] || 'País Desconhecido';
                    competicoesData.push({
                        id: doc.id, text: `${paisNome}: ${competicao.nome}`,
                        value: competicao.nome, paisNome: paisNome // Assuming 'competicao.nome' is the value to store
                    });
                });
                competicoesData.sort((a, b) => a.paisNome.localeCompare(b.paisNome) || a.text.localeCompare(b.text));
                competicoesData.forEach(c => competicoesSelect.append(new Option(c.text, c.value, false, false)));
                competicoesSelect.trigger('change');
            } catch (error) { console.error('Erro ao carregar competições:', error); }
        }
        carregarCompeticoes();

        $('#selecionarTudo').on('click', () => { $('#competicoes > option').prop('selected', true).trigger('change'); });
        $('#limparSelecao').on('click', () => { $('#competicoes').val(null).trigger('change'); });


        async function popularDropdownCategorias() {
            categoriaPaiSubcategoriaSelect.innerHTML = '<option value="">Selecione a Categoria Pai</option>';
            categoriaPaiTerceiraCategoriaSelect.innerHTML = '<option value="">Selecione a Categoria Pai</option>';
            try {
                const querySnapshot = await db.collection('oddcategorias')
                    .where('categoria_subcategoria_3cat', '==', 'categoria').orderBy('ordem', 'asc').get();
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    [categoriaPaiSubcategoriaSelect, categoriaPaiTerceiraCategoriaSelect].forEach(sel => {
                        sel.appendChild(new Option(data.nomecategoria, doc.id));
                    });
                });
            } catch (error) { console.error('Error fetching categories:', error); }
        }

        async function popularDropdownSubcategorias(categoriaId) {
            subcategoriaPaiTerceiraCategoriaSelect.innerHTML = '<option value="">Selecione a Subcategoria Pai</option>';
            if (!categoriaId) { atualizarSugestaoOrdem(); return; }
            try {
                const querySnapshot = await db.collection('oddcategorias')
                    .where('categoria_subcategoria_3cat', '==', 'subcategoria')
                    .where('categoriapai', '==', categoriaId).orderBy('ordem', 'asc').get();
                querySnapshot.forEach(doc => {
                    subcategoriaPaiTerceiraCategoriaSelect.appendChild(new Option(doc.data().nomesubcategoria, doc.id));
                });
            } catch (error) { console.error('Error fetching subcategories:', error); }
            atualizarSugestaoOrdem();
        }

        async function atualizarSugestaoOrdem() {
            const tipoSelecionado = tipoCategoriaSelect.value;
            sugestaoOrdemSpan.textContent = '(A calcular...)';
            ordemInput.value = '';
            try {
                let query, count = 0, shouldQuery = false, conditionMet = true;
                if (tipoSelecionado === 'categoria') {
                    query = db.collection('oddcategorias').where('categoria_subcategoria_3cat', '==', 'categoria');
                    shouldQuery = true;
                } else if (tipoSelecionado === 'subcategoria') {
                    const categoriaPaiId = categoriaPaiSubcategoriaSelect.value;
                    if (categoriaPaiId) {
                        query = db.collection('oddcategorias').where('categoria_subcategoria_3cat', '==', 'subcategoria').where('categoriapai', '==', categoriaPaiId);
                        shouldQuery = true;
                    } else { sugestaoOrdemSpan.textContent = '(Selecione Categoria Pai)'; conditionMet = false; }
                } else if (tipoSelecionado === '3cat') {
                    const categoriaPaiId = categoriaPaiTerceiraCategoriaSelect.value;
                    const subcategoriaPaiId = subcategoriaPaiTerceiraCategoriaSelect.value;
                    if (!categoriaPaiId) { sugestaoOrdemSpan.textContent = '(Selecione Categoria Pai primeiro)'; conditionMet = false; }
                    else if (!subcategoriaPaiId) { sugestaoOrdemSpan.textContent = '(Selecione Subcategoria Pai)'; conditionMet = false; }
                    else {
                        query = db.collection('oddcategorias').where('categoria_subcategoria_3cat', '==', '3cat').where('subcategoriapai', '==', subcategoriaPaiId);
                        shouldQuery = true;
                    }
                } else { sugestaoOrdemSpan.textContent = ''; conditionMet = false; }

                if (shouldQuery && conditionMet && query) {
                    const snapshot = await query.get();
                    count = snapshot.size;
                    const suggestedValue = count + 1;
                    sugestaoOrdemSpan.textContent = `(Automático: ${suggestedValue})`;
                    ordemInput.value = suggestedValue;
                } else if (!conditionMet) { /* Message set, input cleared */ }
                else { sugestaoOrdemSpan.textContent = '(Aguardando seleção)'; }
            } catch (error) {
                console.error("Erro ao calcular ordem sugerida:", error);
                sugestaoOrdemSpan.textContent = '(Erro ao calcular)';
                ordemInput.value = '';
            }
        }

       tipoCategoriaSelect.addEventListener('change', function() {
            const tipoSelecionado = this.value;
            [categoriaNomeDiv, subcategoriaDropdownDiv, subcategoriaNomeDiv, terceiraCategoriaDropdownDiv, 
             terceiraCategoriaDropdownSubcategoriaDiv, terceiraCategoriaNomeDiv, modosSectionDiv].forEach(el => el.style.display = 'none');
            criarModoSimNaoCheckbox.checked = false; 
            criarModoVencedorCheckbox.checked = false; // Always reset checkboxes when type changes

            iconInput.value = ''; // MUDANÇA: Limpa o campo do ícone ao trocar de tipo

            if (tipoSelecionado !== 'subcategoria') categoriaPaiSubcategoriaSelect.value = '';
            if (tipoSelecionado !== '3cat') {
                categoriaPaiTerceiraCategoriaSelect.value = '';
                subcategoriaPaiTerceiraCategoriaSelect.innerHTML = '<option value="">Selecione a Subcategoria Pai</option>';
                subcategoriaPaiTerceiraCategoriaSelect.value = '';
            }

            if (tipoSelecionado === 'categoria') categoriaNomeDiv.style.display = 'block';
            else if (tipoSelecionado === 'subcategoria') {
                subcategoriaDropdownDiv.style.display = 'block'; 
                subcategoriaNomeDiv.style.display = 'block';
                modosSectionDiv.style.display = 'block'; // Show Modos for Subcategoria
            } else if (tipoSelecionado === '3cat') {
                terceiraCategoriaDropdownDiv.style.display = 'block';
                terceiraCategoriaDropdownSubcategoriaDiv.style.display = 'block';
                terceiraCategoriaNomeDiv.style.display = 'block';
                if(categoriaPaiTerceiraCategoriaSelect.value) {
                    popularDropdownSubcategorias(categoriaPaiTerceiraCategoriaSelect.value);
                }
            }
            atualizarSugestaoOrdem();
        });

      categoriaPaiSubcategoriaSelect.addEventListener('change', function() {
            if (tipoCategoriaSelect.value === 'subcategoria') {
                atualizarSugestaoOrdem();
                preencherIconePelaCategoriaPai(this.value); // MUDANÇA: Chama a função para preencher o ícone
            }
        });
      categoriaPaiTerceiraCategoriaSelect.addEventListener('change', async function() {
            subcategoriaPaiTerceiraCategoriaSelect.innerHTML = '<option value="">Selecione a Subcategoria Pai</option>';
            preencherIconePelaCategoriaPai(this.value); // MUDANÇA: Chama a função para preencher o ícone

            if (this.value) {
                await popularDropdownSubcategorias(this.value);
            } else if (tipoCategoriaSelect.value === '3cat') {
                atualizarSugestaoOrdem();
            }
        });

        popularDropdownCategorias().then(() => { atualizarSugestaoOrdem(); });

        document.getElementById('categoriaForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const tipoCategoriaAtual = tipoCategoriaSelect.value;
            const criarModoSimNaoIsChecked = criarModoSimNaoCheckbox.checked;
            // NOVA VARIÁVEL
            const criarModoVencedorIsChecked = criarModoVencedorCheckbox.checked;

            const competicoesSelecionadas = competicoesSelect.val();
            const isAtivado = document.getElementById('ativado').checked;
            const ordemValue = parseInt(ordemInput.value);
            const indiceInglesValue = document.getElementById('indiceIngles').value;
            const iconValue = document.getElementById('icon').value;

            let formData = {
                competicoes: competicoesSelecionadas || [],
                categoria_subcategoria_3cat: tipoCategoriaAtual,
                ordem: ordemValue,
                indiceIngles: indiceInglesValue,
                icon: iconValue,
                ativado: isAtivado,
                breveDescricao: document.getElementById('breveDescricao').value
            };

            if (!tipoCategoriaAtual) { alert("Por favor, selecione o Tipo de Categoria."); return; }
            if (isNaN(formData.ordem) || formData.ordem <= 0) { alert("Por favor, insira ou permita um valor de Ordem válido."); return; }
            if (!formData.indiceIngles.trim()) { alert("Índice Inglês é obrigatório."); return; }
            if (!formData.icon.trim()) { alert("Icon / Emoji é obrigatório."); return; }


            let categoriaPaiId = '';

            if (tipoCategoriaAtual === 'categoria') {
                if (!document.getElementById('nomeCategoriaInput').value.trim()) { alert("Nome da Categoria é obrigatório."); return; }
                formData.nomecategoria = document.getElementById('nomeCategoriaInput').value;
            } else if (tipoCategoriaAtual === 'subcategoria') {
                categoriaPaiId = categoriaPaiSubcategoriaSelect.value;
                if (!categoriaPaiId) { alert("Categoria Pai para Subcategoria é obrigatória."); return; }
                if (!document.getElementById('nomeSubcategoriaInput').value.trim()) { alert("Nome da Subcategoria é obrigatório."); return; }
                formData.categoriapai = categoriaPaiId;
                formData.nomesubcategoria = document.getElementById('nomeSubcategoriaInput').value;
            } else if (tipoCategoriaAtual === '3cat') {
                 if (!categoriaPaiTerceiraCategoriaSelect.value) { alert("Categoria Pai para 3ª Categoria é obrigatória."); return; }
                 if (!subcategoriaPaiTerceiraCategoriaSelect.value) { alert("Subcategoria Pai para 3ª Categoria é obrigatória."); return; }
                 if (!document.getElementById('nomeTerceiraCategoriaInput').value.trim()) { alert("Nome da 3ª Categoria é obrigatório."); return; }
                formData.categoriapai = categoriaPaiTerceiraCategoriaSelect.value;
                formData.subcategoriapai = subcategoriaPaiTerceiraCategoriaSelect.value;
                formData.nome3categoria = document.getElementById('nomeTerceiraCategoriaInput').value;
            }

            try {
                const docRef = await db.collection("oddcategorias").add(formData);
                console.log("Documento principal escrito com ID: ", docRef.id);
                let mainAlertMessage = "Odd principal criada com sucesso!";

                const novaSubcategoriaId = docRef.id;
                const todasCompeticoes = [];
                $('#competicoes > option').each(function() {
                    todasCompeticoes.push(this.value);
                });


                // --- START: Create Sim/Nao Modes if applicable ---
                if (tipoCategoriaAtual === 'subcategoria' && criarModoSimNaoIsChecked) {
                    const modoSimData = {
                        categoria_subcategoria_3cat: "3cat", categoriapai: categoriaPaiId, subcategoriapai: novaSubcategoriaId,
                        nome3categoria: "Sim", indiceIngles: "Yes", breveDescricao: " ", ordem: 1,
                        competicoes: todasCompeticoes, icon: iconValue, ativado: true
                    };
                    const modoNaoData = { ...modoSimData, nome3categoria: "Não", indiceIngles: "No", ordem: 2 };

                    await Promise.all([
                        db.collection("oddcategorias").add(modoSimData),
                        db.collection("oddcategorias").add(modoNaoData)
                    ]);
                    console.log("Modos Sim/Não criados com sucesso para subcategoria ID:", novaSubcategoriaId);
                    mainAlertMessage += "\nModos Sim/Não criados automaticamente.";
                }
                
                // --- START: NOVO BLOCO PARA MODO VENCEDOR ---
                if (tipoCategoriaAtual === 'subcategoria' && criarModoVencedorIsChecked) {
                    const modosVencedor = [
                        { nome: "Equipa da Casa Ganha", indice: "Win1", ordem: 1 },
                        { nome: "Empate", indice: "Draw", ordem: 2 },
                        { nome: "Equipa B Ganha", indice: "Win2", ordem: 3 },
                        { nome: "Equipa da casa Ganha ou Empata", indice: "1X", ordem: 4 },
                        { nome: "Não há Empate", indice: "12", ordem: 5 },
                        { nome: "Equipa visitante Ganha ou Empata", indice: "X2", ordem: 6 }
                    ];

                    const creationPromises = modosVencedor.map(modo => {
                        const modoData = {
                            categoria_subcategoria_3cat: "3cat",
                            categoriapai: categoriaPaiId,
                            subcategoriapai: novaSubcategoriaId,
                            nome3categoria: modo.nome,
                            indiceIngles: modo.indice,
                            breveDescricao: "", // Vazio conforme pedido
                            ordem: modo.ordem,
                            competicoes: todasCompeticoes, // Selecionar todas
                            icon: "⏱", // Ícone específico
                            ativado: true // Ativado
                        };
                        return db.collection("oddcategorias").add(modoData);
                    });

                    await Promise.all(creationPromises);
                    console.log("Modos Vencedor/Dupla Chance criados com sucesso para subcategoria ID:", novaSubcategoriaId);
                    mainAlertMessage += "\nModos Vencedor/Dupla Chance (1X2) criados automaticamente.";
                }
                // --- END: NOVO BLOCO PARA MODO VENCEDOR ---

                alert(mainAlertMessage);

                this.reset(); 
                competicoesSelect.val(null).trigger('change');
                
                tipoCategoriaSelect.value = ""; 
                tipoCategoriaSelect.dispatchEvent(new Event('change')); 
                
                await popularDropdownCategorias(); 
                atualizarSugestaoOrdem(); 
                
                window.scrollTo(0, 0);

            } catch (error) {
                console.error("Erro durante o processo de criação: ", error);
                alert("Ocorreu um erro. Veja a console para mais detalhes.");
            }
        });
    </script>
</body>
</html>
