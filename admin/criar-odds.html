<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Odds - G EMPIRE</title>
    <!-- Dependências de Estilo -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- 1. Adiciona o nosso guardião de segurança. Ele deve ser o primeiro script. -->
    <script type="module" src="js/auth-guard.js"></script>

    <style>
        /* O seu CSS completo e sem abreviações */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; font-size: 14px; line-height: 1.4; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .form-container-wrapper { padding-top: 80px; padding-bottom: 20px; width: 100%; display: flex; justify-content: center; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); width: 500px; max-width: 95%; }
        h1, h2 { text-align: center; color: #333; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        .form-group select, .form-group input[type="text"], .form-group input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .form-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position-x: calc(100% - 10px); background-position-y: center; padding-right: 30px; }
        .form-group input[type="number"] { -moz-appearance: textfield; }
        .form-group input[type="number"]::-webkit-outer-spin-button, .form-group input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        button { background-color: #007bff; color: #fff; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; width: 100%; box-sizing: border-box; }
        button:hover { background-color: #0056b3; }
        #categoriaNome, #subcategoriaNome, #terceiraCategoriaNome, #subcategoriaDropdown, #terceiraCategoriaDropdown, #terceiraCategoriaDropdownSubcategoria, #modosSection { display: none; }
        /* Estilos para o Select2 */
        .select2-container { width: 100% !important; }
        .select2-container--default .select2-selection--multiple { border: 1px solid #ddd; border-radius: 4px; padding: 5px; box-sizing: border-box; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice { background-color: #007bff; border: none; color: white; padding: 5px 10px; margin: 3px; border-radius: 3px; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove { color: white; margin-right: 5px; }
        .select2-container--default .select2-search--inline .select2-search__field { margin-top: 3px; }
    </style>
</head>
<body style="display: none;"> <!-- 2. O corpo da página está oculto por padrão -->

    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item"><i class="fas fa-home"></i></a>
        <a href="criar-gplayer.html" class="menu-item"><i class="fas fa-user"></i>CRIAR GPLAYER</a>
        <a href="criar-jogo.html" class="menu-item"><i class="fas fa-gamepad"></i>CRIAR JOGO</a>
        <a href="criar-jogadores.html" class="menu-item"><i class="fas fa-users"></i>CRIAR JOGADORES</a>
        <a href="criar-clubes.html" class="menu-item"><i class="fas fa-shield-alt"></i>CRIAR CLUBES</a>
        <a href="criar-competicoes.html" class="menu-item"><i class="fas fa-trophy"></i>CRIAR COMPETIÇÕES</a>
        <a href="criar-pais.html" class="menu-item"><i class="fas fa-globe"></i>CRIAR PAÍS</a>
        <a href="criar-mods.html" class="menu-item"><i class="fas fa-puzzle-piece"></i>CRIAR MODS</a>
        <a href="criar-odds.html" class="menu-item active"><i class="fas fa-percentage"></i>CRIAR ODDS</a>
    </nav>

    <div class="form-container-wrapper">
        <div class="container">
            <h1>Criar Odds</h1>
            <h2>Criar Categoria/Subcategoria/3ª Categoria</h2>
            <form id="categoriaForm">
                <div class="form-group"><label for="tipoCategoria">Tipo de Categoria</label><select id="tipoCategoria" name="tipoCategoria"><option value="">Selecione</option><option value="categoria">Categoria</option><option value="subcategoria">Subcategoria</option><option value="3cat">3ª Categoria</option></select></div>
                <div class="form-group" id="categoriaNome"><label for="nomeCategoriaInput">Nome da Categoria</label><input type="text" id="nomeCategoriaInput" name="nomeCategoriaInput"></div>
                <div class="form-group" id="subcategoriaDropdown"><label for="categoriaPaiSubcategoria">Categoria Pai</label><select id="categoriaPaiSubcategoria" name="categoriaPaiSubcategoria"><option value="">Selecione a Categoria Pai</option></select></div>
                <div class="form-group" id="subcategoriaNome"><label for="nomeSubcategoriaInput">Nome da Subcategoria</label><input type="text" id="nomeSubcategoriaInput" name="nomeSubcategoriaInput"></div>
                <div class="form-group" id="terceiraCategoriaDropdown"><label for="categoriaPaiTerceiraCategoria">Categoria Pai</label><select id="categoriaPaiTerceiraCategoria" name="categoriaPaiTerceiraCategoria"><option value="">Selecione a Categoria Pai</option></select></div>
                <div class="form-group" id="terceiraCategoriaDropdownSubcategoria"><label for="subcategoriaPaiTerceiraCategoria">Subcategoria Pai</label><select id="subcategoriaPaiTerceiraCategoria" name="subcategoriaPaiTerceiraCategoria"><option value="">Selecione a Subcategoria Pai</option></select></div>
                <div class="form-group" id="terceiraCategoriaNome"><label for="nomeTerceiraCategoriaInput">Nome da 3ª Categoria</label><input type="text" id="nomeTerceiraCategoriaInput" name="nomeTerceiraCategoriaInput"></div>
                <div class="form-group"><label for="indiceIngles">Indice Inglês</label><input type="text" id="indiceIngles" name="indiceIngles" required></div>
                <div class="form-group"><label for="breveDescricao">Breve Descrição</label><input type="text" id="breveDescricao" name="breveDescricao" value="( )" required></div>
                <div class="form-group"><label for="ordem">Ordem</label> <span id="sugestaoOrdem" style="font-size: 0.9em; color: #777;"></span><input type="number" id="ordem" name="ordem" required></div>
                <div class="form-group"><label for="competicoes">Competições</label><div style="margin-bottom: 10px;"><button type="button" id="selecionarTudo" style="width: auto; margin-right: 10px;">Selecionar Tudo</button><button type="button" id="limparSelecao" style="width: auto; background-color: #dc3545;">Tirar todas as seleções</button></div><select id="competicoes" name="competicoes" multiple></select></div>
                <div class="form-group"><label for="icon">Icon / Emoji</label><input type="text" id="icon" name="icon" placeholder="Insira a URL do ícone ou um Emoji" required></div>
                <div class="form-group"><label for="ativado">Ativado?</label><input type="checkbox" id="ativado" name="ativado" value="true"> <span style="font-size: 0.9em; color: #777;">(preencha a caixa para ativar)</span></div>
                <div class="form-group" id="modosSection">
                    <label>Modos de Criação Automática</label>
                    <div><input type="checkbox" id="criarModoSimNao" name="criarModoSimNao"><span style="font-size: 0.9em; color: #777;">Criar Modo Sim/Não</span></div>
                    <div style="margin-top: 5px;"><input type="checkbox" id="criarModoVencedor" name="criarModoVencedor"><span style="font-size: 0.9em; color: #777;">Criar Modo Win1/Draw/Win2/1X/12/X2</span></div>
                </div>
                <button type="submit">Criar Odd</button>
            </form>
        </div>
    </div>

    <!-- Dependências de Scripts (jQuery e Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- 3. O script da página foi corrigido para usar a versão modular do Firebase -->
    <script type="module">
        // Importa a variável 'db' do guardião e as funções modulares do Firestore
        import { db } from '/js/auth-guard.js';
        import { collection, getDocs, getDoc, doc, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // A inicialização do Firebase foi removida daqui, pois está no guardião.

        const tipoCategoriaSelect = document.getElementById('tipoCategoria');
        const competicoesSelect = $('#competicoes');
        const ordemInput = document.getElementById('ordem');
        const sugestaoOrdemSpan = document.getElementById('sugestaoOrdem');
        const categoriaNomeDiv = document.getElementById('categoriaNome');
        const subcategoriaDropdownDiv = document.getElementById('subcategoriaDropdown');
        const subcategoriaNomeDiv = document.getElementById('subcategoriaNome');
        const terceiraCategoriaDropdownDiv = document.getElementById('terceiraCategoriaDropdown');
        const terceiraCategoriaDropdownSubcategoriaDiv = document.getElementById('terceiraCategoriaDropdownSubcategoria');
        const terceiraCategoriaNomeDiv = document.getElementById('terceiraCategoriaNome');
        const modosSectionDiv = document.getElementById('modosSection');
        const criarModoSimNaoCheckbox = document.getElementById('criarModoSimNao');
        const criarModoVencedorCheckbox = document.getElementById('criarModoVencedor');
        const categoriaPaiSubcategoriaSelect = document.getElementById('categoriaPaiSubcategoria');
        const categoriaPaiTerceiraCategoriaSelect = document.getElementById('categoriaPaiTerceiraCategoria');
        const subcategoriaPaiTerceiraCategoriaSelect = document.getElementById('subcategoriaPaiTerceiraCategoria');
        const iconInput = document.getElementById('icon');

        // Inicializa o Select2 (código original mantido)
        competicoesSelect.select2({
            placeholder: 'Pesquisar e selecionar competições', allowClear: true, width: '100%', language: 'pt',
            theme: 'default', dropdownAutoWidth: true, dropdownParent: competicoesSelect.parent(),
            minimumInputLength: 0, templateResult: formatCompeticao, templateSelection: formatCompeticao,
            minimumResultsForSearch: -1, closeOnSelect: false,
        });

        function formatCompeticao(competicao) {
            if (!competicao.id) return competicao.text;
            return $('<span><i class="fas fa-trophy" style="color: black;"></i> ' + competicao.text + '</span>');
        }

        async function preencherIconePelaCategoriaPai(categoriaId) {
            if (!categoriaId) { iconInput.value = ''; return; }
            try {
                const docRef = doc(db, 'oddcategorias', categoriaId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const iconValue = docSnap.data().icon;
                    iconInput.value = iconValue ? iconValue : '';
                } else {
                    iconInput.value = '';
                }
            } catch (error) {
                console.error("Erro ao buscar ícone da categoria pai:", error);
                iconInput.value = '';
            }
        }

        async function carregarCompeticoes() {
            try {
                const competicoesSnapshot = await getDocs(collection(db, 'competicoes'));
                const paisesSnapshot = await getDocs(collection(db, 'paises'));
                const paisesMap = {};
                paisesSnapshot.forEach(doc => { paisesMap[doc.id] = doc.data().nome; });
                
                competicoesSelect.empty();
                const competicoesData = [];
                competicoesSnapshot.forEach(doc => {
                    const competicao = doc.data();
                    const paisNome = paisesMap[competicao.paisId] || 'País Desconhecido';
                    competicoesData.push({
                        id: doc.id, text: `${paisNome}: ${competicao.nome}`,
                        value: competicao.nome, paisNome: paisNome
                    });
                });
                competicoesData.sort((a, b) => a.paisNome.localeCompare(b.paisNome) || a.text.localeCompare(b.text));
                competicoesData.forEach(c => competicoesSelect.append(new Option(c.text, c.value, false, false)));
                competicoesSelect.trigger('change');
            } catch (error) { console.error('Erro ao carregar competições:', error); }
        }

        async function popularDropdownCategorias() {
            categoriaPaiSubcategoriaSelect.innerHTML = '<option value="">Selecione a Categoria Pai</option>';
            categoriaPaiTerceiraCategoriaSelect.innerHTML = '<option value="">Selecione a Categoria Pai</option>';
            try {
                const q = query(collection(db, 'oddcategorias'), where('categoria_subcategoria_3cat', '==', 'categoria'), orderBy('ordem', 'asc'));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const option = new Option(data.nomecategoria, doc.id);
                    categoriaPaiSubcategoriaSelect.appendChild(option.cloneNode(true));
                    categoriaPaiTerceiraCategoriaSelect.appendChild(option);
                });
            } catch (error) { console.error('Error fetching categories:', error); }
        }

        async function popularDropdownSubcategorias(categoriaId) {
            subcategoriaPaiTerceiraCategoriaSelect.innerHTML = '<option value="">Selecione a Subcategoria Pai</option>';
            if (!categoriaId) { atualizarSugestaoOrdem(); return; }
            try {
                const q = query(collection(db, 'oddcategorias'), where('categoria_subcategoria_3cat', '==', 'subcategoria'), where('categoriapai', '==', categoriaId), orderBy('ordem', 'asc'));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => {
                    subcategoriaPaiTerceiraCategoriaSelect.appendChild(new Option(doc.data().nomesubcategoria, doc.id));
                });
            } catch (error) { console.error('Error fetching subcategories:', error); }
            atualizarSugestaoOrdem();
        }

        async function atualizarSugestaoOrdem() {
            const tipoSelecionado = tipoCategoriaSelect.value;
            sugestaoOrdemSpan.textContent = '(A calcular...)';
            ordemInput.value = '';
            try {
                let q;
                let shouldQuery = false;

                if (tipoSelecionado === 'categoria') {
                    q = query(collection(db, 'oddcategorias'), where('categoria_subcategoria_3cat', '==', 'categoria'));
                    shouldQuery = true;
                } else if (tipoSelecionado === 'subcategoria') {
                    const categoriaPaiId = categoriaPaiSubcategoriaSelect.value;
                    if (categoriaPaiId) {
                        q = query(collection(db, 'oddcategorias'), where('categoria_subcategoria_3cat', '==', 'subcategoria'), where('categoriapai', '==', categoriaPaiId));
                        shouldQuery = true;
                    } else { sugestaoOrdemSpan.textContent = '(Selecione Categoria Pai)'; }
                } else if (tipoSelecionado === '3cat') {
                    const subcategoriaPaiId = subcategoriaPaiTerceiraCategoriaSelect.value;
                    if (subcategoriaPaiId) {
                        q = query(collection(db, 'oddcategorias'), where('categoria_subcategoria_3cat', '==', '3cat'), where('subcategoriapai', '==', subcategoriaPaiId));
                        shouldQuery = true;
                    } else { sugestaoOrdemSpan.textContent = '(Selecione Categoria e Subcategoria Pai)'; }
                } else {
                    sugestaoOrdemSpan.textContent = '';
                }

                if (shouldQuery) {
                    const snapshot = await getDocs(q);
                    const count = snapshot.size;
                    const suggestedValue = count + 1;
                    sugestaoOrdemSpan.textContent = `(Automático: ${suggestedValue})`;
                    ordemInput.value = suggestedValue;
                }
            } catch (error) {
                console.error("Erro ao calcular ordem sugerida:", error);
                sugestaoOrdemSpan.textContent = '(Erro ao calcular)';
            }
        }
        
        // Todos os Event Listeners são mantidos
        $('#selecionarTudo').on('click', () => { $('#competicoes > option').prop('selected', true).trigger('change'); });
        $('#limparSelecao').on('click', () => { $('#competicoes').val(null).trigger('change'); });

        tipoCategoriaSelect.addEventListener('change', function() {
            const tipoSelecionado = this.value;
            [categoriaNomeDiv, subcategoriaDropdownDiv, subcategoriaNomeDiv, terceiraCategoriaDropdownDiv, terceiraCategoriaDropdownSubcategoriaDiv, terceiraCategoriaNomeDiv, modosSectionDiv].forEach(el => el.style.display = 'none');
            criarModoSimNaoCheckbox.checked = false;
            criarModoVencedorCheckbox.checked = false;
            iconInput.value = '';
            
            if (tipoSelecionado !== '3cat') { subcategoriaPaiTerceiraCategoriaSelect.innerHTML = '<option value="">Selecione a Subcategoria Pai</option>'; }

            if (tipoSelecionado === 'categoria') { categoriaNomeDiv.style.display = 'block'; }
            else if (tipoSelecionado === 'subcategoria') { subcategoriaDropdownDiv.style.display = 'block'; subcategoriaNomeDiv.style.display = 'block'; modosSectionDiv.style.display = 'block'; }
            else if (tipoSelecionado === '3cat') { terceiraCategoriaDropdownDiv.style.display = 'block'; terceiraCategoriaDropdownSubcategoriaDiv.style.display = 'block'; terceiraCategoriaNomeDiv.style.display = 'block'; }
            
            atualizarSugestaoOrdem();
        });

        categoriaPaiSubcategoriaSelect.addEventListener('change', function() {
            atualizarSugestaoOrdem();
            preencherIconePelaCategoriaPai(this.value);
        });

        categoriaPaiTerceiraCategoriaSelect.addEventListener('change', async function() {
            preencherIconePelaCategoriaPai(this.value);
            await popularDropdownSubcategorias(this.value);
        });

        subcategoriaPaiTerceiraCategoriaSelect.addEventListener('change', function() {
             atualizarSugestaoOrdem();
        });

        document.getElementById('categoriaForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const tipoCategoriaAtual = tipoCategoriaSelect.value;
            let categoriaPaiId = '';

            const formData = {
                competicoes: competicoesSelect.val() || [],
                categoria_subcategoria_3cat: tipoCategoriaAtual,
                ordem: parseInt(ordemInput.value),
                indiceIngles: document.getElementById('indiceIngles').value,
                icon: document.getElementById('icon').value,
                ativado: document.getElementById('ativado').checked,
                breveDescricao: document.getElementById('breveDescricao').value
            };
            
            // Validações
            if (!tipoCategoriaAtual) { alert("Por favor, selecione o Tipo de Categoria."); return; }
            if (isNaN(formData.ordem) || formData.ordem <= 0) { alert("Por favor, insira um valor de Ordem válido."); return; }

            if (tipoCategoriaAtual === 'categoria') { formData.nomecategoria = document.getElementById('nomeCategoriaInput').value; }
            else if (tipoCategoriaAtual === 'subcategoria') {
                categoriaPaiId = categoriaPaiSubcategoriaSelect.value;
                if (!categoriaPaiId) { alert("Categoria Pai é obrigatória."); return; }
                formData.categoriapai = categoriaPaiId;
                formData.nomesubcategoria = document.getElementById('nomeSubcategoriaInput').value;
            } else if (tipoCategoriaAtual === '3cat') {
                categoriaPaiId = categoriaPaiTerceiraCategoriaSelect.value;
                const subcategoriaPaiId = subcategoriaPaiTerceiraCategoriaSelect.value;
                if (!categoriaPaiId || !subcategoriaPaiId) { alert("Categoria Pai e Subcategoria Pai são obrigatórias."); return; }
                formData.categoriapai = categoriaPaiId;
                formData.subcategoriapai = subcategoriaPaiId;
                formData.nome3categoria = document.getElementById('nomeTerceiraCategoriaInput').value;
            }
            
            try {
                const docRef = await addDoc(collection(db, "oddcategorias"), formData);
                let mainAlertMessage = "Odd principal criada com sucesso!";
                
                if (tipoCategoriaAtual === 'subcategoria') {
                    const novaSubcategoriaId = docRef.id;
                    const todasCompeticoes = $('#competicoes > option').map((_, opt) => opt.value).get();

                    if (criarModoSimNaoCheckbox.checked) {
                        const modoSimData = { ...formData, categoria_subcategoria_3cat: "3cat", subcategoriapai: novaSubcategoriaId, nome3categoria: "Sim", indiceIngles: "Yes", ordem: 1, competicoes: todasCompeticoes, ativado: true };
                        const modoNaoData = { ...modoSimData, nome3categoria: "Não", indiceIngles: "No", ordem: 2 };
                        await addDoc(collection(db, "oddcategorias"), modoSimData);
                        await addDoc(collection(db, "oddcategorias"), modoNaoData);
                        mainAlertMessage += "\nModos Sim/Não criados automaticamente.";
                    }

                    if (criarModoVencedorCheckbox.checked) {
                        const modosVencedor = [
                            { nome: "Equipa da Casa Ganha", indice: "Win1", ordem: 1 }, { nome: "Empate", indice: "Draw", ordem: 2 },
                            { nome: "Equipa B Ganha", indice: "Win2", ordem: 3 }, { nome: "Equipa da casa Ganha ou Empata", indice: "1X", ordem: 4 },
                            { nome: "Não há Empate", indice: "12", ordem: 5 }, { nome: "Equipa visitante Ganha ou Empata", indice: "X2", ordem: 6 }
                        ];
                        const creationPromises = modosVencedor.map(modo => {
                            const modoData = { ...formData, categoria_subcategoria_3cat: "3cat", subcategoriapai: novaSubcategoriaId, nome3categoria: modo.nome, indiceIngles: modo.indice, ordem: modo.ordem, competicoes: todasCompeticoes, icon: "⏱", ativado: true, breveDescricao: "" };
                            return addDoc(collection(db, "oddcategorias"), modoData);
                        });
                        await Promise.all(creationPromises);
                        mainAlertMessage += "\nModos Vencedor/Dupla Chance criados automaticamente.";
                    }
                }
                
                alert(mainAlertMessage);
                this.reset();
                competicoesSelect.val(null).trigger('change');
                tipoCategoriaSelect.value = "";
                tipoCategoriaSelect.dispatchEvent(new Event('change'));
                await popularDropdownCategorias();
                atualizarSugestaoOrdem();
                window.scrollTo(0, 0);
            } catch (error) {
                console.error("Erro durante o processo de criação: ", error);
                alert("Ocorreu um erro. Veja a console para mais detalhes.");
            }
        });
        
        // Carregamento inicial dos dados
        carregarCompeticoes();
        popularDropdownCategorias();
    </script>
</body>
</html>
