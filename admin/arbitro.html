<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Árbitro - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .top-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 24px;
            align-items: center;
            z-index: 1000; /* Existing z-index */
        }

        .menu-item {
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            line-height: 1.4;
        }

        .menu-item:hover, .menu-item.active {
            color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }

        .menu-item i {
            font-size: 16px;
        }

        .content {
            padding: 80px 20px 20px; /* Adjusted top padding accounts for menu */
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .predictions-list {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .prediction-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .prediction-teams {
            font-weight: bold;
            color: #333;
        }

        .prediction-date {
            color: #666;
            font-size: 0.9em;
        }

        .prediction-values {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .prediction-value {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .prediction-points {
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .points-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
            margin-right: 8px;
        }

        .points-input:focus {
            border-color: #28a745;
            outline: none;
        }

        .status-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .status-select option {
            padding: 4px 8px;
        }

        .status-select.neutro {
            color: #666;
            border-color: #ddd;
        }

        .status-select.acerto {
            color: #28a745;
            border-color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }

        .status-select.falha {
            color: #dc3545;
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        .prediction-label {
            color: #666;
        }

        .prediction-number {
            font-weight: bold;
        }

        .prediction-number.neutro {
            color: #333;
            }

        .prediction-number.acerto {
            color: #28a745;
        }

        .prediction-number.falha {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Filters for the main page content */
        .filter-container {
            display: flex;
            justify-content: center; /* Centered for main filters */
            gap: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .round-filter, .gplayer-filter { /* Shared styles for main filters */
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            color: #333;
            background-color: white;
            cursor: pointer;
            outline: none;
        }

        .round-filter:hover, .gplayer-filter:hover {
            border-color: #28a745;
        }

        .launch-button {
            padding: 8px 16px;
            border: 1px solid #28a745;
            border-radius: 4px;
            font-size: 1em;
            color: white;
            background-color: #28a745;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }

        .launch-button:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        #launch-status-icons {
            margin-left: 8px; /* Adjust spacing as needed */
            display: inline-flex; /* Align icons nicely with the button */
            align-items: center;
        }

        #launch-status-icons i {
            margin-right: 4px; /* Spacing between icons if needed */
        }

        .loading-icon {
            display: none; /* Initially hidden */
            color: #007bff; /* Example loading icon color */
            animation: spin 1s linear infinite; /* Optional spinning animation */
        }

        .success-icon {
            display: none; /* Initially hidden */
            color: #28a745; /* Success icon color (green) */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- CSS FOR GEAR ICON AND POPUP --- */
        #settings-icon-container {
            position: fixed;
            top: 85px;
            right: 25px;
            z-index: 999;
            cursor: pointer;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        #settings-icon-container i {
            font-size: 22px;
            color: #555;
            display: block;
            transition: color 0.3s ease;
        }

        #settings-icon-container:hover i {
            color: #28a745;
        }
         #settings-icon-container:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }


        #settings-popup {
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            min-height: 200px;
            max-height: 80vh;
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            overflow-y: auto;
            cursor: grab;
            resize: both;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #settings-popup:active {
            cursor: grabbing;
        }

        #settings-popup h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            font-size: 1.2em;
        }

        #popup-close {
            position: absolute; /* Changed to absolute for positioning within popup */
            top: 10px;
            right: 15px;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s ease;
            z-index: 1002;
        }

        #popup-close:hover {
            color: #333;
        }

        #popup-close-scrollable {
            position: fixed;
            bottom: 20px;
            right: 35px;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s ease;
            z-index: 1002;
            background-color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #popup-close-scrollable:hover {
            color: #333;
        }

        #popup-close, #popup-close-scrollable {
            cursor: pointer;
        }

        /* --- NEW CSS FOR THE CONVERTER INSIDE THE POPUP --- */
        #settings-popup table { /* Scoped to popup */
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        #settings-popup th, #settings-popup td { /* Scoped to popup */
            border: 1px solid black;
            padding: 8px;
            text-align: left; /* Default alignment */
        }
        #settings-popup th { /* Scoped to popup */
            background-color: #f2f2f2;
            text-align: center; /* Center category header text */
        }
        /* Align second and third columns to the right inside popup tables */
        #settings-popup td:nth-child(2), /* Scoped to popup */
        #settings-popup td:nth-child(3) { /* Scoped to popup */
            text-align: right;
        }

        /* Filter container specifically for the converter inside the popup */
        #settings-popup .converter-filter-container { /* Using a more specific class name */
            display: flex;
            justify-content: flex-end; /* Align right */
            align-items: center; /* Align vertically center */
            margin-bottom: 10px; /* Space below dropdown */
        }

        #settings-popup .converter-filter-container label { /* Scoped to popup */
            margin-right: 10px; /* Space between label and dropdown */
        }

        #settings-popup #inputTextArea { /* Scoped to popup */
            width: 100%; /* Make textarea full width */
            box-sizing: border-box;
            max-height: 150px; /* Adjusted height */
        }

        #settings-popup #categoryFilter { /* Scoped to popup */
            width: auto;
            max-width: 100%;
            box-sizing: border-box;
            padding: 4px 8px; /* Consistent padding */
            font-size: 0.9em; /* Consistent font size */
        }
        #settings-popup button { /* Style button inside popup */
             padding: 8px 16px;
             border: 1px solid #28a745;
             border-radius: 4px;
             font-size: 1em;
             color: white;
             background-color: #28a745;
             cursor: pointer;
             outline: none;
             transition: all 0.3s ease;
             margin-bottom: 15px; /* Add space below button */
        }
        #settings-popup button:hover {
             background-color: #218838;
             border-color: #1e7e34;
        }

        /* --- END OF NEW CSS --- */

    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item"><i class="fas fa-home"></i></a>
        <a href="criar-gplayer.html" class="menu-item"><i class="fas fa-plus"></i> CRIAR</a>
        <a href="editar-gplayer.html" class="menu-item"><i class="fas fa-edit"></i> EDITAR</a>
        <a href="gerenciar-jogadores.html" class="menu-item"><i class="fas fa-users"></i> JOGADORES LIVE</a>
    </nav>

    <!-- Gear Icon -->
    <div id="settings-icon-container" title="Configurações">
        <i class="fas fa-cog"></i>
    </div>

    <!-- Popup (Initially Hidden) -->
    <div id="settings-popup">
        <span id="popup-close" title="Fechar">×</span>
        <span id="popup-close-scrollable" title="Fechar"><i class="fas fa-times"></i></span>

        <!-- == CONVERTER HTML START == -->
        <h2>Colar Bets</h2>

        <textarea id="inputTextArea" rows="10" cols="60" placeholder="Enter text here (e.g., Subcategory Name followed by Option text lines and Odd lines)" onpaste="handlePaste(event)"></textarea>
        <br><br>
        <button onclick="window.convertToTable()">Criar Tabela</button>

        <div class="converter-filter-container"> <!-- Changed class name -->
          <select id="categoryFilter" onchange="window.filterTables()">
             <option value="all">All Categories</option>
             <option value="Resultado Final">1. Resultado Final</option>
             <option value="Golos">2. Golos</option>
             <option value="Handicap">3. Handicap</option>
             <option value="Intervalo/Fim do Jogo (HT/FT)">4. Intervalo/Fim do Jogo (HT/FT)</option>
             <option value="Resultado Exato (Placar)">5. Resultado Exato (Placar)</option>
             <option value="Específicos por Equipa">6. Específicos por Equipa</option>
             <option value="Mercados Combinados">7. Mercados Combinados</option>
             <option value="Tempo (Timing)">8. Tempo (Timing)</option>
             <option value="Por Parte (1ª Parte / 2ª Parte)">9. Por Parte (1ª Parte / 2ª Parte)</option>
             <option value="Mercados Especiais / Eventos">10. Mercados Especiais / Eventos</option>
             <option value="Cantos">11. Cantos</option>
             <option value="Cartões Amarelos">12. Cartões Amarelos</option>
             <option value="Remates à Baliza">13. Remates à Baliza</option>
             <option value="Faltas">14. Faltas</option>
             <option value="Remates Totais">15. Remates Totais</option>
             <option value="16. Jogadores (Totais)">16. Jogadores (Totais)</option>
          </select>
        </div>

        <div id="outputTables"></div>
        <!-- == CONVERTER HTML END == -->

    </div>

    <!-- Main Content Area -->
    <div class="content">
        <h1>Árbitro</h1>
        <div class="filter-container"> <!-- Filters for the main Árbitro content -->
            <select id="round-filter" class="round-filter">
                <option value="">Todas as Rondas</option>
            </select>
            <select id="game-filter" class="round-filter">
                <option value="">Todos os Jogos</option>
            </select>
            <select id="gplayer-filter" class="gplayer-filter">
                <option value="">Todos os GPlayers</option>
            </select>
            <button id="launch-button" class="launch-button">Lançar</button><span id="launch-status-icons"></span>
        </div>
        <div id="predictions-container" class="predictions-list">
            <div class="loading">Carregando palpites...</div>
        </div>
    </div>

    <script>
        // Handle paste event for textarea
        function handlePaste(event) {
            setTimeout(() => {
                const textarea = event.target;
                textarea.value = textarea.value.trimRight() + '/////////////////////////////////////////////////////////////////////////////////////////////////////////\n';
            }, 0);
        }

        // Popup dragging functionality and toggle
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        const popup = document.getElementById('settings-popup');
        const settingsIcon = document.getElementById('settings-icon-container');

        settingsIcon.addEventListener('click', () => {
            if (popup.style.display === 'none' || !popup.style.display) {
                popup.style.display = 'block';
                setTimeout(() => {
                    popup.style.opacity = '1';
                    popup.style.visibility = 'visible';
                }, 10);
            } else {
                popup.style.opacity = '0';
                popup.style.visibility = 'hidden';
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        });

        popup.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;

            if (e.target === popup) {
                isDragging = true;
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                setTranslate(currentX, currentY, popup);
            }
        }

        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate(${xPos}px, ${yPos}px)`;
        }
    </script>

    <script type="module">
        // --- EXISTING FIREBASE JAVASCRIPT MODULE (UNCHANGED) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, where, addDoc, serverTimestamp, getCountFromServer, query, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

         const firebaseConfig = {
             apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0", // Note: Exposing API keys client-side is generally discouraged for production. Consider backend functions or stricter security rules.
             authDomain: "g-games-8a8fc.firebaseapp.com",
             projectId: "g-games-8a8fc",
             storageBucket: "g-games-8a8fc.firebasestorage.app",
             messagingSenderId: "689897349449",
             appId: "1:689897349449:web:536599794579901beb7a98",
             measurementId: "G-GTTPJ6G5MD"
         };

         // Initialize Firebase
         const app = initializeApp(firebaseConfig);
         const db = getFirestore(app);

         // Initialize state variables for main page
         let currentRound = null;
         let currentGame = null;
         let currentGPlayer = null;
         let allPredictions = [];
         let isProcessingLaunch = false; // Flag to track processing state

         // --- Functions for the main Árbitro page (loadPredictions, event listeners, launch logic) ---
         // --- (Omitted for brevity - assumed unchanged as per previous code) ---
         async function loadPredictions() {
             try {
                 const predictionsContainer = document.getElementById('predictions-container');
                 const roundFilter = document.getElementById('round-filter');
                 const palpitesSnapshot = await getDocs(collection(db, 'palpites'));

                 // Store all predictions
                 allPredictions = [];
                 const rounds = new Set();
                 const gplayers = new Set();

                 if (palpitesSnapshot.empty) {
                     predictionsContainer.innerHTML = '<div class="prediction-card">Nenhum palpite encontrado.</div>';
                     return;
                 }

                 // Collect all predictions and rounds
                 for (const palpiteDoc of palpitesSnapshot.docs) {
                     const palpite = palpiteDoc.data();
                     if (palpite.ronda) {
                         rounds.add(palpite.ronda);
                     }
                     if (palpite.nomeDeUsuario) {
                         gplayers.add(palpite.nomeDeUsuario);
                     }
                     allPredictions.push({
                         id: palpiteDoc.id,
                         ...palpite
                     });
                 }

                 // Update round filter options
                 const sortedRounds = Array.from(rounds).sort((a, b) => b - a); // Sort in descending order
                 roundFilter.innerHTML = '<option value="">Todas as Rondas</option>';
                 sortedRounds.forEach(round => {
                     roundFilter.innerHTML += `<option value="${round}">Ronda ${round}</option>`;
                 });

                 // Update game filter based on selected round
                 function updateGameFilter() {
                     const gameFilter = document.getElementById('game-filter');
                     const filteredByRound = currentRound ? allPredictions.filter(p => p.ronda === currentRound) : allPredictions;
                     const games = new Set(filteredByRound.map(p => p.nomeJogo).filter(Boolean));
                     const sortedGames = Array.from(games).sort();

                     gameFilter.innerHTML = '<option value="">Todos os Jogos</option>';
                     sortedGames.forEach(game => {
                         // Extract only team names from the game string by removing date and round info
                         const teamNames = game.split('-')[0].trim(); // This will keep only the "EquipaA vs EquipaB" part
                         gameFilter.innerHTML += `<option value="${game}">${teamNames}</option>`;
                     });
                     gameFilter.value = currentGame || '';
                 }

                 // Event listener for round filter
                 document.getElementById('round-filter').addEventListener('change', (e) => {
                     currentRound = e.target.value === "" ? null : Number(e.target.value);
                     currentGame = null; // Reset game selection when round changes
                     updateGameFilter();
                     loadPredictions();
                 });

                 // Event listener for game filter
                 document.getElementById('game-filter').addEventListener('change', (e) => {
                     currentGame = e.target.value || null;
                     loadPredictions();
                 });

                 // Event listener for gplayer filter
                 document.getElementById('gplayer-filter').addEventListener('change', (e) => {
                     currentGPlayer = e.target.value || null;
                     loadPredictions();
                 });

                 // Set default round to highest when page loads for the first time
                 if (sortedRounds.length > 0 && currentRound === null) {
                     currentRound = sortedRounds[0];
                     roundFilter.value = currentRound;
                 } else {
                     // Maintain the selected round in the dropdown
                     roundFilter.value = currentRound || '';
                 }

                 updateGameFilter();
                 // Update GPlayer filter options
                 const gplayerFilter = document.getElementById('gplayer-filter');
                 const sortedGPlayers = Array.from(gplayers).sort();
                 gplayerFilter.innerHTML = '<option value="">Todos os GPlayers</option>';
                 sortedGPlayers.forEach(gplayer => {
                     if (gplayer) { // Only add non-empty GPlayer names
                         gplayerFilter.innerHTML += `<option value="${gplayer}">${gplayer}</option>`;
                     }
                 });
                 gplayerFilter.value = currentGPlayer || '';

                 // Filter predictions by selected round, game, and GPlayer
                 let filteredPredictions = allPredictions;

                 if (currentRound) {
                     filteredPredictions = filteredPredictions.filter(p => p.ronda === currentRound);
                 }

                 if (currentGame) {
                     filteredPredictions = filteredPredictions.filter(p => p.nomeJogo === currentGame);
                 }

                 if (currentGPlayer) {
                     filteredPredictions = filteredPredictions.filter(p => p.nomeDeUsuario === currentGPlayer);
                 }

                 let predictionsHTML = '';

                 for (const palpite of filteredPredictions) {
                     try {
                         // Verificar se jogoId existe
                         if (!palpite.jogoId) {
                             console.warn('Palpite sem jogoId encontrado:', palpite);
                             continue; // Pular este palpite
                         }

                         const jogoDoc = await getDoc(doc(db, 'jogos', palpite.jogoId));

                         // Verificar se o documento do jogo existe
                         if (!jogoDoc.exists()) {
                             console.warn(`Jogo com ID ${palpite.jogoId} não encontrado`);
                             continue; // Pular este palpite
                         }

                         const jogo = jogoDoc.data();

                         // Verificar se jogo tem as propriedades necessárias
                         if (!jogo || !jogo.equipaCasaId || !jogo.equipaForaId) {
                             console.warn(`Jogo com ID ${palpite.jogoId} tem dados incompletos:`, jogo);
                             continue; // Pular este palpite
                         }

                         // Get team names
                         const [equipaCasaDoc, equipaForaDoc] = await Promise.all([
                             getDoc(doc(db, 'clubes', jogo.equipaCasaId)),
                             getDoc(doc(db, 'clubes', jogo.equipaForaId))
                         ]);

                     // Add null checks and default values
                     const equipaCasa = equipaCasaDoc && equipaCasaDoc.exists() ? equipaCasaDoc.data()?.nome || 'Equipa Desconhecida' : 'Equipa Desconhecida';
                     const equipaFora = equipaForaDoc && equipaForaDoc.exists() ? equipaForaDoc.data()?.nome || 'Equipa Desconhecida' : 'Equipa Desconhecida';

                     // Format date - com verificação de segurança
                     let dataFormatada = 'Data não disponível';
                     try {
                         if (jogo.dataJogo && typeof jogo.dataJogo.toDate === 'function') {
                             const dataJogo = jogo.dataJogo.toDate();
                             dataFormatada = dataJogo.toLocaleDateString('pt-PT');
                         }
                     } catch (error) {
                         console.warn('Erro ao formatar data do jogo:', error);
                     }

                     // Get user name - com verificação de segurança
                     let userName = 'Usuário Desconhecido';
                     try {
                         if (palpite.userId) {
                             const userDoc = await getDoc(doc(db, 'users', palpite.userId));
                             userName = userDoc.exists() ? userDoc.data()?.nomeDeUsuario || 'Usuário Desconhecido' : 'Usuário Desconhecido';
                         }
                     } catch (error) {
                         console.warn('Erro ao buscar dados do usuário:', error);
                     }

                     // Create prediction values HTML
                     let palpitesHTML = '';
                     // Verificar se jogo.numeroPalpites existe e é um número válido
                     const numeroPalpites = jogo && typeof jogo.numeroPalpites === 'number' ? jogo.numeroPalpites : 0;
                     for (let i = 1; i <= numeroPalpites; i++) {
                         const palpiteKey = `palpite${i}`; // Mantém palpiteKey para referenciar o texto do palpite
                         const pontosKey = `Palpite${i}PontosQuanto`;
                         // Check if palpiteKey exists in palpite data before accessing it
                         if (palpite.hasOwnProperty(palpiteKey)) {
                             palpitesHTML += `
                                 <div class="prediction-value">
                                     <div class="prediction-points">
                                         <span class="prediction-label">Palpite ${i}</span>
                                         <span class="prediction-number ${palpite[`palpite${i}Status`] || 'neutro'}">${palpite[palpiteKey]}</span>  <!--- Mostra o texto do palpite -->
                                     </div>
                                     <input type="number"
                                         class="points-input"
                                         min="0"
                                         max="999"
                                         value="${palpite[pontosKey] || ''}"
                                         data-palpite-id="${palpite.id}"
                                         data-pontos-key="${pontosKey}"
                                         placeholder="Pts">
                                     <select class="status-select ${palpite[`palpite${i}Status`] || 'neutro'}"
                                         data-palpite-id="${palpite.id}"
                                         data-status-key="palpite${i}Status">
                                         <option value="neutro" ${(palpite[`palpite${i}Status`] || 'neutro') === 'neutro' ? 'selected' : ''}>Neutro</option>
                                         <option value="acerto" ${palpite[`palpite${i}Status`] === 'acerto' ? 'selected' : ''}>Acerto</option>
                                         <option value="falha" ${palpite[`palpite${i}Status`] === 'falha' ? 'selected' : ''}>Falha</option>
                                     </select>
                                 </div>`;
                         }
                     }

                     predictionsHTML += `
                         <div class="prediction-card">
                             <div class="prediction-header">
                                 <div class="prediction-teams">${equipaCasa} vs ${equipaFora}</div>
                                 <div class="prediction-date">${dataFormatada} - ${userName}</div>
                             </div>
                             <div class="prediction-values">
                                 ${palpitesHTML}
                             </div>
                         </div>`;
                     } catch (error) {
                         console.error('Erro ao processar palpite:', error, palpite);
                         // Continua para o próximo palpite
                     }
                 }

                 predictionsContainer.innerHTML = predictionsHTML;

                 // Add event listeners to status toggle buttons
                 document.querySelectorAll('.status-select').forEach(select => {
                     select.addEventListener('change', async (e) => {
                         const palpiteId = e.target.dataset.palpiteId;
                         const statusKey = e.target.dataset.statusKey;
                         const newStatus = e.target.value;

                         try {
                             const palpiteRef = doc(db, 'palpites', palpiteId);
                             const updateData = {};
                             updateData[statusKey] = newStatus; // Atualiza usando statusKey correto

                             await updateDoc(palpiteRef, updateData);

                             // Update select appearance
                             e.target.className = `status-select ${newStatus}`;
                             const predictionNumber = e.target.closest('.prediction-value').querySelector('.prediction-number');
                             predictionNumber.className = `prediction-number ${newStatus}`;
                         } catch (error) {
                             console.error('Error updating status:', error);
                             alert('Erro ao atualizar o status. Por favor, tente novamente.');
                         }
                     });
                 });

                 document.querySelectorAll('.points-input').forEach(input => {
                     input.addEventListener('change', async (e) => {
                         const palpiteId = e.target.dataset.palpiteId;
                         const pontosKey = e.target.dataset.pontosKey; // Usa pontosKey correto
                         const value = e.target.value;

                         if (value && (value < 0 || value > 999)) {
                             alert('Por favor, insira um número entre 0 e 999.');
                             e.target.value = '';
                             return;
                         }

                         try {
                             const palpiteRef = doc(db, 'palpites', palpiteId);
                             const updateData = {};
                             updateData[pontosKey] = value ? parseInt(value) : 0; // Atualiza usando pontosKey correto
                             console.log("pontosKey:", pontosKey);
                             console.log("updateData:", updateData);
                             await updateDoc(palpiteRef, updateData);
                             console.log(`Updated ${pontosKey} with value:`, value);
                         } catch (error) {
                             console.error('Error updating points:', error);
                             alert('Erro ao atualizar os pontos. Por favor, tente novamente.');
                             // Revert the input value to its previous state
                             const palpiteDoc = await getDoc(palpiteRef);
                             if (palpiteDoc.exists()) {
                                 e.target.value = palpiteDoc.data()[pontosKey] || '';
                             }
                         }
                     });
                 });
             } catch (error) {
                 console.error('Error loading predictions:', error);
                 document.getElementById('predictions-container').innerHTML =
                     '<div class="prediction-card">Erro ao carregar palpites. Por favor, tente novamente mais tarde.</div>';
             }
         }

         document.getElementById('launch-button').addEventListener('click', async () => {
            const launchButton = document.getElementById('launch-button');
            const statusIconsSpan = document.getElementById('launch-status-icons');

            // Create and display loading icon
            statusIconsSpan.innerHTML = '<i class="fas fa-spinner fa-spin loading-icon"></i>';
            const loadingIcon = statusIconsSpan.querySelector('.loading-icon');
            loadingIcon.style.display = 'inline-block'; // Show loading icon

            launchButton.disabled = true; // Disable button during processing
            isProcessingLaunch = true; // Set processing flag to true

            try {
                const predictions = document.querySelectorAll('#predictions-container .prediction-card'); // Be more specific
                let updateCount = 0;
                const userAggregatedData = {};

                const currentUserId = 'ADMIN_USER_ID'; // PLACEHOLDER - Implement your logic here

                for (const predictionCard of predictions) {
                    const predictionValues = predictionCard.querySelectorAll('.prediction-value');
                    let cardTotalPontosGanhosForMovimento = 0;
                    let cardTotalPontosPossiveis = 0;
                    let cardTotalPontosGanhos = 0;
                    let currentGameTemporada = null;
                    let currentGameCardUserId = null;
                    let currentGameNomeJogo = null;
                    let isFirstPalpite = true; // Flag to get data from the first palpite only

                    for (const value of predictionValues) {
                        const select = value.querySelector('.status-select');
                        const input = value.querySelector('.points-input');
                        const palpiteId = select.dataset.palpiteId;


                        const pontosKey = input.dataset.pontosKey;
                        const palpiteNumberMatch = pontosKey.match(/\d+/);
                        if (!palpiteNumberMatch) continue; // Skip if no number found
                        const palpiteNumber = palpiteNumberMatch[0];

                        const pontosValue = input ? parseInt(input.value) || 0 : 0;
                        const status = select.value;

                        const palpiteRef = doc(db, 'palpites', palpiteId);
                        const updateData = {};

                        // Get userId, temporada, nomeJogo only ONCE per card from the first palpite processed
                        if (isFirstPalpite) {
                            const palpiteDocSnap = await getDoc(palpiteRef);
                            if (palpiteDocSnap.exists()) {
                                const palpiteData = palpiteDocSnap.data();
                                currentGameCardUserId = palpiteData.userId;
                                currentGameTemporada = palpiteData.temporada;
                                currentGameNomeJogo = palpiteData.nomeJogo;
                                isFirstPalpite = false; // Don't fetch again for this card
                            } else {
                                console.warn("Could not fetch palpite data for ID:", palpiteId);
                                break; // Stop processing this card if data cannot be fetched
                            }
                        }

                        updateData[pontosKey] = pontosValue;

                        let pontosGanhosValue = 0;
                        if (status === 'acerto') {
                            pontosGanhosValue = pontosValue;
                            cardTotalPontosGanhos += pontosValue;
                        }
                        const pontosGanhosKey = `Palpite${palpiteNumber}PontosGanhos`;
                        updateData[pontosGanhosKey] = pontosGanhosValue;
                        const gCoinsGanhosKey = `Palpite${palpiteNumber}GCoinsGanhos`;
                        updateData[gCoinsGanhosKey] = pontosGanhosValue;
                        updateData["Analisado"] = "Sim";

                        cardTotalPontosPossiveis += pontosValue;

                        await updateDoc(palpiteRef, updateData);
                        updateCount++;

                        cardTotalPontosGanhosForMovimento += pontosGanhosValue;
                    } // --- END OF PREDICTION VALUE LOOP ---

                    // --- Create/Edit 'movimentos' document (outside prediction value loop) ---
                    if (currentGameNomeJogo && currentGameCardUserId && currentGameTemporada) { // Ensure data is valid
                        const movimentoQuery = query(collection(db, 'movimentos'), where("nomeJogo", "==", currentGameNomeJogo), where("userId", "==", currentGameCardUserId), limit(1));
                        const movimentoSnapshot = await getDocs(movimentoQuery);
                        let movimentoRefToUpdate;

                        const movimentoData = {
                            "de": currentUserId,
                            "estado": "Palpite Paid",
                            "jogadorId": null,
                            "mediapontos": null,
                            "movimentoData": serverTimestamp(),
                            "para": currentGameCardUserId,
                            "posicao": null,
                            "preco": cardTotalPontosGanhosForMovimento,
                            "temporada": currentGameTemporada.replace('/', ''),
                            "userId": currentGameCardUserId,
                            "valorreal": cardTotalPontosGanhosForMovimento,
                            "nomeJogo": currentGameNomeJogo
                        };

                        if (!movimentoSnapshot.empty) {
                            movimentoRefToUpdate = doc(db, 'movimentos', movimentoSnapshot.docs[0].id);
                            try {
                                await updateDoc(movimentoRefToUpdate, movimentoData);
                                console.log('Documento "movimentos" ATUALIZADO com sucesso para o JOGO:', currentGameNomeJogo, 'User:', currentGameCardUserId, 'Pontos:', cardTotalPontosGanhosForMovimento);
                            } catch (error) {
                                console.error('Erro ao ATUALIZAR documento em "movimentos":', error);
                            }
                        } else {
                            try {
                                await addDoc(collection(db, 'movimentos'), movimentoData);
                                console.log('Documento "movimentos" CRIADO com sucesso para o JOGO:', currentGameNomeJogo, 'User:', currentGameCardUserId, 'Pontos:', cardTotalPontosGanhosForMovimento);
                            } catch (error) {
                                console.error('Erro ao CRIAR documento em "movimentos":', error);
                            }
                        }
                    } else {
                        console.warn("Skipping movimento creation/update due to missing data for card:", predictionCard);
                    }
                    // --- END 'movimentos' document handling ---


                    // --- AGGREGATE DATA PER USER ---
                    if (currentGameCardUserId && currentGameTemporada) {
                        if (!userAggregatedData[currentGameCardUserId]) {
                            userAggregatedData[currentGameCardUserId] = {
                                totalPontosPossiveis: 0,
                                totalPontosGanhos: 0,
                                temporada: currentGameTemporada
                            };
                        }
                        userAggregatedData[currentGameCardUserId].totalPontosPossiveis += cardTotalPontosPossiveis;
                        userAggregatedData[currentGameCardUserId].totalPontosGanhos += cardTotalPontosGanhos;
                    }
                    // --- USER DATA AGGREGATION END ---


                } // --- END OF PREDICTION CARD LOOP ---


                // --- UPDATE USER DOCUMENTS WITH AGGREGATED DATA and GCOINS from MOVIMENTOS ---
                for (const userId in userAggregatedData) {
                    const userData = userAggregatedData[userId];
                    const userRef = doc(db, 'users', userId);

                    const temporadaFormatted = userData.temporada.replace('/', '');
                    const temporadaPontosFieldName = `${temporadaFormatted}Pontos`;
                    const temporadaGCoinsFieldName = `${temporadaFormatted}GCoins`;
                    const temporadaPontosPossiveisFieldName = `${temporadaFormatted}PontosPossiveis`;

                    // Query movimentos to sum valorreal for GCoinsGanhos
                    const movimentosQuery = query(collection(db, 'movimentos'),
                        where("userId", "==", userId),
                        where("temporada", "==", temporadaFormatted)
                        // where("estado", "==", "Palpite Paid") // Optional: Add condition if needed
                    );

                    let totalGCoinsGanhosFromMovimentos = 0;
                    try {
                         const movimentosDocs = await getDocs(movimentosQuery);
                         movimentosDocs.forEach(doc => {
                            const movimentoData = doc.data();
                            // Ensure valorreal is a number before adding
                            if (typeof movimentoData.valorreal === 'number') {
                                totalGCoinsGanhosFromMovimentos += movimentoData.valorreal;
                            } else {
                                console.warn(`Movimento for user ${userId}, temporada ${temporadaFormatted} has non-numeric valorreal:`, movimentoData.valorreal);
                            }
                        });

                        const userUpdateData = {
                            [temporadaPontosFieldName]: (userData.totalPontosGanhos || 0),
                            [temporadaGCoinsFieldName]: totalGCoinsGanhosFromMovimentos,
                            [temporadaPontosPossiveisFieldName]: (userData.totalPontosPossiveis || 0)
                        };
                        await updateDoc(userRef, userUpdateData);
                        console.log(`User ${userId} updated for temporada ${temporadaFormatted}:`, userUpdateData);

                    } catch (error) {
                         console.error(`Error fetching movimentos or updating user ${userId} for temporada ${temporadaFormatted}:`, error);
                         // Decide how to handle this error - skip user update? Alert?
                    }
                }
                // --- USER DOCUMENTS UPDATE END ---

                // Success: Display success icon and remove loading icon
                statusIconsSpan.innerHTML = '<i class="fas fa-check-circle success-icon"></i>';
                const successIcon = statusIconsSpan.querySelector('.success-icon');
                successIcon.style.display = 'inline-block';
                loadingIcon.style.display = 'none';


                // Remove success icon after 3 seconds
                setTimeout(() => {
                    statusIconsSpan.innerHTML = '';
                    launchButton.disabled = false;
                    isProcessingLaunch = false;
                }, 3000);


            } catch (error) {
                console.error('General error during launch process:', error);
                alert('Erro geral ao lançar atualizações. Verifique o console para detalhes.');

                if (loadingIcon) loadingIcon.style.display = 'none';
                statusIconsSpan.innerHTML = '';
                launchButton.disabled = false;
                isProcessingLaunch = false;
            }
        });


         // --- ADD BEFOREUNLOAD EVENT LISTENER ---
         window.addEventListener('beforeunload', (event) => {
             if (isProcessingLaunch) {
                 event.preventDefault();
                 event.returnValue = 'As atualizações de palpites estão em andamento. Tem certeza de que deseja sair desta página? Se sair, o processo pode ser interrompido.';
                 return 'As atualizações de palpites estão em andamento. Tem certeza de que deseja sair desta página? Se sair, o processo pode ser interrompido.';
             }
         });

         // Load main page predictions when the page loads
         loadPredictions();

    </script>

    <!-- == CONVERTER JAVASCRIPT START == -->
    <script>
    (function() { // Self-executing anonymous function for the converter

        // List of *FIXED* subcategories (betting markets) expected in the input text
        // Dynamic "Players:" categories are handled separately
        const categories = [ /* List exactly as provided before - Omitted for brevity */
          // 1. Resultado Final
          "Result", "Double Chance", "Draw No Bet", "Total",
          // 2. Golos
          "Both Teams to Score", "Asian Total", "Total Odd/Even", "1st Goal", "2nd Goal", "3rd Goal", "4th Goal", "5th Goal", "Last Goal", "Goal in Both Halves", "Both Halves Over 1.5", "Both Halves Under 1.5", "Both Halves Over 2.5", "Both Halves Under 2.5", "Both Teams to Score in Both Halves", "Total Goals", "Total Goals 0 - 1", "Total Goals 1 - 2", "Total Goals 1 - 3", "Total Goals 2 - 3", "Total Goals 2 - 4", "Total Goals 2 - 5", "Total Goals 2 - 6", "Total Goals 3 - 4", "Total Goals 3 - 5", "Total Goals 4 - 5", "Total Goals 4 - 6", "Scoring draw", "Only One Team to Score", "Both Teams to Score at Least 1 Half", "Race to 2 Goals", "Race to 3 Goals", "1st Goal to Score", "2nd Goal to Score",
          // 3. Handicap
          "Handicap", "Asian Handicap", "European Handicap (0:1)", "European Handicap (0:2)", "European Handicap (1:0)", "European Handicap (2:0)",
          // 4. Intervalo/Fim do Jogo (HT/FT)
          "Half time/Full time", "Half time/Full time - Home/Home", "Half time/Full time - Draw/Home", "Half time/Full time - Draw/Draw", "Half time/Full time - Draw/Away", "Half time/Full time - Away/Away", "Half time/Full time Double Chance",
          // 5. Resultado Exato (Placar)
          "Correct Score", "Match Score 1:0, 2:0 or 2:1", "Match Score 0:0, 1:0 or 2:0", "Match Score 1:0, 2:0 or 1:1", "Match Score 1:0, 2:0 or 3:0", "Match Score 2:0, 3:0 or 3:1", "Match Score 1:0, 0:0 or 0:1", "Match Score 0:1, 0:2 or 1:2", "Match Score 0:0, 0:1 or 0:2", "Match Score 0:1, 0:2 or 1:1", "Match Score 0:1, 0:2 or 0:3", "Match Score 0:2, 0:3 or 1:3",
          // 6. Específicos por Equipa
          "Total Team 1", "Total Team 2", "Total Goals Team 1", "Total Goals Team 2", "Team 1 to Score", "Team 2 to Score", "Goal in Both Halves: Team 1", "Goal in Both Halves: Team 2", "Team 1: Total Goals 0 - 1", "Team 1: Total Goals 1 - 2", "Team 1: Total Goals 1 - 3", "Team 1: Total Goals 1 - 4", "Team 1: Total Goals 2 - 3", "Team 1: Total Goals 2 - 4", "Team 1: Total Goals 3 - 4", "Team 1: Total Goals 3 - 6", "Team 2: Total Goals 0 - 1", "Team 2: Total Goals 1 - 2", "Team 2: Total Goals 1 - 3", "Team 2: Total Goals 1 - 4", "Team 2: Total Goals 2 - 3", "Team 2: Total Goals 2 - 4", "Team 2: Total Goals 3 - 4", "Team 2: Total Goals 3 - 6", "Each Team Over 1.5", "Each Team Under 1.5", "Team 1 to Score 2 Goals in a Row", "Team 1 to Score 3 Goals in a Row", "Team 2 to Score 2 Goals in a Row", "Team 2 to Score 3 Goals in a Row", "Win 1 at Least 1 Half", "Win 2 at Least 1 Half", "Win 1 in Both Halves", "Team 1 Highest Scoring Half", "Team 2 Highest Scoring Half", "Verona to score in only one of halves", "Parma to score in only one of halves", "Team 1 Score Its 1st Goal", "Team 1 Score Its 2nd Goal", "Team 2 to Score Its 1st Goal", "Team 2 to Score Its 2nd Goal",
          // 7. Mercados Combinados
          "Both Teams to Score and Total", "Result and Total", "Double Chance & Total", "Result and Both Teams to Score:", "Double Chance and Both Teams to Score", "Result or Total", "Result or Both Teams To Score:", "Total or Both Teams to Score:", "Team 1 Win 1st Half & Not Win Match", "Team 2 Win 1st Half & Not Win Match", "Team 1 to Score First & Win", "Team 1 to Score First & Not Win", "Team 2 to Score First & Win", "Team 2 to Score First & Not Win", "Team 1 to Win to Nil", "Team 2 to Win to Nil", "1st half Over (0.5) and 2nd half Over (1.5)", "1st half Over (1.5) and 2nd half Over (0.5)", "Total Over (3.5) and 1st half Over (1.5)", "Win1 and 1st half Over (1.5)", "Win2 and 1st half Over (1.5)", "Win1 and 1st half H1 (-1.5)", "Win2 and 1st half H2 (-1.5)", "H1 (-2.5) and 1st half Win1", "H2 (-2.5) and 1st half Win2", "H1 (-1.5) and 1st half Win1", "H2 (-1.5) and 1st half Win2", "Win1 and Team1 Over (1.5)", "Win2 and Team2 Over (1.5)", "Team 1 to Score First and", "Team 2 to Score First and", "Team 1 to Score First and Total", "Team 2 to Score First and Total", "Half time/Full time and Total", "Win1 and Total Goals 2 - 3", "Win2 and Total Goals 2 - 3", "1st Half/2nd Half Both Teams to Score", "1st Half Result or Both Teams To Score:", "2nd Half Result or Both Teams To Score:", "Half time/Full time and Both Teams to Score", "Penalty & Sending Off", "Penalty or Sending Off",
          // 8. Tempo (Timing)
          "Highest Scoring Half", "1st Goal Minute", "2nd Goal Minute", "Goal from 1 to 10 min.", "Goal from 1 to 15 min.", "Goal from 1 to 20 min.", "Goal from 1 to 25 min.", "Goal from 1 to 30 min.", "Goal from 1 to 35 min.", "Goal from 1 to 40 min.", "Goal from 46 to 60 min.", "Goal from 46 to 65 min.", "Goal from 46 to 70 min.", "Goal from 46 to 75 min.", "Goal from 46 to 80 min.", "Goal from 46 to 85 min.", "Goal from 76 to 90+ min.", "Result from 1 to 10 min.", "Result from 1 to 30 min.", "Result from 1 to 50 min.", "Result from 1 to 60 min.", "Result from 1 to 70 min", "Result from 1 to 75 min", "1-15 min.", "16-30 min.", "31-45+ min.", "46-60 min.", "61-75 min.", "76-90+ min.", "Total Goal Minutes",
          // 9. Por Parte (1ª Parte / 2ª Parte)
          "1st Half: Goal", "2nd Half: Goal", "1st Half: Sending Off", "2nd Half: Sending Off", "1st Half: Penalty", "2nd Half: Penalty", "1st half: Both Teams to Score", "2nd half: Both Teams to Score", "1st half: Total", "1st half: Total Team 1", "1st half: Total Team 2", "1st half: Asian Total", "1st half: Total Even/Odd", "2nd half: Total", "2nd half: Total Team 1", "2nd half: Total Team 2", "2nd half: Asian Total", "2nd half: Total Even/Odd", "1st half: Handicap", "1st half: Asian Handicap", "2nd half: Handicap", "2nd half: Asian Handicap", "1st half: Correct Score", "2nd half: Correct Score", "1st half: Result", "1st half: Double Chance", "1st half: Team 1 to Score", "1st half: Team 2 to Score", "1st half: Result and Total", "1st half: Result and Both Teams to Score:", "1st half: 1st Goal", "1st half: 2nd Goal", "1st half: 3rd Goal", "1st half: European Handicap (0:1)", "1st half: European Handicap (1:0)", "1st half: Total Goals 0 - 1", "1st half: Total Goals 1 - 2", "1st half: Total Goals 1 - 3", "1st half: Total Goals 2 - 3", "1st half: Total Goals 2 - 4", "1st half: Total Goals 2 - 5", "1st half: Total Goals 2 - 6", "1st half: Total Goals 3 - 4", "1st half: Total Goals 3 - 5", "1st half: Team 1: Total Goals 0 - 1", "1st half: Team 1: Total Goals 1 - 2", "1st half: Team 1: Total Goals 1 - 3", "1st half: Team 1: Total Goals 1 - 4", "1st half: Team 1: Total Goals 2 - 3", "1st half: Team 1: Total Goals 2 - 4", "1st half: Team 2: Total Goals 0 - 1", "1st half: Team 2: Total Goals 1 - 2", "1st half: Team 2: Total Goals 1 - 3", "1st half: Team 2: Total Goals 1 - 4", "1st half: Team 2: Total Goals 2 - 3", "1st half: Team 2: Total Goals 2 - 4", "1st half: Total Goals Team 1", "1st half: Total Goals Team 2", "1st half: Total Goals", "1st half: Team 1 to Win to Nil", "1st half: Team 2 to Win to Nil", "1st half: Last Goal", "2nd half: Result", "2nd half: Double Chance", "2nd half: Team 1 to Score", "2nd half: Team 2 to Score", "2nd half: 1st Goal", "2nd half: 2nd Goal", "2nd half: 3rd Goal", "2nd half: European Handicap (0:1)", "2nd half: European Handicap (1:0)", "2nd half: Total Goals 0 - 1", "2nd half: Total Goals 1 - 2", "2nd half: Total Goals 1 - 3", "2nd half: Total Goals 2 - 3", "2nd half: Total Goals 2 - 4", "2nd half: Total Goals 2 - 5", "2nd half: Total Goals 2 - 6", "2nd half: Total Goals 3 - 4", "2nd half: Total Goals 3 - 5", "2nd half: Team 1: Total Goals 0 - 1", "2nd half: Team 1: Total Goals 1 - 2", "2nd half: Team 1: Total Goals 1 - 3", "2nd half: Team 1: Total Goals 1 - 4", "2nd half: Team 1: Total Goals 2 - 3", "2nd half: Team 1: Total Goals 2 - 4", "2nd half: Team 2: Total Goals 0 - 1", "2nd half: Team 2: Total Goals 1 - 2", "2nd half: Team 2: Total Goals 1 - 3", "2nd half: Team 2: Total Goals 1 - 4", "2nd half: Team 2: Total Goals 2 - 3", "2nd half: Team 2: Total Goals 2 - 4", "2nd half: Total Goals Team 1", "2nd half: Total Goals Team 2", "2nd half: Total Goals", "2nd half: Team 1 to Win to Nil", "2nd half: Team 2 to Win to Nil", "2nd half: Last Goal", "1st half or match",
          // 10. Mercados Especiais / Eventos
          "Tie Breaker", "Penalty", "Sending Off", "Sending Off Team 1", "Sending Off Team 2", "1st to Happen:", "How is Scored 1st Goal", "Team 1 Winning Margin 1 Goal", "Team 1 Winning Margin 2 Goals", "Team 1 Winning Margin 1 or 2 Goals", "Team 1 Winning Margin 2 or 3 Goals", "Team 1 Winning Margin 2 or more Goals", "Team 1 Winning Margin 1 Goal or Draw", "Team 1 Winning Margin 2 Goals or Draw", "Team 2 Winning Margin 1 Goal", "Team 2 Winning Margin 2 Goals", "Team 2 Winning Margin 1 or 2 Goals", "Team 2 Winning Margin 2 or 3 Goals", "Team 2 Winning Margin 2 or more Goals", "Team 2 Winning Margin 1 Goal or Draw", "Team 2 Winning Margin 2 Goals or Draw", "Draw in at least one of the Halves", "Any Team Winning Margin 1", "Any Team Winning Margin 2", "Any Team Winning Margin 3", "Any Team Winning Margin 2 & more", "Any Team Winning Margin 3 & more", "Team 1 win from Behind", "Team 2 Win from Behind", "Own Goal", "Double", "1:1 During The Match", "2:0 or 0:2 During The Match", "2:0 During The Match", "0:2 During The Match", "To Miss A Penalty", "To Score A Penalty", "Red card in both teams",
          // 11. Cantos
          "Corners: Total", "Corners: Total Team 1", "Corners: Total Team 2", "Corners: Total Even/Odd", "Corners: 1st Half: Total:", "Corners: 1st Half: Total Team 1", "Corners: 1st Half: Total Team 2", "Corners: 2nd Half: Total", "Corners: 2nd Half: Total Team 1", "Corners: 2nd Half: Total Team 2", "Corners: Total (3 way)", "Corners: Handicap", "Corners: 1st Half: Handicap", "Corners: 2nd Half: Handicap", "Corners: Result", "Corners: 1st Half: Result", "Corners: 2nd Half: Result", "Corners: Highest Scoring Half", "Corners: 1st Corner", "Corners: Last Corner:", "Corners: 10 Minutes Corners (00:00-9:59)", "Corners: Race to Corners",
          // 12. Cartões Amarelos
          "Yellow Cards: Total", "Yellow Cards: Total Team 1", "Yellow Cards: Total Team 2", "Yellow Cards: Total Odd/Even", "Yellow Cards: 1st Half: Total:", "Yellow Cards: 1st Half: Total Team 1", "Yellow Cards: 1st Half: Total Team 2", "Yellow Cards: 2nd Half: Total", "Yellow Cards: Handicap", "Yellow Cards: 1st Half: Handicap", "Yellow Cards: 2nd Half: Handicap", "Yellow Cards: Result", "Yellow Cards: Double Chance", "Yellow Cards: 1st Half: Result", "Yellow Cards: 1st Half: Double Chance", "Yellow Cards: 2nd Half: Result", "Yellow Cards: 2nd Half: Double Chance", "Yellow Cards: Highest Scoring Half", "Yellow Cards: 1st Yellow Card Minute", "Yellow Cards: Both Teams to Receive Cards", "Yellow Cards: Both Teams to Receive 2 or More Cards",
          // 13. Remates à Baliza
          "Shots on target: Total", "Shots on target: Total Team 1", "Shots on target: Total Team 2", "Shots on target: Total Even/Odd", "Shots on target: 1st Half: Total:", "Shots on target: 1st Half: Total Team 1", "Shots on target: 1st Half: Total Team 2", "Shots on target: Handicap", "Shots on target: 1st Half: Handicap", "Shots on target: Result", "Shots on target: Double Chance", "Shots on target: 1st Half: Result", "Shots on target: 1st Half: Double Chance", "Shots on target: Highest Scoring Half",
          // 14. Faltas
          "Fouls: Total", "Fouls: Total Team 1", "Fouls: Total Team 2", "Fouls: Total Even/Odd", "Fouls: Handicap", "Fouls: Result", "Fouls: Double Chance", "Fouls: Highest Scoring Half",
          "Offsides: Total", "Offsides: Total Team 1", "Offsides: Total Team 2", "Offsides: Total Even/Odd", "Offsides: Handicap", "Offsides: Result", "Offsides: Double Chance",
          // 15. Remates Totais
          "Shots: Total", "Shots: Total Team 1", "Shots: Total Team 2", "Shots: Total Even/Odd", "Shots: 1st Half: Total Team 1", "Shots: 1st Half: Total Team 2", "Shots: Handicap", "Shots: 1st Half: Handicap", "Shots: Result", "Shots: Double Chance", "Shots: 1st Half: Result", "Shots: 1st Half: Double Chance", "Shots: Highest Scoring Half"
       ];
        const categoryMap = { /* Map exactly as provided before - Omitted for brevity */
          // 1. Resultado Final
          "Result": "Resultado Final", "Double Chance": "Resultado Final", "Draw No Bet": "Resultado Final",
          // 2. Golos
          "Total": "Golos", "Both Teams to Score": "Golos", "Asian Total": "Golos", "Total Odd/Even": "Golos", "1st Goal": "Golos", "2nd Goal": "Golos", "3rd Goal": "Golos", "4th Goal": "Golos", "5th Goal": "Golos", "Last Goal": "Golos", "Goal in Both Halves": "Golos", "Both Halves Over 1.5": "Golos", "Both Halves Under 1.5": "Golos", "Both Halves Over 2.5": "Golos", "Both Halves Under 2.5": "Golos", "Both Teams to Score in Both Halves": "Golos", "Total Goals": "Golos", "Total Goals 0 - 1": "Golos", "Total Goals 1 - 2": "Golos", "Total Goals 1 - 3": "Golos", "Total Goals 2 - 3": "Golos", "Total Goals 2 - 4": "Golos", "Total Goals 2 - 5": "Golos", "Total Goals 2 - 6": "Golos", "Total Goals 3 - 4": "Golos", "Total Goals 3 - 5": "Golos", "Total Goals 4 - 5": "Golos", "Total Goals 4 - 6": "Golos", "Scoring draw": "Golos", "Only One Team to Score": "Golos", "Both Teams to Score at Least 1 Half": "Golos", "Race to 2 Goals": "Golos", "Race to 3 Goals": "Golos", "1st Goal to Score": "Golos", "2nd Goal to Score": "Golos",
          // 3. Handicap
          "Handicap": "Handicap", "Asian Handicap": "Handicap", "European Handicap (0:1)": "Handicap", "European Handicap (0:2)": "Handicap", "European Handicap (1:0)": "Handicap", "European Handicap (2:0)": "Handicap",
          // 4. Intervalo/Fim do Jogo (HT/FT)
          "Half time/Full time": "Intervalo/Fim do Jogo (HT/FT)", "Half time/Full time - Home/Home": "Intervalo/Fim do Jogo (HT/FT)", "Half time/Full time - Draw/Home": "Intervalo/Fim do Jogo (HT/FT)", "Half time/Full time - Draw/Draw": "Intervalo/Fim do Jogo (HT/FT)", "Half time/Full time - Draw/Away": "Intervalo/Fim do Jogo (HT/FT)", "Half time/Full time - Away/Away": "Intervalo/Fim do Jogo (HT/FT)", "Half time/Full time Double Chance": "Intervalo/Fim do Jogo (HT/FT)",
          // 5. Resultado Exato (Placar)
          "Correct Score": "Resultado Exato (Placar)", "Match Score 1:0, 2:0 or 2:1": "Resultado Exato (Placar)", "Match Score 0:0, 1:0 or 2:0": "Resultado Exato (Placar)", "Match Score 1:0, 2:0 or 1:1": "Resultado Exato (Placar)", "Match Score 1:0, 2:0 or 3:0": "Resultado Exato (Placar)", "Match Score 2:0, 3:0 or 3:1": "Resultado Exato (Placar)", "Match Score 1:0, 0:0 or 0:1": "Resultado Exato (Placar)", "Match Score 0:1, 0:2 or 1:2": "Resultado Exato (Placar)", "Match Score 0:0, 0:1 or 0:2": "Resultado Exato (Placar)", "Match Score 0:1, 0:2 or 1:1": "Resultado Exato (Placar)", "Match Score 0:1, 0:2 or 0:3": "Resultado Exato (Placar)", "Match Score 0:2, 0:3 or 1:3": "Resultado Exato (Placar)",
          // 6. Específicos por Equipa
          "Total Team 1": "Específicos por Equipa", "Total Team 2": "Específicos por Equipa", "Total Goals Team 1": "Específicos por Equipa", "Total Goals Team 2": "Específicos por Equipa", "Team 1 to Score": "Específicos por Equipa", "Team 2 to Score": "Específicos por Equipa", "Goal in Both Halves: Team 1": "Específicos por Equipa", "Goal in Both Halves: Team 2": "Específicos por Equipa", "Team 1: Total Goals 0 - 1": "Específicos por Equipa", "Team 1: Total Goals 1 - 2": "Específicos por Equipa", "Team 1: Total Goals 1 - 3": "Específicos por Equipa", "Team 1: Total Goals 1 - 4": "Específicos por Equipa", "Team 1: Total Goals 2 - 3": "Específicos por Equipa", "Team 1: Total Goals 2 - 4": "Específicos por Equipa", "Team 1: Total Goals 3 - 4": "Específicos por Equipa", "Team 1: Total Goals 3 - 6": "Específicos por Equipa", "Team 2: Total Goals 0 - 1": "Específicos por Equipa", "Team 2: Total Goals 1 - 2": "Específicos por Equipa", "Team 2: Total Goals 1 - 3": "Específicos por Equipa", "Team 2: Total Goals 1 - 4": "Específicos por Equipa", "Team 2: Total Goals 2 - 3": "Específicos por Equipa", "Team 2: Total Goals 2 - 4": "Específicos por Equipa", "Team 2: Total Goals 3 - 4": "Específicos por Equipa", "Team 2: Total Goals 3 - 6": "Específicos por Equipa", "Each Team Over 1.5": "Específicos por Equipa", "Each Team Under 1.5": "Específicos por Equipa", "Team 1 to Score 2 Goals in a Row": "Específicos por Equipa", "Team 1 to Score 3 Goals in a Row": "Específicos por Equipa", "Team 2 to Score 2 Goals in a Row": "Específicos por Equipa", "Team 2 to Score 3 Goals in a Row": "Específicos por Equipa", "Win 1 at Least 1 Half": "Específicos por Equipa", "Win 2 at Least 1 Half": "Específicos por Equipa", "Win 1 in Both Halves": "Específicos por Equipa", "Team 1 Highest Scoring Half": "Específicos por Equipa", "Team 2 Highest Scoring Half": "Específicos por Equipa", "Verona to score in only one of halves": "Específicos por Equipa", "Parma to score in only one of halves": "Específicos por Equipa", "Team 1 Score Its 1st Goal": "Específicos por Equipa", "Team 1 Score Its 2nd Goal": "Específicos por Equipa", "Team 2 to Score Its 1st Goal": "Específicos por Equipa", "Team 2 to Score Its 2nd Goal": "Específicos por Equipa",
          // 7. Mercados Combinados
          "Both Teams to Score and Total": "Mercados Combinados", "Result and Total": "Mercados Combinados", "Double Chance & Total": "Mercados Combinados", "Result and Both Teams to Score:": "Mercados Combinados", "Double Chance and Both Teams to Score": "Mercados Combinados", "Result or Total": "Mercados Combinados", "Result or Both Teams To Score:": "Mercados Combinados", "Total or Both Teams to Score:": "Mercados Combinados", "Team 1 Win 1st Half & Not Win Match": "Mercados Combinados", "Team 2 Win 1st Half & Not Win Match": "Mercados Combinados", "Team 1 to Score First & Win": "Mercados Combinados", "Team 1 to Score First & Not Win": "Mercados Combinados", "Team 2 to Score First & Win": "Mercados Combinados", "Team 2 to Score First & Not Win": "Mercados Combinados", "Team 1 to Win to Nil": "Mercados Combinados", "Team 2 to Win to Nil": "Mercados Combinados", "1st half Over (0.5) and 2nd half Over (1.5)": "Mercados Combinados", "1st half Over (1.5) and 2nd half Over (0.5)": "Mercados Combinados", "Total Over (3.5) and 1st half Over (1.5)": "Mercados Combinados", "Win1 and 1st half Over (1.5)": "Mercados Combinados", "Win2 and 1st half Over (1.5)": "Mercados Combinados", "Win1 and 1st half H1 (-1.5)": "Mercados Combinados", "Win2 and 1st half H2 (-1.5)": "Mercados Combinados", "H1 (-2.5) and 1st half Win1": "Mercados Combinados", "H2 (-2.5) and 1st half Win2": "Mercados Combinados", "H1 (-1.5) and 1st half Win1": "Mercados Combinados", "H2 (-1.5) and 1st half Win2": "Mercados Combinados", "Win1 and Team1 Over (1.5)": "Mercados Combinados", "Win2 and Team2 Over (1.5)": "Mercados Combinados", "Team 1 to Score First and": "Mercados Combinados", "Team 2 to Score First and": "Mercados Combinados", "Team 1 to Score First and Total": "Mercados Combinados", "Team 2 to Score First and Total": "Mercados Combinados", "Half time/Full time and Total": "Mercados Combinados", "Win1 and Total Goals 2 - 3": "Mercados Combinados", "Win2 and Total Goals 2 - 3": "Mercados Combinados", "1st Half/2nd Half Both Teams to Score": "Mercados Combinados", "1st Half Result or Both Teams To Score:": "Mercados Combinados", "2nd Half Result or Both Teams To Score:": "Mercados Combinados", "Half time/Full time and Both Teams to Score": "Mercados Combinados", "Penalty & Sending Off": "Mercados Combinados", "Penalty or Sending Off": "Mercados Combinados",
          // 8. Tempo (Timing)
          "Highest Scoring Half": "Tempo (Timing)", "1st Goal Minute": "Tempo (Timing)", "2nd Goal Minute": "Tempo (Timing)", "Goal from 1 to 10 min.": "Tempo (Timing)", "Goal from 1 to 15 min.": "Tempo (Timing)", "Goal from 1 to 20 min.": "Tempo (Timing)", "Goal from 1 to 25 min.": "Tempo (Timing)", "Goal from 1 to 30 min.": "Tempo (Timing)", "Goal from 1 to 35 min.": "Tempo (Timing)", "Goal from 1 to 40 min.": "Tempo (Timing)", "Goal from 46 to 60 min.": "Tempo (Timing)", "Goal from 46 to 65 min.": "Tempo (Timing)", "Goal from 46 to 70 min.": "Tempo (Timing)", "Goal from 46 to 75 min.": "Tempo (Timing)", "Goal from 46 to 80 min.": "Tempo (Timing)", "Goal from 46 to 85 min.": "Tempo (Timing)", "Goal from 76 to 90+ min.": "Tempo (Timing)", "Result from 1 to 10 min.": "Tempo (Timing)", "Result from 1 to 30 min.": "Tempo (Timing)", "Result from 1 to 50 min.": "Tempo (Timing)", "Result from 1 to 60 min.": "Tempo (Timing)", "Result from 1 to 70 min": "Tempo (Timing)", "Result from 1 to 75 min": "Tempo (Timing)", "1-15 min.": "Tempo (Timing)", "16-30 min.": "Tempo (Timing)", "31-45+ min.": "Tempo (Timing)", "46-60 min.": "Tempo (Timing)", "61-75 min.": "Tempo (Timing)", "76-90+ min.": "Tempo (Timing)", "Total Goal Minutes": "Tempo (Timing)",
          // 9. Por Parte (1ª Parte / 2ª Parte)
          "1st Half: Goal": "Por Parte (1ª Parte / 2ª Parte)", "2nd Half: Goal": "Por Parte (1ª Parte / 2ª Parte)", "1st Half: Sending Off": "Por Parte (1ª Parte / 2ª Parte)", "2nd Half: Sending Off": "Por Parte (1ª Parte / 2ª Parte)", "1st Half: Penalty": "Por Parte (1ª Parte / 2ª Parte)", "2nd Half: Penalty": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Both Teams to Score": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Both Teams to Score": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Team 1": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Team 2": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Asian Total": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Even/Odd": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Team 1": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Team 2": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Asian Total": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Even/Odd": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Handicap": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Asian Handicap": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Handicap": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Asian Handicap": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Correct Score": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Correct Score": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Result": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Double Chance": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 1 to Score": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 2 to Score": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Result and Total": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Result and Both Teams to Score:": "Por Parte (1ª Parte / 2ª Parte)", "1st half: 1st Goal": "Por Parte (1ª Parte / 2ª Parte)", "1st half: 2nd Goal": "Por Parte (1ª Parte / 2ª Parte)", "1st half: 3rd Goal": "Por Parte (1ª Parte / 2ª Parte)", "1st half: European Handicap (0:1)": "Por Parte (1ª Parte / 2ª Parte)", "1st half: European Handicap (1:0)": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 0 - 1": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 1 - 2": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 1 - 3": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 2 - 3": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 2 - 4": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 2 - 5": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 2 - 6": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 3 - 4": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals 3 - 5": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 1: Total Goals 0 - 1": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 1: Total Goals 1 - 2": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 1: Total Goals 1 - 3": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 1: Total Goals 1 - 4": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 1: Total Goals 2 - 3": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 1: Total Goals 2 - 4": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 2: Total Goals 0 - 1": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 2: Total Goals 1 - 2": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 2: Total Goals 1 - 3": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 2: Total Goals 1 - 4": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 2: Total Goals 2 - 3": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 2: Total Goals 2 - 4": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals Team 1": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals Team 2": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Total Goals": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 1 to Win to Nil": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Team 2 to Win to Nil": "Por Parte (1ª Parte / 2ª Parte)", "1st half: Last Goal": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Result": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Double Chance": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 1 to Score": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 2 to Score": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: 1st Goal": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: 2nd Goal": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: 3rd Goal": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: European Handicap (0:1)": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: European Handicap (1:0)": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 0 - 1": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 1 - 2": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 1 - 3": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 2 - 3": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 2 - 4": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 2 - 5": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 2 - 6": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 3 - 4": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals 3 - 5": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 1: Total Goals 0 - 1": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 1: Total Goals 1 - 2": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 1: Total Goals 1 - 3": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 1: Total Goals 1 - 4": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 1: Total Goals 2 - 3": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 1: Total Goals 2 - 4": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 2: Total Goals 0 - 1": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 2: Total Goals 1 - 2": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 2: Total Goals 1 - 3": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 2: Total Goals 1 - 4": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 2: Total Goals 2 - 3": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 2: Total Goals 2 - 4": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals Team 1": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals Team 2": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Total Goals": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 1 to Win to Nil": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Team 2 to Win to Nil": "Por Parte (1ª Parte / 2ª Parte)", "2nd half: Last Goal": "Por Parte (1ª Parte / 2ª Parte)", "1st half or match": "Por Parte (1ª Parte / 2ª Parte)",
          // 10. Mercados Especiais / Eventos
          "Tie Breaker": "Mercados Especiais / Eventos", "Penalty": "Mercados Especiais / Eventos", "Sending Off": "Mercados Especiais / Eventos", "Sending Off Team 1": "Mercados Especiais / Eventos", "Sending Off Team 2": "Mercados Especiais / Eventos", "1st to Happen:": "Mercados Especiais / Eventos", "How is Scored 1st Goal": "Mercados Especiais / Eventos", "Team 1 Winning Margin 1 Goal": "Mercados Especiais / Eventos", "Team 1 Winning Margin 2 Goals": "Mercados Especiais / Eventos", "Team 1 Winning Margin 1 or 2 Goals": "Mercados Especiais / Eventos", "Team 1 Winning Margin 2 or 3 Goals": "Mercados Especiais / Eventos", "Team 1 Winning Margin 2 or more Goals": "Mercados Especiais / Eventos", "Team 1 Winning Margin 1 Goal or Draw": "Mercados Especiais / Eventos", "Team 1 Winning Margin 2 Goals or Draw": "Mercados Especiais / Eventos", "Team 2 Winning Margin 1 Goal": "Mercados Especiais / Eventos", "Team 2 Winning Margin 2 Goals": "Mercados Especiais / Eventos", "Team 2 Winning Margin 1 or 2 Goals": "Mercados Especiais / Eventos", "Team 2 Winning Margin 2 or 3 Goals": "Mercados Especiais / Eventos", "Team 2 Winning Margin 2 or more Goals": "Mercados Especiais / Eventos", "Team 2 Winning Margin 1 Goal or Draw": "Mercados Especiais / Eventos", "Team 2 Winning Margin 2 Goals or Draw": "Mercados Especiais / Eventos", "Draw in at least one of the Halves": "Mercados Especiais / Eventos", "Any Team Winning Margin 1": "Mercados Especiais / Eventos", "Any Team Winning Margin 2": "Mercados Especiais / Eventos", "Any Team Winning Margin 3": "Mercados Especiais / Eventos", "Any Team Winning Margin 2 & more": "Mercados Especiais / Eventos", "Any Team Winning Margin 3 & more": "Mercados Especiais / Eventos", "Team 1 win from Behind": "Mercados Especiais / Eventos", "Team 2 Win from Behind": "Mercados Especiais / Eventos", "Own Goal": "Mercados Especiais / Eventos", "Double": "Mercados Especiais / Eventos", "1:1 During The Match": "Mercados Especiais / Eventos", "2:0 or 0:2 During The Match": "Mercados Especiais / Eventos", "2:0 During The Match": "Mercados Especiais / Eventos", "0:2 During The Match": "Mercados Especiais / Eventos", "To Miss A Penalty": "Mercados Especiais / Eventos", "To Score A Penalty": "Mercados Especiais / Eventos", "Red card in both teams": "Mercados Especiais / Eventos",
          // 11. Cantos
          "Corners: Total": "Cantos", "Corners: Total Team 1": "Cantos", "Corners: Total Team 2": "Cantos", "Corners: Total Even/Odd": "Cantos", "Corners: 1st Half: Total:": "Cantos", "Corners: 1st Half: Total Team 1": "Cantos", "Corners: 1st Half: Total Team 2": "Cantos", "Corners: 2nd Half: Total": "Cantos", "Corners: 2nd Half: Total Team 1": "Cantos", "Corners: 2nd Half: Total Team 2": "Cantos", "Corners: Total (3 way)": "Cantos", "Corners: Handicap": "Cantos", "Corners: 1st Half: Handicap": "Cantos", "Corners: 2nd Half: Handicap": "Cantos", "Corners: Result": "Cantos", "Corners: 1st Half: Result": "Cantos", "Corners: 2nd Half: Result": "Cantos", "Corners: Highest Scoring Half": "Cantos", "Corners: 1st Corner": "Cantos", "Corners: Last Corner:": "Cantos", "Corners: 10 Minutes Corners (00:00-9:59)": "Cantos", "Corners: Race to Corners": "Cantos",
          // 12. Cartões Amarelos
          "Yellow Cards: Total": "Cartões Amarelos", "Yellow Cards: Total Team 1": "Cartões Amarelos", "Yellow Cards: Total Team 2": "Cartões Amarelos", "Yellow Cards: Total Odd/Even": "Cartões Amarelos", "Yellow Cards: 1st Half: Total:": "Cartões Amarelos", "Yellow Cards: 1st Half: Total Team 1": "Cartões Amarelos", "Yellow Cards: 1st Half: Total Team 2": "Cartões Amarelos", "Yellow Cards: 2nd Half: Total": "Cartões Amarelos", "Yellow Cards: Handicap": "Cartões Amarelos", "Yellow Cards: 1st Half: Handicap": "Cartões Amarelos", "Yellow Cards: 2nd Half: Handicap": "Cartões Amarelos", "Yellow Cards: Result": "Cartões Amarelos", "Yellow Cards: Double Chance": "Cartões Amarelos", "Yellow Cards: 1st Half: Result": "Cartões Amarelos", "Yellow Cards: 1st Half: Double Chance": "Cartões Amarelos", "Yellow Cards: 2nd Half: Result": "Cartões Amarelos", "Yellow Cards: 2nd Half: Double Chance": "Cartões Amarelos", "Yellow Cards: Highest Scoring Half": "Cartões Amarelos", "Yellow Cards: 1st Yellow Card Minute": "Cartões Amarelos", "Yellow Cards: Both Teams to Receive Cards": "Cartões Amarelos", "Yellow Cards: Both Teams to Receive 2 or More Cards": "Cartões Amarelos",
          // 13. Remates à Baliza
          "Shots on target: Total": "Remates à Baliza", "Shots on target: Total Team 1": "Remates à Baliza", "Shots on target: Total Team 2": "Remates à Baliza", "Shots on target: Total Even/Odd": "Remates à Baliza", "Shots on target: 1st Half: Total:": "Remates à Baliza", "Shots on target: 1st Half: Total Team 1": "Remates à Baliza", "Shots on target: 1st Half: Total Team 2": "Remates à Baliza", "Shots on target: Handicap": "Remates à Baliza", "Shots on target: 1st Half: Handicap": "Remates à Baliza", "Shots on target: Result": "Remates à Baliza", "Shots on target: Double Chance": "Remates à Baliza", "Shots on target: 1st Half: Result": "Remates à Baliza", "Shots on target: 1st Half: Double Chance": "Remates à Baliza", "Shots on target: Highest Scoring Half": "Remates à Baliza",
          // 14. Faltas
          "Fouls: Total": "Faltas", "Fouls: Total Team 1": "Faltas", "Fouls: Total Team 2": "Faltas", "Fouls: Total Even/Odd": "Faltas", "Fouls: Handicap": "Faltas", "Fouls: Result": "Faltas", "Fouls: Double Chance": "Faltas", "Fouls: Highest Scoring Half": "Faltas",
          "Offsides: Total": "Faltas", "Offsides: Total Team 1": "Faltas", "Offsides: Total Team 2": "Faltas", "Offsides: Total Even/Odd": "Faltas", "Offsides: Handicap": "Faltas", "Offsides: Result": "Faltas", "Offsides: Double Chance": "Faltas",
          // 15. Remates Totais
          "Shots: Total": "Remates Totais", "Shots: Total Team 1": "Remates Totais", "Shots: Total Team 2": "Remates Totais", "Shots: Total Even/Odd": "Remates Totais", "Shots: 1st Half: Total Team 1": "Remates Totais", "Shots: 1st Half: Total Team 2": "Remates Totais", "Shots: Handicap": "Remates Totais", "Shots: 1st Half: Handicap": "Remates Totais", "Shots: Result": "Remates Totais", "Shots: Double Chance": "Remates Totais", "Shots: 1st Half: Result": "Remates Totais", "Shots: 1st Half: Double Chance": "Remates Totais", "Shots: Highest Scoring Half": "Remates Totais",
          // 16. Jogadores (Totais) - This mapping isn't used directly for lookup but helps define the category
          "Players:": "16. Jogadores (Totais)" // Placeholder mapping
       };
        let processedSubcategories = new Set();

        function isOddNumber(str) {
            if (!str) return false;
            // Updated Regex: Allows leading/trailing whitespace, checks for digits with optional single decimal point
            return /^\s*\d+(\.\d+)?\s*$/.test(str);
        }


        window.convertToTable = function() {
            var inputText = document.getElementById("inputTextArea").value;
            var lines = inputText.split('\n');
            var outputDiv = document.getElementById("outputTables"); // Ensure this targets the div inside the popup
            outputDiv.innerHTML = '';
            processedSubcategories.clear();

            var currentSubcategoryName = null;
            var currentTable = null;
            var ignoreCurrentSubcategory = false;
            var pendingOptionText = null;

            const playersPrefix = "Players:";

            for (const line of lines) {
                let trimmedLine = line.trim();

                // Rule 1: Ignore specific isolated characters
                if (trimmedLine === "Ù" || trimmedLine === "Ã" || trimmedLine === "Á") {
                    continue;
                }
                // Ignore completely empty lines
                if (trimmedLine === "") continue;

                let isHeader = false;
                let potentialSubcategoryName = null;
                let mainCategoryForThis = null;

                // Rule 6: Check for dynamic "Players:" subcategory FIRST
                if (trimmedLine.startsWith(playersPrefix)) {
                    isHeader = true;
                    potentialSubcategoryName = trimmedLine; // Use the full line as the unique name
                    mainCategoryForThis = "16. Jogadores (Totais)"; // Assign main category for players
                }
                // If not a dynamic player category, check against FIXED list
                else if (categories.includes(trimmedLine)) {
                    isHeader = true;
                    potentialSubcategoryName = trimmedLine;
                    mainCategoryForThis = categoryMap[potentialSubcategoryName] || "Outras Categorias"; // Lookup main category
                }

                // --- Processing Logic ---
                if (isHeader) {
                    // Discard any pending option text from previous section (Rule 5)
                    pendingOptionText = null;

                    // Handle Rule 2 (Duplicates) using the potentialSubcategoryName
                    if (potentialSubcategoryName !== "Total" && processedSubcategories.has(potentialSubcategoryName)) {
                        // It's a duplicate (and not 'Total'), ignore this and subsequent lines
                        currentSubcategoryName = null;
                        currentTable = null;
                        ignoreCurrentSubcategory = true;
                        console.log("Ignoring duplicate:", potentialSubcategoryName); // Debugging
                        continue;
                    } else {
                        // It's a new unique subcategory or "Total"
                        ignoreCurrentSubcategory = false;
                        currentSubcategoryName = potentialSubcategoryName;

                        // For "Players:", use the part *after* the prefix for the table header display text
                        let displayHeader = currentSubcategoryName;
                        if (currentSubcategoryName.startsWith(playersPrefix)) {
                            displayHeader = currentSubcategoryName.substring(playersPrefix.length).trim();
                        }

                        currentTable = createCategoryTable(displayHeader); // Use possibly shortened name for display
                        outputDiv.appendChild(currentTable);
                        currentTable.setAttribute('data-original-category', currentSubcategoryName); // Store the FULL unique name
                        currentTable.setAttribute('data-category', mainCategoryForThis); // Assign determined main category
                        console.log("Created table for:", displayHeader, "Main category:", mainCategoryForThis); // Debugging


                        // Add the FULL unique name to processed list (except "Total")
                        if (currentSubcategoryName !== "Total") {
                              processedSubcategories.add(currentSubcategoryName);
                        }
                    }
                } else { // Line is not a header
                    if (ignoreCurrentSubcategory || !currentTable) {
                         console.log("Skipping line (ignored or no table):", trimmedLine); // Debugging
                        continue; // Skip if ignoring or no table context
                    }

                    // Apply Rule 4 & 5: Pairing Logic
                    if (pendingOptionText === null) {
                        // Start of a potential pair
                        pendingOptionText = trimmedLine;
                         console.log("Pending text set:", pendingOptionText); // Debugging
                    } else {
                        // Second line of potential pair
                        if (isOddNumber(trimmedLine)) {
                            // Valid odd found, add the row
                            console.log("Found odd:", trimmedLine, "for pending:", pendingOptionText); // Debugging
                            addTableRow(currentTable, pendingOptionText, trimmedLine);
                            pendingOptionText = null; // Pair complete
                        } else {
                            // Not an odd, discard the pending text (Rule 5)
                            console.log("Discarding pending:", pendingOptionText, "- current line is not odd:", trimmedLine); // Debugging
                            // and start a new potential pair with the current line
                            pendingOptionText = trimmedLine;
                             console.log("New pending text set:", pendingOptionText); // Debugging
                        }
                    }
                }
            } // End For loop

             // Debugging: Log final state
             if (pendingOptionText !== null) {
                  console.log("Loop finished with pending text:", pendingOptionText);
             } else {
                 console.log("Loop finished, no pending text.");
             }


            filterTables(); // Apply initial filter
        }

        function createCategoryTable(headerText) {
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headerCell = document.createElement('th');
            headerCell.colSpan = 3;
            headerCell.textContent = headerText;
            headerRow.appendChild(headerCell);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);
            return table;
        }

        function addTableRow(table, optionText, oddValue) {
            const tbody = table.querySelector('tbody');
            if (!tbody) return; // Should not happen, but safety check

            const row = document.createElement('tr');
            const textCell = document.createElement('td');
            textCell.textContent = optionText.trim();

            const numberCell = document.createElement('td');
            numberCell.textContent = oddValue.trim(); // Display the raw odd value

            const calculationCell = document.createElement('td');
            const odd = parseFloat(oddValue.trim()); // Parse for calculation

            if (!isNaN(odd)) { // Check if parsing was successful
                const oddMin = 1.01;
                const oddMax = 15;
                let score;

                if (odd < 0.5) score = 0;
                else if (odd >= 0.5 && odd < oddMin) score = 1; // Handle range below oddMin
                else if (odd > oddMax) score = 10; // Handle range above oddMax
                else { // Calculate score within the main range (oddMin to oddMax)
                    const logOdd = Math.log(odd);
                    const logOddMin = Math.log(oddMin);
                    const logOddMax = Math.log(oddMax);
                    // Ensure logOddMax > logOddMin to avoid division by zero or negative numbers
                    if (logOddMax > logOddMin) {
                        score = 1 + 9 * (logOdd - logOddMin) / (logOddMax - logOddMin);
                    } else {
                         // Fallback if oddMin >= oddMax (shouldn't happen with current values)
                         // Assign score based on whether odd reaches the minimum threshold
                        score = (odd >= oddMin) ? 10 : 1;
                    }
                    score = Math.ceil(score); // Round up
                    score = Math.max(1, Math.min(score, 10)); // Clamp between 1 and 10
                }

                const boldText = document.createElement('b');
                boldText.textContent = score; // Display calculated score
                calculationCell.appendChild(boldText);
            } else {
                calculationCell.textContent = "-"; // Not a valid number for calculation
            }

            row.appendChild(textCell);
            row.appendChild(numberCell);
            row.appendChild(calculationCell);
            tbody.appendChild(row);
        }


        window.filterTables = function() {
            var selectedCategory = document.getElementById("categoryFilter").value;
            // Ensure we are selecting tables *only* within the popup's output area
            var tables = document.querySelectorAll("#settings-popup #outputTables table");

            tables.forEach(function(table) {
                if (selectedCategory === 'all' || table.getAttribute('data-category') === selectedCategory) {
                    table.style.display = ''; // Show table (default display is usually 'table')
                } else {
                    table.style.display = 'none'; // Hide table
                }
            });
        }

    })(); // End of converter's self-executing anonymous function
    </script>
    <!-- == CONVERTER JAVASCRIPT END == -->


    <!-- --- JAVASCRIPT FOR POPUP INTERACTION --- -->
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const settingsIcon = document.getElementById('settings-icon-container');
            const settingsPopup = document.getElementById('settings-popup');
            const closeButtonTopRight = document.getElementById('popup-close');
            const closeButtonScrollable = document.getElementById('popup-close-scrollable');

            if (settingsIcon && settingsPopup && closeButtonTopRight && closeButtonScrollable) {
                settingsIcon.addEventListener('click', () => {
                    settingsPopup.style.display = 'block';
                });

                const closePopup = () => {
                    settingsPopup.style.display = 'none';
                };

                closeButtonTopRight.addEventListener('click', closePopup);
                closeButtonScrollable.addEventListener('click', closePopup);

                // --- DRAGGABLE POPUP FUNCTIONALITY ---
                let isDragging = false;
                let offsetX, offsetY;

                settingsPopup.addEventListener('mousedown', (e) => {
                    // Only start dragging if the mousedown is on the popup itself,
                    // not on inner elements like textarea, select, button, etc.
                    if (e.target === settingsPopup) {
                        isDragging = true;
                        offsetX = e.clientX - settingsPopup.offsetLeft;
                        offsetY = e.clientY - settingsPopup.offsetTop;
                        settingsPopup.style.cursor = 'grabbing';
                        // Optional: Prevent text selection during drag
                        document.body.style.userSelect = 'none';
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    // Boundary checks (optional but recommended)
                    let newX = e.clientX - offsetX;
                    let newY = e.clientY - offsetY;

                    // Keep popup within viewport horizontal bounds
                    newX = Math.max(0, Math.min(newX, window.innerWidth - settingsPopup.offsetWidth));
                     // Keep popup within viewport vertical bounds
                    newY = Math.max(0, Math.min(newY, window.innerHeight - settingsPopup.offsetHeight));


                    settingsPopup.style.left = newX + 'px';
                    settingsPopup.style.top = newY + 'px';
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        settingsPopup.style.cursor = 'grab';
                        // Re-enable text selection
                        document.body.style.userSelect = '';
                    }
                });
                // --- END OF DRAGGABLE POPUP FUNCTIONALITY ---


            } else {
                console.error("Could not find elements for settings popup interaction.");
            }
        });
    </script>
    <!-- --- END OF POPUP INTERACTION JAVASCRIPT --- -->

</body>
</html>
