<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G Empire Eye - Visão Geral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script type="module" src="js/auth-guard.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; display: none; flex-direction: column; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .menu-item i { font-size: 16px; }
        .content { padding: 80px 20px 20px; max-width: 1200px; width: 100%; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 24px; font-size: 28px; text-align: center; }
        #status-message { text-align: center; font-size: 18px; color: #666; padding: 40px; }
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        tbody tr:nth-child(even) { background-color: #fafafa; }
        tbody tr:hover td { background-color: #f1f1f1 !important; }
        thead th.sortable { cursor: pointer; position: relative; user-select: none; }
        thead th.sortable:hover { background-color: #e9e9e9; }
        thead th.sortable::after { content: ''; position: absolute; right: 15px; top: 50%; margin-top: -8px; border: 5px solid transparent; opacity: 0.3; }
        thead th.sort-asc::after { opacity: 1; border-bottom-color: #333; }
        thead th.sort-desc::after { opacity: 1; border-top-color: #333; }
        .highlight-update { background-color: #d4edda !important; transition: background-color 1.5s ease; }

        /* Coloração das Colunas */
        #users-table th:nth-child(3), #users-table td:nth-child(3) { background-color: #e7f3ff; }
        #users-table th:nth-child(4), #users-table td:nth-child(4) { background-color: #fff8e1; }
        #users-table th:nth-child(5), #users-table td:nth-child(5) { background-color: #e8f5e9; }
        #users-table th:nth-child(6), #users-table td:nth-child(6) { background-color: #ffebee; color: #c62828; font-weight: 500;}

        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .popup-content {
            background-color: #fff; padding: 25px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%; max-width: 900px; max-height: 80vh;
            display: flex; flex-direction: column; position: relative;
        }
        .close-button {
            position: absolute; top: 10px; right: 15px;
            font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer;
        }
        .close-button:hover { color: #333; }
        .popup-table-container { overflow-y: auto; }
        #users-table-body tr { cursor: pointer; }

        .popup-header-buttons { position: absolute; top: 25px; right: 50px; display: flex; gap: 10px; }
        .popup-header-buttons button {
            padding: 8px 12px; border: none;
            color: white; border-radius: 5px; cursor: pointer; font-weight: bold;
            transition: background-color 0.3s ease;
        }
        #recalculate-button { background-color: #007bff; }
        #recalculate-button:hover { background-color: #0056b3; }
        #recalculate-button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #timeline-button { background-color: #6c757d; }
        #timeline-button:hover { background-color: #5a6268; }

        #bulletin-button {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background-color: #007bff; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1500; transition: transform 0.3s ease, opacity 0.3s ease;
            transform: scale(0); opacity: 0;
        }
        #bulletin-button.bulletin-visible { transform: scale(1); opacity: 1; }
        #bulletin-badge {
            position: absolute; top: -2px; right: -2px; width: 24px; height: 24px;
            background-color: #dc3545; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; border: 2px solid white;
        }
        #changelog-container .log-entry { padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 15px; }
        #changelog-container .log-entry:last-child { border-bottom: none; }
        #changelog-container .log-entry .user { font-weight: bold; color: #0056b3; }
        #changelog-container .log-entry .change-arrow { color: #ffc107; margin: 0 8px; }

        #filter-container { position: absolute; top: 90px; right: 25px; z-index: 1050; }
        #filter-icon { font-size: 20px; padding: 10px; background-color: #fff; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; color: #333; transition: all 0.3s ease; }
        #filter-icon:hover { color: #2176ff; transform: scale(1.1); }
        #filter-popup { position: absolute; top: 45px; right: 0; background-color: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; width: 200px; transition: opacity 0.3s ease, transform 0.3s ease; transform-origin: top right; }
        #filter-popup.filter-hidden { display: none; opacity: 0; transform: scale(0.95); }
        #filter-popup strong { display: block; margin-bottom: 10px; font-size: 16px; color: #333; }
        #filter-popup div { margin-bottom: 5px; }
        #filter-popup label { margin-left: 8px; cursor: pointer; color: #555; }

        /* === ESTILOS DO NOVO POPUP TIMELINE === */
        #timeline-container .day-group { margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; }
        #timeline-container .day-header { background-color: #f8f9fa; padding: 10px 15px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #timeline-container .day-header:hover { background-color: #e9ecef; }
        #timeline-container .delete-day-btn { color: #dc3545; cursor: pointer; transition: transform 0.2s ease; }
        #timeline-container .delete-day-btn:hover { transform: scale(1.2); }
        #timeline-container .day-actions { padding: 10px 15px; border-top: 1px solid #ddd; display: none; }
        #timeline-container .action-entry { padding: 5px 0; border-bottom: 1px solid #eee; }
        #timeline-container .action-entry:last-child { border-bottom: none; }
        #permissions-button { background-color: #28a745; }
#permissions-button:hover { background-color: #218838; }

.permission-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 5px;
    border-bottom: 1px solid #eee;
}
.permission-toggle:last-child { border-bottom: none; }
.permission-toggle label { font-size: 16px; font-weight: 500; color: #333; text-transform: capitalize; }

/* Estilos para o Toggle Switch */
.switch { position: relative; display: inline-block; width: 60px; height: 34px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc; transition: .4s; border-radius: 34px;
}
.slider:before {
    position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: #28a745; }
input:checked + .slider:before { transform: translateX(26px); }

/* Reutiliza o estilo do botão de recalcular para o de guardar */
.recalculate-button {
    padding: 10px 20px; border: none; color: white; border-radius: 5px; cursor: pointer;
    font-weight: bold; font-size: 15px; transition: background-color 0.3s ease;
    background-color: #007bff;
}
.recalculate-button:hover { background-color: #0056b3; }
.recalculate-button:disabled { background-color: #cccccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="1x.html" class="menu-item"><i class="fas fa-home"></i>Home</a>
        <a href="fusiveis.html" class="menu-item"><i class="fas fa-bolt"></i>Fusíveis</a>
        <a href="arbitro.html" class="menu-item"><i class="fas fa-gavel"></i>Árbitro</a>
        <a href="criar-manual.html" class="menu-item"><i class="fas fa-book"></i>Manual</a>
        <a href="criar-banca.html" class="menu-item"><i class="fas fa-university"></i>Banca</a>
    </nav>
    <main class="content">
        <h1><i class="fas fa-eye"></i> G Empire Eye - Utilizadores</h1>
        <div id="filter-container">
            <i id="filter-icon" class="fas fa-filter" title="Filtrar tabela"></i>
            <div id="filter-popup" class="filter-hidden">
                <strong>Estado na Tabela:</strong>
                <div><input type="radio" id="filter-active" name="table_filter" value="active" checked><label for="filter-active">Apenas Ativos</label></div>
                <div><input type="radio" id="filter-all" name="table_filter" value="all"><label for="filter-all">Ver Todos</label></div>
            </div>
        </div>
        <p id="status-message">A carregar dados dos utilizadores...</p>
        <div class="table-container" style="display: none;">
            <table id="users-table">
                <thead>
                    <tr>
                        <th class="sortable" data-column="displayName">Utilizador</th>
                        <th class="sortable" data-column="tatica">Tática</th>
                        <th class="sortable" data-column="pontos">Pontos</th>
                        <th class="sortable" data-column="gcoins">GCoins</th>
                        <th class="sortable" data-column="whowins">WhoWins</th>
                        <th class="sortable" data-column="divida">Dívida</th>
                        <th class="sortable" data-column="jogadores">Jogadores</th>
                        <th class="sortable" data-column="ultimoacesso">Último Acesso</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>
    </main>

    <!-- POPUP DE MOVIMENTAÇÕES -->
    <div id="movements-popup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-button">&times;</span>
            <div class="popup-header-buttons">
                <button id="permissions-button" title="Gerir permissões de acesso do utilizador.">Permissões</button>
                <button id="timeline-button" title="Ver o registo de atividade do utilizador.">Timeline</button>
                <button id="recalculate-button" title="Recalcula o saldo GCoins do utilizador com base em todos os seus movimentos da temporada.">Recalcular</button>
            </div>
            <h2 id="popup-title" style="margin-bottom: 20px; padding-right: 250px;">Movimentações</h2>
            <div class="popup-table-container">
                <table id="movements-detail-table">
                    <thead>
                        <tr>
                            <th>Data</th><th>Estado</th><th>Tipo</th><th>Preço</th>
                            <th>Valor Real</th><th>Descrição</th><th>Valor a Pagar</th>
                        </tr>
                    </thead>
                    <tbody id="movements-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- POPUP DA TIMELINE -->
    <div id="timeline-popup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-button">&times;</span>
            <h2 id="timeline-popup-title" style="margin-bottom: 20px;">Timeline de Atividade</h2>
            <div id="timeline-container" class="popup-table-container">
                <!-- Conteúdo da timeline será gerado dinamicamente aqui -->
            </div>
        </div>
    </div>

    <!-- NOVO POPUP DE PERMISSÕES -->
    <div id="permissions-popup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-button">&times;</span>
            <h2 id="permissions-popup-title" style="margin-bottom: 20px;">Permissões</h2>
            <div id="permissions-form-container">
                <!-- Os toggles de permissão serão gerados aqui pelo JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button id="save-permissions-btn" class="recalculate-button">Guardar Alterações</button>
                <p id="permissions-status" style="margin-top: 10px; height: 1em; font-weight: bold;"></p>
            </div>
        </div>
    </div>

    <!-- Botão do Boletim e Popup de Changelog -->
    <div id="bulletin-button" class="bulletin-hidden"><i class="fas fa-bell"></i><span id="bulletin-badge"></span></div>
    <div id="changelog-popup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-button">&times;</span>
            <h2 style="margin-bottom: 20px;">Registo de Alterações em Tempo Real</h2>
            <div id="changelog-container" class="popup-table-container"></div>
        </div>
    </div>

   <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy, updateDoc, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
        authDomain: "g-games-8a8fc.firebaseapp.com",
        projectId: "g-games-8a8fc",
        storageBucket: "g-games-8a8fc.appspot.com",
        messagingSenderId: "689897349449",
        appId: "1:689897349449:web:536599794579901beb7a98",
        measurementId: "G-GTTPJ6G5MD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allUsersData = [], playerCounts = {}, debtTotals = {};
    let currentSort = { column: 'pontos', direction: 'desc' };
    let currentFilter = 'active', currentSeason = null;
    let changesMap = new Map(), isInitialLoadComplete = false;
    let changeLog = [], newChangesCount = 0;
    const fieldNames = { pontos: 'Pontos', gcoins: 'GCoins', whowins: 'WhoWins', divida: 'Dívida', jogadores: 'Jogadores' };

    // ... (as funções existentes como fetchCurrentSeason, etc., permanecem as mesmas) ...
    async function fetchCurrentSeason() { if (currentSeason) return currentSeason; const configRef = doc(db, "paineis", "configuracoes_gerais"); const docSnap = await getDoc(configRef); if (docSnap.exists() && docSnap.data().temporadaAtual) { const temporada = docSnap.data().temporadaAtual; currentSeason = temporada.replace(/\//g, ''); return currentSeason; } throw new Error("Não foi possível encontrar a temporada atual."); }
    async function handleRecalculateBalance(userId) { const button = document.getElementById('recalculate-button'); const originalText = button.textContent; button.disabled = true; button.textContent = 'A calcular...'; try { const season = await fetchCurrentSeason(); const movimentosRef = collection(db, "movimentos"); const q = query(movimentosRef, where("userId", "==", userId), where("temporada", "==", season)); const querySnapshot = await getDocs(q); let newBalance = 0; querySnapshot.forEach((doc) => { const data = doc.data(); if (data.estado !== 'WhoWins Paid') { const valor = parseFloat(data.valorreal); if (!isNaN(valor)) newBalance += valor; } }); const userRef = doc(db, 'users', userId); const gCoinsField = `${season}GCoins`; await updateDoc(userRef, { [gCoinsField]: newBalance }); button.textContent = 'Sucesso!'; button.style.backgroundColor = '#28a745'; } catch (error) { console.error("Erro ao recalcular saldo:", error); button.textContent = 'Erro!'; button.style.backgroundColor = '#dc3545'; } finally { setTimeout(() => { button.textContent = originalText; button.disabled = false; button.style.backgroundColor = ''; }, 2000); } }
    function formatFirebaseTimestamp(timestampObject) { if (!timestampObject || typeof timestampObject.toDate !== 'function') return 'Nunca'; try { const dateObj = timestampObject.toDate(); const day = String(dateObj.getDate()).padStart(2, '0'); const month = String(dateObj.getMonth() + 1).padStart(2, '0'); const year = dateObj.getFullYear(); const hours = String(dateObj.getHours()).padStart(2, '0'); const minutes = String(dateObj.getMinutes()).padStart(2, '0'); return `${day}/${month}/${year}, ${hours}h${minutes}`; } catch (error) { return 'Data Inválida'; } }
    function formatMovementDate(timestampObject) { if (!timestampObject || typeof timestampObject.toDate !== 'function') return 'N/A'; const dateObj = timestampObject.toDate(); const day = dateObj.getDate(); const month = dateObj.toLocaleString('pt-PT', { month: 'long' }); const year = dateObj.getFullYear(); return `${day} ${month} ${year}`; }
    function renderTable(users) { const tableBody = document.getElementById('users-table-body'); tableBody.innerHTML = ''; users.forEach(user => { const row = document.createElement('tr'); row.setAttribute('data-userid', user.id); row.setAttribute('data-username', user.displayName); const userChanges = changesMap.get(user.id) || {}; row.innerHTML = `<td>${user.displayName}</td><td>${user.tatica}</td><td class="${userChanges.pontos ? 'highlight-update' : ''}">${user.pontos}</td><td class="${userChanges.gcoins ? 'highlight-update' : ''}">${user.gcoins}</td><td class="${userChanges.whowins ? 'highlight-update' : ''}">${user.whowins}</td><td class="${userChanges.divida ? 'highlight-update' : ''}">${user.divida}</td><td class="${userChanges.jogadores ? 'highlight-update' : ''}">${user.jogadores}</td><td>${user.ultimoacesso}</td>`; tableBody.appendChild(row); }); addEventListenersToRows(); document.querySelectorAll('.highlight-update').forEach(cell => { setTimeout(() => { cell.classList.remove('highlight-update'); }, 2500); }); changesMap.clear(); }
    function processAndRenderUsers(usersSnapshot) { const statusMessage = document.getElementById('status-message'); const tableContainer = document.querySelector('.table-container'); if (usersSnapshot.empty) { statusMessage.textContent = 'Nenhum utilizador encontrado.'; statusMessage.style.display = 'block'; tableContainer.style.display = 'none'; return; } const newUsersData = []; const oldDataMap = new Map(allUsersData.map(u => [u.id, u])); usersSnapshot.forEach(doc => { const userData = doc.data(); const userId = doc.id; const pontosField = `${currentSeason}Pontos`; const gcoinsField = `${currentSeason}GCoins`; const newUser = { id: userId, displayName: userData.nometabela || userData.email || 'N/A', tatica: userData.tática || 'N/A', pontos: userData[pontosField] || 0, gcoins: userData[gcoinsField] || 0, whowins: userData.whowinsgCoins || 0, divida: debtTotals[userId] || 0, jogadores: playerCounts[userId] || 0, ultimoacesso: formatFirebaseTimestamp(userData.ultimoacesso), natabela: userData.natabela || 'No' }; newUsersData.push(newUser); const oldUser = oldDataMap.get(userId); if (oldUser && isInitialLoadComplete) { const userChanges = {}; for (const key of Object.keys(fieldNames)) { if (oldUser[key] !== newUser[key]) { userChanges[key] = true; changeLog.unshift({ user: newUser.displayName, field: fieldNames[key], oldValue: oldUser[key], newValue: newUser[key], timestamp: new Date() }); newChangesCount++; } } if (Object.keys(userChanges).length > 0) { changesMap.set(userId, userChanges); } } }); allUsersData = newUsersData; applyFiltersAndSort(); if (isInitialLoadComplete) { updateBulletinUI(); } statusMessage.style.display = 'none'; tableContainer.style.display = 'block'; }
    function updateBulletinUI() { const bulletinButton = document.getElementById('bulletin-button'); const bulletinBadge = document.getElementById('bulletin-badge'); if (newChangesCount > 0) { bulletinBadge.textContent = newChangesCount > 9 ? '9+' : newChangesCount; bulletinButton.classList.remove('bulletin-hidden'); bulletinButton.classList.add('bulletin-visible'); } else { bulletinButton.classList.remove('bulletin-visible'); bulletinButton.classList.add('bulletin-hidden'); } }
    function renderAndShowChangeLog() { const popup = document.getElementById('changelog-popup'); const container = document.getElementById('changelog-container'); container.innerHTML = ''; if (changeLog.length === 0) { container.innerHTML = '<p style="text-align:center; color:#666;">Nenhuma alteração registada.</p>'; } else { changeLog.forEach(log => { const logEntry = document.createElement('div'); logEntry.className = 'log-entry'; const time = `${String(log.timestamp.getHours()).padStart(2, '0')}:${String(log.timestamp.getMinutes()).padStart(2, '0')}`; logEntry.innerHTML = `<span>[${time}]</span> O campo <strong>${log.field}</strong> do utilizador <span class="user">${log.user}</span> mudou de <span>${log.oldValue}</span> <i class="fas fa-long-arrow-alt-right change-arrow"></i> <span>${log.newValue}</span>.`; container.appendChild(logEntry); }); } popup.style.display = 'flex'; newChangesCount = 0; updateBulletinUI(); }
    function addEventListenersToRows() { document.querySelectorAll('#users-table-body tr').forEach(row => { row.addEventListener('click', () => { const userId = row.dataset.userid; const userName = row.dataset.username; if (userId) { fetchAndShowMovements(userId, userName); } }); }); }
    function applyFiltersAndSort() { let filteredUsers = allUsersData; if (currentFilter === 'active') { filteredUsers = allUsersData.filter(user => user.natabela === 'Yes'); } const { column, direction } = currentSort; filteredUsers.sort((a, b) => { let valA = a[column]; let valB = b[column]; if (typeof valA === 'number' && typeof valB === 'number') { return direction === 'asc' ? valA - valB : valB - valA; } else { return direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA)); } }); document.querySelectorAll('thead th.sortable').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); if (th.dataset.column === column) { th.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc'); } }); renderTable(filteredUsers); }
    function sortTable(columnKey) { const direction = currentSort.column === columnKey && currentSort.direction === 'asc' ? 'desc' : 'asc'; currentSort = { column: columnKey, direction: direction }; applyFiltersAndSort(); }
    
    // --- FUNÇÃO CORRIGIDA E NOVAS FUNÇÕES ---

    /**
     * Converte de forma robusta um campo de data do Firebase (Timestamp ou String) para um objeto Date.
     * @param {object|string} dateInput O campo data do documento do Firestore.
     * @returns {Date|null} Um objeto Date ou null se a conversão falhar.
     */
    function parseDateFromFirestore(dateInput) {
        // Caso 1: É um objeto Timestamp do Firebase (o mais comum e correto)
        if (dateInput && typeof dateInput.toDate === 'function') {
            return dateInput.toDate();
        }

        // Caso 2: É uma string no formato "13 de novembro de 2025 às 19:42:20 UTC"
        if (typeof dateInput === 'string') {
            const months = { 'janeiro': 0, 'fevereiro': 1, 'março': 2, 'abril': 3, 'maio': 4, 'junho': 5, 'julho': 6, 'agosto': 7, 'setembro': 8, 'outubro': 9, 'novembro': 10, 'dezembro': 11 };
            try {
                const parts = dateInput.replace(' de ', ' ').replace(' às ', ' ').replace(' UTC', '').split(' ');
                if (parts.length < 4) return null; // Formato inválido

                const day = parseInt(parts[0], 10);
                const month = months[parts[1].toLowerCase()];
                const year = parseInt(parts[2], 10);
                const timeParts = parts[3].split(':');
                const hours = parseInt(timeParts[0], 10);
                const minutes = parseInt(timeParts[1], 10);
                const seconds = parseInt(timeParts[2], 10);

                if ([day, month, year, hours, minutes, seconds].some(isNaN)) return null;

                return new Date(Date.UTC(year, month, day, hours, minutes, seconds));
            } catch (e) {
                console.warn("Não foi possível fazer o parse da string de data:", dateInput, e);
                return null;
            }
        }
        
        // Caso 3: Tipo de dado inválido ou nulo
        console.warn("Tipo de dado de data inválido encontrado:", dateInput);
        return null;
    }

async function fetchAndShowTimeline(userId, userName) {
    const popup = document.getElementById('timeline-popup');
    const title = document.getElementById('timeline-popup-title');
    const container = document.getElementById('timeline-container');

    title.textContent = `Timeline de Atividade: ${userName}`;
    container.innerHTML = '<p style="text-align:center;">A carregar histórico...</p>';
    popup.style.display = 'flex';

    try {
        const q = query(collection(db, "eye"), where("userId", "==", userId), orderBy("dataacao", "desc"));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            container.innerHTML = '<p style="text-align:center;">Nenhuma atividade registada para este utilizador.</p>';
            return;
        }

        // Agrupa as ações por dia
        const actionsByDay = new Map();
        querySnapshot.forEach(doc => {
            const data = doc.data();
            const actionDate = parseDateFromFirestore(data.dataacao);
            if (!actionDate) return; // Pula registos com data inválida

            const dayKey = actionDate.toLocaleDateString('pt-PT', { year: 'numeric', month: '2-digit', day: '2-digit' });

            if (!actionsByDay.has(dayKey)) {
                actionsByDay.set(dayKey, []);
            }
            actionsByDay.get(dayKey).push({
                time: actionDate.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' }),
                action: data.acao || 'Ação não especificada'
            });
        });

        if (actionsByDay.size === 0) {
            container.innerHTML = '<p style="text-align:center;">Nenhuma atividade com data válida encontrada.</p>';
            return;
        }
        
        // Gera o HTML para a timeline
        let timelineHTML = '';
        for (const [dayKey, actions] of actionsByDay.entries()) {
             // Precisamos de uma data real para o botão de apagar
            const dateParts = dayKey.split('/');
            const realDate = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`);
            const startOfDay = new Date(realDate.setHours(0, 0, 0, 0)).getTime();
            const endOfDay = new Date(realDate.setHours(23, 59, 59, 999)).getTime();

            timelineHTML += `
                <div class="day-group">
                    <div class="day-header">
                        <span>${dayKey}</span>
                        <i class="fas fa-trash-alt delete-day-btn" title="Eliminar todos os registos deste dia"
                           data-userid="${userId}" data-day-key="${dayKey}"
                           data-date-start="${startOfDay}" data-date-end="${endOfDay}"></i>
                    </div>
                    <div class="day-actions">
                        ${actions.map(act => `<div class="action-entry">[${act.time}] ${act.action}</div>`).join('')}
                    </div>
                </div>
            `;
        }
        container.innerHTML = timelineHTML;

        // Adiciona event listeners para os novos elementos
        container.querySelectorAll('.day-header').forEach(header => {
            header.addEventListener('click', (event) => {
                // Não ativa o toggle se o clique for no botão de eliminar
                if (event.target.classList.contains('delete-day-btn')) return;
                const actionsContainer = header.nextElementSibling;
                actionsContainer.style.display = actionsContainer.style.display === 'block' ? 'none' : 'block';
            });
        });

        container.querySelectorAll('.delete-day-btn').forEach(button => {
            button.addEventListener('click', handleDeleteDayActions);
        });

    } catch (error) {
        console.error("Erro ao buscar timeline:", error);
        container.innerHTML = `<p style="text-align:center; color:red;">Ocorreu um erro ao carregar a timeline.</p>`;
    }
}



async function openPermissionsPopup(userId, userName) {
    const popup = document.getElementById('permissions-popup');
    const title = document.getElementById('permissions-popup-title');
    const container = document.getElementById('permissions-form-container');
    const saveBtn = document.getElementById('save-permissions-btn');
    const statusEl = document.getElementById('permissions-status');

    title.textContent = `Permissões: ${userName}`;
    container.innerHTML = '<p style="text-align:center;">A carregar permissões atuais...</p>';
    statusEl.textContent = '';
    saveBtn.disabled = true;
    saveBtn.setAttribute('data-userid', userId); // Guarda o ID do utilizador no botão
    popup.style.display = 'flex';

    try {
        const userRef = doc(db, "users", userId);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
            container.innerHTML = '<p style="text-align:center; color:red;">Utilizador não encontrado.</p>';
            return;
        }

        const userData = userSnap.data();
        const currentPermissions = userData.permissoes || {}; // Garante que é um objeto, mesmo que não exista
        const permissionsList = ['empire', 'whowins', 'myths', 'endless', 'mundial'];

        let formHTML = '';
        permissionsList.forEach(perm => {
            const isEnabled = currentPermissions[perm] === 'yes';
            formHTML += `
                <div class="permission-toggle">
                    <label for="perm-${perm}">${perm}</label>
                    <label class="switch">
                        <input type="checkbox" id="perm-${perm}" data-permission-key="${perm}" ${isEnabled ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
            `;
        });
        
        container.innerHTML = formHTML;
        saveBtn.disabled = false;

    } catch (error) {
        console.error("Erro ao carregar permissões:", error);
        container.innerHTML = `<p style="text-align:center; color:red;">Erro ao carregar: ${error.message}</p>`;
    }
}

async function handleSavePermissions(event) {
    const saveBtn = event.target;
    const userId = saveBtn.dataset.userid;
    const statusEl = document.getElementById('permissions-status');
    
    if (!userId) return;

    saveBtn.disabled = true;
    statusEl.textContent = 'A guardar...';
    statusEl.style.color = '#007bff';

    try {
        const newPermissionsMap = {};
        const container = document.getElementById('permissions-form-container');
        container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            const key = checkbox.dataset.permissionKey;
            newPermissionsMap[key] = checkbox.checked ? 'yes' : 'no';
        });

        const userRef = doc(db, "users", userId);
        await updateDoc(userRef, {
            permissoes: newPermissionsMap
        });

        statusEl.textContent = 'Permissões guardadas com sucesso!';
        statusEl.style.color = '#28a745';

    } catch (error) {
        console.error("Erro ao guardar permissões:", error);
        statusEl.textContent = 'Erro ao guardar. Tente novamente.';
        statusEl.style.color = '#dc3545';
    } finally {
        setTimeout(() => {
            saveBtn.disabled = false;
        }, 1500);
    }
}

    async function handleDeleteDayActions(event) {
        const userId = event.target.dataset.userid;
        const dayKey = event.target.dataset.dayKey;
        const startOfDay = new Date(parseInt(event.target.dataset.dateStart));
        const endOfDay = new Date(parseInt(event.target.dataset.dateEnd));
        
        if (!confirm(`Tem a certeza que deseja eliminar TODOS os registos do dia ${dayKey}?`)) {
            return;
        }
        
        const q = query(collection(db, "eye"), where("userId", "==", userId));
        const snapshot = await getDocs(q);

        const batch = writeBatch(db);
        let count = 0;
        snapshot.forEach(doc => {
            const docData = doc.data();
            const docDate = parseDateFromFirestore(docData.dataacao);
            if (docDate && docDate >= startOfDay && docDate <= endOfDay) {
                batch.delete(doc.ref);
                count++;
            }
        });

        if (count === 0) {
            alert("Nenhum registo encontrado para eliminar (pode já ter sido removido).");
            return;
        }

        try {
            await batch.commit();
            alert(`${count} registos eliminados com sucesso!`);
            event.target.closest('.day-group').remove();
        } catch (error) {
            console.error("Erro ao eliminar registos:", error);
            alert("Ocorreu um erro ao tentar eliminar os registos.");
        }
    }

    async function initializeRealtimeListeners() {
        const statusMessage = document.getElementById('status-message');
        try {
            await fetchCurrentSeason();
            const processFirstSnapshot = (snapshot) => { processAndRenderUsers(snapshot); if (!isInitialLoadComplete) { setTimeout(() => { isInitialLoadComplete = true; }, 1000); }};
            onSnapshot(query(collection(db, "users")), processFirstSnapshot, (error) => { console.error("Erro no listener de 'users':", error); statusMessage.textContent = `Erro de conexão.`; });
            onSnapshot(query(collection(db, "jogadores")), (playersSnapshot) => { const newPlayerCounts = {}; playersSnapshot.forEach(playerDoc => { const buyerId = playerDoc.data().compradopor; if (buyerId) newPlayerCounts[buyerId] = (newPlayerCounts[buyerId] || 0) + 1; }); playerCounts = newPlayerCounts; getDocs(collection(db, "users")).then(processAndRenderUsers); });
            const debtQuery = query(collection(db, "movimentos"), where("estado", "==", "Por Pagar"), where("temporada", "==", currentSeason));
            onSnapshot(debtQuery, (debtSnapshot) => { const newDebtTotals = {}; debtSnapshot.forEach(debtDoc => { const debtData = debtDoc.data(); const userId = debtData.userId; const debtAmount = debtData.valorTotalAPagar || 0; if (userId) newDebtTotals[userId] = (newDebtTotals[userId] || 0) + debtAmount; }); debtTotals = newDebtTotals; getDocs(collection(db, "users")).then(processAndRenderUsers); });
            document.querySelectorAll('thead th.sortable').forEach(th => { th.addEventListener('click', () => sortTable(th.dataset.column)); });
        } catch (error) {
            console.error("Erro CRÍTICO ao inicializar:", error);
            statusMessage.textContent = `Erro ao carregar: ${error.message}`;
        }
    }

    // === Event Listeners da Página ===
    const movementsPopup = document.getElementById('movements-popup');
    movementsPopup.querySelector('.close-button').addEventListener('click', () => movementsPopup.style.display = 'none');
    movementsPopup.addEventListener('click', (event) => { if (event.target === movementsPopup) movementsPopup.style.display = 'none'; });
    document.getElementById('recalculate-button').addEventListener('click', (event) => { const userId = event.target.dataset.userid; if (userId) handleRecalculateBalance(userId); });
    
    document.getElementById('timeline-button').addEventListener('click', (event) => {
        const userId = event.target.dataset.userid;
        const userName = event.target.dataset.username;
        if (userId) {
            fetchAndShowTimeline(userId, userName);
        }
    });

    const timelinePopup = document.getElementById('timeline-popup');
    timelinePopup.querySelector('.close-button').addEventListener('click', () => timelinePopup.style.display = 'none');
    timelinePopup.addEventListener('click', (event) => { if (event.target === timelinePopup) timelinePopup.style.display = 'none'; });

    document.getElementById('bulletin-button').addEventListener('click', renderAndShowChangeLog);
    const changelogPopup = document.getElementById('changelog-popup');
    changelogPopup.querySelector('.close-button').addEventListener('click', () => changelogPopup.style.display = 'none');
    changelogPopup.addEventListener('click', (event) => { if (event.target === changelogPopup) changelogPopup.style.display = 'none'; });

    const filterIcon = document.getElementById('filter-icon');
    const filterPopup = document.getElementById('filter-popup');
    filterIcon.addEventListener('click', (event) => { event.stopPropagation(); filterPopup.classList.toggle('filter-hidden'); });
    window.addEventListener('click', () => { if (!filterPopup.classList.contains('filter-hidden')) filterPopup.classList.add('filter-hidden'); });
    filterPopup.addEventListener('click', (event) => { event.stopPropagation(); });
    document.querySelectorAll('input[name="table_filter"]').forEach(radio => { radio.addEventListener('change', (event) => { currentFilter = event.target.value; applyFiltersAndSort(); filterPopup.classList.add('filter-hidden'); }); });
document.getElementById('permissions-button').addEventListener('click', (event) => {
    const userId = event.target.dataset.userid;
    const userName = event.target.dataset.username;
    if (userId) {
        openPermissionsPopup(userId, userName);
    }
});

// Listeners para o popup de permissões
const permissionsPopup = document.getElementById('permissions-popup');
permissionsPopup.querySelector('.close-button').addEventListener('click', () => permissionsPopup.style.display = 'none');
permissionsPopup.addEventListener('click', (event) => { if (event.target === permissionsPopup) permissionsPopup.style.display = 'none'; });
document.getElementById('save-permissions-btn').addEventListener('click', handleSavePermissions);



    onAuthStateChanged(auth, async (user) => { document.body.style.display = 'flex'; if (user) { const userDoc = await getDoc(doc(db, "users", user.uid)); if (userDoc.exists() && userDoc.data().estatuto === 'ruler') { initializeRealtimeListeners(); } else { window.location.replace('/acesso-negado.html'); } } else { statusMessage.textContent = 'É necessário fazer login para aceder a esta página.'; } });




</script>
</body>
</html>
