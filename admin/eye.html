<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G Empire Eye - Visão Geral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script type="module" src="js/auth-guard.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; display: none; flex-direction: column; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .menu-item i { font-size: 16px; }
        .content { padding: 80px 20px 20px; max-width: 1200px; width: 100%; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 24px; font-size: 28px; text-align: center; }
        #status-message { text-align: center; font-size: 18px; color: #666; padding: 40px; }
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        tbody tr:nth-child(even) { background-color: #fafafa; }
        tbody tr:hover td { background-color: #f1f1f1 !important; }
        thead th.sortable { cursor: pointer; position: relative; user-select: none; }
        thead th.sortable:hover { background-color: #e9e9e9; }
        thead th.sortable::after { content: ''; position: absolute; right: 15px; top: 50%; margin-top: -8px; border: 5px solid transparent; opacity: 0.3; }
        thead th.sort-asc::after { opacity: 1; border-bottom-color: #333; }
        thead th.sort-desc::after { opacity: 1; border-top-color: #333; }
        .highlight-update { background-color: #d4edda !important; transition: background-color 1.5s ease; }

        /* Coloração das Colunas */
        #users-table th:nth-child(3), #users-table td:nth-child(3) { background-color: #e7f3ff; }
        #users-table th:nth-child(4), #users-table td:nth-child(4) { background-color: #fff8e1; }
        #users-table th:nth-child(5), #users-table td:nth-child(5) { background-color: #e8f5e9; }
        #users-table th:nth-child(6), #users-table td:nth-child(6) { background-color: #ffebee; color: #c62828; font-weight: 500;}

        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .popup-content {
            background-color: #fff; padding: 25px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%; max-width: 900px; max-height: 80vh;
            display: flex; flex-direction: column; position: relative;
        }
        .close-button {
            position: absolute; top: 10px; right: 15px;
            font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer;
        }
        .close-button:hover { color: #333; }
        .popup-table-container { overflow-y: auto; }
        #users-table-body tr { cursor: pointer; }

        #recalculate-button {
            position: absolute; top: 25px; right: 50px;
            padding: 8px 12px; border: none; background-color: #007bff;
            color: white; border-radius: 5px; cursor: pointer; font-weight: bold;
            transition: background-color 0.3s ease;
        }
        #recalculate-button:hover { background-color: #0056b3; }
        #recalculate-button:disabled { background-color: #cccccc; cursor: not-allowed; }

        #bulletin-button {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background-color: #007bff; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1500; transition: transform 0.3s ease, opacity 0.3s ease;
            transform: scale(0); opacity: 0;
        }
        #bulletin-button.bulletin-visible { transform: scale(1); opacity: 1; }
        #bulletin-badge {
            position: absolute; top: -2px; right: -2px; width: 24px; height: 24px;
            background-color: #dc3545; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; border: 2px solid white;
        }
        #changelog-container .log-entry { padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 15px; }
        #changelog-container .log-entry:last-child { border-bottom: none; }
        #changelog-container .log-entry .user { font-weight: bold; color: #0056b3; }
        #changelog-container .log-entry .change-arrow { color: #ffc107; margin: 0 8px; }
    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="1x.html" class="menu-item"><i class="fas fa-home"></i>Home</a>
        <a href="fusiveis.html" class="menu-item"><i class="fas fa-bolt"></i>Fusíveis</a>
        <a href="arbitro.html" class="menu-item"><i class="fas fa-gavel"></i>Árbitro</a>
        <a href="criar-manual.html" class="menu-item"><i class="fas fa-book"></i>Manual</a>
        <a href="criar-banca.html" class="menu-item"><i class="fas fa-university"></i>Banca</a>
    </nav>
    <main class="content">
        <h1><i class="fas fa-eye"></i> G Empire Eye - Utilizadores</h1>
        <p id="status-message">A carregar dados dos utilizadores...</p>
        <div class="table-container" style="display: none;">
            <table id="users-table">
                <thead>
                    <tr>
                        <th class="sortable" data-column="displayName">Utilizador</th>
                        <th class="sortable" data-column="tatica">Tática</th>
                        <th class="sortable" data-column="pontos">Pontos</th>
                        <th class="sortable" data-column="gcoins">GCoins</th>
                        <th class="sortable" data-column="whowins">WhoWins</th>
                        <th class="sortable" data-column="divida">Dívida</th>
                        <th class="sortable" data-column="jogadores">Jogadores</th>
                        <th class="sortable" data-column="ultimoacesso">Último Acesso</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>
    </main>

    <!-- HTML DO POPUP DE MOVIMENTAÇÕES -->
    <div id="movements-popup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-button">&times;</span>
            <button id="recalculate-button" title="Recalcula o saldo GCoins do utilizador com base em todos os seus movimentos da temporada.">Recalcular</button>
            <h2 id="popup-title" style="margin-bottom: 20px; padding-right: 120px;">Movimentações</h2>
            <div class="popup-table-container">
                <table id="movements-detail-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Estado</th>
                            <th>Tipo</th>
                            <th>Preço</th>
                            <th>Valor Real</th>
                            <th>Descrição</th>
                            <th>Valor a Pagar</th>
                        </tr>
                    </thead>
                    <tbody id="movements-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Botão do Boletim e Popup de Changelog -->
    <div id="bulletin-button" class="bulletin-hidden">
        <i class="fas fa-bell"></i>
        <span id="bulletin-badge"></span>
    </div>
    <div id="changelog-popup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-button">&times;</span>
            <h2 style="margin-bottom: 20px;">Registo de Alterações em Tempo Real</h2>
            <div id="changelog-container" class="popup-table-container"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.appspot.com",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allUsersData = [];
        let playerCounts = {};
        let debtTotals = {};
        let currentSort = { column: 'pontos', direction: 'desc' };
        let currentSeason = null;
        let changesMap = new Map();

        let isInitialLoadComplete = false;
        let changeLog = [];
        let newChangesCount = 0;
        const fieldNames = {
            pontos: 'Pontos',
            gcoins: 'GCoins',
            whowins: 'WhoWins',
            divida: 'Dívida',
            jogadores: 'Jogadores'
        };

        async function fetchCurrentSeason() {
            if (currentSeason) return currentSeason;
            const configRef = doc(db, "paineis", "configuracoes_gerais");
            const docSnap = await getDoc(configRef);
            if (docSnap.exists() && docSnap.data().temporadaAtual) {
                const temporada = docSnap.data().temporadaAtual;
                currentSeason = temporada.replace(/\//g, '');
                return currentSeason;
            }
            throw new Error("Não foi possível encontrar a temporada atual.");
        }

        async function handleRecalculateBalance(userId) {
            const button = document.getElementById('recalculate-button');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'A calcular...';
            try {
                const season = await fetchCurrentSeason();
                const movimentosRef = collection(db, "movimentos");
                const q = query(movimentosRef, where("userId", "==", userId), where("temporada", "==", season));
                const querySnapshot = await getDocs(q);
                let newBalance = 0;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.estado !== 'WhoWins Paid') {
                        const valor = parseFloat(data.valorreal);
                        if (!isNaN(valor)) newBalance += valor;
                    }
                });
                const userRef = doc(db, 'users', userId);
                const gCoinsField = `${season}GCoins`;
                await updateDoc(userRef, { [gCoinsField]: newBalance });
                button.textContent = 'Sucesso!';
                button.style.backgroundColor = '#28a745';
            } catch (error) {
                console.error("Erro ao recalcular saldo:", error);
                button.textContent = 'Erro!';
                button.style.backgroundColor = '#dc3545';
            } finally {
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    button.style.backgroundColor = '';
                }, 2000);
            }
        }

        function formatFirebaseTimestamp(timestampObject) {
            if (!timestampObject || typeof timestampObject.toDate !== 'function') return 'Nunca';
            try {
                const dateObj = timestampObject.toDate();
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                const hours = String(dateObj.getHours()).padStart(2, '0');
                const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year}, ${hours}h${minutes}`;
            } catch (error) { return 'Data Inválida'; }
        }

        function formatMovementDate(timestampObject) {
            if (!timestampObject || typeof timestampObject.toDate !== 'function') return 'N/A';
            const dateObj = timestampObject.toDate();
            const day = dateObj.getDate();
            const month = dateObj.toLocaleString('pt-PT', { month: 'long' });
            const year = dateObj.getFullYear();
            return `${day} ${month} ${year}`;
        }
        
        function renderTable(users) {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.setAttribute('data-userid', user.id);
                row.setAttribute('data-username', user.displayName);
                const userChanges = changesMap.get(user.id) || {};
                row.innerHTML = `
                    <td>${user.displayName}</td>
                    <td>${user.tatica}</td>
                    <td class="${userChanges.pontos ? 'highlight-update' : ''}">${user.pontos}</td>
                    <td class="${userChanges.gcoins ? 'highlight-update' : ''}">${user.gcoins}</td>
                    <td class="${userChanges.whowins ? 'highlight-update' : ''}">${user.whowins}</td>
                    <td class="${userChanges.divida ? 'highlight-update' : ''}">${user.divida}</td>
                    <td class="${userChanges.jogadores ? 'highlight-update' : ''}">${user.jogadores}</td>
                    <td>${user.ultimoacesso}</td>
                `;
                tableBody.appendChild(row);
            });
            addEventListenersToRows();
            document.querySelectorAll('.highlight-update').forEach(cell => {
                setTimeout(() => {
                    cell.classList.remove('highlight-update');
                }, 2500);
            });
            changesMap.clear();
        }

        function processAndRenderUsers(usersSnapshot) {
            const statusMessage = document.getElementById('status-message');
            const tableContainer = document.querySelector('.table-container');

            if (usersSnapshot.empty) {
                statusMessage.textContent = 'Nenhum utilizador encontrado.';
                statusMessage.style.display = 'block';
                tableContainer.style.display = 'none';
                return;
            }

            const newUsersData = [];
            const oldDataMap = new Map(allUsersData.map(u => [u.id, u]));

            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                const userId = doc.id;
                const pontosField = `${currentSeason}Pontos`;
                const gcoinsField = `${currentSeason}GCoins`;

                const newUser = {
                    id: userId,
                    displayName: userData.nometabela || userData.email || 'N/A',
                    tatica: userData.tática || 'N/A',
                    pontos: userData[pontosField] || 0,
                    gcoins: userData[gcoinsField] || 0,
                    whowins: userData.whowinsgCoins || 0,
                    divida: debtTotals[userId] || 0,
                    jogadores: playerCounts[userId] || 0,
                    ultimoacesso: formatFirebaseTimestamp(userData.ultimoacesso)
                };
                newUsersData.push(newUser);

                const oldUser = oldDataMap.get(userId);
                if (oldUser && isInitialLoadComplete) {
                    const userChanges = {};
                    for (const key of Object.keys(fieldNames)) {
                        if (oldUser[key] !== newUser[key]) {
                            userChanges[key] = true;
                            changeLog.unshift({
                                user: newUser.displayName,
                                field: fieldNames[key],
                                oldValue: oldUser[key],
                                newValue: newUser[key],
                                timestamp: new Date()
                            });
                            newChangesCount++;
                        }
                    }
                    if (Object.keys(userChanges).length > 0) {
                        changesMap.set(userId, userChanges);
                    }
                }
            });

            allUsersData = newUsersData;
            sortTable(currentSort.column, true);

            if (isInitialLoadComplete) {
                updateBulletinUI();
            }

            statusMessage.style.display = 'none';
            tableContainer.style.display = 'block';
        }

        function updateBulletinUI() {
            const bulletinButton = document.getElementById('bulletin-button');
            const bulletinBadge = document.getElementById('bulletin-badge');

            if (newChangesCount > 0) {
                bulletinBadge.textContent = newChangesCount > 9 ? '9+' : newChangesCount;
                bulletinButton.classList.remove('bulletin-hidden');
                bulletinButton.classList.add('bulletin-visible');
            } else {
                bulletinButton.classList.remove('bulletin-visible');
                bulletinButton.classList.add('bulletin-hidden');
            }
        }

        function renderAndShowChangeLog() {
            const popup = document.getElementById('changelog-popup');
            const container = document.getElementById('changelog-container');
            container.innerHTML = '';

            if (changeLog.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666;">Nenhuma alteração registada desde que a página foi carregada.</p>';
            } else {
                changeLog.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    const time = `${String(log.timestamp.getHours()).padStart(2, '0')}:${String(log.timestamp.getMinutes()).padStart(2, '0')}`;
                    
                    logEntry.innerHTML = `
                        <span>[${time}]</span>
                        O campo <strong>${log.field}</strong> do utilizador <span class="user">${log.user}</span> mudou de
                        <span>${log.oldValue}</span> <i class="fas fa-long-arrow-alt-right change-arrow"></i> <span>${log.newValue}</span>.
                    `;
                    container.appendChild(logEntry);
                });
            }
            
            popup.style.display = 'flex';
            newChangesCount = 0;
            updateBulletinUI();
        }

        async function fetchAndShowMovements(userId, userName) {
            const popup = document.getElementById('movements-popup');
            const popupTitle = document.getElementById('popup-title');
            const tableBody = document.getElementById('movements-table-body');
            const recalculateBtn = document.getElementById('recalculate-button');
            const movementsTable = document.getElementById('movements-detail-table');

            recalculateBtn.setAttribute('data-userid', userId);
            popupTitle.textContent = `Movimentações de ${userName}`;
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">A carregar movimentações...</td></tr>';
            
            const oldTfoot = movementsTable.querySelector('tfoot');
            if (oldTfoot) { oldTfoot.remove(); }
            
            popup.style.display = 'flex';

            try {
                let totalPreco = 0, totalValorReal = 0, totalValorAPagar = 0;
                const season = await fetchCurrentSeason();
                const movementsRef = collection(db, "movimentos");
                const q = query(movementsRef, where("userId", "==", userId), where("temporada", "==", season), orderBy("movimentoData", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">Nenhuma movimentação encontrada para a temporada ${season}.</td></tr>`;
                    return;
                }

                tableBody.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatMovementDate(data.movimentoData)}</td>
                        <td>${data.estado || 'N/A'}</td>
                        <td>${data.tipo || 'N/A'}</td>
                        <td>${data.preco || 0}</td>
                        <td>${data.valorreal || 0}</td>
                        <td>${data.descricao || ''}</td>
                        <td>${data.valorTotalAPagar || 0}</td>
                    `;
                    tableBody.appendChild(row);

                    totalPreco += parseFloat(data.preco) || 0;
                    if (data.estado !== 'WhoWins Paid') {
                        totalValorReal += parseFloat(data.valorreal) || 0;
                    }
                    totalValorAPagar += parseFloat(data.valorTotalAPagar) || 0;
                });

                const tfoot = document.createElement('tfoot');
                tfoot.innerHTML = `
                    <tr style="background-color: #f2f2f2; font-weight: bold; border-top: 2px solid #ccc;">
                        <td colspan="3" style="text-align: right;">TOTAIS:</td>
                        <td>${totalPreco}</td>
                        <td>${totalValorReal}</td>
                        <td></td>
                        <td>${totalValorAPagar}</td>
                    </tr>
                `;
                movementsTable.appendChild(tfoot);

            } catch (error) {
                console.error("Erro ao buscar movimentações:", error);
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Erro ao carregar dados.</td></tr>';
            }
        }

        function addEventListenersToRows() {
            document.querySelectorAll('#users-table-body tr').forEach(row => {
                row.addEventListener('click', () => {
                    const userId = row.dataset.userid;
                    const userName = row.dataset.username;
                    if (userId) {
                        fetchAndShowMovements(userId, userName);
                    }
                });
            });
        }
        
       function sortTable(columnKey, keepDirection = false) {
            const direction = keepDirection ? currentSort.direction : (currentSort.column === columnKey && currentSort.direction === 'asc' ? 'desc' : 'asc');
            
            allUsersData.sort((a, b) => {
                let valA = a[columnKey]; 
                let valB = b[columnKey];
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return direction === 'asc' ? valA - valB : valB - valA;
                } else {
                    return direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
                }
            });

            if (!keepDirection) {
                currentSort = { column: columnKey, direction: direction };
            }
            
            document.querySelectorAll('thead th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === currentSort.column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            renderTable(allUsersData);
        }

        async function initializeRealtimeListeners() {
            const statusMessage = document.getElementById('status-message');
            try {
                await fetchCurrentSeason();

                const processFirstSnapshot = (snapshot) => {
                     processAndRenderUsers(snapshot);
                     if (!isInitialLoadComplete) {
                         setTimeout(() => { isInitialLoadComplete = true; console.log("Carga inicial completa. A escutar alterações.") }, 1000);
                     }
                };

                const usersQuery = query(collection(db, "users"));
                onSnapshot(usersQuery, processFirstSnapshot, (error) => {
                     console.error("Erro no listener de 'users':", error);
                     statusMessage.textContent = `Erro de conexão com a base de dados de utilizadores.`;
                });

                const playersQuery = query(collection(db, "jogadores"));
                onSnapshot(playersQuery, (playersSnapshot) => {
                    console.log("Recebida atualização da coleção 'jogadores'. A recontar...");
                    const newPlayerCounts = {};
                    playersSnapshot.forEach(playerDoc => {
                        const buyerId = playerDoc.data().compradopor;
                        if (buyerId) {
                            newPlayerCounts[buyerId] = (newPlayerCounts[buyerId] || 0) + 1;
                        }
                    });
                    playerCounts = newPlayerCounts;
                    getDocs(collection(db, "users")).then(processAndRenderUsers);
                });

                const debtQuery = query(collection(db, "movimentos"), where("estado", "==", "Por Pagar"), where("temporada", "==", currentSeason));
                onSnapshot(debtQuery, (debtSnapshot) => {
                    console.log("Recebida atualização da coleção 'movimentos'. A recalcular dívidas...");
                    const newDebtTotals = {};
                    debtSnapshot.forEach(debtDoc => {
                        const debtData = debtDoc.data();
                        const userId = debtData.userId;
                        const debtAmount = debtData.valorTotalAPagar || 0;
                        if (userId) {
                            newDebtTotals[userId] = (newDebtTotals[userId] || 0) + debtAmount;
                        }
                    });
                    debtTotals = newDebtTotals;
                    getDocs(collection(db, "users")).then(processAndRenderUsers);
                });

                document.querySelectorAll('thead th.sortable').forEach(th => { th.addEventListener('click', () => sortTable(th.dataset.column)); });

            } catch (error) {
                console.error("Erro CRÍTICO ao inicializar listeners:", error);
                statusMessage.textContent = `Ocorreu um erro ao carregar os dados: ${error.message}`;
            }
        }
        
        const movementsPopup = document.getElementById('movements-popup');
        const closeMovementsBtn = movementsPopup.querySelector('.close-button');
        const recalculateBtn = document.getElementById('recalculate-button');
        closeMovementsBtn.addEventListener('click', () => movementsPopup.style.display = 'none');
        movementsPopup.addEventListener('click', (event) => { if (event.target === movementsPopup) movementsPopup.style.display = 'none'; });
        recalculateBtn.addEventListener('click', (event) => {
            const userId = event.target.dataset.userid;
            if (userId) handleRecalculateBalance(userId);
        });
        
        const bulletinButton = document.getElementById('bulletin-button');
        const changelogPopup = document.getElementById('changelog-popup');
        const closeChangelogBtn = changelogPopup.querySelector('.close-button');

        bulletinButton.addEventListener('click', renderAndShowChangeLog);
        closeChangelogBtn.addEventListener('click', () => changelogPopup.style.display = 'none');
        changelogPopup.addEventListener('click', (event) => {
            if (event.target === changelogPopup) {
                changelogPopup.style.display = 'none';
            }
        });

        onAuthStateChanged(auth, async (user) => {
            document.body.style.display = 'flex';
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().estatuto === 'ruler') {
                    initializeRealtimeListeners();
                } else {
                    window.location.replace('/acesso-negado.html');
                }
            } else {
                statusMessage.textContent = 'É necessário fazer login para aceder a esta página.';
            }
        });
    </script>
</body>
</html>
