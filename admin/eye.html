<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>G Empire Eye - Visão Geral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script type="module" src="js/auth-guard.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; display: none; flex-direction: column; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .menu-item i { font-size: 16px; }
        .content { padding: 80px 20px 20px; max-width: 1200px; width: 100%; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 24px; font-size: 28px; text-align: center; }
        #status-message { text-align: center; font-size: 18px; color: #666; padding: 40px; }
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        tbody tr:nth-child(even) { background-color: #fafafa; }
        tbody tr:hover { background-color: #f1f1f1; }
        thead th.sortable { cursor: pointer; position: relative; user-select: none; }
        thead th.sortable:hover { background-color: #e9e9e9; }
        thead th.sortable::after { content: ''; position: absolute; right: 15px; top: 50%; margin-top: -8px; border: 5px solid transparent; opacity: 0.3; }
        thead th.sort-asc::after { opacity: 1; border-bottom-color: #333; }
        thead th.sort-desc::after { opacity: 1; border-top-color: #333; }
    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="1x.html" class="menu-item"><i class="fas fa-home"></i>Home</a>
        <a href="fusiveis.html" class="menu-item"><i class="fas fa-bolt"></i>Fusíveis</a>
        <a href="arbitro.html" class="menu-item"><i class="fas fa-gavel"></i>Árbitro</a>
    </nav>
    <main class="content">
        <h1><i class="fas fa-eye"></i> G Empire Eye - Utilizadores</h1>
        <p id="status-message">A carregar dados dos utilizadores...</p>
        <div class="table-container" style="display: none;">
            <table id="users-table">
                <thead>
                    <tr>
                        <th class="sortable" data-column="displayName">Utilizador</th>
                        <th class="sortable" data-column="tatica">Tática</th>
                        <th class="sortable" data-column="pontos">Pontos</th>
                        <th class="sortable" data-column="gcoins">GCoins</th>
                        <th class="sortable" data-column="ultimoacesso">Último Acesso</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>
    </main>

    <script type="module">
        // LOG A: O primeiro log de todos. Se este não aparecer, o script não está a ser executado.
        console.log("LOG A: O script da página 'eye.html' começou a ser executado.");

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.appspot.com",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allUsersData = [];
        let currentSort = { column: null, direction: 'asc' };

        function formatFirebaseTimestamp(timestampString) {
            console.log("--- A iniciar formatação de data ---");
            console.log("1. Valor recebido:", timestampString);
            if (!timestampString || typeof timestampString !== 'string') {
                console.log("2. Valor inválido ou ausente. A retornar 'Nunca'.");
                return 'Nunca';
            }
            try {
                const meses = { 'janeiro': 0, 'fevereiro': 1, 'março': 2, 'abril': 3, 'maio': 4, 'junho': 5, 'julho': 6, 'agosto': 7, 'setembro': 8, 'outubro': 9, 'novembro': 10, 'dezembro': 11 };
                const cleanString = timestampString.replace(' de ', ' ').replace(' às ', ' ');
                const parts = cleanString.split(/[ :]/);
                console.log("2. String dividida em partes:", parts);
                const day = parseInt(parts[0], 10), month = meses[parts[1].toLowerCase()], year = parseInt(parts[2], 10), hours = parseInt(parts[3], 10), minutes = parseInt(parts[4], 10);
                console.log(`3. Componentes extraídos: Ano=${year}, Mês=${month}, Dia=${day}, Hora=${hours}, Minuto=${minutes}`);
                const dateObj = new Date(year, month, day, hours, minutes);
                console.log("4. Objeto Date criado:", dateObj);
                if (isNaN(dateObj.getTime())) { console.error("5. ERRO: O objeto Date criado é inválido!"); return 'Data Inválida'; }
                const formattedDay = dateObj.getDate(), formattedMonth = dateObj.toLocaleString('pt-PT', { month: 'long' }), formattedYear = dateObj.getFullYear(), formattedHours = String(dateObj.getHours()).padStart(2, '0'), formattedMinutes = String(dateObj.getMinutes()).padStart(2, '0');
                const finalResult = `${formattedDay} ${formattedMonth} ${formattedYear}, ${formattedHours}h${formattedMinutes}`;
                console.log("6. Resultado final da formatação:", finalResult);
                return finalResult;
            } catch (error) { console.error("7. ERRO INESPERADO no bloco try/catch:", error); return 'Erro na Formatação'; }
        }

        function renderTable(users) {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${user.displayName}</td><td>${user.tatica}</td><td>${user.pontos}</td><td>${user.gcoins}</td><td>${user.ultimoacesso}</td>`;
                tableBody.appendChild(row);
            });
        }
        
        function sortTable(columnKey) {
            const isAscending = currentSort.column === columnKey && currentSort.direction === 'asc';
            const direction = isAscending ? 'desc' : 'asc';
            allUsersData.sort((a, b) => {
                let valA = a[columnKey]; let valB = b[columnKey];
                if (typeof valA === 'number' && typeof valB === 'number') { return direction === 'asc' ? valA - b[columnKey] : b[columnKey] - valA; }
                else { return direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA)); }
            });
            currentSort = { column: columnKey, direction: direction };
            document.querySelectorAll('thead th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === columnKey) { th.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc'); }
            });
            renderTable(allUsersData);
        }

        async function fetchAndDisplayUsers() {
            console.log("LOG D: A função fetchAndDisplayUsers() foi chamada.");
            const statusMessage = document.getElementById('status-message');
            const tableContainer = document.querySelector('.table-container');
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                console.log(`LOG E: A consulta ao Firestore retornou ${querySnapshot.size} documentos.`);
                if (querySnapshot.empty) { statusMessage.textContent = 'Nenhum utilizador encontrado.'; return; }

                console.log("LOG F: A iniciar o loop para processar cada utilizador...");
                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    console.log(`LOG G: A processar o utilizador com email: ${userData.email}`);
                    
                    let dynamicPontos = 0, dynamicGCoins = 0;
                    for (const key in userData) {
                        if (key.endsWith('Pontos') && !isNaN(parseInt(key.substring(0, 8)))) { dynamicPontos = userData[key]; }
                        if (key.endsWith('GCoins') && !isNaN(parseInt(key.substring(0, 8)))) { dynamicGCoins = userData[key]; }
                    }
                    allUsersData.push({
                        displayName: userData.nometabela || userData.email || 'N/A',
                        tatica: userData.tática || 'N/A',
                        pontos: dynamicPontos,
                        gcoins: dynamicGCoins,
                        ultimoacesso: formatFirebaseTimestamp(userData.ultimoacesso)
                    });
                });
                
                statusMessage.style.display = 'none';
                tableContainer.style.display = 'block';
                document.querySelectorAll('thead th.sortable').forEach(th => { th.addEventListener('click', () => sortTable(th.dataset.column)); });
                currentSort = { column: 'pontos', direction: 'asc' };
                sortTable('pontos');

            } catch (error) {
                console.error("LOG H: ERRO CRÍTICO no bloco try/catch de fetchAndDisplayUsers:", error);
                statusMessage.textContent = 'Ocorreu um erro ao carregar os dados.';
            }
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("LOG B: Utilizador autenticado encontrado. UID:", user.uid);
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().estatuto === 'ruler') {
                    console.log("LOG C: Verificação de 'ruler' bem-sucedida. A chamar fetchAndDisplayUsers().");
                    fetchAndDisplayUsers();
                } else {
                    console.error("LOG X: Acesso negado. Utilizador não é 'ruler' ou documento não existe.", userDoc.exists() ? userDoc.data() : "Documento não existe");
                    window.location.replace('/acesso-negado.html');
                }
            } else {
                console.warn("LOG Y: Nenhum utilizador autenticado. A redirecionar para o login.");
            }
        });
    </script>
</body>
</html>
