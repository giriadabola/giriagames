<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Empire - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- 1. Adiciona o nosso guardião de segurança. Ele deve ser o primeiro script. -->
    <script type="module" src="js/auth-guard.js"></script>

    <style>
        /* O seu CSS completo e original permanece aqui, sem alterações */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .menu-item i { font-size: 16px; }
        .content { padding: 80px 20px 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 24px; font-size: 28px; }
        .items-grid { display: flex; flex-direction: column; gap: 20px; margin-bottom: 32px; max-width: 1000px; margin-left: auto; margin-right: auto; }
        .item-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; align-items: center; gap: 20px; }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .item-image { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .item-info-container { flex-grow: 1; }
        .item-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; }
        .item-info { color: #666; font-size: 14px; line-height: 1.4; margin-bottom: 4px; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; margin-left: auto; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ff4444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(26px); }
        .action-button-bar { display: flex; justify-content: flex-end; gap: 15px; margin-bottom: 20px; max-width: 1000px; margin-left: auto; margin-right: auto; }
        .save-button { color: white; border: none; padding: 10px 20px; border-radius: 4px; font-size: 15px; cursor: pointer; transition: background-color 0.3s ease; }
        .save-button#saveChanges { background-color: #2176ff; }
        .save-button#saveChanges:hover { background-color: #1a5cc4; }
        .save-button#diaMercadoBtn { background-color: #ff9800; }
        .save-button#diaMercadoBtn:hover { background-color: #e68a00; }
        .save-button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .search-container { position: relative; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .search-input { width: 100%; padding: 12px 40px 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: #2176ff; box-shadow: 0 0 0 3px rgba(33, 118, 255, 0.1); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none; }
        .filter-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; max-width: 1000px; margin-left: auto; margin-right: auto; }
        .filter-button { background-color: #f0f0f0; border: 1px solid #ddd; color: #666; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
        .filter-button:hover, .filter-button.active { background-color: #2176ff; color: white; border-color: #2176ff; font-weight: 500; }
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 30px; flex-wrap: wrap; }
        .pagination-button { background-color: #f0f0f0; border: 1px solid #ddd; color: #666; min-width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s ease; font-size: 14px; padding: 0 5px; }
        .pagination-button:hover:not(.disabled):not(.active) { background-color: #e0e0e0; border-color: #ccc; }
        .pagination-button.active { background-color: #2176ff; color: white; border-color: #2176ff; font-weight: bold; }
        .pagination-button.disabled { opacity: 0.5; cursor: not-allowed; background-color: #f5f5f5; }
        .pagination-button i { font-size: 12px; }
        .no-items { text-align: center; color: #666; font-size: 18px; margin-top: 40px; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .loading { text-align: center; color: #666; font-size: 18px; margin-top: 40px; padding: 30px; }
        .loading i { animation: spin 1s infinite linear; font-size: 28px; margin-bottom: 15px; color: #2176ff; display: block; margin-left: auto; margin-right: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; padding: 20px; }
        .popup-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .popup-content { background-color: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); width: 100%; max-width: 600px; padding: 25px 30px; position: relative; transform: scale(0.95); transition: transform 0.3s ease; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .popup-overlay.active .popup-content { transform: scale(1); }
        .popup-close { position: absolute; top: 15px; right: 15px; font-size: 22px; color: #888; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; line-height: 1; padding: 5px; }
        .popup-close:hover { color: #ff4444; transform: rotate(90deg); }
        .popup-title { font-size: 22px; color: #333; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 1px solid #eee; font-weight: 600; }
        .popup-section { margin-bottom: 25px; }
        .popup-section-title { font-size: 16px; font-weight: 600; color: #444; margin-bottom: 12px; }
        .popup-section h4 { font-size: 14px; color: #555; margin-top: 15px; margin-bottom: 8px; font-weight: 500; }
        .popup-options { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .popup-option { background-color: #f0f0f0; border: 1px solid #ddd; color: #666; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
        .popup-option:hover:not(.active) { background-color: #e5e5e5; border-color: #ccc; }
        .popup-option.active { background-color: #2176ff; color: white; border-color: #2176ff; font-weight: 500; }
        .popup-search-container { margin-bottom: 15px; position: relative; }
        .popup-search-input { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
        .popup-search-input:focus { outline: none; border-color: #2176ff; box-shadow: 0 0 0 3px rgba(33, 118, 255, 0.1); }
        .popup-items-container { max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 5px; margin-bottom: 15px; }
        .popup-item { display: flex; align-items: center; padding: 8px 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease; margin-bottom: 2px; }
        .popup-item:hover { background-color: #f5f5f5; }
        .popup-item-checkbox { margin-right: 12px; flex-shrink: 0; cursor: pointer; accent-color: #2176ff; transform: scale(1.1); }
        .popup-item-name { font-size: 14px; color: #333; line-height: 1.4; flex-grow: 1; pointer-events: none; }
        .popup-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .popup-button { padding: 10px 20px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .popup-button-cancel { background-color: #f0f0f0; color: #666; border: 1px solid #ddd; }
        .popup-button-cancel:hover { background-color: #e0e0e0; border-color: #ccc; }
        .popup-button-apply { background-color: #2176ff; color: white; border: none; }
        .popup-button-apply:hover { background-color: #1a5cc4; }
        .popup-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; }
        .popup-date-input { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; margin-bottom: 15px; cursor: pointer; }
        .popup-date-input:focus { outline: none; border-color: #2176ff; box-shadow: 0 0 0 3px rgba(33, 118, 255, 0.1); }
    </style>
</head>
<body style="display: none;"> <!-- 2. O corpo da página está oculto por padrão -->

    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item"><i class="fas fa-home"></i>Home</a>
        <a href="criar-empire.html" class="menu-item"><i class="fas fa-plus"></i>Criar Item</a>
        <a href="editar-empire.html" class="menu-item"><i class="fas fa-edit"></i>Editar Item</a>
    </nav>

    <main class="content">
        <h1>Gerenciar Itens do Empire</h1>
        <div class="search-container"><input type="text" id="searchInput" class="search-input" placeholder="Pesquisar itens (nome, tipo)..."><i class="fas fa-search search-icon"></i></div>
        <div class="filter-container" id="filterContainer"><button class="filter-button active" data-filter="all">Todos</button></div>
        <div class="action-button-bar"><button id="diaMercadoBtn" class="save-button">Configurar Dia Mercado</button><button id="saveChanges" class="save-button">Salvar Alterações</button></div>
        <div class="items-grid" id="items-grid"><div class="loading" id="loading"><i class="fas fa-spinner"></i><p>Carregando itens...</p></div></div>
        <div class="pagination" id="pagination"></div>
    </main>

    <div class="popup-overlay" id="diaMercadoPopup">
        <div class="popup-content">
            <div class="popup-close" id="popupClose"><i class="fas fa-times"></i></div>
            <h2 class="popup-title">Configurar Dia de Mercado</h2>
            <div class="popup-section">
                <h3 class="popup-section-title">1. Selecionar Itens</h3>
                <div class="popup-options"><button class="popup-option active" data-selection="todos">Todos os Itens</button><button class="popup-option" data-selection="personalizado">Itens Personalizados</button></div>
                <div id="itemsSelectionContainer" style="display: none;"><div class="popup-search-container"><input type="text" id="popupSearchInput" class="popup-search-input" placeholder="Pesquisar itens por nome ou tipo..."></div><div class="popup-items-container" id="popupItemsContainer"></div></div>
            </div>
            <div class="popup-section">
                <h3 class="popup-section-title">2. Selecionar Dia e Frequência</h3>
                <h4>Dia da Semana (Único ou para Recorrência):</h4>
                <div class="popup-options" id="dayOfWeekOptions"><button class="popup-option day-option" data-day="Segunda">Seg</button><button class="popup-option day-option" data-day="Terça">Ter</button><button class="popup-option day-option" data-day="Quarta">Qua</button><button class="popup-option day-option" data-day="Quinta">Qui</button><button class="popup-option day-option" data-day="Sexta">Sex</button><button class="popup-option day-option" data-day="Sábado">Sáb</button><button class="popup-option day-option" data-day="Domingo">Dom</button></div>
                <h4>Frequência (Opcional - combinar com dia acima):</h4>
                <div class="popup-options" id="frequencyOptions"><button class="popup-option frequency-option" data-frequency="7">A cada 7 dias</button><button class="popup-option frequency-option" data-frequency="15">A cada 15 dias</button><button class="popup-option frequency-option" data-frequency="30">A cada 30 dias</button><button class="popup-option frequency-option" data-frequency="">Nenhuma (Usar apenas o dia)</button></div>
                <h4>Ou Data Específica:</h4>
                <input type="date" id="specificDateInput" class="popup-date-input">
            </div>
            <div class="popup-actions"><button class="popup-button popup-button-cancel" id="popupCancelButton">Cancelar</button><button class="popup-button popup-button-apply" id="popupApplyButton">Aplicar</button></div>
        </div>
    </div>

    <!-- 3. O script da página foi modificado para usar o guardião -->
    <script type="module">
        // Importa a variável 'db' do guardião e outras funções do Firestore
        import { db } from './js/auth-guard.js';
        import { collection, getDocs, doc, updateDoc, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // A inicialização do Firebase foi completamente removida daqui

        console.log("Script module started.");
    
        // --- Global State ---
        let changedItems = new Map();
        let allItems = [];
        let currentFilter = 'all';
        let currentPage = 1;
        const itemsPerPage = 10;
    
        // --- Popup State ---
        let selectedItems = new Set();
        let selectedDay = null;
        let selectedFrequency = null;
        let specificDateValue = null;
    
        // --- Utility Functions ---
        function formatCompradoPor(compradoPorUids) {
             if (!Array.isArray(compradoPorUids) || compradoPorUids.length === 0) { return 'Ninguém'; }
             return `${compradoPorUids.length} usuário(s)`;
         }
         function formatDataMercado(dataMercadoValue) {
             if (!dataMercadoValue) { return 'Não definido'; }
             if (typeof dataMercadoValue === 'string' && dataMercadoValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                 try { const [year, month, day] = dataMercadoValue.split('-'); const date = new Date(Date.UTC(Number(year), Number(month) - 1, Number(day))); if (isNaN(date.getTime())) throw new Error("Invalid Date"); return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' }); } catch (e) { console.warn("Error parsing date:", dataMercadoValue, e); return dataMercadoValue; }
             } else if (typeof dataMercadoValue === 'string') { const frequencyMatch = dataMercadoValue.match(/^(\d+)(Segunda|Terça|Quarta|Quinta|Sexta|Sábado|Domingo)$/); if (frequencyMatch) { const frequency = frequencyMatch[1]; const day = frequencyMatch[2]; return `A cada ${frequency} dias (${day})`; } else if (["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"].includes(dataMercadoValue)) { return dataMercadoValue; } else { console.warn("Unrecognized dataMercado format:", dataMercadoValue); return dataMercadoValue; }
             } else { console.warn("Unexpected dataMercado type:", typeof dataMercadoValue, dataMercadoValue); return String(dataMercadoValue); }
         }
    
        // --- DOM Manipulation Functions ---
        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.itemId = item.id;
    
            try {
                const imageUrl = item.imagem || 'https://via.placeholder.com/100x100/eee/ccc?text=Sem+Imagem';
                const valorFormatted = item.valor != null ? item.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'Não definido';
                const compradoPorFormatted = formatCompradoPor(item.compradoPorUids);
                const diaMercadoFormatted = formatDataMercado(item.dataMercado);
    
                card.innerHTML = `
                    <img src="${imageUrl}" alt="${item.nome || 'Item sem nome'}" class="item-image" loading="lazy">
                    <div class="item-info-container">
                        <div class="item-name">${item.nome || 'Item sem nome'}</div>
                        <div class="item-info"><strong>Tipo:</strong> ${item.tipo || 'Não especificado'}</div>
                        <div class="item-info"><strong>Valor:</strong> ${valorFormatted}</div>
                        <div class="item-info"><strong>Comprado por:</strong> ${compradoPorFormatted}</div>
                        <div class="item-info"><strong>Dia Mercado:</strong> ${diaMercadoFormatted}</div>
                    </div>
                    <label class="toggle-switch" title="${item.noMercado ? 'No mercado (Disponível)' : 'Fora do mercado (Indisponível)'}">
                        <input type="checkbox" ${item.noMercado ? 'checked' : ''} data-item-id="${item.id}">
                        <span class="slider"></span>
                    </label>
                `;
    
                const toggleSwitch = card.querySelector('input[type="checkbox"]');
                 toggleSwitch.addEventListener('change', (e) => {
                     const itemId = e.target.dataset.itemId;
                     const isChecked = e.target.checked;
                     changedItems.set(itemId, isChecked);
                     e.target.closest('label').title = isChecked ? 'No mercado (Disponível)' : 'Fora do mercado (Indisponível)';
                 });
    
            } catch (error) {
                console.error(`Error creating card content for item ID: ${item.id}`, item, error);
                card.innerHTML = `<div style="color: red; padding: 10px; border: 1px solid red;">Erro ao renderizar item: ${item.id || 'ID desconhecido'}. Ver console.</div>`;
            }
            return card;
        }
    
        function renderItems() {
            console.log("renderItems called.");
            const itemsGrid = document.getElementById('items-grid');
            const loading = document.getElementById('loading');
            if (!itemsGrid) { console.error("renderItems: Could not find 'items-grid' element."); return; }
            if (loading) { loading.style.display = 'none'; }
    
            itemsGrid.innerHTML = '';
            let filteredItems = (currentFilter === 'all') ? [...allItems] : allItems.filter(item => item.tipo === currentFilter);
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
             if (searchTerm) {
                 filteredItems = filteredItems.filter(item =>
                    (item.nome || '').toLowerCase().includes(searchTerm) ||
                    (item.tipo || '').toLowerCase().includes(searchTerm)
                );
             }
    
            const totalItems = filteredItems.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filteredItems.slice(startIndex, endIndex);
    
            if (paginatedItems.length === 0) {
                let message = 'Nenhum item encontrado.';
                 if (searchTerm && currentFilter !== 'all') { message = `Nenhum item encontrado para "${searchTerm}" do tipo "${currentFilter}".`; }
                 else if (searchTerm) { message = `Nenhum item encontrado para "${searchTerm}".`; }
                 else if (currentFilter !== 'all') { message = `Nenhum item encontrado do tipo "${currentFilter}".`; }
                itemsGrid.innerHTML = `<div class="no-items">${message}</div>`;
            } else {
                paginatedItems.forEach((item, index) => {
                    if (item && item.id) {
                         const itemCard = createItemCard(item);
                         itemsGrid.appendChild(itemCard);
                    } else {
                        console.warn(`renderItems: Skipping invalid item at index ${index}`, item);
                    }
                });
            }
    
            updatePagination(totalPages);
        }
    
        function addFilters(items) {
            const filterContainer = document.getElementById('filterContainer');
            if (!filterContainer) return;
            const types = new Set(items.map(item => item.tipo).filter(Boolean));
            const existingDynamicFilters = filterContainer.querySelectorAll('.filter-button:not([data-filter="all"])');
            existingDynamicFilters.forEach(btn => btn.remove());
            Array.from(types).sort().forEach(type => {
                const button = document.createElement('button');
                button.className = 'filter-button';
                button.dataset.filter = type;
                button.textContent = type;
                filterContainer.appendChild(button);
            });
            console.log("addFilters: Dynamic filter buttons updated.");
        }
    
        function handleFilterClick(event) {
            const clickedButton = event.target;
            const newFilter = clickedButton.dataset.filter;
            if (currentFilter === newFilter && clickedButton.classList.contains('active')) { return; }
            document.querySelectorAll('#filterContainer .filter-button').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            currentFilter = newFilter;
            currentPage = 1;
            renderItems();
        }
    
        function updatePagination(totalPages) {
             const paginationContainer = document.getElementById('pagination');
             if (!paginationContainer) { console.error("updatePagination: Cannot find 'pagination' element."); return; }
             paginationContainer.innerHTML = '';
             if (totalPages <= 1) { return; }
    
             const createButton = (content, pageNumber, isDisabled = false, isActive = false, isEllipsis = false) => {
                 const button = document.createElement('button'); button.className = 'pagination-button'; if (isDisabled) button.classList.add('disabled'); if (isActive) button.classList.add('active'); button.innerHTML = content; button.disabled = isDisabled || isEllipsis; if (isEllipsis) button.style.cursor = 'default';
                 if (!isDisabled && !isEllipsis && pageNumber !== null) { button.addEventListener('click', () => { currentPage = pageNumber; renderItems(); document.getElementById('items-grid')?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }); }
                 return button;
             };
             paginationContainer.appendChild(createButton('<i class="fas fa-chevron-left"></i>', currentPage - 1, currentPage === 1));
             const maxVisiblePages = 5; const sidePages = 1; const pagesAroundCurrent = maxVisiblePages - (2 * sidePages) - 2;
             if (totalPages <= maxVisiblePages) { for (let i = 1; i <= totalPages; i++) { paginationContainer.appendChild(createButton(i.toString(), i, false, i === currentPage)); } }
             else { for (let i = 1; i <= sidePages; i++) { paginationContainer.appendChild(createButton(i.toString(), i, false, i === currentPage)); } if (currentPage > sidePages + Math.ceil(pagesAroundCurrent / 2) + 1) { paginationContainer.appendChild(createButton('...', null, true, false, true)); } let start = Math.max(sidePages + 1, currentPage - Math.floor(pagesAroundCurrent / 2)); let end = Math.min(totalPages - sidePages, currentPage + Math.floor(pagesAroundCurrent / 2)); if (start <= sidePages) { start = sidePages + 1; } if (end >= totalPages - sidePages +1) { end = totalPages - sidePages; } for (let i = start; i <= end; i++) { if (i > sidePages && i < totalPages - sidePages + 1) { paginationContainer.appendChild(createButton(i.toString(), i, false, i === currentPage)); } } if (currentPage < totalPages - sidePages - Math.floor(pagesAroundCurrent / 2)) { paginationContainer.appendChild(createButton('...', null, true, false, true)); } for (let i = totalPages - sidePages + 1; i <= totalPages; i++) { if (i > end || i <= sidePages) { paginationContainer.appendChild(createButton(i.toString(), i, false, i === currentPage)); } } }
             paginationContainer.appendChild(createButton('<i class="fas fa-chevron-right"></i>', currentPage + 1, currentPage === totalPages));
         }
    
        async function loadItems() {
            console.log("loadItems called.");
            const itemsGrid = document.getElementById('items-grid');
            const loading = document.getElementById('loading');
            if (!db) { console.error("loadItems: Firestore DB not initialized."); if (loading) loading.innerHTML = '<p style="color: red;">Erro: Base de dados não inicializada.</p>'; return; }
            if (!itemsGrid) { console.error("loadItems: Could not find 'items-grid' element."); if (loading) loading.innerHTML = '<p style="color: red;">Erro: Elemento da lista não encontrado.</p>'; return; }
    
            if (loading) { itemsGrid.innerHTML = ''; loading.style.display = 'block'; }
    
            try {
                const empireItensRef = collection(db, 'empireitens');
                const snapshot = await getDocs(empireItensRef);
                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allItems.sort((a, b) => { const typeA = a.tipo || ''; const typeB = b.tipo || ''; const nameA = a.nome || ''; const nameB = b.nome || ''; if (typeA < typeB) return -1; if (typeA > typeB) return 1; if (nameA < nameB) return -1; if (nameA > nameB) return 1; return 0; });
                addFilters(allItems);
                currentPage = 1;
                renderItems();
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                if (loading) { loading.innerHTML = `<p style="color: red;">Erro ao carregar itens.</p><p><small>${error.message}</small></p><button onclick="location.reload()">Tentar Novamente</button>`; loading.style.display = 'block'; }
            }
        }
    
        async function saveChanges() {
            const saveButton = document.getElementById('saveChanges'); if (!saveButton || !db) return;
            if (changedItems.size === 0) { alert('Nenhuma alteração de disponibilidade (no mercado) para salvar.'); return; }
            saveButton.textContent = 'Salvando...'; saveButton.disabled = true;
            try {
                const batch = writeBatch(db); let count = 0;
                changedItems.forEach((noMercado, itemId) => { const itemRef = doc(db, 'empireitens', itemId); batch.update(itemRef, { noMercado: noMercado }); count++; });
                await batch.commit();
                changedItems.forEach((noMercado, itemId) => { const index = allItems.findIndex(item => item.id === itemId); if (index !== -1) { allItems[index].noMercado = noMercado; } });
                changedItems.clear();
                alert(`${count} alteraç${count > 1 ? 'ões' : 'ão'} de disponibilidade salva${count > 1 ? 's' : ''} com sucesso!`);
            } catch (error) {
                console.error('Erro ao salvar alterações:', error);
                alert(`Erro ao salvar alterações: ${error.message}. Por favor, tente novamente.`);
            } finally { saveButton.textContent = 'Salvar Alterações'; saveButton.disabled = false; }
        }
    
        function openDiaMercadoPopup() {
            const popup = document.getElementById('diaMercadoPopup'); if (!popup) return;
            selectedItems.clear(); selectedDay = null; selectedFrequency = null; specificDateValue = null;
            const dateInput = popup.querySelector('#specificDateInput'); if (dateInput) dateInput.value = '';
            const searchInput = popup.querySelector('#popupSearchInput'); if (searchInput) searchInput.value = '';
            popup.querySelectorAll('.popup-option').forEach(option => { option.classList.remove('active'); });
            const todosOption = popup.querySelector('.popup-option[data-selection="todos"]'); if (todosOption) todosOption.classList.add('active');
            const itemsSelectionContainer = popup.querySelector('#itemsSelectionContainer'); if (itemsSelectionContainer) itemsSelectionContainer.style.display = 'none';
            populatePopupItems(); popup.classList.add('active'); popup.querySelector('.popup-title')?.focus();
        }
    
        function closeDiaMercadoPopup() {
            const popup = document.getElementById('diaMercadoPopup'); if (popup) popup.classList.remove('active');
        }
    
        function populatePopupItems(searchTerm = '') {
            const container = document.getElementById('popupItemsContainer'); const searchInput = document.getElementById('popupSearchInput'); if (!container || !searchInput) return;
            container.innerHTML = ''; const term = searchTerm.toLowerCase().trim();
            let itemsToShow = allItems.filter(item => term === '' || (item.nome || '').toLowerCase().includes(term) || (item.tipo || '').toLowerCase().includes(term));
            itemsToShow.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
            if (itemsToShow.length === 0) { container.innerHTML = `<div class="no-items" style="font-size: 13px;">Nenhum item encontrado${term ? ` para "${term}"` : ''}.</div>`; }
            else { itemsToShow.forEach(item => { if (!item.id) return; const itemElement = document.createElement('div'); itemElement.className = 'popup-item'; itemElement.tabIndex = 0; const isSelected = selectedItems.has(item.id); itemElement.innerHTML = `<input type="checkbox" class="popup-item-checkbox" data-item-id="${item.id}" ${isSelected ? 'checked' : ''} aria-labelledby="itemName-${item.id}"><span class="popup-item-name" id="itemName-${item.id}">${item.nome || 'Sem nome'} (${item.tipo || 'Sem tipo'})</span>`; const checkbox = itemElement.querySelector('input[type="checkbox"]'); checkbox.addEventListener('change', (e) => { const itemId = e.target.dataset.itemId; if (e.target.checked) { selectedItems.add(itemId); } else { selectedItems.delete(itemId); } }); itemElement.addEventListener('click', (e) => { if (e.target !== checkbox) { checkbox.checked = !checkbox.checked; checkbox.dispatchEvent(new Event('change')); } }); itemElement.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); checkbox.checked = !checkbox.checked; checkbox.dispatchEvent(new Event('change')); } }); container.appendChild(itemElement); }); }
        }
    
        async function applyMarketDayChanges() {
            const applyButton = document.getElementById('popupApplyButton'); if (!applyButton || !db) return;
            applyButton.textContent = 'Aplicando...'; applyButton.disabled = true;
            try {
                let dataMercadoValue = null;
                if (specificDateValue) { dataMercadoValue = specificDateValue; }
                else if (selectedFrequency && selectedDay) { dataMercadoValue = `${selectedFrequency}${selectedDay}`; }
                else if (selectedDay) { dataMercadoValue = selectedDay; }
                else if (selectedFrequency && !selectedDay) { alert("Erro: Frequência selecionada ("+selectedFrequency+" dias), mas nenhum dia da semana foi escolhido. Por favor, selecione um dia ou desmarque a frequência."); throw new Error("Invalid state: Frequency without day."); }
                else { dataMercadoValue = deleteField(); }
                const useAllItems = document.querySelector('#diaMercadoPopup .popup-option[data-selection="todos"].active');
                const itemsToUpdateIds = useAllItems ? allItems.map(item => item.id) : Array.from(selectedItems);
                if (!useAllItems && itemsToUpdateIds.length === 0) { alert('Selecione "Todos os Itens" ou marque itens na lista personalizada.'); throw new Error("No items selected for update."); }
                const batch = writeBatch(db); let updateCount = 0;
                itemsToUpdateIds.forEach(itemId => { if (itemId) { const itemRef = doc(db, 'empireitens', itemId); batch.update(itemRef, { dataMercado: dataMercadoValue }); updateCount++; } });
                if (updateCount > 0) {
                    await batch.commit();
                    const localUpdateValue = (dataMercadoValue === deleteField()) ? undefined : dataMercadoValue;
                    allItems = allItems.map(item => { if (itemsToUpdateIds.includes(item.id)) { return { ...item, dataMercado: localUpdateValue }; } return item; });
                    renderItems();
                    alert(`Dia de mercado atualizado para ${updateCount} item(s)!`);
                    closeDiaMercadoPopup();
                } else { alert("Nenhum item válido encontrado para atualizar."); closeDiaMercadoPopup(); }
            } catch (error) {
                console.error('Erro ao aplicar Dia de Mercado:', error);
                if (error.message !== "Invalid state: Frequency without day." && error.message !== "No items selected for update.") { alert(`Erro ao aplicar alterações: ${error.message}. Por favor, tente novamente.`); }
            } finally { applyButton.textContent = 'Aplicar'; applyButton.disabled = false; }
        }
    
        function setupEventListeners() {
            console.log("setupEventListeners called.");
            document.getElementById('saveChanges')?.addEventListener('click', saveChanges);
            document.getElementById('searchInput')?.addEventListener('input', () => { currentPage = 1; renderItems(); });
            document.getElementById('diaMercadoBtn')?.addEventListener('click', openDiaMercadoPopup);
            const filterContainer = document.getElementById('filterContainer');
            if (filterContainer) { filterContainer.addEventListener('click', (event) => { if (event.target.matches('.filter-button')) { handleFilterClick(event); } }); }
            const popup = document.getElementById('diaMercadoPopup');
            if (popup) {
                popup.querySelector('#popupClose')?.addEventListener('click', closeDiaMercadoPopup);
                popup.querySelector('#popupCancelButton')?.addEventListener('click', closeDiaMercadoPopup);
                popup.querySelector('#popupApplyButton')?.addEventListener('click', applyMarketDayChanges);
                popup.querySelector('#popupSearchInput')?.addEventListener('input', (e) => { populatePopupItems(e.target.value); });
                popup.querySelector('#specificDateInput')?.addEventListener('change', (e) => {
                    const dateValue = e.target.value;
                    if (dateValue) { popup.querySelectorAll('.popup-option.day-option, .popup-option.frequency-option').forEach(opt => opt.classList.remove('active')); selectedDay = null; selectedFrequency = null; specificDateValue = dateValue; }
                    else { specificDateValue = null; }
                });
                const popupContent = popup.querySelector('.popup-content');
                if (popupContent) {
                    popupContent.addEventListener('click', (event) => {
                        if (event.target.matches('.popup-option')) {
                            const optionButton = event.target;
                            if (optionButton.matches('[data-selection]')) {
                                popup.querySelectorAll('.popup-option[data-selection]').forEach(opt => opt.classList.remove('active'));
                                optionButton.classList.add('active');
                                const showPersonalizado = optionButton.dataset.selection === 'personalizado';
                                const container = document.getElementById('itemsSelectionContainer');
                                if (container) { container.style.display = showPersonalizado ? 'block' : 'none'; if (showPersonalizado) { document.getElementById('popupSearchInput')?.focus(); } }
                            } else if (optionButton.matches('.day-option[data-day]')) {
                                const dayValue = optionButton.dataset.day; const wasActive = optionButton.classList.contains('active'); specificDateValue = null; const dateInput = popup.querySelector('#specificDateInput'); if(dateInput) dateInput.value = '';
                                popup.querySelectorAll('.popup-option.day-option').forEach(opt => { if (opt !== optionButton) opt.classList.remove('active'); });
                                if (wasActive) { optionButton.classList.remove('active'); selectedDay = null; } else { optionButton.classList.add('active'); selectedDay = dayValue; }
                            } else if (optionButton.matches('.frequency-option[data-frequency]')) {
                                const frequencyValue = optionButton.dataset.frequency || null; const wasActive = optionButton.classList.contains('active'); specificDateValue = null; const dateInput = popup.querySelector('#specificDateInput'); if(dateInput) dateInput.value = '';
                                popup.querySelectorAll('.popup-option.frequency-option').forEach(opt => { if (opt !== optionButton) opt.classList.remove('active'); });
                                if (wasActive) { optionButton.classList.remove('active'); selectedFrequency = null; } else { optionButton.classList.add('active'); selectedFrequency = frequencyValue; }
                            }
                        }
                    });
                }
            }
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired.");
            if (db) { loadItems(); }
            else { console.error("DB not initialized. Cannot load items."); }
            setupEventListeners();
        });
    </script>
</body>
</html>
