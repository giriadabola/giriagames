<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G Empire - Gerir Banca</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script type="module" src="js/auth-guard.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; display: none; flex-direction: column; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .menu-item i { font-size: 16px; }
        .content { padding: 80px 20px 20px; max-width: 600px; width: 100%; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 24px; font-size: 28px; text-align: center; }
        #status-message { text-align: center; font-size: 18px; color: #666; padding: 40px; }
        .form-container { display: none; background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-group input, #user-select, #query-user-select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-group input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .form-button { width: 100%; padding: 12px; border: none; background-color: #2176ff; color: white; font-size: 16px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
        .form-button:hover { background-color: #1a5fcc; }
        .feedback-message { text-align: center; margin-top: 16px; font-weight: bold; }
        .feedback-message.success { color: green; }
        .feedback-message.error { color: red; }
        .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 2000; justify-content: center; align-items: center; }
        .popup-content { background: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .popup-content h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .popup-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .popup-button { flex: 1; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .popup-button.confirm { background-color: #28a745; color: white; }
        .popup-button.confirm:hover { background-color: #218838; }
        .popup-button.cancel { background-color: #dc3545; color: white; }
        .popup-button.cancel:hover { background-color: #c82333; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .results-table th, .results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .results-table th { background-color: #f2f2f2; font-weight: bold; }
        .results-table tr:nth-child(even) { background-color: #f9f9f9; }
        .valor-positivo { color: #28a745; font-weight: bold; }
        .valor-negativo { color: #dc3545; font-weight: bold; }
        .fab-button { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background-color: #ffc107; color: white; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 1500; }
        .fab-button:hover { background-color: #e0a800; }
        .simulation-box { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin-bottom: 20px; margin-top: 10px; }
        .simulation-box h3 { font-size: 16px; margin-bottom: 10px; color: #444; border-bottom: 2px solid #2176ff; display: inline-block; }
        .sim-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; }
        .sim-result { font-weight: bold; font-size: 18px; text-align: center; padding: 10px; border-radius: 4px; background: #fff; border: 1px solid #ddd; }
        .sim-advice { font-size: 13px; color: #666; margin-top: 8px; font-style: italic; background: #fff3cd; padding: 8px; border-radius: 4px; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="1x.html" class="menu-item"><i class="fas fa-home"></i>Home</a>
        <a href="fusiveis.html" class="menu-item"><i class="fas fa-bolt"></i>Fusíveis</a>
        <a href="arbitro.html" class="menu-item"><i class="fas fa-gavel"></i>Árbitro</a>
        <a href="criar-manual.html" class="menu-item"><i class="fas fa-book"></i>Manual</a>
        <a href="criar-banca.html" class="menu-item active"><i class="fas fa-university"></i>Banca</a>
    </nav>
    <main class="content">
        <h1><i class="fas fa-university"></i> Gerir Valor da Banca</h1>
        <p id="status-message">A carregar dados...</p>
        <div class="form-container" id="banca-form-container">
            <form id="banca-form">
                <div class="form-group">
                    <label for="base-value-input">Valor Base (Ajuste Manual)</label>
                    <input type="number" step="any" id="base-value-input" value="0">
                </div>
                <div class="form-group">
                    <label for="total-input">Total Calculado</label>
                    <input type="text" id="total-input" readonly>
                </div>
                <button type="submit" class="form-button">Guardar Alterações</button>
            </form>
            <p id="feedback-message" class="feedback-message"></p>
            <button id="open-loan-popup-btn" class="form-button" style="margin-top: 20px; background-color: #28a745;"><i class="fas fa-hand-holding-usd"></i> Conceder Empréstimo</button>
            <button id="open-query-popup-btn" class="form-button" style="margin-top: 10px; background-color: #007bff;"><i class="fas fa-search"></i> Consultar Movimentos</button>
        </div>
    </main>
    
    <button id="open-taxa-popup-btn" class="fab-button" title="Gerir Taxa WhoWins"><i class="fas fa-cog"></i></button>

    <!-- POPUP 1: CONSULTA -->
    <div class="popup-overlay" id="query-popup">
        <div class="popup-content">
            <h2>Consultar Movimentos</h2>
            <div class="form-group">
                <label for="query-user-select">Selecione o Utilizador</label>
                <select id="query-user-select"><option value="">A carregar utilizadores...</option></select>
            </div>
            <div id="query-result-container" style="min-height: 50px; max-height: 300px; overflow-y: auto;"></div>
            <div class="popup-buttons">
                <button type="button" class="popup-button cancel" id="close-query-btn">Fechar</button>
            </div>
        </div>
    </div>

    <!-- POPUP 2: EMPRÉSTIMO -->
    <div class="popup-overlay" id="loan-popup">
        <div class="popup-content">
            <h2>Conceder Empréstimo</h2>
            <form id="loan-form">
                <div class="form-group">
                    <label for="user-select">Selecionar Utilizador</label>
                    <select id="user-select" required></select>
                </div>
                <div class="form-group">
                    <label for="loan-amount">Valor do Empréstimo</label>
                    <input type="number" id="loan-amount" placeholder="Ex: 500" required min="1">
                </div>
                <div class="form-group">
                    <label for="loan-description">Descrição (Opcional)</label>
                    <input type="text" id="loan-description" placeholder="Ex: Adiantamento prémio">
                </div>
                <div class="form-group">
                    <label for="loan-interest">Juros (Valor Fixo em GCoins)</label>
                    <input type="number" id="loan-interest" placeholder="Ex: 50" value="0" required min="0" step="1">
                </div>
                <div class="popup-buttons">
                    <button type="submit" class="popup-button confirm">Confirmar</button>
                    <button type="button" class="popup-button cancel" id="cancel-loan-btn">Cancelar</button>
                </div>
            </form>
            <p id="loan-feedback" class="feedback-message"></p>
        </div>
    </div>
    
    <!-- POPUP 3: TAXAS (Lógica Bruta) -->
    <div class="popup-overlay" id="taxa-popup">
        <div class="popup-content">
            <h2>Gerir Taxa e Comissões</h2>
            <div class="simulation-box">
                <h3><i class="fas fa-calculator"></i> Configurador</h3>
                <form id="taxa-form">
                    <div class="form-group">
                        <label for="taxa-whowins-input">Custo (Mini-gCoins necessários para 1 GCoin)</label>
                        <input type="number" step="any" id="taxa-whowins-input" placeholder="Ex: 2" required>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="taxa-banca-input">Comissão Banca (GCoins retidos por cada 1 GCoin gerado)</label>
                        <input type="number" step="0.01" min="0" max="1" id="taxa-banca-input" placeholder="Ex: 0.5" value="0" required>
                        <small style="color: #666;">Ex: 0.5 = De cada 1 GCoin, 0.5 vai para banca (50%).</small>
                    </div>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ddd;">
                    <h3>Simulação de Resultado</h3>
                    <div class="sim-row">
                        <div style="flex: 1;"><label style="font-size: 12px;">Input User (Mini):</label><input type="number" id="sim-amount-input" value="100"></div>
                        <div style="display: flex; align-items: center; padding-top: 20px;"><i class="fas fa-arrow-right" style="color: #666;"></i></div>
                        <div style="flex: 1;"><label style="font-size: 12px;">Total Gerado:</label><div id="sim-total-generated" class="sim-result" style="font-size: 14px;">0</div></div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1; background: #e8f5e9; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb;">
                            <label style="font-size: 12px; color: #155724; font-weight: bold;">User Recebe:</label><div id="sim-user-gets" style="font-size: 18px; font-weight: bold; color: #155724;">0</div>
                        </div>
                        <div style="flex: 1; background: #f8d7da; padding: 10px; border-radius: 5px; border: 1px solid #f5c6cb;">
                            <label style="font-size: 12px; color: #721c24; font-weight: bold;">Banca Retém:</label><div id="sim-bank-gets" style="font-size: 18px; font-weight: bold; color: #721c24;">0</div>
                        </div>
                    </div>
                    <div id="sim-advice-text" class="sim-advice" style="display: none; margin-top: 15px;"></div>
                    <div class="popup-buttons" style="margin-top: 20px;">
                        <button type="submit" class="popup-button confirm">Guardar Configurações</button>
                        <button type="button" class="popup-button cancel" id="cancel-taxa-btn">Cancelar</button>
                    </div>
                </form>
            </div>
            <p id="taxa-feedback" class="feedback-message"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, addDoc, Timestamp, writeBatch, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = { apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0", authDomain: "g-games-8a8fc.firebaseapp.com", projectId: "g-games-8a8fc", storageBucket: "g-games-8a8fc.appspot.com", messagingSenderId: "689897349449", appId: "1:689897349449:web:536599794579901beb7a98", measurementId: "G-GTTPJ6G5MD" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        // Elements
        const statusMessage = document.getElementById('status-message');
        const formContainer = document.getElementById('banca-form-container');
        const bancaForm = document.getElementById('banca-form');
        const baseValueInput = document.getElementById('base-value-input');
        const totalInput = document.getElementById('total-input');
        const feedbackMessage = document.getElementById('feedback-message');
        const openLoanPopupBtn = document.getElementById('open-loan-popup-btn');
        const loanPopup = document.getElementById('loan-popup');
        const loanForm = document.getElementById('loan-form');
        const userSelect = document.getElementById('user-select');
        const loanAmountInput = document.getElementById('loan-amount');
        const loanDescriptionInput = document.getElementById('loan-description');
        const cancelLoanBtn = document.getElementById('cancel-loan-btn');
        const loanFeedback = document.getElementById('loan-feedback');
        const loanInterestInput = document.getElementById('loan-interest');
        const openQueryPopupBtn = document.getElementById('open-query-popup-btn');
        const queryPopup = document.getElementById('query-popup');
        const queryUserSelect = document.getElementById('query-user-select');
        const queryResultContainer = document.getElementById('query-result-container');
        const closeQueryBtn = document.getElementById('close-query-btn');
        const openTaxaPopupBtn = document.getElementById('open-taxa-popup-btn');
        const taxaPopup = document.getElementById('taxa-popup');
        const taxaForm = document.getElementById('taxa-form');
        const taxaInput = document.getElementById('taxa-whowins-input');
        const cancelTaxaBtn = document.getElementById('cancel-taxa-btn');
        const taxaFeedback = document.getElementById('taxa-feedback');
        const taxaBancaInput = document.getElementById('taxa-banca-input');
        const simUserGets = document.getElementById('sim-user-gets');
        const simBankGets = document.getElementById('sim-bank-gets');
        const simTotalGenerated = document.getElementById('sim-total-generated');
        const simAmountInput = document.getElementById('sim-amount-input');
        const simAdviceText = document.getElementById('sim-advice-text');

        let movimentosSum = 0; let currentSeason = null;

        function updateSimulation() {
            const rate = parseFloat(taxaInput.value);
            const fee = parseFloat(taxaBancaInput.value) || 0; // VALOR BRUTO (Ex: 0.5)
            const amount = parseFloat(simAmountInput.value);

            if (isNaN(rate) || isNaN(amount) || rate <= 0) {
                simTotalGenerated.textContent = "-"; simUserGets.textContent = "0"; simBankGets.textContent = "0"; simAdviceText.style.display = 'none'; return;
            }

            const rawGCoins = amount / rate;
            // LÓGICA NOVA: VALOR BRUTO
            const bankCut = rawGCoins * fee; // Não divide por 100
            const userCut = rawGCoins - bankCut;

            simTotalGenerated.textContent = Number(rawGCoins.toFixed(4));
            simUserGets.textContent = Number(userCut.toFixed(4));
            simBankGets.textContent = Number(bankCut.toFixed(4));

            const isUserInt = Number.isInteger(Number(userCut.toFixed(6)));
            const isBankInt = Number.isInteger(Number(bankCut.toFixed(6)));

            simAdviceText.style.display = 'block';
            if (isUserInt && isBankInt) {
                simAdviceText.innerHTML = `<i class="fas fa-check-circle"></i> <strong>Válido!</strong><br>User recebe ${userCut} e Banca recebe ${bankCut} (inteiros).`;
                simAdviceText.className = 'sim-advice'; simAdviceText.style.backgroundColor = "#d4edda"; simAdviceText.style.color = "#155724"; simAdviceText.style.borderLeft = "4px solid #28a745";
            } else {
                simAdviceText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Gera Decimais!</strong><br>Esta combinação gera números quebrados. Ajuste os valores.`;
                simAdviceText.className = 'sim-advice'; simAdviceText.style.backgroundColor = "#f8d7da"; simAdviceText.style.color = "#721c24"; simAdviceText.style.borderLeft = "4px solid #dc3545";
            }
        }

        async function fetchCurrentSeason() {
            const docSnap = await getDoc(doc(db, "paineis", "configuracoes_gerais"));
            if (docSnap.exists() && docSnap.data().temporadaAtual) return docSnap.data().temporadaAtual.replace(/\//g, '');
            throw new Error("Sem temporada.");
        }

        async function calculateMovimentosSum(season) {
            const q = query(collection(db, "movimentos"), where("tipo", "==", "Banca"), where("temporada", "==", season));
            const querySnapshot = await getDocs(q);
            let sum = 0; querySnapshot.forEach((doc) => { const p = parseFloat(doc.data().preco); if (!isNaN(p)) sum += p; });
            return sum;
        }

        function updateCalculatedTotal() { totalInput.value = ((parseFloat(baseValueInput.value) || 0) + movimentosSum).toFixed(2); }

        async function handleFormSubmit(e) {
            e.preventDefault(); feedbackMessage.textContent = 'A guardar...';
            try {
                await addDoc(collection(db, 'movimentos'), { preco: parseFloat(baseValueInput.value) || 0, movimentoData: Timestamp.now(), tipo: "Banca", temporada: currentSeason, descricao: "Ajuste manual" });
                movimentosSum = await calculateMovimentosSum(currentSeason);
                await setDoc(doc(db, "paineis", "Banca"), { valor: movimentosSum }, { merge: true });
                baseValueInput.value = 0; updateCalculatedTotal(); feedbackMessage.textContent = 'Sucesso!'; feedbackMessage.className = 'feedback-message success';
            } catch (error) { console.error(error); feedbackMessage.textContent = 'Erro.'; feedbackMessage.className = 'feedback-message error'; }
        }

        async function populateUsersDropdowns() {
            try {
                const q = query(collection(db, 'users'), where("aceite", "==", "Yes"));
                const querySnapshot = await getDocs(q);
                const users = [];
                querySnapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));
                users.sort((a, b) => (a.nometabela || a.id).localeCompare(b.nometabela || b.id));
                const opt = '<option value="">-- Selecione --</option>';
                if (userSelect) { userSelect.innerHTML = opt; users.forEach(u => { const o = document.createElement('option'); o.value = u.id; o.textContent = u.nometabela || u.id; userSelect.appendChild(o); }); }
                if (queryUserSelect) { queryUserSelect.innerHTML = opt; users.forEach(u => { const o = document.createElement('option'); o.value = u.id; o.textContent = u.nometabela || u.id; queryUserSelect.appendChild(o); }); }
            } catch (error) { console.error(error); }
        }

        async function handleLoanSubmit(e) {
            e.preventDefault(); const uid = userSelect.value; const amt = parseFloat(loanAmountInput.value);
            if (!uid || isNaN(amt) || amt <= 0) return;
            loanFeedback.textContent = 'Processando...';
            try {
                const batch = writeBatch(db);
                batch.set(doc(collection(db, 'movimentos')), { tipo: "Banca", preco: -amt, movimentoData: Timestamp.now(), temporada: currentSeason, descricao: `Empréstimo`, para_userId: uid });
                batch.set(doc(collection(db, 'movimentos')), { userId: uid, valorreal: amt, tipo: "Empréstimo", movimentoData: Timestamp.now(), temporada: currentSeason, de: "Banca", descricao: loanDescriptionInput.value || "Empréstimo", valorJuros: parseFloat(loanInterestInput.value) || 0, valorTotalAPagar: amt + (parseFloat(loanInterestInput.value) || 0), estado: "Por Pagar" });
                const uRef = doc(db, 'users', uid); const uSnap = await getDoc(uRef);
                const newBal = (uSnap.data()[`${currentSeason}GCoins`] || 0) + amt;
                batch.update(uRef, { [`${currentSeason}GCoins`]: newBal });
                batch.set(doc(db, "paineis", "Banca"), { valor: movimentosSum - amt }, { merge: true });
                await batch.commit();
                movimentosSum -= amt; updateCalculatedTotal(); loanPopup.style.display = 'none';
            } catch (e) { console.error(e); loanFeedback.textContent = 'Erro.'; }
        }

        async function handleTaxaSubmit(e) {
            e.preventDefault(); const r = parseFloat(taxaInput.value); const f = parseFloat(taxaBancaInput.value);
            if (isNaN(r) || r <= 0 || isNaN(f) || f < 0) return;
            taxaFeedback.textContent = 'A guardar...';
            try {
                await setDoc(doc(db, "paineis", "Banca"), { taxaWhoWins: r, taxaBanca: f }, { merge: true });
                taxaFeedback.textContent = 'Guardado!'; setTimeout(() => taxaPopup.style.display = 'none', 1000);
            } catch (e) { taxaFeedback.textContent = 'Erro.'; }
        }

        async function initializePage() {
            try {
                currentSeason = await fetchCurrentSeason(); movimentosSum = await calculateMovimentosSum(currentSeason);
                updateCalculatedTotal(); await populateUsersDropdowns();
                statusMessage.style.display = 'none'; formContainer.style.display = 'block';

                openQueryPopupBtn.addEventListener('click', () => { queryPopup.style.display = 'flex'; });
                closeQueryBtn.addEventListener('click', () => queryPopup.style.display = 'none');
                queryUserSelect.addEventListener('change', async (e) => {
                    const uid = e.target.value; if(!uid) return;
                    queryResultContainer.innerHTML = 'Carregando...';
                    const qs = await getDocs(query(collection(db, "movimentos"), where("userId", "==", uid), where("temporada", "==", currentSeason), where("valorreal", "!=", null), orderBy("movimentoData", "desc")));
                    let h = '<table class="results-table"><tr><th>Data</th><th>Tipo</th><th>Valor</th></tr>';
                    qs.forEach(d => { h += `<tr><td>${d.data().movimentoData.toDate().toLocaleDateString()}</td><td>${d.data().tipo}</td><td class="${d.data().valorreal>=0?'valor-positivo':'valor-negativo'}">${d.data().valorreal}</td></tr>`; });
                    queryResultContainer.innerHTML = h + '</table>';
                });

                baseValueInput.addEventListener('input', updateCalculatedTotal); bancaForm.addEventListener('submit', handleFormSubmit);
                openLoanPopupBtn.addEventListener('click', () => { loanPopup.style.display = 'flex'; });
                cancelLoanBtn.addEventListener('click', () => loanPopup.style.display = 'none');
                loanForm.addEventListener('submit', handleLoanSubmit);
                
                openTaxaPopupBtn.addEventListener('click', async () => { 
                    taxaPopup.style.display = 'flex'; 
                    const ds = await getDoc(doc(db, "paineis", "Banca"));
                    if(ds.exists()) { taxaInput.value = ds.data().taxaWhoWins || 0; taxaBancaInput.value = ds.data().taxaBanca || 0; updateSimulation(); }
                });
                cancelTaxaBtn.addEventListener('click', () => taxaPopup.style.display = 'none');
                taxaForm.addEventListener('submit', handleTaxaSubmit);
                taxaInput.addEventListener('input', updateSimulation); simAmountInput.addEventListener('input', updateSimulation); taxaBancaInput.addEventListener('input', updateSimulation);
            } catch (e) { console.error(e); statusMessage.textContent = e.message; }
        }

        onAuthStateChanged(auth, async (u) => { if(u && (await getDoc(doc(db,"users",u.uid))).data().estatuto==='ruler') { document.body.style.display='flex'; initializePage(); } else window.location.href='/'; });
    </script>
</body>
</html>
