<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G Empire - Gerir Banca</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script type="module" src="js/auth-guard.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; display: none; flex-direction: column; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .menu-item i { font-size: 16px; }
        .content { padding: 80px 20px 20px; max-width: 600px; width: 100%; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 24px; font-size: 28px; text-align: center; }
        #status-message { text-align: center; font-size: 18px; color: #666; padding: 40px; }
        .form-container { display: none; background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-group input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .form-button { width: 100%; padding: 12px; border: none; background-color: #2176ff; color: white; font-size: 16px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
        .form-button:hover { background-color: #1a5fcc; }
        .feedback-message { text-align: center; margin-top: 16px; font-weight: bold; }
        .feedback-message.success { color: green; }
        .feedback-message.error { color: red; }
    </style>
</head>
<body>
    <nav class="top-menu">
        <a href="1x.html" class="menu-item"><i class="fas fa-home"></i>Home</a>
        <a href="fusiveis.html" class="menu-item"><i class="fas fa-bolt"></i>Fusíveis</a>
        <a href="arbitro.html" class="menu-item"><i class="fas fa-gavel"></i>Árbitro</a>
        <a href="criar-manual.html" class="menu-item"><i class="fas fa-book"></i>Manual</a>
        <a href="criar-banca.html" class="menu-item active"><i class="fas fa-university"></i>Banca</a>
    </nav>
    <main class="content">
        <h1><i class="fas fa-university"></i> Gerir Valor da Banca</h1>
        <p id="status-message">A carregar dados...</p>
        
        <div class="form-container" id="banca-form-container">
            <form id="banca-form">
                <div class="form-group">
                    <label for="base-value-input">Valor Base (Ajuste Manual)</label>
                    <input type="number" step="any" id="base-value-input" value="0">
                </div>
                <div class="form-group">
                    <label for="total-input">Total Calculado</label>
                    <input type="text" id="total-input" readonly>
                </div>
                <button type="submit" class="form-button">Guardar Alterações</button>
            </form>
            <p id="feedback-message" class="feedback-message"></p>
        </div>
    </main>

        <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, addDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.appspot.com",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Elementos do DOM ---
        const statusMessage = document.getElementById('status-message');
        const formContainer = document.getElementById('banca-form-container');
        const bancaForm = document.getElementById('banca-form');
        const baseValueInput = document.getElementById('base-value-input');
        const totalInput = document.getElementById('total-input');
        const feedbackMessage = document.getElementById('feedback-message');
        
        let movimentosSum = 0;
        let currentSeason = null;

        // --- Funções ---

        // 1. Busca a temporada atual
        async function fetchCurrentSeason() {
            const configRef = doc(db, "paineis", "configuracoes_gerais");
            const docSnap = await getDoc(configRef);
            if (docSnap.exists() && docSnap.data().temporadaAtual) {
                return docSnap.data().temporadaAtual;
            }
            throw new Error("Não foi possível encontrar a temporada atual em 'paineis/configuracoes_gerais'.");
        }

        // 2. Calcula a soma dos movimentos da banca para a temporada
        async function calculateMovimentosSum(season) {
            const movimentosRef = collection(db, "movimentos");
            const q = query(movimentosRef, 
                where("tipo", "==", "Banca"),
                where("temporada", "==", season)
            );
            
            const querySnapshot = await getDocs(q);
            let sum = 0;
            querySnapshot.forEach((doc) => {
                const preco = parseFloat(doc.data().preco);
                if (!isNaN(preco)) {
                    sum += preco;
                }
            });
            return sum;
        }
        
        // 3. Atualiza o campo "Total" na interface
        function updateCalculatedTotal() {
            const baseValue = parseFloat(baseValueInput.value) || 0;
            const total = baseValue + movimentosSum;
            totalInput.value = total.toFixed(2);
        }

        // 4. Carrega os dados iniciais e configura a página
        async function initializePage() {
            try {
                currentSeason = await fetchCurrentSeason();
                movimentosSum = await calculateMovimentosSum(currentSeason);
                
                // O campo "Valor Base" começa sempre em 0, não é lido da base de dados.
                updateCalculatedTotal(); 
                
                statusMessage.style.display = 'none';
                formContainer.style.display = 'block';
                
                baseValueInput.addEventListener('input', updateCalculatedTotal);
                bancaForm.addEventListener('submit', handleFormSubmit);

            } catch (error) {
                console.error("Erro na inicialização:", error);
                statusMessage.textContent = `Erro: ${error.message}`;
            }
        }

        // 5. Lida com a submissão do formulário
        async function handleFormSubmit(event) {
            event.preventDefault();
            feedbackMessage.textContent = 'A guardar...';
            feedbackMessage.className = 'feedback-message';

            const valorAdicionar = parseFloat(baseValueInput.value) || 0;
            const newTotalValue = valorAdicionar + movimentosSum;

            try {
                // Parte 1: Criar novo documento em "movimentos" com o valor do input
                const movimentoData = {
                    userId: null,
                    preco: valorAdicionar,
                    movimentoData: Timestamp.now(),
                    tipo: "Banca",
                    temporada: currentSeason
                };

                const movimentosRef = collection(db, 'movimentos');
                await addDoc(movimentosRef, movimentoData);

                // Parte 2: Atualizar apenas o total no painel "Banca"
                const bancaRef = doc(db, "paineis", "Banca");
                // Apenas o campo 'valor' é guardado, NENHUM 'valor_base' é escrito.
                await setDoc(bancaRef, {
                    valor: newTotalValue
                }, { merge: true });

                // Parte 3: Atualizar a interface do utilizador
                movimentosSum += valorAdicionar;
                baseValueInput.value = 0;
                updateCalculatedTotal();

                feedbackMessage.textContent = 'Operação registada com sucesso!';
                feedbackMessage.className = 'feedback-message success';
            } catch (error) {
                console.error("Erro ao guardar dados:", error);
                feedbackMessage.textContent = 'Ocorreu um erro ao guardar.';
                feedbackMessage.className = 'feedback-message error';
            }
        }

        // --- Controlo de Acesso ---
        onAuthStateChanged(auth, async (user) => {
            document.body.style.display = 'flex';
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().estatuto === 'ruler') {
                    await initializePage();
                } else {
                    window.location.replace('/acesso-negado.html');
                }
            } else {
                statusMessage.textContent = 'É necessário fazer login para aceder a esta página.';
            }
        });
    </script>
</body>
</html>
