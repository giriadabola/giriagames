<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Item do Império - GGames</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

    <!-- 1. ADICIONA O GUARDIÃO DE SEGURANÇA. -->
   <script type="module" src="js/auth-guard.js"></script>

    <style>
        /* Basic Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            min-height: 100vh;
            background-color: #f4f7fc;
            font-family: 'Roboto', sans-serif;
            color: #333;
            font-size: 16px;
            padding-top: 70px; /* Space for fixed menu */
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 40px;
        }

        /* Top Menu Styles */
        .top-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 24px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease, background-color 0.3s ease;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item:hover, .menu-item.active {
            color: #2176ff;
            background-color: rgba(33, 118, 255, 0.1);
        }

        .menu-item i {
            font-size: 16px;
        }

        /* --- START: Slot Icon Style (Right Aligned) --- */
        #slot-icon-trigger {
            display: block;      /* Treat as a block element */
            width: fit-content;  /* Size block to the icon width */
            margin-top: 15px;    /* Space above the icon */
            margin-bottom: 15px; /* Space below the icon */
            margin-left: auto;   /* Push the element to the right */
            margin-right: 0;     /* Align flush to the right edge (of the content container) */
            font-size: 28px;     /* Adjust size as needed */
            color: #2176ff;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
        }
        #slot-icon-trigger:hover {
            color: #0056d6;
            transform: scale(1.1); /* Keep hover effect */
        }
        /* --- END: Slot Icon Style (Right Aligned) --- */


        /* Content Area */
        .content {
            max-width: 800px;
            margin: 0 auto; /* Center the content block, remove top margin */
        }

        /* Heading */
        h1 {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 24px;
        }

         /* Item List Styling */
        .item-list {
            margin-bottom: 32px;
        }

        .item-card {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .item-card h3 { color: #333; margin-bottom: 4px; font-size: 17px; }
        .item-card p { color: #666; font-size: 14px; margin: 0; }
        .item-card .item-info { flex-grow: 1; }
        .item-card .item-actions i { color: #2176ff; font-size: 18px; }

        /* Search Bar Styling */
        .search-container { position: relative; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .search-input { width: 100%; padding: 12px 40px 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: #2176ff; box-shadow: 0 0 0 3px rgba(33, 118, 255, 0.1); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none; }

        /* Form Container Styling */
        .form-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px; /* Apply max-width here */
            margin: 20px auto; /* Center form container */
        }

        /* Form Group Styling */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }

        /* Input, Select, Textarea Styling */
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea,
        .choices__inner {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background-color: white;
        }

        /* Choices.js specific adjustments */
         .choices__inner { padding: 7px 7px 4px 10px !important; min-height: 46px !important; }
         .choices.is-focused .choices__inner { border-color: #2176ff !important; box-shadow: 0 0 0 2px rgba(33, 118, 255, 0.2) !important; }
         .choices[data-type*='select-multiple'] .choices__button,
         .choices[data-type*='select-one'] .choices__button { margin: 0; padding-left: 8px; background-image: url('data:image/svg+xml;utf8,<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.99984 1L5.00001 5L1 8.99984M1.00016 1L5.00001 5L9 8.99984" stroke="%23666" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>'); }

        /* Standard select dropdown arrow */
         .form-group select:not([multiple]):not(.choices__input) {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
             background-repeat: no-repeat;
             background-position: right .75rem center;
             background-size: 16px 12px;
             appearance: none;
         }

        /* Focus Styling */
        .form-group input:focus,
        .form-group select:not(.choices__input):focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2176ff;
            box-shadow: 0 0 0 2px rgba(33, 118, 255, 0.2);
        }

        .form-group textarea { resize: vertical; min-height: 80px; }
        .optional-text { font-size: 0.85em; color: #777; margin-left: 5px; }

        /* Button Styling */
        .submit-button, .popup-save-button { /* Shared style */
            background: linear-gradient(135deg, #2176ff 0%, #0056d6 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s ease;
            display: block;
            width: 100%;
            margin-top: 20px;
            font-weight: 600;
            text-align: center; /* Ensure text is centered */
        }
        .submit-button:hover, .popup-save-button:hover {
             background: linear-gradient(135deg, #0056d6 0%, #2176ff 100%);
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(33, 118, 255, 0.4);
        }
        .submit-button:disabled, .popup-save-button:disabled {
             background: #ccc;
             cursor: not-allowed;
             transform: none;
             box-shadow: none;
        }
        /* Back Button */
        .back-button {
             background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 25px;
             font-size: 0.9em; cursor: pointer; transition: background-color 0.3s ease; display: inline-block;
             width: auto; margin-top: 15px; margin-right: 10px; font-weight: 500;
         }
         .back-button:hover { background: #5a6268; }


        /* --- START: Popup Styles --- */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Above everything else */
            padding: 20px; /* Add padding for smaller screens */
            opacity: 0; /* Start invisible for transition */
            transition: opacity 0.3s ease;
        }
        .popup-overlay.visible { /* Class to control visibility */
            display: flex;
            opacity: 1;
        }
        .popup-content {
            background-color: #ffffff;
            padding: 30px 35px; /* More padding */
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 550px; /* Slightly wider */
            position: relative;
            max-height: 90vh; /* Limit height */
            overflow-y: auto; /* Allow scrolling if content overflows */
            transform: scale(0.9); /* Start slightly smaller */
            transition: transform 0.3s ease;
        }
        .popup-overlay.visible .popup-content {
            transform: scale(1); /* Scale to full size */
        }
        .popup-content h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
            font-weight: 600;
        }
        .popup-close-button {
            position: absolute;
            top: 12px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px; /* Larger */
            color: #888;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .popup-close-button:hover {
            color: #333;
        }
        /* Valor Real Buttons Styling */
        .valorreal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 20px; /* Add margin below */
        }
        .valorreal-buttons button {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            border: 2px solid transparent;
        }
        .valorreal-tirar {
            background-color: #ffebee; /* Light red */
            color: #c62828; /* Darker red */
            border-color: #ef9a9a;
        }
        .valorreal-tirar:hover {
            background-color: #ffcdd2;
        }
        .valorreal-dar {
            background-color: #e8f5e9; /* Light green */
            color: #2e7d32; /* Darker green */
            border-color: #a5d6a7;
        }
        .valorreal-dar:hover {
             background-color: #c8e6c9;
        }
        .valorreal-buttons button.active {
            border-width: 2px;
             /* Example active state */
             box-shadow: 0 0 0 3px rgba(33, 118, 255, 0.3);
             font-weight: bold;
        }
        .valorreal-buttons button:disabled {
             background-color: #eee;
             color: #999;
             cursor: not-allowed;
             border-color: #ddd;
        }

        /* Ensure popup form elements use form-group styling */
        #slot-popup .form-group { margin-bottom: 18px; } /* Adjust margin if needed */
        #slot-popup .form-group label { margin-bottom: 6px; }
        #slot-popup .form-group input,
        #slot-popup .form-group select {
            /* Styles should be inherited, but can override if needed */
        }
        /* --- END: Popup Styles --- */

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body { padding-top: 60px; padding-left: 10px; padding-right: 10px; }
            .form-container { padding: 20px; margin-top: 15px; }
            .top-menu { gap: 10px; padding: 8px 0; }
            .menu-item { padding: 6px 10px; font-size: 0.9em; }
            .menu-item i { font-size: 14px; }
            .item-card { padding: 12px 15px; }
            .item-card h3 { font-size: 16px; }
            .item-card p { font-size: 13px; }
            #slot-icon-trigger { margin-top: 10px; margin-bottom: 10px; font-size: 26px; margin-right: 5px;} /* Adjust icon margin/size on mobile, add slight right margin if needed */
            .popup-content { padding: 25px 20px; max-width: 95%; } /* Adjust popup padding */
            .content { margin-top: 0; } /* Ensure no extra top margin on mobile */
        }
    </style>
</head>
<body style="display: none;"> <!-- 2. O CORPO DA PÁGINA FICA OCULTO POR PADRÃO -->

    <!-- Top Menu -->
    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item"> <i class="fas fa-home"></i> </a>
        <a href="editar-gplayer.html" class="menu-item"> <i class="fas fa-user"></i> EDITAR GPLAYER </a>
        <a href="editar-jogo.html" class="menu-item"> <i class="fas fa-gamepad"></i> EDITAR JOGO </a>
        <a href="editar-jogadores.html" class="menu-item"> <i class="fas fa-users"></i> EDITAR JOGADORES </a>
        <a href="editar-clubes.html" class="menu-item"> <i class="fas fa-shield-alt"></i> EDITAR CLUBES </a>
        <a href="editar-competicoes.html" class="menu-item"> <i class="fas fa-trophy"></i> EDITAR COMPETIÇÕES </a>
        <a href="editar-pais.html" class="menu-item"> <i class="fas fa-globe"></i> EDITAR PAIS </a>
        <a href="editar-mods.html" class="menu-item"> <i class="fas fa-puzzle-piece"></i> EDITAR MODS </a>
        <a href="editar-odds.html" class="menu-item"> <i class="fas fa-puzzle-piece"></i> EDITAR ODDS </a>
    </nav>

    <!-- Main Content Area -->
    <main class="content">
        <i id="slot-icon-trigger" class="fas fa-plus-circle" title="Adicionar Movimento Slot"></i>
        <a href="gerenciar-empire.html" class="menu-item"><i class="fas fa-users"></i> GERIR MERCADO EMPIRE</a>
        <h1>Listar e Editar Itens do Império</h1>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Pesquisar por nome ou tipo..." class="search-input">
            <i class="fas fa-search search-icon"></i>
        </div>
        <div id="item-list" class="item-list"><p>Carregando itens...</p></div>
        <div id="item-edit-form-container" class="form-container" style="display: none;">
            <h2>Editar Item</h2>
             <form id="item-edit-form">
                <input type="hidden" id="item-id">
                <div class="form-group"> 
                    <label for="tipo">Tipo:</label> 
                    <select id="tipo" name="tipo" required> 
                        <option value="" disabled selected>-- Selecione o Tipo --</option> 
                        <option value="Filosofia">Filosofia</option>
                    <option value="Formações">Formações</option>
                    <option value="Estádio">Estádio</option>
                    <option value="Fisioterapeuta">Fisioterapeuta</option>
                    <option value="Agente">Agente</option>
                    <option value="Treinador">Treinador</option>
                    <option value="Mestre da Tática">Mestre da Tática</option>
                    <option value="Preparador Físico">Preparador Físico</option>
                     <option value="Chefe dos Olheiros">Chefe dos Olheiros</option>
               
                <div class="form-group"> <label for="nome">Nome:</label> <input type="text" id="nome" name="nome" required> </div>
                <div class="form-group"> <label for="imagem">Imagem <span class="optional-text">(Link - Opcional)</span></label> <input type="url" id="imagem" name="imagem" placeholder="https://exemplo.com/imagem.png"> </div>
                <div class="form-group"> <label for="anexadoItem">Anexado? <span class="optional-text">(Filosofia ou Estádio - Opcional)</span></label> <select id="anexadoItem" name="anexadoItem"> <option value="" selected enable>-- Selecione Item Anexado (Opcional) --</option> </select> </div>
                <div class="form-group"> <label for="valor">Valor <span class="optional-text">(Opcional)</span></label> <input type="number" id="valor" name="valor" placeholder="Ex: 1000" step="any"> </div>
                <div class="form-group"> <label for="nota">Nota <span class="optional-text">(Opcional)</span></label> <textarea id="nota" name="nota" rows="4" placeholder="Descreva o item..."></textarea> </div>
                <div class="form-group"> <label for="competicoes">Competições <span class="optional-text">(Multiescolha - Opcional)</span></label> <select id="competicoes" name="competicoes" multiple placeholder="Selecione as competições..."> </select> </div>
                <div class="form-group"> <label for="nivel">Nível <span class="optional-text">(Opcional)</span></label> <select id="nivel" name="nivel"> <option value="">-- Selecione o Nível (se aplicável) --</option> <option value="Nível 1">Nível 1</option> <option value="Nível 2">Nível 2</option> <option value="Nível 3">Nível 3</option> </select> </div>
                <div class="form-group"> <label for="noMercado">No Mercado?</label> <select id="noMercado" name="noMercado"> <option value="" selected disabled>-- Selecione --</option> <option value="sim">Sim</option> <option value="nao">Não</option> </select> </div>
                <div class="form-group"> <label for="ordem">Ordem:</label> <select id="ordem" name="ordem"> <option value="" selected disabled>-- Selecione a Ordem --</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div>
                <div class="form-group"> <label for="compradoPor">Comprado Por <span class="optional-text">(Multiescolha - Opcional)</span></label> <select id="compradoPor" name="compradoPor" multiple placeholder="Selecione os usuários..."> </select> </div>
                 <button type="button" class="back-button" id="back-to-list-button">Voltar à Lista</button>
                 <button type="submit" class="submit-button">Salvar Alterações</button>
            </form>
        </div>
    </main>

    <div id="slot-popup-overlay" class="popup-overlay">
        <div class="popup-content">
            <button id="slot-popup-close-button" class="popup-close-button">×</button>
            <h2>Adicionar Movimento Slot</h2>
            <form id="slot-form">
                <div class="form-group"><label for="popup-empireTipo">Empire Tipo:</label><input type="text" id="popup-empireTipo" name="empireTipo" value="Extra" required></div>
                <div class="form-group"><label for="popup-estado">Estado:</label><input type="text" id="popup-estado" name="estado" value="Empire Paid" required></div>
                <div class="form-group"><label for="popup-itemEmpire">Item Empire:</label><input type="text" id="popup-itemEmpire" name="itemEmpire" required placeholder="Nome do item"></div>
                <div class="form-group"><label for="popup-preco">Preço:</label><input type="number" id="popup-preco" name="preco" required placeholder="Ex: 22" step="any"></div>
                <label>Ação sobre o Valor:</label>
                <div class="valorreal-buttons"><button type="button" id="popup-valorreal-tirar" class="valorreal-tirar">Tirar</button><button type="button" id="popup-valorreal-dar" class="valorreal-dar">Dar</button></div>
                <input type="hidden" id="popup-valorreal-hidden" name="valorreal">
                <div class="form-group"><label for="popup-temporada">Temporada:</label><input type="text" id="popup-temporada" name="temporada" readonly required placeholder="Carregando..."></div>
                <div class="form-group"><label for="popup-tipo">Tipo:</label><input type="text" id="popup-tipo" name="tipo" value="Empire" required></div>
                <div class="form-group"><label for="popup-userId">Usuário (Nome):</label><select id="popup-userId" name="userId" required><option value="" selected disabled>-- Selecione o Usuário --</option></select></div>
                <button type="submit" id="popup-save-button" class="popup-save-button">Gravar Movimento</button>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

      <script type="module">
        // Importa 'db' e 'auth' do nosso guardião central. (CORRIGIDO)
        import { db, auth } from './js/auth-guard.js';
        
        // Importa as funções específicas do Firestore que esta página precisa.
        import {
            collection, getDocs, doc, getDoc, updateDoc, serverTimestamp,
            query, where, addDoc, orderBy, limit
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Importa a função onAuthStateChanged para saber quando inicializar a página.
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- Variáveis Globais e Elementos do DOM ---
        let competicoesChoicesInstance = null;
        let compradoPorChoicesInstance = null;
        const itemListDiv = document.getElementById('item-list');
        const itemEditFormContainer = document.getElementById('item-edit-form-container');
        const itemEditForm = document.getElementById('item-edit-form');
        const itemIdInput = document.getElementById('item-id');
        const backButton = document.getElementById('back-to-list-button');
        const searchInput = document.getElementById('search-input');
        const slotIconTrigger = document.getElementById('slot-icon-trigger');
        const slotPopupOverlay = document.getElementById('slot-popup-overlay');
        const slotPopupCloseButton = document.getElementById('slot-popup-close-button');
        const slotForm = document.getElementById('slot-form');
        const popupPrecoInput = document.getElementById('popup-preco');
        const popupValorRealTirarButton = document.getElementById('popup-valorreal-tirar');
        const popupValorRealDarButton = document.getElementById('popup-valorreal-dar');
        const popupValorRealHiddenInput = document.getElementById('popup-valorreal-hidden');
        const popupTemporadaInput = document.getElementById('popup-temporada');
        const popupUserIdSelect = document.getElementById('popup-userId');
        const popupSaveButton = document.getElementById('popup-save-button');
        const popupItemEmpireInput = document.getElementById('popup-itemEmpire');
        const popupEmpireTipoInput = document.getElementById('popup-empireTipo');
        const popupEstadoInput = document.getElementById('popup-estado');
        const popupTipoInput = document.getElementById('popup-tipo');

        // --- Funções de Carregamento de Dados ---
        async function loadCompeticoes() {
             const competicoesSelect = document.getElementById('competicoes');
             if (!competicoesSelect) return;
             try {
                 const competicoesCol = collection(db, 'competicoes');
                 const competicoesSnapshot = await getDocs(competicoesCol);
                 const choicesData = [];
                 competicoesSnapshot.forEach((doc) => {
                     const data = doc.data();
                     if (data.nome) choicesData.push({ value: doc.id, label: data.nome });
                 });
                 choicesData.sort((a, b) => a.label.localeCompare(b.label));

                 if (competicoesChoicesInstance) competicoesChoicesInstance.destroy();
                 competicoesChoicesInstance = new Choices(competicoesSelect, { removeItemButton: true, placeholder: true, placeholderValue: 'Selecione...', choices: choicesData, searchPlaceholderValue: "Pesquisar...", itemSelectText: '', shouldSort: false, maxItemCount: -1, position: 'bottom' });
             } catch (error) {
                 console.error("Erro ao carregar competições:", error);
                 if(competicoesSelect) competicoesSelect.innerHTML = '<option value="" disabled>Erro</option>';
             }
        }

        async function loadUsers() {
             const compradoPorSelect = document.getElementById('compradoPor');
             if (!compradoPorSelect) return;
             try {
                 const usersCol = collection(db, 'users');
                 const querySnapshot = await getDocs(usersCol);
                 const choicesData = [];
                 if (!querySnapshot.empty) {
                     const users = [];
                     querySnapshot.forEach((doc) => {
                         const data = doc.data();
                         if (data.nomeDeUsuario) users.push({ id: doc.id, nomeDeUsuario: data.nomeDeUsuario });
                     });
                     users.sort((a, b) => a.nomeDeUsuario.localeCompare(b.nomeDeUsuario));
                     users.forEach(user => choicesData.push({ value: user.id, label: user.nomeDeUsuario }));
                 }

                 if (compradoPorChoicesInstance) compradoPorChoicesInstance.destroy();
                 compradoPorChoicesInstance = new Choices(compradoPorSelect, { removeItemButton: true, placeholder: true, placeholderValue: 'Selecione...', choices: choicesData, searchPlaceholderValue: "Pesquisar...", itemSelectText: '', shouldSort: false, maxItemCount: -1, position: 'bottom' });
             } catch (error) {
                 console.error("Erro ao carregar usuários:", error);
                  if (compradoPorChoicesInstance) { compradoPorChoicesInstance.destroy(); }
             }
        }

        async function loadAnexadoOptions() {
             const anexadoSelect = document.getElementById('anexadoItem');
             if (!anexadoSelect) { console.error("Elemento #anexadoItem não encontrado."); return; }
             const placeholderOptionHTML = anexadoSelect.querySelector('option[value=""]')?.outerHTML || '<option value="" selected enable>-- Selecione Item Anexado (Opcional) --</option>';
             anexadoSelect.innerHTML = placeholderOptionHTML;

             try {
                 const itemsCol = collection(db, 'empireitens');
                 const qFilosofia = query(itemsCol, where("tipo", "==", "Filosofia"));
                 const qEstadio = query(itemsCol, where("tipo", "==", "Estádio"));
                 const [filosofiaSnapshot, estadioSnapshot] = await Promise.all([ getDocs(qFilosofia), getDocs(qEstadio) ]);
                 const combinedItems = [];
                 filosofiaSnapshot.forEach((doc) => { const data = doc.data(); if (data.nome) { combinedItems.push({ id: doc.id, nome: data.nome, tipo: data.tipo }); } });
                 estadioSnapshot.forEach((doc) => { const data = doc.data(); if (data.nome) { combinedItems.push({ id: doc.id, nome: data.nome, tipo: data.tipo }); } });
                 combinedItems.sort((a, b) => { const textA = `${a.tipo}: ${a.nome}`; const textB = `${b.tipo}: ${b.nome}`; return textA.localeCompare(textB); });
                 combinedItems.forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = `${item.tipo}: ${item.nome}`; anexadoSelect.appendChild(option); });
             } catch (error) {
                 console.error("Erro ao carregar opções de Anexado (Filosofia/Estádio):", error);
                 anexadoSelect.innerHTML = placeholderOptionHTML;
                 const errorOption = document.createElement('option'); errorOption.textContent = "Erro ao carregar itens"; errorOption.disabled = true; anexadoSelect.appendChild(errorOption);
             }
        }
        
        async function fetchLatestSeason() {
            if (!popupTemporadaInput) return;
            popupTemporadaInput.value = "Carregando...";
            popupTemporadaInput.readOnly = true;
            try {
                const jogosCol = collection(db, 'jogos');
                const q = query(jogosCol, orderBy('temporada', 'desc'), limit(1));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const latestJogo = querySnapshot.docs[0].data();
                    let temporada = latestJogo.temporada;
                    if (typeof temporada === 'string' && temporada.includes('/')) {
                        temporada = temporada.replace('/', '');
                        popupTemporadaInput.value = temporada;
                    } else if (typeof temporada === 'string') {
                         console.warn("Formato de temporada não esperado (usando valor direto):", latestJogo.temporada);
                         popupTemporadaInput.value = temporada;
                    } else {
                        console.warn("Tipo ou formato de temporada inesperado:", latestJogo.temporada);
                        popupTemporadaInput.value = "Erro formato";
                    }
                } else {
                    console.warn("Nenhuma temporada encontrada na coleção 'jogos'. Defina manualmente ou configure um valor padrão.");
                    popupTemporadaInput.value = "N/A";
                }
            } catch (error) {
                console.error("Erro ao buscar a temporada mais recente:", error);
                popupTemporadaInput.value = "Erro ao carregar";
            }
        }

        async function fetchUsersForPopup() {
            if (!popupUserIdSelect) return;
            popupUserIdSelect.innerHTML = '<option value="" selected disabled>-- Selecione o Usuário --</option>';
            try {
                const usersCol = collection(db, 'users');
                const querySnapshot = await getDocs(usersCol);
                const usersData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let displayName = data.nomeDeUsuario || data.nome || doc.id;
                    if (displayName) {
                        usersData.push({ id: doc.id, name: displayName });
                    }
                });
                usersData.sort((a, b) => a.name.localeCompare(b.name));
                usersData.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    popupUserIdSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar usuários para o popup:", error);
                const errorOption = document.createElement('option');
                errorOption.textContent = "Erro ao carregar";
                errorOption.disabled = true;
                popupUserIdSelect.appendChild(errorOption);
            }
        }
        
        // --- Funções de Exibição e Interação com Itens ---
        let allItems = [];
        function filterItems(searchText) {
             const normalizedSearch = searchText.toLowerCase().trim();
             const filteredItems = allItems.filter(item => {
                 const nome = (item.nome || '').toLowerCase();
                 const tipo = (item.tipo || '').toLowerCase();
                 return nome.includes(normalizedSearch) || tipo.includes(normalizedSearch);
             });
             displayItems(filteredItems);
        }
        function displayItems(items) {
             if (!itemListDiv) return;
             itemListDiv.innerHTML = '';
             if (items.length === 0) {
                 itemListDiv.innerHTML = '<p>Nenhum item encontrado.</p>';
                 return;
             }
             items.forEach((item) => {
                 const card = document.createElement('div');
                 card.className = 'item-card';
                 card.onclick = () => {
                     if (auth.currentUser) {
                        loadItemDetails(item.id);
                     } else {
                         alert("Faça login para editar itens.");
                     }
                 };
                 card.innerHTML = `
                    <div class="item-info">
                        <h3>${item.nome || 'Item sem nome'}</h3>
                        <p>Tipo: ${item.tipo || 'N/A'}</p>
                    </div>
                    <div class="item-actions">
                        <i class="fas fa-edit"></i>
                    </div>`;
                 itemListDiv.appendChild(card);
             });
        }
        async function loadItems() {
             if (!itemListDiv) return;
             const itemsCollection = collection(db, 'empireitens');
             itemListDiv.innerHTML = '<p>Carregando itens...</p>';
             try {
                 const querySnapshot = await getDocs(itemsCollection);
                 allItems = [];
                 if (querySnapshot.empty) {
                    displayItems([]);
                    return;
                 }
                 querySnapshot.forEach((doc) => {
                     allItems.push({ id: doc.id, ...doc.data() });
                 });
                 allItems.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                 displayItems(allItems);

                 if (searchInput && !searchInput.listenerAttached) {
                     searchInput.addEventListener('input', (e) => filterItems(e.target.value));
                     searchInput.listenerAttached = true;
                 }
             } catch (error) {
                 console.error('Error loading items:', error);
                 itemListDiv.innerHTML = '<p style="color: red;">Erro ao carregar itens.</p>';
             }
        }

        async function loadItemDetails(itemId) {
             if (!itemEditForm || !itemIdInput || !auth.currentUser) { return; }
             await loadAnexadoOptions();

             try {
                 const itemDocRef = doc(db, 'empireitens', itemId);
                 const itemDocSnap = await getDoc(itemDocRef);

                 if (itemDocSnap.exists()) {
                     const item = itemDocSnap.data();
                     itemEditForm.reset();

                     itemIdInput.value = itemId;
                     itemEditForm.tipo.value = item.tipo || '';
                     itemEditForm.nome.value = item.nome || '';
                     itemEditForm.imagem.value = item.imagem || '';
                     itemEditForm.valor.value = item.valor !== undefined ? item.valor : '';
                     itemEditForm.nota.value = item.nota || '';
                     itemEditForm.nivel.value = item.nivel || '';
                     itemEditForm.noMercado.value = item.noMercado === true ? 'sim' : (item.noMercado === false ? 'nao' : '');
                     itemEditForm.ordem.value = item.ordem || '';

                     const anexadoSelect = itemEditForm.querySelector('#anexadoItem');
                     if (anexadoSelect) {
                         anexadoSelect.value = item.anexadoItemId || '';
                         if (item.anexadoItemId && !anexadoSelect.querySelector(`option[value="${item.anexadoItemId}"]`)) {
                             console.warn(`Anexado ID "${item.anexadoItemId}" não encontrado nas opções.`);
                         }
                     }

                     if (competicoesChoicesInstance) {
                         competicoesChoicesInstance.removeActiveItems();
                         if (item.competicoesIds && Array.isArray(item.competicoesIds)) {
                             competicoesChoicesInstance.setChoiceByValue(item.competicoesIds);
                         }
                     }

                     if (compradoPorChoicesInstance) {
                         compradoPorChoicesInstance.removeActiveItems();
                         if (item.compradoPorUids && Array.isArray(item.compradoPorUids)) {
                             compradoPorChoicesInstance.setChoiceByValue(item.compradoPorUids);
                         }
                     }

                     if(itemListDiv) itemListDiv.style.display = 'none';
                     if(itemEditFormContainer) itemEditFormContainer.style.display = 'block';

                 } else {
                     console.error('Item não encontrado com ID:', itemId);
                     alert('Item não encontrado.');
                 }
             } catch (error) {
                 console.error('Erro ao carregar detalhes do item:', error);
                 alert('Erro ao carregar detalhes do item.');
                 if(itemEditFormContainer) itemEditFormContainer.style.display = 'none';
                 if(itemListDiv) itemListDiv.style.display = 'block';
             }
        }
        
        // --- Funções do Popup ---
        function openPopup() {
            if (!slotPopupOverlay || !auth.currentUser) {
                if (!auth.currentUser) alert("Faça login para adicionar um movimento.");
                return;
            }
            if(slotForm) slotForm.reset();
            if(popupEmpireTipoInput) popupEmpireTipoInput.value = "Extra";
            if(popupEstadoInput) popupEstadoInput.value = "Empire Paid";
            if(popupTipoInput) popupTipoInput.value = "Empire";
            if(popupTemporadaInput) popupTemporadaInput.value = "";
            if(popupUserIdSelect) popupUserIdSelect.innerHTML = '<option value="" selected disabled>-- Carregando Usuários --</option>';
            resetValorRealState();
            fetchLatestSeason();
            fetchUsersForPopup();
            slotPopupOverlay.classList.add('visible');
        }

        function closePopup() {
            if (!slotPopupOverlay) return;
            slotPopupOverlay.classList.remove('visible');
            setTimeout(() => {
               if(slotForm) slotForm.reset();
               resetValorRealState();
               if(popupEmpireTipoInput) popupEmpireTipoInput.value = "Extra";
               if(popupEstadoInput) popupEstadoInput.value = "Empire Paid";
               if(popupTipoInput) popupTipoInput.value = "Empire";
               if(popupTemporadaInput) popupTemporadaInput.value = "";
               if(popupUserIdSelect) popupUserIdSelect.innerHTML = '<option value="" selected disabled>-- Selecione o Usuário --</option>';
            }, 300);
        }
        
        function resetValorRealState() {
             if (popupValorRealHiddenInput) popupValorRealHiddenInput.value = '';
             if (popupValorRealTirarButton) popupValorRealTirarButton.classList.remove('active');
             if (popupValorRealDarButton) popupValorRealDarButton.classList.remove('active');
        }

        function handleValorRealClick(isTirar) {
            if (!popupPrecoInput || !popupValorRealHiddenInput) return;
            const precoValue = parseFloat(popupPrecoInput.value);
            if (isNaN(precoValue) || popupPrecoInput.value.trim() === '') {
                alert("Por favor, insira um valor numérico válido no campo 'Preço' antes de selecionar 'Tirar' ou 'Dar'.");
                resetValorRealState(); return;
            }
            const calculatedValue = isTirar ? -Math.abs(precoValue) : Math.abs(precoValue);
            popupValorRealHiddenInput.value = calculatedValue;
            if (popupValorRealTirarButton) popupValorRealTirarButton.classList.toggle('active', isTirar);
            if (popupValorRealDarButton) popupValorRealDarButton.classList.toggle('active', !isTirar);
        }

        // --- Ponto de Entrada e Inicialização da Página ---
        function initializePage() {
            // Carrega os dados iniciais necessários para os formulários
            Promise.all([
                loadCompeticoes(),
                loadUsers(),
                loadAnexadoOptions()
            ]);
            
            // Carrega a lista principal de itens
            loadItems();

            // Anexa todos os event listeners
            if (itemEditForm) {
                itemEditForm.addEventListener('submit', async (e) => {
                     e.preventDefault();
                     if (!auth.currentUser) { alert("Faça login para salvar alterações."); return; }
                     const submitButton = itemEditForm.querySelector('.submit-button');
                     if (!submitButton) return;
                     submitButton.disabled = true; submitButton.textContent = 'A Salvar...';
                     const itemId = itemIdInput.value;
                     if (!itemId) { alert("Erro: ID do item não encontrado."); submitButton.disabled = false; submitButton.textContent = 'Salvar Alterações'; return; }

                     const tipo = itemEditForm.tipo.value;
                     const nome = itemEditForm.nome.value;
                     const imagem = itemEditForm.imagem.value;
                     const anexadoItemId = itemEditForm.anexadoItem.value;
                     const valorInput = itemEditForm.valor.value;
                     const nota = itemEditForm.nota.value;
                     const nivel = itemEditForm.nivel.value;
                     const noMercadoValue = itemEditForm.noMercado.value;
                     const ordemValue = itemEditForm.ordem.value;
                     const selectedCompeticoes = competicoesChoicesInstance ? competicoesChoicesInstance.getValue(true) : [];
                     const selectedUsers = compradoPorChoicesInstance ? compradoPorChoicesInstance.getValue(true) : [];

                     const updatedData = {
                         tipo: tipo, nome: nome, noMercado: noMercadoValue === 'sim',
                         atualizadoEm: serverTimestamp(),
                         compradoPorUids: Array.isArray(selectedUsers) ? selectedUsers : [],
                         competicoesIds: Array.isArray(selectedCompeticoes) ? selectedCompeticoes : [],
                     };
                     if (imagem) updatedData.imagem = imagem;
                     if (valorInput !== '' && !isNaN(parseFloat(valorInput))) updatedData.valor = parseFloat(valorInput); else if (itemEditForm.valor.hasAttribute('value')) updatedData.valor = null;
                     if (nota) updatedData.nota = nota; else if (itemEditForm.nota.hasAttribute('value')) updatedData.nota = null;
                     if (nivel) updatedData.nivel = nivel; else if (itemEditForm.nivel.hasAttribute('value')) updatedData.nivel = null;
                     if (ordemValue && !isNaN(parseInt(ordemValue, 10))) updatedData.ordem = parseInt(ordemValue, 10); else if (itemEditForm.ordem.hasAttribute('value')) updatedData.ordem = null;
                     if (anexadoItemId) { updatedData.anexadoItemId = anexadoItemId; } else { updatedData.anexadoItemId = null; }

                     try {
                         const itemDocRef = doc(db, 'empireitens', itemId);
                         await updateDoc(itemDocRef, updatedData);
                         alert('Item atualizado com sucesso!');
                         if(itemEditFormContainer) itemEditFormContainer.style.display = 'none';
                         if(itemListDiv) itemListDiv.style.display = 'block';
                         await loadItems();
                     } catch (error) {
                         console.error('Erro ao atualizar item:', error);
                         alert('Erro ao atualizar item.');
                     } finally {
                         submitButton.disabled = false; submitButton.textContent = 'Salvar Alterações';
                     }
                });
            }

            if (backButton) {
                backButton.addEventListener('click', () => {
                     if(itemEditFormContainer) itemEditFormContainer.style.display = 'none';
                     if(itemListDiv) itemListDiv.style.display = 'block';
                     if(itemEditForm) itemEditForm.reset();
                     if (competicoesChoicesInstance) competicoesChoicesInstance.removeActiveItems();
                     if (compradoPorChoicesInstance) compradoPorChoicesInstance.removeActiveItems();
                     if(itemIdInput) itemIdInput.value = '';
                     if(itemEditForm.tipo) itemEditForm.tipo.value = "";
                     if(itemEditForm.anexadoItem) itemEditForm.anexadoItem.value = "";
                     if(itemEditForm.nivel) itemEditForm.nivel.value = "";
                     if(itemEditForm.noMercado) itemEditForm.noMercado.value = "";
                     if(itemEditForm.ordem) itemEditForm.ordem.value = "";
                });
            }

            if (slotIconTrigger) slotIconTrigger.addEventListener('click', openPopup);
            if (slotPopupCloseButton) slotPopupCloseButton.addEventListener('click', closePopup);
            if (slotPopupOverlay) slotPopupOverlay.addEventListener('click', (event) => { if (event.target === slotPopupOverlay) closePopup(); });
            if (popupValorRealTirarButton) popupValorRealTirarButton.addEventListener('click', () => handleValorRealClick(true));
            if (popupValorRealDarButton) popupValorRealDarButton.addEventListener('click', () => handleValorRealClick(false));
            if(popupPrecoInput) popupPrecoInput.addEventListener('input', () => { if (popupValorRealHiddenInput?.value !== '') resetValorRealState(); });
            
            if (slotForm) {
                slotForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!popupSaveButton || !auth.currentUser) { if (!auth.currentUser) alert("Faça login para gravar."); return; }
                    popupSaveButton.disabled = true; popupSaveButton.textContent = 'A Gravar...';

                    const preco = popupPrecoInput.value.trim();
                    const itemEmpire = popupItemEmpireInput.value.trim();
                    const userId = popupUserIdSelect.value;
                    const valorReal = popupValorRealHiddenInput.value;
                    const temporada = popupTemporadaInput.value;
                    const empireTipo = popupEmpireTipoInput.value.trim();
                    const estado = popupEstadoInput.value.trim();
                    const tipo = popupTipoInput.value.trim();

                    let isValid = true; let errorMessage = "Por favor, corrija:\n";
                    if (!itemEmpire) { isValid = false; errorMessage += "- 'Item Empire' é obrigatório.\n"; }
                    if (!preco || isNaN(parseFloat(preco))) { isValid = false; errorMessage += "- 'Preço' deve ser número.\n"; }
                    if (!valorReal || isNaN(parseFloat(valorReal))) { isValid = false; errorMessage += "- Selecione 'Tirar'/'Dar'.\n"; }
                    if (!userId) { isValid = false; errorMessage += "- Selecione 'Usuário'.\n"; }
                    if (!temporada || temporada === "Carregando..." || temporada.includes("Erro") || temporada === "N/A") { isValid = false; errorMessage += "- 'Temporada' inválida.\n"; }
                    if (!empireTipo) { isValid = false; errorMessage += "- 'Empire Tipo' obrigatório.\n"; }
                    if (!estado) { isValid = false; errorMessage += "- 'Estado' obrigatório.\n"; }
                    if (!tipo) { isValid = false; errorMessage += "- 'Tipo' obrigatório.\n"; }

                    if (!isValid) {
                        alert(errorMessage);
                        popupSaveButton.disabled = false; popupSaveButton.textContent = 'Gravar Movimento';
                        return;
                    }

                    const movimentoData = {
                        empireTipo: empireTipo, estado: estado, itemEmpire: itemEmpire,
                        preco: parseFloat(preco), valorreal: parseFloat(valorReal),
                        temporada: temporada, tipo: tipo, userId: userId,
                        movimentoData: serverTimestamp(),
                        userName: popupUserIdSelect.selectedOptions[0]?.textContent || userId
                    };

                  try {
    // PASSO 1: Grava a nova transação (o seu código original)
    const movimentosCollectionRef = collection(db, 'movimentos');
    const docRef = await addDoc(movimentosCollectionRef, movimentoData);
    console.log("Movimento gravado com ID: ", docRef.id);

    // --- INÍCIO DA NOVA LÓGICA DE RECONCILIAÇÃO ---

    // PASSO 2: Prepara a query para buscar TODOS os movimentos do utilizador na temporada
    const movimentosQuery = query(collection(db, 'movimentos'),
        where("userId", "==", userId),
        where("temporada", "==", temporada),
        where("estado", "!=", "Dívida") // Boa prática: Ignora dívidas no cálculo de GCoins
    );

    // PASSO 3: Executa a query e calcula o novo total
    const movimentosSnapshot = await getDocs(movimentosQuery);
    let totalGcoinsRecalculado = 0;
    
    movimentosSnapshot.forEach(movDoc => {
        const movData = movDoc.data();
        if (typeof movData.valorreal === 'number') {
            totalGcoinsRecalculado += movData.valorreal;
        }
    });

    // PASSO 4: Atualiza o documento do utilizador com o novo saldo total
    const userDocRef = doc(db, 'users', userId);
    const temporadaGcoinsField = `${temporada}GCoins`;
    
    await updateDoc(userDocRef, {
        [temporadaGcoinsField]: totalGcoinsRecalculado
    });
    
    console.log(`Saldo de GCoins do utilizador ${userId} reconciliado para: ${totalGcoinsRecalculado}`);
    
    // --- FIM DA NOVA LÓGICA DE RECONCILIAÇÃO ---

    alert('Movimento gravado e saldo do utilizador atualizado com sucesso!');
    closePopup();

} catch (error) {
    console.error('Erro ao gravar movimento ou ao atualizar GCoins:', error);
    alert('Ocorreu um erro. Verifique a consola para mais detalhes.');
} finally {
    popupSaveButton.disabled = false;
    popupSaveButton.textContent = 'Gravar Movimento';
}
                });
            }
        }
        
        // Ponto de entrada que verifica o estado de autenticação antes de rodar qualquer coisa.
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Se o usuário está aqui, o guardião já validou as permissões.
                // Agora, podemos inicializar com segurança a funcionalidade da página.
                initializePage();
            }
            // Não há 'else' porque o auth-guard.js já trata do redirecionamento.
        });

    </script>
  
</body>
</html>
