<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Mitos Game - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- 1. Adiciona o nosso guardião de segurança. Ele deve ser o primeiro script. -->
    <script type="module" src="js/auth-guard.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .menu-item i { font-size: 16px; }
        .content { padding: 80px 20px 20px; max-width: 800px; margin: 0 auto; }
        .search-container, .form-container { background: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        h1 { color: #333; margin-bottom: 24px; font-size: 24px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        input[type="text"], input[type="number"], textarea, select, input[type="datetime-local"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: white; }
        select:disabled { background-color: #e9ecef; cursor: not-allowed;}
        textarea { height: 100px; resize: vertical; }
        .btn { background-color: #2176ff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background-color 0.3s ease; width: 100%; }
        .btn:hover { background-color: #0056d6; }
        .btn-danger { background-color: #dc3545; margin-top: 12px; }
        .btn-danger:hover { background-color: #c82333; }
        .error-message { color: #dc3545; font-size: 14px; margin-top: 4px; display: none; }
        .games-list { list-style: none; margin-top: 16px; padding-left: 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; display: none; }
        .game-item { background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 12px; cursor: pointer; transition: background-color 0.2s ease; }
        .game-item:last-child { border-bottom: none; }
        .game-item:hover { background: #e9ecef; }
        .game-item.selected { background: #cfe2ff; border-color: #9ec5fe; font-weight: bold; color: #0a58ca; }
        .select2-container { width: 100% !important; }
    </style>
</head>
<body style="display: none;"> <!-- 2. O corpo da página está oculto por padrão -->

    <nav class="top-menu">
        <a href="1x.html" class="menu-item"> <i class="fas fa-home"></i> Home </a>
        <a href="engrenagem.html" class="menu-item"> <i class="fas fa-cog"></i> Engrenagem </a>
        <!-- Add other menu items as needed -->
    </nav>

    <main class="content">
        <div class="search-container">
            <h1>Buscar Item para Editar</h1>
            <div class="form-group">
                <input type="text" id="searchGame" placeholder="Digite o nome do item..." class="search-input">
            </div>
            <ul class="games-list" id="gamesList">
                <li>Carregando itens...</li>
            </ul>
        </div>

        <div class="form-container">
            <h1>Editar Item</h1>
            <form id="editMitosForm">
                <div class="form-group"><label for="name">Nome</label><input type="text" id="name" name="name" required><div class="error-message">Por favor, insira um nome válido.</div></div>
                <div class="form-group"><label for="familia">Família</label><select id="familia" name="familia" required><option value="">Carregando famílias...</option></select><div class="error-message">Por favor, selecione uma família.</div></div>
                <div class="form-group"><label for="castaSelect">Casta</label><select id="castaSelect" name="casta" required disabled><option value="">Selecione uma família primeiro</option></select><div class="error-message">Por favor, selecione uma casta.</div></div>
                <div class="form-group"><label for="description">Descrição</label><textarea id="description" name="description" required></textarea><div class="error-message">Por favor, insira uma descrição.</div></div>
                <div class="form-group"><label for="equipes">Equipas</label><select id="equipes" name="equipes[]" multiple="multiple" required></select><div class="error-message">Por favor, selecione pelo menos uma equipe.</div></div>
                <div class="form-group"><label for="imagem">URL da Imagem</label><input type="text" id="imagem" name="imagem" required><div class="error-message">Por favor, insira uma URL de imagem válida.</div></div>
                <div class="form-group"><label for="compradoPor">Comprado Por</label><select id="compradoPor" name="compradoPor" required><option value="">Carregando usuários...</option></select><div class="error-message">Por favor, selecione um comprador.</div></div>
                <div class="form-group"><label for="pontosGanhos">Pontos Ganhos</label><input type="number" id="pontosGanhos" name="pontosGanhos" min="0"></div>
                <div class="form-group"><label for="vitorias">Vitórias</label><input type="number" id="vitorias" name="vitorias" min="0"></div>
                <div class="form-group"><label for="empates">Empates</label><input type="number" id="empates" name="empates" min="0"></div>
                <div class="form-group"><label for="derrotas">Derrotas</label><input type="number" id="derrotas" name="derrotas" min="0"></div>
                <div class="form-group"><label for="ativo">Ativo?</label><select id="ativo" name="ativo" required><option value="yes">Sim</option><option value="no">Não</option></select></div>
                <div class="form-group"><label for="visivel">Visível?</label><select id="visivel" name="visivel" required><option value="no">Não</option><option value="yes">Sim</option></select></div>
                <div class="form-group"><label for="dataAtivacao">Data de Ativação (Opcional)</label><input type="datetime-local" id="dataAtivacao" name="dataAtivacao"></div>
                <div class="form-group"><label for="tipo">Tipo</label><input type="text" id="tipo" name="tipo" readonly></div>
                <button type="submit" class="btn">Salvar Alterações</button>
                <button type="button" id="deleteButton" class="btn btn-danger">Excluir Item</button>
            </form>
        </div>
    </main>

    <!-- 3. O script da página foi modificado para usar a conexão do guardião -->
    <script type="module">
        // Importa a variável 'db' do guardião e as funções do Firestore
        import { db } from '/js/auth-guard.js';
        import { collection, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // A inicialização do Firebase foi removida daqui

        let currentGameId = null;
        let allItemsCache = []; // Cache for searchable items

        // References to form elements
        const editForm = document.getElementById('editMitosForm');
        const familiaSelect = document.getElementById('familia');
        const castaSelect = document.getElementById('castaSelect');
        const searchInput = document.getElementById('searchGame');
        const gamesListUl = document.getElementById('gamesList');

        // O código a partir daqui é o seu original, sem alterações na lógica,
        // pois ele já usa a variável 'db' que agora estamos a importar.

        $(document).ready(function() {
            $('#equipes').select2({ placeholder: 'Selecione as equipes', allowClear: true });
            $('#familia').select2({ placeholder: 'Selecione uma família', allowClear: true });
            $('#compradoPor').select2({ placeholder: 'Selecione o comprador', allowClear: true });
            $('#castaSelect').select2({ placeholder: 'Selecione uma casta', allowClear: true });

            loadUsers();
            loadFamilias();
            loadEquipes();
            loadEditableItems();

            initializeCastaSelect();

            searchInput.addEventListener('focus', function() {
                gamesListUl.style.display = 'block';
            });
        });

        function initializeCastaSelect() {
            castaSelect.innerHTML = '<option value="">Selecione uma família primeiro</option>';
            castaSelect.disabled = true;
            $(castaSelect).trigger('change');
        }

        async function loadUsers() {
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                const select = document.getElementById('compradoPor');
                select.innerHTML = '<option value="">Selecione o comprador</option>';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.nomeDeUsuario) {
                        const option = new Option(data.nomeDeUsuario, data.nomeDeUsuario);
                        select.appendChild(option);
                    }
                });
                $(select).trigger('change.select2');
            } catch (error) {
                console.error("Erro ao carregar usuários: ", error);
                 document.getElementById('compradoPor').innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function loadFamilias() {
             familiaSelect.disabled = true;
            try {
                const q = query(collection(db, 'mitosgameItens'), where("tipo", "==", "familia"));
                const querySnapshot = await getDocs(q);
                familiaSelect.innerHTML = '<option value="">Selecione a família</option>';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const option = new Option(data.nome, doc.id);
                    familiaSelect.appendChild(option);
                });
                 $(familiaSelect).trigger('change.select2');
            } catch (error) {
                console.error("Erro ao carregar famílias: ", error);
                 familiaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            } finally {
                 familiaSelect.disabled = false;
            }
        }

        async function loadEquipes() {
            try {
                const querySnapshot = await getDocs(collection(db, 'clubes'));
                const select = document.getElementById('equipes');
                select.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const option = new Option(data.nome, data.nome);
                    select.appendChild(option);
                });
                 $(select).trigger('change.select2');
            } catch (error) {
                console.error("Erro ao carregar equipes: ", error);
            }
        }

        async function loadEditableItems() {
            try {
                const q = query(collection(db, 'mitosgameItens'));
                onSnapshot(q, (querySnapshot) => {
                    gamesListUl.innerHTML = '';
                    allItemsCache = [];
                    if (querySnapshot.empty) {
                        gamesListUl.innerHTML = '<li>Nenhum item encontrado.</li>';
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const item = { id: doc.id, ...data };
                        allItemsCache.push(item);

                        const li = document.createElement('li');
                        li.className = 'game-item';
                        li.textContent = data.nome || `Item sem nome (ID: ${doc.id})`;
                        li.dataset.id = doc.id;
                        li.onclick = () => loadGameData(item);
                        gamesListUl.appendChild(li);
                    });
                    filterGamesList();
                }, (error) => {
                     console.error("Erro ao carregar itens editáveis (real-time): ", error);
                     gamesListUl.innerHTML = '<li>Erro ao carregar itens.</li>';
                });
            } catch (error) {
                console.error("Erro ao carregar itens editáveis: ", error);
                gamesListUl.innerHTML = '<li>Erro ao carregar itens.</li>';
            }
        }

        searchInput.addEventListener('input', filterGamesList);

        function filterGamesList() {
            const searchTerm = searchInput.value.toLowerCase();
            const listItems = gamesListUl.querySelectorAll('li.game-item');
             listItems.forEach(li => {
                 const itemName = li.textContent.toLowerCase();
                 const isVisible = itemName.includes(searchTerm);
                 li.style.display = isVisible ? 'block' : 'none';
             });
        }

        async function loadCastasForSelectedFamilyEdit(familyId) {
             if (!familyId) {
                 initializeCastaSelect();
                 return;
             }
             castaSelect.disabled = true;
             castaSelect.innerHTML = '<option value="">Carregando castas...</option>';
             $(castaSelect).trigger('change');
             try {
                 const q = query(collection(db, 'mitosgameItens'), where("tipo", "==", "casta"), where("familiaId", "==", familyId));
                 const querySnapshot = await getDocs(q);
                 castaSelect.innerHTML = '<option value="">Selecione a casta</option>';
                 if (querySnapshot.empty) {
                     castaSelect.innerHTML = '<option value="">Nenhuma casta encontrada</option>';
                 } else {
                     querySnapshot.forEach((doc) => {
                         const data = doc.data();
                         const option = new Option(data.nome, data.nome);
                         castaSelect.appendChild(option);
                     });
                 }
                 castaSelect.disabled = false;
             } catch (error) {
                 console.error(`Erro ao carregar castas (Edit) para família ${familyId}: `, error);
                 castaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                 castaSelect.disabled = true;
             } finally {
                 $(castaSelect).trigger('change');
             }
        }

        async function loadGameData(gameData) {
            if (!gameData || !gameData.id) {
                editForm.reset();
                 initializeCastaSelect();
                 $('#familia').val(null).trigger('change');
                 $('#equipes').val(null).trigger('change');
                 $('#compradoPor').val(null).trigger('change');
                currentGameId = null;
                return;
            }
            currentGameId = gameData.id;

            document.querySelectorAll('.game-item').forEach(item => item.classList.remove('selected'));
            const selectedLi = gamesListUl.querySelector(`li[data-id='${gameData.id}']`);
            if (selectedLi) {
                 selectedLi.classList.add('selected');
            }
            
            document.getElementById('name').value = gameData.nome || '';
            document.getElementById('description').value = gameData.descricao || '';
            $('#compradoPor').val(gameData.compradoPor || '').trigger('change');
            document.getElementById('pontosGanhos').value = gameData.pontosGanhos || 0;
            document.getElementById('vitorias').value = gameData.vitorias || 0;
            document.getElementById('empates').value = gameData.empates || 0;
            document.getElementById('derrotas').value = gameData.derrotas || 0;
            document.getElementById('ativo').value = gameData.ativo ? 'yes' : 'no';
            document.getElementById('visivel').value = gameData.visivel === true ? 'yes' : 'no';
            document.getElementById('dataAtivacao').value = gameData.dataAtivacao || '';
            $('#equipes').val(gameData.equipes || []).trigger('change');
            document.getElementById('imagem').value = gameData.imagem || '';
            document.getElementById('tipo').value = gameData.mitoType || 'N/A';

            const familyIdToSelect = gameData.familia || '';
            const castaIdToSelect = gameData.casta || ''; 
            $('#familia').val(familyIdToSelect).trigger('change');

             if (familyIdToSelect) {
                 await loadCastasForSelectedFamilyEdit(familyIdToSelect);

                 let castaName = '';
                 if (castaIdToSelect) {
                     try {
                         const castaDoc = await getDoc(doc(db, 'mitosgameItens', castaIdToSelect));
                         if (castaDoc.exists()) {
                             castaName = castaDoc.data().nome || '';
                         }
                     } catch (error) {
                         console.error("Error fetching casta document: ", error);
                     }
                 }
                 $('#castaSelect').val(castaName).trigger('change');
             } else {
                 initializeCastaSelect();
             }
        }

        familiaSelect.addEventListener('change', function() {
            const selectedFamilyId = this.value;
            loadCastasForSelectedFamilyEdit(selectedFamilyId);
        });

        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentGameId) {
                alert('Por favor, selecione um item da lista para editar.');
                return;
            }

             let isFormValid = true;
             editForm.querySelectorAll('[required]:not(:disabled)').forEach(input => {
                const val = $(input).val();
                 if (!val || (Array.isArray(val) && val.length === 0)) {
                     isFormValid = false;
                     input.closest('.form-group')?.querySelector('.error-message')?.style.display = 'block';
                 } else {
                     input.closest('.form-group')?.querySelector('.error-message')?.style.display = 'none';
                 }
             });

            if (!isFormValid) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            try {
                const gameRef = doc(db, 'mitosgameItens', currentGameId);
                const formData = {
                    nome: document.getElementById('name').value,
                    familia: familiaSelect.value,
                    casta: castaSelect.value,
                    //descricao: document.getElementById('description').value, // Corrected from 'description'
                    descricao: document.getElementById('description').value,
                    equipes: $('#equipes').val() || [],
                    imagem: document.getElementById('imagem').value,
                    compradoPor: document.getElementById('compradoPor').value,
                    pontosGanhos: parseInt(document.getElementById('pontosGanhos').value) || 0,
                    vitorias: parseInt(document.getElementById('vitorias').value) || 0,
                    empates: parseInt(document.getElementById('empates').value) || 0,
                    derrotas: parseInt(document.getElementById('derrotas').value) || 0,
                    ativo: document.getElementById('ativo').value === 'yes',
                    visivel: document.getElementById('visivel').value === 'yes',
                    dataAtivacao: document.getElementById('dataAtivacao').value,
                    //tipo: document.getElementById('tipo').value // 'tipo' is readonly, but let's send it back
                    mitoType: document.getElementById('tipo').value 
                };
                await updateDoc(gameRef, formData);
                alert('Item atualizado com sucesso!');
            } catch (error) {
                console.error("Erro ao atualizar item: ", error);
                alert('Erro ao atualizar item. Verifique o console para detalhes.');
            }
        });

        document.getElementById('deleteButton').addEventListener('click', async function() {
            if (!currentGameId) {
                alert('Por favor, selecione um item da lista para excluir.');
                return;
            }

            const itemToDelete = allItemsCache.find(item => item.id === currentGameId);
            const itemName = itemToDelete ? itemToDelete.nome : `o item selecionado`;

            if (confirm(`Tem certeza que deseja excluir "${itemName}"?`)) {
                try {
                    await deleteDoc(doc(db, 'mitosgameItens', currentGameId));
                    alert(`"${itemName}" excluído com sucesso!`);
                    editForm.reset();
                    $('#familia').val(null).trigger('change');
                    $('#equipes').val(null).trigger('change');
                    $('#compradoPor').val(null).trigger('change');
                    initializeCastaSelect();
                    currentGameId = null;
                } catch (error) {
                    console.error("Erro ao excluir item: ", error);
                    alert('Erro ao excluir item.');
                }
            }
        });
    </script>
</body>
</html>
