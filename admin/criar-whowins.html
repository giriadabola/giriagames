<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar WhoWins - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- 1. Adiciona o nosso guardião de segurança. Ele é o responsável por verificar o login e a permissão. -->
   <script type="module" src="js/auth-guard.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; font-size: 14px; line-height: 1.4; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .content { max-width: 800px; margin: 80px auto 20px; padding: 20px; }
        h1 { color: #1a1a1a; text-align: center; margin-bottom: 30px; }
        .form-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .form-group { margin-bottom: 20px; position: relative; display: flex; align-items: center; gap: 10px; }
        .form-group.highlight-section { background-color: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-group .input-container { flex: 1; position: relative; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; }
        .club-image { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid #ddd; }
        .club-image.placeholder { background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #2176ff; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background-color: #ffffff; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; }
        .search-option { padding: 10px; cursor: pointer; transition: background-color 0.3s ease; }
        .search-option:hover { background-color: #f5f5f5; }
        .submit-btn { background-color: #2176ff; color: #ffffff; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease; width: 100%; margin-top: 20px; }
        .submit-btn:hover { background-color: #1a5cc4; }
    </style>
</head>
<body style="display: none;"> <!-- 2. O corpo da página está oculto por padrão -->

    <nav class="top-menu">
        <a href="javascript:history.back()" class="menu-item"><i class="fas fa-arrow-left"></i></a>
        <a href="engrenagem.html" class="menu-item"><i class="fas fa-home"></i></a>
        <a href="criar-gplayer.html" class="menu-item"><i class="fas fa-user"></i>CRIAR GPLAYER</a>
        <a href="criar-jogo.html" class="menu-item"><i class="fas fa-gamepad"></i>CRIAR JOGO</a>
        <a href="criar-jogadores.html" class="menu-item"><i class="fas fa-users"></i>CRIAR JOGADORES</a>
        <a href="criar-clubes.html" class="menu-item"><i class="fas fa-shield-alt"></i>CRIAR CLUBES</a>
        <a href="criar-competicoes.html" class="menu-item"><i class="fas fa-trophy"></i>CRIAR COMPETIÇÕES</a>
        <a href="criar-pais.html" class="menu-item"><i class="fas fa-globe"></i>CRIAR PAIS</a>
        <a href="criar-mods.html" class="menu-item"><i class="fas fa-puzzle-piece"></i>CRIAR MODS</a>
        <a href="criar-odds.html" class="menu-item"><i class="fas fa-percentage"></i>CRIAR ODDS</a>
    </nav>
    <div class="content">
        <h1>Criar WhoWins</h1>
        <div class="form-container">
            <form id="criar-whowins-form">
                <div class="form-group"><label for="equipa-casa">Equipa Casa</label><div class="club-image placeholder" id="equipa-casa-image"><i class="fas fa-shield-alt"></i></div><div class="input-container"><input type="text" id="equipa-casa" name="equipa-casa" placeholder="Digite para pesquisar..." required><div id="equipa-casa-list" class="search-results"></div></div></div>
                <div class="form-group"><label for="equipa-fora">Equipa Fora</label><div class="club-image placeholder" id="equipa-fora-image"><i class="fas fa-shield-alt"></i></div><div class="input-container"><input type="text" id="equipa-fora" name="equipa-fora" placeholder="Digite para pesquisar..." required><div id="equipa-fora-list" class="search-results"></div></div></div>
                <div class="form-group"><label for="competicao">Competição</label><div class="club-image placeholder" id="competicao-image"><i class="fas fa-trophy"></i></div><div class="input-container"><select id="competicao" name="competicao" required><option value="">Selecione uma competição</option></select></div></div>
                <div class="form-group" style="display: none;"><label for="arena">Arena</label><input type="text" id="arena" name="arena" readonly></div>
                <div class="form-group"><label for="data-jogo">Data do Jogo</label><input type="date" id="data-jogo" name="data-jogo" required></div>
                <div class="form-group"><label for="hora-jogo">Hora do Jogo</label><input type="time" id="hora-jogo" name="hora-jogo" required></div>
                <div class="form-group highlight-section"><label for="inicio-palpite">Início dos Palpites</label><input type="datetime-local" id="inicio-palpite" name="inicio-palpite" required></div>
                <div class="form-group highlight-section"><label for="fim-palpite">Fim dos Palpites</label><input type="datetime-local" id="fim-palpite" name="fim-palpite" required></div>
                <div class="form-group" style="display: none;"><label for="anexado">Anexado</label><select id="anexado" name="anexado"><option value="whowins" selected>whowins</option></select></div>
                <div class="form-group" style="display: none;"><label for="nome-jogo">Nome do Jogo</label><input type="text" id="nome-jogo" name="nome-jogo" required></div>
                <div class="form-group"><label for="temporada">Temporada</label><input type="text" id="temporada" name="temporada" value="2025/2026" required></div>
                <button type="submit" class="submit-btn">Criar WhoWins</button>
            </form>
        </div>
    </div>

    <!-- 3. O script da página foi modificado para usar o guardião -->
    <script type="module">
        // Importa as variáveis 'auth' e 'db' do guardião central.
        import { auth, db } from '/js/auth-guard.js';
        // Importa as outras funções do Firebase que esta página precisa.
        import { collection, addDoc, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // A inicialização do Firebase foi removida daqui, pois já está no auth-guard.js

        let currentUser = null;

        // Mesmo com o guardião, esta página precisa saber qual é o utilizador atual para associar o jogo criado.
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
        });

        // TODAS AS SUAS FUNÇÕES ORIGINAIS PERMANECEM AQUI, SEM ALTERAÇÕES
        async function searchClubs(searchTerm) {
            const clubesRef = collection(db, 'clubes');
            const searchTermLower = searchTerm.toLowerCase();
            const querySnapshot = await getDocs(collection(db, 'clubes'));
            const results = querySnapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(club => club.nome.toLowerCase().includes(searchTermLower));
            return results;
        }
        
        async function loadCompetitions() {
            try {
                const competicoesRef = collection(db, 'competicoes');
                const querySnapshot = await getDocs(competicoesRef);
                const competicaoSelect = document.getElementById('competicao');
                competicaoSelect.innerHTML = '<option value="">Selecione uma competição</option>';
                querySnapshot.forEach(doc => {
                    const competicao = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = competicao.nome;
                    competicaoSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar competições:', error);
            }
        }
        
        async function getLatestRound() {
            const jogosRef = collection(db, 'jogos');
            const querySnapshot = await getDocs(jogosRef);
            let latestRound = 1;
            querySnapshot.forEach(doc => {
                const ronda = doc.data().ronda || 1;
                if (ronda > latestRound) latestRound = ronda;
            });
            return latestRound;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('criar-whowins-form');
            const equipaCasaInput = document.getElementById('equipa-casa');
            const equipaForaInput = document.getElementById('equipa-fora');
            const equipaCasaList = document.getElementById('equipa-casa-list');
            const equipaForaList = document.getElementById('equipa-fora-list');
            const competicaoSelect = document.getElementById('competicao');
            const nomeJogoInput = document.getElementById('nome-jogo');
            let selectedEquipaCasaId = null;
            let selectedEquipaForaId = null;

            await loadCompetitions();

            competicaoSelect.addEventListener('change', async () => {
                const selectedCompetitionId = competicaoSelect.value;
                if (selectedCompetitionId) {
                    try {
                        const competicaoRef = doc(db, 'competicoes', selectedCompetitionId);
                        const competicaoSnap = await getDoc(competicaoRef);
                        if (competicaoSnap.exists()) {
                            const competicaoData = competicaoSnap.data();
                            const arenaInput = document.getElementById('arena');
                            if (!arenaInput.value) {
                                if (competicaoData) {
                                    arenaInput.value = competicaoData.arena || '';
                                } else {
                                    arenaInput.value = '';
                                }
                            }
                            const competicaoImage = document.getElementById('competicao-image');
                            if (competicaoData && competicaoData.imagem) {
                                competicaoImage.innerHTML = `<img src="${competicaoData.imagem}" class="club-image" alt="${competicaoData.nome}">`;
                                competicaoImage.className = 'club-image';
                            } else {
                                competicaoImage.innerHTML = '<i class="fas fa-trophy"></i>';
                                competicaoImage.className = 'club-image placeholder';
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao carregar dados da competição:', error);
                    }
                } else {
                    document.getElementById('arena').value = '';
                }
            });

            equipaCasaInput.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.trim();
                equipaCasaList.innerHTML = '';
                if (searchTerm.length < 2) return;
                try {
                    const clubs = await searchClubs(searchTerm);
                    clubs.forEach(club => {
                        const div = document.createElement('div');
                        div.className = 'search-option';
                        div.textContent = `${club.nome} (${club.pais})`;
                        div.addEventListener('click', async () => {
                            equipaCasaInput.value = club.nome;
                            selectedEquipaCasaId = club.id;
                            equipaCasaList.innerHTML = '';
                            const clubDoc = await getDoc(doc(db, 'clubes', club.id));
                            const clubData = clubDoc.data();
                            const clubImage = document.getElementById('equipa-casa-image');
                            if (clubData && clubData.imagem) {
                                clubImage.innerHTML = `<img src="${clubData.imagem}" class="club-image" alt="${club.nome}">`;
                                clubImage.className = 'club-image';
                            } else {
                                clubImage.innerHTML = '<i class="fas fa-shield-alt"></i>';
                                clubImage.className = 'club-image placeholder';
                            }
                            if (clubData && clubData.competicaoId) {
                                competicaoSelect.value = clubData.competicaoId;
                                const competicaoDoc = await getDoc(doc(db, 'competicoes', clubData.competicaoId));
                                const competicaoData = competicaoDoc.data();
                                const competicaoImage = document.getElementById('competicao-image');
                                if (competicaoData && competicaoData.imagem) {
                                    competicaoImage.innerHTML = `<img src="${competicaoData.imagem}" class="club-image" alt="${competicaoData.nome}">`;
                                    competicaoImage.className = 'club-image';
                                } else {
                                    competicaoImage.innerHTML = '<i class="fas fa-trophy"></i>';
                                    competicaoImage.className = 'club-image placeholder';
                                }
                                const arenaInput = document.getElementById('arena');
                                if (competicaoData && competicaoData.arena) {
                                    arenaInput.value = competicaoData.arena;
                                } else {
                                    arenaInput.value = '';
                                }
                            }
                        });
                        equipaCasaList.appendChild(div);
                    });
                } catch (error) {
                    console.error('Erro ao buscar clubes:', error);
                }
            });

            equipaForaInput.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.trim();
                equipaForaList.innerHTML = '';
                if (searchTerm.length < 2) return;
                try {
                    const clubs = await searchClubs(searchTerm);
                    clubs.forEach(club => {
                        const div = document.createElement('div');
                        div.className = 'search-option';
                        div.textContent = `${club.nome} (${club.pais})`;
                        div.addEventListener('click', async () => {
                            equipaForaInput.value = club.nome;
                            selectedEquipaForaId = club.id;
                            equipaForaList.innerHTML = '';
                            const clubDoc = await getDoc(doc(db, 'clubes', club.id));
                            const clubData = clubDoc.data();
                            const clubImage = document.getElementById('equipa-fora-image');
                            if (clubData && clubData.imagem) {
                                clubImage.innerHTML = `<img src="${clubData.imagem}" class="club-image" alt="${club.nome}">`;
                                clubImage.className = 'club-image';
                            } else {
                                clubImage.innerHTML = '<i class="fas fa-shield-alt"></i>';
                                clubImage.className = 'club-image placeholder';
                            }
                        });
                        equipaForaList.appendChild(div);
                    });
                } catch (error) {
                    console.error('Erro ao buscar clubes:', error);
                }
            });

            function updateGameName() {
                const equipaCasa = equipaCasaInput.value;
                const equipaFora = equipaForaInput.value;
                const dataJogo = document.getElementById('data-jogo').value;
                if (equipaCasa && equipaFora && dataJogo) {
                    const formattedDate = new Date(dataJogo).toLocaleDateString('pt-PT');
                    nomeJogoInput.value = `${equipaCasa} x ${equipaFora} - ${formattedDate}`;
                }
            }

            function setDefaultPredictionTimes() {
                const inicioPalpiteInput = document.getElementById('inicio-palpite');
                const fimPalpiteInput = document.getElementById('fim-palpite');
                const dataJogoInput = document.getElementById('data-jogo');
                const horaJogoInput = document.getElementById('hora-jogo');
                const now = new Date();
                const currentDateTime = now.toISOString().slice(0, 16);
                inicioPalpiteInput.value = currentDateTime;
                function updateFimPalpite() {
                    const gameDate = dataJogoInput.value;
                    const gameTime = horaJogoInput.value;
                    if (gameDate && gameTime) {
                        const gameDateTime = new Date(gameDate + 'T' + gameTime);
                        gameDateTime.setHours(gameDateTime.getHours() - 1);
                        fimPalpiteInput.value = gameDateTime.toISOString().slice(0, 16);
                    }
                }
                dataJogoInput.addEventListener('change', updateFimPalpite);
                horaJogoInput.addEventListener('change', updateFimPalpite);
            }

            setDefaultPredictionTimes();
            document.getElementById('data-jogo').addEventListener('change', updateGameName);
            equipaCasaInput.addEventListener('change', updateGameName);
            equipaForaInput.addEventListener('change', updateGameName);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedEquipaCasaId || !selectedEquipaForaId) {
                    alert('Por favor, selecione ambas as equipas da lista.');
                    return;
                }
                try {
                    const nomeJogo = nomeJogoInput.value;
                    const whoWinsRef = collection(db, 'whowinsJogos');
                    const q = query(whoWinsRef, where('nomeJogo', '==', nomeJogo));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        alert('Já existe um jogo com este nome. Por favor, escolha um nome diferente.');
                        return;
                    }
                    if (!currentUser) {
                        alert('Por favor, faça login para criar um WhoWins.');
                        return;
                    }
                    const whowinsData = {
                        equipaCasaId: selectedEquipaCasaId,
                        equipaCasa: equipaCasaInput.value,
                        equipaForaId: selectedEquipaForaId,
                        equipaFora: equipaForaInput.value,
                        competicaoId: competicaoSelect.value,
                        competicao: competicaoSelect.options[competicaoSelect.selectedIndex].text,
                        arena: document.getElementById('arena').value,
                        dataJogo: new Date(document.getElementById('data-jogo').value),
                        inicioIntervalo: new Date(document.getElementById('inicio-palpite').value),
                        fimIntervalo: document.getElementById('fim-palpite').value ? new Date(document.getElementById('fim-palpite').value) : null,
                        anexado: document.getElementById('anexado').value,
                        nomeJogo: nomeJogoInput.value,
                        temporada: document.getElementById('temporada').value,
                        dataCriacao: new Date(),
                        timestamp: Date.now(),
                        userId: currentUser.uid
                    };
                    await addDoc(collection(db, 'whowinsJogos'), whowinsData);
                    alert('WhoWins criado com sucesso!');
                    form.reset();
                    selectedEquipaCasaId = null;
                    selectedEquipaForaId = null;
                    document.getElementById('equipa-casa-image').innerHTML = '<i class="fas fa-shield-alt"></i>';
                    document.getElementById('equipa-casa-image').className = 'club-image placeholder';
                    document.getElementById('equipa-fora-image').innerHTML = '<i class="fas fa-shield-alt"></i>';
                    document.getElementById('equipa-fora-image').className = 'club-image placeholder';
                    document.getElementById('competicao-image').innerHTML = '<i class="fas fa-trophy"></i>';
                    document.getElementById('competicao-image').className = 'club-image placeholder';
                } catch (error) {
                    console.error('Erro ao criar WhoWins:', error);
                    alert('Erro ao criar WhoWins. Por favor, tente novamente.');
                }
            });
        });
    </script>
</body>
</html>
