<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar WhoWins - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- 1. Adiciona o nosso guardião de segurança. Ele é o responsável por verificar o login e a permissão. -->
    <script type="module" src="js/auth-guard.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; }
        .top-menu { position: fixed; top: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 24px; align-items: center; z-index: 1000; }
        .menu-item { text-decoration: none; color: #666; transition: color 0.3s ease; font-weight: 500; padding: 8px 16px; border-radius: 4px; font-size: 14px; line-height: 1.4; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { color: #2176ff; background-color: rgba(33, 118, 255, 0.1); }
        .content { max-width: 800px; margin: 80px auto 20px; padding: 20px; }
        h1 { color: #1a1a1a; text-align: center; margin-bottom: 30px; }
        .form-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .form-group { margin-bottom: 20px; position: relative; display: flex; align-items: center; gap: 10px; }
        .form-group.highlight-section { background-color: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-group .input-container { flex: 1; position: relative; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; }
        .club-image { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid #ddd; }
        .club-image.placeholder { background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #2176ff; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background-color: #ffffff; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; }
        .search-option { padding: 10px; cursor: pointer; transition: background-color 0.3s ease; }
        .search-option:hover { background-color: #f5f5f5; }
        .submit-btn { background-color: #2176ff; color: #ffffff; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease; width: 100%; margin-top: 20px; }
        .submit-btn:hover { background-color: #1a5cc4; }

        /* --- NOVO CSS PARA O MODAL DAS ARENAS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
        }
        .close-btn:hover {
            color: #000;
        }
        #arenas-list {
            list-style-type: none;
            padding: 0;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
        #arenas-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #arenas-list li:last-child {
            border-bottom: none;
        }
        #arenas-list li:hover {
            background-color: #f5f5f5;
        }
        #arena-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
        }
        /* Ajuste para usar a classe do botão submit no modal */
        #arena-form .form-control {
             width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;
        }
        .floating-arena-icon {
    position: fixed;
    top: 15px;
    right: 20px;
    z-index: 1001; /* Garante que fica acima do menu de topo */
    width: 50px;
    height: 50px;
    background-color: #2176ff; /* Cor primária do seu design */
    color: white;
    border-radius: 50%; /* Para o tornar circular */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    text-decoration: none;
    transition: transform 0.2s ease-in-out;
}

.floating-arena-icon:hover {
    transform: scale(1.1);
    background-color: #1a5cc4; /* Um tom mais escuro no hover */
}

    </style>
</head>
<body style="display: none;"> <!-- O corpo da página está oculto por padrão -->
 <!-- NOVO ÍCONE FLUTUANTE DO GESTOR DE ARENAS -->
    <a href="#" id="manage-arenas-btn" class="floating-arena-icon" title="Gerir Arenas WhoWins">
        <i class="fas fa-landmark"></i>
    </a>

    <nav class="top-menu">
        <a href="javascript:history.back()" class="menu-item"><i class="fas fa-arrow-left"></i></a>
        <a href="engrenagem.html" class="menu-item"><i class="fas fa-home"></i></a>
        <a href="criar-gplayer.html" class="menu-item"><i class="fas fa-user"></i>CRIAR GPLAYER</a>
        <a href="criar-jogo.html" class="menu-item"><i class="fas fa-gamepad"></i>CRIAR JOGO</a>
        <a href="criar-jogadores.html" class="menu-item"><i class="fas fa-users"></i>CRIAR JOGADORES</a>
        <a href="criar-clubes.html" class="menu-item"><i class="fas fa-shield-alt"></i>CRIAR CLUBES</a>
        <a href="criar-competicoes.html" class="menu-item"><i class="fas fa-trophy"></i>CRIAR COMPETIÇÕES</a>
        <a href="criar-pais.html" class="menu-item"><i class="fas fa-globe"></i>CRIAR PAIS</a>
        <a href="criar-mods.html" class="menu-item"><i class="fas fa-puzzle-piece"></i>CRIAR MODS</a>
        <a href="criar-odds.html" class="menu-item"><i class="fas fa-percentage"></i>CRIAR ODDS</a>
       
       
    </nav>
    <div class="content">
        <h1>Criar WhoWins</h1>
        <div class="form-container">
            <form id="criar-whowins-form">
                <div class="form-group"><label for="equipa-casa">Equipa Casa</label><div class="club-image placeholder" id="equipa-casa-image"><i class="fas fa-shield-alt"></i></div><div class="input-container"><input type="text" id="equipa-casa" name="equipa-casa" placeholder="Digite para pesquisar..." required><div id="equipa-casa-list" class="search-results"></div></div></div>
                <div class="form-group"><label for="equipa-fora">Equipa Fora</label><div class="club-image placeholder" id="equipa-fora-image"><i class="fas fa-shield-alt"></i></div><div class="input-container"><input type="text" id="equipa-fora" name="equipa-fora" placeholder="Digite para pesquisar..." required><div id="equipa-fora-list" class="search-results"></div></div></div>
                <div class="form-group"><label for="competicao">Competição</label><div class="club-image placeholder" id="competicao-image"><i class="fas fa-trophy"></i></div><div class="input-container"><select id="competicao" name="competicao" required><option value="">Selecione uma competição</option></select></div></div>
                <div class="form-group" style="display: none;"><label for="arena">Arena</label><input type="text" id="arena" name="arena" readonly></div>
                <div class="form-group"><label for="data-jogo">Data do Jogo</label><input type="date" id="data-jogo" name="data-jogo" required></div>
                <div class="form-group"><label for="hora-jogo">Hora do Jogo</label><input type="time" id="hora-jogo" name="hora-jogo" required></div>
                <div class="form-group highlight-section"><label for="inicio-palpite">Início dos Palpites</label><input type="datetime-local" id="inicio-palpite" name="inicio-palpite" required></div>
                <div class="form-group highlight-section"><label for="fim-palpite">Fim dos Palpites</label><input type="datetime-local" id="fim-palpite" name="fim-palpite" required></div>
                <div class="form-group" style="display: none;"><label for="anexado">Anexado</label><select id="anexado" name="anexado"><option value="whowins" selected>whowins</option></select></div>
                <div class="form-group" style="display: none;"><label for="nome-jogo">Nome do Jogo</label><input type="text" id="nome-jogo" name="nome-jogo" required></div>
                <div class="form-group"><label for="temporada">Temporada</label><input type="text" id="temporada" name="temporada" value="2025/2026" required></div>
                <button type="submit" class="submit-btn">Criar WhoWins</button>
            </form>
        </div>
    </div>

    <!-- NOVO HTML PARA O MODAL DAS ARENAS -->
    <div id="arena-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span id="close-arena-modal" class="close-btn">&times;</span>
            <h2>Gerir Arenas WhoWins</h2>
    
            <!-- Vista da Lista de Arenas -->
            <div id="arena-list-view">
                <button id="show-create-arena-form-btn" class="submit-btn" style="margin: 0 0 20px 0;">Criar Nova Arena</button>
                <p>Selecione uma arena para editar:</p>
                <ul id="arenas-list">
                    <!-- A lista de arenas será preenchida via JavaScript -->
                </ul>
            </div>
    
            <!-- Vista do Formulário de Criação/Edição -->
            <div id="arena-form-view" style="display: none;">
                <h3 id="arena-form-title"></h3>
                <form id="arena-form">
                    <input type="hidden" id="arena-name-hidden">
                    <div class="form-group"><label for="arena-image">Link da Imagem</label><input type="url" id="arena-image" class="form-control" placeholder="https://exemplo.com/imagem.png"></div>
                    <div class="form-group"><label for="arena-video">Link do Vídeo (Opcional)</label><input type="url" id="arena-video" class="form-control" placeholder="https://exemplo.com/video.mp4"></div>
                    <div class="form-group"><label for="arena-nota">Nota (Descrição)</label><textarea id="arena-nota" class="form-control" rows="3"></textarea></div>
                    <div class="form-group"><label for="arena-fama">Fama (Número)</label><input type="number" id="arena-fama" class="form-control" placeholder="Ex: 100"></div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="submit-btn" style="margin-top: 0;">Salvar</button>
                        <button type="button" id="cancel-arena-edit-btn" class="submit-btn" style="background-color: #6c757d; margin-top: 0;">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    

    <!-- O script da página foi modificado para usar o guardião e incluir a nova funcionalidade -->
    <script type="module">
        // Importa as variáveis 'auth' e 'db' do guardião central.
        import { db, auth } from './js/auth-guard.js';
        // Importa as outras funções do Firebase que esta página precisa (updateDoc foi adicionado).
        import { collection, addDoc, getDocs, query, where, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
        });

        // FUNÇÕES ORIGINAIS DO FORMULÁRIO 'CRIAR WHOWINS'
        async function searchClubs(searchTerm) {
            const clubesRef = collection(db, 'clubes');
            const searchTermLower = searchTerm.toLowerCase();
            const querySnapshot = await getDocs(collection(db, 'clubes'));
            const results = querySnapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(club => club.nome.toLowerCase().includes(searchTermLower));
            return results;
        }
        
        async function loadCompetitions() {
            try {
                const competicoesRef = collection(db, 'competicoes');
                const querySnapshot = await getDocs(competicoesRef);
                const competicaoSelect = document.getElementById('competicao');
                competicaoSelect.innerHTML = '<option value="">Selecione uma competição</option>';
                querySnapshot.forEach(doc => {
                    const competicao = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = competicao.nome;
                    competicaoSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar competições:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('criar-whowins-form');
            const equipaCasaInput = document.getElementById('equipa-casa');
            const equipaForaInput = document.getElementById('equipa-fora');
            const equipaCasaList = document.getElementById('equipa-casa-list');
            const equipaForaList = document.getElementById('equipa-fora-list');
            const competicaoSelect = document.getElementById('competicao');
            const nomeJogoInput = document.getElementById('nome-jogo');
            let selectedEquipaCasaId = null;
            let selectedEquipaForaId = null;

            await loadCompetitions();

            competicaoSelect.addEventListener('change', async () => {
                const selectedCompetitionId = competicaoSelect.value;
                if (selectedCompetitionId) {
                    try {
                        const competicaoRef = doc(db, 'competicoes', selectedCompetitionId);
                        const competicaoSnap = await getDoc(competicaoRef);
                        if (competicaoSnap.exists()) {
                            const competicaoData = competicaoSnap.data();
                            const arenaInput = document.getElementById('arena');
                            if (!arenaInput.value) {
                                if (competicaoData) {
                                    arenaInput.value = competicaoData.arena || '';
                                } else {
                                    arenaInput.value = '';
                                }
                            }
                            const competicaoImage = document.getElementById('competicao-image');
                            if (competicaoData && competicaoData.imagem) {
                                competicaoImage.innerHTML = `<img src="${competicaoData.imagem}" class="club-image" alt="${competicaoData.nome}">`;
                                competicaoImage.className = 'club-image';
                            } else {
                                competicaoImage.innerHTML = '<i class="fas fa-trophy"></i>';
                                competicaoImage.className = 'club-image placeholder';
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao carregar dados da competição:', error);
                    }
                } else {
                    document.getElementById('arena').value = '';
                }
            });

            equipaCasaInput.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.trim();
                equipaCasaList.innerHTML = '';
                if (searchTerm.length < 2) return;
                try {
                    const clubs = await searchClubs(searchTerm);
                    clubs.forEach(club => {
                        const div = document.createElement('div');
                        div.className = 'search-option';
                        div.textContent = `${club.nome} (${club.pais})`;
                        div.addEventListener('click', async () => {
                            equipaCasaInput.value = club.nome;
                            selectedEquipaCasaId = club.id;
                            equipaCasaList.innerHTML = '';
                            const clubDoc = await getDoc(doc(db, 'clubes', club.id));
                            const clubData = clubDoc.data();
                            const clubImage = document.getElementById('equipa-casa-image');
                            if (clubData && clubData.imagem) {
                                clubImage.innerHTML = `<img src="${clubData.imagem}" class="club-image" alt="${club.nome}">`;
                                clubImage.className = 'club-image';
                            } else {
                                clubImage.innerHTML = '<i class="fas fa-shield-alt"></i>';
                                clubImage.className = 'club-image placeholder';
                            }
                            if (clubData && clubData.competicaoId) {
                                competicaoSelect.value = clubData.competicaoId;
                                competicaoSelect.dispatchEvent(new Event('change')); // Dispara o evento para carregar dados da competição
                            }
                        });
                        equipaCasaList.appendChild(div);
                    });
                } catch (error) {
                    console.error('Erro ao buscar clubes:', error);
                }
            });

            equipaForaInput.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.trim();
                equipaForaList.innerHTML = '';
                if (searchTerm.length < 2) return;
                try {
                    const clubs = await searchClubs(searchTerm);
                    clubs.forEach(club => {
                        const div = document.createElement('div');
                        div.className = 'search-option';
                        div.textContent = `${club.nome} (${club.pais})`;
                        div.addEventListener('click', async () => {
                            equipaForaInput.value = club.nome;
                            selectedEquipaForaId = club.id;
                            equipaForaList.innerHTML = '';
                            const clubDoc = await getDoc(doc(db, 'clubes', club.id));
                            const clubData = clubDoc.data();
                            const clubImage = document.getElementById('equipa-fora-image');
                            if (clubData && clubData.imagem) {
                                clubImage.innerHTML = `<img src="${clubData.imagem}" class="club-image" alt="${club.nome}">`;
                                clubImage.className = 'club-image';
                            } else {
                                clubImage.innerHTML = '<i class="fas fa-shield-alt"></i>';
                                clubImage.className = 'club-image placeholder';
                            }
                        });
                        equipaForaList.appendChild(div);
                    });
                } catch (error) {
                    console.error('Erro ao buscar clubes:', error);
                }
            });

            function updateGameName() {
                const equipaCasa = equipaCasaInput.value;
                const equipaFora = equipaForaInput.value;
                const dataJogo = document.getElementById('data-jogo').value;
                if (equipaCasa && equipaFora && dataJogo) {
                    const formattedDate = new Date(dataJogo).toLocaleDateString('pt-PT');
                    nomeJogoInput.value = `${equipaCasa} x ${equipaFora} - ${formattedDate}`;
                }
            }

            function setDefaultPredictionTimes() {
                const inicioPalpiteInput = document.getElementById('inicio-palpite');
                const fimPalpiteInput = document.getElementById('fim-palpite');
                const dataJogoInput = document.getElementById('data-jogo');
                const horaJogoInput = document.getElementById('hora-jogo');
                const now = new Date();
                const currentDateTime = now.toISOString().slice(0, 16);
                inicioPalpiteInput.value = currentDateTime;
                function updateFimPalpite() {
                    const gameDate = dataJogoInput.value;
                    const gameTime = horaJogoInput.value;
                    if (gameDate && gameTime) {
                        const gameDateTime = new Date(gameDate + 'T' + gameTime);
                        gameDateTime.setHours(gameDateTime.getHours() - 1);
                        fimPalpiteInput.value = gameDateTime.toISOString().slice(0, 16);
                    }
                }
                dataJogoInput.addEventListener('change', updateFimPalpite);
                horaJogoInput.addEventListener('change', updateFimPalpite);
            }

            setDefaultPredictionTimes();
            document.getElementById('data-jogo').addEventListener('change', updateGameName);
            equipaCasaInput.addEventListener('change', updateGameName);
            equipaForaInput.addEventListener('change', updateGameName);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedEquipaCasaId || !selectedEquipaForaId) {
                    alert('Por favor, selecione ambas as equipas da lista.');
                    return;
                }
                try {
                    updateGameName(); // Garante que o nome do jogo está atualizado
                    const nomeJogo = nomeJogoInput.value;
                    const whoWinsRef = collection(db, 'whowinsJogos');
                    const q = query(whoWinsRef, where('nomeJogo', '==', nomeJogo));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        alert('Já existe um jogo com este nome. Por favor, escolha um nome diferente.');
                        return;
                    }
                    if (!currentUser) {
                        alert('Por favor, faça login para criar um WhoWins.');
                        return;
                    }
                    const whowinsData = {
                        equipaCasaId: selectedEquipaCasaId,
                        equipaCasa: equipaCasaInput.value,
                        equipaForaId: selectedEquipaForaId,
                        equipaFora: equipaForaInput.value,
                        competicaoId: competicaoSelect.value,
                        competicao: competicaoSelect.options[competicaoSelect.selectedIndex].text,
                        arena: document.getElementById('arena').value,
                        dataJogo: new Date(document.getElementById('data-jogo').value + 'T' + document.getElementById('hora-jogo').value),
                        inicioIntervalo: new Date(document.getElementById('inicio-palpite').value),
                        fimIntervalo: document.getElementById('fim-palpite').value ? new Date(document.getElementById('fim-palpite').value) : null,
                        anexado: document.getElementById('anexado').value,
                        nomeJogo: nomeJogoInput.value,
                        temporada: document.getElementById('temporada').value,
                        dataCriacao: new Date(),
                        timestamp: Date.now(),
                        userId: currentUser.uid
                    };
                    await addDoc(collection(db, 'whowinsJogos'), whowinsData);
                    alert('WhoWins criado com sucesso!');
                    form.reset();
                    selectedEquipaCasaId = null;
                    selectedEquipaForaId = null;
                    document.getElementById('equipa-casa-image').innerHTML = '<i class="fas fa-shield-alt"></i>';
                    document.getElementById('equipa-casa-image').className = 'club-image placeholder';
                    document.getElementById('equipa-fora-image').innerHTML = '<i class="fas fa-shield-alt"></i>';
                    document.getElementById('equipa-fora-image').className = 'club-image placeholder';
                    document.getElementById('competicao-image').innerHTML = '<i class="fas fa-trophy"></i>';
                    document.getElementById('competicao-image').className = 'club-image placeholder';
                    setDefaultPredictionTimes();
                } catch (error) {
                    console.error('Erro ao criar WhoWins:', error);
                    alert('Erro ao criar WhoWins. Por favor, tente novamente.');
                }
            });

            // --- NOVO CÓDIGO DO GESTOR DE ARENAS ---

            const manageArenasBtn = document.getElementById('manage-arenas-btn');
            const arenaModal = document.getElementById('arena-modal');
            const closeArenaModalBtn = document.getElementById('close-arena-modal');
            const arenaListView = document.getElementById('arena-list-view');
            const arenaFormView = document.getElementById('arena-form-view');
            const arenasList = document.getElementById('arenas-list');
            const showCreateArenaFormBtn = document.getElementById('show-create-arena-form-btn');
            const arenaForm = document.getElementById('arena-form');
            const arenaFormTitle = document.getElementById('arena-form-title');
            const cancelArenaEditBtn = document.getElementById('cancel-arena-edit-btn');
            const arenaNameHidden = document.getElementById('arena-name-hidden');

            let arenasData = {};

            async function loadAndDisplayArenas() {
                try {
                    const docRef = doc(db, 'paineis', 'paineis arena');
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        arenasData = docSnap.data();
                        arenasList.innerHTML = ''; 

                        const sortedKeys = Object.keys(arenasData).sort((a, b) => {
                           const numA = parseInt(a.match(/\d+/)?.[0] || 0);
                           const numB = parseInt(b.match(/\d+/)?.[0] || 0);
                           return numA - numB;
                        });

                        sortedKeys.forEach(key => {
                            const li = document.createElement('li');
                            li.textContent = key;
                            li.dataset.arenaName = key;
                            li.addEventListener('click', () => showEditForm(key));
                            arenasList.appendChild(li);
                        });
                    } else {
                        console.log("Documento 'paineis arena' não encontrado!");
                        arenasList.innerHTML = '<li>Nenhuma arena encontrada. Clique em "Criar" para adicionar a primeira.</li>';
                        arenasData = {};
                    }
                } catch (error) {
                    console.error("Erro ao carregar arenas:", error);
                    alert("Não foi possível carregar as arenas.");
                }
            }
            
            function showEditForm(arenaName) {
                const data = arenasData[arenaName];
                if (!data) return;

                arenaForm.reset();
                arenaFormTitle.textContent = `Editar: ${arenaName}`;
                arenaNameHidden.value = arenaName;
                
                document.getElementById('arena-image').value = data.image || '';
                document.getElementById('arena-video').value = data.video || '';
                document.getElementById('arena-nota').value = data.nota || '';
                document.getElementById('arena-fama').value = data.fama || '';

                arenaListView.style.display = 'none';
                arenaFormView.style.display = 'block';
            }

            function showCreateForm() {
                arenaForm.reset();
                arenaFormTitle.textContent = 'Criar Nova Arena';
                arenaNameHidden.value = '';

                arenaListView.style.display = 'none';
                arenaFormView.style.display = 'block';
            }

            function showListView() {
                arenaListView.style.display = 'block';
                arenaFormView.style.display = 'none';
            }

            manageArenasBtn.addEventListener('click', (e) => {
                e.preventDefault();
                arenaModal.style.display = 'flex';
                showListView();
                loadAndDisplayArenas();
            });

            closeArenaModalBtn.addEventListener('click', () => {
                arenaModal.style.display = 'none';
            });
            
            arenaModal.addEventListener('click', (e) => {
                if (e.target === arenaModal) {
                    arenaModal.style.display = 'none';
                }
            });

            showCreateArenaFormBtn.addEventListener('click', showCreateForm);
            cancelArenaEditBtn.addEventListener('click', showListView);

            arenaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.submitter;
                btn.disabled = true;
                btn.textContent = 'Salvando...';

                let arenaName = arenaNameHidden.value;
                const isCreating = !arenaName;

                if (isCreating) {
                    const arenaNumbers = Object.keys(arenasData).map(k => parseInt(k.match(/\d+/)?.[0] || 0));
                    const nextNumber = arenaNumbers.length > 0 ? Math.max(...arenaNumbers) + 1 : 1;
                    arenaName = `Arena ${nextNumber}`;
                }

                const dataToSave = {
                    image: document.getElementById('arena-image').value,
                    video: document.getElementById('arena-video').value,
                    nota: document.getElementById('arena-nota').value,
                    fama: Number(document.getElementById('arena-fama').value) || 0
                };

                try {
                    const docRef = doc(db, 'paineis', 'paineis arena');
                    await updateDoc(docRef, {
                        [arenaName]: dataToSave
                    }, { merge: true }); // Usar merge para não apagar outras arenas
                    
                    alert(`Arena '${arenaName}' salva com sucesso!`);
                    arenaModal.style.display = 'none';
                } catch (error) {
                    if (error.code === 'not-found') {
                        // Se o documento não existe, cria-o
                        await setDoc(docRef, { [arenaName]: dataToSave });
                        alert(`Arena '${arenaName}' criada com sucesso!`);
                        arenaModal.style.display = 'none';
                    } else {
                        console.error("Erro ao salvar arena:", error);
                        alert("Ocorreu um erro ao salvar. Tente novamente.");
                    }
                } finally {
                     btn.disabled = false;
                     btn.textContent = 'Salvar';
                }
            });
        });
    </script>
</body>
</html>
