<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Odds - G EMPIRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        .top-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 12px;
            align-items: center;
            z-index: 1000;
            flex-wrap: wrap;
        }
        .menu-item {
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease, background-color 0.3s ease;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.4;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .menu-item:hover, .menu-item.active {
            color: #2176ff;
            background-color: rgba(33, 118, 255, 0.1);
        }
        .content {
            padding: 80px 20px 20px;
            padding-top: calc(60px + 24px);
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            width: 550px;
            max-width: 95%;
            margin: 0 auto;
        }
        .search-container {
            position: relative;
            margin-bottom: 30px;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .search-results {
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            border-top: none;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            position: absolute;
            width: 100%;
            top: 100%;
            left: 0;
            z-index: 1001;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }
        .form-group select,
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="url"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }
        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
            vertical-align: middle;
        }
        .form-group select {
             appearance: none;
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
             background-repeat: no-repeat;
             background-position: right 10px top 50%;
             background-size: .65em auto;
             padding-right: 30px;
        }
        .select2-container {
            width: 100% !important;
        }
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            min-height: 42px;
            font-size: 15px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 3px;
            font-size: 13px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: rgba(255,255,255,0.7);
            margin-right: 5px;
            cursor: pointer;
            font-size: 14px;
        }
         .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
             color: white;
         }
         .select2-container--default .select2-search--inline .select2-search__field {
             margin-top: 5px;
             font-size: 15px;
         }
         .select2-dropdown {
             border: 1px solid #ddd;
             border-radius: 4px;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
         }
        button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, opacity 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
             opacity: 0.6;
             cursor: not-allowed;
        }
        .button-group button {
            width: auto;
            padding: 8px 12px;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 0;
            font-weight: normal;
        }
         .button-group button#limparSelecao {
             background-color: #dc3545;
         }
         .button-group button#limparSelecao:hover:not(:disabled) {
              background-color: #c82333;
          }
        #categoriaNome,
        #subcategoriaNome,
        #terceiraCategoriaNome {
            display: none;
        }
        .tree-view-toggle-container {
            text-align: left;
        }
        .tree-view-button {
            width: auto;
            padding: 10px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
            margin-top: 0;
        }
        .tree-view-button:hover {
            background-color: #5a6268;
        }
        .tree-view-button .toggle-icon {
            transition: transform 0.3s ease;
        }
        .tree-view-button.open .toggle-icon {
            transform: rotate(180deg);
        }
        .odds-tree-view-area {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
            max-height: 450px;
            overflow-y: auto;
        }
        .odds-tree-view-area ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        .odds-tree-view-area .tree-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            box-sizing: border-box;
        }
        .odds-tree-view-area .tree-item:last-child {
            border-bottom: none;
        }
        .odds-tree-view-area .tree-item:hover {
            background-color: #e9e9e9;
        }
        .odds-tree-view-area .tree-item-content {
            display: flex;
            align-items: center;
            flex-grow: 1;
            flex-shrink: 1;
            min-width: 50px;
            overflow: hidden;
            padding-right: 8px;
        }
        .odds-tree-view-area .tree-item-name-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 0;
            overflow: hidden;
            cursor: default;
        }
        .odds-tree-view-area .tree-item-name-container.toggleable {
            cursor: pointer;
        }
        .odds-tree-view-area .tree-toggle-icon {
            margin-right: 6px;
            transition: transform 0.2s ease-in-out;
            width: 1em;
            color: #555;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        .odds-tree-view-area .tree-toggle-icon.no-toggle {
            visibility: hidden;
        }
        .odds-tree-view-area li.expanded > .tree-item .tree-item-name-container .tree-toggle-icon:not(.no-toggle) {
            transform: rotate(90deg);
        }
        .odds-tree-view-area .tree-item-name {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .odds-tree-view-area .tree-item-name.categoria { font-weight: bold; color: #333; }
        .odds-tree-view-area .tree-item-name.subcategoria { color: #2a6099; }
        .odds-tree-view-area .tree-item-name.terceira-categoria { color: #5a8d5a; }
        .odds-tree-view-area .tree-item-details {
            font-size: 0.85em;
            color: #777;
            margin-left: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .odds-tree-view-area .edit-tree-item-btn {
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: auto;
            padding: 3px 6px !important;
            font-size: 10px !important;
            line-height: 1.2 !important;
            background-color: #007bff !important;
            color: white !important;
            border: none !important;
            border-radius: 3px !important;
            cursor: pointer !important;
            white-space: nowrap !important;
            width: auto !important;
            margin-top: 0 !important;
            margin-left: auto;
        }
        .odds-tree-view-area .edit-tree-item-btn:hover {
            background-color: #0056b3 !important;
        }
        .odds-tree-view-area ul.sub-list,
        .odds-tree-view-area ul.sub-sub-list {
            display: none;
            padding-left: 25px;
            border-left: 1px solid #ccc;
            margin-left: 10px;
        }
        .odds-tree-view-area li.expanded > ul.sub-list,
        .odds-tree-view-area li.expanded > ul.sub-sub-list {
            display: block;
        }
        .odds-tree-view-area .loading-text,
        .odds-tree-view-area .error-text {
            padding: 10px;
            text-align: center;
            color: #777;
        }
        .odds-tree-view-area .error-text {
            color: red;
        }
        #deleteOddButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1005;
            margin: 0;
            padding: 0;
        }
        #deleteOddButton:hover {
            background-color: #c82333;
        }
        #deleteConfirmPopup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 15px;
        }
        .popup-content {
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }
        .popup-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        .popup-content p {
            margin-bottom: 25px;
            color: #555;
            font-size: 15px;
        }
        .popup-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .popup-buttons button {
            width: auto;
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 500;
        }
        .popup-buttons #confirmDeleteBtn {
            background-color: #dc3545;
        }
        .popup-buttons #confirmDeleteBtn:hover:not(:disabled) {
            background-color: #c82333;
        }
        .popup-buttons #cancelDeleteBtn {
            background-color: #28a745;
            color: white;
        }
        .popup-buttons #cancelDeleteBtn:hover:not(:disabled) {
            background-color: #218838;
        }
        @media (max-width: 992px) {
             .top-menu { justify-content: flex-start; padding-left: 15px; padding-right: 15px; gap: 8px; }
             .menu-item { padding: 6px 10px; font-size: 12px; }
              .menu-item .fas { font-size: 14px; }
             .content { padding-top: 100px; }
         }
         @media (max-width: 768px) {
              .top-menu { gap: 5px; }
              .menu-item span { display: none; }
              .menu-item .fas { margin-right: 0; }
              .menu-item { padding: 8px; }
              .content { padding-top: 80px; }
              .container { width: 95%; padding: 20px; }
              .search-results { max-width: 100%; }
              .tree-view-toggle-container { padding: 0 10px; }
              .odds-tree-view-area { max-height: 350px; }
              .odds-tree-view-area .tree-item-name { font-size: 13px; }
              .odds-tree-view-area .edit-tree-item-btn { padding: 3px 6px !important; font-size: 10px !important; width: auto !important; }
              #deleteOddButton { width: 45px; height: 45px; font-size: 18px; bottom: 15px; right: 15px; }
         }
          @media (max-width: 480px) {
               h1 { font-size: 24px; }
               .form-group label { font-size: 13px; }
               .form-group input, .form-group select, .select2-container--default .select2-selection--multiple { font-size: 14px; }
               button { font-size: 15px; }
               .button-group button { font-size: 13px;}
               .tree-view-button { font-size: 14px; }
               .odds-tree-view-area .edit-tree-item-btn { font-size: 9px !important; padding: 2px 4px !important; }
               .popup-content { padding: 20px; }
               .popup-buttons button { padding: 8px 15px; font-size: 14px; }
          }
        .odds-tree-view-area .delete-tree-item-btn {
            flex-grow: 0; flex-shrink: 0; flex-basis: auto; padding: 3px 6px !important; font-size: 10px !important; line-height: 1.2 !important; background-color: #dc3545 !important; color: white !important; border: none !important; border-radius: 3px !important; cursor: pointer !important; white-space: nowrap !important; width: auto !important; margin-top: 0 !important; margin-left: 5px;
        }
        .odds-tree-view-area .delete-tree-item-btn:hover { background-color: #c82333 !important; }
        @media (max-width: 480px) { .odds-tree-view-area .delete-tree-item-btn { font-size: 9px !important; padding: 2px 4px !important; } }
        .odds-tree-view-area .move-tree-item-btn {
            flex-grow: 0; flex-shrink: 0; flex-basis: auto; padding: 3px 6px !important; font-size: 10px !important; line-height: 1.2 !important; color: white !important; border: none !important; border-radius: 3px !important; cursor: pointer !important; width: auto !important; margin-top: 0 !important; margin-left: 5px;
        }
        .odds-tree-view-area .move-up-btn { background-color: #28a745 !important; }
        .odds-tree-view-area .move-up-btn:hover { background-color: #218838 !important; }
        .odds-tree-view-area .move-down-btn { background-color: #ffc107 !important; color: #212529 !important; }
        .odds-tree-view-area .move-down-btn:hover { background-color: #e0a800 !important; }
        @media (max-width: 480px) { .odds-tree-view-area .move-tree-item-btn { font-size: 9px !important; padding: 2px 4px !important; } }
        .odds-tree-view-area .order-input {
            width: 50px !important; padding: 3px 6px !important; font-size: 10px !important; line-height: 1.2 !important; text-align: center; border: 1px solid #ccc !important; border-radius: 3px !important; margin-left: auto; margin-right: 5px;
        }
        .odds-tree-view-area .order-input:disabled { background-color: #e9ecef; cursor: wait; }
    </style>
</head>
<body style="display: none;">

    <nav class="top-menu">
        <a href="engrenagem.html" class="menu-item"><i class="fas fa-home"></i><span>HOME</span></a>
        <a href="criar-gplayer.html" class="menu-item"><i class="fas fa-user"></i><span>CRIAR GPLAYER</span></a>
        <a href="criar-jogo.html" class="menu-item"><i class="fas fa-gamepad"></i><span>CRIAR JOGO</span></a>
        <a href="criar-jogadores.html" class="menu-item"><i class="fas fa-users"></i><span>CRIAR JOGADORES</span></a>
        <a href="criar-clubes.html" class="menu-item"><i class="fas fa-shield-alt"></i><span>CRIAR CLUBES</span></a>
        <a href="criar-competicoes.html" class="menu-item"><i class="fas fa-trophy"></i><span>CRIAR COMPETIÇÕES</span></a>
        <a href="criar-pais.html" class="menu-item"><i class="fas fa-globe"></i><span>CRIAR PAÍS</span></a>
        <a href="criar-mods.html" class="menu-item"><i class="fas fa-puzzle-piece"></i><span>CRIAR MODS</span></a>
        <a href="editar-odds.html" class="menu-item active"><i class="fas fa-percentage"></i><span>EDITAR ODDS</span></a>
        <a href="criar-odds.html" class="menu-item"><i class="fas fa-plus-circle"></i><span>CRIAR ODDS</span></a>
    </nav>

    <div class="content">
        <h1>Editar Odds</h1>
        <div class="tree-view-toggle-container" style="max-width: 1200px; margin: 0 auto 20px auto; padding: 0 20px;">
            <button id="toggleTreeViewButton" type="button" class="tree-view-button" aria-expanded="false">
                <i class="fas fa-sitemap"></i> Mostrar Estrutura de Odds <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <div id="oddsTreeView" class="odds-tree-view-area" style="display: none;"></div>
        </div>
        <div class="container">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Pesquisar odd por nome ou índice..." id="searchInput" autocomplete="off">
                <div class="search-results" id="searchResults"></div>
            </div>
            <form id="editarOddForm">
                <div class="form-group"><label for="tipoCategoria">Tipo de Categoria</label><select id="tipoCategoria" name="tipoCategoria" required><option value="" disabled selected>Selecione o Tipo de Categoria</option><option value="categoria">Categoria</option><option value="subcategoria">Subcategoria</option><option value="3cat">3ª Categoria</option></select></div>
                <div class="form-group"><label for="categoriaDropdown">Categoria</label><select id="categoriaDropdown" name="categoriaDropdown" required><option value="" disabled selected>Selecione a Categoria</option></select></div>
                <div class="form-group" id="categoriaNome"><label for="nomeCategoriaInput">Nome da Categoria</label><input type="text" id="nomeCategoriaInput" name="nomeCategoriaInput"></div>
                <div class="form-group" id="subcategoriaDropdown" style="display: none;"><label for="subcategoriaPai">Subcategoria</label><select id="subcategoriaPai" name="subcategoriaPai" required><option value="" disabled selected>Selecione a Subcategoria</option></select></div>
                <div class="form-group" id="subcategoriaNome"><label for="nomeSubcategoriaInput">Nome da Subcategoria</label><input type="text" id="nomeSubcategoriaInput" name="nomeSubcategoriaInput"></div>
                <div class="form-group" id="terceiraCategoriaNome"><label for="nomeTerceiraCategoriaInput">Nome da 3ª Categoria</label><input type="text" id="nomeTerceiraCategoriaInput" name="nomeTerceiraCategoriaInput"></div>
                <div class="form-group"><label for="indiceIngles">Indice Inglês</label><input type="text" id="indiceIngles" name="indiceIngles" required></div>
                <div class="form-group"><label for="breveDescricao">Breve Descrição</label><input type="text" id="breveDescricao" name="breveDescricao"></div>
                <div class="form-group"><label for="ordem">Ordem (para exibição)</label><input type="number" id="ordem" name="ordem" placeholder="Ex: 10" required></div>
                <div class="form-group"><label for="icon">Icon / Emoji</label><input type="text" id="icon" name="icon" placeholder="Ex: ⚽ ou https://url.to/icon.png" required></div>
                <div class="form-group"><label for="competicoes">Associar a Competições</label><div class="button-group" style="margin-bottom: 10px;"><button type="button" id="selecionarTudo">Selecionar Todas</button><button type="button" id="limparSelecao">Limpar Seleção</button></div><select id="competicoes" name="competicoes" multiple></select></div>
                <div class="form-group"><label for="ativado"><input type="checkbox" id="ativado" name="ativado" value="true">Ativado? <span style="font-size: 0.9em; color: #777; font-weight: normal;">(Desmarque para desativar esta odd)</span></label></div>
                <button type="submit" id="submitButton">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <button id="deleteOddButton" title="Remover Odd Carregada"><i class="fas fa-trash-alt"></i></button>
    <div id="deleteConfirmPopup"><div class="popup-content"><h3>Confirmar Exclusão</h3><p>Tem certeza que deseja remover esta odd permanentemente? Esta ação não pode ser desfeita.</p><div class="popup-buttons"><button id="confirmDeleteBtn" type="button">Sim, Remover</button><button id="cancelDeleteBtn" type="button">Não</button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/pt.js"></script>

    <script type="module">
        // ===================================================================
        // PARTE 1: INICIALIZAÇÃO DO FIREBASE E GUARDIÃO DE SEGURANÇA
        // ===================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.firebasestorage.app",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };

        if (!firebase.apps.length) {
             firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const timestamp = firebase.firestore.FieldValue.serverTimestamp;

        const ROLES_PERMITIDAS = ["ruler", "estafeta"];

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDocRef = db.collection("users").doc(user.uid);
                const userDoc = await userDocRef.get();
                if (userDoc.exists && ROLES_PERMITIDAS.includes(userDoc.data().estatuto)) {
                    document.body.style.display = 'block';
                    initializePage();
                } else {
                    window.location.replace('/acesso-negado.html');
                }
            } else {
                window.location.replace('/login.html');
            }
        });

        // ===================================================================
        // PARTE 2: CÓDIGO ORIGINAL DA PÁGINA (FUNÇÕES E VARIÁVEIS)
        // ===================================================================
        const tipoCategoriaSelect = document.getElementById('tipoCategoria');
        const categoriaDropdown = document.getElementById('categoriaDropdown');
        const categoriaNomeDiv = document.getElementById('categoriaNome');
        const nomeCategoriaInput = document.getElementById('nomeCategoriaInput');
        const subcategoriaNomeDiv = document.getElementById('subcategoriaNome');
        const nomeSubcategoriaInput = document.getElementById('nomeSubcategoriaInput');
        const terceiraCategoriaNomeDiv = document.getElementById('terceiraCategoriaNome');
        const nomeTerceiraCategoriaInput = document.getElementById('nomeTerceiraCategoriaInput');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const editarOddForm = document.getElementById('editarOddForm');
        const indiceInglesInput = document.getElementById('indiceIngles');
        const breveDescricaoInput = document.getElementById('breveDescricao');
        const ordemInput = document.getElementById('ordem');
        const iconInput = document.getElementById('icon');
        const ativadoCheckbox = document.getElementById('ativado');
        const competicoesSelect = $('#competicoes');
        const submitButton = document.getElementById('submitButton');
        const subcategoriaPaiSelect = document.getElementById('subcategoriaPai');
        const toggleTreeViewButton = document.getElementById('toggleTreeViewButton');
        const oddsTreeViewDiv = document.getElementById('oddsTreeView');
        const deleteOddButton = document.getElementById('deleteOddButton');
        const deleteConfirmPopup = document.getElementById('deleteConfirmPopup');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        let selectedOddId = null;
        let originalOddData = null;
        let allCompeticoesData = [];
        let oddIdToDelete = null;

        async function loadSubcategorias() {
            try {
                subcategoriaPaiSelect.innerHTML = '<option value="" disabled selected>Selecione a Subcategoria</option>';
                const snapshot = await db.collection('oddcategorias').where('categoria_subcategoria_3cat', '==', 'subcategoria').get();
                const subcategorias = [];
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    if (data.nomesubcategoria && data.categoriapai) {
                        try {
                            const categoriaPaiDoc = await db.collection('oddcategorias').doc(data.categoriapai).get();
                            const categoriaPaiData = categoriaPaiDoc.data();
                            const categoriaPaiNome = categoriaPaiData?.nomecategoria || 'Categoria Desconhecida';
                            subcategorias.push({ id: doc.id, nome: data.nomesubcategoria, categoriaPaiNome: categoriaPaiNome });
                        } catch (error) {
                            console.warn('Aviso ao buscar categoria pai para subcategoria:', error.message, 'ID Subcat:', doc.id, 'ID Pai:', data.categoriapai);
                            subcategorias.push({ id: doc.id, nome: data.nomesubcategoria, categoriaPaiNome: 'Categoria Pai não encontrada' });
                        }
                    } else if (data.nomesubcategoria) {
                         subcategorias.push({ id: doc.id, nome: data.nomesubcategoria, categoriaPaiNome: 'Sem Categoria Pai Associada' });
                    }
                }
                subcategorias.sort((a, b) => a.nome.localeCompare(b.nome));
                subcategorias.forEach(subcategoria => {
                    const option = document.createElement('option');
                    option.value = subcategoria.id;
                    option.textContent = `${subcategoria.nome} (Cat. Pai: ${subcategoria.categoriaPaiNome})`;
                    subcategoriaPaiSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar subcategorias:', error);
            }
        }

        async function handleOrderChange(event) {
            const input = event.target;
            const oddId = input.dataset.id;
            const newOrder = parseInt(input.value, 10);
            const type = input.dataset.type;
            const parentId = input.dataset.parentId;
            const subParentId = input.dataset.subParentId;
            const docSnap = await db.collection('oddcategorias').doc(oddId).get();
            const originalOrder = docSnap.exists ? docSnap.data().ordem : null;
            if (isNaN(newOrder) || newOrder < 1) {
                alert("Por favor, insira um número de ordem válido (maior ou igual a 1).");
                input.value = originalOrder;
                return;
            }
            if (newOrder === originalOrder) { return; }
            input.disabled = true;
            try {
                const batch = db.batch();
                let query = db.collection('oddcategorias').where('categoria_subcategoria_3cat', '==', type);
                if (type === 'subcategoria') { query = query.where('categoriapai', '==', parentId); }
                else if (type === '3cat') { query = query.where('categoriapai', '==', parentId).where('subcategoriapai', '==', subParentId); }
                const snapshot = await query.get();
                let siblings = [];
                snapshot.forEach(doc => siblings.push({ id: doc.id, ...doc.data() }));
                const itemToMove = siblings.find(item => item.id === oddId);
                if (!itemToMove) throw new Error("Item a ser movido não encontrado.");
                let sortedSiblings = siblings.filter(item => item.id !== oddId).sort((a, b) => (a.ordem || Infinity) - (b.ordem || Infinity));
                const finalNewOrder = Math.max(1, Math.min(newOrder, sortedSiblings.length + 1));
                sortedSiblings.splice(finalNewOrder - 1, 0, itemToMove);
                sortedSiblings.forEach((item, index) => {
                    const newAssignedOrder = index + 1;
                    if (item.ordem !== newAssignedOrder) {
                        const docRef = db.collection('oddcategorias').doc(item.id);
                        batch.update(docRef, { ordem: newAssignedOrder, lastUpdated: timestamp() });
                    }
                });
                await batch.commit();
                await renderOddsTree();
            } catch (error) {
                console.error("Erro ao atualizar a ordem:", error);
                alert(`Não foi possível atualizar a ordem: ${error.message}`);
                input.value = originalOrder;
                input.disabled = false;
            }
        }

        async function loadCategorias() {
            try {
                const snapshot = await db.collection('oddcategorias').where('categoria_subcategoria_3cat', '==', 'categoria').get();
                categoriaDropdown.innerHTML = '<option value="" disabled selected>Selecione a Categoria</option>';
                const categorias = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nomecategoria) {
                        categorias.push({ id: doc.id, nome: data.nomecategoria });
                    }
                });
                categorias.sort((a, b) => a.nome.localeCompare(b.nome));
                categorias.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    option.textContent = categoria.nome;
                    categoriaDropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        function resetForm() {
            if (editarOddForm) editarOddForm.reset();
            if (typeof competicoesSelect.val === 'function') competicoesSelect.val(null).trigger('change');
            if (tipoCategoriaSelect) tipoCategoriaSelect.value = "";
            selectedOddId = null;
            originalOddData = null;
            if (searchInput) searchInput.value = '';
            toggleCategoryFields();
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = 'Salvar Alterações';
            }
            if(typeof loadCategorias === "function") loadCategorias();
            if (deleteOddButton) deleteOddButton.style.display = 'none';
        }

        function toggleCategoryFields() {
            if (!tipoCategoriaSelect || !categoriaNomeDiv || !subcategoriaNomeDiv || !terceiraCategoriaNomeDiv || !document.getElementById('subcategoriaDropdown') || !categoriaDropdown || !subcategoriaPaiSelect) { return; }
            const selectedValue = tipoCategoriaSelect.value;
            categoriaNomeDiv.style.display = 'none';
            subcategoriaNomeDiv.style.display = 'none';
            terceiraCategoriaNomeDiv.style.display = 'none';
            document.getElementById('subcategoriaDropdown').style.display = 'none';
            if (selectedValue === 'categoria') {
                categoriaDropdown.style.display = 'none';
                categoriaDropdown.required = false;
            } else {
                categoriaDropdown.style.display = 'block';
                categoriaDropdown.required = true;
            }
            subcategoriaPaiSelect.required = false;
            if (selectedValue === '3cat') {
                document.getElementById('subcategoriaDropdown').style.display = 'block';
                subcategoriaPaiSelect.required = true;
                if(typeof loadSubcategorias === "function") loadSubcategorias();
            }
            switch(selectedValue) {
                case 'categoria':
                    categoriaNomeDiv.style.display = 'block'; if (nomeCategoriaInput) nomeCategoriaInput.required = true; if (nomeSubcategoriaInput) nomeSubcategoriaInput.required = false; if (nomeTerceiraCategoriaInput) nomeTerceiraCategoriaInput.required = false;
                    break;
                case 'subcategoria':
                    subcategoriaNomeDiv.style.display = 'block'; if (nomeSubcategoriaInput) nomeSubcategoriaInput.required = true; if (nomeCategoriaInput) nomeCategoriaInput.required = false; if (nomeTerceiraCategoriaInput) nomeTerceiraCategoriaInput.required = false;
                    break;
                case '3cat':
                    terceiraCategoriaNomeDiv.style.display = 'block'; if (nomeTerceiraCategoriaInput) nomeTerceiraCategoriaInput.required = true; if (nomeCategoriaInput) nomeCategoriaInput.required = false; if (nomeSubcategoriaInput) nomeSubcategoriaInput.required = false;
                    break;
                default:
                    if (nomeCategoriaInput) nomeCategoriaInput.required = false; if (nomeSubcategoriaInput) nomeSubcategoriaInput.required = false; if (nomeTerceiraCategoriaInput) nomeTerceiraCategoriaInput.required = false; if (categoriaDropdown) categoriaDropdown.required = false;
                    break;
            }
        }

        async function carregarCompeticoes() {
            try {
                const [competicoesSnapshot, paisesSnapshot] = await Promise.all([ db.collection('competicoes').orderBy('nome').get(), db.collection('paises').get() ]);
                const paisesMap = {};
                paisesSnapshot.forEach(doc => { paisesMap[doc.id] = doc.data().nome; });
                allCompeticoesData = [];
                competicoesSnapshot.forEach(doc => {
                    const competicao = doc.data();
                    const paisNome = paisesMap[competicao.paisId] || 'País Desconhecido';
                    allCompeticoesData.push({ id: competicao.nome, text: `${paisNome}: ${competicao.nome}` });
                });
                allCompeticoesData.sort((a, b) => a.text.localeCompare(b.text));
                if (typeof competicoesSelect.select2 === 'function') {
                    competicoesSelect.select2({ placeholder: 'Pesquisar e selecionar competições', allowClear: true, width: '100%', language: 'pt', theme: 'default', dropdownAutoWidth: true, minimumInputLength: 0, closeOnSelect: false, data: allCompeticoesData });
                    competicoesSelect.val(null).trigger('change');
                }
            } catch (error) {
                console.error('Erro crítico ao carregar competições ou países:', error);
            }
        }

        async function preencherFormulario(oddId) {
            selectedOddId = oddId;
            if (submitButton) { submitButton.disabled = true; submitButton.textContent = 'Carregando Dados...'; }
            if (editarOddForm) editarOddForm.reset(); 
            if (typeof competicoesSelect.val === 'function') competicoesSelect.val(null).trigger('change');
            try {
                const docSnap = await db.collection('oddcategorias').doc(oddId).get();
                if (!docSnap.exists) throw new Error(`Documento com ID ${oddId} não encontrado.`);
                const data = docSnap.data();
                originalOddData = { ...data, id: docSnap.id };
                if (tipoCategoriaSelect) tipoCategoriaSelect.value = data.categoria_subcategoria_3cat || '';
                toggleCategoryFields();
                if (indiceInglesInput) indiceInglesInput.value = data.indiceIngles || '';
                if (breveDescricaoInput) breveDescricaoInput.value = data.breveDescricao || '';
                if (ordemInput) ordemInput.value = data.ordem !== undefined ? data.ordem : '';
                if (iconInput) iconInput.value = data.icon || '';
                if (ativadoCheckbox) ativadoCheckbox.checked = data.ativado === true;
                if (data.categoria_subcategoria_3cat === 'categoria') { if (nomeCategoriaInput) nomeCategoriaInput.value = data.nomecategoria || ''; if (categoriaDropdown) categoriaDropdown.value = ''; }
                else if (data.categoria_subcategoria_3cat === 'subcategoria') { if (nomeSubcategoriaInput) nomeSubcategoriaInput.value = data.nomesubcategoria || ''; if (data.categoriapai && categoriaDropdown) { await loadCategorias(); categoriaDropdown.value = data.categoriapai; } else if (categoriaDropdown) { categoriaDropdown.value = ''; } }
                else if (data.categoria_subcategoria_3cat === '3cat') { if (nomeTerceiraCategoriaInput) nomeTerceiraCategoriaInput.value = data.nome3categoria || ''; if (data.categoriapai && categoriaDropdown) { await loadCategorias(); categoriaDropdown.value = data.categoriapai; } else if (categoriaDropdown) { categoriaDropdown.value = ''; } if (data.subcategoriapai && subcategoriaPaiSelect) { await loadSubcategorias(); subcategoriaPaiSelect.value = data.subcategoriapai; } else if (subcategoriaPaiSelect) { subcategoriaPaiSelect.value = ''; } }
                if (data.competicoes && Array.isArray(data.competicoes) && typeof competicoesSelect.val === 'function') {
                    const validCompeticoes = data.competicoes.filter(compValue => allCompeticoesData.some(option => option.id === compValue));
                    competicoesSelect.val(validCompeticoes).trigger('change');
                } else if (typeof competicoesSelect.val === 'function') {
                    competicoesSelect.val(null).trigger('change');
                }
                let displayText = data.indiceIngles || 'Odd Selecionada';
                if (data.categoria_subcategoria_3cat === 'categoria' && data.nomecategoria) displayText = data.nomecategoria;
                else if (data.categoria_subcategoria_3cat === 'subcategoria' && data.nomesubcategoria) displayText = data.nomesubcategoria;
                else if (data.categoria_subcategoria_3cat === '3cat' && data.nome3categoria) displayText = data.nome3categoria;
                if (searchInput) searchInput.value = `${displayText} (${data.categoria_subcategoria_3cat || 'Tipo Desconhecido'})`;
                if (searchResults) searchResults.style.display = 'none';
                if (deleteOddButton) deleteOddButton.style.display = 'flex';
            } catch (error) {
                console.error("Erro ao preencher formulário:", error);
                alert(`Erro ao carregar dados da odd para edição: ${error.message}`);
                resetForm();
            } finally {
                if (submitButton) { submitButton.disabled = false; submitButton.textContent = 'Salvar Alterações'; }
            }
        }

        async function renderOddsTree() {
            if (!oddsTreeViewDiv) { console.error("DEBUG: oddsTreeViewDiv não foi encontrado no DOM!"); return; }
            oddsTreeViewDiv.innerHTML = '<p class="loading-text">Carregando estrutura de odds...</p>';
            try {
                const snapshot = await db.collection('oddcategorias').get();
                if (snapshot.empty) { oddsTreeViewDiv.innerHTML = '<p class="loading-text">Nenhuma odd encontrada para exibir na estrutura.</p>'; return; }
                const allOdds = [];
                snapshot.forEach(doc => allOdds.push({ id: doc.id, ...doc.data() }));
                const parseOrder = (item) => { const order = parseInt(item.ordem); return !isNaN(order) ? order : Infinity; };
                const categorias = allOdds.filter(odd => odd.categoria_subcategoria_3cat === 'categoria').sort((a, b) => parseOrder(a) - parseOrder(b));
                const subcategorias = allOdds.filter(odd => odd.categoria_subcategoria_3cat === 'subcategoria').sort((a, b) => parseOrder(a) - parseOrder(b));
                const terceirasCategorias = allOdds.filter(odd => odd.categoria_subcategoria_3cat === '3cat').sort((a, b) => parseOrder(a) - parseOrder(b));
                if (categorias.length === 0 && allOdds.filter(odd => odd.categoria_subcategoria_3cat === 'categoria' || odd.categoria_subcategoria_3cat === 'subcategoria' || odd.categoria_subcategoria_3cat === '3cat').length === 0) { oddsTreeViewDiv.innerHTML = '<p class="loading-text">Nenhuma odd categorizada (categoria, subcategoria, 3cat) encontrada para exibir na estrutura.</p>'; return; }
                let treeHtml = '<ul>';
                for (const cat of categorias) {
                    const childSubcategorias = subcategorias.filter(sub => sub.categoriapai === cat.id);
                    const hasChildren = childSubcategorias.length > 0;
                    const toggleableClass = hasChildren ? 'toggleable' : '';
                    const noToggleIconClass = !hasChildren ? 'no-toggle' : '';
                    treeHtml += `<li><div class="tree-item"><div class="tree-item-content"><span class="tree-item-name-container ${toggleableClass}" data-item-id="${cat.id}"><i class="fas fa-caret-right tree-toggle-icon ${noToggleIconClass}"></i><span class="tree-item-name categoria">${cat.nomecategoria || `[Categoria ID: ${cat.id} sem nome]`}</span></span></div><input type="number" class="order-input" value="${cat.ordem || ''}" title="Mudar Ordem (Pressione Enter)" data-id="${cat.id}" data-type="categoria" data-parent-id="" data-sub-parent-id=""><button class="edit-tree-item-btn" data-id="${cat.id}">Editar</button><button class="delete-tree-item-btn" data-id="${cat.id}">Eliminar</button></div>`;
                    if (hasChildren) {
                        treeHtml += '<ul class="sub-list">';
                        for (const subCat of childSubcategorias) {
                            const childTerceirasCategorias = terceirasCategorias.filter(ter => ter.categoriapai === subCat.categoriapai && ter.subcategoriapai === subCat.id);
                            const hasGrandChildren = childTerceirasCategorias.length > 0;
                            const subToggleableClass = hasGrandChildren ? 'toggleable' : '';
                            const subNoToggleIconClass = !hasGrandChildren ? 'no-toggle' : '';
                            treeHtml += `<li><div class="tree-item"><div class="tree-item-content"><span class="tree-item-name-container ${subToggleableClass}" data-item-id="${subCat.id}"><i class="fas fa-caret-right tree-toggle-icon ${subNoToggleIconClass}"></i><span class="tree-item-name subcategoria">${subCat.nomesubcategoria || `[Subcat ID: ${subCat.id} sem nome]`}</span></span></div><input type="number" class="order-input" value="${subCat.ordem || ''}" title="Mudar Ordem (Pressione Enter)" data-id="${subCat.id}" data-type="subcategoria" data-parent-id="${subCat.categoriapai || ''}" data-sub-parent-id=""><button class="edit-tree-item-btn" data-id="${subCat.id}">Editar</button><button class="delete-tree-item-btn" data-id="${subCat.id}">Eliminar</button></div>`;
                            if (hasGrandChildren) {
                                treeHtml += '<ul class="sub-sub-list">';
                                for (const terCat of childTerceirasCategorias) {
                                    treeHtml += `<li><div class="tree-item"><div class="tree-item-content"><span class="tree-item-name-container" data-item-id="${terCat.id}"><i class="fas fa-minus tree-toggle-icon no-toggle"></i><span class="tree-item-name terceira-categoria">${terCat.nome3categoria || `[3aCat ID: ${terCat.id} sem nome]`}</span></span></div><input type="number" class="order-input" value="${terCat.ordem || ''}" title="Mudar Ordem (Pressione Enter)" data-id="${terCat.id}" data-type="3cat" data-parent-id="${terCat.categoriapai || ''}" data-sub-parent-id="${terCat.subcategoriapai || ''}"><button class="edit-tree-item-btn" data-id="${terCat.id}">Editar</button><button class="delete-tree-item-btn" data-id="${terCat.id}">Eliminar</button></div></li>`;
                                }
                                treeHtml += '</ul>';
                            }
                            treeHtml += '</li>';
                        }
                        treeHtml += '</ul>';
                    }
                    treeHtml += '</li>';
                }
                treeHtml += '</ul>';
                oddsTreeViewDiv.innerHTML = treeHtml;
                oddsTreeViewDiv.querySelectorAll('.edit-tree-item-btn').forEach(button => { button.addEventListener('click', function() { const oddId = this.dataset.id; preencherFormulario(oddId); if (toggleTreeViewButton && oddsTreeViewDiv.style.display === 'block') { oddsTreeViewDiv.style.display = 'none'; toggleTreeViewButton.classList.remove('open'); const mainIcon = toggleTreeViewButton.querySelector('.toggle-icon'); if (mainIcon) { mainIcon.classList.remove('fa-chevron-up'); mainIcon.classList.add('fa-chevron-down'); } toggleTreeViewButton.setAttribute('aria-expanded', 'false'); } }); });
                oddsTreeViewDiv.querySelectorAll('.delete-tree-item-btn').forEach(button => { button.addEventListener('click', function(event) { event.stopPropagation(); oddIdToDelete = this.dataset.id; if (deleteConfirmPopup) { deleteConfirmPopup.style.display = 'flex'; } }); });
                oddsTreeViewDiv.querySelectorAll('.tree-item-name-container.toggleable').forEach(toggleElement => { toggleElement.addEventListener('click', function() { this.closest('li').classList.toggle('expanded'); }); });
            } catch (error) {
                console.error("DEBUG: Erro CRÍTICO ao renderizar árvore de odds:", error);
                if (oddsTreeViewDiv) oddsTreeViewDiv.innerHTML = `<p class="error-text">Erro ao carregar estrutura. Verifique o console para detalhes técnicos. Mensagem: ${error.message}</p>`;
            }
        }

        // ===================================================================
        // PARTE 3: INICIALIZAÇÃO DA PÁGINA (CHAMADA PELO GUARDIÃO)
        // ===================================================================
        function initializePage() {
            if (tipoCategoriaSelect) {
                tipoCategoriaSelect.addEventListener('change', toggleCategoryFields);
            }
            let searchDebounceTimer;
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    if (searchResults) { searchResults.innerHTML = ''; searchResults.style.display = 'none'; }
                    clearTimeout(searchDebounceTimer);
                    if (searchTerm.length < 2) return;
                    searchDebounceTimer = setTimeout(async () => {
                        if (!searchResults) return;
                        searchResults.innerHTML = '<div class="search-result-item" style="cursor:default;">Pesquisando...</div>';
                        searchResults.style.display = 'block';
                        try {
                            const oddSnapshot = await db.collection('oddcategorias').get();
                            const results = [];
                            oddSnapshot.forEach(doc => {
                                const data = doc.data();
                                const tipo = data.categoria_subcategoria_3cat;
                                let nome = ''; let match = false;
                                if (tipo === 'categoria' && data.nomecategoria?.toLowerCase().includes(searchTerm)) { nome = data.nomecategoria; match = true; }
                                else if (tipo === 'subcategoria' && data.nomesubcategoria?.toLowerCase().includes(searchTerm)) { nome = data.nomesubcategoria; match = true; }
                                else if (tipo === '3cat' && data.nome3categoria?.toLowerCase().includes(searchTerm)) { nome = data.nome3categoria; match = true; }
                                else if (data.indiceIngles?.toLowerCase().includes(searchTerm)) {
                                    match = true;
                                    if (tipo === 'categoria') nome = data.nomecategoria;
                                    else if (tipo === 'subcategoria') nome = data.nomesubcategoria;
                                    else if (tipo === '3cat') nome = data.nome3categoria;
                                    else nome = data.indiceIngles;
                                }
                                if (match) results.push({ id: doc.id, nome: nome || data.indiceIngles || 'Nome Indefinido', tipo: tipo || 'Tipo Indefinido', indice: data.indiceIngles || '' });
                            });
                            results.sort((a, b) => a.nome.localeCompare(b.nome));
                            if (results.length > 0) {
                                searchResults.innerHTML = results.map(result => `<div class="search-result-item" data-id="${result.id}">${result.nome} ${result.indice && result.indice !== result.nome ? '<span style="color:#555;">('+result.indice+')</span>' : ''} - <span style="color:#888;">[${result.tipo}]</span></div>`).join('');
                                document.querySelectorAll('.search-result-item[data-id]').forEach(item => { item.addEventListener('click', function() { preencherFormulario(this.dataset.id); if(searchResults) searchResults.style.display = 'none'; }); });
                            } else { searchResults.innerHTML = '<div class="search-result-item" style="cursor:default;">Nenhum resultado encontrado</div>'; }
                            searchResults.style.display = 'block';
                        } catch (error) {
                            console.error('Erro na pesquisa:', error);
                            if (searchResults) { searchResults.innerHTML = '<div class="search-result-item" style="color:red; cursor:default;">Erro ao realizar pesquisa</div>'; searchResults.style.display = 'block'; }
                        }
                    }, 300);
                });
            }
            document.addEventListener('click', function(e) { if (searchResults && searchInput && !searchInput.contains(e.target) && !searchResults.contains(e.target)) { searchResults.style.display = 'none'; } });
            const selecionarTudoBtn = document.getElementById('selecionarTudo');
            if (selecionarTudoBtn) { selecionarTudoBtn.addEventListener('click', function() { if (allCompeticoesData && typeof competicoesSelect.val === 'function') { const allOptionValues = allCompeticoesData.map(option => option.id); competicoesSelect.val(allOptionValues).trigger('change'); } }); }
            const limparSelecaoBtn = document.getElementById('limparSelecao');
            if (limparSelecaoBtn) { limparSelecaoBtn.addEventListener('click', function() { if (typeof competicoesSelect.val === 'function') { competicoesSelect.val(null).trigger('change'); } }); }
            if (toggleTreeViewButton && oddsTreeViewDiv) { toggleTreeViewButton.addEventListener('click', () => { const isVisible = oddsTreeViewDiv.style.display === 'block'; oddsTreeViewDiv.style.display = isVisible ? 'none' : 'block'; toggleTreeViewButton.classList.toggle('open', !isVisible); const icon = toggleTreeViewButton.querySelector('.toggle-icon'); if (icon) { icon.classList.toggle('fa-chevron-down', isVisible); icon.classList.toggle('fa-chevron-up', !isVisible); } toggleTreeViewButton.setAttribute('aria-expanded', String(!isVisible)); if (!isVisible) renderOddsTree(); }); }
            if (deleteOddButton) { deleteOddButton.addEventListener('click', () => { if (selectedOddId) { oddIdToDelete = selectedOddId; if (deleteConfirmPopup) deleteConfirmPopup.style.display = 'flex'; } else { alert("Nenhuma odd está carregada no formulário para ser excluída."); } }); }
            if (cancelDeleteBtn) { cancelDeleteBtn.addEventListener('click', () => { if (deleteConfirmPopup) deleteConfirmPopup.style.display = 'none'; oddIdToDelete = null; }); }
            if (confirmDeleteBtn) { confirmDeleteBtn.addEventListener('click', async () => { if (!oddIdToDelete) { alert("Erro: Nenhuma odd selecionada para exclusão."); if (deleteConfirmPopup) deleteConfirmPopup.style.display = 'none'; return; } confirmDeleteBtn.disabled = true; if (cancelDeleteBtn) cancelDeleteBtn.disabled = true; confirmDeleteBtn.textContent = 'Removendo...'; try { await db.collection('oddcategorias').doc(oddIdToDelete).delete(); alert('Odd removida com sucesso!'); window.location.reload(); } catch (error) { console.error('Erro ao remover a odd:', error); alert(`Erro ao remover a odd: ${error.message}`); if (deleteConfirmPopup) deleteConfirmPopup.style.display = 'none'; confirmDeleteBtn.disabled = false; if (cancelDeleteBtn) cancelDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'Sim, Remover'; } finally { oddIdToDelete = null; } }); }
            if (editarOddForm) {
                editarOddForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    if (!selectedOddId) { alert('Por favor, pesquise e selecione uma odd da lista ou da estrutura antes de salvar.'); if (searchInput) searchInput.focus(); return; }
                    if (!submitButton) return;
                    submitButton.disabled = true;
                    submitButton.textContent = 'Salvando...';
                    try {
                        const tipoCategoria = tipoCategoriaSelect.value;
                        if (!tipoCategoria) throw new Error("O campo 'Tipo de Categoria' é obrigatório.");
                        const formData = { categoria_subcategoria_3cat: tipoCategoria, indiceIngles: indiceInglesInput ? indiceInglesInput.value.trim() : '', breveDescricao: breveDescricaoInput ? breveDescricaoInput.value.trim() : '', ordem: ordemInput ? parseInt(ordemInput.value) : null, icon: iconInput ? iconInput.value.trim() : '', competicoes: (typeof competicoesSelect.val === 'function') ? (competicoesSelect.val() || []) : [], ativado: ativadoCheckbox ? ativadoCheckbox.checked : false, lastUpdated: timestamp() };
                        delete formData.nomecategoria; delete formData.nomesubcategoria; delete formData.nome3categoria; delete formData.categoriapai; delete formData.subcategoriapai;
                        if (!formData.indiceIngles) throw new Error("O campo 'Indice Inglês' é obrigatório.");
                        if (formData.ordem === null || isNaN(formData.ordem)) throw new Error("O campo 'Ordem' deve ser um número válido.");
                        if (!formData.icon) throw new Error("O campo 'Icon / Emoji' é obrigatório.");
                        if (tipoCategoria === 'subcategoria') {
                            formData.nomesubcategoria = nomeSubcategoriaInput ? nomeSubcategoriaInput.value.trim() : '';
                            formData.categoriapai = categoriaDropdown ? categoriaDropdown.value : '';
                            if (!formData.nomesubcategoria) throw new Error("O campo 'Nome da Subcategoria' é obrigatório.");
                            if (!formData.categoriapai) throw new Error("É necessário selecionar uma Categoria pai.");
                            const isMoveOperation = originalOddData && originalOddData.categoriapai !== formData.categoriapai;
                            if (isMoveOperation) {
                                const batch = db.batch();
                                const subcategoriaRef = db.collection('oddcategorias').doc(selectedOddId);
                                batch.update(subcategoriaRef, formData);
                                const terceirasCategoriasSnapshot = await db.collection('oddcategorias').where('subcategoriapai', '==', selectedOddId).get();
                                const filhosMovidosCount = terceirasCategoriasSnapshot.size;
                                terceirasCategoriasSnapshot.forEach(doc => { const terceiraCatRef = db.collection('oddcategorias').doc(doc.id); batch.update(terceiraCatRef, { categoriapai: formData.categoriapai, lastUpdated: timestamp() }); });
                                await batch.commit();
                                alert(`Subcategoria movida com sucesso! ${filhosMovidosCount} 3ªs categorias filhas foram atualizadas automaticamente.`);
                            } else {
                                await db.collection('oddcategorias').doc(selectedOddId).update(formData);
                                alert('Subcategoria atualizada com sucesso!');
                            }
                        } else {
                            if (tipoCategoria === 'categoria') { formData.nomecategoria = nomeCategoriaInput ? nomeCategoriaInput.value.trim() : ''; if (!formData.nomecategoria) throw new Error("O campo 'Nome da Categoria' é obrigatório."); }
                            else if (tipoCategoria === '3cat') { formData.nome3categoria = nomeTerceiraCategoriaInput ? nomeTerceiraCategoriaInput.value.trim() : ''; formData.categoriapai = categoriaDropdown ? categoriaDropdown.value : ''; formData.subcategoriapai = subcategoriaPaiSelect ? subcategoriaPaiSelect.value : ''; if (!formData.nome3categoria) throw new Error("O campo 'Nome da 3ª Categoria' é obrigatório."); if (!formData.categoriapai) throw new Error("É necessário selecionar uma Categoria pai."); if (!formData.subcategoriapai) throw new Error("É necessário selecionar uma Subcategoria pai."); }
                            await db.collection('oddcategorias').doc(selectedOddId).update(formData);
                            alert('Odd atualizada com sucesso!');
                        }
                        if (oddsTreeViewDiv && (oddsTreeViewDiv.style.display === 'block' || (oddsTreeViewDiv.innerHTML && oddsTreeViewDiv.innerHTML.trim() !== ''))) { renderOddsTree(); }
                        resetForm();
                    } catch (error) {
                        console.error('Erro ao salvar alterações:', error);
                        alert(`Erro ao salvar: ${error.message}\nPor favor, verifique os campos e tente novamente.`);
                    } finally {
                        if (submitButton) { submitButton.disabled = false; submitButton.textContent = 'Salvar Alterações'; }
                    }
                });
            }
            if (oddsTreeViewDiv) {
                oddsTreeViewDiv.addEventListener('change', async (event) => {
                    if (event.target.classList.contains('order-input')) {
                        if (event.target.disabled) return;
                        await handleOrderChange(event);
                    }
                });
            }
            console.log("DEBUG: initializePage chamada.");
            resetForm();
            carregarCompeticoes();
            loadCategorias();
            toggleCategoryFields();
            if (toggleTreeViewButton) {
                toggleTreeViewButton.setAttribute('aria-expanded', 'false');
            }
            console.log("DEBUG: Página inicializada.");
        }
    </script>
</body>
</html>
