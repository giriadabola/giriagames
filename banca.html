<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banca - Ggames</title>
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEIbiLnCB/s320/soccer-ball-png.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { min-height: 100vh; background-color: #f4f7f9; color: #333; }
        .content { padding: 20px; margin-bottom: 80px; }
        h1 { text-align: center; color: #0a2e5c; font-size: 2.5rem; margin-bottom: 30px; font-weight: 700; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f9; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { border: 12px solid #e3e3e3; border-top: 12px solid #0a2e5c; border-radius: 50%; width: 80px; height: 80px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .action-cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto; }
        .action-card { background-color: #ffffff; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; text-decoration: none; color: #333; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #e0e0e0; }
        .action-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); }
        .action-card .card-icon { font-size: 3rem; margin-bottom: 15px; }
        .action-card .card-label { font-size: 1.2rem; font-weight: 600; color: #0a2e5c; }
        .card-value { font-size: 1.6rem; font-weight: 700; margin-top: 8px; color: #e74c3c; }
        .action-card .card-description { font-size: 0.9rem; color: #777; margin-top: 8px; }
        .icon-convert { color: #2ecc71; } .icon-debt { color: #e74c3c; } .icon-loan { color: #3498db; } .icon-history { color: #f39c12; } .icon-invest { color: #1abc9c; }
        #bancaTotalCard { background: linear-gradient(145deg, #0a2e5c, #1a4a8a); border-color: rgba(10, 46, 92, 0.5); cursor: default; box-shadow: 0 10px 25px rgba(10, 46, 92, 0.2); }
        #bancaTotalCard:hover { transform: translateY(-8px); box-shadow: 0 18px 35px rgba(10, 46, 92, 0.25); }
        #bancaTotalCard .card-icon, #bancaTotalCard .card-label { color: #ffffff; opacity: 0.9; }
        #bancaTotalCard #bancaTotalValue { color: #ffffff; font-size: 2.2rem; letter-spacing: 1px; }
        .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 46, 92, 0.8); backdrop-filter: blur(5px); z-index: 3000; justify-content: center; align-items: center; }
        .popup-content { background-color: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); max-width: 450px; width: 90%; text-align: center; position: relative; }
        .popup-content h2 { color: #0a2e5c; margin-bottom: 1.5rem; font-size: 1.8rem; }
        .password-input { width: 100%; padding: 12px 15px; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
        .password-input:focus { outline: none; border-color: #3498db; box-shadow: 0 0 8px rgba(52, 152, 219, 0.3); }
        .popup-btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; }
        .popup-buttons { display: flex; justify-content: center; }
        .popup-btn-confirm { background-color: #0a2e5c; color: white; }
        .popup-btn-confirm:hover { background-color: #1a4a8a; transform: translateY(-2px); }
        .popup-btn-icon { background: none; color: #aaa; border: none; font-size: 1.5rem; cursor: pointer; position: absolute; top: 15px; right: 15px; }
        .popup-btn-icon:hover { color: #333; }
        .conversion-info { text-align: left; margin-bottom: 1.5rem; }
        .conversion-info p { margin-bottom: 0.5rem; font-size: 1.1em; }
        .conversion-rate-note { font-size: 0.8em; color: #777; margin-top: 1rem; }
        .currency-selection-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .currency-card { background: linear-gradient(135deg, #f8f9fa, #e9ecef); border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; width: 200px; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .currency-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); border-color: #3498db; }
        .currency-card img { width: 60px; height: 60px; margin-bottom: 10px; }
        .currency-card .currency-name { font-size: 1.1rem; font-weight: 600; color: #0a2e5c; }
        .currency-card.disabled { cursor: not-allowed; opacity: 0.5; background: #f1f1f1; }
        
        /* ESTILOS NOVOS PARA O RESULTADO */
        .result-box { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0; border: 1px solid #e9ecef; text-align: left; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95rem; }
        .result-row.total { border-top: 1px solid #ddd; margin-top: 8px; padding-top: 8px; font-weight: bold; font-size: 1.1rem; }
        .text-danger { color: #dc3545; }
        .text-success { color: #28a745; }
        .text-muted { color: #6c757d; }
        .aviso-multiplo { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; font-size: 0.9rem; margin-top: 10px; border-left: 4px solid #ffeeba; display: none; }
   
   /* --- Notificação de Atualização (Toast) --- */
        #rate-toast {
            visibility: hidden;
            min-width: 300px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 10000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            border-left: 5px solid #f39c12;
        }

        #rate-toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        #rate-toast i { margin-right: 10px; color: #f39c12; }
    </style>
</head>
<body>
    <div id="rate-toast"><i class="fas fa-sync-alt fa-spin"></i> Taxas atualizadas pela Banca!</div>
    <div id="loading-screen"><div class="loading-spinner"></div></div>

    <div class="content" style="display: none;">
        <h1>Banca Ggames</h1>
        <div class="action-cards-container">
            <div class="action-card" id="bancaTotalCard"><i class="fas fa-university card-icon"></i><div class="card-label">Fundos da Banca</div><div class="card-value" id="bancaTotalValue">0 ₲₵</div></div>
            <div id="openExchangeHouseCard" class="action-card"><i class="fas fa-exchange-alt card-icon icon-convert"></i><div class="card-label">Casa de Conversão</div><p class="card-description">Troque as suas moedas aqui.</p></div>
            <div id="payDebtCard" class="action-card"><i class="fas fa-file-invoice-dollar card-icon icon-debt"></i><div class="card-label">Pagar Dívidas</div><div class="card-value" id="debtValueOnCard">A carregar...</div><p class="card-description">Veja e pague os seus empréstimos.</p></div>
            <div id="investmentsCard" class="action-card"><i class="fas fa-chart-line card-icon icon-invest"></i><div class="card-label">Investimentos</div><p class="card-description">Oportunidades para crescer GCoins.</p></div>
            <div id="loanRequestCard" class="action-card"><i class="fas fa-hand-holding-usd card-icon icon-loan"></i><div class="card-label">Solicitar Empréstimo</div><p class="card-description">Peça um adiantamento.</p></div>
            <a href="historico_banca.html" class="action-card"><i class="fas fa-history card-icon icon-history"></i><div class="card-label">Meu Histórico</div><p class="card-description">Suas transações.</p></a>
        </div>
    </div>

    <div class="popup-overlay" id="exchangeHousePopup">
        <div class="popup-content">
            <button class="popup-btn popup-btn-icon" id="closeExchangeHousePopupBtn"><i class="fas fa-times"></i></button>
            <h2>Casa de Conversão</h2>
            <p>Selecione a moeda para converter:</p>
            <div class="currency-selection-container">
                <div class="currency-card" id="selectMiniGcoinsCard"><img src="https://i.ibb.co/wJk6k0q/mini-gcoin-icon.png" alt="Mini-gCoin"><div class="currency-name">Mini-gCoins</div></div>
                <div class="currency-card disabled"><img src="https://i.ibb.co/Kz2XyvP/token-icon.png" alt="Token"><div class="currency-name">Tokens (Breve)</div></div>
            </div>
            <div id="exchangeHouseLoader" style="display: none; text-align: center; margin-top: 20px;"><div class="loading-spinner" style="width: 50px; height: 50px; border-width: 6px; margin: auto;"></div><p style="margin-top: 10px;">A carregar...</p></div>
        </div>
    </div>

    <div class="popup-overlay" id="conversionPopup">
        <div class="popup-content">
            <button class="popup-btn popup-btn-icon" id="closeConversionPopupBtn"><i class="fas fa-times"></i></button>
            <h2>Converter mini-gCoins</h2>
            <div class="conversion-info">
                <p>Seus mini-gCoins: <strong id="currentMiniGCoins">0</strong></p>
                <p>Seus gCoins: <strong id="currentGCoins">0</strong></p>
            </div>
            <input type="number" id="conversionAmountInput" class="password-input" placeholder="Valor a converter" min="1">
            
            <!-- RESULTADO MELHORADO -->
            <div id="conversionResultContainer" style="display:none;">
                <div class="result-box">
                    <div class="result-row text-muted"><span>Gerado (Bruto):</span> <strong id="calcGross">0</strong></div>
                    <div class="result-row text-danger"><span>Comissão Banca:</span> <strong id="calcBank">-0</strong></div>
                    <div class="result-row total text-success"><span>Recebe (Líquido):</span> <strong id="calcUser">0</strong></div>
                </div>
            </div>

            <p id="conversionRateNote" class="conversion-rate-note"></p>
            <p id="conversionRuleNote" class="aviso-multiplo"></p>
            <button id="confirmConversionBtn" class="popup-btn popup-btn-confirm" style="background-color: #2ecc71; width:100%;">Confirmar Conversão</button>
            <p id="conversionFeedback" style="margin-top:10px; font-weight:bold;"></p>
        </div>
    </div>

    <!-- Outros popups (Debt, Loan) mantêm-se iguais mas omitidos para brevidade, usar o código anterior se necessário -->
    <div class="popup-overlay" id="debtPaymentPopup"><div class="popup-content"><button class="popup-btn popup-btn-icon" id="closeDebtPopupBtn"><i class="fas fa-times"></i></button><h2 style="color:#c0392b">Pagar Dívida</h2><p>Total: <strong id="popupDebtTotal">0</strong></p><input type="number" id="paymentAmountInput" class="password-input" placeholder="Valor"><div style="display:flex; gap:10px; margin-bottom:10px"><button id="maxPaymentBtn" class="popup-btn" style="background:#f39c12">MAX</button></div><button id="confirmPaymentBtn" class="popup-btn popup-btn-confirm" style="background:#27ae60">Pagar</button><p id="debtFeedback"></p></div></div>
    <div class="popup-overlay" id="loanRequestPopup"><div class="popup-content"><button class="popup-btn popup-btn-icon" id="closeLoanPopupBtn"><i class="fas fa-times"></i></button><h2>Solicitar Empréstimo</h2><input type="number" id="loanAmountInput" class="password-input" placeholder="Valor"><p id="loanFeeInfo"></p><button id="confirmLoanRequestBtn" class="popup-btn popup-btn-confirm">Solicitar</button><p id="loanFeedback"></p></div></div>

    <script src="config.js"></script>
  <script type="module">
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'us-central1');

        // Elementos
        const loadingScreen = document.getElementById('loading-screen');
        const content = document.querySelector('.content');
        const bancaTotalValue = document.getElementById('bancaTotalValue');
        const debtValueOnCard = document.getElementById('debtValueOnCard');
        const exchangeHousePopup = document.getElementById('exchangeHousePopup');
        const conversionPopup = document.getElementById('conversionPopup');
        const conversionAmountInput = document.getElementById('conversionAmountInput');
        const confirmConversionBtn = document.getElementById('confirmConversionBtn');
        const calcGross = document.getElementById('calcGross');
        const calcBank = document.getElementById('calcBank');
        const calcUser = document.getElementById('calcUser');
        const resultContainer = document.getElementById('conversionResultContainer');
        const ruleNote = document.getElementById('conversionRuleNote');
        const rateToast = document.getElementById('rate-toast');

        let currentUserGCoins = 0;
        let currentUserMiniGCoins = 0;
        let conversionRate = 0;
        let bankFeeFactor = 0;
        let minRequiredMultiple = 1;
        let currentSeason = '';
        let totalUserDebt = 0;
        let isFirstLoad = true; // Para evitar popup ao abrir a página

        async function loadMenuSettings() {
            const snap = await getDoc(doc(db, 'paineis', 'paineis menu'));
            return snap.exists() ? snap.data() : {};
        }

        function calculateMinMultiple(rate, fee) {
            for(let i=1; i<=10000; i++) {
                const gross = i / rate;
                const bank = gross * fee;
                const user = gross - bank;
                const isClean = Math.abs(bank - Math.round(bank)) < 1e-9 && 
                                Math.abs(user - Math.round(user)) < 1e-9;
                if(isClean) return i;
            }
            return 0;
        }

        // FUNÇÃO PARA MOSTRAR NOTIFICAÇÃO
        function showUpdateToast() {
            rateToast.className = "show";
            // Toca um som subtil se quiseres (opcional)
            // new Audio('notification.mp3').play().catch(e=>{});
            
            // Atualiza texto se o popup estiver aberto
            if(conversionPopup.style.display === 'flex') {
                 updateConversionUI();
                 // Dispara o evento de input para recalcular valores se o user estiver a escrever
                 if(conversionAmountInput.value) conversionAmountInput.dispatchEvent(new Event('input'));
            }

            setTimeout(function(){ rateToast.className = rateToast.className.replace("show", ""); }, 4000);
        }
        
        function updateConversionUI() {
             let note = `Taxa: ${conversionRate} mini-gCoins = 1 gCoin.`;
             if(bankFeeFactor > 0) note += `<br>Comissão Banca: ${(bankFeeFactor * 100).toFixed(0)}% sobre o valor gerado.`;
             document.getElementById('conversionRateNote').innerHTML = note;
        }

        // LISTENER EM TEMPO REAL (SUBSTITUI loadBancaValue)
        function setupBancaListener() {
            const unsub = onSnapshot(doc(db, 'paineis', 'Banca'), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const newRate = data.taxaWhoWins || 0;
                    const newFee = data.taxaBanca || 0;
                    const newVal = data.valor || 0;

                    bancaTotalValue.textContent = newVal.toLocaleString('pt-PT') + ' ₲₵';

                    // Detetar se houve mudança nas taxas
                    if (!isFirstLoad && (newRate !== conversionRate || newFee !== bankFeeFactor)) {
                        conversionRate = newRate;
                        bankFeeFactor = newFee;
                        if(conversionRate > 0) minRequiredMultiple = calculateMinMultiple(conversionRate, bankFeeFactor);
                        
                        showUpdateToast(); // MOSTRA AVISO
                    } else {
                        // Primeira carga ou sem mudanças
                        conversionRate = newRate;
                        bankFeeFactor = newFee;
                        if(conversionRate > 0) minRequiredMultiple = calculateMinMultiple(conversionRate, bankFeeFactor);
                    }
                    isFirstLoad = false;
                }
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (!userDoc.exists() || userDoc.data().aceite !== "Yes") { window.location.href = 'index.html'; return; }
                    
                    const menuSettings = await loadMenuSettings();
                    if (menuSettings.bank !== 'on' && userDoc.data().estatuto !== 'ruler') { window.location.href = '404.html'; return; }
                    if (typeof updateMenuVisibility === 'function') updateMenuVisibility(menuSettings);

                    const configSnap = await getDoc(doc(db, 'paineis', 'configuracoes_gerais'));
                    currentSeason = configSnap.exists() ? configSnap.data().temporadaAtual.replace('/', '') : '';

                    // Inicia o listener em tempo real
                    setupBancaListener();

                    await loadUserDebts(user.uid);
                    loadingScreen.style.display = 'none'; content.style.display = 'block';
                } catch (e) { console.error(e); window.location.href = '404.html'; }
            } else window.location.href = 'index.html';
        });

        async function loadUserDebts(uid) {
            const q = query(collection(db, 'movimentos'), where('userId', '==', uid), where('estado', '==', 'Por Pagar'), where('tipo', '==', 'Empréstimo'));
            const snap = await getDocs(q);
            let total = 0; snap.forEach(d => total += d.data().valorTotalAPagar || 0);
            totalUserDebt = total;
            debtValueOnCard.textContent = total.toLocaleString('pt-PT') + ' ₲₵';
            const uSnap = await getDoc(doc(db, 'users', uid));
            if (uSnap.exists()) currentUserGCoins = uSnap.data()[currentSeason + 'GCoins'] || 0;
        }

        // Eventos Exchange
        document.getElementById('openExchangeHouseCard').addEventListener('click', () => exchangeHousePopup.style.display = 'flex');
        document.getElementById('closeExchangeHousePopupBtn').addEventListener('click', () => exchangeHousePopup.style.display = 'none');
        document.getElementById('closeConversionPopupBtn').addEventListener('click', () => conversionPopup.style.display = 'none');

        document.getElementById('selectMiniGcoinsCard').addEventListener('click', async () => {
            document.getElementById('exchangeHouseLoader').style.display = 'block';
            document.querySelector('.currency-selection-container').style.display = 'none';
            
            const uSnap = await getDoc(doc(db, 'users', auth.currentUser.uid));
            if (uSnap.exists()) {
                currentUserMiniGCoins = uSnap.data().whowinsgCoins || 0;
                currentUserGCoins = uSnap.data()[currentSeason + 'GCoins'] || 0;
                document.getElementById('currentMiniGCoins').textContent = currentUserMiniGCoins.toFixed(0);
                document.getElementById('currentGCoins').textContent = currentUserGCoins.toFixed(0);
                
                updateConversionUI(); // Atualiza textos
                
                conversionAmountInput.value = '';
                resultContainer.style.display = 'none';
                ruleNote.style.display = 'none';
                
                conversionPopup.style.display = 'flex';
                exchangeHousePopup.style.display = 'none';
            }
            document.getElementById('exchangeHouseLoader').style.display = 'none';
            document.querySelector('.currency-selection-container').style.display = 'flex';
        });

        conversionAmountInput.addEventListener('input', () => {
            const amount = parseFloat(conversionAmountInput.value);
            
            if (isNaN(amount) || amount <= 0) {
                resultContainer.style.display = 'none';
                ruleNote.style.display = 'none';
                confirmConversionBtn.disabled = true;
                return;
            }

            if (conversionRate > 0) {
                resultContainer.style.display = 'block';
                
                const gross = amount / conversionRate;
                const bank = gross * bankFeeFactor;
                const user = gross - bank;

                calcGross.textContent = Number(gross.toFixed(4));
                calcBank.textContent = "-" + Number(bank.toFixed(4));
                calcUser.textContent = Number(user.toFixed(4));

                const valid = Number.isInteger(Number(gross.toFixed(6))) && 
                              Number.isInteger(Number(bank.toFixed(6))) && 
                              Number.isInteger(Number(user.toFixed(6)));

                if (valid) {
                    confirmConversionBtn.disabled = false; 
                    confirmConversionBtn.style.opacity = "1"; 
                    confirmConversionBtn.style.cursor = "pointer";
                    ruleNote.style.display = 'none';
                } else {
                    confirmConversionBtn.disabled = true; 
                    confirmConversionBtn.style.opacity = "0.6"; 
                    confirmConversionBtn.style.cursor = "not-allowed";
                    
                    ruleNote.style.display = 'block';
                    if(minRequiredMultiple > 1) {
                        ruleNote.innerHTML = `<i class="fas fa-info-circle"></i> Insira <strong>múltiplos de ${minRequiredMultiple}</strong> (ex: ${minRequiredMultiple}, ${minRequiredMultiple*2}...).`;
                    } else {
                         ruleNote.innerHTML = `<i class="fas fa-exclamation-triangle"></i> O valor tem de resultar em GCoins inteiros.`;
                    }
                }
            }
        });

        confirmConversionBtn.addEventListener('click', async () => {
            const amt = parseFloat(conversionAmountInput.value);
            if(amt > currentUserMiniGCoins) { document.getElementById('conversionFeedback').textContent = "Saldo insuficiente."; return; }
            
            confirmConversionBtn.disabled = true; confirmConversionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const res = await httpsCallable(functions, 'convertCoins')({ amount: amt });
                if (res.data.success) {
                    document.getElementById('conversionFeedback').textContent = "Sucesso!"; document.getElementById('conversionFeedback').style.color = "green";
                    setTimeout(() => location.reload(), 1500);
                }
            } catch (e) {
                document.getElementById('conversionFeedback').textContent = e.message; document.getElementById('conversionFeedback').style.color = "red";
                confirmConversionBtn.disabled = false; confirmConversionBtn.textContent = "Confirmar Conversão";
            }
        });

        document.getElementById('payDebtCard').addEventListener('click', () => { if(totalUserDebt > 0) document.getElementById('debtPaymentPopup').style.display='flex'; else alert('Sem dívidas.'); });
        document.getElementById('closeDebtPopupBtn').addEventListener('click', () => document.getElementById('debtPaymentPopup').style.display='none');
        
        document.getElementById('maxPaymentBtn').addEventListener('click', () => {
            const maxPayable = Math.min(currentUserGCoins, totalUserDebt);
            document.getElementById('paymentAmountInput').value = Math.floor(maxPayable);
        });

        document.getElementById('confirmPaymentBtn').addEventListener('click', async () => {
            const amount = parseFloat(document.getElementById('paymentAmountInput').value);
            const feedback = document.getElementById('debtFeedback');
            const btn = document.getElementById('confirmPaymentBtn');

            if (isNaN(amount) || amount <= 0) { feedback.textContent = 'Valor inválido.'; feedback.style.color = 'red'; return; }
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            feedback.textContent = 'A processar...'; feedback.style.color = 'black';

            try {
                await auth.currentUser.getIdToken(true);
                const res = await httpsCallable(functions, 'payDebt')({ amount: amount });
                if (res.data.success) {
                    feedback.textContent = 'Pagamento bem-sucedido!'; feedback.style.color = 'green';
                    setTimeout(() => { location.reload(); }, 1500);
                }
            } catch (error) {
                feedback.textContent = error.message; feedback.style.color = 'red';
                btn.disabled = false; btn.innerHTML = 'Confirmar Pagamento';
            }
        });

        document.getElementById('loanRequestCard').addEventListener('click', () => {
            document.getElementById('loanFeeInfo').textContent = "Será aplicada uma taxa de juro sobre o valor solicitado.";
            document.getElementById('loanRequestPopup').style.display = 'flex';
        });
        document.getElementById('closeLoanPopupBtn').addEventListener('click', () => document.getElementById('loanRequestPopup').style.display = 'none');
        document.getElementById('confirmLoanRequestBtn').addEventListener('click', () => alert("Funcionalidade em desenvolvimento!"));
        document.getElementById('investmentsCard').addEventListener('click', () => alert("Funcionalidade em desenvolvimento!"));
    </script>
    <script src="menu-component.js"></script> 
</body>
</html>
