<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário - Ggames</title>
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEIbiLnCB/s320/soccer-ball-png.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ESTILOS GERAIS E MENU (Reutilizados) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
       body {
    min-height: 100vh;
    background-color: #f0f0f0;
    font-family: Arial, sans-serif;
    /* A linha display: none; foi removida */
}
        .content { padding: 10px; margin-bottom: 80px; }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }
        .bottom-menu { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 32px; align-items: center; z-index: 1000; }
        .menu-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; }
        .menu-item.active { color: #2176ff; font-weight: bold; }
        .menu-item i { font-size: 24px; margin-bottom: 4px; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; display: flex; justify-content: center; align-items: center; z-index: 1001; }
        .loading-spinner { border: 16px solid #f3f3f3; border-top: 16px solid #3498db; border-radius: 50%; width: 120px; height: 120px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* NOVOS ESTILOS ESPECÍFICOS DO CALENDÁRIO */
        #calendar-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .round-container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .round-header {
            padding: 15px;
            background-color: #343a40; /* Cabeçalho da ronda escuro */
            color: #ffffff;
            font-size: 1.3em;
            text-align: center;
        }
        
        /* ESTILO PARA A RONDA ATUAL */
        .round-container.current-round {
            background-color: #e7f5ff; /* Fundo azul claro para destaque */
            border: 2px solid #2176ff;
            box-shadow: 0 6px 20px rgba(33, 118, 255, 0.2);
        }
        .round-container.current-round .round-header {
             background-color: #2176ff; /* Cor de destaque para o cabeçalho da ronda atual */
        }

        .competition-list {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .round-container .competition-list:last-child {
            border-bottom: none;
        }

        .competition-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .competition-header img {
            width: 25px;
            height: 25px;
            object-fit: contain;
        }

        .competition-header h3 {
            font-size: 1.1em;
            color: #333;
        }

        .game-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0 12px 35px; /* Adiciona padding à esquerda para alinhar com o título da liga */
            border-top: 1px solid #eee;
        }

        .game-teams {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .game-teams .vs {
            color: #888;
            font-weight: bold;
        }

        .game-datetime {
            font-size: 0.85em;
            color: #666;
            text-align: right;
            flex-shrink: 0;
        }
        
        .no-games {
            text-align: center;
            color: #666;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>

    <!-- Fica fora do wrapper -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <!-- NOVO WRAPPER para o conteúdo principal -->
    <div id="main-content-wrapper" style="display: none;">
        <div class="content">
            <h1>Calendário de Jogos</h1>
            <div id="calendar-container">
                <!-- Os jogos agrupados por ronda serão carregados aqui -->
            </div>
        </div>

        <nav class="bottom-menu">
            <a href="1x.html" class="menu-item"><i class="fas fa-home"></i></a>
            <a href="market.html" class="menu-item"><i class="fas fa-shopping-cart"></i></a>
            <a href="team.html" class="menu-item"><i class="fas fa-users"></i></a>
            <a href="empire.html" class="menu-item"><i class="fas fa-landmark"></i></a>
            <a href="rankings.html" class="menu-item"><i class="fas fa-list"></i></a>
            <a href="profile.html" class="menu-item"><i class="fas fa-user"></i></a>
        </nav>

<script src="config.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loadingScreen = document.getElementById('loading-screen');
    const mainContentWrapper = document.getElementById('main-content-wrapper');

    // Funções de Acesso e Menu (sem alterações)
    async function getUserStatus(userId) { /* ... */ return getDoc(doc(db, 'users', userId)).then(d => d.exists() ? { estatuto: d.data().estatuto, aceite: d.data().aceite } : null); }
    async function loadMenuSettings() { /* ... */ return getDoc(doc(db, 'paineis', 'paineis menu')).then(d => d.exists() ? d.data() : {}); }
    function checkPageAccess(userStatus, menuSettings) { /* ... */ return (menuSettings['calendario'] === 'on' || userStatus === 'ruler'); }
    function updateMenuVisibility(menuSettings) { /* ... */ document.querySelectorAll('.bottom-menu .menu-item').forEach(i => { const k = i.getAttribute('href').replace('.html', ''); if (menuSettings[k] === 'off') i.style.display = 'none'; }); }

    // --- LÓGICA DO CALENDÁRIO (TOTALMENTE REESCRITA) ---
    async function loadCalendar() {
        const container = document.getElementById('calendar-container');
        container.innerHTML = '';
        const now = new Date();
        const dataCache = new Map();

        try {
            const gamesQuery = query(collection(db, 'jogos'), orderBy("dataJogo", "asc"));
            const querySnapshot = await getDocs(gamesQuery);
            const allGames = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (allGames.length === 0) {
                container.innerHTML = '<p class="no-games">Nenhum jogo encontrado no calendário.</p>';
                return;
            }

            // 1. Determinar a RONDA ATUAL (o menor número de ronda com jogos ativos)
            let currentRoundNumber = Infinity;
            allGames.forEach(game => {
                if (game.inicioIntervalo && game.fimIntervalo) {
                    const inicio = game.inicioIntervalo.toDate();
                    const fim = game.fimIntervalo.toDate();
                    if (now >= inicio && now <= fim) {
                        // Se encontrarmos uma ronda ativa, verificamos se é a mais baixa até agora
                        if (game.ronda < currentRoundNumber) {
                            currentRoundNumber = game.ronda;
                        }
                    }
                }
            });
            // Se nenhuma ronda estiver ativa, não definimos nenhuma como atual
            if (currentRoundNumber === Infinity) {
                currentRoundNumber = null;
            }

            // 2. Agrupar jogos primeiro por RONDA e depois por COMPETIÇÃO
            const groupedData = {};
            for (const game of allGames) {
                if (!game.ronda || !game.competicaoId) continue;

                // Cria o grupo da ronda se não existir
                if (!groupedData[game.ronda]) {
                    groupedData[game.ronda] = {};
                }
                // Cria o grupo da competição (dentro da ronda) se não existir
                if (!groupedData[game.ronda][game.competicaoId]) {
                    groupedData[game.ronda][game.competicaoId] = {
                        name: game.competicao,
                        image: '',
                        games: []
                    };
                }
                // Adiciona o jogo
                groupedData[game.ronda][game.competicaoId].games.push(game);
            }

            // 3. Renderizar o HTML com a nova estrutura
            const sortedRounds = Object.keys(groupedData).sort((a, b) => Number(a) - Number(b));

            for (const roundNumber of sortedRounds) {
                const isCurrent = (Number(roundNumber) === currentRoundNumber);
                const roundContainer = document.createElement('div');
                roundContainer.className = `round-container ${isCurrent ? 'current-round' : ''}`;
                
                const roundHeader = document.createElement('div');
                roundHeader.className = 'round-header';
                roundHeader.innerHTML = `<h2>Ronda ${roundNumber}</h2>`;
                roundContainer.appendChild(roundHeader);

                const competitionsInRound = groupedData[roundNumber];
                for (const compId in competitionsInRound) {
                    const competition = competitionsInRound[compId];
                    
                    // Busca dados da competição (com cache)
                    if (!dataCache.has(compId)) {
                        const compDoc = await getDoc(doc(db, 'competicoes', compId));
                        dataCache.set(compId, compDoc.exists() ? compDoc.data() : { imagem: '' });
                    }
                    competition.image = dataCache.get(compId).imagem;

                    const competitionList = document.createElement('div');
                    competitionList.className = 'competition-list';
                    competitionList.innerHTML = `
                        <div class="competition-header">
                            <img src="${competition.image}" alt="${competition.name}">
                            <h3>${competition.name}</h3>
                        </div>
                    `;

                    for (const game of competition.games) {
                        const gameDate = game.dataJogo.toDate();
                        const formattedDate = gameDate.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' });
                        const formattedTime = gameDate.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });

                        const gameElement = document.createElement('div');
                        gameElement.className = 'game-list-item';
                        gameElement.innerHTML = `
                            <div class="game-teams">
                                <span>${game.equipaCasa}</span>
                                <span class="vs">vs</span>
                                <span>${game.equipaFora}</span>
                            </div>
                            <div class="game-datetime">
                                ${formattedDate} - ${formattedTime}
                            </div>
                        `;
                        competitionList.appendChild(gameElement);
                    }
                    roundContainer.appendChild(competitionList);
                }
                container.appendChild(roundContainer);
            }
        } catch (error) {
            console.error("Erro ao carregar o calendário: ", error);
            container.innerHTML = '<p class="error">Não foi possível carregar o calendário. Tente novamente mais tarde.</p>';
        } finally {
            loadingScreen.style.display = 'none';
        }
    }

    // --- Ponto de Entrada da Página ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userInfo = await getUserStatus(user.uid);
            if (userInfo && userInfo.aceite === "Yes") {
                const menuSettings = await loadMenuSettings();
                // A regra de acesso pode precisar ser ajustada para 'calendario'
                if (checkPageAccess(userInfo.estatuto, menuSettings)) {
                    mainContentWrapper.style.display = 'block';
                    updateMenuVisibility(menuSettings);
                    await loadCalendar();
                } else {
                    window.location.href = '404.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        } else {
            window.location.href = 'index.html';
        }
    });

</script>
</body>
</html>
