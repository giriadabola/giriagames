<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relvado - GGAMES</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ... (Seu CSS original - o mesmo do código anterior correto) ... */
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
        }

        .menu-item:hover, .menu-item.active {
            color: #333;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #2176ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(33, 118, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover {
            color: #0056d6;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(33, 118, 255, 0.6));
        }

        .content {
            padding: 20px;
            margin-bottom: 80px;
            display: none;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .loading-spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .team-section {
            display: flex;
            gap: 20px;
            padding: 20px;
            flex-direction: column;
            align-items: flex-start;
        }

        @media (min-width: 768px) {
            .team-section {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .pitch-side, .player-selection-side {
            flex: 1;
            min-width: 300px;
        }

        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 0;
            padding-bottom: 75%;
            background-color: #2d6a4f;
            border: 1px solid #228B22;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .pitch-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 96%;
            height: 94%;
            border: 1px solid white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }


        .pitch-area::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
            background-color: white;
            z-index: 0; /* Optionally add this to ensure line is behind, although default is 0 */
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 1px solid white;
            border-radius: 50%;
        }

        .position {
            position: absolute;
            width: 30px; /* Tamanho original da "bola" */
            height: 30px; /* Tamanho original da "bola" */
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            color: white;
            transition: background-color 0.3s ease;
            border: none;
        }

        .position:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .position img {
            position: absolute; /* Posicionamento absoluto para sobrepor a "bola" */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centraliza a imagem */
            width: 60px; /* Dobro do tamanho da "bola" */
            height: 60px; /* Dobro do tamanho da "bola" */
            border-radius: 50%;
            object-fit: cover;
            /* pointer-events: none; REMOVED THIS LINE */
            z-index: 1; /* Add this line to bring player images forward */
        }


        .formation-options {
            margin-bottom: 10px;
        }

        .formation-options label {
            margin-right: 10px;
            font-weight: bold;
        }

        .player-search-section {
        }

        .player-search-bar {
        }

        .player-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-results {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
            width: 100%;
            display: none; /* Hide player results section */
        }

        .starting-eleven-player {
        background-color: #e0f7fa; /* Cor de fundo mais clara para jogadores do 11 inicial */
        border: 2px solid #81d4fa; /* Borda para destacar */
    }

        .player-card {
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .player-card:hover {
            background-color: #eaeaea;
        }

        .player-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .player-card .player-info {
            flex: 1;
        }

        .player-card .player-name {
            font-weight: bold;
            display: inline-block; /* Display inline to be in the same line as flag */
        }

        .player-card .country-flag {
            width: 20px;
            height: 15px;
            object-fit: contain;
            margin-left: 0px; /* Changed from 5px to 0px to move flag closer to name */
            vertical-align: middle;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            display: inline-block;
        }

        .player-card .player-position {
            font-size: 0.9em;
            color: #777;
            display: block;
            text-align: left;
        }


        .formation-options {
            padding: 10px;
            }

        .formation-options select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .formation-options #formation-select {
            position: absolute;
            left: -9999px;
            visibility: hidden;
        }

        .search-container {
            padding: 10px;
            display: none; /* Hide search container as well since player-results is hidden */
        }

        .search-container input[type="text"] {
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .filter-dropdowns {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            display: none; /* Hide filter dropdowns as well since player-results is hidden */
        }

        .filter-dropdowns select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

       /* Optional CSS for Starting Eleven Player Cards - uncomment if you want different styling
        .starting-eleven-player {
            background-color: #f0f8ff;
            border: 1px solid #add8e6;
        }
        */

       .starting-eleven-section { /* Styling for both Titulares and Suplentes */
           margin-top: 20px;
           padding: 15px;
           background-color: #fff;
           border-radius: 10px;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
       }

       .starting-eleven-section h2 { /* Styling for headings in both sections */
           color: #333;
           margin-bottom: 15px;
           font-size: 1.5em;
           text-align: center;
       }

       .starting-eleven-container, .substitutes-container { /* Styling for player containers in both sections */
           display: flex;
           flex-direction: column;
           gap: 10px;
           max-height: 500px; /* Increased max-height for Titulares */
           overflow-y: auto;
       }

       .substitutes-section {
           margin-top: 20px; /* Add some space between sections */
           padding: 15px;
           background-color: #fff;
           border-radius: 10px;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
       }

       .substitutes-section h2 {
           color: #333;
           margin-bottom: 15px;
           font-size: 1.5em;
           text-align: center;
       }

       .substitutes-container {
           display: flex;
           flex-direction: column;
           gap: 10px;
           max-height: 300px; /* Adjust max-height as needed */
           overflow-y: auto;
       }


    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <h1>Relvado</h1>

        <div class="team-section">
            <div class="pitch-side">
                <div class="formation-options">
                    <label for="formation-select"></label>
                    <select id="formation-select">
                        <option value="4-4-2">4-4-2</option>
                        <option value="4-3-3">4-3-3</option>
                        <option value="4-5-1">4-5-1</option>
                        <option value="3-4-3">3-4-3</option>
                        <option value="5-3-2">5-3-2</option>
                    </select>
                    <label for="user-select" style="margin-left: 20px;">GPlayers:</label>
                    <select id="user-select">
                        <option value="">Selecione um GPlayer</option>
                    </select>
                </div>


                <div class="pitch-container">
                    <div class="pitch-area">
                        <div class="center-circle"></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-side">
                <div class="starting-eleven-section">
                    <h2>11 Titulares</h2>
                    <div class="starting-eleven-container">
                        <!-- Starting eleven players will be displayed here -->
                    </div>
                </div>

                <div class="substitutes-section">  <!-- NEW SUBSTITUTES SECTION -->
                    <h2>Suplentes</h2>
                    <div class="substitutes-container">
                        <!-- Substitutes players will be displayed here -->
                    </div>
                </div>
            </div>

        </div>


    </div>

    <nav class="bottom-menu">
        <a href="1x.html" class="menu-item">
            <i class="fas fa-home"></i>
        </a>
        <a href="market.html" class="menu-item">
            <i class="fas fa-shopping-cart"></i>
        </a>
        <a href="team.html" class="menu-item active">
            <i class="fas fa-users"></i>
        </a>
        <a href="empire.html" class="menu-item">
            <i class="fas fa-landmark empire-icon"></i>
        </a>
        <a href="rankings.html" class="menu-item">
            <i class="fas fa-list"></i>
        </a>
        <a href="profile.html" class="menu-item">
            <i class="fas fa-user"></i>
        </a>
    </nav>

    <script type="module">
                    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
                    import { getFirestore, collection, getDocs, query, orderBy, limit, where, doc, getDoc, setDoc, addDoc, FieldValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
                    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

                    const firebaseConfig = {
                        apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
                        authDomain: "g-games-8a8fc.firebaseapp.com",
                        projectId: "g-games-8a8fc",
                        storageBucket: "g-games-8a8fc.firebasestorage.app",
                        messagingSenderId: "689897349449",
                        appId: "1:689897349449:web:536599794579901beb7a98",
                        measurementId: "G-GTTPJ6G5MD"
                    };

                    // Initialize Firebase
                    const app = initializeApp(firebaseConfig);
                    const db = getFirestore(app);
                    const auth = getAuth(app);

                    // Initialize allPlayers array
                    let allPlayers = [];
                    let assignedPlayers = {}; // Initialize assignedPlayers as a global variable
                    let currentUserStatus = null;
                    let currentUserUid = null;
                    let userPlayers = [];
                    let currentFormation = '4-4-2';
                    const formations = { // Keep formations definition here at the bottom for proper scope after function definitions
                        '4-4-2': [
                            { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                            { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                            { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                            { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                            { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                            { position: 'ML', top: '40%', left: '12%', positionType: 'MID' },
                            { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                            { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' },
                            { position: 'MR', top: '40%', left: '82%', positionType: 'MID' },
                            { position: 'FW1', top: '10%', left: '32%', positionType: 'FWD' },
                            { position: 'FW2', top: '10%', left: '62%', positionType: 'FWD' }
                        ],
                        '4-3-3': [
                            { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                            { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                            { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                            { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                            { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                            { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                            { position: 'MC2', top: '60%', left: '47%', positionType: 'MID' },
                            { position: 'MC3', top: '40%', left: '62%', positionType: 'MID' },
                            { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' },
                            { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' },
                            { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' },
                        ],
                        '4-5-1': [
                            { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                            { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                            { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                            { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                            { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                            { position: 'DML', top: '50%', left: '47%', positionType: 'MID' },
                            { position: 'MC1', top: '40%', left: '10%', positionType: 'MID' },
                            { position: 'AMC', top: '40%', left: '30%', positionType: 'MID' },
                            { position: 'MC2', top: '40%', left: '64%', positionType: 'MID' },
                            { position: 'DMR', top: '40%', left: '84%', positionType: 'MID' },
                            { position: 'FW', top: '10%', left: '47%', positionType: 'FWD' }
                        ],
                        '3-4-3': [
                            { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                            { position: 'DC1', top: '75%', left: '20%', positionType: 'DEF' },
                            { position: 'DC2', top: '75%', left: '47%', positionType: 'DEF' },
                            { position: 'DC3', top: '75%', left: '77%', positionType: 'DEF' },
                            { position: 'ML', top: '40%', left: '12%', positionType: 'MID' },
                            { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                            { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' },
                            { position: 'MR', top: '40%', left: '82%', positionType: 'MID' },
                            { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' },
                            { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' },
                            { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' },
                        ],
                        '5-3-2': [
                            { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                            { position: 'SW', top: '75%', left: '10%', positionType: 'DEF' },
                            { position: 'WBL', top: '75%', left: '30%', positionType: 'DEF' },
                            { position: 'DC1', top: '75%', left: '47%', positionType: 'DEF' },
                            { position: 'DC2', top: '75%', left: '64%', positionType: 'DEF' },
                            { position: 'WBR', top: '75%', left: '84%', positionType: 'DEF' },
                            { position: 'MC1', top: '40%', left: '30%', positionType: 'MID' },
                            { position: 'MC2', top: '55%', left: '47%', positionType: 'MID' },
                            { position: 'MC3', top: '40%', left: '64%', positionType: 'MID' },
                            { position: 'FW1', top: '10%', left: '30%', positionType: 'FWD' },
                            { position: 'FW2', top: '10%', left: '64%', positionType: 'FWD' }
                        ]
                    };
                    const loadingScreen = document.getElementById('loading-screen');
                    const content = document.querySelector('.content');

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserStatus = await getUserStatus(user.uid);
                            if (currentUserStatus !== null) {
                                console.log(`User is logged in on team.html with status: ${currentUserStatus}`);
                                loadingScreen.style.display = 'none';
                                content.style.display = 'block';
                            } else {
                                console.log('User is not accepted');
                                window.location.href = 'index.html';
                            }
                        } else {
                            console.log('No user is logged in on team.html');
                            window.location.href = 'index.html';
                        }
                    });
                    const formationSelect = document.getElementById('formation-select');
                    const pitchArea = document.querySelector('.pitch-area');
                    const firebase = { /* ... firebase object ... */
                        firestore: {
                            doc: doc,
                            getDoc: getDoc,
                            collection: collection,
                            getDocs: getDocs,
                            query: query,
                            orderBy: orderBy,
                            limit: limit,
                            setDoc: setDoc,
                            addDoc: addDoc,
                            FieldValue: FieldValue
                        }
                    };


                    function renderFormation(formationName) {
                        const previousFormation = currentFormation;
                        const previousAssignedPlayers = { ...assignedPlayers };

                        pitchArea.querySelectorAll('.position img').forEach(img => img.remove());
                        for (const pos in assignedPlayers) {
                            assignedPlayers[pos] = null;
                        }
                        assignedPlayers = {};

                        currentFormation = formationName;

                        const currentFormationPositions = formations[formationName];
                        pitchArea.innerHTML = '<div class="center-circle"></div>';

                        currentFormationPositions.forEach(pos => {
                            const positionElement = document.createElement('div');
                            positionElement.classList.add('position');
                            positionElement.dataset.position = pos.position;
                            positionElement.style.top = pos.top;
                            positionElement.style.left = pos.left;
                            positionElement.textContent = '+';
                            positionElement.dataset.playerId = null;
                            positionElement.dataset.positionType = pos.positionType;

                            positionElement.addEventListener('dragover', (event) => {
                                event.preventDefault();
                            });
                            positionElement.addEventListener('drop', handlePositionDrop);
                            positionElement.addEventListener('dragstart', (event) => {
                                const imgElement = positionElement.querySelector('img');
                                if (imgElement) {
                                    const assignedPlayerId = positionElement.dataset.assignedPlayerId;
                                    event.dataTransfer.setData('playerId', assignedPlayerId);
                                    event.dataTransfer.setData('originalPositionId', positionElement.dataset.position);
                                } else {
                                    event.preventDefault();
                                }
                            });
                            pitchArea.appendChild(positionElement);
                        });

                        if (previousFormation && previousAssignedPlayers) {
                            repositionPlayers(previousFormation, previousAssignedPlayers, formationName);
                        }
                    }

                    function repositionPlayers(previousFormationName, previousAssignedPlayers, currentFormationName) {
                        const currentFormationPositions = formations[currentFormationName];
                        const availablePositions = currentFormationPositions.reduce((acc, pos) => {
                            acc[pos.positionType] = acc[pos.positionType] || [];
                            acc[pos.positionType].push(pos.position);
                            return acc;
                        }, {});

                        for (const positionId in previousAssignedPlayers) {
                            const playerId = previousAssignedPlayers[positionId];
                            if (!playerId) continue;
                            const player = allPlayers.find(p => p.id === playerId);
                            if (!player) continue;

                            const playerPosicaoIngles = {
                                "Avançado": "FWD",
                                "Defesa": "DEF",
                                "Médio": "MID",
                                "Guarda-Redes": "GK"
                            }[player.posicao];

                            if (availablePositions[playerPosicaoIngles] && availablePositions[playerPosicaoIngles].length > 0) {
                                const newPositionId = availablePositions[playerPosicaoIngles].shift();
                                const positionElement = document.querySelector(`.position[data-position="${newPositionId}"]`);
                                if (positionElement) {
                                    positionElement.innerHTML = '';
                                    const playerImg = document.createElement('img');
                                    playerImg.src = player.imagem || 'placeholder_image_url.png';
                                    playerImg.alt = player.nome;
                                    positionElement.appendChild(playerImg);
                                    positionElement.dataset.assignedPlayerId = playerId;
                                    assignedPlayers[newPositionId] = playerId;
                                }
                            }
                        }
                    }


                    function createStartingElevenPlayerCard(player) {
                        const card = document.createElement('div');
                        card.classList.add('player-card', 'starting-eleven-player'); // Add 'starting-eleven-player' class for specific styling
                        card.dataset.playerId = player.id; // Store player ID for easy removal later

                        const img = document.createElement('img');
                        img.src = player.imagem || 'placeholder_image_url.png';
                        img.alt = player.nome;
                        card.appendChild(img);

                        const playerInfo = document.createElement('div');
                        playerInfo.classList.add('player-info');

                        const playerName = document.createElement('span');
                        playerName.classList.add('player-name');
                        playerName.textContent = player.nome;
                        playerInfo.appendChild(playerName);

                        if (player.nacionalidadebandeira) { // Conditionally add flag
                            const countryFlag = document.createElement('img');
                            countryFlag.classList.add('country-flag');
                            countryFlag.src = player.nacionalidadebandeira;
                            countryFlag.alt = player.nacionalidade;
                            playerName.appendChild(countryFlag); // Append flag to player name
                        }

                        const playerPosition = document.createElement('span');
                        playerPosition.classList.add('player-position');
                        playerPosition.textContent = player.posicao;
                        playerInfo.appendChild(playerPosition);

                        card.appendChild(playerInfo);
                        return card;
                    }


                    function handlePositionDrop(event) {
                        event.preventDefault();
                        const playerId = event.dataTransfer.getData('playerId');
                        const positionElement = event.currentTarget;
                        const positionId = positionElement.dataset.position;
                        const positionType = positionElement.dataset.positionType;
                        const originalPositionId = event.dataTransfer.getData('originalPositionId');

                        const player = allPlayers.find(p => p.id === playerId);
                        if (!player) return;

                        const posicaoMapping = {
                            "Avançado": "FWD",
                            "Defesa": "DEF",
                            "Médio": "MID",
                            "Guarda-Redes": "GK"
                        };
                        const playerPosicaoIngles = posicaoMapping[player.posicao];

                        if (playerPosicaoIngles !== positionType) {
                            alert(`Este jogador é ${player.posicao} e só pode ser colocado em posições de ${positionType}`);
                            return;
                        }

                        const alreadyAssignedPosition = Object.keys(assignedPlayers).find(pos => assignedPlayers[pos] === playerId);
                        if (alreadyAssignedPosition && alreadyAssignedPosition !== positionId) {
                            const previousPositionElement = document.querySelector(`.position[data-position="${alreadyAssignedPosition}"]`);
                            if (previousPositionElement) {
                                removePlayerFromPosition(previousPositionElement, playerId, alreadyAssignedPosition);
                            }
                        }

                        const existingPlayerId = positionElement.dataset.assignedPlayerId;
                        const startingElevenContainer = document.querySelector('.starting-eleven-container'); // Get the container

                        if (existingPlayerId) {
                            if (existingPlayerId === playerId) {
                                return;
                            }

                            const originalPositionElement = originalPositionId ? document.querySelector(`.position[data-position="${originalPositionId}"]`) : null;

                            if (originalPositionElement) {
                                originalPositionElement.innerHTML = '+';
                                originalPositionElement.dataset.assignedPlayerId = null;
                                delete assignedPlayers[originalPositionId];

                                // Remove existing player card from Starting Eleven if swapped
                                const existingPlayerCard = startingElevenContainer.querySelector(`.player-card[data-player-id="${existingPlayerId}"]`);
                                if (existingPlayerCard) {
                                    startingElevenContainer.removeChild(existingPlayerCard);
                                }

                                positionElement.innerHTML = '';
                                const playerImg = document.createElement('img');
                                playerImg.src = player.imagem || 'placeholder_image_url.png';
                                playerImg.alt = player.nome;
                                positionElement.appendChild(playerImg);
                                positionElement.dataset.assignedPlayerId = playerId;
                                assignedPlayers[positionId] = playerId;

                                // Add new player card to Starting Eleven
                                const newPlayerCard = createStartingElevenPlayerCard(player);
                                startingElevenContainer.appendChild(newPlayerCard);


                                const playerExistente = allPlayers.find(p => p.id === existingPlayerId);
                                if (playerExistente) {
                                    originalPositionElement.innerHTML = '';
                                    const playerExistenteImg = document.createElement('img');
                                    playerExistenteImg.src = playerExistente.imagem || 'placeholder_image_url.png';
                                    playerExistenteImg.alt = playerExistente.nome;
                                    originalPositionElement.appendChild(playerExistenteImg);
                                    originalPositionElement.dataset.assignedPlayerId = existingPlayerId;
                                    assignedPlayers[originalPositionId] = existingPlayerId;

                                    // Add back the swapped out player's card to Starting Eleven
                                    const swappedOutPlayerCard = createStartingElevenPlayerCard(playerExistente);
                                    startingElevenContainer.appendChild(swappedOutPlayerCard);


                                    console.log(`Jogadores trocados: ${player.nome} trocado com ${playerExistente.nome}`);
                                    return;
                                }
                            } else {
                                 // Remove existing player card from Starting Eleven if replaced
                                const existingPlayerCard = startingElevenContainer.querySelector(`.player-card[data-player-id="${existingPlayerId}"]`);
                                if (existingPlayerCard) {
                                    startingElevenContainer.removeChild(existingPlayerCard);
                                }

                                positionElement.innerHTML = '';
                                const playerImg = document.createElement('img');
                                playerImg.src = player.imagem || 'placeholder_image_url.png';
                                playerImg.alt = player.nome;
                                positionElement.appendChild(playerImg);
                                positionElement.dataset.assignedPlayerId = playerId;
                                assignedPlayers[positionId] = playerId;

                                // Add new player card to Starting Eleven
                                const newPlayerCard = createStartingElevenPlayerCard(player);
                                startingElevenContainer.appendChild(newPlayerCard);
                                console.log(`Jogador ${player.nome} substituiu o jogador na posição ${positionId}`);
                            }


                        } else {
                            positionElement.innerHTML = '';
                            const playerImg = document.createElement('img');
                            playerImg.src = player.imagem || 'placeholder_image_url.png';
                            playerImg.alt = player.nome;
                            positionElement.appendChild(playerImg);
                            positionElement.dataset.assignedPlayerId = playerId;
                            assignedPlayers[positionId] = playerId;

                            // Add new player card to Starting Eleven
                            const newPlayerCard = createStartingElevenPlayerCard(player);
                            startingElevenContainer.appendChild(newPlayerCard);
                            console.log(`Jogador ${player.nome} colocado na posição ${positionId}`);
                        }
                    }

                    function removePlayerFromPosition(positionElement, playerId, positionId) {
                        console.log("LOG 3: removePlayerFromPosition function started for playerId:", playerId, "positionId:", positionId);
                        try {
                            positionElement.innerHTML = '+';
                            positionElement.dataset.assignedPlayerId = null;
                            delete assignedPlayers[positionId];

                            // Remove player card from Starting Eleven
                            const startingElevenContainer = document.querySelector('.starting-eleven-container');
                            const playerCardToRemove = startingElevenContainer.querySelector(`.player-card[data-player-id="${playerId}"]`);
                            if (playerCardToRemove) {
                                startingElevenContainer.removeChild(playerCardToRemove);
                            }


                            console.log('assignedPlayers após remover:', JSON.stringify(assignedPlayers));
                            positionElement.removeEventListener('dragover', handlePositionDragOver);
                            positionElement.removeEventListener('drop', handlePositionDrop);
                            positionElement.addEventListener('dragover', (event) => {
                                event.preventDefault();
                            });
                            positionElement.addEventListener('drop', handlePositionDrop);
                            console.log(`Player ${playerId} removed from position ${positionId}`);
                            console.log("LOG 4: removePlayerFromPosition function finished for playerId:", playerId, "positionId:", positionId);
                        } catch (error) {
                            console.error("Erro interno em removePlayerFromPosition:", error);
                        }
                    }

                    function handlePositionDragOver(event) { /* ... handlePositionDragOver function ... */
                        event.preventDefault();
                    }

                    function isPlayerAssigned(playerId) {
                        console.log("isPlayerAssigned called for playerId:", playerId);
                        console.log("Current assignedPlayers:", JSON.stringify(assignedPlayers));
                        for (const position in assignedPlayers) {
                            if (assignedPlayers[position] === playerId) {
                                console.log(`Player ${playerId} is already assigned to position ${position}`);
                                return true;
                            }
                        }
                        console.log(`Player ${playerId} is NOT assigned.`);
                        return false;
                    }

                    async function fetchPlanteisData(userId, formation, season) {
                        try {
                            const planteisRef = collection(db, 'planteis');
                            const planteisQuery = query(planteisRef,
                                where('userId', '==', userId),
                                where('formacao', '==', formation),
                                where('temporada', '==', season)
                            );
                            const planteisSnapshot = await getDocs(planteisQuery);

                            if (!planteisSnapshot.empty) {
                                return planteisSnapshot.docs[0].data();
                            } else {
                                console.log('No plantel found for user, formation, and season.');
                                return null;
                            }
                        } catch (error) {
                            console.error('Error fetching planteis data:', error);
                            return null;
                        }
                    }

                    async function fetchPlayers(selectedUserId = null) {
                        if (!selectedUserId) {
                            return;
                        }

                        const jogadoresRef = collection(db, 'jogadores');
                        const q = query(jogadoresRef, where('compradopor', '==', selectedUserId));
                        const playersSnap = await getDocs(q);

                        const fetchedPlayers = [];
                        playersSnap.forEach(doc => {
                            const playerData = doc.data();
                            fetchedPlayers.push({...playerData, id: doc.id, posicao: playerData.posicao});
                        });
                        allPlayers = fetchedPlayers;

                        const selectedFormation = document.getElementById('formation-select').value;
                        const palpitesRef = collection(db, 'palpites');
                        const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                        const palpitesSnapshot = await getDocs(palpitesQuery);
                        let latestSeason = '';
                        if (!palpitesSnapshot.empty) {
                            latestSeason = palpitesSnapshot.docs[0].data().temporada;
                        } else {
                            console.error('No seasons found in palpites collection');
                            latestSeason = '';
                        }
                        const planteisData = await fetchPlanteisData(selectedUserId, selectedFormation, latestSeason);
                    }

                    async function fetchUserPlayers(userId) {
                        const userPlayersRef = collection(db, 'users', userId, 'jogadores');
                        const userPlayersSnap = await getDocs(userPlayersRef);
                        const fetchedUserPlayers = [];
                        userPlayersSnap.forEach(doc => {
                            fetchedUserPlayers.push({...doc.data(), id: doc.id});
                        });
                        userPlayers = fetchedUserPlayers;
                        console.log('User players fetched:', userPlayers);
                    }


                    async function getUserStatus(userId) {
                        const userDoc = doc(db, 'users', userId);
                        const docSnap = await getDoc(userDoc);
                        if (docSnap.exists() && docSnap.data().aceite === "Yes") {
                            return docSnap.data().estatuto;
                        } else {
                            return null;
                        }
                    }

                    async function loadUserTeam() {
                        const selectedUserId = document.getElementById('user-select').value;
                        const selectedFormation = document.getElementById('formation-select').value;

                        console.log('loadUserTeam chamado para:', { selectedUserId, selectedFormation });

                        if (!selectedUserId) {
                            console.log("Nenhum utilizador selecionado");
                            return;
                        }

                        pitchArea.querySelectorAll('.position img').forEach(img => img.remove());
                        const positions = document.querySelectorAll('.position');
                        positions.forEach(positionElement => {
                            positionElement.textContent = '+';
                            positionElement.dataset.assignedPlayerId = null;
                        });
                        assignedPlayers = {};

                        // Clear Starting Eleven and Substitutes containers before loading new team
                        const startingElevenContainer = document.querySelector('.starting-eleven-container');
                        startingElevenContainer.innerHTML = ''; // Clear existing cards
                        const substitutesContainer = document.querySelector('.substitutes-container'); // Get substitutes container
                        substitutesContainer.innerHTML = ''; // Clear existing substitutes cards

                        try {
                            const palpitesRef = collection(db, 'palpites');
                            const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                            const palpitesSnapshot = await getDocs(palpitesQuery);
                            let latestSeason = '';

                            if (!palpitesSnapshot.empty) {
                                latestSeason = palpitesSnapshot.docs[0].data().temporada;
                            } else {
                                console.error('No seasons found in palpites collection');
                                return;
                            }

                            const planteisRef = collection(db, 'planteis');
                            const planteisQuery = query(planteisRef,
                                where('userId', '==', selectedUserId),
                                where('formacao', '==', selectedFormation),
                                where('temporada', '==', latestSeason)
                            );
                            const planteisSnapshot = await getDocs(planteisQuery);

                            const startingElevenPlayerIds = []; // Array to hold player IDs in starting eleven

                            if (!planteisSnapshot.empty) {
                                const plantelData = planteisSnapshot.docs[0].data();

                                const positions = document.querySelectorAll('.position');
                                positions.forEach(positionElement => {
                                    const positionId = positionElement.dataset.position;
                                    const playerId = plantelData[positionId];

                                    if (playerId) {
                                        const player = allPlayers.find(p => p.id === playerId);
                                        if (player) {
                                            positionElement.innerHTML = '';
                                            const playerImg = document.createElement('img');
                                            playerImg.src = player.imagem || 'placeholder_image_url.png';
                                            playerImg.alt = player.nome;
                                            positionElement.appendChild(playerImg);
                                            positionElement.dataset.assignedPlayerId = playerId;
                                            assignedPlayers[positionId] = playerId;
                                            startingElevenPlayerIds.push(playerId); // Add player ID to starting eleven list

                                            // Add player card to Starting Eleven on initial load
                                            const playerCard = createStartingElevenPlayerCard(player);
                                            startingElevenContainer.appendChild(playerCard);
                                        }
                                    }
                                });
                            } else {
                                console.log('No team found for the selected user and formation');
                            }

                            // --- Load Substitutes ---
                            const substitutesPlayers = allPlayers.filter(player => !startingElevenPlayerIds.includes(player.id)); // Filter out starting eleven players

                            substitutesPlayers.forEach(player => {
                                const substituteCard = createStartingElevenPlayerCard(player); // Reuse card creation function
                                substitutesContainer.appendChild(substituteCard); // Add to substitutes container
                            });


                        } catch (error) {
                            console.error('Erro ao carregar equipa:', error);
                        }
                    }

                    // Function to load all players
                    async function loadAllPlayers(selectedUserId = null) {
                        try {
                            // const playerResultsContainer = document.querySelector('.player-results'); // No longer needed

                            // If no user is selected, clear allPlayers and show message
                            if (!selectedUserId) {
                                allPlayers = [];
                                // playerResultsContainer.textContent = 'Selecione um GPlayer para ver os jogadores'; // No longer needed
                                return;
                            }

                            // If a user is selected, fetch and filter players
                            const jogadoresRef = collection(db, 'jogadores');
                            const snapshot = await getDocs(jogadoresRef);
                            allPlayers = snapshot.docs
                                .map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }))
                                .filter(player => player.compradopor === selectedUserId);

                            // The player results section is removed, so no need to render player results here anymore
                        } catch (error) {
                            console.error('Error loading players:', error);
                        }
                    }

                    // Function to populate user select dropdown and load team on user change
                    async function loadUsers() {
                        try {
                            const usersRef = collection(db, 'users');
                            const querySnapshot = await getDocs(usersRef);
                            const userSelect = document.getElementById('user-select');

                            // Clear existing options except the first one
                            while (userSelect.options.length > 1) {
                                userSelect.remove(1);
                            }

                            // Create an array to store user data
                            const users = [];

                            // Collect all users with valid usernames
                            querySnapshot.forEach((doc) => {
                                const userData = doc.data();
                                if (userData.nomeDeUsuario) {
                                    users.push({
                                        id: doc.id,
                                        username: userData.nomeDeUsuario
                                    });
                                }
                            });

                            // Sort users by username alphabetically
                            users.sort((a, b) => a.username.localeCompare(b.username));

                            // Add sorted users to dropdown
                            users.forEach(user => {
                                const option = document.createElement('option');
                                option.value = user.id;
                                option.textContent = user.username;
                                userSelect.appendChild(option);
                            });

                            // Get the latest season
                            const palpitesRef = collection(db, 'palpites');
                            const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                            const palpitesSnapshot = await getDocs(palpitesQuery);
                            let latestSeason = '';

                            if (!palpitesSnapshot.empty) {
                                latestSeason = palpitesSnapshot.docs[0].data().temporada;
                            } else {
                                console.error('No seasons found in palpites collection');
                                return;
                            }

                            // Event listener for user selection to set default formation and load team
                            userSelect.addEventListener('change', async (event) => {
                                const selectedUserId = event.target.value;
                                if (!selectedUserId) return;

                                // Get the current formation from the select element
                                const formationSelect = document.getElementById('formation-select');
                                const selectedFormation = formationSelect.value;

                                // Query planteis for the selected user's active formation
                                const planteisRef = collection(db, 'planteis');
                                const planteisQuery = query(planteisRef,
                                where('userId', '==', selectedUserId),
                                where('formacao', '==', selectedFormation),
                                where('temporada', '==', latestSeason),
                                where('estado', '==', 'ativo') // ADICIONE ESTA LINHA
                            );

                                const planteisSnapshot = await getDocs(planteisQuery);
                                if (!planteisSnapshot.empty) {
                                    const plantelData = planteisSnapshot.docs[0].data();
                                    const formationSelect = document.getElementById('formation-select');
                                    formationSelect.value = plantelData.formacao;
                                }
                                // Trigger the loadUserTeam function to update the display
                                loadUserTeam();
                            });
                        } catch (error) {
                            console.error('Error loading users:', error);
                        }
                    }


                    // --- START: Event Listeners and Initial Calls ---

                    formationSelect.addEventListener('change', (event) => { /* ... formationSelect event listener ... */
                        const selectedFormation = event.target.value;
                        renderFormation(selectedFormation);
                    });


                    document.getElementById('user-select').addEventListener('change', (event) => { // Keep this after fetchPlayers definition
                        const selectedUserId = event.target.value;
                        fetchPlayers(selectedUserId);
                    });

                    onAuthStateChanged(auth, async (user) => { /* ... onAuthStateChanged ... */
                        if (user) {
                            currentUserUid = user.uid;
                            currentUserStatus = await getUserStatus(user.uid);
                            console.log(`User is logged in on team.html with status: ${currentUserStatus}`);
                            await fetchUserPlayers(user.uid);
                            await fetchPlayers(document.getElementById('user-select').value); // Initial fetchPlayers call
                            renderFormation(currentFormation);
                            loadingScreen.style.display = 'none';
                            content.style.display = 'block';
                        } else {
                            console.log('No user is logged in on team.html');
                            loadingScreen.style.display = 'none';
                            window.location.href = 'index.html';
                        }
                    });

                    document.addEventListener('DOMContentLoaded', async () => { // Keep DOMContentLoaded at the end
                        renderFormation(currentFormation); // Keep this here as well
                        loadUsers(); // Keep this here as well
                    });
                    // --- END: Event Listeners and Initial Calls ---


    </script>
</body>
</html>
