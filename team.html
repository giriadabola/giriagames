<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relvado - Ggames</title>
        <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEiIbiLnCB/s320/soccer-ball-png.webp">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ... (Seu CSS original - o mesmo do código anterior correto) ... */
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex; /* Default display */
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
        }

        /* Style for hidden menu items */
        .menu-item.hidden {
            display: none;
        }


        .menu-item:hover, .menu-item.active {
            color: #333;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #2176ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(33, 118, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover {
            color: #0056d6;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(33, 118, 255, 0.6));
        }

        .content {
            padding: 20px;
            margin-bottom: 80px;
            display: none; /* Initially hidden */
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Ensure it's above content but below potential modals */
        }

        .loading-spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

      .team-section {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    padding: 20px;
}

        @media (min-width: 768px) {
            .team-section {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .pitch-side, .player-selection-side {
            flex: 1;
            min-width: 300px;
        }

        .player-selection-side {
    display: flex; /* Arrange children in a row */
    gap: 20px; /* Add space between the two sections */
    align-items: flex-start; /* Align items to the top */
}


        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 0;
            padding-bottom: 75%;
            background-color: #2d6a4f;
            border: 1px solid #228B22;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .pitch-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 96%;
            height: 94%;
            border: 1px solid white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }


        .pitch-area::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
            background-color: white;
            z-index: 0; /* Optionally add this to ensure line is behind, although default is 0 */
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 1px solid white;
            border-radius: 50%;
        }

        .position {
            position: absolute;
            width: 30px; /* Tamanho original da "bola" */
            height: 30px; /* Tamanho original da "bola" */
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            color: white;
            transition: background-color 0.3s ease;
            border: none;
        }

        .position:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .position img {
            position: absolute; /* Posicionamento absoluto para sobrepor a "bola" */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centraliza a imagem */
            width: 60px; /* Dobro do tamanho da "bola" */
            height: 60px; /* Dobro do tamanho da "bola" */
            border-radius: 50%;
            object-fit: cover;
            /* pointer-events: none; REMOVED THIS LINE */
            z-index: 1; /* Add this line to bring player images forward */
        }


.position img:not(.player-style-icon) {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    z-index: 1;
}


.player-style-icon {
    /* --- Comportamento --- */
    position: absolute !important;
    z-index: 2 !important;
    cursor: pointer !important;

    /* --- ANULAÇÃO DAS REGRAS DE CENTRALIZAÇÃO HERDADAS --- */
    top: auto !important;          /* <<-- ANULA a posição vertical herdada (essencial) */
    left: auto !important;         /* <<-- ANULA a posição horizontal herdada (essencial) */
    transform: none !important;    /* <<-- ANULA qualquer transformação (essencial) */

    /* --- Posição Final (agora vai funcionar) --- */
    bottom: -30px !important;      /* Usei um valor baixo para ser notório */
    right: -16px !important;

    /* --- Tamanho Final --- */
    width: 40px !important;
    height: 40px !important;

    /* --- Estilo Visual --- */
    border-radius: 50% !important;
    border: none !important;
    box-shadow: none !important;
    background-color: transparent !important;
}

        .formation-options {
            margin-bottom: 10px;
        }

        .formation-options label {
            margin-right: 10px;
            font-weight: bold;
        }

        .player-search-section {
        }

        .player-search-bar {
        }

        .player-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-results {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
            width: 100%;
            display: none; /* Hide player results section */
        }

        .starting-eleven-player {
        background-color: #e0f7fa; /* Cor de fundo mais clara para jogadores do 11 inicial */
        border: 2px solid #81d4fa; /* Borda para destacar */
    }

        .player-card {
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .player-card:hover {
            background-color: #eaeaea;
        }

        .player-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .player-card .player-info {
            flex: 1;
        }

        .player-card .player-name {
            font-weight: bold;
            display: inline-block; /* Display inline to be in the same line as flag */
        }

        .player-card .country-flag {
            width: 20px;
            height: 15px;
            object-fit: contain;
            margin-left: 0px; /* Changed from 5px to 0px to move flag closer to name */
            vertical-align: middle;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            display: inline-block;
        }

        .player-card .player-position {
            font-size: 0.9em;
            color: #777;
            display: block;
            text-align: left;
        }


        .formation-options {
            padding: 10px;
            }

        .formation-options select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .formation-options #formation-select {
            position: absolute;
            left: -9999px;
            visibility: hidden;
        }

        .search-container {
            padding: 10px;
            display: none; /* Hide search container as well since player-results is hidden */
        }

        .search-container input[type="text"] {
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .filter-dropdowns {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            display: none; /* Hide filter dropdowns as well since player-results is hidden */
        }

        .filter-dropdowns select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

       /* Optional CSS for Starting Eleven Player Cards - uncomment if you want different styling
        .starting-eleven-player {
            background-color: #f0f8ff;
            border: 1px solid #add8e6;
        }
        */


        .starting-eleven-section h1,
        .starting-eleven-section {
    flex: 1 1 45%; /* Allow shrinking, set basis to ~45% */
    /* You could also use width: 45%; */
    max-width: 45%; /* Optional: enforce a max width */
    /* Keep existing styles like margin-top, padding, etc. */
    margin-top: 20px;
    padding: 15px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 1.3em;
    text-align: center;
}

       .starting-eleven-section h2 { /* Styling for headings in both sections */
           color: #333;
           margin-bottom: 15px;
           font-size: 1.5em;
           text-align: center;
       }

       .starting-eleven-container, .substitutes-container { /* Styling for player containers in both sections */
           display: flex;
           flex-direction: column;
           gap: 10px;
           max-height: 500px; /* Increased max-height for Titulares */
           overflow-y: auto;
       }

       .substitutes-section {
    flex: 1 1 45%; /* Allow shrinking, set basis to ~45% */
     /* You could also use width: 45%; */
    max-width: 45%; /* Optional: enforce a max width */
    /* Keep existing styles like margin-top, padding, etc. */
    margin-top: 20px;
    padding: 15px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}


.starting-eleven-container {
   max-height: 400px; /* Example adjustment - change as needed */
   /* Keep overflow-y: auto; */
}




       .substitutes-section h2 {
           color: #333;
           margin-bottom: 15px;
           font-size: 1.5em;
           text-align: center;
       }

       .substitutes-container {
           display: flex;
           flex-direction: column;
           gap: 10px;
           max-height: 400px; /* Adjust max-height as needed */
           overflow-y: auto;
       }

       @media (max-width: 767px) {
    .team-section {
        flex-direction: column;
        align-items: center;
        padding: 10px; /* Reduz o padding geral em mobile */
    }

    .pitch-side {
        width: 100%; /* Ocupa a largura toda */
        max-width: 400px; /* Limita o tamanho máximo do campo */
        margin-bottom: 20px;
    }

    .player-selection-side {
        display: flex;
        flex-direction: row; /* Força as secções a ficarem lado a lado */
        justify-content: space-between; /* Distribui o espaço */
        width: 100%;
        gap: 10px; /* Espaçamento menor entre as colunas */
    }

    .starting-eleven-section, .substitutes-section {
        flex: 1; /* Faz com que ambas as secções partilhem o espaço igualmente */
        max-width: none; /* Remove a limitação de 45% */
        padding: 10px;
        margin-top: 0; /* Remove a margem de cima */
    }

    .starting-eleven-section h2, .substitutes-section h2 {
        font-size: 1.1em; /* Reduz o tamanho do título para caber melhor */
        margin-bottom: 10px;
    }

    .player-card .player-name {
        font-size: 0.9em; /* Ajusta o nome do jogador */
    }

    .player-card img {
        width: 40px; /* Imagem do jogador um pouco menor */
        height: 40px;
    }
}

#user-load-spinner {
    margin-left: 10px; /* Adiciona espaço entre o dropdown e o ícone */
    color: #3498db; /* Usa uma cor azul, similar ao spinner principal */
    vertical-align: middle; /* Alinha verticalmente o ícone com o texto */
    font-size: 1.2em; /* Torna o ícone um pouco maior e mais visível */
}

    </style>
</head>
<body oncontextmenu="return false;">

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <h1>Relvado</h1>

        <div class="team-section">
            <div class="pitch-side">
                <div class="formation-options">
                    <label for="formation-select"></label>
                    <select id="formation-select">
                        <option value="4-4-2">4-4-2</option>
                        <option value="4-3-3">4-3-3</option>
                        <option value="4-5-1">4-5-1</option>
                        <option value="3-4-3">3-4-3</option>
                        <option value="5-3-2">5-3-2</option>
                    </select>
                   <label for="user-select" style="margin-left: 20px;">GPlayers:</label>
<select id="user-select">
    <option value="">Selecione um GPlayer</option>
</select>
<!-- Ícone de carregamento adicionado aqui -->
<i class="fas fa-spinner fa-spin" id="user-load-spinner" style="display: none;"></i>
                </div>

                <div class="pitch-container">
                    <div class="pitch-area">
                        <div class="center-circle"></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-side">
                <div class="starting-eleven-section">
                    <h2>11 Titulares</h2>
                    <div class="starting-eleven-container">
                        <!-- Starting eleven players will be displayed here -->
                    </div>
                </div>

                <div class="substitutes-section">  <!-- NEW SUBSTITUTES SECTION -->
                    <h2>Suplentes</h2>
                    <div class="substitutes-container">
                        <!-- Substitutes players will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-menu">
         <!-- Menu items will have 'hidden' class added/removed dynamically -->
        <a href="1x.html" class="menu-item" data-menu-key="1x">
            <i class="fas fa-home"></i>
        </a>
        <a href="market.html" class="menu-item" data-menu-key="market"> <!-- Assuming market.html link relates to 'market' setting -->
            <i class="fas fa-shopping-cart"></i>
        </a>
        <a href="team.html" class="menu-item active" data-menu-key="team">
            <i class="fas fa-users"></i>
        </a>
        <a href="empire.html" class="menu-item" data-menu-key="empire">
            <i class="fas fa-landmark empire-icon"></i>
        </a>
        <a href="rankings.html" class="menu-item" data-menu-key="rankings">
            <i class="fas fa-list"></i>
        </a>
        <a href="profile.html" class="menu-item" data-menu-key="profile">
            <i class="fas fa-user"></i>
        </a>
        <!-- Note: No 'bank' link was found, mapping 'Transações = bank' is skipped unless HTML is updated -->
    </nav>

    <script src="config.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit, where, doc, getDoc, setDoc, addDoc, FieldValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- Global Variables ---
let allPlayers = [];
let assignedPlayers = {};
let userPlayerStyles = []; // NOVA variável global para guardar os estilos do jogador
let currentUserStatus = null;
let currentUserUid = null;
let userPlayers = [];
let currentFormation = '4-4-2'; // Default formation
const formations = {
    '4-4-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '32%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '62%', positionType: 'FWD' } ],
    '4-3-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '60%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '62%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
    '4-5-1': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'DML', top: '50%', left: '47%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '10%', positionType: 'MID' }, { position: 'AMC', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '64%', positionType: 'MID' }, { position: 'DMR', top: '40%', left: '84%', positionType: 'MID' }, { position: 'FW', top: '10%', left: '47%', positionType: 'FWD' } ],
    '3-4-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DC1', top: '75%', left: '20%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC3', top: '75%', left: '77%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
    '5-3-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'SW', top: '75%', left: '10%', positionType: 'DEF' }, { position: 'WBL', top: '75%', left: '30%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '64%', positionType: 'DEF' }, { position: 'WBR', top: '75%', left: '84%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '55%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '64%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '30%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '64%', positionType: 'FWD' } ]
};
const loadingScreen = document.getElementById('loading-screen');
const content = document.querySelector('.content');
const formationSelect = document.getElementById('formation-select');
const pitchArea = document.querySelector('.pitch-area');
const userSelect = document.getElementById('user-select');
const bottomMenu = document.querySelector('.bottom-menu');

// --- Firebase Helper Functions ---
async function getUserData(userId) {
    const userDocRef = doc(db, 'users', userId);
    try {
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            return { estatuto: data.estatuto, aceite: data.aceite, exists: true };
        } else {
            return { exists: false };
        }
    } catch (error) {
        console.error("Error getting user data:", error);
        return { exists: false, error: true };
    }
}

async function getPanelMenuSettings() {
    const panelMenuDocRef = doc(db, 'paineis', 'paineis menu');
    try {
        const docSnap = await getDoc(panelMenuDocRef);
        return docSnap.exists() ? docSnap.data() : {};
    } catch (error) {
        console.error("Error getting panel menu settings:", error);
        return {};
    }
}

// --- UI Update Functions ---
function updateMenuVisibility(menuSettings) {
    const menuItems = bottomMenu.querySelectorAll('.menu-item');
    const settingToKeyMap = { '1x': '1x', 'bank': 'bank', 'empire': 'empire', 'market': 'market', 'profile': 'profile', 'rankings': 'rankings', 'team': 'team' };
    menuItems.forEach(item => {
        const menuKey = item.dataset.menuKey;
        if (menuKey) {
            const settingName = settingToKeyMap[menuKey];
            const settingValue = menuSettings[settingName];
            if (settingValue === 'off') {
                item.classList.add('hidden');
            } else {
                item.classList.remove('hidden');
            }
        }
    });
}

function renderFormation(formationName) {
    const previousFormation = currentFormation;
    const previousAssignedPlayers = { ...assignedPlayers };
    pitchArea.querySelectorAll('.position img').forEach(img => img.remove());
    assignedPlayers = {};
    currentFormation = formationName;
    const currentFormationPositions = formations[formationName];
    pitchArea.innerHTML = '<div class="center-circle"></div>';
    currentFormationPositions.forEach(pos => {
        const positionElement = document.createElement('div');
        positionElement.classList.add('position');
        positionElement.dataset.position = pos.position;
        positionElement.style.top = pos.top;
        positionElement.style.left = pos.left;
        positionElement.textContent = '+';
        positionElement.dataset.playerId = null;
        positionElement.dataset.positionType = pos.positionType;
        positionElement.addEventListener('dragover', (event) => event.preventDefault());
        positionElement.addEventListener('drop', handlePositionDrop);
        pitchArea.appendChild(positionElement);
    });
    if (previousFormation && Object.keys(previousAssignedPlayers).length > 0) {
        repositionPlayers(previousFormation, previousAssignedPlayers, formationName);
    }
}

function repositionPlayers(previousFormationName, previousAssignedPlayers, currentFormationName) {
    const currentFormationPositions = formations[currentFormationName];
    const availablePositions = currentFormationPositions.reduce((acc, pos) => {
        acc[pos.positionType] = acc[pos.positionType] || [];
        acc[pos.positionType].push(pos.position);
        return acc;
    }, {});
    const startingElevenContainer = document.querySelector('.starting-eleven-container');
    startingElevenContainer.innerHTML = '';
    for (const positionId in previousAssignedPlayers) {
        const playerId = previousAssignedPlayers[positionId];
        if (!playerId) continue;
        const player = allPlayers.find(p => p.id === playerId);
        if (!player) continue;
        const posicaoMapping = { "Avançado": "FWD", "Atacante": "FWD", "Defesa": "DEF", "Médio": "MID", "Meio-campista": "MID", "Guarda-Redes": "GK", "Goleiro": "GK" };
        const playerPosicaoIngles = posicaoMapping[player.posicao];
        if (!playerPosicaoIngles) continue;
        if (availablePositions[playerPosicaoIngles] && availablePositions[playerPosicaoIngles].length > 0) {
            const newPositionId = availablePositions[playerPosicaoIngles].shift();
            const positionElement = document.querySelector(`.position[data-position="${newPositionId}"]`);
            if (positionElement) {
                placePlayerInPosition(positionElement, player, newPositionId);
                const playerCard = createStartingElevenPlayerCard(player);
                startingElevenContainer.appendChild(playerCard);
            }
        }
    }
    updateSubstitutesList();
}

function createStartingElevenPlayerCard(player, isInteractive) { // Adicionado o parâmetro 'isInteractive'
    const card = document.createElement('div');
    card.classList.add('player-card');
    card.dataset.playerId = player.id;

    // SÓ ADICIONA A LÓGICA DE ARRASTAR SE isInteractive for verdadeiro
    if (isInteractive) {
        card.draggable = true;
        card.addEventListener('dragstart', (event) => {
            if (isPlayerAssigned(player.id)) {
                event.preventDefault();
                alert(`${player.nome} já está no relvado.`);
                return;
            }
            event.dataTransfer.setData('playerId', player.id);
            event.dataTransfer.setData('originalPositionId', 'list');
        });
    } else {
        // Se não for interativo, garante que não é arrastável e tem o cursor padrão
        card.draggable = false;
        card.style.cursor = 'default';
    }

    const img = document.createElement('img');
    img.src = player.imagem || 'placeholder_image_url.png';
    img.alt = player.nome;
    img.draggable = false;
    card.appendChild(img);

    const playerInfo = document.createElement('div');
    playerInfo.classList.add('player-info');

    const playerName = document.createElement('span');
    playerName.classList.add('player-name');
    playerName.textContent = player.nome;
    playerInfo.appendChild(playerName);

    if (player.nacionalidadebandeira) {
        const countryFlag = document.createElement('img');
        countryFlag.classList.add('country-flag');
        countryFlag.src = player.nacionalidadebandeira;
        countryFlag.alt = player.nacionalidade || '';
        countryFlag.draggable = false;
        playerName.appendChild(countryFlag);
    }

    const playerPosition = document.createElement('span');
    playerPosition.classList.add('player-position');
    playerPosition.textContent = player.posicao;
    playerInfo.appendChild(playerPosition);

    card.appendChild(playerInfo);
    return card;
}





function handlePositionDrop(event) {
    event.preventDefault();
    const playerId = event.dataTransfer.getData('playerId');
    const positionElement = event.currentTarget;
    const positionId = positionElement.dataset.position;
    const positionType = positionElement.dataset.positionType;
    const originalPositionId = event.dataTransfer.getData('originalPositionId');
    const player = allPlayers.find(p => p.id === playerId);
    if (!player) return;
    const posicaoMapping = { "Avançado": "FWD", "Atacante": "FWD", "Defesa": "DEF", "Médio": "MID", "Meio-campista": "MID", "Guarda-Redes": "GK", "Goleiro": "GK" };
    const playerPosicaoIngles = posicaoMapping[player.posicao];
    if (playerPosicaoIngles !== positionType) {
        alert(`Este jogador é ${player.posicao} e não pode ser colocado numa posição ${positionType}.`);
        return;
    }
    let playerWasSwapped = false;
    if (originalPositionId && originalPositionId !== 'list') {
        const originalPositionElement = document.querySelector(`.position[data-position="${originalPositionId}"]`);
        if (originalPositionElement && assignedPlayers[originalPositionId] === playerId) {
            removePlayerFromPositionDOM(originalPositionElement);
            delete assignedPlayers[originalPositionId];
        }
    }
    const existingPlayerId = positionElement.dataset.assignedPlayerId;
    if (existingPlayerId && existingPlayerId !== playerId) {
        const existingPlayer = allPlayers.find(p => p.id === existingPlayerId);
        if (existingPlayer && originalPositionId && originalPositionId !== 'list') {
            const originalPositionElement = document.querySelector(`.position[data-position="${originalPositionId}"]`);
            if (originalPositionElement) {
                placePlayerInPosition(originalPositionElement, existingPlayer, originalPositionId);
                playerWasSwapped = true;
            } else {
                removePlayerFromPositionDOM(positionElement);
                delete assignedPlayers[positionId];
            }
        } else {
            removePlayerFromPositionDOM(positionElement);
            delete assignedPlayers[positionId];
        }
        if (playerWasSwapped || !(originalPositionId && originalPositionId !== 'list')) {
            placePlayerInPosition(positionElement, player, positionId);
        }
    } else if (existingPlayerId !== playerId) {
        placePlayerInPosition(positionElement, player, positionId);
    }
    updateStartingElevenList();
    updateSubstitutesList();
}

function placePlayerInPosition(positionElement, player, positionId) {
    positionElement.innerHTML = '';
    const playerImg = document.createElement('img');
    playerImg.src = player.imagem || 'placeholder_image_url.png';
    playerImg.alt = player.nome;
    playerImg.draggable = true;
    positionElement.appendChild(playerImg);
    positionElement.dataset.assignedPlayerId = player.id;
    assignedPlayers[positionId] = player.id;
}

function removePlayerFromPositionDOM(positionElement) {
    if (!positionElement) return;
    positionElement.innerHTML = '+';
    positionElement.dataset.assignedPlayerId = null;
}

function updateStartingElevenList() {
    const startingElevenContainer = document.querySelector('.starting-eleven-container');
    startingElevenContainer.innerHTML = '';
    const assignedPlayerIds = Object.values(assignedPlayers).filter(id => id !== null);
 assignedPlayerIds.forEach(playerId => {
    const player = allPlayers.find(p => p.id === playerId);
    if (player) {
        // ANTES: const playerCard = createStartingElevenPlayerCard(player);
        const playerCard = createStartingElevenPlayerCard(player, false); // DEPOIS: Passar 'false'
        
        playerCard.classList.add('starting-eleven-player');
        startingElevenContainer.appendChild(playerCard);
    }
});
}

function updateSubstitutesList() {
    const substitutesContainer = document.querySelector('.substitutes-container');
    substitutesContainer.innerHTML = '';
    const assignedPlayerIds = Object.values(assignedPlayers).filter(id => id !== null);
    const substitutePlayers = allPlayers.filter(player => !assignedPlayerIds.includes(player.id));
    substitutePlayers.forEach(player => {
        const playerCard = createStartingElevenPlayerCard(player, false);
        playerCard.draggable = false;
        playerCard.style.cursor = 'default';
        substitutesContainer.appendChild(playerCard);
    });
}

function isPlayerAssigned(playerId) {
    return Object.values(assignedPlayers).includes(playerId);
}

async function fetchPlanteisData(userId, formation, season) {
    try {
        const q = query(collection(db, 'planteis'), where('userId', '==', userId), where('formacao', '==', formation), where('temporada', '==', season));
        const planteisSnapshot = await getDocs(q);
        return !planteisSnapshot.empty ? planteisSnapshot.docs[0].data() : null;
    } catch (error) {
        console.error('Error fetching planteis data:', error);
        return null;
    }
}

async function fetchAllUserPlayers(selectedUserId) {
    if (!selectedUserId) {
        allPlayers = [];
        updateStartingElevenList();
        updateSubstitutesList();
        return;
    }
    const q = query(collection(db, 'jogadores'), where('compradopor', '==', selectedUserId));
    try {
        const playersSnap = await getDocs(q);
        allPlayers = playersSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
    } catch (error) {
        console.error(`Error fetching players for user ${selectedUserId}:`, error);
        allPlayers = [];
    }
}

// NOVA FUNÇÃO para carregar os Estilos de Jogador do utilizador selecionado
async function fetchPlayerStyles(selectedUserId) {
    if (!selectedUserId) {
        userPlayerStyles = [];
        return;
    }
    try {
        const q = query(
            collection(db, 'movimentos'), 
            where('userId', '==', selectedUserId), 
            where('empireTipo', '==', 'Estilos de Jogador')
        );
        const snapshot = await getDocs(q);
        userPlayerStyles = snapshot.docs.map(doc => ({ 
            id: doc.id, 
            nome: doc.data().itemEmpire, 
            imagem: doc.data().imagem
        }));
    } catch (error) {
        console.error(`Error fetching player styles for user ${selectedUserId}:`, error);
        userPlayerStyles = [];
    }
}

// VERSÃO ATUALIZADA da função para incluir o carregamento dos Estilos
async function loadUserTeam() {
    const selectedUserId = userSelect.value;
    const selectedFormation = formationSelect.value;

    if (!selectedUserId) {
        renderFormation(selectedFormation);
        updateStartingElevenList();
        updateSubstitutesList();
        return;
    }

    // 1. Limpa os ícones de estilo antigos antes de carregar novos
    pitchArea.querySelectorAll('.player-style-icon').forEach(icon => icon.remove());

    // 2. Carrega os jogadores E os estilos do utilizador selecionado
    await fetchAllUserPlayers(selectedUserId);
    await fetchPlayerStyles(selectedUserId); // Adiciona a chamada para carregar os estilos

    // Limpa o campo e o estado antes de carregar
    pitchArea.querySelectorAll('.position img:not(.player-style-icon)').forEach(img => img.remove());
    pitchArea.querySelectorAll('.position').forEach(pos => {
        pos.textContent = '+';
        pos.dataset.assignedPlayerId = null;
    });
    assignedPlayers = {};

    document.querySelector('.starting-eleven-container').innerHTML = '';
    document.querySelector('.substitutes-container').innerHTML = '';
document.addEventListener('contextmenu', function(event) {
    event.preventDefault();
});

    try {
        const configDocRef = doc(db, 'paineis', 'configuracoes_gerais');
        const configDocSnap = await getDoc(configDocRef);
        let latestSeason = '';

        if (configDocSnap.exists() && configDocSnap.data().temporadaAtual) {
            latestSeason = configDocSnap.data().temporadaAtual;
        } else {
            console.error('Documento de configuração "paineis/configuracoes_gerais" ou campo "temporadaAtual" não encontrado.');
            updateStartingElevenList();
            updateSubstitutesList();
            return;
        }

        const plantelData = await fetchPlanteisData(selectedUserId, selectedFormation, latestSeason);

        if (plantelData) {
            // Coloca os jogadores no campo (código existente)
            const positions = pitchArea.querySelectorAll('.position');
            positions.forEach(positionElement => {
                const positionId = positionElement.dataset.position;
                const playerId = plantelData[positionId];
                if (playerId) {
                    const player = allPlayers.find(p => p.id === playerId);
                    if (player) {
                        placePlayerInPosition(positionElement, player, positionId);
                    }
                }
            });

            // 3. Adiciona a lógica para exibir os estilos guardados
            if (plantelData.estilos) {
                Object.entries(plantelData.estilos).forEach(([positionId, styleId]) => {
                    const positionElement = pitchArea.querySelector(`.position[data-position="${positionId}"]`);
                    const styleData = userPlayerStyles.find(s => s.id === styleId);

                    if (positionElement && styleData) {
                        const styleIcon = document.createElement('img');
                        styleIcon.src = styleData.imagem;
                        styleIcon.classList.add('player-style-icon'); // Aplica o nosso CSS!
                        positionElement.appendChild(styleIcon);
                    }
                });
            }
        }

        updateStartingElevenList();
        updateSubstitutesList();

    } catch (error) {
        console.error('Error loading user team:', error);
        assignedPlayers = {};
        updateStartingElevenList();
        updateSubstitutesList();
    }
}

async function loadUsers() {
    try {
        const usersRef = collection(db, 'users');
        const querySnapshot = await getDocs(usersRef);
        const users = [];
        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            if (userData.natabela === "Yes") {
                users.push({ id: doc.id, displayNome: userData.nometabela });
            }
        });
        users.sort((a, b) => a.displayNome.localeCompare(b.displayNome));
        const userSelect = document.getElementById('user-select');
        while (userSelect.options.length > 1) {
            userSelect.remove(1);
        }
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.displayNome;
            userSelect.appendChild(option);
        });
        userSelect.removeEventListener('change', handleUserSelectionChange);
        userSelect.addEventListener('change', handleUserSelectionChange);
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

async function handleUserSelectionChange(event) {
    const spinner = document.getElementById('user-load-spinner');
    spinner.style.display = 'inline-block';
    try {
        const selectedUserId = event.target.value;
        if (!selectedUserId) {
            allPlayers = [];
            assignedPlayers = {};
            renderFormation(formationSelect.value);
            updateStartingElevenList();
            updateSubstitutesList();
            return;
        }
        await loadUserTeam();
    } catch (error) {
        console.error("Ocorreu um erro ao carregar a equipa do utilizador:", error);
    } finally {
        spinner.style.display = 'none';
    }
}

// --- Initialization and Event Listeners ---
formationSelect.addEventListener('change', (event) => {
    const selectedFormation = event.target.value;
    renderFormation(selectedFormation);
    loadUserTeam();
});

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUserUid = user.uid;
        const [userData, panelSettings] = await Promise.all([
            getUserData(currentUserUid),
            getPanelMenuSettings()
        ]);

        if (userData.error || !userData.exists) {
            window.location.href = '404.html';
            return;
        }

        currentUserStatus = userData.estatuto;
        const isUserAccepted = userData.aceite === "Yes";
        const teamPanelSetting = panelSettings?.team;
        updateMenuVisibility(panelSettings || {});
        const canAccessTeamPage = teamPanelSetting === 'on' || (teamPanelSetting === 'off' && currentUserStatus === 'ruler');

        if (!isUserAccepted || !canAccessTeamPage) {
            window.location.href = '404.html';
            return;
        }

        await loadUsers();
        renderFormation(formationSelect.value);
        loadingScreen.style.display = 'none';
        content.style.display = 'block';

    } else {
        window.location.href = 'index.html';
    }
});
    </script>
</body>
</html>
