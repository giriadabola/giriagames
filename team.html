<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relvado - Ggames</title>
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEiIbiLnCB/s320/soccer-ball-png.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- NEW: Modern Color Palette & Global Styles --- */
        :root {
            --bg-color: #f0f2f5;
            --primary-text: #2c3e50;
            --secondary-text: #7f8c8d;
            --card-bg: #ffffff;
            --accent-color: #3498db;
            --pitch-dark-green: #27ae60;
            --pitch-light-green: #2ecc71;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: var(--bg-color);
            font-family: 'Poppins', Arial, sans-serif; /* NEW: Font */
            color: var(--primary-text);
        }
        
        /* --- NEW: Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }



        .content {
            padding: 20px;
            margin-bottom: 80px;
            display: none;
        }

        h1, h2 {
            font-weight: 600; /* Bolder headings */
        }

        h1 {
            color: var(--primary-text);
            margin-bottom: 25px;
            text-align: center;
        }

        /* --- Loading Screen (Unchanged) --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f0f0; display: flex; justify-content: center;
            align-items: center; z-index: 1001;
        }
        .loading-spinner {
            border: 16px solid #f3f3f3; border-top: 16px solid var(--accent-color);
            border-radius: 50%; width: 120px; height: 120px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- UPDATED: Main Layout --- */
        .team-section {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 30px; /* Increased gap */
            padding: 20px;
        }

        .pitch-side, .player-selection-side {
            flex: 1;
            min-width: 300px;
        }

        .player-selection-side {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        /* --- UPDATED: Pitch Area --- */
        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            aspect-ratio: 3 / 4; /* More realistic pitch ratio */
            height: auto;
            padding-bottom: 0;
            border-radius: 15px; /* Softer radius */
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            /* NEW: Realistic pitch stripes */
            background: repeating-linear-gradient(
                to bottom,
                var(--pitch-dark-green),
                var(--pitch-dark-green) 20%,
                var(--pitch-light-green) 20%,
                var(--pitch-light-green) 40%
            );
        }

        .pitch-area {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 96%; height: 94%;
            border: 2px solid rgba(255, 255, 255, 0.5); /* Thicker, softer lines */
            border-radius: 5px;
        }
        
        .pitch-area::after { /* Center line */
            content: ''; position: absolute; width: 100%; height: 2px;
            top: 50%; left: 0; background-color: rgba(255, 255, 255, 0.5);
        }

        .center-circle {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 15%; height: 15%; /* Responsive size */
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }

        /* --- UPDATED: Player Position Markers on Pitch --- */
        .position {
            position: absolute;
            width: 35px; height: 35px;
            background-color: rgba(255, 255, 255, 0.2); /* Softer placeholder */
            backdrop-filter: blur(2px); /* NEW: Glass effect */
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            font-size: 24px; font-weight: 300;
            color: white;
            transition: all 0.3s ease;
        }

        .position:hover {
            background-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1); /* NEW: Hover effect */
        }
        
        /* When a player is added, the '+' is gone */
        .position:not(:empty) {
            background-color: transparent;
            border: none;
            backdrop-filter: none;
        }

        .position img {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 65px; height: 65px; /* Slightly larger */
            border-radius: 50%; object-fit: cover; z-index: 1;
            border: 3px solid var(--card-bg); /* NEW: Nice border */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* NEW: Depth */
        }
        
        /* Unchanged styles for player style icon */
        .player-style-icon{position:absolute!important;z-index:2!important;cursor:pointer!important;top:auto!important;left:auto!important;transform:none!important;bottom:-30px!important;right:-16px!important;width:40px!important;height:40px!important;border-radius:50%!important;border:none!important;box-shadow:none!important;background-color:transparent!important}

        /* --- UPDATED: Controls / Selectors --- */
        .formation-options {
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .formation-options label { margin-right: 10px; font-weight: 500; }
        
        .formation-options select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #fff;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
        }
        
        /* Hiding original formation select */
        .formation-options #formation-select { position: absolute; left: -9999px; visibility: hidden; }

        /* --- UPDATED: Player Lists & Cards --- */
        .starting-eleven-section, .substitutes-section {
            flex: 1 1 45%;
            max-width: 45%;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 15px; /* Softer radius */
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .starting-eleven-section h2, .substitutes-section h2 {
           color: var(--primary-text);
           margin-bottom: 20px;
           font-size: 1.4em;
           font-weight: 600;
           text-align: center;
           border-bottom: 1px solid var(--border-color); /* NEW: Separator */
           padding-bottom: 10px;
        }
        
        .starting-eleven-container, .substitutes-container {
           display: flex; flex-direction: column; gap: 12px;
           max-height: 500px; overflow-y: auto;
           padding-right: 5px; /* Space for scrollbar */
        }

        .player-card {
            border: 1px solid transparent; /* Start transparent */
            padding: 8px; border-radius: 10px;
            text-align: left; cursor: pointer;
            background-color: var(--bg-color);
            transition: all 0.3s ease;
            display: flex; align-items: center;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
            border-color: var(--accent-color); /* Highlight on hover */
        }
        
        .starting-eleven-player {
            background-color: #e0f7fa;
            border: 1px solid #b3e5fc;
        }

        .player-card img {
            width: 50px; height: 50px; border-radius: 50%;
            object-fit: cover; margin-right: 15px;
            border: 2px solid #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .player-card .player-info { flex: 1; }
        .player-card .player-name { font-weight: 500; font-size: 0.95em; }

        .player-card .country-flag {
            width: 20px; height: auto; margin-left: 8px;
            vertical-align: middle; border: none; border-radius: 3px;
            box-shadow: none; display: inline-block;
        }

        .player-card .player-position {
            font-size: 0.85em; color: var(--secondary-text);
            display: block; text-align: left;
        }
        
        #user-load-spinner {
            margin-left: 10px; color: var(--accent-color);
            vertical-align: middle; font-size: 1.2em;
        }

        /* --- UPDATED: Mobile Responsiveness --- */
        @media (max-width: 767px) {
            h1 { font-size: 1.8em; }
            .content { padding: 10px; }
            .team-section { flex-direction: column; align-items: center; padding: 10px; gap: 20px; }
            
            .pitch-side {
                width: 100%; max-width: 400px; margin-bottom: 20px;
            }

            .player-selection-side {
                flex-direction: column; /* Stack lists vertically on mobile */
                width: 100%; gap: 20px;
            }

            .starting-eleven-section, .substitutes-section {
                width: 100%; /* Full width for each list */
                max-width: none;
                padding: 15px; margin-top: 0;
            }

            .starting-eleven-section h2, .substitutes-section h2 {
                font-size: 1.2em;
            }
            
            .player-card .player-name { font-size: 0.9em; }
            .player-card img { width: 40px; height: 40px; }
        }

    </style>
</head>
<body oncontextmenu="return false;">

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <h1>Relvado</h1> <!-- Title Changed -->

        <div class="team-section">
            <div class="pitch-side">
                <div class="formation-options">
                    <label for="user-select">GPlayers:</label>
                    <select id="user-select">
                        <option value="">Selecione um GPlayer</option>
                    </select>
                    <i class="fas fa-spinner fa-spin" id="user-load-spinner" style="display: none;"></i>
                    <!-- Hidden formation select, logic is in JS -->
                    <select id="formation-select">
                        <option value="4-4-2">4-4-2</option>
                        <option value="4-3-3">4-3-3</option>
                        <option value="4-5-1">4-5-1</option>
                        <option value="3-4-3">3-4-3</option>
                        <option value="5-3-2">5-3-2</option>
                    </select>
                </div>

                <div class="pitch-container">
                    <div class="pitch-area">
                        <div class="center-circle"></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-side">
                <div class="starting-eleven-section">
                    <h2>11 Titulares</h2>
                    <div class="starting-eleven-container">
                        <!-- Starting eleven players will be displayed here -->
                    </div>
                </div>

                <div class="substitutes-section">
                    <h2>Suplentes</h2>
                    <div class="substitutes-container">
                        <!-- Substitutes players will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

 
    
    <script src="config.js"></script>
    <script type="module">
        // Your JavaScript remains exactly the same.
        // Paste it here.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit, where, doc, getDoc, setDoc, addDoc, FieldValue, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

async function logUserAction(actionDescription) {
    if (!auth.currentUser) {
        console.log("Nenhum utilizador logado para registar a ação.");
        return;
    }
    
    try {
        const eyeCollection = collection(db, 'eye');
        await addDoc(eyeCollection, {
            dataacao: serverTimestamp(),
            acao: actionDescription,
            userId: auth.currentUser.uid
        });
    } catch (error) {
        console.error("Erro ao registar ação na coleção 'eye':", error);
    }
}

// --- Global Variables ---
let allPlayers = [];
let assignedPlayers = {};
let userPlayerStyles = []; // NOVA variável global para guardar os estilos do jogador
let currentUserStatus = null;
let currentUserUid = null;
let userPlayers = [];
let currentFormation = '4-4-2'; // Default formation
const formations = {
    '4-4-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '32%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '62%', positionType: 'FWD' } ],
    '4-3-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '60%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '62%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
    '4-5-1': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'DML', top: '50%', left: '47%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '10%', positionType: 'MID' }, { position: 'AMC', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '64%', positionType: 'MID' }, { position: 'DMR', top: '40%', left: '84%', positionType: 'MID' }, { position: 'FW', top: '10%', left: '47%', positionType: 'FWD' } ],
    '3-4-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DC1', top: '75%', left: '20%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC3', top: '75%', left: '77%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
    '5-3-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'SW', top: '75%', left: '10%', positionType: 'DEF' }, { position: 'WBL', top: '75%', left: '30%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '64%', positionType: 'DEF' }, { position: 'WBR', top: '75%', left: '84%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '55%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '64%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '30%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '64%', positionType: 'FWD' } ]
};
const loadingScreen = document.getElementById('loading-screen');
const content = document.querySelector('.content');
const formationSelect = document.getElementById('formation-select');
const pitchArea = document.querySelector('.pitch-area');
const userSelect = document.getElementById('user-select');
const bottomMenu = document.querySelector('.bottom-menu');

// --- Firebase Helper Functions ---
async function getUserData(userId) {
    const userDocRef = doc(db, 'users', userId);
    try {
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            return { estatuto: data.estatuto, aceite: data.aceite, exists: true };
        } else {
            return { exists: false };
        }
    } catch (error) {
        console.error("Error getting user data:", error);
        return { exists: false, error: true };
    }
}

async function getPanelMenuSettings() {
    const panelMenuDocRef = doc(db, 'paineis', 'paineis menu');
    try {
        const docSnap = await getDoc(panelMenuDocRef);
        return docSnap.exists() ? docSnap.data() : {};
    } catch (error) {
        console.error("Error getting panel menu settings:", error);
        return {};
    }
}

// --- UI Update Functions ---


function renderFormation(formationName) {
    const previousFormation = currentFormation;
    const previousAssignedPlayers = { ...assignedPlayers };
    pitchArea.querySelectorAll('.position img').forEach(img => img.remove());
    assignedPlayers = {};
    currentFormation = formationName;
    const currentFormationPositions = formations[formationName];
    pitchArea.innerHTML = '<div class="center-circle"></div>';
    currentFormationPositions.forEach(pos => {
        const positionElement = document.createElement('div');
        positionElement.classList.add('position');
        positionElement.dataset.position = pos.position;
        positionElement.style.top = pos.top;
        positionElement.style.left = pos.left;
        positionElement.textContent = '+';
        positionElement.dataset.playerId = null;
        positionElement.dataset.positionType = pos.positionType;
        positionElement.addEventListener('dragover', (event) => event.preventDefault());
        positionElement.addEventListener('drop', handlePositionDrop);
        pitchArea.appendChild(positionElement);
    });
    if (previousFormation && Object.keys(previousAssignedPlayers).length > 0) {
        repositionPlayers(previousFormation, previousAssignedPlayers, formationName);
    }
}

function repositionPlayers(previousFormationName, previousAssignedPlayers, currentFormationName) {
    const currentFormationPositions = formations[currentFormationName];
    const availablePositions = currentFormationPositions.reduce((acc, pos) => {
        acc[pos.positionType] = acc[pos.positionType] || [];
        acc[pos.positionType].push(pos.position);
        return acc;
    }, {});
    const startingElevenContainer = document.querySelector('.starting-eleven-container');
    startingElevenContainer.innerHTML = '';
    for (const positionId in previousAssignedPlayers) {
        const playerId = previousAssignedPlayers[positionId];
        if (!playerId) continue;
        const player = allPlayers.find(p => p.id === playerId);
        if (!player) continue;
        const posicaoMapping = { "Avançado": "FWD", "Atacante": "FWD", "Defesa": "DEF", "Médio": "MID", "Meio-campista": "MID", "Guarda-Redes": "GK", "Goleiro": "GK" };
        const playerPosicaoIngles = posicaoMapping[player.posicao];
        if (!playerPosicaoIngles) continue;
        if (availablePositions[playerPosicaoIngles] && availablePositions[playerPosicaoIngles].length > 0) {
            const newPositionId = availablePositions[playerPosicaoIngles].shift();
            const positionElement = document.querySelector(`.position[data-position="${newPositionId}"]`);
            if (positionElement) {
                placePlayerInPosition(positionElement, player, newPositionId);
                const playerCard = createStartingElevenPlayerCard(player);
                startingElevenContainer.appendChild(playerCard);
            }
        }
    }
    updateSubstitutesList();
}

function createStartingElevenPlayerCard(player, isInteractive) { // Adicionado o parâmetro 'isInteractive'
    const card = document.createElement('div');
    card.classList.add('player-card');
    card.dataset.playerId = player.id;

    // SÓ ADICIONA A LÓGICA DE ARRASTAR SE isInteractive for verdadeiro
    if (isInteractive) {
        card.draggable = true;
        card.addEventListener('dragstart', (event) => {
            if (isPlayerAssigned(player.id)) {
                event.preventDefault();
                alert(`${player.nome} já está no relvado.`);
                return;
            }
            event.dataTransfer.setData('playerId', player.id);
            event.dataTransfer.setData('originalPositionId', 'list');
        });
    } else {
        // Se não for interativo, garante que não é arrastável e tem o cursor padrão
        card.draggable = false;
        card.style.cursor = 'default';
    }

    const img = document.createElement('img');
    img.src = player.imagem || 'placeholder_image_url.png';
    img.alt = player.nome;
    img.draggable = false;
    card.appendChild(img);

    const playerInfo = document.createElement('div');
    playerInfo.classList.add('player-info');

    const playerName = document.createElement('span');
    playerName.classList.add('player-name');
    playerName.textContent = player.nome;
    playerInfo.appendChild(playerName);

    if (player.nacionalidadebandeira) {
        const countryFlag = document.createElement('img');
        countryFlag.classList.add('country-flag');
        countryFlag.src = player.nacionalidadebandeira;
        countryFlag.alt = player.nacionalidade || '';
        countryFlag.draggable = false;
        playerName.appendChild(countryFlag);
    }

    const playerPosition = document.createElement('span');
    playerPosition.classList.add('player-position');
    playerPosition.textContent = player.posicao;
    playerInfo.appendChild(playerPosition);

    card.appendChild(playerInfo);
    return card;
}





function handlePositionDrop(event) {
    event.preventDefault();
    const playerId = event.dataTransfer.getData('playerId');
    const positionElement = event.currentTarget;
    const positionId = positionElement.dataset.position;
    const positionType = positionElement.dataset.positionType;
    const originalPositionId = event.dataTransfer.getData('originalPositionId');
    const player = allPlayers.find(p => p.id === playerId);
    if (!player) return;
    const posicaoMapping = { "Avançado": "FWD", "Atacante": "FWD", "Defesa": "DEF", "Médio": "MID", "Meio-campista": "MID", "Guarda-Redes": "GK", "Goleiro": "GK" };
    const playerPosicaoIngles = posicaoMapping[player.posicao];
    if (playerPosicaoIngles !== positionType) {
        alert(`Este jogador é ${player.posicao} e não pode ser colocado numa posição ${positionType}.`);
        return;
    }
    let playerWasSwapped = false;
    if (originalPositionId && originalPositionId !== 'list') {
        const originalPositionElement = document.querySelector(`.position[data-position="${originalPositionId}"]`);
        if (originalPositionElement && assignedPlayers[originalPositionId] === playerId) {
            removePlayerFromPositionDOM(originalPositionElement);
            delete assignedPlayers[originalPositionId];
        }
    }
    const existingPlayerId = positionElement.dataset.assignedPlayerId;
    if (existingPlayerId && existingPlayerId !== playerId) {
        const existingPlayer = allPlayers.find(p => p.id === existingPlayerId);
        if (existingPlayer && originalPositionId && originalPositionId !== 'list') {
            const originalPositionElement = document.querySelector(`.position[data-position="${originalPositionId}"]`);
            if (originalPositionElement) {
                placePlayerInPosition(originalPositionElement, existingPlayer, originalPositionId);
                playerWasSwapped = true;
            } else {
                removePlayerFromPositionDOM(positionElement);
                delete assignedPlayers[positionId];
            }
        } else {
            removePlayerFromPositionDOM(positionElement);
            delete assignedPlayers[positionId];
        }
        if (playerWasSwapped || !(originalPositionId && originalPositionId !== 'list')) {
            placePlayerInPosition(positionElement, player, positionId);
        }
    } else if (existingPlayerId !== playerId) {
        placePlayerInPosition(positionElement, player, positionId);
    }
    updateStartingElevenList();
    updateSubstitutesList();
}

function placePlayerInPosition(positionElement, player, positionId) {
    positionElement.innerHTML = '';
    const playerImg = document.createElement('img');
    playerImg.src = player.imagem || 'placeholder_image_url.png';
    playerImg.alt = player.nome;
    playerImg.draggable = true;
    positionElement.appendChild(playerImg);
    positionElement.dataset.assignedPlayerId = player.id;
    assignedPlayers[positionId] = player.id;
}

function removePlayerFromPositionDOM(positionElement) {
    if (!positionElement) return;
    positionElement.innerHTML = '+';
    positionElement.dataset.assignedPlayerId = null;
}

function updateStartingElevenList() {
    const startingElevenContainer = document.querySelector('.starting-eleven-container');
    startingElevenContainer.innerHTML = '';
    const assignedPlayerIds = Object.values(assignedPlayers).filter(id => id !== null);
 assignedPlayerIds.forEach(playerId => {
    const player = allPlayers.find(p => p.id === playerId);
    if (player) {
        // ANTES: const playerCard = createStartingElevenPlayerCard(player);
        const playerCard = createStartingElevenPlayerCard(player, false); // DEPOIS: Passar 'false'
        
        playerCard.classList.add('starting-eleven-player');
        startingElevenContainer.appendChild(playerCard);
    }
});
}

function updateSubstitutesList() {
    const substitutesContainer = document.querySelector('.substitutes-container');
    substitutesContainer.innerHTML = '';
    const assignedPlayerIds = Object.values(assignedPlayers).filter(id => id !== null);
    const substitutePlayers = allPlayers.filter(player => !assignedPlayerIds.includes(player.id));
    substitutePlayers.forEach(player => {
        const playerCard = createStartingElevenPlayerCard(player, false);
        playerCard.draggable = false;
        playerCard.style.cursor = 'default';
        substitutesContainer.appendChild(playerCard);
    });
}

function isPlayerAssigned(playerId) {
    return Object.values(assignedPlayers).includes(playerId);
}

async function fetchPlanteisData(userId, formation, season) {
    try {
        const q = query(collection(db, 'planteis'), where('userId', '==', userId), where('formacao', '==', formation), where('temporada', '==', season));
        const planteisSnapshot = await getDocs(q);
        return !planteisSnapshot.empty ? planteisSnapshot.docs[0].data() : null;
    } catch (error) {
        console.error('Error fetching planteis data:', error);
        return null;
    }
}

async function fetchAllUserPlayers(selectedUserId) {
    if (!selectedUserId) {
        allPlayers = [];
        updateStartingElevenList();
        updateSubstitutesList();
        return;
    }
    const q = query(collection(db, 'jogadores'), where('compradopor', '==', selectedUserId));
    try {
        const playersSnap = await getDocs(q);
        allPlayers = playersSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
    } catch (error) {
        console.error(`Error fetching players for user ${selectedUserId}:`, error);
        allPlayers = [];
    }
}

// NOVA FUNÇÃO para carregar os Estilos de Jogador do utilizador selecionado
async function fetchPlayerStyles(selectedUserId) {
    if (!selectedUserId) {
        userPlayerStyles = [];
        return;
    }
    try {
        const q = query(
            collection(db, 'movimentos'), 
            where('userId', '==', selectedUserId), 
            where('empireTipo', '==', 'Estilos de Jogador')
        );
        const snapshot = await getDocs(q);
        userPlayerStyles = snapshot.docs.map(doc => ({ 
            id: doc.id, 
            nome: doc.data().itemEmpire, 
            imagem: doc.data().imagem
        }));
    } catch (error) {
        console.error(`Error fetching player styles for user ${selectedUserId}:`, error);
        userPlayerStyles = [];
    }
}

// VERSÃO ATUALIZADA da função para incluir o carregamento dos Estilos
async function loadUserTeam() {
    const selectedUserId = userSelect.value;
    const selectedFormation = formationSelect.value;

    if (!selectedUserId) {
        renderFormation(selectedFormation);
        updateStartingElevenList();
        updateSubstitutesList();
        return;
    }

    // 1. Limpa os ícones de estilo antigos antes de carregar novos
    pitchArea.querySelectorAll('.player-style-icon').forEach(icon => icon.remove());

    // 2. Carrega os jogadores E os estilos do utilizador selecionado
    await fetchAllUserPlayers(selectedUserId);
    await fetchPlayerStyles(selectedUserId); // Adiciona a chamada para carregar os estilos

    // Limpa o campo e o estado antes de carregar
    pitchArea.querySelectorAll('.position img:not(.player-style-icon)').forEach(img => img.remove());
    pitchArea.querySelectorAll('.position').forEach(pos => {
        pos.textContent = '+';
        pos.dataset.assignedPlayerId = null;
    });
    assignedPlayers = {};

    document.querySelector('.starting-eleven-container').innerHTML = '';
    document.querySelector('.substitutes-container').innerHTML = '';
document.addEventListener('contextmenu', function(event) {
    event.preventDefault();
});

    try {
        const configDocRef = doc(db, 'paineis', 'configuracoes_gerais');
        const configDocSnap = await getDoc(configDocRef);
        let latestSeason = '';

        if (configDocSnap.exists() && configDocSnap.data().temporadaAtual) {
            latestSeason = configDocSnap.data().temporadaAtual;
        } else {
            console.error('Documento de configuração "paineis/configuracoes_gerais" ou campo "temporadaAtual" não encontrado.');
            updateStartingElevenList();
            updateSubstitutesList();
            return;
        }

        const plantelData = await fetchPlanteisData(selectedUserId, selectedFormation, latestSeason);

        if (plantelData) {
            // Coloca os jogadores no campo (código existente)
            const positions = pitchArea.querySelectorAll('.position');
            positions.forEach(positionElement => {
                const positionId = positionElement.dataset.position;
                const playerId = plantelData[positionId];
                if (playerId) {
                    const player = allPlayers.find(p => p.id === playerId);
                    if (player) {
                        placePlayerInPosition(positionElement, player, positionId);
                    }
                }
            });

            // 3. Adiciona a lógica para exibir os estilos guardados
            if (plantelData.estilos) {
                Object.entries(plantelData.estilos).forEach(([positionId, styleId]) => {
                    const positionElement = pitchArea.querySelector(`.position[data-position="${positionId}"]`);
                    const styleData = userPlayerStyles.find(s => s.id === styleId);

                    if (positionElement && styleData) {
                        const styleIcon = document.createElement('img');
                        styleIcon.src = styleData.imagem;
                        styleIcon.classList.add('player-style-icon'); // Aplica o nosso CSS!
                        positionElement.appendChild(styleIcon);
                    }
                });
            }
        }

        updateStartingElevenList();
        updateSubstitutesList();

    } catch (error) {
        console.error('Error loading user team:', error);
        assignedPlayers = {};
        updateStartingElevenList();
        updateSubstitutesList();
    }
}

async function loadUsers() {
    try {
        const usersRef = collection(db, 'users');
        const querySnapshot = await getDocs(usersRef);
        const users = [];
        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            if (userData.natabela === "Yes") {
                users.push({ id: doc.id, displayNome: userData.nometabela });
            }
        });
        users.sort((a, b) => a.displayNome.localeCompare(b.displayNome));
        const userSelect = document.getElementById('user-select');
        while (userSelect.options.length > 1) {
            userSelect.remove(1);
        }
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.displayNome;
            userSelect.appendChild(option);
        });
        userSelect.removeEventListener('change', handleUserSelectionChange);
        userSelect.addEventListener('change', handleUserSelectionChange);
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

async function handleUserSelectionChange(event) {
    const spinner = document.getElementById('user-load-spinner');
    spinner.style.display = 'inline-block';
    try {
        const selectedUserId = event.target.value;
        const selectedUserName = event.target.options[event.target.selectedIndex].text;
        
        // Log da ação
        logUserAction(`Visualizou a equipa de: ${selectedUserName}`);

        if (!selectedUserId) {
            allPlayers = [];
            assignedPlayers = {};
            renderFormation(formationSelect.value);
            updateStartingElevenList();
            updateSubstitutesList();
            return;
        }
        await loadUserTeam();
    } catch (error) {
        console.error("Ocorreu um erro ao carregar a equipa do utilizador:", error);
    } finally {
        spinner.style.display = 'none';
    }
}

// --- Initialization and Event Listeners ---
formationSelect.addEventListener('change', (event) => {
    const selectedFormation = event.target.value;
    
    // Log da ação
    logUserAction(`Mudou a visualização da formação para: ${selectedFormation}`);
    
    renderFormation(selectedFormation);
    loadUserTeam();
});

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUserUid = user.uid;

        // Atualiza o último acesso do utilizador
        try {
            await updateDoc(doc(db, 'users', user.uid), {
                ultimoacesso: serverTimestamp()
            });
        } catch (error) {
            console.error("Erro ao atualizar o campo ultimoacesso: ", error);
        }

        const [userData, panelSettings] = await Promise.all([
            getUserData(currentUserUid),
            getPanelMenuSettings()
        ]);

        if (userData.error || !userData.exists) {
            window.location.href = '404.html';
            return;
        }

        currentUserStatus = userData.estatuto;
        const isUserAccepted = userData.aceite === "Yes";
        const teamPanelSetting = panelSettings?.team;
        updateMenuVisibility(panelSettings || {});
        const canAccessTeamPage = teamPanelSetting === 'on' || (teamPanelSetting === 'off' && currentUserStatus === 'ruler');

        if (!isUserAccepted || !canAccessTeamPage) {
            window.location.href = '404.html';
            return;
        }

        // Regista a entrada na página no log
        await logUserAction(`Entrou em ${document.title}`);

        await loadUsers();
        renderFormation(formationSelect.value);
        loadingScreen.style.display = 'none';
        content.style.display = 'block';

    } else {
        window.location.href = 'index.html';
    }
});

document.addEventListener('click', async (event) => {
    const menuItem = event.target.closest('a.menu-item');

    if (!menuItem) return;

    const actionName = `Navegou para: ${menuItem.querySelector('.menu-text')?.textContent.trim() || 'Menu'}`;
    
    event.preventDefault();
    await logUserAction(actionName);
    window.location.href = menuItem.href;
});

    </script>
    <script src="menu-component.js"></script> 
</body>
</html>
