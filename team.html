<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relvado - Ggames</title>
        <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEiIbiLnCB/s320/soccer-ball-png.webp">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ... (Seu CSS original - o mesmo do código anterior correto) ... */
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex; /* Default display */
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
        }

        /* Style for hidden menu items */
        .menu-item.hidden {
            display: none;
        }


        .menu-item:hover, .menu-item.active {
            color: #333;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #2176ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(33, 118, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover {
            color: #0056d6;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(33, 118, 255, 0.6));
        }

        .content {
            padding: 20px;
            margin-bottom: 80px;
            display: none; /* Initially hidden */
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Ensure it's above content but below potential modals */
        }

        .loading-spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

      .team-section {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    padding: 20px;
}

        @media (min-width: 768px) {
            .team-section {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .pitch-side, .player-selection-side {
            flex: 1;
            min-width: 300px;
        }

        .player-selection-side {
    display: flex; /* Arrange children in a row */
    gap: 20px; /* Add space between the two sections */
    align-items: flex-start; /* Align items to the top */
}


        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 0;
            padding-bottom: 75%;
            background-color: #2d6a4f;
            border: 1px solid #228B22;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .pitch-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 96%;
            height: 94%;
            border: 1px solid white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }


        .pitch-area::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
            background-color: white;
            z-index: 0; /* Optionally add this to ensure line is behind, although default is 0 */
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 1px solid white;
            border-radius: 50%;
        }

        .position {
            position: absolute;
            width: 30px; /* Tamanho original da "bola" */
            height: 30px; /* Tamanho original da "bola" */
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            color: white;
            transition: background-color 0.3s ease;
            border: none;
        }

        .position:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .position img {
            position: absolute; /* Posicionamento absoluto para sobrepor a "bola" */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centraliza a imagem */
            width: 60px; /* Dobro do tamanho da "bola" */
            height: 60px; /* Dobro do tamanho da "bola" */
            border-radius: 50%;
            object-fit: cover;
            /* pointer-events: none; REMOVED THIS LINE */
            z-index: 1; /* Add this line to bring player images forward */
        }


        .formation-options {
            margin-bottom: 10px;
        }

        .formation-options label {
            margin-right: 10px;
            font-weight: bold;
        }

        .player-search-section {
        }

        .player-search-bar {
        }

        .player-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-results {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
            width: 100%;
            display: none; /* Hide player results section */
        }

        .starting-eleven-player {
        background-color: #e0f7fa; /* Cor de fundo mais clara para jogadores do 11 inicial */
        border: 2px solid #81d4fa; /* Borda para destacar */
    }

        .player-card {
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .player-card:hover {
            background-color: #eaeaea;
        }

        .player-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .player-card .player-info {
            flex: 1;
        }

        .player-card .player-name {
            font-weight: bold;
            display: inline-block; /* Display inline to be in the same line as flag */
        }

        .player-card .country-flag {
            width: 20px;
            height: 15px;
            object-fit: contain;
            margin-left: 0px; /* Changed from 5px to 0px to move flag closer to name */
            vertical-align: middle;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            display: inline-block;
        }

        .player-card .player-position {
            font-size: 0.9em;
            color: #777;
            display: block;
            text-align: left;
        }


        .formation-options {
            padding: 10px;
            }

        .formation-options select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .formation-options #formation-select {
            position: absolute;
            left: -9999px;
            visibility: hidden;
        }

        .search-container {
            padding: 10px;
            display: none; /* Hide search container as well since player-results is hidden */
        }

        .search-container input[type="text"] {
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .filter-dropdowns {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            display: none; /* Hide filter dropdowns as well since player-results is hidden */
        }

        .filter-dropdowns select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

       /* Optional CSS for Starting Eleven Player Cards - uncomment if you want different styling
        .starting-eleven-player {
            background-color: #f0f8ff;
            border: 1px solid #add8e6;
        }
        */


        .starting-eleven-section h1,
        .starting-eleven-section {
    flex: 1 1 45%; /* Allow shrinking, set basis to ~45% */
    /* You could also use width: 45%; */
    max-width: 45%; /* Optional: enforce a max width */
    /* Keep existing styles like margin-top, padding, etc. */
    margin-top: 20px;
    padding: 15px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 1.3em;
    text-align: center;
}

       .starting-eleven-section h2 { /* Styling for headings in both sections */
           color: #333;
           margin-bottom: 15px;
           font-size: 1.5em;
           text-align: center;
       }

       .starting-eleven-container, .substitutes-container { /* Styling for player containers in both sections */
           display: flex;
           flex-direction: column;
           gap: 10px;
           max-height: 500px; /* Increased max-height for Titulares */
           overflow-y: auto;
       }

       .substitutes-section {
    flex: 1 1 45%; /* Allow shrinking, set basis to ~45% */
     /* You could also use width: 45%; */
    max-width: 45%; /* Optional: enforce a max width */
    /* Keep existing styles like margin-top, padding, etc. */
    margin-top: 20px;
    padding: 15px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}


.starting-eleven-container {
   max-height: 400px; /* Example adjustment - change as needed */
   /* Keep overflow-y: auto; */
}




       .substitutes-section h2 {
           color: #333;
           margin-bottom: 15px;
           font-size: 1.5em;
           text-align: center;
       }

       .substitutes-container {
           display: flex;
           flex-direction: column;
           gap: 10px;
           max-height: 400px; /* Adjust max-height as needed */
           overflow-y: auto;
       }

       @media (max-width: 767px) {
    .team-section {
        flex-direction: column;
        align-items: center;
        padding: 10px; /* Reduz o padding geral em mobile */
    }

    .pitch-side {
        width: 100%; /* Ocupa a largura toda */
        max-width: 400px; /* Limita o tamanho máximo do campo */
        margin-bottom: 20px;
    }

    .player-selection-side {
        display: flex;
        flex-direction: row; /* Força as secções a ficarem lado a lado */
        justify-content: space-between; /* Distribui o espaço */
        width: 100%;
        gap: 10px; /* Espaçamento menor entre as colunas */
    }

    .starting-eleven-section, .substitutes-section {
        flex: 1; /* Faz com que ambas as secções partilhem o espaço igualmente */
        max-width: none; /* Remove a limitação de 45% */
        padding: 10px;
        margin-top: 0; /* Remove a margem de cima */
    }

    .starting-eleven-section h2, .substitutes-section h2 {
        font-size: 1.1em; /* Reduz o tamanho do título para caber melhor */
        margin-bottom: 10px;
    }

    .player-card .player-name {
        font-size: 0.9em; /* Ajusta o nome do jogador */
    }

    .player-card img {
        width: 40px; /* Imagem do jogador um pouco menor */
        height: 40px;
    }
}

    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <h1>Relvado</h1>

        <div class="team-section">
            <div class="pitch-side">
                <div class="formation-options">
                    <label for="formation-select"></label>
                    <select id="formation-select">
                        <option value="4-4-2">4-4-2</option>
                        <option value="4-3-3">4-3-3</option>
                        <option value="4-5-1">4-5-1</option>
                        <option value="3-4-3">3-4-3</option>
                        <option value="5-3-2">5-3-2</option>
                    </select>
                    <label for="user-select" style="margin-left: 20px;">GPlayers:</label>
                    <select id="user-select">
                        <option value="">Selecione um GPlayer</option>
                    </select>
                </div>

                <div class="pitch-container">
                    <div class="pitch-area">
                        <div class="center-circle"></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-side">
                <div class="starting-eleven-section">
                    <h2>11 Titulares</h2>
                    <div class="starting-eleven-container">
                        <!-- Starting eleven players will be displayed here -->
                    </div>
                </div>

                <div class="substitutes-section">  <!-- NEW SUBSTITUTES SECTION -->
                    <h2>Suplentes</h2>
                    <div class="substitutes-container">
                        <!-- Substitutes players will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-menu">
         <!-- Menu items will have 'hidden' class added/removed dynamically -->
        <a href="1x.html" class="menu-item" data-menu-key="1x">
            <i class="fas fa-home"></i>
        </a>
        <a href="market.html" class="menu-item" data-menu-key="market"> <!-- Assuming market.html link relates to 'market' setting -->
            <i class="fas fa-shopping-cart"></i>
        </a>
        <a href="team.html" class="menu-item active" data-menu-key="team">
            <i class="fas fa-users"></i>
        </a>
        <a href="empire.html" class="menu-item" data-menu-key="empire">
            <i class="fas fa-landmark empire-icon"></i>
        </a>
        <a href="rankings.html" class="menu-item" data-menu-key="rankings">
            <i class="fas fa-list"></i>
        </a>
        <a href="profile.html" class="menu-item" data-menu-key="profile">
            <i class="fas fa-user"></i>
        </a>
        <!-- Note: No 'bank' link was found, mapping 'Transações = bank' is skipped unless HTML is updated -->
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, limit, where, doc, getDoc, setDoc, addDoc, FieldValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            // KEEP YOUR CONFIG HERE
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0", // Replace with your actual API key if needed
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.firebasestorage.app",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global Variables ---
        let allPlayers = [];
        let assignedPlayers = {};
        let currentUserStatus = null;
        let currentUserUid = null;
        let userPlayers = [];
        let currentFormation = '4-4-2'; // Default formation
        const formations = { /* ... formations object ... */
           '4-4-2': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                { position: 'ML', top: '40%', left: '12%', positionType: 'MID' },
                { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' },
                { position: 'MR', top: '40%', left: '82%', positionType: 'MID' },
                { position: 'FW1', top: '10%', left: '32%', positionType: 'FWD' },
                { position: 'FW2', top: '10%', left: '62%', positionType: 'FWD' }
            ],
            '4-3-3': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                { position: 'MC2', top: '60%', left: '47%', positionType: 'MID' },
                { position: 'MC3', top: '40%', left: '62%', positionType: 'MID' },
                { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' },
                { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' },
                { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' },
            ],
            '4-5-1': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                { position: 'DML', top: '50%', left: '47%', positionType: 'MID' },
                { position: 'MC1', top: '40%', left: '10%', positionType: 'MID' },
                { position: 'AMC', top: '40%', left: '30%', positionType: 'MID' },
                { position: 'MC2', top: '40%', left: '64%', positionType: 'MID' },
                { position: 'DMR', top: '40%', left: '84%', positionType: 'MID' },
                { position: 'FW', top: '10%', left: '47%', positionType: 'FWD' }
            ],
            '3-4-3': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'DC1', top: '75%', left: '20%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '47%', positionType: 'DEF' },
                { position: 'DC3', top: '75%', left: '77%', positionType: 'DEF' },
                { position: 'ML', top: '40%', left: '12%', positionType: 'MID' },
                { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' },
                { position: 'MR', top: '40%', left: '82%', positionType: 'MID' },
                { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' },
                { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' },
                { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' },
            ],
            '5-3-2': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'SW', top: '75%', left: '10%', positionType: 'DEF' },
                { position: 'WBL', top: '75%', left: '30%', positionType: 'DEF' },
                { position: 'DC1', top: '75%', left: '47%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '64%', positionType: 'DEF' },
                { position: 'WBR', top: '75%', left: '84%', positionType: 'DEF' },
                { position: 'MC1', top: '40%', left: '30%', positionType: 'MID' },
                { position: 'MC2', top: '55%', left: '47%', positionType: 'MID' },
                { position: 'MC3', top: '40%', left: '64%', positionType: 'MID' },
                { position: 'FW1', top: '10%', left: '30%', positionType: 'FWD' },
                { position: 'FW2', top: '10%', left: '64%', positionType: 'FWD' }
            ]
        };
        const loadingScreen = document.getElementById('loading-screen');
        const content = document.querySelector('.content');
        const formationSelect = document.getElementById('formation-select');
        const pitchArea = document.querySelector('.pitch-area');
        const userSelect = document.getElementById('user-select'); // Added for easier access
        const bottomMenu = document.querySelector('.bottom-menu'); // Added for easier access

        // --- Firebase Helper Functions ---

        // Fetches user status and acceptance
        async function getUserData(userId) {
            const userDocRef = doc(db, 'users', userId);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    return {
                        estatuto: data.estatuto,
                        aceite: data.aceite,
                        exists: true
                    };
                } else {
                    return { exists: false };
                }
            } catch (error) {
                console.error("Error getting user data:", error);
                return { exists: false, error: true };
            }
        }

        // Fetches panel menu settings
        async function getPanelMenuSettings() {
            const panelMenuDocRef = doc(db, 'paineis', 'paineis menu'); // Correct path
            try {
                const docSnap = await getDoc(panelMenuDocRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    return {}; // Return empty object if not found
                }
            } catch (error) {
                console.error("Error getting panel menu settings:", error);
                return {}; // Return empty object on error
            }
        }

        // --- UI Update Functions ---

        // Shows/hides bottom menu items based on settings
        function updateMenuVisibility(menuSettings) {
            const menuItems = bottomMenu.querySelectorAll('.menu-item');

            const settingToKeyMap = {
                '1x': '1x',
                'bank': 'bank', // Assuming there might be a 'bank' item later?
                'empire': 'empire',
                'market': 'market',
                'profile': 'profile',
                'rankings': 'rankings',
                'team': 'team'
            };

            menuItems.forEach(item => {
                const menuKey = item.dataset.menuKey; // Use data-menu-key attribute
                if (menuKey) {
                    const settingName = settingToKeyMap[menuKey];
                    const settingValue = menuSettings[settingName]; // Get the value from fetched settings

                    if (settingValue === 'off') {
                        item.classList.add('hidden'); // Use CSS class to hide
                    } else {
                        item.classList.remove('hidden'); // Ensure visible if 'on' or setting missing
                    }
                }
            });
        }


        // Renders the football pitch positions for a given formation
        function renderFormation(formationName) {
           /* ... (renderFormation function - unchanged) ... */
            const previousFormation = currentFormation;
            const previousAssignedPlayers = { ...assignedPlayers };

            pitchArea.querySelectorAll('.position img').forEach(img => img.remove());
            for (const pos in assignedPlayers) {
                assignedPlayers[pos] = null;
            }
            assignedPlayers = {};

            currentFormation = formationName;

            const currentFormationPositions = formations[formationName];
            pitchArea.innerHTML = '<div class="center-circle"></div>'; // Clear existing positions and add circle

            currentFormationPositions.forEach(pos => {
                const positionElement = document.createElement('div');
                positionElement.classList.add('position');
                positionElement.dataset.position = pos.position;
                positionElement.style.top = pos.top;
                positionElement.style.left = pos.left;
                positionElement.textContent = '+';
                positionElement.dataset.playerId = null; // Ensure reset
                positionElement.dataset.positionType = pos.positionType; // Store position type (GK, DEF, MID, FWD)

                // Drag and Drop Event Listeners
                positionElement.addEventListener('dragover', (event) => {
                    event.preventDefault(); // Necessary to allow drop
                });
                positionElement.addEventListener('drop', handlePositionDrop);
                pitchArea.appendChild(positionElement);
            });

            // Reposition players if switching formation
            if (previousFormation && Object.keys(previousAssignedPlayers).length > 0) {
                repositionPlayers(previousFormation, previousAssignedPlayers, formationName);
            }
            // Load team for the current user/formation after rendering positions
        }

         // Repositions players when formation changes
        function repositionPlayers(previousFormationName, previousAssignedPlayers, currentFormationName) {
           /* ... (repositionPlayers function - unchanged) ... */
            const currentFormationPositions = formations[currentFormationName];
            // Create a map of position types to available slots in the new formation
            const availablePositions = currentFormationPositions.reduce((acc, pos) => {
                acc[pos.positionType] = acc[pos.positionType] || [];
                acc[pos.positionType].push(pos.position);
                return acc;
            }, {});

            const startingElevenContainer = document.querySelector('.starting-eleven-container');
            startingElevenContainer.innerHTML = ''; // Clear starting eleven list before repositioning

            for (const positionId in previousAssignedPlayers) {
                const playerId = previousAssignedPlayers[positionId];
                if (!playerId) continue; // Skip empty previous positions

                const player = allPlayers.find(p => p.id === playerId);
                if (!player) {
                    continue;
                }

                const posicaoMapping = {
                    "Avançado": "FWD", "Atacante": "FWD", // Added Atacante
                    "Defesa": "DEF",
                    "Médio": "MID", "Meio-campista": "MID", // Added Meio-campista
                    "Guarda-Redes": "GK", "Goleiro": "GK" // Added Goleiro
                };
                const playerPosicaoIngles = posicaoMapping[player.posicao];

                if (!playerPosicaoIngles) {
                    continue;
                }

                // Find a suitable slot in the new formation based on player's position type
                if (availablePositions[playerPosicaoIngles] && availablePositions[playerPosicaoIngles].length > 0) {
                    const newPositionId = availablePositions[playerPosicaoIngles].shift(); // Take the first available slot
                    const positionElement = document.querySelector(`.position[data-position="${newPositionId}"]`);

                    if (positionElement) {
                        // Add player image to the new position
                        positionElement.innerHTML = ''; // Clear '+'
                        const playerImg = document.createElement('img');
                        playerImg.src = player.imagem || 'placeholder_image_url.png';
                        playerImg.alt = player.nome;
                        playerImg.draggable = false; // Make the image draggable from the pitch
                        positionElement.appendChild(playerImg);
                        positionElement.dataset.assignedPlayerId = playerId;
                        assignedPlayers[newPositionId] = playerId; // Update global state

                        // Add player to the starting eleven list
                        const playerCard = createStartingElevenPlayerCard(player);
                        startingElevenContainer.appendChild(playerCard);

                    }
                } else {
                    // If no slot, player implicitly becomes a substitute (handled by loadUserTeam logic later)
                }
            }
             // Update substitutes after repositioning starting players
            updateSubstitutesList();
        }

        // Creates a player card element (used for both starting 11 and substitutes)
        function createStartingElevenPlayerCard(player) {
           /* ... (createStartingElevenPlayerCard function - unchanged) ... */
            const card = document.createElement('div');
            card.classList.add('player-card'); // Basic class
            // Add specific class if needed later:
            // card.classList.add(isStarting ? 'starting-eleven-player' : 'substitute-player');
            card.dataset.playerId = player.id; // Store player ID
            card.draggable = true; // Make the card draggable

            // Drag Start Handler for Player Cards
            card.addEventListener('dragstart', (event) => {
                // Check if the player is already assigned to a pitch position
                 if (isPlayerAssigned(player.id)) {
                    event.preventDefault(); // Prevent dragging if already on pitch
                    alert(`${player.nome} já está no relvado. Remova-o primeiro se quiser movê-lo a partir daqui.`);
                    return;
                 }
                event.dataTransfer.setData('playerId', player.id);
                event.dataTransfer.setData('originalPositionId', 'list'); // Indicate drag from list
            });

            const img = document.createElement('img');
            img.src = player.imagem || 'placeholder_image_url.png'; // Use placeholder if no image
            img.alt = player.nome;
            // Prevent image dragging interfering with card dragging
            img.draggable = false;
            card.appendChild(img);

            const playerInfo = document.createElement('div');
            playerInfo.classList.add('player-info');

            const playerName = document.createElement('span');
            playerName.classList.add('player-name');
            playerName.textContent = player.nome;
            playerInfo.appendChild(playerName);

            // Add country flag if available
            if (player.nacionalidadebandeira) {
                const countryFlag = document.createElement('img');
                countryFlag.classList.add('country-flag');
                countryFlag.src = player.nacionalidadebandeira;
                countryFlag.alt = player.nacionalidade || ''; // Add alt text
                countryFlag.draggable = false; // Prevent flag dragging
                // Append flag directly after the name text node for inline display
                playerName.appendChild(countryFlag);
            }

            const playerPosition = document.createElement('span');
            playerPosition.classList.add('player-position');
            playerPosition.textContent = player.posicao; // Display Portuguese position name
            playerInfo.appendChild(playerPosition);

            card.appendChild(playerInfo);
            return card;
        }

        // Handles dropping a player onto a pitch position
        function handlePositionDrop(event) {
           /* ... (handlePositionDrop function - unchanged, ensure it calls updateSubstitutesList) ... */
            event.preventDefault();
            const playerId = event.dataTransfer.getData('playerId');
            const positionElement = event.currentTarget; // The position div being dropped onto
            const positionId = positionElement.dataset.position;
            const positionType = positionElement.dataset.positionType; // e.g., 'GK', 'DEF'
            const originalPositionId = event.dataTransfer.getData('originalPositionId'); // 'list' or another positionId

            const player = allPlayers.find(p => p.id === playerId);
            if (!player) {
                console.error("Dropped player not found in allPlayers:", playerId);
                return;
            }

            // --- 1. Check Position Compatibility ---
            const posicaoMapping = {
                "Avançado": "FWD", "Atacante": "FWD",
                "Defesa": "DEF",
                "Médio": "MID", "Meio-campista": "MID",
                "Guarda-Redes": "GK", "Goleiro": "GK"
            };
            const playerPosicaoIngles = posicaoMapping[player.posicao];

            if (playerPosicaoIngles !== positionType) {
                alert(`Este jogador é ${player.posicao} (${playerPosicaoIngles}) e não pode ser colocado numa posição ${positionType}.`);
                return; // Prevent drop if positions don't match
            }

             // --- 2. Handle Removing Player from Original Location ---
            const startingElevenContainer = document.querySelector('.starting-eleven-container');
            let playerWasSwapped = false; // Flag to track if a swap happened

             // If player came from another pitch position
            if (originalPositionId && originalPositionId !== 'list') {
                 const originalPositionElement = document.querySelector(`.position[data-position="${originalPositionId}"]`);
                 if (originalPositionElement && assignedPlayers[originalPositionId] === playerId) {
                    removePlayerFromPositionDOM(originalPositionElement); // Visually remove
                    delete assignedPlayers[originalPositionId]; // Update state
                 }
            }
             // No need to explicitly remove from substitutes list here, updateSubstitutesList() handles it later


            // --- 3. Handle the Target Position (Swap or Place) ---
            const existingPlayerId = positionElement.dataset.assignedPlayerId;

            if (existingPlayerId && existingPlayerId !== playerId) {
                // --- 3a. SWAP Logic ---
                const existingPlayer = allPlayers.find(p => p.id === existingPlayerId);

                 if (!existingPlayer) {
                    console.error("Existing player for swap not found:", existingPlayerId);
                    // Fallback: Replace instead of swap if existing player data is missing
                    placePlayerInPosition(positionElement, player, positionId);
                } else if (originalPositionId && originalPositionId !== 'list') {
                     // Move the *existing* player to the *original* position of the dropped player
                     const originalPositionElement = document.querySelector(`.position[data-position="${originalPositionId}"]`);
                     if (originalPositionElement) {
                         placePlayerInPosition(originalPositionElement, existingPlayer, originalPositionId);
                          playerWasSwapped = true; // Mark swap successful
                     } else {
                          // Remove existing player if original spot isn't available (shouldn't happen often)
                          removePlayerFromPositionDOM(positionElement); // Remove visually before placing new
                          delete assignedPlayers[positionId]; // Update state
                     }
                 } else {
                    // Player dragged from list onto occupied spot - existing player goes back to substitutes
                    removePlayerFromPositionDOM(positionElement); // Remove visually before placing new
                    delete assignedPlayers[positionId]; // Update state
                    // The existing player will reappear in substitutes list via updateSubstitutesList()
                 }

                 // Now, place the *dropped* player in the target position (if swap didn't fail)
                 if (playerWasSwapped || !(originalPositionId && originalPositionId !== 'list')) {
                    placePlayerInPosition(positionElement, player, positionId);
                 }

            } else if (existingPlayerId === playerId) {
                // Dropped onto the same spot - do nothing
                 return;
            } else {
                 // --- 3b. PLACE Logic (Target position is empty) ---
                placePlayerInPosition(positionElement, player, positionId);
            }

             // --- 4. Update UI Lists ---
             updateStartingElevenList(); // Update the "11 Titulares" list
             updateSubstitutesList();   // Update the "Suplentes" list
        }

         // Helper to visually and statefully place a player image onto a position element
        function placePlayerInPosition(positionElement, player, positionId) {
            positionElement.innerHTML = ''; // Clear '+' or previous image
            const playerImg = document.createElement('img');
            playerImg.src = player.imagem || 'placeholder_image_url.png';
            playerImg.alt = player.nome;
            playerImg.draggable = true; // Make the image draggable from the pitch
            positionElement.appendChild(playerImg);
            positionElement.dataset.assignedPlayerId = player.id; // Link player ID to element
            assignedPlayers[positionId] = player.id; // Update global state
        }

         // Helper to visually remove player image and reset data attribute
         function removePlayerFromPositionDOM(positionElement) {
            if (!positionElement) return;
            positionElement.innerHTML = '+'; // Restore the '+' sign
            positionElement.dataset.assignedPlayerId = null; // Clear the player ID link
            // Note: Does NOT modify the assignedPlayers state; that's done in the calling function (handlePositionDrop or repositionPlayers)
        }

        // Updates the "11 Titulares" list based on the current 'assignedPlayers' state
        function updateStartingElevenList() {
            const startingElevenContainer = document.querySelector('.starting-eleven-container');
            startingElevenContainer.innerHTML = ''; // Clear current list

            // Get player IDs currently assigned to pitch positions
            const assignedPlayerIds = Object.values(assignedPlayers).filter(id => id !== null);

            assignedPlayerIds.forEach(playerId => {
                const player = allPlayers.find(p => p.id === playerId);
                if (player) {
                    const playerCard = createStartingElevenPlayerCard(player);
                    playerCard.classList.add('starting-eleven-player'); // Add specific class if needed

                    // --- MODIFICATION START ---
                    // Make starting eleven cards in the LIST non-draggable
                    playerCard.draggable = false; // Ensure it's false
                    playerCard.style.cursor = 'default'; // Use default cursor (was 'not-allowed' before, default is clearer for non-interactive)
                    // --- MODIFICATION END ---

                    startingElevenContainer.appendChild(playerCard);
                }
            });
        }

        // Updates the "Suplentes" list
        function updateSubstitutesList() {
            const substitutesContainer = document.querySelector('.substitutes-container');
            substitutesContainer.innerHTML = ''; // Clear current list

            const assignedPlayerIds = Object.values(assignedPlayers).filter(id => id !== null);

            // Filter allPlayers to find those *not* in assignedPlayers
            const substitutePlayers = allPlayers.filter(player => !assignedPlayerIds.includes(player.id));

            substitutePlayers.forEach(player => {
                const playerCard = createStartingElevenPlayerCard(player); // Reuse card creation

                // --- MODIFICATION START ---
                // Make substitute cards NOT draggable
                playerCard.draggable = false; // Change from true to false
                playerCard.style.cursor = 'default'; // Change cursor from 'grab' to default
                // --- MODIFICATION END ---

                substitutesContainer.appendChild(playerCard);
            });
        }

        // Checks if a player ID is currently assigned to any pitch position
        function isPlayerAssigned(playerId) {
            const isAssigned = Object.values(assignedPlayers).includes(playerId);
            return isAssigned;
        }

        // Fetches the specific plantel data for a user/formation/season (if exists)
        async function fetchPlanteisData(userId, formation, season) {
            try {
                const planteisRef = collection(db, 'planteis');
                const planteisQuery = query(planteisRef,
                    where('userId', '==', userId),
                    where('formacao', '==', formation),
                    where('temporada', '==', season)
                    // Optional: Add where('estado', '==', 'ativo') if needed here too
                );
                const planteisSnapshot = await getDocs(planteisQuery);

                if (!planteisSnapshot.empty) {
                    // Return the first match (should ideally be unique per user/formation/season)
                    return planteisSnapshot.docs[0].data();
                } else {
                    return null; // Indicate no existing plantel found
                }
            } catch (error) {
                console.error('Error fetching planteis data:', error);
                return null; // Indicate error
            }
        }

         // Fetches all players owned by the selected user
         async function fetchAllUserPlayers(selectedUserId) {
            if (!selectedUserId) {
                allPlayers = []; // Clear players if no user selected
                 updateStartingElevenList();
                 updateSubstitutesList();
                return;
            }

            const jogadoresRef = collection(db, 'jogadores');
            // Query players where 'compradopor' field matches the selected user ID
            const q = query(jogadoresRef, where('compradopor', '==', selectedUserId));

            try {
                const playersSnap = await getDocs(q);
                const fetchedPlayers = [];
                playersSnap.forEach(doc => {
                    const playerData = doc.data();
                    // Ensure essential fields exist
                    if (playerData.nome && playerData.posicao) {
                        fetchedPlayers.push({
                            ...playerData,
                            id: doc.id // Add the document ID as 'id'
                        });
                    }
                });
                allPlayers = fetchedPlayers; // Update the global player list for this user

            } catch (error) {
                 console.error(`Error fetching players for user ${selectedUserId}:`, error);
                allPlayers = []; // Clear list on error
            }
        }

         // Fetches the currently logged-in user's player IDs (if needed, less used now)
        async function fetchUserPlayers(userId) {
            // This function seems less critical now that we fetch based on selected user
            // Keeping it in case it's used elsewhere or for future reference
            try {
                const userPlayersRef = collection(db, 'users', userId, 'jogadores'); // Path might differ based on actual structure
                const userPlayersSnap = await getDocs(userPlayersRef);
                const fetchedUserPlayers = [];
                userPlayersSnap.forEach(doc => {
                    fetchedUserPlayers.push({ ...doc.data(), id: doc.id });
                });
                userPlayers = fetchedUserPlayers; // This global variable might not be actively used
             } catch (error) {
                 console.error("Error fetching logged-in user's players:", error);
                 userPlayers = [];
             }
        }

        // Loads the saved team formation and player placements from Firestore
        async function loadUserTeam() {
            const selectedUserId = userSelect.value;
            const selectedFormation = formationSelect.value;

            if (!selectedUserId) {
                 // Clear pitch and lists if no user is selected
                 renderFormation(selectedFormation); // Re-render empty formation
                 updateStartingElevenList();
                 updateSubstitutesList();
                return;
            }

             // Fetch all players for the selected user first
            await fetchAllUserPlayers(selectedUserId);


            // Clear current pitch visuals and state before loading saved data
             pitchArea.querySelectorAll('.position img').forEach(img => img.remove());
             pitchArea.querySelectorAll('.position').forEach(pos => {
                 pos.textContent = '+';
                 pos.dataset.assignedPlayerId = null;
             });
             assignedPlayers = {}; // Reset assignments

            const startingElevenContainer = document.querySelector('.starting-eleven-container');
            startingElevenContainer.innerHTML = ''; // Clear lists too
            const substitutesContainer = document.querySelector('.substitutes-container');
            substitutesContainer.innerHTML = '';

            try {
                // 1. Get the latest season
            const configDocRef = doc(db, 'paineis', 'configuracoes_gerais');
const configDocSnap = await getDoc(configDocRef);
let latestSeason = '';

if (configDocSnap.exists() && configDocSnap.data().temporadaAtual) {
    latestSeason = configDocSnap.data().temporadaAtual;
} else {
    console.error('Documento de configuração "paineis/configuracoes_gerais" ou campo "temporadaAtual" não encontrado.');
    updateStartingElevenList();
    updateSubstitutesList();
    return; // Stop if no season context
}

                // 2. Fetch the specific plantel data for this user, formation, and season
                const plantelData = await fetchPlanteisData(selectedUserId, selectedFormation, latestSeason);

                if (plantelData) {
                    // 3. Populate the pitch based on fetched plantel data
                    const positions = pitchArea.querySelectorAll('.position');
                    positions.forEach(positionElement => {
                        const positionId = positionElement.dataset.position; // e.g., 'GK', 'DC1'
                        const playerId = plantelData[positionId]; // Get player ID from plantel data using positionId as key

                        if (playerId) {
                            const player = allPlayers.find(p => p.id === playerId);
                            if (player) {
                                placePlayerInPosition(positionElement, player, positionId); // Use helper to place image and update state
                            } else {
                                 positionElement.textContent = '?'; // Indicate missing player data
                                 positionElement.dataset.assignedPlayerId = null; // Ensure it's null
                            }
                        } else {
                             // Position exists in formation but no player assigned in saved data
                             positionElement.textContent = '+';
                             positionElement.dataset.assignedPlayerId = null;
                        }
                    });
                 } else {
                    // Ensure pitch is empty if no data found (already cleared, but good practice)
                    assignedPlayers = {};
                }

                 // 4. Update UI lists after loading/placing players
                 updateStartingElevenList(); // Reflects players placed on pitch
                 updateSubstitutesList();   // Shows remaining players

            } catch (error) {
                console.error('Error loading user team:', error);
                 // Reset on error
                 assignedPlayers = {};
                 updateStartingElevenList();
                 updateSubstitutesList();
            }
        }


        // Populates the user selection dropdown
        async function loadUsers() {
            try {
                const usersRef = collection(db, 'users');
                const querySnapshot = await getDocs(usersRef);
                const userSelect = document.getElementById('user-select');

                // Limpa opções existentes
                while (userSelect.options.length > 1) {
                    userSelect.remove(1);
                }

                const users = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.nomeDeUsuario) {
                        users.push({
                            id: doc.id,
                            username: userData.nomeDeUsuario
                        });
                    }
                });

                // Ordena por nome de utilizador
                users.sort((a, b) => a.username.localeCompare(b.username));

                // Adiciona utilizadores ao dropdown
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    userSelect.appendChild(option);
                });

                // Adiciona o listener para futuras mudanças
                userSelect.removeEventListener('change', handleUserSelectionChange);
                userSelect.addEventListener('change', handleUserSelectionChange);

                // --- ALTERAÇÃO PRINCIPAL ---
                // Se houver utilizadores na lista, seleciona o primeiro e carrega a sua equipa.
                // Isto garante que o carregamento inicial funcione em todos os dispositivos.
                if (userSelect.options.length > 1) {
                    userSelect.selectedIndex = 1; // Seleciona o primeiro utilizador (índice 0 é "Selecione...")
                    // Simula um evento de 'change' para acionar o carregamento da equipa
                    await handleUserSelectionChange({ target: userSelect });
                }

            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Handles the change event for the user select dropdown
         async function handleUserSelectionChange(event) {
            const selectedUserId = event.target.value;

            if (!selectedUserId) {
                 // Clear everything if "Selecione" is chosen
                 allPlayers = [];
                 assignedPlayers = {};
                 renderFormation(formationSelect.value); // Reset pitch
                 updateStartingElevenList();
                 updateSubstitutesList();
                 return;
             }

            // When user changes, fetch their players and load their default/saved team
             // The formation might reset or load based on saved data within loadUserTeam
            await loadUserTeam(); // This now handles fetching players and loading the team/formation
        }

        // --- Initialization and Event Listeners ---

        // Formation select change listener
        formationSelect.addEventListener('change', (event) => {
            const selectedFormation = event.target.value;
            // Render the new formation layout, which will then call loadUserTeam
            renderFormation(selectedFormation);
            // loadUserTeam() will be called inside renderFormation if repositioning happens,
            // or called explicitly if needed after rendering base formation
            loadUserTeam();
        });

        // Authentication state change listener (MAIN ENTRY POINT)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;

                // 1. Fetch User Data (Status and Acceptance) and Panel Settings concurrently
                const [userData, panelSettings] = await Promise.all([
                    getUserData(currentUserUid),
                    getPanelMenuSettings()
                ]);

                 // Check if user data fetch failed critically
                if (userData.error || !userData.exists) {
                    console.error("Failed to fetch user data or user doesn't exist.");
                    loadingScreen.style.display = 'none'; // Hide loading
                    window.location.href = '404.html'; // Redirect on critical error
                    return;
                }

                currentUserStatus = userData.estatuto;
                const isUserAccepted = userData.aceite === "Yes";
                const teamPanelSetting = panelSettings?.team; // Use optional chaining

                // 2. Apply Menu Visibility Rules FIRST
                updateMenuVisibility(panelSettings || {}); // Pass settings or empty obj

                // 3. Apply Access Control Rules for THIS page ('team')
                const canAccessTeamPage = teamPanelSetting === 'on' || (teamPanelSetting === 'off' && currentUserStatus === 'ruler');

                if (!isUserAccepted || !canAccessTeamPage) {
                    loadingScreen.style.display = 'none'; // Hide loading
                    // Decide where to redirect users denied access
                    // Maybe redirect non-rulers to home if team is off?
                    window.location.href = '404.html'; // Redirect if not accepted or not allowed by panel settings/status
                    return; // Stop further execution for this page
                }

                // 4. User is Authenticated, Accepted, and Allowed Access - Proceed with page load
                // Populate the user dropdown
                await loadUsers(); // This will also trigger initial team load via its event listener if needed

                 // Initial rendering of the default/selected formation
                 renderFormation(formationSelect.value); // Render initial structure

                // Hide loading screen and show content
                loadingScreen.style.display = 'none';
                content.style.display = 'block';

            } else {
                // No user logged in
                loadingScreen.style.display = 'none'; // Hide loading
                // Redirect to login page
                window.location.href = 'index.html';
            }
        });

        // Initial setup on DOMContentLoaded (less critical now as onAuthStateChanged is the main driver)
        document.addEventListener('DOMContentLoaded', async () => {
            // Auth state listener will handle main setup.
        });

    </script>
</body>
</html>
