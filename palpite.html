<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpite - Ggames</title>
        <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEIbiLnCB/s320/soccer-ball-png.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
          <style>
              /* ESTILOS GERAIS (maioria mantida) */
         * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; }
        .content { padding: 10px; margin-bottom: 120px; }
        .game-info { background: white; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); text-align: center; position: relative; }
        .game-info::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 2px dashed transparent; border-radius: 12px; background-image: linear-gradient(90deg, #2176ff, #21d4fd, #b721ff, #ffdd00, #2176ff); background-size: 400% 100%; animation: snake-border 8s linear infinite; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; z-index: -1; }
        @keyframes snake-border { 0% { background-position: 0% 0%; } 100% { background-position: 400% 0%; } }
        .game-header { margin-bottom: 15px; }
        .competition-and-date { display: flex; align-items: center; justify-content: center; gap: 5px; color: #444; font-size: 1.0em; font-weight: 500; flex-wrap: wrap; }
        .competition-and-date .separator { margin: 0 5px; color: #ccc; }
        .competition-image { height: 20px; display: inline-flex; align-items: center; }
        .competition-image img { max-height: 100%; width: auto; vertical-align: middle; }
        .teams-container { display: flex; align-items: center; justify-content: space-around; margin-bottom: 10px; }
        .team { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .team-image { width: 80px; height: 80px; margin-bottom: 10px; }
        .team-image img { width: 100%; height: 100%; object-fit: contain; }
        .team-name { font-weight: bold; text-align: center; }
        .vs { font-size: 24px; font-weight: bold; margin: 0 20px; }
        .countdown-timer { margin: 15px auto; padding: 8px 12px; background-color: #f9f9f9; border-radius: 8px; color: #555; font-weight: 500; font-size: 0.9em; box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05); border: 1px solid #eee; width: fit-content; }
        .countdown-label { color: #777; font-size: 0.9em; margin-right: 8px; }
        .timer-unit { display: inline-block; padding: 4px 8px; margin: 0 3px; background-color: #e9ecef; border-radius: 4px; font-weight: bold; color: #333; min-width: 30px; text-align: center; }
        .existing-prediction-message { margin-top: 15px; padding: 10px; background-color: #e9f5ff; border: 1px solid #b3d7ff; border-radius: 8px; color: #004085; font-weight: bold; }
        #odds-list-container { margin-top: 20px; }
        .odds-category { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .category-header, .subcategory-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer; font-weight: bold; color: #333; transition: background-color 0.2s ease; }
        .category-header { background-color: #f9f9f9; font-size: 0.9em; }
        .category-header:hover { background-color: #f0f0f0; }
        .subcategory-header { background-color: #fff; padding-left: 30px; font-weight: 500; font-size: 0.85em; }
        .subcategory-header:hover { background-color: #f5f5f5; }
        .category-header-title { display: flex; align-items: center; gap: 10px; }
        .toggle-icon { transition: transform 0.3s ease; }
        .active > .toggle-icon { transform: rotate(180deg); }
        .nested-list { padding: 0; margin: 0; list-style: none; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; background-color: #fff; }
        .nested-list > li:not(:first-child) { border-top: 1px solid #f0f0f0; }
        .category-header.active + .nested-list, .subcategory-header.active + .nested-list { max-height: 50000px; }
        .odds-items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; padding: 15px 15px 15px 40px; list-style: none; }
        .odds-item { position: relative; display: flex; justify-content: center; align-items: center; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 0.85em; padding: 10px; }
        .odds-item-text { margin-top: 10px; }
        .odds-item:hover { border-color: #2176ff; background-color: #f0f7ff; }
        .odds-item.selected { background-color: #2176ff; color: white; border-color: #0056d6; font-weight: bold; }
        .odds-item.disabled { background-color: #e9ecef; color: #adb5bd; cursor: not-allowed; border-color: #dee2e6; }
        .submit-button { margin-top: 20px; padding: 15px; background: #2176ff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: background-color 0.3s ease; }
        .submit-button:hover { background: #0056d6; }
        .submit-button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); z-index: 1002; min-width: 300px; }
        .popup-content { position: relative; padding-right: 20px; }
        .close-popup { position: absolute; top: 0; right: 0; cursor: pointer; font-size: 20px; color: #666; }
        .popup-message { margin-top: 10px; text-align: center; }
        .bottom-menu { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); padding: 12px 0; display: flex; justify-content: center; gap: 32px; align-items: center; z-index: 1000; }
        .menu-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; }
        .menu-item i { font-size: 24px; margin-bottom: 4px; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; display: flex; justify-content: center; align-items: center; z-index: 1001; }
        .loading-spinner { border: 16px solid #f3f3f3; border-top: 16px solid #3498db; border-radius: 50%; width: 120px; height: 120px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .subcategory-filter-container { padding: 10px 15px 10px 30px; background-color: #f5f5f5; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .subcategory-filter-container strong { font-size: 0.85em; color: #555; font-weight: 500; }
        .filter-btn { background-color: #fff; border: 1px solid #ccc; color: #333; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.8em; font-weight: 500; transition: all 0.2s ease; }
        .filter-btn:hover { background-color: #e9e9e9; border-color: #999; }
        .filter-btn.active { background-color: #2176ff; color: white; border-color: #0056d6; font-weight: bold; }
        .nested-list:hover { overflow: visible; }
        .info-container { position: absolute; top: 2px; right: 5px; z-index: 100; }
        .info-icon { font-size: 14px; color: #007bff; cursor: pointer; padding: 5px; }
        .info-tooltip { visibility: hidden; opacity: 0; width: 220px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1010; bottom: 120%; left: 50%; margin-left: -110px; transition: opacity 0.3s, visibility 0.3s; font-size: 0.8em; font-weight: normal; white-space: normal; pointer-events: none; }
        .info-container:hover .info-tooltip, .info-tooltip.active { visibility: visible; opacity: 1; pointer-events: auto; }
        .info-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -110px; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .info-tooltip.tooltip-adjust-left { left: auto; right: 0; margin-left: 0; }
        .info-tooltip.tooltip-adjust-left::after { left: auto; right: 10px; margin-left: 0; }
        .info-tooltip.tooltip-adjust-right { left: 0; margin-left: 0; }
        .info-tooltip.tooltip-adjust-right::after { left: 10px; margin-left: 0; }
        .confirmation-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .confirmation-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .confirmation-list-item:last-child { border-bottom: none; }
        .confirmation-list-item span { flex-grow: 1; margin-right: 15px; }
        .remove-prediction-btn { background-color: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; font-weight: bold; line-height: 24px; text-align: center; cursor: pointer; padding: 0; flex-shrink: 0; transition: background-color 0.2s ease; }
        .remove-prediction-btn:hover { background-color: #c82333; }
        #category-shortcuts-container { margin: 0 0 20px 0; padding: 0 10px; }
        .shortcuts-wrapper { display: flex; justify-content: center; gap: 10px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .shortcuts-wrapper::-webkit-scrollbar { display: none; }
        .category-shortcut { display: flex; align-items: center; justify-content: center; background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; width: 50px; height: 50px; flex-shrink: 0; cursor: pointer; transition: all 0.2s ease; }
        .category-shortcut:hover { border-color: #2176ff; background-color: #f0f7ff; transform: translateY(-2px); }
        .shortcut-icon { font-size: 24px; }
        .menu-item.hidden { display: none; }
        .prediction-display-container {
    margin-top: 20px;
    padding: 20px;
    background-color: #ffffff;
    border: 1px solid #e7e7e7;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.prediction-display-container h3 {
    text-align: center;
    color: #333;
    margin-bottom: 15px;
    font-size: 1.2em;
    border-bottom: 2px solid #2176ff;
    padding-bottom: 10px;
}

.prediction-card {
    background: #f9f9f9;
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 5px solid #2176ff;
}

.prediction-card p {
    margin: 0;
    font-size: 1em;
    color: #555;
}

.prediction-card strong {
    color: #333;
}
   </style>
</head>
<body>
    <div id="loading-screen"><div class="loading-spinner"></div></div>
    <div id="error-popup" class="popup"><div class="popup-content"><span class="close-popup">×</span><div class="popup-message"></div></div></div>
    <div id="confirmation-popup" class="popup"><div class="popup-content"><span class="close-popup">×</span><h3 style="margin-bottom: 15px;">Confirmar Palpites</h3><div id="confirmation-predictions" style="margin-bottom: 20px;"></div><div style="display: flex; gap: 10px; justify-content: center;">
       <button onclick="confirmPredictions(this)" style="background: #2176ff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Confirmar</button>
    </div></div></div>
  <div class="content">
    <h1></h1>
    <div id="game-container"></div>

    <!-- Contêiner para exibir os palpites já feitos -->
    <div id="prediction-display-area"></div>

    <!-- Contêineres para a seleção de odds (serão escondidos após o palpite) -->
    <div id="category-shortcuts-container"></div>
    <div id="odds-list-container"></div>
    <div id="submit-button-container"></div>
</div>

<nav class="bottom-menu">
    <a href="1x.html" class="menu-item active" data-key="1x"><i class="fas fa-home"></i></a>
    <a href="market.html" class="menu-item" data-key="market"><i class="fas fa-shopping-cart"></i></a>
    <a href="team.html" class="menu-item" data-key="team"><i class="fas fa-users"></i></a>
    <a href="empire.html" class="menu-item" data-key="empire"><i class="fas fa-landmark"></i></a>
    <a href="rankings.html" class="menu-item" data-key="rankings"><i class="fas fa-list"></i></a>
    <a href="profile.html" class="menu-item" data-key="profile"><i class="fas fa-user"></i></a>
</nav>
    <script src="config.js"></script>
 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, serverTimestamp, getDocs, query, where, orderBy, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    const loadingScreen = document.getElementById('loading-screen');
    const content = document.querySelector('.content');
    let currentGame = null;
    let selectedPredictions = [];
    let maxPredictions = 0;
    let countdownInterval = null;

    // NOVO: Flag de controlo para impedir submissões múltiplas
    let isSubmitting = false;

    // --- FUNÇÕES DE RENDERIZAÇÃO DINÂMICA ---
    function renderPredictionCards(predictions) {
        document.getElementById('category-shortcuts-container').style.display = 'none';
        document.getElementById('odds-list-container').style.display = 'none';
        document.getElementById('submit-button-container').style.display = 'none';

        const displayArea = document.getElementById('prediction-display-area');
        let cardsHtml = `<div class="prediction-display-container"><h3>Os teus Palpites Registrados</h3>`;
        
        Object.keys(predictions)
            .filter(key => key.startsWith('palpite') && !key.includes('Pontos') && !key.includes('Indice'))
            .sort()
            .forEach(key => {
                const predictionNumber = key.replace('palpite', '');
                const predictionValue = predictions[key];
                cardsHtml += `<div class="prediction-card"><p><strong>Palpite ${predictionNumber}:</strong> ${replaceTeamPlaceholders(predictionValue)}</p></div>`;
            });
        
        cardsHtml += `</div>`;
        displayArea.innerHTML = cardsHtml;
        displayArea.style.display = 'block';
    }
    
    async function showOddsSelector() {
        const displayArea = document.getElementById('prediction-display-area');
        displayArea.innerHTML = '';
        displayArea.style.display = 'none';

        document.getElementById('category-shortcuts-container').style.display = 'block';
        document.getElementById('odds-list-container').style.display = 'block';
        document.getElementById('submit-button-container').style.display = 'block';

        const hierarchy = await buildFullOddHierarchy();
        renderOddsList(hierarchy);
        document.getElementById('submit-button-container').innerHTML = `<button id="submit-button" class="submit-button" onclick="submitPredictions()" disabled>Enviar Palpites (0/${maxPredictions})</button>`;
    }

    // --- FUNÇÃO CONFIRMPREDICTIONS MODIFICADA ---
    // MODIFICADO: A função agora aceita o elemento do botão como argumento
    window.confirmPredictions = async function(buttonElement) {
        // NOVO: Se uma submissão já estiver em andamento, interrompe a função
        if (isSubmitting) {
            return;
        }

        // NOVO: Ativa a flag e desativa o botão para dar feedback visual e impedir cliques
        isSubmitting = true;
        buttonElement.disabled = true;
        buttonElement.textContent = 'A processar...';

        try {
            if (!currentGame || !auth.currentUser) throw new Error('Dados do jogo ou utilizador não disponíveis.');
            if (new Date() > currentGame.fimIntervalo.toDate()) { showErrorPopup('Tempo esgotado, impossível palpitar.'); closeConfirmationPopup(); return; }
            
            const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
            if (!userDoc.exists()) throw new Error('User data not found');
            const userData = userDoc.data();
            
            const palpiteData = {
                userId: auth.currentUser.uid, 
                nomeDeUsuario: userData.nomeDeUsuario || 'Utilizador Anónimo', 
                jogoId: currentGame.id, nomeJogo: currentGame.nomeJogo || 'Jogo Sem Nome', equipaCasaId: currentGame.equipaCasaId, equipaCasa: currentGame.equipaCasa, equipaForaId: currentGame.equipaForaId, equipaFora: currentGame.equipaFora, dataJogo: currentGame.dataJogo, 
                competicaoId: currentGame.competicaoId || null, 
                competicao: currentGame.competicao || 'Competição Desconhecida', 
                ronda: currentGame.ronda || null, 
                temporada: currentGame.temporada || null,
                dataPalpite: serverTimestamp(), 
                Analisado: "Não", PontosGanhos: 0 
            };

            selectedPredictions.forEach((pData, index) => {
                const predictionNumber = index + 1;
                palpiteData[`palpite${predictionNumber}`] = replaceTeamPlaceholders(pData.value);
                palpiteData[`Palpite${predictionNumber}PontosGanhos`] = 0;
                palpiteData[`Palpite${predictionNumber}IndiceIngles`] = { PalpiteCategoria: pData.catIndice, PalpiteSubCategoria: pData.subcatIndice, PalpiteCategoria3: pData.cat3Indice };
            });

            const batch = writeBatch(db);
            const globalPalpiteRef = doc(collection(db, 'palpites'));
            const userPalpiteRef = doc(collection(db, 'users', auth.currentUser.uid, 'palpites'));
            batch.set(globalPalpiteRef, palpiteData);
            batch.set(userPalpiteRef, palpiteData);
            await batch.commit();

            closeConfirmationPopup();
            renderPredictionCards(palpiteData);
        } catch (error) {
            console.error('Error submitting predictions:', error);
            showErrorPopup(`Erro ao enviar palpites: ${error.message}`);
            closeConfirmationPopup();
            // NOVO: Se ocorrer um erro, reativa o botão para permitir uma nova tentativa
            buttonElement.disabled = false;
            buttonElement.textContent = 'Confirmar';
        } finally {
            // NOVO: Independentemente do sucesso ou falha, liberta a flag no final
            isSubmitting = false;
        }
    };

    // --- FUNÇÃO LOADGAMEDETAILS MODIFICADA ---
    async function loadGameDetails() {
        try {
            loadingScreen.style.display = 'flex';
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');
            if (!gameId) { showErrorPopup('Nenhum jogo selecionado. Redirecionando...'); setTimeout(() => { window.location.href = '1x.html'; }, 3000); return; }
            
            currentGame = await loadGameData(gameId);
            maxPredictions = currentGame.numeroPalpites || 1;
            
            const competicaoDoc = await getDoc(doc(db, 'competicoes', currentGame.competicaoId || ' '));
            const equipaCasaDoc = await getDoc(doc(db, 'clubes', currentGame.equipaCasaId || ' '));
            const equipaForaDoc = await getDoc(doc(db, 'clubes', currentGame.equipaForaId || ' '));
            const competicaoImg = competicaoDoc.exists() ? competicaoDoc.data().imagem : '';
            const equipaCasaImg = equipaCasaDoc.exists() ? equipaCasaDoc.data().imagem : 'https://via.placeholder.com/80';
            const equipaForaImg = equipaForaDoc.exists() ? equipaForaDoc.data().imagem : 'https://via.placeholder.com/80';
            const gameDate = currentGame.dataJogo.toDate();
            const formattedDate = gameDate.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const formattedTime = gameDate.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });

            document.getElementById('game-container').innerHTML = `
                <div class="game-info">
                    <div class="game-header"><div class="competition-and-date"><div class="competition-image"><img src="${competicaoImg}" alt="${currentGame.competicao}"></div><span>${currentGame.competicao}</span><span class="separator">|</span><span>${formattedDate} - ${formattedTime}</span><span class="separator">|</span><strong style="color: #2176ff;">Palpites Possíveis: ${maxPredictions}</strong></div></div>
                    <div id="timer-or-message-container"></div> 
                    <div class="teams-container"><div class="team"><div class="team-image"><img src="${equipaCasaImg}" alt="${currentGame.equipaCasa}"></div><div class="team-name">${currentGame.equipaCasa}</div></div><div class="vs">VS</div><div class="team"><div class="team-image"><img src="${equipaForaImg}" alt="${currentGame.equipaFora}"></div><div class="team-name">${currentGame.equipaFora}</div></div></div>
                </div>`;

            const timerContainer = document.getElementById('timer-or-message-container');
            const existingPredictions = await checkExistingPredictions(currentGame.id);

            if (existingPredictions) {
                timerContainer.innerHTML = `<div class="existing-prediction-message"><strong>Já efetuou o seu palpite para este jogo.</strong></div>`;
                renderPredictionCards(existingPredictions);
            } else {
                const now = new Date();
                const inicio = currentGame.inicioIntervalo ? currentGame.inicioIntervalo.toDate() : null;
                const fim = currentGame.fimIntervalo ? currentGame.fimIntervalo.toDate() : null;

                if (inicio && now < inicio) {
                    // ANTES do intervalo de palpites
                    timerContainer.innerHTML = `<div class="existing-prediction-message" style="background-color: #fff3cd; border-color: #ffeeba; color: #856404;"><strong>O jogo ainda não está disponível para palpitar.</strong></div>`;
                    document.getElementById('odds-list-container').innerHTML = '';
                    document.getElementById('submit-button-container').innerHTML = '';
                    document.getElementById('category-shortcuts-container').innerHTML = '';
                } else if (fim && now > fim) {
                    // DEPOIS do intervalo de palpites
                    timerContainer.innerHTML = `<div class="countdown-timer"><span id="countdown"><span style="color: red; font-weight: bold;">Tempo esgotado!</span></span></div>`;
                    document.getElementById('odds-list-container').innerHTML = '<p style="text-align:center; padding: 20px;">O tempo para palpitar neste jogo esgotou.</p>';
                    document.getElementById('submit-button-container').innerHTML = '';
                    document.getElementById('category-shortcuts-container').innerHTML = '';
                } else {
                    // DENTRO do intervalo de palpites
                    timerContainer.innerHTML = `<div class="countdown-timer"><span class="countdown-label">Tempo para palpitar:</span><span id="countdown">Calculando...</span></div>`;
                    await showOddsSelector();
                    
                    if (currentGame.fimIntervalo) {
                        const countdownElement = document.getElementById('countdown');
                        clearInterval(countdownInterval);
                        const updateCountdown = () => {
                            const timeLeft = currentGame.fimIntervalo.toDate().getTime() - new Date().getTime();
                            if (timeLeft <= 0) {
                                countdownElement.innerHTML = '<span style="color: red; font-weight: bold;">Tempo esgotado!</span>';
                                clearInterval(countdownInterval);
                                document.getElementById('odds-list-container').innerHTML = '<p style="text-align:center; padding: 20px;">O tempo para palpitar neste jogo esgotou.</p>';
                                document.getElementById('submit-button-container').innerHTML = '';
                                document.getElementById('category-shortcuts-container').innerHTML = '';
                                return;
                            }
                            const d = Math.floor(timeLeft / 86400000), h = Math.floor(timeLeft % 86400000 / 3600000), m = Math.floor(timeLeft % 3600000 / 60000), s = Math.floor(timeLeft % 60000 / 1000);
                            countdownElement.innerHTML = `${d > 0 ? `<span class="timer-unit">${d}d</span>` : ''}<span class="timer-unit">${h}h</span><span class="timer-unit">${m}m</span><span class="timer-unit">${s}s</span>`;
                        };
                        updateCountdown();
                        countdownInterval = setInterval(updateCountdown, 1000);
                    }
                }
            }
            
            loadingScreen.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error in loadGameDetails:', error);
            showErrorPopup(`Erro fatal ao carregar detalhes do jogo: ${error.message}`);
            loadingScreen.style.display = 'none';
            content.style.display = 'block';
        }
    }
    
    // --- FUNÇÃO GETUSERSTATUS CORRIGIDA ---
    async function getUserStatus(userId) {
        try {
            const docSnap = await getDoc(doc(db, 'users', userId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                // CORRIGIDO: de "estatuito" para "estatuto"
                return data.aceite === "Yes" ? data.estatuto || null : null;
            }
            return null;
        } catch (error) {
            console.error("Erro ao buscar status do usuário:", error);
            return null;
        }
    }

    // ----- O RESTANTE DO SEU CÓDIGO (sem alterações) -----
    function showErrorPopup(message) { /* ... */ const popup = document.getElementById('error-popup'); popup.querySelector('.popup-message').textContent = message; popup.style.display = 'block'; }
    window.closeConfirmationPopup = function() { document.getElementById('confirmation-popup').style.display = 'none'; }
    document.querySelector('#error-popup .close-popup').addEventListener('click', () => document.getElementById('error-popup').style.display = 'none');
    document.querySelector('#confirmation-popup .close-popup').addEventListener('click', closeConfirmationPopup);
    function replaceTeamPlaceholders(text) { if (!text || !currentGame) return text; return text.replace(/Equipa da Casa|Equipa A/gi, currentGame.equipaCasa).replace(/Equipa Visitante|Equipa de Fora|Equipa B/gi, currentGame.equipaFora); }
    async function buildFullOddHierarchy() { const allOddsData = []; const q = query(collection(db, 'oddcategorias'), orderBy('ordem')); const querySnapshot = await getDocs(q); querySnapshot.forEach(doc => { allOddsData.push({ id: doc.id, ...doc.data() }); }); const categories = new Map(); const subcategories = new Map(); const thirdLevelItems = []; allOddsData.forEach(item => { if (item.categoria_subcategoria_3cat === 'categoria') { categories.set(item.id, { ...item, children: [] }); } else if (item.categoria_subcategoria_3cat === 'subcategoria') { subcategories.set(item.id, { ...item, children: [] }); } else if (item.categoria_subcategoria_3cat === '3cat') { thirdLevelItems.push(item); } }); thirdLevelItems.forEach(item => { if (item.subcategoriapai && subcategories.has(item.subcategoriapai)) { subcategories.get(item.subcategoriapai).children.push(item); } }); for (const [id, subcategory] of subcategories) { if (subcategory.categoriapai && categories.has(subcategory.categoriapai)) { categories.get(subcategory.categoriapai).children.push(subcategory); } } return Array.from(categories.values()); }
    function renderOddsList(hierarchy) { const container = document.getElementById('odds-list-container'); container.innerHTML = ''; const shortcutsContainer = document.getElementById('category-shortcuts-container'); let shortcutsHtml = ''; hierarchy.forEach(category => { if (category.children.length === 0) return; shortcutsHtml += `<div class="category-shortcut" onclick="scrollToCategory('${category.id}')" title="${replaceTeamPlaceholders(category.nomecategoria)}"><span class="shortcut-icon">${category.icon || '⭐'}</span></div>`; const categoryElement = document.createElement('div'); categoryElement.className = 'odds-category'; categoryElement.id = category.id; let filterBarHtml = ''; if (category.nomecategoria === 'Por Parte') filterBarHtml = `<div class="subcategory-filter-container"><strong>Filtro:</strong><button class="filter-btn active" onclick="applyFilter(this, '${category.id}', 'all')">Todas</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', '1st Half')">Primeira Parte</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', '2nd Half')">Segunda Parte</button></div>`; else if (category.nomecategoria === 'Mercados Combinados') filterBarHtml = `<div class="subcategory-filter-container"><strong>Filtro:</strong><button class="filter-btn active" onclick="applyFilter(this, '${category.id}', 'all')">Todos</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'home')">${currentGame.equipaCasa}</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'away')">${currentGame.equipaFora}</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'both')">Ambas</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'others')">Outras Odds</button></div>`; else if (category.nomecategoria === 'Mercados Especiais') filterBarHtml = `<div class="subcategory-filter-container"><strong>Filtro:</strong><button class="filter-btn active" onclick="applyFilter(this, '${category.id}', 'all')">Todos</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'home_special')">${currentGame.equipaCasa}</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'away_special')">${currentGame.equipaFora}</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'others_special')">Outras Odds</button></div>`; else if (category.nomecategoria === 'Específicos por Equipa') filterBarHtml = `<div class="subcategory-filter-container"><strong>Filtro:</strong><button class="filter-btn active" onclick="applyFilter(this, '${category.id}', 'all')">Todos</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'home_team_specific')">${currentGame.equipaCasa}</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'away_team_specific')">${currentGame.equipaFora}</button><button class="filter-btn" onclick="applyFilter(this, '${category.id}', 'others_team_specific')">Outras Odds</button></div>`; let subcategoriesHTML = ''; category.children.forEach(subcategory => { if (subcategory.children.length === 0) return; let itemsHTML = ''; subcategory.children.forEach(item => { const predictionData = { value: `${category.nomecategoria} - ${subcategory.nomesubcategoria} - ${item.nome3categoria}`, catIndice: category.indiceIngles || null, subcatIndice: subcategory.indiceIngles || null, cat3Indice: item.indiceIngles || null }; let infoIconHTML = item.breveDescricao && item.breveDescricao.trim() !== '' ? `<div class="info-container"><i class="fas fa-info-circle info-icon"></i><div class="info-tooltip">${replaceTeamPlaceholders(item.breveDescricao)}</div></div>` : ''; itemsHTML += `<li class="odds-item" data-prediction='${JSON.stringify(predictionData)}'>${infoIconHTML}<span class="odds-item-text">${replaceTeamPlaceholders(item.nome3categoria)}</span></li>`; }); const subcatIndiceIngles = subcategory.indiceIngles || ''; subcategoriesHTML += `<li class="filterable-subcategory" data-indice-ingles="${subcatIndiceIngles}"><div class="subcategory-header"><span>${replaceTeamPlaceholders(subcategory.nomesubcategoria)}</span><i class="fas fa-chevron-down toggle-icon"></i></div><ul class="nested-list"><ul class="odds-items-grid">${itemsHTML}</ul></ul></li>`; }); if (subcategoriesHTML === '') return; categoryElement.innerHTML = `<div class="category-header"><span class="category-header-title"><span>${category.icon || '⭐'}</span><span>${replaceTeamPlaceholders(category.nomecategoria)}</span></span><i class="fas fa-chevron-down toggle-icon"></i></div><ul class="nested-list">${filterBarHtml}${subcategoriesHTML}</ul>`; container.appendChild(categoryElement); }); if (shortcutsHtml) shortcutsContainer.innerHTML = `<div class="shortcuts-wrapper">${shortcutsHtml}</div>`; addEventListenersToList(); }
    window.scrollToCategory = function(targetId) { const targetElement = document.getElementById(targetId); if (!targetElement) return; targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' }); const header = targetElement.querySelector('.category-header'); if (header && !header.classList.contains('active')) setTimeout(() => header.click(), 300); };
    window.applyFilter = function(clickedButton, categoryId, filterKeyword) { clickedButton.parentElement.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); clickedButton.classList.add('active'); const subcategories = clickedButton.closest('.odds-category').querySelectorAll('.filterable-subcategory'); subcategories.forEach(subcatLi => { const indiceIngles = (subcatLi.dataset.indiceIngles || '').toLowerCase(); let show = false; if (filterKeyword === 'all') show = true; else { let keywords = [], exclusionKeywords = []; switch(filterKeyword) { case '1st Half': keywords = ['1st half']; break; case '2nd Half': keywords = ['2nd half']; break; case 'home': keywords = ['h1', 'team 1', 'win1', 'win 1']; break; case 'away': keywords = ['h2', 'team 2', 'win2', 'win 2']; break; case 'both': keywords = ['both teams']; break; case 'home_special': keywords = ['h1', 'team 1', 'win1', 'win 1', '2:0']; break; case 'away_special': keywords = ['h2', 'team 2', 'win2', 'win 2', '0:2']; break; case 'home_team_specific': keywords = ['h1', 'team 1', 'win1', 'win 1']; break; case 'away_team_specific': keywords = ['h2', 'team 2', 'win2', 'win 2']; break; case 'others': exclusionKeywords = ['h1', 'team 1', 'win1', 'win 1', 'h2', 'team 2', 'win2', 'win 2', 'both teams']; break; case 'others_special': exclusionKeywords = ['h1', 'team 1', 'win1', 'win 1', '2:0', 'h2', 'team 2', 'win2', 'win 2', '0:2']; break; case 'others_team_specific': exclusionKeywords = ['h1', 'team 1', 'win1', 'win 1', 'h2', 'team 2', 'win2', 'win 2']; break; } if (keywords.length > 0 && keywords.some(k => indiceIngles.includes(k))) show = true; if (exclusionKeywords.length > 0 && !exclusionKeywords.some(k => indiceIngles.includes(k))) show = true; } subcatLi.style.display = show ? 'block' : 'none'; }); }
    function addEventListenersToList() { document.querySelectorAll('.category-header, .subcategory-header').forEach(header => header.addEventListener('click', e => { if (!e.target.closest('.subcategory-filter-container')) e.currentTarget.classList.toggle('active'); })); document.querySelectorAll('.odds-item').forEach(item => item.addEventListener('click', () => handlePredictionClick(item))); document.querySelectorAll('.info-container').forEach(container => container.addEventListener('click', e => { e.stopPropagation(); const tooltip = container.querySelector('.info-tooltip'); const isAlreadyActive = tooltip.classList.contains('active'); document.querySelectorAll('.info-tooltip.active').forEach(t => t.classList.remove('active')); if (!isAlreadyActive) { tooltip.classList.add('active'); tooltip.classList.remove('tooltip-adjust-left', 'tooltip-adjust-right'); const tooltipRect = tooltip.getBoundingClientRect(); if (tooltipRect.right > window.innerWidth) tooltip.classList.add('tooltip-adjust-left'); if (tooltipRect.left < 0) tooltip.classList.add('tooltip-adjust-right'); } })); document.addEventListener('click', e => { if (!e.target.closest('.info-container')) document.querySelectorAll('.info-tooltip.active').forEach(t => t.classList.remove('active', 'tooltip-adjust-left', 'tooltip-adjust-right')); }); }
    function handlePredictionClick(itemElement) { const predictionDataStr = itemElement.dataset.prediction; const isSelected = itemElement.classList.contains('selected'); if (isSelected) { itemElement.classList.remove('selected'); selectedPredictions = selectedPredictions.filter(p => p.value !== JSON.parse(predictionDataStr).value); } else { if (selectedPredictions.length >= maxPredictions) { showErrorPopup(`Número máximo de palpites (${maxPredictions}) já foi atingido.`); return; } itemElement.classList.add('selected'); selectedPredictions.push(JSON.parse(predictionDataStr)); } updateUI(); }
    function updateUI() { const submitButton = document.getElementById('submit-button'); if (submitButton) { submitButton.textContent = `Enviar Palpites (${selectedPredictions.length}/${maxPredictions})`; submitButton.disabled = selectedPredictions.length === 0; } const isMaxReached = selectedPredictions.length >= maxPredictions; document.querySelectorAll('.odds-item').forEach(item => { if (!item.classList.contains('selected')) item.classList.toggle('disabled', isMaxReached); }); }
    window.submitPredictions = function() { if (selectedPredictions.length !== maxPredictions) { showErrorPopup(`Deve selecionar exatamente ${maxPredictions} palpites. Atualmente tem ${selectedPredictions.length}.`); return; } const confirmationPopup = document.getElementById('confirmation-popup'); let predictionsHtml = '<ul class="confirmation-list">'; selectedPredictions.forEach((p, i) => predictionsHtml += `<li class="confirmation-list-item"><span><strong>${replaceTeamPlaceholders(p.value)}</strong></span><button class="remove-prediction-btn" onclick="removePredictionFromPopup(${i})" title="Remover este palpite">×</button></li>`); predictionsHtml += '</ul>'; document.getElementById('confirmation-predictions').innerHTML = predictionsHtml; confirmationPopup.style.display = 'block'; }
    window.removePredictionFromPopup = function(indexToRemove) { const predictionValue = selectedPredictions[indexToRemove].value; selectedPredictions.splice(indexToRemove, 1); for (const item of document.querySelectorAll('.odds-item')) { if (JSON.parse(item.dataset.prediction).value === predictionValue) { item.classList.remove('selected'); break; } } updateUI(); closeConfirmationPopup(); };
    async function loadGameData(gameId) { const gameDoc = await getDoc(doc(db, 'jogos', gameId)); if (!gameDoc.exists()) throw new Error('Jogo não encontrado'); const game = { id: gameDoc.id, ...gameDoc.data() }; game.numeroPalpites = game.numeroPalpites || 1; const equipaCasaDoc = await getDoc(doc(db, 'clubes', game.equipaCasaId || ' ')); game.equipaCasa = equipaCasaDoc.exists() ? equipaCasaDoc.data().nome : 'Equipa A'; const equipaForaDoc = await getDoc(doc(db, 'clubes', game.equipaForaId || ' ')); game.equipaFora = equipaForaDoc.exists() ? equipaForaDoc.data().nome : 'Equipa B'; return game; }
    async function checkExistingPredictions(gameId) { if (!auth.currentUser) return null; const q = query(collection(db, 'users', auth.currentUser.uid, 'palpites'), where('jogoId', '==', gameId)); const querySnapshot = await getDocs(q); return querySnapshot.empty ? null : querySnapshot.docs[0].data(); }
    let currentUserStatus = null;
    async function loadMenuSettings() { try { const docSnap = await getDoc(doc(db, 'paineis', 'paineis menu')); return docSnap.exists() ? docSnap.data() : null; } catch (error) { return null; } }
    function checkPageAccess(userStatus, menuSettings) { return !menuSettings ? userStatus === 'ruler' : menuSettings['1x'] === 'on' || userStatus === 'ruler'; }
    function updateMenuVisibility(menuSettings) { if (!menuSettings) return; document.querySelectorAll('.bottom-menu .menu-item').forEach(item => { const key = item.getAttribute('data-key'); if (key) item.classList.toggle('hidden', menuSettings[key] === 'off'); }); }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserStatus = await getUserStatus(user.uid);
            if (currentUserStatus === null) {
                window.location.href = '404.html';
                return;
            }

            // CÓDIGO ADICIONADO PARA ATUALIZAR O ÚLTIMO ACESSO (COM CORREÇÃO)
            try {
                const userDocRef = doc(db, 'users', user.uid);
                await updateDoc(userDocRef, {
                    ultimoacesso: serverTimestamp()
                });
            } catch (error) {
                console.error("Erro ao atualizar o campo ultimoacesso: ", error);
            }
            // FIM DO CÓDIGO ADICIONADO

            const menuSettings = await loadMenuSettings();
            if (checkPageAccess(currentUserStatus, menuSettings)) {
                updateMenuVisibility(menuSettings);
                await loadGameDetails();
            } else {
                window.location.href = '404.html';
            }
        } else {
            loadingScreen.style.display = 'none';
            window.location.href = 'index.html';
        }
    });

    window.addEventListener('beforeunload', () => clearInterval(countdownInterval));
</script>
</body>
</html>
