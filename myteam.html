<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Equipa - GGAMES</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ... (Seu CSS original - o mesmo do c√≥digo anterior correto) ... */
        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
        }

        .menu-item:hover, .menu-item.active {
            color: #333;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #2176ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(33, 118, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover {
            color: #0056d6;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(33, 118, 255, 0.6));
        }

         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }



        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex; /* Show when active class is added */
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-confirm {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .btn-confirm:hover {
            background-color: #45a049;
        }

        .btn-cancel:hover {
            background-color: #d32f2f;
        }

        .btn-confirm.add-player-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-confirm.add-player-btn:hover {
            background: linear-gradient(135deg, #45a049, #357a38);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-confirm.add-player-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }



        .content {
            padding: 20px;
            margin-bottom: 80px; /* Reduced margin-bottom to accommodate bottom menu */
            display: none; /* Hide content initially */
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .loading-spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .team-section {
            display: flex;
            gap: 20px;
            padding: 20px;
            flex-direction: column;
            align-items: flex-start;
        }

        @media (min-width: 768px) {
            .team-section {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .pitch-side, .player-selection-side {
            flex: 1;
            min-width: 300px;
        }

        .player-selection-side {
            margin-top: 45px; /* Aligns with the top of pitch-area */
        }

        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 0;
            padding-bottom: 75%;
            background-color: #2d6a4f;
            border: 1px solid #228B22;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .pitch-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 96%;
            height: 94%;
            border: 1px solid white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }


        .pitch-area::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
            background-color: white;
            z-index: 0; /* Optionally add this to ensure line is behind, although default is 0 */
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 1px solid white;
            border-radius: 50%;
        }

        .position {
            position: absolute;
            width: 30px; /* Tamanho original da "bola" */
            height: 30px; /* Tamanho original da "bola" */
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            color: white;
            transition: background-color 0.3s ease;
            border: none;
        }

        .position:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .position img {
            position: absolute; /* Posicionamento absoluto para sobrepor a "bola" */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centraliza a imagem */
            width: 60px; /* Dobro do tamanho da "bola" */
            height: 60px; /* Dobro do tamanho da "bola" */
            border-radius: 50%;
            object-fit: cover;
            /* pointer-events: none; REMOVED THIS LINE */
            z-index: 1; /* Add this line to bring player images forward */
        }


        .formation-options {
            margin-bottom: 10px;
        }

        .formation-options label {
            margin-right: 10px;
            font-weight: bold;
        }

        .player-search-section {
        }

        .player-search-bar {
        }

        .player-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-results, .playerCardList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            width: 100%;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }

        .player-results::-webkit-scrollbar, .playerCardList::-webkit-scrollbar {
            width: 8px;
        }

        .player-results::-webkit-scrollbar-track, .playerCardList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .player-results::-webkit-scrollbar-thumb, .playerCardList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .player-results::-webkit-scrollbar-thumb:hover, .playerCardList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Add casta-based background gradients */
        .player-card.bronze {
            background: linear-gradient(135deg, #cd7f32, #a0522d);
            color: white;
        }

        .player-card.silver {
            background: linear-gradient(135deg, #c0c0c0, #808080);
            color: white;
        }

        .player-card.golden {
            background: linear-gradient(135deg, #ffd700, #daa520);
            color: white;
            /*text-shadow: 0 0 4px black;*/ /* Opcional: Sombra no texto para melhor contraste */
        }


        .player-card.diamond {
            background: linear-gradient(135deg, #b9f2ff, #00bfff);
            color: white;
        }

        .player-card.platina {
            background: linear-gradient(135deg, #e5e4e2, #c0c0c0);
            color: white;
        }

        .player-card {
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            background-color: #f5f5f5;
        }

        .player-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .player-card .player-info {
            width: 100%;
            text-align: center;
        }

        .player-card .player-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 2px;
            display: block;
        }

        .player-card .country-flag {
            width: 20px;
            height: 15px;
            object-fit: contain;
            position: absolute;
            top: 8px;
            right: 8px;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            z-index: 2;
        }

        .player-card .player-position {
            font-size: 0.8em;
            color: white;
            display: block;
            text-align: center;
        }

        .player-card .competition-logo {
            width: 20px;
            height: 15px;
            object-fit: contain;
            position: absolute;
            top: 28px;
            right: 8px;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            z-index: 2;
        }


        .formation-options {
            padding: 10px;
        }

        .formation-controls {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
        }

        button#saveFormationBtn, button#chooseBtn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#saveFormationBtn {
            background-color: #4CAF50;
        }

        button#saveFormationBtn:hover {
            background-color: #45a049;
        }

        button#chooseBtn {
            background-color: #FFB700;
        }

        button#chooseBtn:hover {
            background-color: #DAA520;
        }

        .formation-select-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .formation-options select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .search-container {
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .search-container input[type="text"] {
            padding: 8px;
            width: 40%;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .filter-dropdowns {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .filter-dropdowns select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button#saveFormationBtn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50; /* Green background */
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#saveFormationBtn:hover {
            background-color: #45a049; /* Darker green on hover */
        }


    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <h1>Minha Equipa</h1>

        <div class="team-section">
            <div class="pitch-side">
                <div class="formation-options">
                    <div class="formation-controls">
                        <div class="formation-select-container">
                            <label for="formation-select">Forma√ß√£o:</label>
                            <select id="formation-select">
                                <option value="" disabled selected>Selecionar Forma√ß√£o</option>
                            </select>
                        </div>
                        <button id="saveFormationBtn">Guardar</button>
                        <button id="chooseBtn">Escolher</button>
                    </div>
                </div>

                <div class="pitch-container">
                    <div class="pitch-area">
                        <div class="center-circle"></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-side">
                <div class="search-container">
                    <input type="text" id="player-search" placeholder="Pesquisar jogador...">
                    <div class="filter-dropdowns">
                        <select id="country-filter">
                            <option value="">Pa√≠s (Todos)</option>
                        </select>
                        <select id="club-filter">
                            <option value="">Clube (Todos)</option>
                        </select>
                    </div>
                </div>
                <div class="player-results">
                    No data available in table
                </div>
            </div>
        </div>


    </div>



    <!-- Player List Modal -->
    <div id="playerListModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Escolha um Jogador</h3>
            <div id="playerCardList" class="player-results">
                <!-- Player cards will be loaded here by JavaScript -->
                <p>A carregar jogadores...</p>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" id="closePlayerListModal">Fechar</button>
            </div>
        </div>
    </div>

    <nav class="bottom-menu">
        <a href="1x.html" class="menu-item">
            <i class="fas fa-home"></i>
        </a>
        <a href="market.html" class="menu-item">
            <i class="fas fa-shopping-cart"></i>
        </a>
        <a href="team.html" class="menu-item active">
            <i class="fas fa-users"></i>
        </a>
        <a href="empire.html" class="menu-item">
            <i class="fas fa-landmark empire-icon"></i>
        </a>
        <a href="rankings.html" class="menu-item">
            <i class="fas fa-list"></i>
        </a>
        <a href="profile.html" class="menu-item">
            <i class="fas fa-user"></i>
        </a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, limit, setDoc, addDoc, FieldValue, where, serverTimestamp, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.firebasestorage.app",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const firebase = {
            firestore: {
                doc: doc,
                getDoc: getDoc,
                collection: collection,
                getDocs: getDocs,
                query: query,
                orderBy: orderBy,
                limit: limit,
                setDoc: setDoc,
                addDoc: addDoc,
                FieldValue: FieldValue,
                where: where,
                serverTimestamp: serverTimestamp, // ADDED serverTimestamp here for easier access if needed in future
                writeBatch: writeBatch
            }
        };


        const loadingScreen = document.getElementById('loading-screen');
        const content = document.querySelector('.content');
        let currentUserStatus = null;
        let currentUserUid = null;
        let allPlayers = [];
        let userPlayers = [];
        let countries = {};
        let clubs = new Set();
        let currentFormation = ''; // Initialize currentFormation to empty string
        let hasUnsavedChanges = false;
        const formationSelect = document.getElementById('formation-select');
        const pitchArea = document.querySelector('.pitch-area');
        const playerResultsContainer = document.querySelector('.player-results');
        const playerSearchInput = document.getElementById('player-search');
        const countryFilterSelect = document.getElementById('country-filter');
        const clubFilterSelect = document.getElementById('club-filter');
        const playerListModal = document.getElementById('playerListModal'); // Get the player list modal
        const closePlayerListModalBtn = document.getElementById('closePlayerListModal'); // Get close button for player list modal
        const playerCardListContainer = document.getElementById('playerCardList'); // Container for player cards in modal


        let assignedPlayers = {}; // Declare assignedPlayers outside renderFormation scope


        const formations = { // Keep formations for pitch rendering logic
            '4-4-2': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                { position: 'ML', top: '40%', left: '12%', positionType: 'MID' },
                { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' },
                { position: 'MR', top: '40%', left: '82%', positionType: 'MID' },
                { position: 'FW1', top: '10%', left: '32%', positionType: 'FWD' },
                { position: 'FW2', top: '10%', left: '62%', positionType: 'FWD' }
            ],
            '4-3-3': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                { position: 'MC2', top: '60%', left: '47%', positionType: 'MID' },
                { position: 'MC3', top: '40%', left: '62%', positionType: 'MID' },
                { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' },
                { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' },
                { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' },
            ],
            '4-5-1': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' },
                { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' },
                { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' },
                { position: 'DML', top: '50%', left: '47%', positionType: 'MID' },
                { position: 'MC1', top: '40%', left: '10%', positionType: 'MID' },
                { position: 'AMC', top: '40%', left: '30%', positionType: 'MID' },
                { position: 'MC2', top: '40%', left: '64%', positionType: 'MID' },
                { position: 'DMR', top: '40%', left: '84%', positionType: 'MID' },
                { position: 'FW', top: '10%', left: '47%', positionType: 'FWD' }
            ],
            '3-4-3': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'DC1', top: '75%', left: '20%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '47%', positionType: 'DEF' },
                { position: 'DC3', top: '75%', left: '77%', positionType: 'DEF' },
                { position: 'ML', top: '40%', left: '12%', positionType: 'MID' },
                { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' },
                { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' },
                { position: 'MR', top: '40%', left: '82%', positionType: 'MID' },
                { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' },
                { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' },
                { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' },
            ],
            '5-3-2': [
                { position: 'GK', top: '90%', left: '47%', positionType: 'GK' },
                { position: 'SW', top: '75%', left: '10%', positionType: 'DEF' },
                { position: 'WBL', top: '75%', left: '30%', positionType: 'DEF' },
                { position: 'DC1', top: '75%', left: '47%', positionType: 'DEF' },
                { position: 'DC2', top: '75%', left: '64%', positionType: 'DEF' },
                { position: 'WBR', top: '75%', left: '84%', positionType: 'DEF' },
                { position: 'MC1', top: '40%', left: '30%', positionType: 'MID' },
                { position: 'MC2', top: '55%', left: '47%', positionType: 'MID' },
                { position: 'MC3', top: '40%', left: '64%', positionType: 'MID' },
                { position: 'FW1', top: '10%', left: '30%', positionType: 'FWD' },
                { position: 'FW2', top: '10%', left: '64%', positionType: 'FWD' }
            ]
        };


        async function saveFormation() {
            hasUnsavedChanges = false;
            if (!currentUserUid) {
                console.log("Utilizador n√£o autenticado.");
                return;
            }

            try {
                // Get the latest season from palpites collection
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                let latestSeason = '';

                if (!palpitesSnapshot.empty) {
                    latestSeason = palpitesSnapshot.docs[0].data().temporada;
                } else {
                    console.error('No seasons found in palpites collection');
                    return;
                }

                // Check for existing formation in planteis
                const planteisRef = collection(db, 'planteis');
                const planteisQuery = query(
                    planteisRef,
                    where('userId', '==', currentUserUid),
                    where('formacao', '==', currentFormation),
                    where('temporada', '==', latestSeason)
                );
                const planteisSnapshot = await getDocs(planteisQuery);

                // Create position data from assignedPlayers
                const positionData = {};
                const positions = document.querySelectorAll('.position');
                positions.forEach(positionElement => {
                    const positionId = positionElement.dataset.position;
                    const playerId = positionElement.dataset.assignedPlayerId;
                    positionData[positionId] = playerId || null;
                });

                const plantelData = {
                    ...positionData,
                    userId: currentUserUid,
                    formacao: currentFormation,
                    temporada: latestSeason,
                    estado: 'ativo',
                    dataDeEdicao: serverTimestamp()
                };

                if (!planteisSnapshot.empty) {
                    // Update existing formation
                    const docRef = planteisSnapshot.docs[0].ref;
                    await updateDoc(docRef, plantelData);
                } else {
                    // Create new formation
                    await addDoc(planteisRef, plantelData);
                }

                // Reset unsaved changes flag
                hasUnsavedChanges = false;
                console.log("Forma√ß√£o guardada com sucesso!");

                // Show confirmation icon
                const saveBtn = document.getElementById('saveFormationBtn');
                const confirmIcon = document.createElement('i');
                confirmIcon.classList.add('fas', 'fa-check');
                confirmIcon.style.color = '#4CAF50';
                confirmIcon.style.marginLeft = '10px';
                saveBtn.parentNode.insertBefore(confirmIcon, saveBtn.nextSibling);

                // Remove confirmation icon after 3 seconds
                setTimeout(() => {
                    confirmIcon.remove();
                }, 3000);

            } catch (error) {
                console.error("Erro ao guardar forma√ß√£o:", error);
                alert("Erro ao guardar forma√ß√£o.");
            }
        }


        function renderFormation(formationName) {
            // Completely reset the formation and assigned players
            currentFormation = formationName;
            assignedPlayers = {};
            pitchArea.querySelectorAll('.position').forEach(pos => pos.remove()); // Remove all position elements

            currentFormation = formationName; // Update current formation

            const currentFormationPositions = formations[formationName];
            pitchArea.innerHTML = '<div class="center-circle"></div>'; // Re-add the center circle

            currentFormationPositions.forEach(pos => {
                const positionElement = document.createElement('div');
                positionElement.classList.add('position');
                positionElement.dataset.position = pos.position;
                positionElement.style.top = pos.top;
                positionElement.style.left = pos.left;
                positionElement.textContent = '+'; // Set back to '+' as default text
                positionElement.dataset.playerId = null;
                positionElement.dataset.positionType = pos.positionType;

                positionElement.addEventListener('dragover', (event) => {
                    event.preventDefault();
                });
                positionElement.addEventListener('drop', handlePositionDrop);

                // *** MODIFIED CLICK EVENT LISTENER - DEBUGGING - CORRECTED NULL CHECK ***
                positionElement.addEventListener('click', () => {
                    const assignedPlayerId = positionElement.dataset.assignedPlayerId;
                    console.log(`Click on position ${positionElement.dataset.position}, assignedPlayerId: ${assignedPlayerId}, typeof assignedPlayerId: ${typeof assignedPlayerId}`); // DEBUG LOG - TYPE OF
                    if (assignedPlayerId && assignedPlayerId !== "null") { // CORRECTED IF CONDITION
                        console.log("Player ID found (corrected check), calling removePlayerFromPosition"); // DEBUG LOG - CORRECTED CHECK
                        // If player is assigned, remove them
                        removePlayerFromPosition(positionElement, assignedPlayerId, positionElement.dataset.position);
                        hasUnsavedChanges = true; // Marcar que h√° altera√ß√µes n√£o salvas
                    } else {
                        console.log("No Player ID found (corrected check), calling showPlayerListModal"); // DEBUG LOG - CORRECTED CHECK
                        // If no player is assigned, show player list modal
                        showPlayerListModal(positionElement.dataset.positionType, positionElement); // PASS positionType and positionElement
                    }
                });


                pitchArea.appendChild(positionElement);
            });


            // N√£o reposicionar jogadores automaticamente ao mudar de forma√ß√£o
            // Deixamos a forma√ß√£o limpa para o utilizador adicionar jogadores manualmente
            // ou carregar a forma√ß√£o guardada do Firebase
        }

        function showPlayerListModal(positionType, positionElement) {
            playerListModal.classList.add('active'); // Show the modal
            playerCardListContainer.innerHTML = '<p>A carregar jogadores...</p>'; // Reset and show loading message
            populatePlayerCardList(positionType, positionElement); // Call function to populate player cards
        }

        async function populatePlayerCardList(positionType, positionElement) {
            try {
                // 1. Filter players based on positionType and ownership
                const filteredPlayers = allPlayers.filter(player => {
                    const playerPosicaoIngles = { // Mapping Portugu√™s -> Ingl√™s
                        "Avan√ßado": "FWD",
                        "Defesa": "DEF",
                        "M√©dio": "MID",
                        "Guarda-Redes": "GK"
                    }[player.posicao];
                    return playerPosicaoIngles === positionType && player.compradopor === currentUserUid;
                });

                // 2. Exclude already assigned players
                const availablePlayers = filteredPlayers.filter(player => {
                    return !isPlayerAssigned(player.id); // Use the isPlayerAssigned function
                });

                playerCardListContainer.innerHTML = ''; // Clear "Loading..." message

                if (availablePlayers.length === 0) {
                    playerCardListContainer.innerHTML = '<p>Sem jogadores dispon√≠veis para esta posi√ß√£o.</p>';
                    return;
                }

                // 3. Render player cards in the modal
                availablePlayers.forEach(player => {
                    const playerCard = document.createElement('div');
                    playerCard.classList.add('player-card');
                    playerCard.classList.add('modal-player-card'); // Add a class to distinguish modal cards if needed
                    // === PASTE YOUR PLAYER CARD CREATION LOGIC FROM renderPlayerResults HERE ===
                    // Make sure to adapt it if necessary for the modal context
                    if (player.casta) {
                        const castaMap = {
                            'Jogador Ouro': 'golden',
                            'Jogador Prata': 'silver',
                            'Jogador Bronze': 'bronze',
                            'Jogador Platina': 'platina',
                            'Jogador Diamante': 'diamond'
                        };

                        const castaClass = castaMap[player.casta];
                        if (castaClass) {
                            playerCard.classList.add(castaClass);
                        }
                    }

                    // Add country flag to the top right corner of the card
                    if (player.paisId && countries[player.paisId]) {
                        const flagImg = document.createElement('img');
                        flagImg.src = countries[player.paisId].imagem || 'placeholder_flag_url.png';
                        flagImg.alt = countries[player.paisId].nome;
                        flagImg.classList.add('country-flag');
                        playerCard.appendChild(flagImg);
                    }

                    const img = document.createElement('img');
                    img.src = player.imagem || 'placeholder_image_url.png';
                    img.alt = player.nome;
                    playerCard.appendChild(img);

                    const playerInfo = document.createElement('div');
                    playerInfo.classList.add('player-info');

                    const playerName = document.createElement('span');
                    playerName.classList.add('player-name');
                    playerName.textContent = player.nome;
                    playerInfo.appendChild(playerName);

                    const playerPosition = document.createElement('span');
                    playerPosition.classList.add('player-position');
                    playerPosition.textContent = player.posicao;
                    playerInfo.appendChild(playerPosition);

                    // Add competition logo using two-step fetch process - adapt if needed for modal
                    if (player.clube) {
                        const clubesRef = collection(db, 'clubes');
                        const clubQuery = query(clubesRef, where('nome', '==', player.clube));
                        getDocs(clubQuery).then(clubSnapshot => {
                            if (!clubSnapshot.empty) {
                                const clubData = clubSnapshot.docs[0].data();
                                if (clubData.competicaoId) {
                                    const competicaoRef = doc(db, 'competicoes', clubData.competicaoId);
                                    getDoc(competicaoRef).then(competicaoDoc => {
                                        if (competicaoDoc.exists()) {
                                            const competicaoData = competicaoDoc.data();
                                            const competicaoLogo = document.createElement('img');
                                            competicaoLogo.src = competicaoData.imagem;
                                            competicaoLogo.alt = competicaoData.nome;
                                            competicaoLogo.classList.add('competition-logo');
                                            playerInfo.appendChild(competicaoLogo);
                                        }
                                    });
                                }
                            }
                        });
                    }


                    // 4. Add "ADICIONAR" button to each card
                    const addButton = document.createElement('button');
                    addButton.textContent = 'ADICIONAR';
                    addButton.classList.add('btn-confirm', 'add-player-btn'); // Style the button
                    addButton.addEventListener('click', () => {
                        // Logic to add player to position and close modal
                        assignPlayerToPosition(player, positionElement);
                        playerListModal.classList.remove('active'); // Close the modal after adding
                    });
                    playerCard.appendChild(addButton);

                    playerCardListContainer.appendChild(playerCard);
                });


            } catch (error) {
                console.error("Error populating player card list:", error);
                playerCardListContainer.innerHTML = '<p>Erro ao carregar jogadores.</p>';
            }
        }

        function assignPlayerToPosition(player, positionElement) {
            // Similar logic to handlePositionDrop, but triggered by "ADICIONAR" button
            const playerId = player.id;
            const positionId = positionElement.dataset.position;

            // Clear '+' text and add player image to the position
            positionElement.innerHTML = '';
            const playerImg = document.createElement('img');
            playerImg.src = player.imagem || 'placeholder_image_url.png';
            playerImg.alt = player.nome;
            positionElement.appendChild(playerImg);
            positionElement.dataset.assignedPlayerId = playerId;
            assignedPlayers[positionId] = playerId;
            hasUnsavedChanges = true; // Mark that there are unsaved changes
            console.log(`Jogador ${player.nome} adicionado √† posi√ß√£o ${positionId} via popup.`);
        }


        closePlayerListModalBtn.addEventListener('click', () => {
            playerListModal.classList.remove('active'); // Hide the player list modal
        });


        function repositionPlayers(previousFormationName, previousAssignedPlayers, currentFormationName) {
            const currentFormationPositions = formations[currentFormationName];
            const availablePositions = currentFormationPositions.reduce((acc, pos) => { // Criar um mapa de posi√ß√µes dispon√≠veis por tipo
                acc[pos.positionType] = acc[pos.positionType] || [];
                acc[pos.positionType].push(pos.position);
                return acc;
            }, {});

            for (const positionId in previousAssignedPlayers) {
                const playerId = previousAssignedPlayers[positionId];
                if (!playerId) continue; // Skip if no player assigned to this previous position
                const player = allPlayers.find(p => p.id === playerId);
                if (!player) continue;

                const playerPosicaoIngles = { // Mapeamento para Portugu√™s -> Ingl√™s (igual ao handlePositionDrop)
                    "Avan√ßado": "FWD",
                    "Defesa": "DEF",
                    "M√©dio": "MID",
                    "Guarda-Redes": "GK"
                }[player.posicao];

                if (availablePositions[playerPosicaoIngles] && availablePositions[playerPosicaoIngles].length > 0) {
                    const newPositionId = availablePositions[playerPosicaoIngles].shift(); // Obter e remover a primeira posi√ß√£o dispon√≠vel deste tipo
                    const positionElement = document.querySelector(`.position[data-position="${newPositionId}"]`);
                    if (positionElement) {
                        positionElement.innerHTML = ''; // Clear '+' text
                        const playerImg = document.createElement('img');
                        playerImg.src = player.imagem || 'placeholder_image_url.png';
                        playerImg.alt = player.nome;
                        positionElement.appendChild(playerImg);
                        positionElement.dataset.assignedPlayerId = playerId;
                        assignedPlayers[newPositionId] = playerId; // Update assignedPlayers for the new formation
                        hasUnsavedChanges = true; // Mark that there are unsaved changes when repositioning players
                        console.log(`Jogador ${player.nome} reposicionado de ${previousFormationName} para ${currentFormationName} na posi√ß√£o ${newPositionId}`);
                    }
                } else {
                    console.log(`N√£o foi poss√≠vel reposicionar ${player.nome} de ${previousFormationName} para ${currentFormationName}. Sem posi√ß√µes ${playerPosicaoIngles} dispon√≠veis.`);
                    // Jogador n√£o pode ser reposicionado - pode querer fazer algo mais aqui (ex: colocar numa "banca")
                }
            }
        }


        function handlePositionDrop(event) {
            event.preventDefault();
            const playerId = event.dataTransfer.getData('playerId');
            const positionElement = event.currentTarget;
            const positionId = positionElement.dataset.position;
            const positionType = positionElement.dataset.positionType;
            const originalPositionId = event.dataTransfer.getData('originalPositionId'); // Obter a posi√ß√£o de origem se for uma troca

            const player = allPlayers.find(p => p.id === playerId);
            if (!player) return;

            const posicaoMapping = {
                "Avan√ßado": "FWD",
                "Defesa": "DEF",
                "M√©dio": "MID",
                "Guarda-Redes": "GK"
            };
            const playerPosicaoIngles = posicaoMapping[player.posicao];

            if (playerPosicaoIngles !== positionType) {
                alert(`Este jogador √© ${player.posicao} e s√≥ pode ser colocado em posi√ß√µes de ${positionType}`);
                return;
            }

            // Verificar se o jogador j√° est√° atribu√≠do a OUTRA posi√ß√£o
            const alreadyAssignedPosition = Object.keys(assignedPlayers).find(pos => assignedPlayers[pos] === playerId);
            if (alreadyAssignedPosition && alreadyAssignedPosition !== positionId) {
                // Remover jogador da posi√ß√£o anterior
                const previousPositionElement = document.querySelector(`.position[data-position="${alreadyAssignedPosition}"]`);
                if (previousPositionElement) {
                    removePlayerFromPosition(previousPositionElement, playerId, alreadyAssignedPosition);
                }
            }


            // Verificar se j√° existe um jogador na posi√ß√£o de destino
            const existingPlayerId = positionElement.dataset.assignedPlayerId;

            if (existingPlayerId) {
                // Trocar jogadores
                if (existingPlayerId === playerId) { // Impedir troca consigo mesmo
                    return;
                }

                const originalPositionElement = originalPositionId ? document.querySelector(`.position[data-position="${originalPositionId}"]`) : null;

                if (originalPositionElement) {
                    // Remover jogador arrastado da posi√ß√£o original
                    originalPositionElement.innerHTML = '+';
                    originalPositionElement.dataset.assignedPlayerId = null;
                    delete assignedPlayers[originalPositionId]; // Remover do assignedPlayers

                    // Colocar jogador arrastado na nova posi√ß√£o
                    positionElement.innerHTML = '';
                    const playerImg = document.createElement('img');
                    playerImg.src = player.imagem || 'placeholder_image_url.png';
                    playerImg.alt = player.nome;
                    positionElement.appendChild(playerImg);
                    positionElement.dataset.assignedPlayerId = playerId;
                    assignedPlayers[positionId] = playerId;

                    // Encontrar o jogador existente (que estava na posi√ß√£o de destino)
                    const playerExistente = allPlayers.find(p => p.id === existingPlayerId);
                    if (playerExistente) {
                        // Colocar o jogador existente DE VOLTA na posi√ß√£o de ORIGEM do jogador arrastado

                        originalPositionElement.innerHTML = ''; // Limpar texto '+'
                        const playerExistenteImg = document.createElement('img');
                        playerExistenteImg.src = playerExistente.imagem || 'placeholder_image_url.png';
                        playerExistenteImg.alt = playerExistente.nome;
                        originalPositionElement.appendChild(playerExistenteImg);
                        originalPositionElement.dataset.assignedPlayerId = existingPlayerId;
                        assignedPlayers[originalPositionId] = existingPlayerId; // Reatribuir jogador existente √† posi√ß√£o original

                        console.log(`Jogadores trocados: ${player.nome} trocado com ${playerExistente.nome}`);
                        hasUnsavedChanges = true; // Marcar que h√° altera√ß√µes n√£o salvas
                        return; // Troca completa, sair da fun√ß√£o
                    }
                } else {
                    // Se n√£o h√° posi√ß√£o original (jogador arrastado da lista), substitui o jogador existente
                    positionElement.innerHTML = '';
                    const playerImg = document.createElement('img');
                    playerImg.src = player.imagem || 'placeholder_image_url.png';
                    playerImg.alt = player.nome;
                    positionElement.appendChild(playerImg);
                    positionElement.dataset.assignedPlayerId = playerId;
                    assignedPlayers[positionId] = playerId;
                    console.log(`Jogador ${player.nome} substituiu o jogador na posi√ß√£o ${positionId}`);
                    hasUnsavedChanges = true; // Marcar que h√° altera√ß√µes n√£o salvas
                }


            } else {
                // Se n√£o havia jogador na posi√ß√£o de destino (ou se a troca falhou por algum motivo),
                // L√≥gica normal de "drop" (colocar jogador na posi√ß√£o vazia) - a mesma de antes
                positionElement.innerHTML = ''; // Clear '+' text
                const playerImg = document.createElement('img');
                playerImg.src = player.imagem || 'placeholder_image_url.png';
                playerImg.alt = player.nome;
                positionElement.appendChild(playerImg);
                positionElement.dataset.assignedPlayerId = playerId;
                assignedPlayers[positionId] = playerId;
                console.log(`Jogador ${player.nome} colocado na posi√ß√£o ${positionId}`);
                hasUnsavedChanges = true; // Marcar que h√° altera√ß√µes n√£o salvas
            }
        }


        function removePlayerFromPosition(positionElement, playerId, positionId) {
            console.log("LOG 3: removePlayerFromPosition function started for playerId:", playerId, "positionId:", positionId);
            try {
                positionElement.innerHTML = '+'; // Set back to '+' text
                positionElement.dataset.assignedPlayerId = null;
                delete assignedPlayers[positionId];
                console.log('assignedPlayers ap√≥s remover:', JSON.stringify(assignedPlayers));
                positionElement.removeEventListener('dragover', handlePositionDragOver); // Remover event listeners para evitar acumula√ß√£o
                positionElement.removeEventListener('drop', handlePositionDrop);
                positionElement.addEventListener('dragover', (event) => {
                    event.preventDefault();
                });
                positionElement.addEventListener('drop', handlePositionDrop);
                console.log(`Player ${playerId} removed from position ${positionId}`);
                hasUnsavedChanges = true; // Mark that there are unsaved changes when removing a player
                console.log("LOG 4: removePlayerFromPosition function finished for playerId:", playerId, "positionId:", positionId);
            } catch (error) {
                console.error("Erro interno em removePlayerFromPosition:", error);
            }
        }

        function handlePositionDragOver(event) {
            event.preventDefault();
        }

        function isPlayerAssigned(playerId) {
            console.log("isPlayerAssigned called for playerId:", playerId);
            console.log("Current assignedPlayers:", JSON.stringify(assignedPlayers));
            for (const position in assignedPlayers) {
                if (assignedPlayers[position] === playerId) {
                    console.log(`Player ${playerId} is already assigned to position ${position}`);
                    return true;
                }
            }
            console.log(`Player ${playerId} is NOT assigned.`);
            return false;
        }


        formationSelect.addEventListener('change', async (e) => {
            const newFormation = e.target.value;
            if (!newFormation) return; // Prevent rendering if formation is empty (default option)

            if (hasUnsavedChanges) {
                console.log("Inside if (hasUnsavedChanges) - value is:", hasUnsavedChanges); // ADDED CONSOLE LOG
                showConfirmationModal(
                    'Quer guardar as altera√ß√µes feitas?',
                    async () => {
                        // User clicked 'Sim'
                        await saveFormation();
                        currentFormation = newFormation;
                        renderFormation(currentFormation);
                        await loadFormation();
                    },
                    () => {
                        // User clicked 'N√£o'
                        hasUnsavedChanges = false;
                        currentFormation = newFormation;
                        renderFormation(currentFormation);
                        loadFormation();
                    }
                );
            } else {
                console.log("Inside else (hasUnsavedChanges) - value is:", hasUnsavedChanges); // ADDED CONSOLE LOG
                currentFormation = newFormation;
                renderFormation(currentFormation);
                await loadFormation();
            }
        });

        // Fun√ß√£o para mostrar o modal de confirma√ß√£o personalizado
        function showConfirmationModal(message, confirmCallback, cancelCallback) {
            console.log("showConfirmationModal function called");
            console.log("Confirmation modal message:", message);

            // Criar o overlay do modal
            const modalOverlay = document.createElement('div');
            modalOverlay.classList.add('modal-overlay');

            // Criar o conte√∫do do modal
            const modalContent = document.createElement('div');
            modalContent.classList.add('modal-content');

            // Adicionar a mensagem
            const messageElement = document.createElement('p');
            messageElement.textContent = message;
            modalContent.appendChild(messageElement);

            // Criar os bot√µes
            const buttonsContainer = document.createElement('div');
            buttonsContainer.classList.add('modal-buttons');

            // Bot√£o Sim
            const confirmButton = document.createElement('button');
            confirmButton.classList.add('btn-confirm');
            confirmButton.textContent = 'Sim';
            confirmButton.onclick = () => {
                document.body.removeChild(modalOverlay);
                if (confirmCallback) confirmCallback();
            };

            // Bot√£o N√£o
            const cancelButton = document.createElement('button');
            cancelButton.classList.add('btn-cancel');
            cancelButton.textContent = 'N√£o';
            cancelButton.onclick = () => {
                document.body.removeChild(modalOverlay);
                if (cancelCallback) cancelCallback();
            };

            // Adicionar bot√µes ao container
            buttonsContainer.appendChild(confirmButton);
            buttonsContainer.appendChild(cancelButton);
            modalContent.appendChild(buttonsContainer);

            // Adicionar o conte√∫do ao overlay e o overlay ao body
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            modalOverlay.classList.add('active'); // ADICIONE ESTA LINHA!
            console.log("Modal overlay element created and appended:", modalOverlay);
            console.log("Modal content element created and appended:", modalContent);
        }


        async function fetchPlayers() {
            const playersRef = collection(db, 'jogadores');
            // Create a query to filter players where compradopor equals currentUserUid
            const playersQuery = query(playersRef, where('compradopor', '==', currentUserUid));
            const playersSnap = await getDocs(playersQuery);
            const fetchedPlayers = [];
            playersSnap.forEach(doc => {
                const playerData = doc.data();
                fetchedPlayers.push({...playerData, id: doc.id, posicao: playerData.posicao});
                clubs.add(playerData.clube);
            });
            allPlayers = fetchedPlayers;
            populateClubFilter();
            renderPlayerResults(allPlayers);
        }

        async function fetchUserPlayers(userId) {
            const userPlayersRef = collection(db, 'users', userId, 'jogadores'); // This path seems incorrect, should be just 'jogadores' collection for all players bought by users
            const userPlayersSnap = await getDocs(userPlayersRef);
            const fetchedUserPlayers = [];
            userPlayersSnap.forEach(doc => {
                fetchedUserPlayers.push({...doc.data(), id: doc.id});
            });
            userPlayers = fetchedUserPlayers;
            console.log('User players fetched:', userPlayers);
        }

        async function fetchCountries() {
            const countriesRef = collection(db, 'paises');
            const countriesSnap = await getDocs(countriesRef);
            const fetchedCountries = {};
            countriesSnap.forEach(doc => {
                fetchedCountries[doc.id] = doc.data();
            });
            countries = fetchedCountries;
            populateCountryFilter();
        }


        function populateCountryFilter() {
            countryFilterSelect.innerHTML = '<option value="">Pa√≠s (Todos)</option>';
            for (const countryId in countries) {
                const country = countries[countryId];
                const option = document.createElement('option');
                option.value = countryId;
                option.textContent = country.nome;
                countryFilterSelect.appendChild(option);
            }
        }

        function populateClubFilter() {
            clubFilterSelect.innerHTML = '<option value="">Clube (Todos)</option>';
            clubs.forEach(clubName => {
                const option = document.createElement('option');
                option.value = clubName;
                option.textContent = clubName;
                clubFilterSelect.appendChild(option);
            });
        }


        function renderPlayerResults(players) {
            // Sort players by position in the specified order: Guarda-Redes, Defesa, M√©dio, Avan√ßado
            const positionOrder = {
                'Guarda-Redes': 1,
                'Defesa': 2,
                'M√©dio': 3,
                'Avan√ßado': 4
            };

            // Create a sorted copy of the players array
            const sortedPlayers = [...players].sort((a, b) => {
                const posA = positionOrder[a.posicao] || 999; // Default high value for unknown positions
                const posB = positionOrder[b.posicao] || 999;
                return posA - posB;
            });

            playerResultsContainer.innerHTML = '';
            if (sortedPlayers.length === 0) {
                playerResultsContainer.textContent = 'No data available in table';
                return;
            }

            sortedPlayers.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('player-card');
                playerCard.draggable = true;
                playerCard.dataset.playerId = player.id;

                // Add casta-based class for styling
                if (player.casta) {
                    const castaMap = {
                        'Jogador Ouro': 'golden',
                        'Jogador Prata': 'silver',
                        'Jogador Bronze': 'bronze',
                        'Jogador Platina': 'platina',
                        'Jogador Diamante': 'diamond'
                    };

                    const castaClass = castaMap[player.casta];
                    if (castaClass) {
                        playerCard.classList.add(castaClass);
                    }
                }

                // Add country flag to the top right corner of the card
                if (player.paisId && countries[player.paisId]) {
                    const flagImg = document.createElement('img');
                    flagImg.src = countries[player.paisId].imagem || 'placeholder_flag_url.png';
                    flagImg.alt = countries[player.paisId].nome;
                    flagImg.classList.add('country-flag');
                    playerCard.appendChild(flagImg);
                }

                const img = document.createElement('img');
                img.src = player.imagem || 'placeholder_image_url.png';
                img.alt = player.nome;
                playerCard.appendChild(img);

                const playerInfo = document.createElement('div');
                playerInfo.classList.add('player-info');

                const playerName = document.createElement('span');
                playerName.classList.add('player-name');
                playerName.textContent = player.nome;
                playerInfo.appendChild(playerName);

                const playerPosition = document.createElement('span');
                playerPosition.classList.add('player-position');
                playerPosition.textContent = player.posicao;
                playerInfo.appendChild(playerPosition);

                // Add competition logo using two-step fetch process
                if (player.clube) {
                    const clubesRef = collection(db, 'clubes');
                    const clubQuery = query(clubesRef, where('nome', '==', player.clube));
                    getDocs(clubQuery).then(clubSnapshot => {
                        if (!clubSnapshot.empty) {
                            const clubData = clubSnapshot.docs[0].data();
                            if (clubData.competicaoId) {
                                const competicaoRef = doc(db, 'competicoes', clubData.competicaoId);
                                getDoc(competicaoRef).then(competicaoDoc => {
                                    if (competicaoDoc.exists()) {
                                        const competicaoData = competicaoDoc.data();
                                        const competicaoLogo = document.createElement('img');
                                        competicaoLogo.src = competicaoData.imagem;
                                        competicaoLogo.alt = competicaoData.nome;
                                        competicaoLogo.classList.add('competition-logo');
                                        playerInfo.appendChild(competicaoLogo);
                                    }
                                });
                            }
                        }
                    });
                }

                playerCard.appendChild(playerInfo);

                playerCard.addEventListener('dragstart', (event) => {
                    event.dataTransfer.setData('playerId', player.id);
                });

                playerResultsContainer.appendChild(playerCard);
            });
        }


        function filterPlayers() {
            const searchTerm = playerSearchInput.value.toLowerCase();
            const selectedCountryId = countryFilterSelect.value;
            const selectedClub = clubFilterSelect.value;

            const filteredPlayers = allPlayers.filter(player => {
                const nameMatch = player.nome.toLowerCase().includes(searchTerm);
                const countryMatch = selectedCountryId ? player.paisId === selectedCountryId : true;
                const clubMatch = selectedClub ? player.clube === selectedClub : true;
                const userMatch = player.compradopor === currentUserUid; // Only show players bought by current user

                return nameMatch && countryMatch && clubMatch && userMatch;
            });
            renderPlayerResults(filteredPlayers);
        }


        playerSearchInput.addEventListener('input', filterPlayers);
        countryFilterSelect.addEventListener('change', filterPlayers);
        clubFilterSelect.addEventListener('change', filterPlayers);

        const saveFormationButton = document.getElementById('saveFormationBtn');
        saveFormationButton.addEventListener('click', saveFormation);

        const chooseBtn = document.getElementById('chooseBtn');

        chooseBtn.addEventListener('click', async () => {
            if (!currentUserUid) {
                console.log("User ID not available");
                return;
            }

            try {
                // Get the latest season from palpites collection
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);

                if (palpitesSnapshot.empty) {
                    console.error('No seasons found in palpites collection');
                    return;
                }

                const latestSeason = palpitesSnapshot.docs[0].data().temporada;

                // Query all planteis for current user and season
                const planteisRef = collection(db, 'planteis');
                const allPlanteisQuery = query(
                    planteisRef,
                    where('userId', '==', currentUserUid),
                    where('temporada', '==', latestSeason)
                );

                const allPlanteisSnapshot = await getDocs(allPlanteisQuery);

                // Update estado for all formations
                const batch = firebase.firestore.writeBatch(db);

                allPlanteisSnapshot.forEach(doc => {
                    const formation = doc.data().formacao;
                    // Set estado based on whether it matches current formation
                    const newEstado = formation === currentFormation ? 'ativo' : 'desativo';
                    batch.update(doc.ref, { estado: newEstado });
                });

                // Commit all updates
                await batch.commit();

                // Show confirmation icon
                const confirmIcon = document.createElement('i');
                confirmIcon.classList.add('fas', 'fa-check');
                confirmIcon.style.color = '#4CAF50';
                confirmIcon.style.marginLeft = '10px';
                chooseBtn.parentNode.insertBefore(confirmIcon, chooseBtn.nextSibling);

                // Remove the confirmation icon after 2 seconds
                setTimeout(() => {
                    confirmIcon.remove();
                }, 2000);

                console.log('Formation set as active successfully');
            } catch (error) {
                console.error('Error setting active formation:', error);
            }
        });


        async function getUserStatus(userId) {
            const userDoc = doc(db, 'users', userId);
            const docSnap = await getDoc(userDoc);
            if (docSnap.exists() && docSnap.data().aceite === "Yes") {
                return docSnap.data().estatuto;
            } else {
                return null;
            }
        }

        async function fetchFormationsFromFirestore() {
            if (!currentUserUid) {
                console.log("currentUserUid n√£o definido ao buscar forma√ß√µes.");
                return []; // Retorna um array vazio se n√£o houver utilizador
            }
            try {
                const userDocRef = firebase.firestore.doc(db, 'users', currentUserUid); // Refer√™ncia ao documento do utilizador atual
                const userDocSnap = await firebase.firestore.getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const t√°ticaString = userData.t√°tica; // Assume que o campo se chama 't√°tica'

                    if (t√°ticaString) {
                        // Processa a string para criar um array de forma√ß√µes
                        const formationNames = t√°ticaString.split(' '); // Divide a string por espa√ßos
                        return formationNames.map(name => ({ value: name, label: name })); // Cria objetos com value e label
                    } else {
                        console.log("Campo 't√°tica' est√° vazio ou n√£o existe no documento do utilizador.");
                        return []; // Retorna array vazio se o campo 't√°tica' estiver vazio
                    }
                } else {
                    console.log("Documento do utilizador n√£o encontrado.");
                    return []; // Retorna array vazio se o documento do utilizador n√£o existir
                }
            } catch (error) {
                console.error("Erro ao buscar forma√ß√µes do Firestore:", error);
                return []; // Retorna array vazio em caso de erro
            }
        }

        async function fetchActiveFormationFromPlanteis() {
            if (!currentUserUid) {
                console.log("currentUserUid n√£o definido ao buscar forma√ß√£o ativa em planteis.");
                return null;
            }
            try {
                const planteisRef = collection(db, 'planteis');
                const activePlanteisQuery = query(
                    planteisRef,
                    where('userId', '==', currentUserUid),
                    where('estado', '==', 'ativo'),
                    limit(1) // Assumindo que s√≥ existe um plantel ativo por utilizador
                );
                const activePlanteisSnapshot = await getDocs(activePlanteisQuery);

                if (!activePlanteisSnapshot.empty) {
                    const plantelData = activePlanteisSnapshot.docs[0].data();
                    return plantelData.formacao; // Retorna a forma√ß√£o ativa
                } else {
                    console.log("Nenhum plantel ativo encontrado para o utilizador.");
                    return null; // Retorna null se n√£o encontrar plantel ativo
                }
            } catch (error) {
                console.error("Erro ao buscar forma√ß√£o ativa do planteis:", error);
                return null; // Retorna null em caso de erro
            }
        }


        async function populateFormationDropdownFromFirestore() {
            const formations = await fetchFormationsFromFirestore();
            const formationSelect = document.getElementById('formation-select');

            // Limpa as op√ß√µes existentes antes de adicionar novas
            formationSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = "Selecionar Forma√ß√£o";
            formationSelect.appendChild(defaultOption);


            formations.forEach(formation => {
                const option = document.createElement('option');
                option.value = formation.value;
                option.textContent = formation.label;
                formationSelect.appendChild(option);
            });
        }


        async function loadFormation() {
            if (!currentUserUid) {
                console.log("currentUserUid n√£o definido ao carregar forma√ß√£o. Aguardando autentica√ß√£o...");
                return;
            }

            // Clear all positions and assigned players before loading
            pitchArea.querySelectorAll('.position img').forEach(img => img.remove());
            const positions = document.querySelectorAll('.position');
            positions.forEach(positionElement => {
                positionElement.textContent = '+';
                positionElement.dataset.assignedPlayerId = null;
            });
            assignedPlayers = {};

            try {
                // Get the latest season from palpites collection
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                let latestSeason = '';

                if (!palpitesSnapshot.empty) {
                    latestSeason = palpitesSnapshot.docs[0].data().temporada;
                } else {
                    console.error('No seasons found in palpites collection');
                    return;
                }

                // Query planteis for the current user's formation
                const planteisRef = collection(db, 'planteis');
                const planteisQuery = query(planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason));
                const planteisSnapshot = await getDocs(planteisQuery);

                if (!planteisSnapshot.empty) {
                    const plantelData = planteisSnapshot.docs[0].data();

                    // Clear current formation
                    pitchArea.querySelectorAll('.position img').forEach(img => img.remove());
                    assignedPlayers = {};

                    // Load players into positions
                    const positions = document.querySelectorAll('.position');
                    positions.forEach(positionElement => {
                        const positionId = positionElement.dataset.position;
                        const playerId = plantelData[positionId];

                        if (playerId) {
                            const player = allPlayers.find(p => p.id === playerId);
                            if (player) {
                                positionElement.innerHTML = '';
                                const playerImg = document.createElement('img');
                                playerImg.src = player.imagem || 'placeholder_image_url.png';
                                playerImg.alt = player.nome;
                                positionElement.appendChild(playerImg);
                                positionElement.dataset.assignedPlayerId = playerId;
                                assignedPlayers[positionId] = playerId;
                            }
                        }
                    });
                    console.log('Formation loaded successfully');
                } else {
                    console.log('No saved formation found for current user and formation type');
                }
            } catch (error) {
                console.error("Error loading formation:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                currentUserStatus = await getUserStatus(user.uid);
                if (currentUserStatus !== null) {
                    console.log(`User is logged in on team.html with status: ${currentUserStatus}`);
                    await fetchUserPlayers(user.uid);
                    await fetchPlayers();
                    await fetchCountries();
                    await populateFormationDropdownFromFirestore(); // Populate dropdown from Firestore

                    const activeFormation = await fetchActiveFormationFromPlanteis(); // Fetch active formation from planteis
                    const formationOptions = await fetchFormationsFromFirestore(); // Fetch formations again to get the list

                    if (activeFormation) {
                        currentFormation = activeFormation; // Set currentFormation to the active one
                        formationSelect.value = activeFormation; // Set dropdown to the active formation
                    } else if (formationOptions.length > 0) {
                        currentFormation = formationOptions[0].value; // Fallback to the first from 't√°tica' if no active plantel, if available
                        formationSelect.value = currentFormation; // Ensure dropdown is set even if no active plantel
                    } else {
                        currentFormation = '4-4-2'; // Default to 4-4-2 if no formations anywhere, or handle as needed
                        formationSelect.value = '4-4-2'; // Set dropdown to default as well
                    }


                    renderFormation(currentFormation); // Render initial formation *after* loading dropdown and setting currentFormation
                    await loadFormation(); // Load saved formation after players are fetched
                    loadingScreen.style.display = 'none';
                    content.style.display = 'block';
                } else {
                    console.log('User is not accepted');
                    window.location.href = '404.html';
                }
            } else {
                console.log('No user is logged in on team.html');
                loadingScreen.style.display = 'none';
                window.location.href = 'index.html';
            }
        });


        // Add event listener for page navigation
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Add event listeners for navigation menu items
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', async (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    showConfirmationModal(
                        'Quer guardar as altera√ß√µes feitas?',
                        async () => {
                            await saveFormation();
                            window.location.href = item.href;
                        },
                        () => {
                            hasUnsavedChanges = false;
                            window.location.href = item.href;
                        }
                    );
                }
            });
        });
    </script>
</body>
</html>
