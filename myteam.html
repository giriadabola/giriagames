<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Equipa - GGAMES</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ... (Seu CSS original - o mesmo do código anterior correto) ... */
        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
        }

        .menu-item:hover, .menu-item.active {
            color: #333;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #2176ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(33, 118, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover {
            color: #0056d6;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(33, 118, 255, 0.6));
        }

         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }



        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex; /* Show when active class is added */
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-confirm {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .btn-confirm:hover {
            background-color: #45a049;
        }

        .btn-cancel:hover {
            background-color: #d32f2f;
        }

        .btn-confirm.add-player-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-confirm.add-player-btn:hover {
            background: linear-gradient(135deg, #45a049, #357a38);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-confirm.add-player-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }



        .content {
            padding: 20px;
            margin-bottom: 80px; /* Reduced margin-bottom to accommodate bottom menu */
            display: none; /* Hide content initially */
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .loading-spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .team-section {
            display: flex;
            gap: 20px;
            padding: 20px;
            flex-direction: column;
            align-items: flex-start;
        }

        @media (min-width: 768px) {
            .team-section {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .pitch-side, .player-selection-side {
            flex: 1;
            min-width: 300px;
        }

        .player-selection-side {
            margin-top: 45px; /* Aligns with the top of pitch-area */
        }

        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 0;
            padding-bottom: 75%;
            background-color: #2d6a4f;
            border: 1px solid #228B22;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .pitch-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 96%;
            height: 94%;
            border: 1px solid white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }


        .pitch-area::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
            background-color: white;
            z-index: 0; /* Optionally add this to ensure line is behind, although default is 0 */
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 1px solid white;
            border-radius: 50%;
        }

        .position {
            position: absolute;
            width: 30px; /* Tamanho original da "bola" */
            height: 30px; /* Tamanho original da "bola" */
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            color: white;
            transition: background-color 0.3s ease;
            border: none;
        }

        .position:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .position img {
            position: absolute; /* Posicionamento absoluto para sobrepor a "bola" */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centraliza a imagem */
            width: 60px; /* Dobro do tamanho da "bola" */
            height: 60px; /* Dobro do tamanho da "bola" */
            border-radius: 50%;
            object-fit: cover;
            /* pointer-events: none; REMOVED THIS LINE */
            z-index: 1; /* Add this line to bring player images forward */
        }


        .formation-options {
            margin-bottom: 10px;
        }

        .formation-options label {
            margin-right: 10px;
            font-weight: bold;
        }

        .player-search-section {
        }

        .player-search-bar {
        }

        .player-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-results, .playerCardList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            width: 100%;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }

        .player-results::-webkit-scrollbar, .playerCardList::-webkit-scrollbar {
            width: 8px;
        }

        .player-results::-webkit-scrollbar-track, .playerCardList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .player-results::-webkit-scrollbar-thumb, .playerCardList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .player-results::-webkit-scrollbar-thumb:hover, .playerCardList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Add casta-based background gradients */
        .player-card.bronze {
            background: linear-gradient(135deg, #cd7f32, #a0522d);
            color: white;
        }

        .player-card.silver {
            background: linear-gradient(135deg, #c0c0c0, #808080);
            color: white;
        }

        .player-card.golden {
            background: linear-gradient(135deg, #ffd700, #daa520);
            color: white;
            /*text-shadow: 0 0 4px black;*/ /* Opcional: Sombra no texto para melhor contraste */
        }


        .player-card.diamond {
            background: linear-gradient(135deg, #b9f2ff, #00bfff);
            color: white;
        }

        .player-card.platina {
            background: linear-gradient(135deg, #e5e4e2, #c0c0c0);
            color: white;
        }

        .player-card {
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            background-color: #f5f5f5;
        }

        .player-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .player-card .player-info {
            width: 100%;
            text-align: center;
        }

        .player-card .player-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 2px;
            display: block;
        }

        .player-card .country-flag {
            width: 20px;
            height: 15px;
            object-fit: contain;
            position: absolute;
            top: 8px;
            right: 8px;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            z-index: 2;
        }

        .player-card .player-position {
            font-size: 0.8em;
            color: white;
            display: block;
            text-align: center;
        }

        .player-card .competition-logo {
            width: 20px;
            height: 15px;
            object-fit: contain;
            position: absolute;
            top: 28px;
            right: 8px;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            z-index: 2;
        }


        .formation-options {
            padding: 10px;
        }

        .formation-controls {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
        }

        button#saveFormationBtn, button#chooseBtn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#saveFormationBtn {
            background-color: #4CAF50;
        }

        button#saveFormationBtn:hover {
            background-color: #45a049;
        }

        button#chooseBtn {
            background-color: #FFB700;
        }

        button#chooseBtn:hover {
            background-color: #DAA520;
        }

        .formation-select-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .formation-options select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .search-container {
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .search-container input[type="text"] {
            padding: 8px;
            width: 40%;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .filter-dropdowns {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .filter-dropdowns select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button#saveFormationBtn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50; /* Green background */
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#saveFormationBtn:hover {
            background-color: #45a049; /* Darker green on hover */
        }

        @media (max-width: 767px) {
    .content {
        padding: 10px; /* Reduz o padding geral da página */
    }

    .team-section {
        flex-direction: column; /* Força o empilhamento vertical do relvado e da lista de jogadores */
        align-items: center; /* Centra os blocos na página */
    }

    .pitch-side, .player-selection-side {
        width: 100%; /* Faz com que cada secção ocupe a largura total */
        min-width: unset; /* Remove a largura mínima que causa problemas */
    }

    .player-selection-side {
        margin-top: 20px; /* Adiciona espaço entre o relvado e a secção de pesquisa */
    }

    .formation-controls {
        flex-direction: column; /* Empilha os controlos de formação */
        gap: 10px;
        align-items: stretch; /* Faz os botões esticarem */
    }

    .formation-select-container {
        justify-content: space-between;
    }

    .search-container {
        flex-direction: column; /* Empilha a barra de pesquisa e os filtros */
        gap: 10px;
    }

    .filter-dropdowns {
        flex-direction: column; /* Empilha os filtros de país e clube */
        gap: 10px;
    }

    .search-container input[type="text"], .filter-dropdowns select {
        width: 100%; /* Faz os campos de filtro ocuparem a largura toda */
    }

    .player-results, .playerCardList {
        /* O grid já é responsivo, mas podemos ajustar o tamanho mínimo dos cartões */
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        padding: 10px;
    }
}


    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <h1>Minha Equipa</h1>

        <div class="team-section">
            <div class="pitch-side">
                <div class="formation-options">
                    <div class="formation-controls">
                        <div class="formation-select-container">
                            <label for="formation-select">Formação:</label>
                            <select id="formation-select">
                                <option value="" disabled selected>Selecionar Formação</option>
                            </select>
                        </div>
                        <button id="saveFormationBtn">Guardar</button>
                        <button id="chooseBtn">Escolher</button>
                    </div>
                </div>

                <div class="pitch-container">
                    <div class="pitch-area">
                        <div class="center-circle"></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-side">
                <div class="search-container">
                    <input type="text" id="player-search" placeholder="Pesquisar jogador...">
                    <div class="filter-dropdowns">
                        <select id="country-filter">
                            <option value="">País (Todos)</option>
                        </select>
                        <select id="club-filter">
                            <option value="">Clube (Todos)</option>
                        </select>
                    </div>
                </div>
                <div class="player-results">
                    No data available in table
                </div>
            </div>
        </div>


    </div>



    <!-- Player List Modal -->
    <div id="playerListModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Escolha um Jogador</h3>
            <div id="playerCardList" class="player-results">
                <!-- Player cards will be loaded here by JavaScript -->
                <p>A carregar jogadores...</p>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" id="closePlayerListModal">Fechar</button>
            </div>
        </div>
    </div>

    <nav class="bottom-menu">
        <a href="1x.html" class="menu-item">
            <i class="fas fa-home"></i>
        </a>
        <a href="market.html" class="menu-item">
            <i class="fas fa-shopping-cart"></i>
        </a>
        <a href="team.html" class="menu-item active">
            <i class="fas fa-users"></i>
        </a>
        <a href="empire.html" class="menu-item">
            <i class="fas fa-landmark empire-icon"></i>
        </a>
        <a href="rankings.html" class="menu-item">
            <i class="fas fa-list"></i>
        </a>
        <a href="profile.html" class="menu-item">
            <i class="fas fa-user"></i>
        </a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, limit, setDoc, addDoc, FieldValue, where, serverTimestamp, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    
        const firebaseConfig = {
            apiKey: "AIzaSyD8WcFD7jC55feYYqdY7aJSgxXyXkEjTX0",
            authDomain: "g-games-8a8fc.firebaseapp.com",
            projectId: "g-games-8a8fc",
            storageBucket: "g-games-8a8fc.firebasestorage.app",
            messagingSenderId: "689897349449",
            appId: "1:689897349449:web:536599794579901beb7a98",
            measurementId: "G-GTTPJ6G5MD"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const firebase = {
            firestore: {
                doc: doc,
                getDoc: getDoc,
                collection: collection,
                getDocs: getDocs,
                query: query,
                orderBy: orderBy,
                limit: limit,
                setDoc: setDoc,
                addDoc: addDoc,
                FieldValue: FieldValue,
                where: where,
                serverTimestamp: serverTimestamp,
                writeBatch: writeBatch
            }
        };
    
    
        const loadingScreen = document.getElementById('loading-screen');
        const content = document.querySelector('.content');
        let currentUserStatus = null;
        let currentUserUid = null;
        let userOwnedPlayers = []; // Jogadores que o user *possui* (para a lista)
        let countries = {};
        let clubs = new Set();
        let currentFormation = '';
        let hasUnsavedChanges = false;
        const formationSelect = document.getElementById('formation-select');
        const pitchArea = document.querySelector('.pitch-area');
        const playerResultsContainer = document.querySelector('.player-results');
        const playerSearchInput = document.getElementById('player-search');
        const countryFilterSelect = document.getElementById('country-filter');
        const clubFilterSelect = document.getElementById('club-filter');
        const playerListModal = document.getElementById('playerListModal');
        const closePlayerListModalBtn = document.getElementById('closePlayerListModal');
        const playerCardListContainer = document.getElementById('playerCardList');
    
        // Armazena { positionId: playerId } para a formação atual no relvado
        let assignedPlayers = {};
    
        const formations = {
            '4-4-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '32%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '62%', positionType: 'FWD' } ],
            '4-3-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '60%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '62%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
            '4-5-1': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'DML', top: '50%', left: '47%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '10%', positionType: 'MID' }, { position: 'AMC', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '64%', positionType: 'MID' }, { position: 'DMR', top: '40%', left: '84%', positionType: 'MID' }, { position: 'FW', top: '10%', left: '47%', positionType: 'FWD' } ],
            '3-4-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DC1', top: '75%', left: '20%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC3', top: '75%', left: '77%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
            '5-3-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'SW', top: '75%', left: '10%', positionType: 'DEF' }, { position: 'WBL', top: '75%', left: '30%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '64%', positionType: 'DEF' }, { position: 'WBR', top: '75%', left: '84%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '55%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '64%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '30%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '64%', positionType: 'FWD' } ]
        };
        const posicaoMapping = { "Avançado": "FWD", "Defesa": "DEF", "Médio": "MID", "Guarda-Redes": "GK" };
    
    
        // --- FUNÇÃO AUXILIAR COM LOG ---
        // Função auxiliar para verificar se um jogador já está em alguma posição no relvado
        function isPlayerAlreadyOnPitch(playerId) {
            // Log do estado ANTES da verificação
            console.log(`[Check isPlayerAlreadyOnPitch] Verificando ID: ${playerId}. Estado atual assignedPlayers: ${JSON.stringify(assignedPlayers)}`);
            const isOnPitch = Object.values(assignedPlayers).includes(playerId);
            console.log(`[Check isPlayerAlreadyOnPitch] Resultado para ${playerId}: ${isOnPitch}`);
            return isOnPitch;
        }
    
    
        // --- FUNÇÕES DE DRAG AND DROP COM LOGS ---
    
        function handlePlayerCardDragStart(event) {
            const playerCard = event.currentTarget;
            const playerId = playerCard.dataset.playerId;
            event.dataTransfer.setData('playerId', playerId);
            event.dataTransfer.setData('source', 'list');
            event.dataTransfer.effectAllowed = 'move';
            console.log(`Dragging player ${playerId} from list`);
        }
    
        function handlePositionDragStart(event) {
            const positionElement = event.currentTarget;
            const playerId = positionElement.dataset.assignedPlayerId;
            const positionId = positionElement.dataset.position;
            if (playerId && playerId !== 'null') {
                event.dataTransfer.setData('playerId', playerId);
                event.dataTransfer.setData('originalPositionId', positionId);
                event.dataTransfer.setData('source', 'pitch');
                event.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    const img = positionElement.querySelector('img');
                    if (img) img.style.visibility = 'hidden';
                }, 0);
                console.log(`Dragging player ${playerId} from position ${positionId}`);
            } else {
                event.preventDefault();
            }
        }
    
        function handlePositionDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
    
        // *** handlePositionDrop COM LOGS DETALHADOS ***
        function handlePositionDrop(event) {
            event.preventDefault();
            const targetPositionElement = event.currentTarget;
            const targetPositionId = targetPositionElement.dataset.position;
            const targetPositionType = targetPositionElement.dataset.positionType;
            const draggedPlayerId = event.dataTransfer.getData('playerId');
            const source = event.dataTransfer.getData('source');
            const originalPositionId = event.dataTransfer.getData('originalPositionId');
    
            console.log(`--- Drop Event Start ---`);
            console.log(`Player ID: ${draggedPlayerId}, Source: ${source}, Target Pos: ${targetPositionId}, Original Pos: ${originalPositionId}`);
            console.log(`Estado assignedPlayers ANTES do drop: ${JSON.stringify(assignedPlayers)}`);
    
            const draggedPlayer = userOwnedPlayers.find(p => p.id === draggedPlayerId);
            if (!draggedPlayer) {
                console.error("Drop Falhou: Jogador arrastado não encontrado nos dados locais.");
                if (originalPositionId) {
                    const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                    const img = originalPositionElement?.querySelector('img');
                    if(img) img.style.visibility = 'visible';
                }
                console.log(`--- Drop Event End (Erro) ---`);
                return;
            }
    
            // VERIFICAÇÃO PRINCIPAL (arrastar da lista)
            if (source === 'list') {
                if (isPlayerAlreadyOnPitch(draggedPlayerId)) { // Função auxiliar já tem log
                    alert(`${draggedPlayer.nome} já está em campo!`);
                    console.log(`Drop Bloqueado: Jogador ${draggedPlayerId} já existe em assignedPlayers.`);
                    console.log(`--- Drop Event End (Bloqueado) ---`);
                    return;
                }
            }
    
            // Mostra a imagem de volta na posição original (se veio do relvado)
            if (originalPositionId) {
                const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                const img = originalPositionElement?.querySelector('img');
                if(img) img.style.visibility = 'visible';
            }
    
    
            // Validação de Tipo de Posição
            const playerPosicaoIngles = posicaoMapping[draggedPlayer.posicao];
            if (playerPosicaoIngles !== targetPositionType) {
                alert(`Este jogador é ${draggedPlayer.posicao} e só pode ser colocado em posições de ${targetPositionType}`);
                console.log(`Drop Bloqueado: Tipo de posição incompatível.`);
                console.log(`--- Drop Event End (Bloqueado) ---`);
                return;
            }
    
            // --- Lógica de Colocação / Troca ---
            const playerAlreadyInTargetPositionId = targetPositionElement.dataset.assignedPlayerId;
    
            // Caso 1: Drop na mesma posição de origem
            if (originalPositionId === targetPositionId) {
                console.log(`Drop Ignorado: Mesma posição de origem e destino.`);
                console.log(`--- Drop Event End (Ignorado) ---`);
                return; // Não faz nada
            }
    
            // Variável para guardar temporariamente o ID a ser removido (se houver troca/substituição)
            let idToRemoveFromTarget = null;
            if (playerAlreadyInTargetPositionId && playerAlreadyInTargetPositionId !== 'null') {
                idToRemoveFromTarget = playerAlreadyInTargetPositionId;
            }
    
    
            // Passo 1: Remover visualmente e do estado (se necessário)
            // Remove da posição ORIGINAL (se veio do relvado)
            if (originalPositionId) {
                const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                if (originalPositionElement) {
                    console.log(`Removendo ${draggedPlayerId} da posição original ${originalPositionId}`);
                    removePlayerFromPositionDOM(originalPositionElement); // Remove visual e listeners
                    delete assignedPlayers[originalPositionId]; // Remove do estado
                    console.log(`Estado após remover da origem: ${JSON.stringify(assignedPlayers)}`);
                }
            }
            // Remove da posição ALVO (se estava ocupada)
            if (idToRemoveFromTarget) {
                console.log(`Removendo ${idToRemoveFromTarget} da posição alvo ${targetPositionId} (antes de colocar/trocar)`);
                removePlayerFromPositionDOM(targetPositionElement); // Remove visualmente quem estava lá
                // Não remove de assignedPlayers ainda, pois pode ser necessário para a troca
            }
    
    
            // Passo 2: Adicionar/Trocar
            // Caso 2a: Substituir (veio da lista, alvo ocupado)
            if (source === 'list' && idToRemoveFromTarget) {
                console.log(`Substituindo ${idToRemoveFromTarget} por ${draggedPlayerId} (da lista) em ${targetPositionId}`);
                addPlayerToPositionDOM(targetPositionElement, draggedPlayer);
                assignedPlayers[targetPositionId] = draggedPlayerId; // Sobrescreve no estado
                console.log(`Estado após substituir: ${JSON.stringify(assignedPlayers)}`);
                hasUnsavedChanges = true;
            }
            // Caso 2b: Trocar (veio do relvado, alvo ocupado)
            else if (source === 'pitch' && originalPositionId && idToRemoveFromTarget) {
                console.log(`Trocando ${draggedPlayerId} (origem ${originalPositionId}) com ${idToRemoveFromTarget} (alvo ${targetPositionId})`);
                const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                const playerOriginallyInTarget = userOwnedPlayers.find(p => p.id === idToRemoveFromTarget); // Usa o ID guardado
    
                if (originalPositionElement && playerOriginallyInTarget) {
                    // Coloca o jogador que estava no alvo na posição original
                    console.log(`Colocando ${idToRemoveFromTarget} na posição original ${originalPositionId}`);
                    addPlayerToPositionDOM(originalPositionElement, playerOriginallyInTarget);
                    assignedPlayers[originalPositionId] = idToRemoveFromTarget; // Atualiza estado da origem
                    console.log(`Estado após colocar alvo na origem: ${JSON.stringify(assignedPlayers)}`);
    
                    // Coloca o jogador arrastado na posição de destino
                    console.log(`Colocando ${draggedPlayerId} na posição alvo ${targetPositionId}`);
                    addPlayerToPositionDOM(targetPositionElement, draggedPlayer);
                    assignedPlayers[targetPositionId] = draggedPlayerId; // Atualiza estado do alvo
                    console.log(`Estado após colocar arrastado no alvo: ${JSON.stringify(assignedPlayers)}`);
                    hasUnsavedChanges = true;
                } else {
                    console.error("Falha na Troca: Elemento original ou dados do jogador alvo não encontrados.");
                    // Tentar reverter (pode ser complexo) - no mínimo, logar o erro.
                    // Colocar o jogador arrastado de volta na origem se possível
                    if (originalPositionId && originalPositionElement) {
                        console.log("Revertendo: Colocando jogador arrastado de volta na origem.");
                        addPlayerToPositionDOM(originalPositionElement, draggedPlayer);
                        assignedPlayers[originalPositionId] = draggedPlayerId;
                        console.log(`Estado após reverter: ${JSON.stringify(assignedPlayers)}`);
                    }
                }
            }
            // Caso 3: Colocar em posição vazia (veio da lista ou relvado)
            else if (!idToRemoveFromTarget) {
                console.log(`Colocando ${draggedPlayerId} na posição vazia ${targetPositionId}`);
                addPlayerToPositionDOM(targetPositionElement, draggedPlayer);
                assignedPlayers[targetPositionId] = draggedPlayerId; // Adiciona ao estado
                console.log(`Estado após colocar em vazio: ${JSON.stringify(assignedPlayers)}`);
                // Se veio do relvado, marca a posição original como vazia permanentemente no DOM
                if (originalPositionId) {
                    const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                    // Só adiciona '+' se estiver realmente vazia e não for a posição alvo (evita duplo '+')
                    if(originalPositionElement && !originalPositionElement.querySelector('img') && originalPositionElement !== targetPositionElement) {
                        originalPositionElement.innerHTML = '+';
                    }
                }
                hasUnsavedChanges = true;
            }
    
            console.log(`--- Drop Event End ---`);
        }
    
        function handlePositionDragEnd(event) {
            // Garante que a imagem original (se escondida) volta a ser visível
            // É importante fazer isso mesmo se o drop não foi bem sucedido
            const positionElement = event.currentTarget; // O elemento de onde o drag começou
            const img = positionElement?.querySelector('img'); // Usa optional chaining
            if (img) {
                img.style.visibility = 'visible';
            }
            console.log("Drag ended for position:", positionElement?.dataset?.position); // Log mais seguro
        }
    
    
        // --- FUNÇÕES AUXILIARES PARA MANIPULAÇÃO DO DOM E ESTADO ---
    
        function addPlayerToPositionDOM(positionElement, player) {
            if (!positionElement || !player) return;
            positionElement.innerHTML = '';
            const playerImg = document.createElement('img');
            playerImg.src = player.imagem || 'placeholder_image_url.png';
            playerImg.alt = player.nome;
            playerImg.style.visibility = 'visible';
            positionElement.appendChild(playerImg);
            positionElement.dataset.assignedPlayerId = player.id;
            positionElement.draggable = true;
            positionElement.addEventListener('dragstart', handlePositionDragStart);
            positionElement.addEventListener('dragend', handlePositionDragEnd);
        }
    
        function removePlayerFromPositionDOM(positionElement) {
            if (!positionElement) return;
            positionElement.innerHTML = '';
            positionElement.dataset.assignedPlayerId = null;
            positionElement.draggable = false;
            positionElement.removeEventListener('dragstart', handlePositionDragStart);
            positionElement.removeEventListener('dragend', handlePositionDragEnd);
        }
    
        // *** handlePositionClick COM LOGS DETALHADOS ***
        function handlePositionClick(event) {
            const positionElement = event.currentTarget;
            const assignedPlayerId = positionElement.dataset.assignedPlayerId;
            const positionId = positionElement.dataset.position;
    
            console.log(`--- Click Event Start ---`);
            console.log(`Click na posição ${positionId}. Jogador atribuído (DOM): ${assignedPlayerId}.`);
            console.log(`Estado assignedPlayers ANTES do click: ${JSON.stringify(assignedPlayers)}`);
    
    
            if (assignedPlayerId && assignedPlayerId !== "null") {
                console.log(`Removendo ${assignedPlayerId} de ${positionId} via click.`);
                removePlayerFromPositionDOM(positionElement); // Limpa DOM/listeners
                positionElement.innerHTML = '+'; // Adiciona '+'
                delete assignedPlayers[positionId]; // ATUALIZA ESTADO
                console.log(`Estado assignedPlayers APÓS remover por click: ${JSON.stringify(assignedPlayers)}`);
                hasUnsavedChanges = true;
            } else {
                console.log(`Posição ${positionId} vazia. Abrindo modal.`);
                showPlayerListModal(positionElement.dataset.positionType, positionElement); // Função com logs
            }
            console.log(`--- Click Event End ---`);
        }
    
    
        // --- Funções de Inicialização, Fetch, Renderização (maioria inalterada) ---
    
        async function saveFormation() {
            if (!currentUserUid) { console.log("Utilizador não autenticado."); return; }
            try {
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                let latestSeason = '';
                if (!palpitesSnapshot.empty) { latestSeason = palpitesSnapshot.docs[0].data().temporada; }
                else { console.error('No seasons found.'); alert("Erro: Temporada não encontrada."); return; }
    
                if (!currentFormation) { alert("Por favor, selecione uma formação."); return; }
    
                const planteisRef = collection(db, 'planteis');
                const planteisQuery = query( planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason) );
                const planteisSnapshot = await getDocs(planteisQuery);
    
                const plantelData = { userId: currentUserUid, formacao: currentFormation, temporada: latestSeason, estado: 'desativo', dataDeEdicao: serverTimestamp() };
                const formationPositions = formations[currentFormation]?.map(p => p.position) || [];
                formationPositions.forEach(posId => { plantelData[posId] = assignedPlayers[posId] || null; });
    
                if (!planteisSnapshot.empty) {
                    const docRef = planteisSnapshot.docs[0].ref;
                    const currentData = planteisSnapshot.docs[0].data();
                    plantelData.estado = currentData.estado || 'desativo'; // Mantem estado
                    await updateDoc(docRef, plantelData);
                    console.log("Formação atualizada!");
                } else {
                    await addDoc(planteisRef, plantelData);
                    console.log("Nova formação guardada!");
                }
                hasUnsavedChanges = false;
                // Feedback visual
                const saveBtn = document.getElementById('saveFormationBtn');
                const confirmIcon = document.createElement('i');
                confirmIcon.classList.add('fas', 'fa-check'); confirmIcon.style.color = '#4CAF50'; confirmIcon.style.marginLeft = '10px';
                saveBtn.parentNode.insertBefore(confirmIcon, saveBtn.nextSibling);
                setTimeout(() => confirmIcon.remove(), 3000);
            } catch (error) { console.error("Erro ao guardar formação:", error); alert("Erro ao guardar formação."); }
        }
    
    
        function renderFormation(formationName) {
            assignedPlayers = {};
            pitchArea.innerHTML = '<div class="center-circle"></div>';
            if (!formationName || !formations[formationName]) {
                console.warn(`Formação "${formationName}" inválida.`);
                return;
            }
            currentFormation = formationName;
            const currentFormationPositions = formations[formationName];
            currentFormationPositions.forEach(pos => {
                const positionElement = document.createElement('div');
                positionElement.classList.add('position');
                positionElement.dataset.position = pos.position;
                positionElement.style.top = pos.top;
                positionElement.style.left = pos.left;
                positionElement.dataset.positionType = pos.positionType;
                positionElement.innerHTML = '+';
                positionElement.draggable = false;
                positionElement.dataset.assignedPlayerId = null;
                positionElement.addEventListener('dragover', handlePositionDragOver);
                positionElement.addEventListener('drop', handlePositionDrop);
                positionElement.addEventListener('click', handlePositionClick);
                pitchArea.appendChild(positionElement);
            });
            console.log(`Rendered empty formation: ${formationName}`);
        }
    
    
        function showPlayerListModal(positionType, positionElement) {
            playerListModal.classList.add('active');
            playerCardListContainer.innerHTML = '<p>A carregar jogadores...</p>';
            populatePlayerCardList(positionType, positionElement); // Função com logs
        }
    
        // *** populatePlayerCardList COM LOGS DETALHADOS ***
        async function populatePlayerCardList(positionType, positionElement) {
            try {
                const positionTypePortugues = Object.keys(posicaoMapping).find(key => posicaoMapping[key] === positionType);
    
                console.log(`--- Modal Populate Start ---`);
                console.log(`Filtrando jogadores para ${positionType} (${positionTypePortugues}).`);
                console.log(`Estado assignedPlayers ANTES de filtrar modal: ${JSON.stringify(assignedPlayers)}`);
    
                const filteredByPosition = userOwnedPlayers.filter(player =>
                    player.posicao === positionTypePortugues
                );
    
                const assignedIds = Object.values(assignedPlayers).filter(id => id !== null);
                console.log(`IDs atualmente no relvado: [${assignedIds.join(', ')}]`);
    
                const availablePlayers = filteredByPosition.filter(player => {
                    const alreadyAssigned = assignedIds.includes(player.id);
                    if (alreadyAssigned) {
                        console.log(`Excluindo do modal: ${player.id} (${player.nome}) - Já está no relvado.`);
                    }
                    return !alreadyAssigned;
                });
    
                playerCardListContainer.innerHTML = '';
    
                if (availablePlayers.length === 0) {
                    playerCardListContainer.innerHTML = '<p>Sem jogadores disponíveis para esta posição (ou já estão em campo).</p>';
                    console.log(`Nenhum jogador disponível encontrado para o modal.`);
                } else {
                    console.log(`Jogadores disponíveis para o modal (${availablePlayers.length}): ${availablePlayers.map(p=>p.id).join(', ')}`);
                    availablePlayers.forEach(player => {
                        const playerCard = createPlayerCardElement(player, false);
                        const addButton = document.createElement('button');
                        addButton.textContent = 'ADICIONAR';
                        addButton.classList.add('btn-confirm', 'add-player-btn');
                        addButton.style.marginTop = '5px';
                        addButton.onclick = () => {
                            assignPlayerToPosition(player, positionElement); // Função com logs
                            playerListModal.classList.remove('active');
                        };
                        playerCard.appendChild(addButton);
                        playerCardListContainer.appendChild(playerCard);
                    });
                }
                console.log(`--- Modal Populate End ---`);
    
            } catch (error) {
                console.error("Erro ao popular lista de jogadores no modal:", error);
                playerCardListContainer.innerHTML = '<p>Erro ao carregar jogadores.</p>';
                console.log(`--- Modal Populate End (Erro) ---`);
            }
        }
    
        // *** assignPlayerToPosition COM LOGS DETALHADOS ***
        function assignPlayerToPosition(player, positionElement) {
            const positionId = positionElement.dataset.position;
            console.log(`--- Modal Add Start ---`);
            console.log(`Tentando adicionar ${player.nome} (ID: ${player.id}) à posição ${positionId}.`);
            console.log(`Estado assignedPlayers ANTES da adição modal: ${JSON.stringify(assignedPlayers)}`);
    
    
            // VERIFICAÇÃO PRINCIPAL
            if (isPlayerAlreadyOnPitch(player.id)) { // Função auxiliar já tem log
                alert(`${player.nome} já está em campo noutra posição!`);
                console.log(`Adição Modal Bloqueada: Jogador ${player.id} já existe em assignedPlayers.`);
                console.log(`--- Modal Add End (Bloqueado) ---`);
                return;
            }
    
            // Verifica se a posição foi ocupada enquanto o modal estava aberto
            if (positionElement.dataset.assignedPlayerId && positionElement.dataset.assignedPlayerId !== 'null') {
                alert("Esta posição já foi ocupada enquanto escolhia. Tente novamente.");
                console.log(`Adição Modal Bloqueada: Posição ${positionId} ocupada (race condition?).`);
                console.log(`--- Modal Add End (Bloqueado) ---`);
                return;
            }
    
            console.log(`Adicionando ${player.id} a ${positionId} via modal.`);
            removePlayerFromPositionDOM(positionElement); // Limpa DOM
            addPlayerToPositionDOM(positionElement, player); // Adiciona DOM
            assignedPlayers[positionId] = player.id; // ATUALIZA ESTADO
            console.log(`Estado assignedPlayers APÓS adição modal: ${JSON.stringify(assignedPlayers)}`);
            hasUnsavedChanges = true;
            console.log(`--- Modal Add End ---`);
        }
    
    
        closePlayerListModalBtn.addEventListener('click', () => {
            playerListModal.classList.remove('active');
        });
    
        function showConfirmationModal(message, confirmCallback, cancelCallback) {
            const existingModal = document.querySelector('.confirmation-modal-overlay');
            if (existingModal) document.body.removeChild(existingModal);
            console.log("showConfirmationModal function called");
            const modalOverlay = document.createElement('div');
            modalOverlay.classList.add('modal-overlay', 'confirmation-modal-overlay');
            const modalContent = document.createElement('div');
            modalContent.classList.add('modal-content');
            const messageElement = document.createElement('p');
            messageElement.textContent = message;
            modalContent.appendChild(messageElement);
            const buttonsContainer = document.createElement('div');
            buttonsContainer.classList.add('modal-buttons');
            const confirmButton = document.createElement('button');
            confirmButton.classList.add('btn-confirm'); confirmButton.textContent = 'Sim';
            confirmButton.onclick = () => { document.body.removeChild(modalOverlay); if (confirmCallback) confirmCallback(); };
            const cancelButton = document.createElement('button');
            cancelButton.classList.add('btn-cancel'); cancelButton.textContent = 'Não';
            cancelButton.onclick = () => { document.body.removeChild(modalOverlay); if (cancelCallback) cancelCallback(); };
            buttonsContainer.appendChild(confirmButton); buttonsContainer.appendChild(cancelButton);
            modalContent.appendChild(buttonsContainer);
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            modalOverlay.classList.add('active');
            console.log("Confirmation modal displayed");
        }
    
        async function fetchUserOwnedPlayers() {
            if (!currentUserUid) return;
            const playersRef = collection(db, 'jogadores');
            const q = query(playersRef, where('compradopor', '==', currentUserUid));
            const querySnapshot = await getDocs(q);
            const fetchedUserPlayers = [];
            const uniqueClubs = new Set();
            const uniqueCountryIds = new Set();
            querySnapshot.forEach((doc) => {
                const playerData = doc.data();
                fetchedUserPlayers.push({ ...playerData, id: doc.id });
                if (playerData.clube) uniqueClubs.add(playerData.clube);
                if (playerData.paisId) uniqueCountryIds.add(playerData.paisId);
            });
            userOwnedPlayers = fetchedUserPlayers;
            clubs = uniqueClubs;
            console.log(`Fetched ${userOwnedPlayers.length} players owned by user ${currentUserUid}`);
            populateClubFilter();
            renderPlayerResults(userOwnedPlayers);
        }
    
    
        async function fetchCountries() {
            const countriesRef = collection(db, 'paises');
            const countriesSnap = await getDocs(countriesRef);
            countries = {}; // Reset before fetching
            countriesSnap.forEach(doc => { countries[doc.id] = doc.data(); });
            populateCountryFilter();
        }
    
    
        function populateCountryFilter() {
            countryFilterSelect.innerHTML = '<option value="">País (Todos)</option>';
            const sortedCountries = Object.entries(countries).sort(([, a], [, b]) => a.nome.localeCompare(b.nome));
            sortedCountries.forEach(([countryId, countryData]) => {
                const option = document.createElement('option');
                option.value = countryId; option.textContent = countryData.nome;
                countryFilterSelect.appendChild(option);
            });
        }
    
    
        function populateClubFilter() {
            clubFilterSelect.innerHTML = '<option value="">Clube (Todos)</option>';
            const sortedClubs = [...clubs].sort((a, b) => a.localeCompare(b));
            sortedClubs.forEach(clubName => {
                const option = document.createElement('option');
                option.value = clubName; option.textContent = clubName;
                clubFilterSelect.appendChild(option);
            });
        }
    
        function createPlayerCardElement(player, isDraggable) {
            const playerCard = document.createElement('div');
            playerCard.classList.add('player-card');
            playerCard.dataset.playerId = player.id;
            if (isDraggable) {
                playerCard.draggable = true;
                playerCard.addEventListener('dragstart', handlePlayerCardDragStart);
            }
            const castaMap = { 'Jogador Ouro': 'golden', 'Jogador Prata': 'silver', 'Jogador Bronze': 'bronze', 'Jogador Platina': 'platina', 'Jogador Diamante': 'diamond' };
            const castaClass = castaMap[player.casta];
            if (castaClass) playerCard.classList.add(castaClass);
    
            if (player.paisId && countries[player.paisId]) {
                const flagImg = document.createElement('img');
                flagImg.src = countries[player.paisId].imagem || 'placeholder_flag_url.png';
                flagImg.alt = countries[player.paisId].nome;
                flagImg.classList.add('country-flag');
                playerCard.appendChild(flagImg);
            }
            const img = document.createElement('img');
            img.src = player.imagem || 'placeholder_image_url.png'; img.alt = player.nome;
            playerCard.appendChild(img);
            const playerInfo = document.createElement('div'); playerInfo.classList.add('player-info');
            const playerName = document.createElement('span'); playerName.classList.add('player-name'); playerName.textContent = player.nome; playerInfo.appendChild(playerName);
            const playerPosition = document.createElement('span'); playerPosition.classList.add('player-position'); playerPosition.textContent = player.posicao; playerInfo.appendChild(playerPosition);
            playerCard.appendChild(playerInfo);
    
            if (player.clube) {
                fetchCompetitionLogo(player.clube).then(logoData => {
                    if (logoData) {
                        const competicaoLogo = document.createElement('img');
                        competicaoLogo.src = logoData.imagem; competicaoLogo.alt = logoData.nome;
                        competicaoLogo.classList.add('competition-logo');
                        playerInfo.appendChild(competicaoLogo);
                    }
                });
            }
            return playerCard;
        }
    
        async function fetchCompetitionLogo(clubName) {
            try {
                const clubesRef = collection(db, 'clubes');
                const clubQuery = query(clubesRef, where('nome', '==', clubName), limit(1));
                const clubSnapshot = await getDocs(clubQuery);
                if (!clubSnapshot.empty) {
                    const clubData = clubSnapshot.docs[0].data();
                    if (clubData.competicaoId) {
                        const competicaoRef = doc(db, 'competicoes', clubData.competicaoId);
                        const competicaoDoc = await getDoc(competicaoRef);
                        if (competicaoDoc.exists()) return competicaoDoc.data();
                    }
                } return null;
            } catch (error) { console.error(`Erro logo ${clubName}:`, error); return null; }
        }
    
        function renderPlayerResults(playersToRender) {
            playerResultsContainer.innerHTML = '';
            if (playersToRender.length === 0) { playerResultsContainer.innerHTML = '<p>Nenhum jogador encontrado.</p>'; return; }
            const positionOrder = { 'Guarda-Redes': 1, 'Defesa': 2, 'Médio': 3, 'Avançado': 4 };
            playersToRender.sort((a, b) => {
                const posA = positionOrder[a.posicao] || 99; const posB = positionOrder[b.posicao] || 99;
                if (posA !== posB) return posA - posB;
                return a.nome.localeCompare(b.nome);
            });
            playersToRender.forEach(player => {
                const playerCardElement = createPlayerCardElement(player, true);
                playerResultsContainer.appendChild(playerCardElement);
            });
        }
    
    
        function filterPlayers() {
            const searchTerm = playerSearchInput.value.toLowerCase();
            const selectedCountryId = countryFilterSelect.value;
            const selectedClub = clubFilterSelect.value;
            const filtered = userOwnedPlayers.filter(player => {
                const nameMatch = player.nome.toLowerCase().includes(searchTerm);
                const countryMatch = !selectedCountryId || player.paisId === selectedCountryId;
                const clubMatch = !selectedClub || player.clube === selectedClub;
                return nameMatch && countryMatch && clubMatch;
            });
            renderPlayerResults(filtered);
        }
    
    
        playerSearchInput.addEventListener('input', filterPlayers);
        countryFilterSelect.addEventListener('change', filterPlayers);
        clubFilterSelect.addEventListener('change', filterPlayers);
    
        const saveFormationButton = document.getElementById('saveFormationBtn');
        saveFormationButton.addEventListener('click', saveFormation);
    
        const chooseBtn = document.getElementById('chooseBtn');
        chooseBtn.addEventListener('click', async () => {
            if (!currentUserUid) return;
            if (!currentFormation) { alert("Selecione uma formação."); return; }
            if (hasUnsavedChanges) { alert("Guarde as alterações antes de escolher."); return; }
            try {
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                if (palpitesSnapshot.empty) throw new Error('Temporada não encontrada.');
                const latestSeason = palpitesSnapshot.docs[0].data().temporada;
    
                const planteisRef = collection(db, 'planteis');
                const currentFormationQuery = query( planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason), limit(1) );
                const currentFormationSnap = await getDocs(currentFormationQuery);
                if (currentFormationSnap.empty) { alert(`A formação ${currentFormation} não está guardada. Guarde-a primeiro.`); return; }
                const currentFormationDocRef = currentFormationSnap.docs[0].ref;
    
                const allPlanteisQuery = query( planteisRef, where('userId', '==', currentUserUid), where('temporada', '==', latestSeason) );
                const allPlanteisSnapshot = await getDocs(allPlanteisQuery);
                const batch = writeBatch(db);
                allPlanteisSnapshot.forEach(doc => { batch.update(doc.ref, { estado: 'desativo' }); });
                batch.update(currentFormationDocRef, { estado: 'ativo' }); // Ativa a selecionada
                await batch.commit();
    
                // Feedback visual
                const confirmIcon = document.createElement('i');
                confirmIcon.classList.add('fas', 'fa-check'); confirmIcon.style.color = '#4CAF50'; confirmIcon.style.marginLeft = '10px';
                chooseBtn.parentNode.insertBefore(confirmIcon, chooseBtn.nextSibling);
                setTimeout(() => confirmIcon.remove(), 2000);
                console.log(`Formação ${currentFormation} definida como ativa.`);
            } catch (error) { console.error('Erro ao definir formação ativa:', error); alert('Erro: ' + error.message); }
        });
    
    
        async function getUserStatus(userId) {
            const userDoc = doc(db, 'users', userId);
            const docSnap = await getDoc(userDoc);
            if (docSnap.exists() && docSnap.data().aceite === "Yes") { return docSnap.data().estatuto; }
            else { return null; }
        }
    
        async function fetchFormationsFromFirestore() {
            if (!currentUserUid) return [];
            try {
                const userDocRef = doc(db, 'users', currentUserUid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const táticaString = userData.tática;
                    if (táticaString) { return táticaString.split(' ').filter(name => name.trim() !== '').map(name => ({ value: name, label: name })); }
                }
                console.log("Campo 'tática' vazio ou user não encontrado."); return [];
            } catch (error) { console.error("Erro ao buscar formações:", error); return []; }
        }
    
        async function fetchActiveFormationFromPlanteis() {
            if (!currentUserUid) return null;
            try {
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                if (palpitesSnapshot.empty) { console.warn("Temporada não encontrada."); return null; }
                const latestSeason = palpitesSnapshot.docs[0].data().temporada;
    
                const planteisRef = collection(db, 'planteis');
                const activePlanteisQuery = query( planteisRef, where('userId', '==', currentUserUid), where('estado', '==', 'ativo'), where('temporada', '==', latestSeason), limit(1) );
                const activePlanteisSnapshot = await getDocs(activePlanteisQuery);
                if (!activePlanteisSnapshot.empty) { return activePlanteisSnapshot.docs[0].data().formacao; }
                return null;
            } catch (error) { console.error("Erro ao buscar formação ativa:", error); return null; }
        }
    
    
        async function populateFormationDropdownFromFirestore() {
            const formationsFromUser = await fetchFormationsFromFirestore();
            formationSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = ""; defaultOption.disabled = true; defaultOption.selected = true;
            defaultOption.textContent = "Selecionar Formação";
            formationSelect.appendChild(defaultOption);
            if (formationsFromUser.length > 0) {
                formationsFromUser.forEach(formation => {
                    const option = document.createElement('option');
                    option.value = formation.value; option.textContent = formation.label;
                    formationSelect.appendChild(option);
                });
            } else { console.warn("Nenhuma formação encontrada para o utilizador."); }
        }
    
    
        async function loadFormation() {
            if (!currentUserUid || !currentFormation) {
                console.log("Utilizador ou formação atual não definidos. Não carrega.");
                renderFormation(null); // Renderiza campo vazio se não há formação selecionada
                return;
            }
            console.log(`Tentando carregar ${currentFormation} para user ${currentUserUid}`);
            // Limpa campo antes de carregar
            pitchArea.querySelectorAll('.position').forEach(pos => { removePlayerFromPositionDOM(pos); pos.innerHTML = '+'; });
            assignedPlayers = {};
    
            try {
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                if (palpitesSnapshot.empty) throw new Error("Temporada não encontrada.");
                const latestSeason = palpitesSnapshot.docs[0].data().temporada;
    
                const planteisRef = collection(db, 'planteis');
                const q = query( planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason), limit(1) );
                const querySnapshot = await getDocs(q);
    
                if (!querySnapshot.empty) {
                    const plantelData = querySnapshot.docs[0].data();
                    console.log("Plantel encontrado:", plantelData);
                    const currentFormationPositions = formations[currentFormation];
                    if (!currentFormationPositions) { console.error(`Definições para ${currentFormation} não encontradas.`); return; }
    
                    let playersFoundCount = 0;
                    currentFormationPositions.forEach(posInfo => {
                        const positionId = posInfo.position;
                        const playerId = plantelData[positionId];
                        if (playerId) {
                            const positionElement = pitchArea.querySelector(`.position[data-position="${positionId}"]`);
                            const player = userOwnedPlayers.find(p => p.id === playerId);
                            if (positionElement && player) {
                                addPlayerToPositionDOM(positionElement, player);
                                assignedPlayers[positionId] = playerId;
                                playersFoundCount++;
                            } else { console.warn(`Jogador ${playerId} ou elemento ${positionId} não encontrado ao carregar.`); }
                        }
                    });
                    console.log(`Formação ${currentFormation} carregada com ${playersFoundCount} jogadores.`);
                    hasUnsavedChanges = false;
                } else {
                    console.log(`Nenhuma formação ${currentFormation} guardada encontrada para ${latestSeason}.`);
                    hasUnsavedChanges = false;
                }
            } catch (error) { console.error("Erro ao carregar formação:", error); }
        }
    
        // --- Event Listener para mudança de Formação ---
        formationSelect.addEventListener('change', async (e) => {
            const newFormation = e.target.value;
            if (!newFormation) return;
            console.log(`Formation changed to: ${newFormation}. Unsaved changes: ${hasUnsavedChanges}`);
    
            if (hasUnsavedChanges) {
                showConfirmationModal(
                    'Existem alterações não guardadas. Quer guardá-las antes de mudar?',
                    async () => { // Sim (Guardar)
                        await saveFormation(); // Guarda a anterior
                        currentFormation = newFormation;
                        renderFormation(currentFormation); // Renderiza nova vazia
                        await loadFormation(); // Carrega dados da nova
                    },
                    async () => { // Não (Descartar)
                        hasUnsavedChanges = false;
                        currentFormation = newFormation;
                        renderFormation(currentFormation); // Renderiza nova vazia
                        await loadFormation(); // Carrega dados da nova
                    }
                );
            } else {
                currentFormation = newFormation;
                renderFormation(currentFormation); // Renderiza nova vazia
                await loadFormation(); // Carrega dados da nova
            }
        });
    
    
        // --- Inicialização e Autenticação ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                currentUserStatus = await getUserStatus(user.uid);
                if (currentUserStatus !== null) {
                    console.log(`User ${currentUserUid} logged in with status: ${currentUserStatus}`);
                    loadingScreen.style.display = 'flex'; // Mostrar loading antes de carregar dados
    
                    try {
                        await fetchCountries();
                        await populateFormationDropdownFromFirestore();
                        await fetchUserOwnedPlayers(); // Carrega jogadores DEPOIS de países e formações
    
                        const activeFormation = await fetchActiveFormationFromPlanteis();
                        // Não precisa buscar de novo `formationOptions`, já foi usado em populate
    
                        let initialFormationToLoad = null;
                        if (activeFormation && formationSelect.querySelector(`option[value="${activeFormation}"]`)) {
                            initialFormationToLoad = activeFormation;
                            formationSelect.value = activeFormation;
                        } else if (formationSelect.options.length > 1) { // Se há opções além do placeholder
                            initialFormationToLoad = formationSelect.options[1].value;
                            formationSelect.value = initialFormationToLoad;
                        } else {
                            console.log("Nenhuma formação ativa ou definida encontrada.");
                        }
    
                        currentFormation = initialFormationToLoad;
                        renderFormation(currentFormation); // Renderiza estrutura
    
                        if (currentFormation) {
                            await loadFormation(); // Carrega dados se houver formação inicial
                        }
                     } catch(error) {
                          console.error("Erro durante a inicialização:", error);
                          // Poderia mostrar uma mensagem de erro mais amigável aqui
                     } finally {
                          loadingScreen.style.display = 'none'; // Esconder loading após tudo
                          content.style.display = 'block';
                     }
    
                } else {
                    console.log('User is not accepted.');
                    loadingScreen.style.display = 'none';
                    window.location.href = '404.html';
                }
            } else {
                console.log('No user is logged in.');
                loadingScreen.style.display = 'none';
                window.location.href = 'index.html';
            }
        });
    
    
        // --- Prevenção de Perda de Dados ---
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                const message = 'Tem alterações não guardadas que serão perdidas.';
                e.preventDefault(); e.returnValue = message; return message;
            }
        });
    
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', async (e) => {
                const destination = item.href;
                // Verifica se tem alterações E se o destino é válido e diferente da página atual
                if (hasUnsavedChanges && destination && !destination.endsWith('#') && destination !== window.location.href) {
                    e.preventDefault();
                    showConfirmationModal(
                        'Tem alterações não guardadas. Quer guardá-las antes de sair?',
                        async () => { await saveFormation(); window.location.href = destination; }, // Sim
                        () => { hasUnsavedChanges = false; window.location.href = destination; } // Não
                    );
                }
            });
        });
    
    </script>
</body>
</html>
