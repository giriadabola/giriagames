<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Equipa - Ggames</title>
        <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEiIbiLnCB/s320/soccer-ball-png.webp">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ... (Seu CSS original) ... */
        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
        }

        .menu-item:hover, .menu-item.active {
            color: #333;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #2176ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(33, 118, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover {
            color: #0056d6;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(33, 118, 255, 0.6));
        }

         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }



        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex; /* Show when active class is added */
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-confirm {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .btn-confirm:hover {
            background-color: #45a049;
        }

        .btn-cancel:hover {
            background-color: #d32f2f;
        }

        .btn-confirm.add-player-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-confirm.add-player-btn:hover {
            background: linear-gradient(135deg, #45a049, #357a38);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-confirm.add-player-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }



        .content {
            padding: 20px;
            margin-bottom: 80px; /* Reduced margin-bottom to accommodate bottom menu */
            display: none; /* Hide content initially */
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .loading-spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .team-section {
            display: flex;
            gap: 20px;
            padding: 20px;
            flex-direction: column;
            align-items: flex-start;
        }

        @media (min-width: 768px) {
            .team-section {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .pitch-side, .player-selection-side {
            flex: 1;
            min-width: 300px;
        }

        .player-selection-side {
            margin-top: 45px; /* Aligns with the top of pitch-area */
        }

        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 0;
            padding-bottom: 75%;
            background-color: #2d6a4f;
            border: 1px solid #228B22;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .pitch-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 96%;
            height: 94%;
            border: 1px solid white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }


        .pitch-area::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
            background-color: white;
            z-index: 0; /* Optionally add this to ensure line is behind, although default is 0 */
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 1px solid white;
            border-radius: 50%;
        }

      .position {
    position: absolute;
    width: 30px; /* Tamanho original do círculo invisível */
    height: 30px; /* Tamanho original do círculo invisível */
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    font-size: 20px;
    color: white;
    transition: background-color 0.3s ease;
    border: none;
}

        .position:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

.position img:not(.player-style-icon) {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Centraliza a imagem */
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    z-index: 1; /* Camada 1: Fica por cima do círculo base */
}


        .formation-options {
            margin-bottom: 10px;
        }

        .formation-options label {
            margin-right: 10px;
            font-weight: bold;
        }

        .player-search-section {
        }

        .player-search-bar {
        }

        .player-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .player-results, .playerCardList {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            width: 100%;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }
        
        .position-group-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }

        .position-group-title:first-child {
            margin-top: 0;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }
        

        .player-results::-webkit-scrollbar, .playerCardList::-webkit-scrollbar {
            width: 8px;
        }

        .player-results::-webkit-scrollbar-track, .playerCardList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .player-results::-webkit-scrollbar-thumb, .playerCardList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .player-results::-webkit-scrollbar-thumb:hover, .playerCardList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Add casta-based background gradients */
        .player-card.bronze {
            background: linear-gradient(135deg, #cd7f32, #a0522d);
            color: white;
        }

        .player-card.silver {
            background: linear-gradient(135deg, #c0c0c0, #808080);
            color: white;
        }

        .player-card.golden {
            background: linear-gradient(135deg, #ffd700, #daa520);
            color: white;
            /*text-shadow: 0 0 4px black;*/ /* Opcional: Sombra no texto para melhor contraste */
        }


        .player-card.diamond {
            background: linear-gradient(135deg, #b9f2ff, #00bfff);
            color: white;
        }

        .player-card.platina {
            background: linear-gradient(135deg, #e5e4e2, #c0c0c0);
            color: white;
        }

        .player-card {
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            background-color: #f5f5f5;
        }

        .player-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .player-card .player-info {
            width: 100%;
            text-align: center;
        }

        .player-card .player-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 2px;
            display: block;
        }

        .player-card .country-flag {
            width: 20px;
            height: 15px;
            object-fit: contain;
            position: absolute;
            top: 8px;
            right: 8px;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            z-index: 2;
        }

        .player-card .player-position {
            font-size: 0.8em;
            color: white;
            display: block;
            text-align: center;
        }

        .player-card .competition-logo {
            width: 20px;
            height: 15px;
            object-fit: contain;
            position: absolute;
            top: 28px;
            right: 8px;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            z-index: 2;
        }


        .formation-options {
            padding: 10px;
        }

        .formation-controls {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
        }

        button#saveFormationBtn, button#chooseBtn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#saveFormationBtn {
            background-color: #4CAF50;
        }

        button#saveFormationBtn:hover {
            background-color: #45a049;
        }

        button#chooseBtn {
            background-color: #FFB700;
        }

        button#chooseBtn:hover {
            background-color: #DAA520;
        }

        .formation-select-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .formation-options select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .search-container {
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            flex-wrap: wrap; /* Permite que os itens quebrem para a próxima linha */
        }

        .search-container input[type="text"] {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            flex-grow: 1; /* Permite que a barra de pesquisa cresça */
            min-width: 200px; /* Garante que não fique muito pequena */
        }

        .filter-dropdowns {
            display: flex;
            gap: 10px;
            flex-grow: 1; /* Permite que o container de filtros cresça */
            justify-content: space-between;
        }

        .filter-dropdowns select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            flex: 1; /* Faz com que os filtros partilhem o espaço */
        }


        button#saveFormationBtn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50; /* Green background */
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#saveFormationBtn:hover {
            background-color: #45a049; /* Darker green on hover */
        }

        /* --- INÍCIO DA ALTERAÇÃO CSS PARA FILTROS MOBILE --- */
          @media (max-width: 767px) {
            .content {
                padding: 10px;
            }

            .team-section {
                flex-direction: column;
                align-items: center;
            }

            .pitch-side, .player-selection-side {
                width: 100%;
                min-width: unset;
            }

            .player-selection-side {
                margin-top: 20px;
            }

            .formation-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .formation-select-container {
                justify-content: space-between;
            }

            .search-container {
                flex-direction: column; 
                gap: 10px;
            }
            
            .search-container input[type="text"] {
                width: 100%; 
            }

            .filter-dropdowns {
                display: flex; /* Garante que é um flex container */
                flex-wrap: wrap; /* ADICIONADO: Permite que os itens quebrem para a próxima linha */
                flex-direction: row; 
                width: 100%;
                gap: 10px;
            }
            
            .filter-dropdowns select {
                flex: 1; 
                width: auto;
                min-width: 120px; /* ADICIONADO: Garante uma largura mínima antes de quebrar a linha */
            }

            .position-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }
            .player-results, .playerCardList {
                padding: 10px;
            }
        }
        
        .player-card.style-item {
    background: linear-gradient(135deg, #434343 0%, #000000 100%);
    color: #f0f0f0; /* Cor do texto mais clara para contraste */
    border: 1px solid #555; /* Borda sutil */
}

/* Opcional: Adicionar um brilho sutil ao passar o mouse */
.player-card.style-item:hover {
    background: linear-gradient(135deg, #5a5a5a 0%, #1a1a1a 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(255, 255, 255, 0.1);
}

.player-style-icon {
    position: absolute;

    /* --- Posição Final (mais para baixo) --- */
    bottom: -26px;
    right: -16px;

    /* --- Tamanho (inalterado) --- */
    width: 40px;
    height: 40px;

    /* --- Estilo Visual (inalterado) --- */
    border-radius: 50%;
    border: none;
    box-shadow: none;
    background-color: transparent;

    /* --- Comportamento (inalterado) --- */
    z-index: 2;
    cursor: pointer;
}

/* --- ADIÇÃO: Estilo para o card de estilo quando está em uso no campo --- */
.player-card.style-in-use {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none; /* Desativa completamente o card (incluindo o arraste) */
}

.player-card.player-in-use {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none; /* Desativa completamente o card (incluindo o arraste) */
}

        /* --- FIM DA ALTERAÇÃO CSS PARA FILTROS MOBILE --- */
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <h1>Minha Equipa</h1>

        <div class="team-section">
            <div class="pitch-side">
                <div class="formation-options">
                    <div class="formation-controls">
                        <div class="formation-select-container">
                            <label for="formation-select">Formação:</label>
                            <select id="formation-select">
                                <option value="" disabled selected>Selecionar Formação</option>
                            </select>
                        </div>
                        <button id="saveFormationBtn">Guardar</button>
                        <button id="chooseBtn">Escolher</button>
                    </div>
                </div>

                <div class="pitch-container">
                    <div class="pitch-area">
                        <div class="center-circle"></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-side">
                <div class="search-container">
                    <input type="text" id="player-search" placeholder="Pesquisar jogador...">
                    <div class="filter-dropdowns">
                        <select id="country-filter">
                            <option value="">País (Todos)</option>
                        </select>
                        <select id="club-filter">
                            <option value="">Clube (Todos)</option>
                        </select>
                        <select id="position-filter">
                            <option value="">Posição (Todas)</option>
                            <option value="Guarda-Redes">Guarda-Redes</option>
                            <option value="Defesa">Defesa</option>
                            <option value="Médio">Médio</option>
                            <option value="Avançado">Avançado</option>
                        </select>
                    </div>
                </div>
                <div class="player-results">
                    No data available in table
                </div>
            </div>
        </div>
    </div>

    <!-- Player List Modal -->
    <div id="playerListModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Escolha um Jogador</h3>
            <div id="playerCardList" class="player-results">
                <p>A carregar jogadores...</p>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" id="closePlayerListModal">Fechar</button>
            </div>
        </div>
    </div>

    <nav class="bottom-menu">
        <a href="1x.html" class="menu-item">
            <i class="fas fa-home"></i>
        </a>
        <a href="market.html" class="menu-item">
            <i class="fas fa-shopping-cart"></i>
        </a>
        <a href="team.html" class="menu-item active">
            <i class="fas fa-users"></i>
        </a>
        <a href="empire.html" class="menu-item">
            <i class="fas fa-landmark empire-icon"></i>
        </a>
        <a href="rankings.html" class="menu-item">
            <i class="fas fa-list"></i>
        </a>
        <a href="profile.html" class="menu-item">
            <i class="fas fa-user"></i>
        </a>
    </nav>

    <script src="config.js"></script>
    <script type="module">
        // --- O SEU JAVASCRIPT PERMANECE EXATAMENTE O MESMO DA VERSÃO ANTERIOR ---
   import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, limit, setDoc, addDoc, FieldValue, where, serverTimestamp, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// --- Configuração Inicial ---
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- Variáveis Globais ---
let currentUserStatus = null;
let currentUserUid = null;
let userOwnedPlayers = [];
let userOwnedPlayerStyles = [];
let countries = {};
let clubs = new Set();
let currentFormation = '';
let hasUnsavedChanges = false;
let assignedPlayers = {}; // Rastreia { positionId: playerId }
let playerStyleAssignments = {}; // Rastreia { positionId: styleId }

// Mapeamento de Regras para Estilos de Jogador
const styleToPositionMap = {
    "Muralha": "Guarda-Redes", "Guardião": "Guarda-Redes",
    "General": "Defesa", "Estafeta": "Defesa",
    "Arqueiro": "Médio", "Provedor": "Médio",
    "Cometa": "Avançado", "Soldado": "Avançado"
};

const posicaoMapping = { "Avançado": "FWD", "Defesa": "DEF", "Médio": "MID", "Guarda-Redes": "GK" };

// --- Seletores de Elementos DOM ---
const loadingScreen = document.getElementById('loading-screen');
const content = document.querySelector('.content');
const formationSelect = document.getElementById('formation-select');
const pitchArea = document.querySelector('.pitch-area');
const playerResultsContainer = document.querySelector('.player-results');
const playerSearchInput = document.getElementById('player-search');
const countryFilterSelect = document.getElementById('country-filter');
const clubFilterSelect = document.getElementById('club-filter');
const positionFilterSelect = document.getElementById('position-filter');
const playerListModal = document.getElementById('playerListModal');
const closePlayerListModalBtn = document.getElementById('closePlayerListModal');
const playerCardListContainer = document.getElementById('playerCardList');
const saveFormationButton = document.getElementById('saveFormationBtn');
const chooseBtn = document.getElementById('chooseBtn');

const formations = {
    '4-4-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '32%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '62%', positionType: 'FWD' } ],
    '4-3-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '60%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '62%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
    '4-5-1': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'DML', top: '50%', left: '47%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '10%', positionType: 'MID' }, { position: 'AMC', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '64%', positionType: 'MID' }, { position: 'DMR', top: '40%', left: '84%', positionType: 'MID' }, { position: 'FW', top: '10%', left: '47%', positionType: 'FWD' } ],
    '3-4-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DC1', top: '75%', left: '20%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC3', top: '75%', left: '77%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
    '5-3-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'SW', top: '75%', left: '10%', positionType: 'DEF' }, { position: 'WBL', top: '75%', left: '30%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '64%', positionType: 'DEF' }, { position: 'WBR', top: '75%', left: '84%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '55%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '64%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '30%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '64%', positionType: 'FWD' } ]
};

// --- Funções de Arrastar e Largar (Drag and Drop) ---

function handlePlayerCardDragStart(event) {
    const playerCard = event.currentTarget;
    event.dataTransfer.setData('type', 'player');
    event.dataTransfer.setData('playerId', playerCard.dataset.playerId);
    event.dataTransfer.setData('source', 'list');
    event.dataTransfer.effectAllowed = 'move';
}

function handleStyleCardDragStart(event) {
    const styleCard = event.currentTarget;
    const styleId = styleCard.dataset.playerId;
    const styleName = styleCard.querySelector('.player-name').textContent;
    const styleImageSrc = styleCard.querySelector('img').src;

    event.dataTransfer.setData('type', 'style');
    event.dataTransfer.setData('styleId', styleId);
    event.dataTransfer.setData('styleName', styleName);
    event.dataTransfer.effectAllowed = 'move';

     const dragGhostImage = document.createElement('img');
    dragGhostImage.src = styleImageSrc;

   dragGhostImage.style.width = '40px';
    dragGhostImage.style.height = '40px';
    dragGhostImage.style.borderRadius = '50%';
    dragGhostImage.style.position = 'absolute';
    dragGhostImage.style.top = '-1000px'; // Esconde fora da tela

    document.body.appendChild(dragGhostImage);
    event.dataTransfer.setDragImage(dragGhostImage, 20, 20);

    setTimeout(() => {
        document.body.removeChild(dragGhostImage);
    }, 0);

    setTimeout(() => {
        document.body.removeChild(dragGhostImage);
    }, 0);
}

function handlePositionDragStart(event) {
    const positionElement = event.currentTarget;
    const playerId = positionElement.dataset.assignedPlayerId;
    if (playerId && playerId !== 'null') {
        event.dataTransfer.setData('type', 'player');
        event.dataTransfer.setData('playerId', playerId);
        event.dataTransfer.setData('originalPositionId', positionElement.dataset.position);
        event.dataTransfer.setData('source', 'pitch');
        event.dataTransfer.effectAllowed = 'move';
        setTimeout(() => {
            const img = positionElement.querySelector('img:not(.player-style-icon)');
            if (img) img.style.visibility = 'hidden';
        }, 0);
    } else {
        event.preventDefault();
    }
}

function handlePositionDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
}

function handlePositionDrop(event) {
    event.preventDefault();
    const targetPositionElement = event.currentTarget;
    const type = event.dataTransfer.getData('type');

    if (type === 'style') {
        handleStyleDrop(event, targetPositionElement);
    } else if (type === 'player') {
        handlePlayerDrop(event, targetPositionElement);
    }
}

function handleStyleDrop(event, targetPositionElement) {
    const styleId = event.dataTransfer.getData('styleId');
    const styleName = event.dataTransfer.getData('styleName');
    const targetPositionId = targetPositionElement.dataset.position;
    const targetPlayerId = targetPositionElement.dataset.assignedPlayerId;

    if (!targetPlayerId || targetPlayerId === 'null') {
        alert("Só pode adicionar um estilo a um jogador que já esteja em campo.");
        return;
    }
    const targetPlayer = userOwnedPlayers.find(p => p.id === targetPlayerId);
    if (!targetPlayer) return;

    const requiredPosition = styleToPositionMap[styleName];
    if (targetPlayer.posicao !== requiredPosition) {
        alert(`O estilo "${styleName}" só pode ser aplicado a jogadores da posição "${requiredPosition}".`);
        return;
    }

    if (Object.values(playerStyleAssignments).includes(styleId)) {
        alert(`O estilo "${styleName}" já está a ser usado por outro jogador.`);
        return;
    }

    if (playerStyleAssignments[targetPositionId]) {
        const oldStyleIcon = targetPositionElement.querySelector('.player-style-icon');
        if (oldStyleIcon) oldStyleIcon.click();
    }

    playerStyleAssignments[targetPositionId] = styleId;
    const styleData = userOwnedPlayerStyles.find(s => s.id === styleId);
    if (styleData) {
        const styleIcon = document.createElement('img');
        styleIcon.src = styleData.imagem;
        styleIcon.classList.add('player-style-icon');
        styleIcon.addEventListener('click', removePlayerStyle);
        targetPositionElement.appendChild(styleIcon);
    }

    const styleCardInList = playerResultsContainer.querySelector(`.player-card[data-player-id="${styleId}"]`);
    if (styleCardInList) styleCardInList.classList.add('style-in-use');

    hasUnsavedChanges = true;
}

function handlePlayerDrop(event, targetPositionElement) {
    const targetPositionId = targetPositionElement.dataset.position;
    const targetPositionType = targetPositionElement.dataset.positionType;
    const draggedPlayerId = event.dataTransfer.getData('playerId');
    const source = event.dataTransfer.getData('source');
    const originalPositionId = event.dataTransfer.getData('originalPositionId');
    const draggedPlayer = userOwnedPlayers.find(p => p.id === draggedPlayerId);

    if (!draggedPlayer) {
        const originalPosEl = pitchArea.querySelector(`.position[data-position="${originalPositionId}"] img:not(.player-style-icon)`);
        if (originalPosEl) originalPosEl.style.visibility = 'visible';
        console.error("Drop Falhou: Jogador arrastado não encontrado.");
        return;
    }

    if (source === 'list' && Object.values(assignedPlayers).includes(draggedPlayerId)) {
        alert(`${draggedPlayer.nome} já está em campo!`);
        return;
    }

    const originalPosImg = pitchArea.querySelector(`.position[data-position="${originalPositionId}"] img:not(.player-style-icon)`);
    if (originalPosImg) originalPosImg.style.visibility = 'visible';

    if (posicaoMapping[draggedPlayer.posicao] !== targetPositionType) {
        alert(`Este jogador é ${draggedPlayer.posicao} e não pode ser colocado nesta posição.`);
        return;
    }

    const playerAlreadyInTargetId = targetPositionElement.dataset.assignedPlayerId;
    if (originalPositionId === targetPositionId) return;

    if (originalPositionId) {
        removePlayerFromPosition(originalPositionId);
    }

    if (playerAlreadyInTargetId && playerAlreadyInTargetId !== 'null') {
        removePlayerFromPosition(targetPositionId);
    }

    if (source === 'pitch' && originalPositionId && playerAlreadyInTargetId && playerAlreadyInTargetId !== 'null') {
        const playerOriginallyInTarget = userOwnedPlayers.find(p => p.id === playerAlreadyInTargetId);
        if (playerOriginallyInTarget) {
            addPlayerToPosition(originalPositionId, playerOriginallyInTarget);
        }
    }

    addPlayerToPosition(targetPositionId, draggedPlayer);
    hasUnsavedChanges = true;
}

function handlePositionDragEnd(event) {
    const img = event.currentTarget.querySelector('img:not(.player-style-icon)');
    if (img) img.style.visibility = 'visible';
}

function handlePositionClick(event) {
    const positionElement = event.currentTarget;
    const assignedPlayerId = positionElement.dataset.assignedPlayerId;

    if (assignedPlayerId && assignedPlayerId !== "null") {
        removePlayerFromPosition(positionElement.dataset.position);
    } else {
        showPlayerListModal(positionElement.dataset.positionType, positionElement);
    }
}

// --- Funções de Manipulação de Elementos e Modais ---

function addPlayerToPosition(positionId, player) {
    const positionElement = pitchArea.querySelector(`.position[data-position="${positionId}"]`);
    if (!positionElement || !player) return;

    positionElement.innerHTML = ''; // Limpa o "+"
    const playerImg = document.createElement('img');
    playerImg.src = player.imagem || 'placeholder.png';
    playerImg.alt = player.nome;
    positionElement.appendChild(playerImg);
    positionElement.dataset.assignedPlayerId = player.id;
    positionElement.draggable = true;
    positionElement.addEventListener('dragstart', handlePositionDragStart);
    positionElement.addEventListener('dragend', handlePositionDragEnd);
    assignedPlayers[positionId] = player.id;
    const playerCardInList = playerResultsContainer.querySelector(`.player-card[data-player-id="${player.id}"]`);
    if (playerCardInList) {
        playerCardInList.classList.add('player-in-use');
    }
}

function removePlayerFromPosition(positionId) {
    const positionElement = pitchArea.querySelector(`.position[data-position="${positionId}"]`);
    if (!positionElement) return;

    const removedPlayerId = assignedPlayers[positionId];

    if (playerStyleAssignments[positionId]) {
        const styleIcon = positionElement.querySelector('.player-style-icon');
        if (styleIcon) styleIcon.click();
    }

    positionElement.innerHTML = '+';
    positionElement.dataset.assignedPlayerId = null;
    positionElement.draggable = false;
    positionElement.removeEventListener('dragstart', handlePositionDragStart);
    positionElement.removeEventListener('dragend', handlePositionDragEnd);
    delete assignedPlayers[positionId];
    hasUnsavedChanges = true;
    if (removedPlayerId) {
        const playerCardInList = playerResultsContainer.querySelector(`.player-card[data-player-id="${removedPlayerId}"]`);
        if (playerCardInList) {
            playerCardInList.classList.remove('player-in-use');
        }
    }
}

function removePlayerStyle(event) {
    event.stopPropagation();
    const styleIcon = event.currentTarget;
    const positionElement = styleIcon.parentNode;
    const positionId = positionElement.dataset.position;

    if (positionId && playerStyleAssignments[positionId]) {
        const styleId = playerStyleAssignments[positionId];
        delete playerStyleAssignments[positionId];

        const styleCardInList = playerResultsContainer.querySelector(`.player-card[data-player-id="${styleId}"]`);
        if (styleCardInList) styleCardInList.classList.remove('style-in-use');

        styleIcon.remove();
        hasUnsavedChanges = true;
    }
}

function showPlayerListModal(positionType, positionElement) {
    playerListModal.classList.add('active');
    playerCardListContainer.innerHTML = '<p>A carregar jogadores...</p>';
    populatePlayerCardList(positionType, positionElement);
}

function populatePlayerCardList(positionType, positionElement) {
    const positionTypePortugues = Object.keys(posicaoMapping).find(key => posicaoMapping[key] === positionType);
    const filteredByPosition = userOwnedPlayers.filter(player => player.posicao === positionTypePortugues);
    const assignedIds = Object.values(assignedPlayers).filter(id => id !== null);
    const availablePlayers = filteredByPosition.filter(player => !assignedIds.includes(player.id));
    
    playerCardListContainer.innerHTML = '';
    if (availablePlayers.length === 0) {
        playerCardListContainer.innerHTML = '<p>Sem jogadores disponíveis para esta posição.</p>';
        return;
    }

    const gridContainer = document.createElement('div');
    gridContainer.classList.add('position-grid'); 

    availablePlayers.forEach(player => {
        const playerCard = createPlayerCardElement(player);
        const addButton = document.createElement('button');
        addButton.textContent = 'ADICIONAR';
        addButton.classList.add('btn-confirm', 'add-player-btn');
        addButton.style.marginTop = '5px';
        addButton.onclick = () => {
            assignPlayerToPosition(player, positionElement);
            playerListModal.classList.remove('active');
        };
        playerCard.appendChild(addButton);
        gridContainer.appendChild(playerCard);
    });
    playerCardListContainer.appendChild(gridContainer);
}

function assignPlayerToPosition(player, positionElement) {
    const positionId = positionElement.dataset.position;
    if (Object.values(assignedPlayers).includes(player.id)) {
        alert(`${player.nome} já está em campo!`);
        return;
    }
    if (positionElement.dataset.assignedPlayerId && positionElement.dataset.assignedPlayerId !== 'null') {
        alert("Esta posição já foi ocupada.");
        return;
    }
    addPlayerToPosition(positionId, player);
    hasUnsavedChanges = true;
}

function showConfirmationModal(message, confirmCallback, cancelCallback) {
    const existingModal = document.querySelector('.confirmation-modal-overlay');
    if (existingModal) document.body.removeChild(existingModal);
    
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay confirmation-modal-overlay active';
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';
    modalContent.innerHTML = `<p>${message}</p>`;
    
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'modal-buttons';
    
    const confirmButton = document.createElement('button');
    confirmButton.className = 'btn-confirm';
    confirmButton.textContent = 'Sim';
    confirmButton.onclick = () => { document.body.removeChild(modalOverlay); if (confirmCallback) confirmCallback(); };
    
    const cancelButton = document.createElement('button');
    cancelButton.className = 'btn-cancel';
    cancelButton.textContent = 'Não';
    cancelButton.onclick = () => { document.body.removeChild(modalOverlay); if (cancelCallback) cancelCallback(); };
    
    buttonsContainer.appendChild(confirmButton);
    buttonsContainer.appendChild(cancelButton);
    modalContent.appendChild(buttonsContainer);
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
}

// --- Funções de Renderização e Criação de Elementos ---

// VERSÃO CORRIGIDA E MAIS ROBUSTA
function createPlayerCardElement(item) {
    const card = document.createElement('div');
    card.classList.add('player-card');
    card.dataset.playerId = item.id;

    const isPlayer = item.tipo !== 'Estilo';

    if (isPlayer) {
        card.draggable = true;
        card.addEventListener('dragstart', handlePlayerCardDragStart);
        if (item.casta) {
            const castaMap = { 'Jogador Ouro': 'golden', 'Jogador Prata': 'silver', 'Jogador Bronze': 'bronze', 'Jogador Platina': 'platina', 'Jogador Diamante': 'diamond' };
            const castaClass = castaMap[item.casta];
            if (castaClass) card.classList.add(castaClass);
        }
        if (item.paisId && countries[item.paisId]) {
            const flagImg = document.createElement('img');
            flagImg.src = countries[item.paisId].imagem || 'placeholder.png';
            flagImg.classList.add('country-flag');
            card.appendChild(flagImg);
        }
    } else { // É um Estilo
        card.classList.add('style-item');
        card.draggable = true;
        card.addEventListener('dragstart', handleStyleCardDragStart);
        if (Object.values(playerStyleAssignments).includes(item.id)) {
            card.classList.add('style-in-use');
        }
    }

    const img = document.createElement('img');
    img.src = item.imagem || 'placeholder.png';
    img.alt = item.nome;
    card.appendChild(img);

    const infoDiv = document.createElement('div');
    infoDiv.classList.add('player-info');
    const nameSpan = document.createElement('span');
    nameSpan.classList.add('player-name');
    nameSpan.textContent = item.nome;
    infoDiv.appendChild(nameSpan);

    if (isPlayer && item.posicao) {
        const positionSpan = document.createElement('span');
        positionSpan.classList.add('player-position');
        positionSpan.textContent = item.posicao;
        infoDiv.appendChild(positionSpan);
    }
    card.appendChild(infoDiv);

    if (isPlayer && item.clube) {
        fetchCompetitionLogo(item.clube).then(logoData => {
            if (logoData) {
                const competicaoLogo = document.createElement('img');
                competicaoLogo.src = logoData.imagem;
                competicaoLogo.alt = logoData.nome;
                competicaoLogo.classList.add('competition-logo');
                infoDiv.appendChild(competicaoLogo);
            }
        });
    }
    return card;
}

function renderPlayerResults() {
    playerResultsContainer.innerHTML = '';
    
    const positionOrder = ['Guarda-Redes', 'Defesa', 'Médio', 'Avançado'];
    const groupedPlayers = userOwnedPlayers.reduce((acc, player) => {
        (acc[player.posicao] = acc[player.posicao] || []).push(player);
        return acc;
    }, {});

    positionOrder.forEach(position => {
        if (groupedPlayers[position]?.length > 0) {
            const title = document.createElement('h3');
            title.textContent = position;
            title.classList.add('position-group-title');
            playerResultsContainer.appendChild(title);

            const grid = document.createElement('div');
            grid.classList.add('position-grid');
            groupedPlayers[position]
                .sort((a, b) => a.nome.localeCompare(b.nome))
                .forEach(player => grid.appendChild(createPlayerCardElement(player)));
            playerResultsContainer.appendChild(grid);
        }
    });

    if (userOwnedPlayerStyles.length > 0) {
        const title = document.createElement('h3');
        title.textContent = 'Estilos de Jogador';
        title.classList.add('position-group-title');
        playerResultsContainer.appendChild(title);

        const grid = document.createElement('div');
        grid.classList.add('position-grid');
        userOwnedPlayerStyles
            .sort((a, b) => a.nome.localeCompare(b.nome))
            .forEach(style => grid.appendChild(createPlayerCardElement(style)));
        playerResultsContainer.appendChild(grid);
    }
    
    filterPlayers();
}

function renderFormation(formationName) {
    assignedPlayers = {};
    playerStyleAssignments = {};
    pitchArea.innerHTML = '<div class="center-circle"></div>';
    if (!formationName || !formations[formationName]) return;
    currentFormation = formationName;
    formations[formationName].forEach(pos => {
        const positionElement = document.createElement('div');
        positionElement.classList.add('position');
        positionElement.dataset.position = pos.position;
        positionElement.style.top = pos.top;
        positionElement.style.left = pos.left;
        positionElement.dataset.positionType = pos.positionType;
        positionElement.innerHTML = '+';
        positionElement.draggable = false;
        positionElement.dataset.assignedPlayerId = null;
        positionElement.addEventListener('dragover', handlePositionDragOver);
        positionElement.addEventListener('drop', handlePositionDrop);
        positionElement.addEventListener('click', handlePositionClick);
        pitchArea.appendChild(positionElement);
    });
}

// --- Funções de Dados (Firebase) ---

async function fetchUserOwnedPlayers() {
    if (!currentUserUid) return;
    const q = query(collection(db, 'jogadores'), where('compradopor', '==', currentUserUid));
    const snapshot = await getDocs(q);
    const fetchedPlayers = [];
    const uniqueClubs = new Set();
    const uniqueCountryIds = new Set();
    snapshot.forEach(doc => {
        const data = doc.data();
        fetchedPlayers.push({ ...data, id: doc.id });
        if (data.clube) uniqueClubs.add(data.clube);
        if (data.paisId) uniqueCountryIds.add(data.paisId);
    });
    userOwnedPlayers = fetchedPlayers;
    clubs = uniqueClubs;
}

async function fetchPlayerStyles() {
    if (!currentUserUid) return;
    const q = query(collection(db, 'movimentos'), where('userId', '==', currentUserUid), where('empireTipo', '==', 'Estilos de Jogador'));
    const snapshot = await getDocs(q);
    userOwnedPlayerStyles = snapshot.docs.map(doc => ({ 
        id: doc.id, 
        nome: doc.data().itemEmpire, 
        imagem: doc.data().imagem, 
        tipo: 'Estilo' 
    }));
}

async function fetchCountries() {
    const snapshot = await getDocs(collection(db, 'paises'));
    countries = {};
    snapshot.forEach(doc => { countries[doc.id] = doc.data(); });
}

async function fetchFormationsFromFirestore() {
            if (!currentUserUid) return []; // Retorna um array vazio se não houver utilizador
            try {
                const docSnap = await getDoc(doc(db, 'users', currentUserUid));
                if (docSnap.exists()) {
                    // AGORA: Obtemos o campo 'tática', que esperamos que seja um array
                    const taticasArray = docSnap.data().tática;

                    // VERIFICAÇÃO: Certificamo-nos que é realmente um array e não está vazio
                    if (Array.isArray(taticasArray) && taticasArray.length > 0) {
                        // Se for um array, mapeamos cada nome de formação para o formato que a dropdown precisa
                        return taticasArray.map(name => ({ value: name, label: name }));
                    }
                }
            } catch (error) { 
                console.error("Erro ao buscar formações:", error); 
            }
            
            // Se o campo não existir, não for um array, ou estiver vazio, retorna um array vazio.
            return [];
        }

async function fetchActiveFormationFromPlanteis() {
    if (!currentUserUid) return null;
    try {
        const palpitesSnap = await getDocs(query(collection(db, 'palpites'), orderBy('temporada', 'desc'), limit(1)));
        if (palpitesSnap.empty) return null;
        const latestSeason = palpitesSnap.docs[0].data().temporada;
        
        const q = query(collection(db, 'planteis'), where('userId', '==', currentUserUid), where('estado', '==', 'ativo'), where('temporada', '==', latestSeason), limit(1));
        const activePlanteisSnap = await getDocs(q);
        return activePlanteisSnap.empty ? null : activePlanteisSnap.docs[0].data().formacao;
    } catch (error) { console.error("Erro ao buscar formação ativa:", error); }
    return null;
}

async function fetchCompetitionLogo(clubName) {
    try {
        const clubSnap = await getDocs(query(collection(db, 'clubes'), where('nome', '==', clubName), limit(1)));
        if (!clubSnap.empty) {
            const { competicaoId } = clubSnap.docs[0].data();
            if (competicaoId) {
                const competicaoDoc = await getDoc(doc(db, 'competicoes', competicaoId));
                if (competicaoDoc.exists()) return competicaoDoc.data();
            }
        }
    } catch (error) { console.error(`Erro logo ${clubName}:`, error); }
    return null;
}

async function saveFormation() {
    if (!currentUserUid || !currentFormation) {
        alert("Por favor, selecione uma formação.");
        return;
    }
    try {
        const palpitesSnap = await getDocs(query(collection(db, 'palpites'), orderBy('temporada', 'desc'), limit(1)));
        if (palpitesSnap.empty) throw new Error('Temporada não encontrada.');
        const latestSeason = palpitesSnap.docs[0].data().temporada;

        const planteisRef = collection(db, 'planteis');
        const q = query(planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason));
        const planteisSnap = await getDocs(q);

        const plantelData = { 
            userId: currentUserUid, 
            formacao: currentFormation, 
            temporada: latestSeason, 
            estado: 'desativo', 
            dataDeEdicao: serverTimestamp(),
            estilos: playerStyleAssignments // Salvar os estilos
        };
        formations[currentFormation]?.forEach(p => { plantelData[p.position] = assignedPlayers[p.position] || null; });

        if (!planteisSnap.empty) {
            const docRef = planteisSnap.docs[0].ref;
            plantelData.estado = planteisSnap.docs[0].data().estado || 'desativo';
            await updateDoc(docRef, plantelData);
        } else {
            await addDoc(planteisRef, plantelData);
        }
        hasUnsavedChanges = false;
        alert("Formação guardada com sucesso!");
    } catch (error) { console.error("Erro ao guardar formação:", error); alert("Erro ao guardar formação."); }
}

async function loadFormation() {
    if (!currentUserUid || !currentFormation) {
        renderFormation(null);
        return;
    }
     playerResultsContainer.querySelectorAll('.player-card.player-in-use').forEach(card => {
        card.classList.remove('player-in-use');
    });
    
   try {
        const palpitesSnap = await getDocs(query(collection(db, 'palpites'), orderBy('temporada', 'desc'), limit(1)));
        if (palpitesSnap.empty) throw new Error("Temporada não encontrada.");
        const latestSeason = palpitesSnap.docs[0].data().temporada;

        const q = query(collection(db, 'planteis'), where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason), limit(1));
        const snapshot = await getDocs(q);

      renderFormation(currentFormation); // Renderiza o campo vazio primeiro

        if (!snapshot.empty) {
            const plantelData = snapshot.docs[0].data();
            formations[currentFormation]?.forEach(posInfo => {
                const playerId = plantelData[posInfo.position];
                if (playerId) {
                    const player = userOwnedPlayers.find(p => p.id === playerId);
                    if (player) addPlayerToPosition(posInfo.position, player);
                }
            });
            
            
            playerStyleAssignments = plantelData.estilos || {};
            Object.entries(playerStyleAssignments).forEach(([positionId, styleId]) => {
                const positionElement = pitchArea.querySelector(`.position[data-position="${positionId}"]`);
                const styleData = userOwnedPlayerStyles.find(s => s.id === styleId);
                if (positionElement && styleData) {
                    const styleIcon = document.createElement('img');
                    styleIcon.src = styleData.imagem;
                    styleIcon.classList.add('player-style-icon');
                    styleIcon.addEventListener('click', removePlayerStyle);
                    positionElement.appendChild(styleIcon);

                    const styleCardInList = playerResultsContainer.querySelector(`.player-card[data-player-id="${styleId}"]`);
                    if(styleCardInList) styleCardInList.classList.add('style-in-use');
                }
            });
        }
        hasUnsavedChanges = false;
    } catch (error) { console.error("Erro ao carregar formação:", error); }
}

// --- Lógica de UI e Filtros ---

function populateCountryFilter() {
    countryFilterSelect.innerHTML = '<option value="">País (Todos)</option>';
    Object.entries(countries)
        .sort(([, a], [, b]) => a.nome.localeCompare(b.nome))
        .forEach(([id, data]) => {
            const option = document.createElement('option');
            option.value = id; option.textContent = data.nome;
            countryFilterSelect.appendChild(option);
        });
}

function populateClubFilter() {
    clubFilterSelect.innerHTML = '<option value="">Clube (Todos)</option>';
    [...clubs].sort().forEach(clubName => {
        const option = document.createElement('option');
        option.value = clubName; option.textContent = clubName;
        clubFilterSelect.appendChild(option);
    });
}

async function populateFormationDropdownFromFirestore() {
    const formationsFromUser = await fetchFormationsFromFirestore();
    formationSelect.innerHTML = '<option value="" disabled selected>Selecionar Formação</option>';
    formationsFromUser.forEach(f => {
        const option = document.createElement('option');
        option.value = f.value; option.textContent = f.label;
        formationSelect.appendChild(option);
    });
}

function filterPlayers() {
    const searchTerm = playerSearchInput.value.toLowerCase();
    const selectedCountryId = countryFilterSelect.value;
    const selectedClub = clubFilterSelect.value;
    const selectedPosition = positionFilterSelect.value;

    playerResultsContainer.querySelectorAll('.player-card:not(.style-item)').forEach(card => {
        const player = userOwnedPlayers.find(p => p.id === card.dataset.playerId);
        if (!player) { card.style.display = 'none'; return; }

        const nameMatch = player.nome.toLowerCase().includes(searchTerm);
        const countryMatch = !selectedCountryId || player.paisId === selectedCountryId;
        const clubMatch = !selectedClub || player.clube === selectedClub;
        const positionMatch = !selectedPosition || player.posicao === selectedPosition;

        card.style.display = (nameMatch && countryMatch && clubMatch && positionMatch) ? '' : 'none';
    });
}

async function getUserStatus(userId) {
    const userDoc = await getDoc(doc(db, 'users', userId));
    if (userDoc.exists() && userDoc.data().aceite === "Yes") {
        return userDoc.data().estatuto;
    }
    return null;
}

// --- Inicialização da Página ---

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUserUid = user.uid;
        currentUserStatus = await getUserStatus(user.uid);
        
        if (!currentUserStatus) {
            window.location.href = '404.html';
            return;
        }

        try {
            await updateDoc(doc(db, 'users', user.uid), { ultimoacesso: serverTimestamp() });
            
            const paineisMenuDoc = await getDoc(doc(db, 'paineis', 'paineis menu'));
            if (paineisMenuDoc.exists()) {
                const menuData = paineisMenuDoc.data();
                if (menuData.team === "off" && currentUserStatus !== 'ruler') {
                    window.location.href = '404.html';
                    return;
                }
                document.querySelectorAll('.menu-item').forEach(item => {
                    const key = item.href.split('/').pop().replace('.html', '');
                    if (menuData[key] === "off") {
                        item.style.display = 'none';
                    }
                });
            }

            await Promise.all([
                fetchCountries(),
                fetchUserOwnedPlayers(),
                fetchPlayerStyles()
            ]);
            
            await populateFormationDropdownFromFirestore();
            populateCountryFilter();
            populateClubFilter();
            renderPlayerResults();

            const activeFormation = await fetchActiveFormationFromPlanteis();
            const formationsFromUser = await fetchFormationsFromFirestore();
            let initialFormationToLoad = activeFormation || (formationsFromUser[0]?.value || null);
            
            if (initialFormationToLoad) {
                formationSelect.value = initialFormationToLoad;
                currentFormation = initialFormationToLoad;
                await loadFormation();
            } else {
                renderFormation(null);
            }
            
        } catch (error) {
            console.error("Erro na inicialização:", error);
        } finally {
            loadingScreen.style.display = 'none';
            content.style.display = 'block';
        }
    } else {
        window.location.href = 'index.html';
    }
});

// --- Adição de Event Listeners ---
playerSearchInput.addEventListener('input', filterPlayers);
countryFilterSelect.addEventListener('change', filterPlayers);
clubFilterSelect.addEventListener('change', filterPlayers);
positionFilterSelect.addEventListener('change', filterPlayers);
saveFormationButton.addEventListener('click', saveFormation);
closePlayerListModalBtn.addEventListener('click', () => playerListModal.classList.remove('active'));

chooseBtn.addEventListener('click', async () => {
    if (!currentUserUid || !currentFormation) { alert("Selecione uma formação."); return; }
    if (hasUnsavedChanges) { alert("Guarde as alterações antes de escolher."); return; }
    try {
        const palpitesSnap = await getDocs(query(collection(db, 'palpites'), orderBy('temporada', 'desc'), limit(1)));
        if (palpitesSnap.empty) throw new Error('Temporada não encontrada.');
        const latestSeason = palpitesSnap.docs[0].data().temporada;

        const planteisRef = collection(db, 'planteis');
        const q = query(planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason), limit(1));
        const currentSnap = await getDocs(q);
        if (currentSnap.empty) { alert(`A formação ${currentFormation} não está guardada. Guarde-a primeiro.`); return; }
        
        const batch = writeBatch(db);
        const allPlanteisSnap = await getDocs(query(planteisRef, where('userId', '==', currentUserUid), where('temporada', '==', latestSeason)));
        allPlanteisSnap.forEach(doc => batch.update(doc.ref, { estado: 'desativo' }));
        batch.update(currentSnap.docs[0].ref, { estado: 'ativo' });
        await batch.commit();

        alert(`Formação ${currentFormation} definida como ativa!`);
    } catch (error) { console.error('Erro ao definir formação ativa:', error); alert('Erro: ' + error.message); }
});

formationSelect.addEventListener('change', async (e) => {
    const newFormation = e.target.value;
    if (!newFormation || newFormation === currentFormation) return;

    const switchFormation = async () => {
        hasUnsavedChanges = false;
        currentFormation = newFormation;
        await loadFormation();
    };

    if (hasUnsavedChanges) {
        showConfirmationModal(
            'Existem alterações não guardadas. Quer guardá-las antes de mudar?',
            async () => { await saveFormation(); await switchFormation(); },
            async () => { await switchFormation(); }
        );
    } else {
        await switchFormation();
    }
});

document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', (e) => {
        const destination = item.href;
        if (hasUnsavedChanges && destination && !destination.endsWith('#') && destination !== window.location.href) {
            e.preventDefault();
            showConfirmationModal(
                'Tem alterações não guardadas. Quer guardá-las antes de sair?',
                async () => { await saveFormation(); window.location.href = destination; },
                () => { hasUnsavedChanges = false; window.location.href = destination; }
            );
        }
    });
});

document.addEventListener('contextmenu', function(event) {
    // Verifica se o elemento que foi clicado é uma tag de imagem (IMG)
    if (event.target.tagName === 'IMG') {
        // Impede o comportamento padrão do navegador (mostrar o menu)
        event.preventDefault();
    }
});

    </script>
</body>
</html>
