<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Equipa - Ggames</title>
        <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEiIbiLnCB/s320/soccer-ball-png.webp">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ... (Seu CSS original - o mesmo do código anterior correto) ... */
        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
        }

        .menu-item:hover, .menu-item.active {
            color: #333;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #2176ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(33, 118, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover {
            color: #0056d6;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(33, 118, 255, 0.6));
        }

         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }



        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex; /* Show when active class is added */
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-confirm {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .btn-confirm:hover {
            background-color: #45a049;
        }

        .btn-cancel:hover {
            background-color: #d32f2f;
        }

        .btn-confirm.add-player-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-confirm.add-player-btn:hover {
            background: linear-gradient(135deg, #45a049, #357a38);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-confirm.add-player-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }



        .content {
            padding: 20px;
            margin-bottom: 80px; /* Reduced margin-bottom to accommodate bottom menu */
            display: none; /* Hide content initially */
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .loading-spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .team-section {
            display: flex;
            gap: 20px;
            padding: 20px;
            flex-direction: column;
            align-items: flex-start;
        }

        @media (min-width: 768px) {
            .team-section {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .pitch-side, .player-selection-side {
            flex: 1;
            min-width: 300px;
        }

        .player-selection-side {
            margin-top: 45px; /* Aligns with the top of pitch-area */
        }

        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 0;
            padding-bottom: 75%;
            background-color: #2d6a4f;
            border: 1px solid #228B22;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .pitch-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 96%;
            height: 94%;
            border: 1px solid white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }


        .pitch-area::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
            background-color: white;
            z-index: 0; /* Optionally add this to ensure line is behind, although default is 0 */
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 1px solid white;
            border-radius: 50%;
        }

        .position {
            position: absolute;
            width: 30px; /* Tamanho original da "bola" */
            height: 30px; /* Tamanho original da "bola" */
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            color: white;
            transition: background-color 0.3s ease;
            border: none;
        }

        .position:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .position img {
            position: absolute; /* Posicionamento absoluto para sobrepor a "bola" */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centraliza a imagem */
            width: 60px; /* Dobro do tamanho da "bola" */
            height: 60px; /* Dobro do tamanho da "bola" */
            border-radius: 50%;
            object-fit: cover;
            /* pointer-events: none; REMOVED THIS LINE */
            z-index: 1; /* Add this line to bring player images forward */
        }


        .formation-options {
            margin-bottom: 10px;
        }

        .formation-options label {
            margin-right: 10px;
            font-weight: bold;
        }

        .player-search-section {
        }

        .player-search-bar {
        }

        .player-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-results, .playerCardList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            width: 100%;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }

        .player-results::-webkit-scrollbar, .playerCardList::-webkit-scrollbar {
            width: 8px;
        }

        .player-results::-webkit-scrollbar-track, .playerCardList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .player-results::-webkit-scrollbar-thumb, .playerCardList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .player-results::-webkit-scrollbar-thumb:hover, .playerCardList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Add casta-based background gradients */
        .player-card.bronze {
            background: linear-gradient(135deg, #cd7f32, #a0522d);
            color: white;
        }

        .player-card.silver {
            background: linear-gradient(135deg, #c0c0c0, #808080);
            color: white;
        }

        .player-card.golden {
            background: linear-gradient(135deg, #ffd700, #daa520);
            color: white;
            /*text-shadow: 0 0 4px black;*/ /* Opcional: Sombra no texto para melhor contraste */
        }


        .player-card.diamond {
            background: linear-gradient(135deg, #b9f2ff, #00bfff);
            color: white;
        }

        .player-card.platina {
            background: linear-gradient(135deg, #e5e4e2, #c0c0c0);
            color: white;
        }

        .player-card {
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            background-color: #f5f5f5;
        }

        .player-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .player-card .player-info {
            width: 100%;
            text-align: center;
        }

        .player-card .player-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 2px;
            display: block;
        }

        .player-card .country-flag {
            width: 20px;
            height: 15px;
            object-fit: contain;
            position: absolute;
            top: 8px;
            right: 8px;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            z-index: 2;
        }

        .player-card .player-position {
            font-size: 0.8em;
            color: white;
            display: block;
            text-align: center;
        }

        .player-card .competition-logo {
            width: 20px;
            height: 15px;
            object-fit: contain;
            position: absolute;
            top: 28px;
            right: 8px;
            border: none;
            border-radius: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            z-index: 2;
        }


        .formation-options {
            padding: 10px;
        }

        .formation-controls {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
        }

        button#saveFormationBtn, button#chooseBtn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#saveFormationBtn {
            background-color: #4CAF50;
        }

        button#saveFormationBtn:hover {
            background-color: #45a049;
        }

        button#chooseBtn {
            background-color: #FFB700;
        }

        button#chooseBtn:hover {
            background-color: #DAA520;
        }

        .formation-select-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .formation-options select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .search-container {
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .search-container input[type="text"] {
            padding: 8px;
            width: 40%;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .filter-dropdowns {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .filter-dropdowns select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button#saveFormationBtn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50; /* Green background */
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#saveFormationBtn:hover {
            background-color: #45a049; /* Darker green on hover */
        }

        @media (max-width: 767px) {
    .content {
        padding: 10px; /* Reduz o padding geral da página */
    }

    .team-section {
        flex-direction: column; /* Força o empilhamento vertical do relvado e da lista de jogadores */
        align-items: center; /* Centra os blocos na página */
    }

    .pitch-side, .player-selection-side {
        width: 100%; /* Faz com que cada secção ocupe a largura total */
        min-width: unset; /* Remove a largura mínima que causa problemas */
    }

    .player-selection-side {
        margin-top: 20px; /* Adiciona espaço entre o relvado e a secção de pesquisa */
    }

    .formation-controls {
        flex-direction: column; /* Empilha os controlos de formação */
        gap: 10px;
        align-items: stretch; /* Faz os botões esticarem */
    }

    .formation-select-container {
        justify-content: space-between;
    }

    .search-container {
        flex-direction: column; /* Empilha a barra de pesquisa e os filtros */
        gap: 10px;
    }

    .filter-dropdowns {
        flex-direction: column; /* Empilha os filtros de país e clube */
        gap: 10px;
    }

    .search-container input[type="text"], .filter-dropdowns select {
        width: 100%; /* Faz os campos de filtro ocuparem a largura toda */
    }

    .player-results, .playerCardList {
        /* O grid já é responsivo, mas podemos ajustar o tamanho mínimo dos cartões */
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        padding: 10px;
    }
}
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <h1>Minha Equipa</h1>

        <div class="team-section">
            <div class="pitch-side">
                <div class="formation-options">
                    <div class="formation-controls">
                        <div class="formation-select-container">
                            <label for="formation-select">Formação:</label>
                            <select id="formation-select">
                                <option value="" disabled selected>Selecionar Formação</option>
                            </select>
                        </div>
                        <button id="saveFormationBtn">Guardar</button>
                        <button id="chooseBtn">Escolher</button>
                    </div>
                </div>

                <div class="pitch-container">
                    <div class="pitch-area">
                        <div class="center-circle"></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-side">
                <div class="search-container">
                    <input type="text" id="player-search" placeholder="Pesquisar jogador...">
                    <div class="filter-dropdowns">
                        <select id="country-filter">
                            <option value="">País (Todos)</option>
                        </select>
                        <select id="club-filter">
                            <option value="">Clube (Todos)</option>
                        </select>
                    </div>
                </div>
                <div class="player-results">
                    No data available in table
                </div>
            </div>
        </div>
    </div>

    <!-- Player List Modal -->
    <div id="playerListModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Escolha um Jogador</h3>
            <div id="playerCardList" class="player-results">
                <p>A carregar jogadores...</p>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" id="closePlayerListModal">Fechar</button>
            </div>
        </div>
    </div>

    <nav class="bottom-menu">
        <a href="1x.html" class="menu-item">
            <i class="fas fa-home"></i>
        </a>
        <a href="market.html" class="menu-item">
            <i class="fas fa-shopping-cart"></i>
        </a>
        <a href="team.html" class="menu-item active">
            <i class="fas fa-users"></i>
        </a>
        <a href="empire.html" class="menu-item">
            <i class="fas fa-landmark empire-icon"></i>
        </a>
        <a href="rankings.html" class="menu-item">
            <i class="fas fa-list"></i>
        </a>
        <a href="profile.html" class="menu-item">
            <i class="fas fa-user"></i>
        </a>
    </nav>


    
   <script src="config.js"></script>
    
    <script type="module">
   
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, collection, getDocs, doc, getDoc, query, where, 
            updateDoc, serverTimestamp, writeBatch, orderBy, limit, addDoc 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
          const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // O resto das variáveis da sua página permanece exatamente igual.
        const loadingScreen = document.getElementById('loading-screen');
        const content = document.querySelector('.content');
        let currentUserStatus = null;
        let currentUserUid = null;
        let userOwnedPlayers = [];
        let countries = {};
        let clubs = new Set();
        let currentFormation = '';
        let hasUnsavedChanges = false;
        const formationSelect = document.getElementById('formation-select');
        const pitchArea = document.querySelector('.pitch-area');
        const playerResultsContainer = document.querySelector('.player-results');
        const playerSearchInput = document.getElementById('player-search');
        const countryFilterSelect = document.getElementById('country-filter');
        const clubFilterSelect = document.getElementById('club-filter');
        const playerListModal = document.getElementById('playerListModal');
        const closePlayerListModalBtn = document.getElementById('closePlayerListModal');
        const playerCardListContainer = document.getElementById('playerCardList');
        let assignedPlayers = {};

        const formations = {
            '4-4-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '32%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '62%', positionType: 'FWD' } ],
            '4-3-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '60%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '62%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
            '4-5-1': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DL', top: '75%', left: '12%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '32%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '62%', positionType: 'DEF' }, { position: 'DR', top: '75%', left: '82%', positionType: 'DEF' }, { position: 'DML', top: '50%', left: '47%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '10%', positionType: 'MID' }, { position: 'AMC', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '64%', positionType: 'MID' }, { position: 'DMR', top: '40%', left: '84%', positionType: 'MID' }, { position: 'FW', top: '10%', left: '47%', positionType: 'FWD' } ],
            '3-4-3': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'DC1', top: '75%', left: '20%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC3', top: '75%', left: '77%', positionType: 'DEF' }, { position: 'ML', top: '40%', left: '12%', positionType: 'MID' }, { position: 'MC1', top: '40%', left: '32%', positionType: 'MID' }, { position: 'MC2', top: '40%', left: '62%', positionType: 'MID' }, { position: 'MR', top: '40%', left: '82%', positionType: 'MID' }, { position: 'AML', top: '10%', left: '25%', positionType: 'FWD' }, { position: 'AMC', top: '10%', left: '50%', positionType: 'FWD' }, { position: 'AMR', top: '10%', left: '75%', positionType: 'FWD' }, ],
            '5-3-2': [ { position: 'GK', top: '90%', left: '47%', positionType: 'GK' }, { position: 'SW', top: '75%', left: '10%', positionType: 'DEF' }, { position: 'WBL', top: '75%', left: '30%', positionType: 'DEF' }, { position: 'DC1', top: '75%', left: '47%', positionType: 'DEF' }, { position: 'DC2', top: '75%', left: '64%', positionType: 'DEF' }, { position: 'WBR', top: '75%', left: '84%', positionType: 'DEF' }, { position: 'MC1', top: '40%', left: '30%', positionType: 'MID' }, { position: 'MC2', top: '55%', left: '47%', positionType: 'MID' }, { position: 'MC3', top: '40%', left: '64%', positionType: 'MID' }, { position: 'FW1', top: '10%', left: '30%', positionType: 'FWD' }, { position: 'FW2', top: '10%', left: '64%', positionType: 'FWD' } ]
        };
        const posicaoMapping = { "Avançado": "FWD", "Defesa": "DEF", "Médio": "MID", "Guarda-Redes": "GK" };

        function isPlayerAlreadyOnPitch(playerId) {
            return Object.values(assignedPlayers).includes(playerId);
        }

        function handlePlayerCardDragStart(event) {
            const playerCard = event.currentTarget;
            const playerId = playerCard.dataset.playerId;
            event.dataTransfer.setData('playerId', playerId);
            event.dataTransfer.setData('source', 'list');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handlePositionDragStart(event) {
            const positionElement = event.currentTarget;
            const playerId = positionElement.dataset.assignedPlayerId;
            const positionId = positionElement.dataset.position;
            if (playerId && playerId !== 'null') {
                event.dataTransfer.setData('playerId', playerId);
                event.dataTransfer.setData('originalPositionId', positionId);
                event.dataTransfer.setData('source', 'pitch');
                event.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    const img = positionElement.querySelector('img');
                    if (img) img.style.visibility = 'hidden';
                }, 0);
            } else {
                event.preventDefault();
            }
        }

        function handlePositionDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        function handlePositionDrop(event) {
            event.preventDefault();
            const targetPositionElement = event.currentTarget;
            const targetPositionId = targetPositionElement.dataset.position;
            const targetPositionType = targetPositionElement.dataset.positionType;
            const draggedPlayerId = event.dataTransfer.getData('playerId');
            const source = event.dataTransfer.getData('source');
            const originalPositionId = event.dataTransfer.getData('originalPositionId');
            const draggedPlayer = userOwnedPlayers.find(p => p.id === draggedPlayerId);

            if (!draggedPlayer) {
                console.error("Drop Falhou: Jogador arrastado não encontrado nos dados locais.");
                if (originalPositionId) {
                    const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                    const img = originalPositionElement?.querySelector('img');
                    if(img) img.style.visibility = 'visible';
                }
                return;
            }

            if (source === 'list' && isPlayerAlreadyOnPitch(draggedPlayerId)) {
                alert(`${draggedPlayer.nome} já está em campo!`);
                return;
            }

            if (originalPositionId) {
                const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                const img = originalPositionElement?.querySelector('img');
                if(img) img.style.visibility = 'visible';
            }

            const playerPosicaoIngles = posicaoMapping[draggedPlayer.posicao];
            if (playerPosicaoIngles !== targetPositionType) {
                alert(`Este jogador é ${draggedPlayer.posicao} e só pode ser colocado em posições de ${targetPositionType}`);
                return;
            }

            const playerAlreadyInTargetPositionId = targetPositionElement.dataset.assignedPlayerId;
            if (originalPositionId === targetPositionId) return;

            let idToRemoveFromTarget = null;
            if (playerAlreadyInTargetPositionId && playerAlreadyInTargetPositionId !== 'null') {
                idToRemoveFromTarget = playerAlreadyInTargetPositionId;
            }

            if (originalPositionId) {
                const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                if (originalPositionElement) {
                    removePlayerFromPositionDOM(originalPositionElement);
                    delete assignedPlayers[originalPositionId];
                }
            }

            if (idToRemoveFromTarget) {
                removePlayerFromPositionDOM(targetPositionElement);
            }

            if (source === 'list' && idToRemoveFromTarget) {
                addPlayerToPositionDOM(targetPositionElement, draggedPlayer);
                assignedPlayers[targetPositionId] = draggedPlayerId;
                hasUnsavedChanges = true;
            } else if (source === 'pitch' && originalPositionId && idToRemoveFromTarget) {
                const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                const playerOriginallyInTarget = userOwnedPlayers.find(p => p.id === idToRemoveFromTarget);
                if (originalPositionElement && playerOriginallyInTarget) {
                    addPlayerToPositionDOM(originalPositionElement, playerOriginallyInTarget);
                    assignedPlayers[originalPositionId] = idToRemoveFromTarget;
                    addPlayerToPositionDOM(targetPositionElement, draggedPlayer);
                    assignedPlayers[targetPositionId] = draggedPlayerId;
                    hasUnsavedChanges = true;
                } else {
                    console.error("Falha na Troca: Elemento original ou dados do jogador alvo não encontrados.");
                    if (originalPositionId && originalPositionElement) {
                        addPlayerToPositionDOM(originalPositionElement, draggedPlayer);
                        assignedPlayers[originalPositionId] = draggedPlayerId;
                    }
                }
            } else if (!idToRemoveFromTarget) {
                addPlayerToPositionDOM(targetPositionElement, draggedPlayer);
                assignedPlayers[targetPositionId] = draggedPlayerId;
                if (originalPositionId) {
                    const originalPositionElement = pitchArea.querySelector(`.position[data-position="${originalPositionId}"]`);
                    if(originalPositionElement && !originalPositionElement.querySelector('img') && originalPositionElement !== targetPositionElement) {
                        originalPositionElement.innerHTML = '+';
                    }
                }
                hasUnsavedChanges = true;
            }
        }

        function handlePositionDragEnd(event) {
            const positionElement = event.currentTarget;
            const img = positionElement?.querySelector('img');
            if (img) {
                img.style.visibility = 'visible';
            }
        }

        function addPlayerToPositionDOM(positionElement, player) {
            if (!positionElement || !player) return;
            positionElement.innerHTML = '';
            const playerImg = document.createElement('img');
            playerImg.src = player.imagem || 'placeholder_image_url.png';
            playerImg.alt = player.nome;
            playerImg.style.visibility = 'visible';
            positionElement.appendChild(playerImg);
            positionElement.dataset.assignedPlayerId = player.id;
            positionElement.draggable = true;
            positionElement.addEventListener('dragstart', handlePositionDragStart);
            positionElement.addEventListener('dragend', handlePositionDragEnd);
        }

        function removePlayerFromPositionDOM(positionElement) {
            if (!positionElement) return;
            positionElement.innerHTML = '';
            positionElement.dataset.assignedPlayerId = null;
            positionElement.draggable = false;
            positionElement.removeEventListener('dragstart', handlePositionDragStart);
            positionElement.removeEventListener('dragend', handlePositionDragEnd);
        }

        function handlePositionClick(event) {
            const positionElement = event.currentTarget;
            const assignedPlayerId = positionElement.dataset.assignedPlayerId;
            const positionId = positionElement.dataset.position;
            if (assignedPlayerId && assignedPlayerId !== "null") {
                removePlayerFromPositionDOM(positionElement);
                positionElement.innerHTML = '+';
                delete assignedPlayers[positionId];
                hasUnsavedChanges = true;
            } else {
                showPlayerListModal(positionElement.dataset.positionType, positionElement);
            }
        }

        async function saveFormation() {
            if (!currentUserUid) return;
            try {
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                let latestSeason = '';
                if (!palpitesSnapshot.empty) { latestSeason = palpitesSnapshot.docs[0].data().temporada; }
                else { console.error('No seasons found.'); alert("Erro: Temporada não encontrada."); return; }

                if (!currentFormation) { alert("Por favor, selecione uma formação."); return; }

                const planteisRef = collection(db, 'planteis');
                const planteisQuery = query( planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason) );
                const planteisSnapshot = await getDocs(planteisQuery);

                const plantelData = { userId: currentUserUid, formacao: currentFormation, temporada: latestSeason, estado: 'desativo', dataDeEdicao: serverTimestamp() };
                const formationPositions = formations[currentFormation]?.map(p => p.position) || [];
                formationPositions.forEach(posId => { plantelData[posId] = assignedPlayers[posId] || null; });

                if (!planteisSnapshot.empty) {
                    const docRef = planteisSnapshot.docs[0].ref;
                    const currentData = planteisSnapshot.docs[0].data();
                    plantelData.estado = currentData.estado || 'desativo';
                    await updateDoc(docRef, plantelData);
                } else {
                    await addDoc(planteisRef, plantelData);
                }
                hasUnsavedChanges = false;
                const saveBtn = document.getElementById('saveFormationBtn');
                const confirmIcon = document.createElement('i');
                confirmIcon.classList.add('fas', 'fa-check'); confirmIcon.style.color = '#4CAF50'; confirmIcon.style.marginLeft = '10px';
                saveBtn.parentNode.insertBefore(confirmIcon, saveBtn.nextSibling);
                setTimeout(() => confirmIcon.remove(), 3000);
            } catch (error) { console.error("Erro ao guardar formação:", error); alert("Erro ao guardar formação."); }
        }

        function renderFormation(formationName) {
            assignedPlayers = {};
            pitchArea.innerHTML = '<div class="center-circle"></div>';
            if (!formationName || !formations[formationName]) return;
            currentFormation = formationName;
            const currentFormationPositions = formations[formationName];
            currentFormationPositions.forEach(pos => {
                const positionElement = document.createElement('div');
                positionElement.classList.add('position');
                positionElement.dataset.position = pos.position;
                positionElement.style.top = pos.top;
                positionElement.style.left = pos.left;
                positionElement.dataset.positionType = pos.positionType;
                positionElement.innerHTML = '+';
                positionElement.draggable = false;
                positionElement.dataset.assignedPlayerId = null;
                positionElement.addEventListener('dragover', handlePositionDragOver);
                positionElement.addEventListener('drop', handlePositionDrop);
                positionElement.addEventListener('click', handlePositionClick);
                pitchArea.appendChild(positionElement);
            });
        }

        function showPlayerListModal(positionType, positionElement) {
            playerListModal.classList.add('active');
            playerCardListContainer.innerHTML = '<p>A carregar jogadores...</p>';
            populatePlayerCardList(positionType, positionElement);
        }

        async function populatePlayerCardList(positionType, positionElement) {
            try {
                const positionTypePortugues = Object.keys(posicaoMapping).find(key => posicaoMapping[key] === positionType);
                const filteredByPosition = userOwnedPlayers.filter(player => player.posicao === positionTypePortugues);
                const assignedIds = Object.values(assignedPlayers).filter(id => id !== null);
                const availablePlayers = filteredByPosition.filter(player => !assignedIds.includes(player.id));
                playerCardListContainer.innerHTML = '';
                if (availablePlayers.length === 0) {
                    playerCardListContainer.innerHTML = '<p>Sem jogadores disponíveis para esta posição (ou já estão em campo).</p>';
                } else {
                    availablePlayers.forEach(player => {
                        const playerCard = createPlayerCardElement(player, false);
                        const addButton = document.createElement('button');
                        addButton.textContent = 'ADICIONAR';
                        addButton.classList.add('btn-confirm', 'add-player-btn');
                        addButton.style.marginTop = '5px';
                        addButton.onclick = () => {
                            assignPlayerToPosition(player, positionElement);
                            playerListModal.classList.remove('active');
                        };
                        playerCard.appendChild(addButton);
                        playerCardListContainer.appendChild(playerCard);
                    });
                }
            } catch (error) {
                console.error("Erro ao popular lista de jogadores no modal:", error);
                playerCardListContainer.innerHTML = '<p>Erro ao carregar jogadores.</p>';
            }
        }

        function assignPlayerToPosition(player, positionElement) {
            const positionId = positionElement.dataset.position;
            if (isPlayerAlreadyOnPitch(player.id)) {
                alert(`${player.nome} já está em campo noutra posição!`);
                return;
            }
            if (positionElement.dataset.assignedPlayerId && positionElement.dataset.assignedPlayerId !== 'null') {
                alert("Esta posição já foi ocupada enquanto escolhia. Tente novamente.");
                return;
            }
            removePlayerFromPositionDOM(positionElement);
            addPlayerToPositionDOM(positionElement, player);
            assignedPlayers[positionId] = player.id;
            hasUnsavedChanges = true;
        }

        closePlayerListModalBtn.addEventListener('click', () => {
            playerListModal.classList.remove('active');
        });

        function showConfirmationModal(message, confirmCallback, cancelCallback) {
            const existingModal = document.querySelector('.confirmation-modal-overlay');
            if (existingModal) document.body.removeChild(existingModal);
            const modalOverlay = document.createElement('div');
            modalOverlay.classList.add('modal-overlay', 'confirmation-modal-overlay');
            const modalContent = document.createElement('div');
            modalContent.classList.add('modal-content');
            const messageElement = document.createElement('p');
            messageElement.textContent = message;
            modalContent.appendChild(messageElement);
            const buttonsContainer = document.createElement('div');
            buttonsContainer.classList.add('modal-buttons');
            const confirmButton = document.createElement('button');
            confirmButton.classList.add('btn-confirm'); confirmButton.textContent = 'Sim';
            confirmButton.onclick = () => { document.body.removeChild(modalOverlay); if (confirmCallback) confirmCallback(); };
            const cancelButton = document.createElement('button');
            cancelButton.classList.add('btn-cancel'); cancelButton.textContent = 'Não';
            cancelButton.onclick = () => { document.body.removeChild(modalOverlay); if (cancelCallback) cancelCallback(); };
            buttonsContainer.appendChild(confirmButton); buttonsContainer.appendChild(cancelButton);
            modalContent.appendChild(buttonsContainer);
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            modalOverlay.classList.add('active');
        }

        async function fetchUserOwnedPlayers() {
            if (!currentUserUid) return;
            const playersRef = collection(db, 'jogadores');
            const q = query(playersRef, where('compradopor', '==', currentUserUid));
            const querySnapshot = await getDocs(q);
            const fetchedUserPlayers = [];
            const uniqueClubs = new Set();
            const uniqueCountryIds = new Set();
            querySnapshot.forEach((doc) => {
                const playerData = doc.data();
                fetchedUserPlayers.push({ ...playerData, id: doc.id });
                if (playerData.clube) uniqueClubs.add(playerData.clube);
                if (playerData.paisId) uniqueCountryIds.add(playerData.paisId);
            });
            userOwnedPlayers = fetchedUserPlayers;
            clubs = uniqueClubs;
            populateClubFilter();
            renderPlayerResults(userOwnedPlayers);
        }

        async function fetchCountries() {
            const countriesRef = collection(db, 'paises');
            const countriesSnap = await getDocs(countriesRef);
            countries = {};
            countriesSnap.forEach(doc => { countries[doc.id] = doc.data(); });
            populateCountryFilter();
        }

        function populateCountryFilter() {
            countryFilterSelect.innerHTML = '<option value="">País (Todos)</option>';
            const sortedCountries = Object.entries(countries).sort(([, a], [, b]) => a.nome.localeCompare(b.nome));
            sortedCountries.forEach(([countryId, countryData]) => {
                const option = document.createElement('option');
                option.value = countryId; option.textContent = countryData.nome;
                countryFilterSelect.appendChild(option);
            });
        }

        function populateClubFilter() {
            clubFilterSelect.innerHTML = '<option value="">Clube (Todos)</option>';
            const sortedClubs = [...clubs].sort((a, b) => a.localeCompare(b));
            sortedClubs.forEach(clubName => {
                const option = document.createElement('option');
                option.value = clubName; option.textContent = clubName;
                clubFilterSelect.appendChild(option);
            });
        }

        function createPlayerCardElement(player, isDraggable) {
            const playerCard = document.createElement('div');
            playerCard.classList.add('player-card');
            playerCard.dataset.playerId = player.id;
            if (isDraggable) {
                playerCard.draggable = true;
                playerCard.addEventListener('dragstart', handlePlayerCardDragStart);
            }
            const castaMap = { 'Jogador Ouro': 'golden', 'Jogador Prata': 'silver', 'Jogador Bronze': 'bronze', 'Jogador Platina': 'platina', 'Jogador Diamante': 'diamond' };
            const castaClass = castaMap[player.casta];
            if (castaClass) playerCard.classList.add(castaClass);

            if (player.paisId && countries[player.paisId]) {
                const flagImg = document.createElement('img');
                flagImg.src = countries[player.paisId].imagem || 'placeholder_flag_url.png';
                flagImg.alt = countries[player.paisId].nome;
                flagImg.classList.add('country-flag');
                playerCard.appendChild(flagImg);
            }
            const img = document.createElement('img');
            img.src = player.imagem || 'placeholder_image_url.png'; img.alt = player.nome;
            playerCard.appendChild(img);
            const playerInfo = document.createElement('div'); playerInfo.classList.add('player-info');
            const playerName = document.createElement('span'); playerName.classList.add('player-name'); playerName.textContent = player.nome; playerInfo.appendChild(playerName);
            const playerPosition = document.createElement('span'); playerPosition.classList.add('player-position'); playerPosition.textContent = player.posicao; playerInfo.appendChild(playerPosition);
            playerCard.appendChild(playerInfo);

            if (player.clube) {
                fetchCompetitionLogo(player.clube).then(logoData => {
                    if (logoData) {
                        const competicaoLogo = document.createElement('img');
                        competicaoLogo.src = logoData.imagem; competicaoLogo.alt = logoData.nome;
                        competicaoLogo.classList.add('competition-logo');
                        playerInfo.appendChild(competicaoLogo);
                    }
                });
            }
            return playerCard;
        }

        async function fetchCompetitionLogo(clubName) {
            try {
                const clubesRef = collection(db, 'clubes');
                const clubQuery = query(clubesRef, where('nome', '==', clubName), limit(1));
                const clubSnapshot = await getDocs(clubQuery);
                if (!clubSnapshot.empty) {
                    const clubData = clubSnapshot.docs[0].data();
                    if (clubData.competicaoId) {
                        const competicaoRef = doc(db, 'competicoes', clubData.competicaoId);
                        const competicaoDoc = await getDoc(competicaoRef);
                        if (competicaoDoc.exists()) return competicaoDoc.data();
                    }
                } return null;
            } catch (error) { console.error(`Erro logo ${clubName}:`, error); return null; }
        }

        function renderPlayerResults(playersToRender) {
            playerResultsContainer.innerHTML = '';
            if (playersToRender.length === 0) { playerResultsContainer.innerHTML = '<p>Nenhum jogador encontrado.</p>'; return; }
            const positionOrder = { 'Guarda-Redes': 1, 'Defesa': 2, 'Médio': 3, 'Avançado': 4 };
            playersToRender.sort((a, b) => {
                const posA = positionOrder[a.posicao] || 99; const posB = positionOrder[b.posicao] || 99;
                if (posA !== posB) return posA - posB;
                return a.nome.localeCompare(b.nome);
            });
            playersToRender.forEach(player => {
                const playerCardElement = createPlayerCardElement(player, true);
                playerResultsContainer.appendChild(playerCardElement);
            });
        }

        function filterPlayers() {
            const searchTerm = playerSearchInput.value.toLowerCase();
            const selectedCountryId = countryFilterSelect.value;
            const selectedClub = clubFilterSelect.value;
            const filtered = userOwnedPlayers.filter(player => {
                const nameMatch = player.nome.toLowerCase().includes(searchTerm);
                const countryMatch = !selectedCountryId || player.paisId === selectedCountryId;
                const clubMatch = !selectedClub || player.clube === selectedClub;
                return nameMatch && countryMatch && clubMatch;
            });
            renderPlayerResults(filtered);
        }

        playerSearchInput.addEventListener('input', filterPlayers);
        countryFilterSelect.addEventListener('change', filterPlayers);
        clubFilterSelect.addEventListener('change', filterPlayers);

        const saveFormationButton = document.getElementById('saveFormationBtn');
        saveFormationButton.addEventListener('click', saveFormation);

        const chooseBtn = document.getElementById('chooseBtn');
        chooseBtn.addEventListener('click', async () => {
            if (!currentUserUid) return;
            if (!currentFormation) { alert("Selecione uma formação."); return; }
            if (hasUnsavedChanges) { alert("Guarde as alterações antes de escolher."); return; }
            try {
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                if (palpitesSnapshot.empty) throw new Error('Temporada não encontrada.');
                const latestSeason = palpitesSnapshot.docs[0].data().temporada;

                const planteisRef = collection(db, 'planteis');
                const currentFormationQuery = query( planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason), limit(1) );
                const currentFormationSnap = await getDocs(currentFormationQuery);
                if (currentFormationSnap.empty) { alert(`A formação ${currentFormation} não está guardada. Guarde-a primeiro.`); return; }
                const currentFormationDocRef = currentFormationSnap.docs[0].ref;

                const allPlanteisQuery = query( planteisRef, where('userId', '==', currentUserUid), where('temporada', '==', latestSeason) );
                const allPlanteisSnapshot = await getDocs(allPlanteisQuery);
                const batch = writeBatch(db);
                allPlanteisSnapshot.forEach(doc => { batch.update(doc.ref, { estado: 'desativo' }); });
                batch.update(currentFormationDocRef, { estado: 'ativo' });
                await batch.commit();

                const confirmIcon = document.createElement('i');
                confirmIcon.classList.add('fas', 'fa-check'); confirmIcon.style.color = '#4CAF50'; confirmIcon.style.marginLeft = '10px';
                chooseBtn.parentNode.insertBefore(confirmIcon, chooseBtn.nextSibling);
                setTimeout(() => confirmIcon.remove(), 2000);
            } catch (error) { console.error('Erro ao definir formação ativa:', error); alert('Erro: ' + error.message); }
        });

        async function getUserStatus(userId) {
            const userDoc = doc(db, 'users', userId);
            const docSnap = await getDoc(userDoc);
            if (docSnap.exists() && docSnap.data().aceite === "Yes") { return docSnap.data().estatuto; }
            else { return null; }
        }

        async function fetchFormationsFromFirestore() {
            if (!currentUserUid) return [];
            try {
                const userDocRef = doc(db, 'users', currentUserUid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const táticaString = userData.tática;
                    if (táticaString) { return táticaString.split(' ').filter(name => name.trim() !== '').map(name => ({ value: name, label: name })); }
                }
                return [];
            } catch (error) { console.error("Erro ao buscar formações:", error); return []; }
        }

        async function fetchActiveFormationFromPlanteis() {
            if (!currentUserUid) return null;
            try {
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                if (palpitesSnapshot.empty) return null;
                const latestSeason = palpitesSnapshot.docs[0].data().temporada;
                const planteisRef = collection(db, 'planteis');
                const activePlanteisQuery = query( planteisRef, where('userId', '==', currentUserUid), where('estado', '==', 'ativo'), where('temporada', '==', latestSeason), limit(1) );
                const activePlanteisSnapshot = await getDocs(activePlanteisQuery);
                if (!activePlanteisSnapshot.empty) { return activePlanteisSnapshot.docs[0].data().formacao; }
                return null;
            } catch (error) { console.error("Erro ao buscar formação ativa:", error); return null; }
        }

        async function populateFormationDropdownFromFirestore() {
            const formationsFromUser = await fetchFormationsFromFirestore();
            formationSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = ""; defaultOption.disabled = true; defaultOption.selected = true;
            defaultOption.textContent = "Selecionar Formação";
            formationSelect.appendChild(defaultOption);
            if (formationsFromUser.length > 0) {
                formationsFromUser.forEach(formation => {
                    const option = document.createElement('option');
                    option.value = formation.value; option.textContent = formation.label;
                    formationSelect.appendChild(option);
                });
            }
        }

        async function loadFormation() {
            if (!currentUserUid || !currentFormation) {
                renderFormation(null);
                return;
            }
            pitchArea.querySelectorAll('.position').forEach(pos => { removePlayerFromPositionDOM(pos); pos.innerHTML = '+'; });
            assignedPlayers = {};
            try {
                const palpitesRef = collection(db, 'palpites');
                const palpitesQuery = query(palpitesRef, orderBy('temporada', 'desc'), limit(1));
                const palpitesSnapshot = await getDocs(palpitesQuery);
                if (palpitesSnapshot.empty) throw new Error("Temporada não encontrada.");
                const latestSeason = palpitesSnapshot.docs[0].data().temporada;

                const planteisRef = collection(db, 'planteis');
                const q = query( planteisRef, where('userId', '==', currentUserUid), where('formacao', '==', currentFormation), where('temporada', '==', latestSeason), limit(1) );
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const plantelData = querySnapshot.docs[0].data();
                    const currentFormationPositions = formations[currentFormation];
                    if (!currentFormationPositions) { console.error(`Definições para ${currentFormation} não encontradas.`); return; }

                    currentFormationPositions.forEach(posInfo => {
                        const positionId = posInfo.position;
                        const playerId = plantelData[positionId];
                        if (playerId) {
                            const positionElement = pitchArea.querySelector(`.position[data-position="${positionId}"]`);
                            const player = userOwnedPlayers.find(p => p.id === playerId);
                            if (positionElement && player) {
                                addPlayerToPositionDOM(positionElement, player);
                                assignedPlayers[positionId] = playerId;
                            }
                        }
                    });
                    hasUnsavedChanges = false;
                } else {
                    hasUnsavedChanges = false;
                }
            } catch (error) { console.error("Erro ao carregar formação:", error); }
        }

        formationSelect.addEventListener('change', async (e) => {
            const newFormation = e.target.value;
            if (!newFormation) return;
            if (hasUnsavedChanges) {
                showConfirmationModal(
                    'Existem alterações não guardadas. Quer guardá-las antes de mudar?',
                    async () => {
                        await saveFormation();
                        currentFormation = newFormation;
                        renderFormation(currentFormation);
                        await loadFormation();
                    },
                    async () => {
                        hasUnsavedChanges = false;
                        currentFormation = newFormation;
                        renderFormation(currentFormation);
                        await loadFormation();
                    }
                );
            } else {
                currentFormation = newFormation;
                renderFormation(currentFormation);
                await loadFormation();
            }
        });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUserUid = user.uid;
        currentUserStatus = await getUserStatus(user.uid);

        if (currentUserStatus !== null) {
            try {
                // --- INÍCIO DO CÓDIGO ADICIONADO ---
                const paineisMenuDoc = await getDoc(doc(db, 'paineis', 'paineis menu'));

                if (paineisMenuDoc.exists()) {
                    const paineisMenuData = paineisMenuDoc.data();

                    // Regra 1: Controlo de Acesso à Página "Minha Equipa"
                    if (paineisMenuData.team === "off" && currentUserStatus !== 'ruler') {
                        window.location.href = '404.html';
                        return; // Interrompe a execução para não carregar o resto da página
                    }

                    // Regra 2: Visibilidade Dinâmica dos Itens do Menu
                    const menuItemsConfig = {
                        "1x": "menu-item-1x", // Supondo que o ID seja este
                        "market": "menu-item-market", // Supondo que o ID seja este
                        "team": "menu-item-team", // Supondo que o ID seja este
                        "empire": "menu-item-empire", // Supondo que o ID seja este
                        "rankings": "menu-item-rankings", // Supondo que o ID seja este
                        "profile": "menu-item-profile" // Supondo que o ID seja este
                    };

                    // Adicione IDs aos seus <a> no HTML se ainda não tiverem
                    // Ex: <a href="market.html" class="menu-item" id="menu-item-market">
                    for (const menuItemKey in menuItemsConfig) {
                        if (paineisMenuData[menuItemKey] === "off") {
                            // Encontre o item do menu pelo href, já que não temos IDs no seu HTML
                            const menuItemElement = document.querySelector(`.menu-item[href*="${menuItemKey}.html"]`);
                            if (menuItemElement) {
                                menuItemElement.style.display = 'none';
                            }
                        }
                    }
                } else {
                    console.error("Documento 'paineis menu' não encontrado.");
                    // Continua a carregar a página como fallback
                }
                // --- FIM DO CÓDIGO ADICIONADO ---


                // Lógica original da página "Minha Equipa"
                await fetchCountries();
                await populateFormationDropdownFromFirestore();
                await fetchUserOwnedPlayers();

                const activeFormation = await fetchActiveFormationFromPlanteis();
                let initialFormationToLoad = null;

                if (activeFormation && formationSelect.querySelector(`option[value="${activeFormation}"]`)) {
                    initialFormationToLoad = activeFormation;
                    formationSelect.value = activeFormation;
                } else if (formationSelect.options.length > 1) {
                    initialFormationToLoad = formationSelect.options[1].value;
                    formationSelect.value = initialFormationToLoad;
                }

                currentFormation = initialFormationToLoad;
                renderFormation(currentFormation);

                if (currentFormation) {
                    await loadFormation();
                }

            } catch (error) {
                console.error("Erro durante a inicialização:", error);
            } finally {
                loadingScreen.style.display = 'none';
                content.style.display = 'block';
            }
        } else {
            // Se o status for nulo (aceite != "Yes")
            window.location.href = '404.html';
        }
    } else {
        // Se não houver utilizador logado
        window.location.href = 'index.html';
    }
});

        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                const message = 'Tem alterações não guardadas que serão perdidas.';
                e.preventDefault(); e.returnValue = message; return message;
            }
        });

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', async (e) => {
                const destination = item.href;
                if (hasUnsavedChanges && destination && !destination.endsWith('#') && destination !== window.location.href) {
                    e.preventDefault();
                    showConfirmationModal(
                        'Tem alterações não guardadas. Quer guardá-las antes de sair?',
                        async () => { await saveFormation(); window.location.href = destination; },
                        () => { hasUnsavedChanges = false; window.location.href = destination; }
                    );
                }
            });
        });
    </script>
</body>
</html>
