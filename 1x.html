<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1xWhatIf - Ggames</title>
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTl6Ljabwgx-VXdZz8FcAoygQprujSsCoXc32Y_iU0FjYVPu1B6MffWwp8gcCVuV8TWn39FRk9OIe1nc-esubVJYmdLsTptAoR9GyqNuw4R5MBaeaoWXTc3JaqH2YVNtEmfReQqohvQKvHiI0XwE5na2ty2B9Bt4oELxYv2BaZ7R3UmeylpiVEiIbiLnCB/s320/soccer-ball-png.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Estilos existentes ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Mod Popup Styles */
        .mod-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mod-popup-overlay.active {
            display: flex;
            opacity: 1;
        }

        .mod-popup-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            width: 85%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: hidden;
            border-radius: 15px;
            padding: 25px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 15px 12px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .mod-popup-overlay.active .mod-popup-content {
            transform: scale(1);
        }

        .mod-popup-close {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            z-index: 2100;
        }

        .mod-popup-close:hover {
            color: #333;
            background-color: rgba(255, 255, 255, 1);
            transform: rotate(90deg);
        }

        .mod-popup-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        /* NEW MOD badge styling */
        .new-mod-badge {
            position: absolute;
            top: -15px;
            left: -15px;
            background: #FFD700;
            color: #333;
            font-weight: bold;
            font-size: 0.8em;
            padding: 8px 12px;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            z-index: 2200;
            transform: rotate(-15deg);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 70px;
            height: 70px;
        }

        .new-mod-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFD700;
            z-index: -1;
            border-radius: 50%;
            transform: scale(1);
            animation: pulse-star 1.5s infinite alternate;
        }

        @keyframes pulse-star {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            100% {
                transform: scale(1.2);
                opacity: 0.3;
            }
        }
        .mod-popup-image-container {
            display: none; /* Always hide the image container */
            width: 100%;
            height: 150px;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .mod-popup-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .mod-popup-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #2176ff;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1);
        }

        .mod-popup-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            width: 100%;
        }

        .mod-popup-overall {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(33, 118, 255, 0.2);
            width: auto;
        }

        .mod-popup-points {
            display: flex;
            justify-content: flex-end;
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .mod-popup-points-gain {
            color: #28a745;
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-right: 10px;
        }

        .mod-popup-points-loss {
            color: #dc3545;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .mod-popup-points-gain::before {
            content: '+';
            margin-right: 2px;
        }

        .mod-popup-points-loss::before {
            content: '-';
            margin-right: 2px;
        }

        .mod-popup-video {
            width: 100%;
            margin: 15px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            height: 350px; /* Fixed height */
            padding: 0; /* ADDED padding: 0; */
        }

        .mod-popup-video iframe {
    width: 100% !important; /* Force 100% width */
    height: 100% !important; /* Force 100% height */
    border: none;
    overflow: hidden;
    max-width: 100% !important; /* Ensure max-width is also 100% */
    max-height: 100% !important; /* Ensure max-height is also 100% */
    scrolling: no;
    padding: 0 !important; /* Force remove padding */
    margin: 0 !important; /* Force remove margin */
    display: block;
    box-sizing: border-box;
    object-fit: cover;      /* Scale video to cover */
    object-position: center; /* Center the video */
}

        .mod-popup-analyze {
            display: block;
            width: 100%;
            padding: 12px 0;
            background: linear-gradient(135deg, #2176ff, #1a5cc4);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(33, 118, 255, 0.3);
        }

        .mod-popup-analyze:hover {
            background: linear-gradient(135deg, #1a5cc4, #0d4cb3);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(33, 118, 255, 0.4);
        }

        /* Icon animation styles */
        .mod-icon-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2001;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .mod-icon-container.active {
            opacity: 1;
            pointer-events: auto;
        }

        .mod-icon-animation {
            width: 150px;
            height: 150px;
            animation: pulse 1.5s infinite alternate, rotate 3.5s forwards;
            transform-origin: center;
        }

        @keyframes pulse {
            0% {
                transform: scale(1) rotate(0deg);
                filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
            }
            100% {
                transform: scale(1.2) rotate(0deg);
                filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8));
            }
        }

        @keyframes rotate {
            0% {
                transform: scale(1) rotate(0deg);
            }
            80% {
                transform: scale(1.5) rotate(360deg);
                filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.9));
            }
            100% {
                transform: scale(3) rotate(720deg);
                opacity: 0;
                filter: drop-shadow(0 0 50px rgba(255, 255, 255, 1));
            }
        }

        /* Gold card popup styling */
        .mod-popup-gold {
            background: linear-gradient(135deg, #fff9e6 0%, #fff5cc 100%);
            border: 3px solid rgba(255, 215, 0, 0.7);
        }

        .mod-popup-gold .mod-popup-title {
            color: #b8860b;
            text-shadow: 0 0 3px rgba(255, 215, 0, 0.5);
        }

        /* Silver card popup styling */
        .mod-popup-silver {
            background: linear-gradient(135deg, #f5f5f5 0%, #e6e6e6 100%);
            border: 2px solid rgba(192, 192, 192, 0.6);
        }

        .mod-popup-silver .mod-popup-title {
            color: #707070;
            text-shadow: 0 0 3px rgba(192, 192, 192, 0.5);
        }

        /* Bronze card popup styling */
        .mod-popup-bronze {
            background: linear-gradient(135deg, #f5e6d8 0%, #e6d0c0 100%);
            border: 2px solid rgba(205, 127, 50, 0.6);
        }

        .mod-popup-bronze .mod-popup-title {
            color: #8b4513;
            text-shadow: 0 0 3px rgba(205, 127, 50, 0.5);
        }

        /* Blue card popup styling */
        .mod-popup-blue {
            background: linear-gradient(135deg, #e6f2ff 0%, #d0e6ff 100%);
            border: 2px solid rgba(70, 130, 180, 0.5);
        }

        .mod-popup-blue .mod-popup-title {
            color: #4682b4;
            text-shadow: 0 0 3px rgba(70, 130, 180, 0.5);
        }

        /* Mods Button Styles */
        .mods-button {
    position: fixed;
    top: 0px; /* Fixed to the top */
    right: 20px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    border: none;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(155, 89, 182, 0.5);
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
}

        .mods-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.7);
        }

        .mods-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: skewX(-25deg);
            animation: lightEffect 3s infinite;
        }

        @keyframes lightEffect {
            0% {
                left: -100%;
            }
            100% {
                left: 200%;
            }
        }

        body {
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            /* overflow: hidden;  REMOVED overflow: hidden; from body style */
            display: none; /* ADD THIS LINE: Initially hide the body */
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            align-items: center;
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            transition: color 0.3s ease;
        }

        .menu-item:hover, .menu-item.active {
            color: #333;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-icon {
            font-size: 42px;
            color: #2176ff;
            transform: translateY(-3px);
            filter: drop-shadow(0 0 8px rgba(33, 118, 255, 0.4));
            transition: all 0.3s ease;
        }

        .empire-icon:hover {
            color: #0056d6;
            transform: translateY(-8px);
            filter: drop-shadow(0 0 12px rgba(33, 118, 255, 0.6));
        }

        .content {
            padding: 20px;
            margin-bottom: 80px;
            display: none; /* Oculta o conteúdo inicialmente */
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #games-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 10px;
        }

        .game-card {
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08), 0 6px 6px rgba(0, 0, 0, 0.12);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .game-card.voted {
            background: linear-gradient(to bottom right, #f0fff4, #dcffe4);
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .vote-status-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 18px;
            z-index: 2;
        }

        .vote-status-icon.voted {
            color: #28a745;
        }

        .vote-status-icon.pending {
            color: #ffc107;
        }

        .round-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2176ff, #1a5cc4);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(33, 118, 255, 0.3);
            letter-spacing: 0.5px;
        }

        .game-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12), 0 8px 8px rgba(0, 0, 0, 0.08);
        }

        .teams-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .team-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 12px;
            border: 3px solid #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .team-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .team-name {
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
        }

        .vs {
            margin: 0 15px;
            font-weight: bold;
            color: #666;
        }

        .competition-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .competition-image {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }

        .competition-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .competition-details {
            flex: 1;
        }

        .competition-name {
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
        }

        .round {
            color: #666;
            font-size: 0.8em;
        }

        .predict-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #2176ff, #1a5cc4);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(33, 118, 255, 0.2);
        }

        .predict-button:hover {
            background: linear-gradient(135deg, #1a5cc4, #0d4cb3);
            box-shadow: 0 6px 8px rgba(33, 118, 255, 0.3);
            transform: translateY(-2px);
        }

        .game-datetime {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .no-games, .error {
            text-align: center;
            color: #666;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin: 20px 0;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
        }

        /* Tela de carregamento */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0; /* Cor de fundo da tela de carregamento */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Garante que está acima de tudo */
        }

        .loading-spinner {
            border: 16px solid #f3f3f3; /* Cinza claro */
            border-top: 16px solid #3498db; /* Azul */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <!-- Mod Icon Animation Container -->
    <div id="mod-icon-container" class="mod-icon-container">
        <img id="mod-icon-animation" class="mod-icon-animation" src="" alt="Mod Icon">
    </div>

    <!-- Mod Popup Overlay -->
    <div id="mod-popup-overlay" class="mod-popup-overlay">
        <div class="mod-popup-content">
            <button class="mod-popup-close">
                <i class="fas fa-times"></i>
            </button>
            <div class="mod-popup-header">
                <div class="mod-popup-image-container">
                    <img src="" alt="" class="mod-popup-image" id="popup-mod-image">
                </div>
                <h2 class="mod-popup-title" id="popup-mod-title"></h2>
                <span class="new-mod-badge">NEW MOD</span>
            </div>
            <div class="mod-popup-info">
                <div class="mod-popup-overall">
                    <span class="overall-label">Overall:</span>
                    <span class="overall-value" id="popup-mod-overall"></span>
                </div>
                <div class="mod-popup-points">
                    <span class="mod-popup-points-gain" id="popup-mod-points-gain"></span>
                    <span class="mod-popup-points-loss" id="popup-mod-points-loss"></span>
                </div>
            </div>
            <div id="popup-mod-video" class="mod-popup-video"></div>
            <button id="popup-mod-analyze" class="mod-popup-analyze">Analisar</button>
        </div>
    </div>

    <a href="mods.html" class="mods-button">
        <i class="fas fa-star"></i>
        Mods
    </a>

    <div class="content">
        <h1>1x WhatIf...</h1>
        <div id="games-container">
            <!-- Jogos serão carregados aqui dinamicamente -->
        </div>
    </div>

    <nav class="bottom-menu">
        <a href="1x.html" class="menu-item active">
            <i class="fas fa-home"></i>
        </a>
        <a href="market.html" class="menu-item">
            <i class="fas fa-shopping-cart"></i>
        </a>
        <a href="team.html" class="menu-item">
            <i class="fas fa-users"></i>
        </a>
        <a href="empire.html" class="menu-item">
            <i class="fas fa-landmark empire-icon"></i>
        </a>
        <a href="rankings.html" class="menu-item">
            <i class="fas fa-list"></i>
        </a>
        <a href="profile.html" class="menu-item">
            <i class="fas fa-user"></i>
        </a>
    </nav>
<script src="config.js"></script>
    <script type="module">
        // Importar funções do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

             // Inicializar Firebase
        // A variável 'firebaseConfig' vem do ficheiro config.js
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserStatus = null;
        let menuVisibilitySettings = null;
        const loadingScreen = document.getElementById('loading-screen');
        const content = document.querySelector('.content');

        // Função para carregar configurações do menu
        async function loadMenuSettings() {
            try {
                const menuSettingsDocRef = doc(db, 'paineis', 'paineis menu');
                const docSnap = await getDoc(menuSettingsDocRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    return {}; // Return empty object to avoid errors
                }
            } catch (error) {
                return {}; // Return empty object to avoid errors
            }
        }

        // Função para verificar acesso à página
        async function checkPageAccess(userStatus, menuSettings) {
            if (!menuSettings || menuSettings['1x'] !== 'on') {
                if (!userStatus || userStatus !== 'ruler') { // Changed to check userStatus directly
                    window.location.href = '404.html.html';
                    return false;
                }
            }
            return true;
        }

        // Função para atualizar visibilidade do menu
        function updateMenuVisibility(menuSettings) {
            if (!menuSettings) return;

            const menuItems = {
                '1x': document.querySelector('a[href="1x.html"]'),
                'bank': document.querySelector('a[href="bank.html"]'),
                'empire': document.querySelector('a[href="empire.html"]'),
                'market': document.querySelector('a[href="market.html"]'),
                'profile': document.querySelector('a[href="profile.html"]'),
                'rankings': document.querySelector('a[href="rankings.html"]'),
                'team': document.querySelector('a[href="team.html"]')
            };

            for (const [key, element] of Object.entries(menuItems)) {
                if (element && menuSettings[key] === 'off') {
                    element.style.display = 'none';
                } else if (element) {
                    element.style.display = ''; // Ensure it's visible if setting is 'on' or missing
                }
            }
        }

        // Função para obter o estatuto e aceite do usuário do Firestore
        async function getUserStatus(userId) {
            const userDoc = doc(db, 'users', userId);
            const docSnap = await getDoc(userDoc);
            if (docSnap.exists()) {
                const userData = docSnap.data();
                return {
                    estatuto: userData.estatuto,
                    aceite: userData.aceite
                };
            } else {
                return null;
            }
        }

        // Função para verificar acesso e configurar menu
        async function setupPageAccess() {
            try {
                const menuSettings = await loadMenuSettings();
                const hasPageAccess = await checkPageAccess(currentUserStatus, menuSettings);
                if (!hasPageAccess) {
                    return;
                }
                updateMenuVisibility(menuSettings);
            } catch (error) {
                window.location.href = '404.html';
            }
        }

        // Função para carregar jogos ativos
        async function loadActiveGames() {
            const gamesContainer = document.getElementById('games-container');
            const now = new Date();

            try {
                const gamesRef = collection(db, 'jogos');
                const querySnapshot = await getDocs(gamesRef);
                const activeGames = [];

                for (const gameDoc of querySnapshot.docs) {
                    const game = gameDoc.data();
                    if (!game.inicioIntervalo || !game.fimIntervalo) {
                        continue;
                    }
                    const inicioPalpites = game.inicioIntervalo.toDate();
                    const fimPalpites = game.fimIntervalo.toDate();

                    if (now >= inicioPalpites && now <= fimPalpites) {
                        if (auth.currentUser) {
                            try {
                                const userPalpitesRef = collection(doc(db, 'users', auth.currentUser.uid), 'palpites');
                                const q = query(userPalpitesRef, where('jogoId', '==', gameDoc.id));
                                const palpiteSnapshot = await getDocs(q);
                                game.hasVoted = !palpiteSnapshot.empty;
                            } catch (error) {
                                game.hasVoted = false;
                            }
                        } else {
                            game.hasVoted = false;
                        }

                        if (typeof db === 'undefined' || db === null) {
                            continue;
                        }

                        let equipaCasaIdString = game.equipaCasaId;
                        if (typeof equipaCasaIdString !== 'string' || !equipaCasaIdString) {
                            continue;
                        }

                        let equipaForaIdString = game.equipaForaId;
                        if (typeof equipaForaIdString !== 'string' || !equipaForaIdString) {
                            continue;
                        }

                        let competicaoIdString = game.competicaoId;
                        if (typeof competicaoIdString !== 'string' || !competicaoIdString) {
                            continue;
                        }
                        
                        const equipaCasaRef = doc(db, 'clubes', equipaCasaIdString);
                        const equipaCasaDoc = await getDoc(equipaCasaRef);
                        const equipaCasaData = equipaCasaDoc.data();
                        game.equipaCasaImagem = equipaCasaData?.imagem || 'https://via.placeholder.com/50';

                        const equipaForaRef = doc(db, 'clubes', equipaForaIdString);
                        const equipaForaDoc = await getDoc(equipaForaRef);
                        const equipaForaData = equipaForaDoc.data();
                        if (equipaForaData) {
                            game.equipaForaImagem = equipaForaData.imagem || 'https://via.placeholder.com/50';
                        } else {
                            game.equipaForaImagem = 'https://via.placeholder.com/50';
                        }

                        const competicaoRef = doc(db, 'competicoes', competicaoIdString);
                        const competicaoDoc = await getDoc(competicaoRef);
                        const competicaoData = competicaoDoc.data();
                        game.competicaoImagem = competicaoData?.imagem || 'https://via.placeholder.com/30';

                        activeGames.push({ id: gameDoc.id, ...game });
                    }
                }

                if (activeGames.length === 0) {
                    gamesContainer.innerHTML = '<p class="no-games">Não há jogos disponíveis para palpites no momento.</p>';
                    return;
                }

                gamesContainer.innerHTML = '';
                for (const game of activeGames) {
                    const card = document.createElement('div');
                    card.className = `game-card${game.hasVoted ? ' voted' : ''}`;

                    card.innerHTML = `
                        <i class="vote-status-icon fas ${game.hasVoted ? 'fa-check voted' : 'fa-hourglass-half pending'}"></i>
                        <div class="round-badge">Ronda ${game.ronda}</div>
                        <div class="teams-container">
                            <div class="team">
                                <div class="team-image">
                                    <img src="${game.equipaCasaImagem || 'https://via.placeholder.com/50'}" alt="${game.equipaCasa}">
                                </div>
                                <div class="team-name">${game.equipaCasa}</div>
                            </div>
                            <div class="vs">VS</div>
                            <div class="team">
                                <div class="team-image">
                                    <img src="${game.equipaForaImagem || 'https://via.placeholder.com/50'}" alt="${game.equipaFora}">
                                </div>
                                <div class="team-name">${game.equipaFora}</div>
                            </div>
                        </div>
                        <div class="game-datetime">${game.dataJogo?.toDate()?.toLocaleDateString('pt-PT')} - ${game.dataJogo?.toDate()?.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' })}</div>
                        <div class="competition-info">
                            <div class="competition-image">
                                <img src="${game.competicaoImagem || 'https://via.placeholder.com/30'}" alt="${game.competicao}">
                            </div>
                            <div class="competition-details">
                                <div class="competition-name">${game.competicao}</div>
                            </div>
                        </div>
                        <button class="predict-button" onclick="window.location.href='palpite.html?id=${game.id}'">${game.hasVoted ? 'Ver Palpite' : 'Palpitar'}</button>
                    `;

                    gamesContainer.appendChild(card);
                }
            } catch (error) {
                gamesContainer.innerHTML = '<p class="error">Erro ao carregar os jogos. Por favor, tente novamente mais tarde.</p>';
            } finally {
                loadingScreen.style.display = 'none';
                content.style.display = 'block';
            }
        }

        // Função para abrir o popup de um mod
        async function openModPopup(modId) {
            try {
                const modDocRef = doc(db, 'mods', modId);
                const modDocSnap = await getDoc(modDocRef);

                if (!modDocSnap.exists()) {
                    return;
                }

                const modData = modDocSnap.data();
                const popupOverlay = document.getElementById('mod-popup-overlay');
                const popupContent = popupOverlay.querySelector('.mod-popup-content');

                document.querySelector('.mod-popup-image-container').style.display = 'none';
                document.getElementById('popup-mod-title').textContent = modData.nomeMod || 'Mod sem nome';
                document.getElementById('popup-mod-overall').textContent = modData.overall || 'N/A';
                document.getElementById('popup-mod-points-gain').textContent = `${modData.possivelVitoria || '0'} pts`;
                document.getElementById('popup-mod-points-loss').textContent = `${modData.possivelDerrota || '0'} pts`;

                const videoContainer = document.getElementById('popup-mod-video');
                if (modData.videoMod) {
                    videoContainer.innerHTML = `<iframe src="${modData.videoMod}" allowfullscreen scrolling="no"></iframe>`;
                    videoContainer.style.display = 'block';
                } else if (modData.videoUrl) {
                    videoContainer.innerHTML = `<iframe src="${modData.videoUrl}" allowfullscreen scrolling="no"></iframe>`;
                    videoContainer.style.display = 'block';
                } else {
                    videoContainer.innerHTML = '';
                    videoContainer.style.display = 'none';
                }

                const analyzeButton = document.getElementById('popup-mod-analyze');
                if (analyzeButton) {
                    analyzeButton.onclick = async function() {
                        try {
                            const userId = auth.currentUser ? auth.currentUser.uid : null;
                            if (!userId) {
                                return;
                            }
                            let multiUsersMod = modData.multiUsersMod || [];
                            if (!multiUsersMod.includes(userId)) {
                                multiUsersMod.push(userId);
                                await updateDoc(modDocRef, {
                                    multiUsersMod: multiUsersMod
                                });
                            }
                            localStorage.setItem('openModId', modId);
                            window.location.href = 'mods.html';
                        } catch (error) {
                            // Silently fail or handle error appropriately
                        }
                    };
                }

                popupContent.className = 'mod-popup-content';
                const overall = parseInt(modData.overall) || 0;
                if (overall >= 90) {
                    popupContent.classList.add('mod-popup-gold');
                } else if (overall >= 80) {
                    popupContent.classList.add('mod-popup-silver');
                } else if (overall >= 70) {
                    popupContent.classList.add('mod-popup-bronze');
                } else {
                    popupContent.classList.add('mod-popup-blue');
                }

                const iconContainer = document.getElementById('mod-icon-container');
                const iconAnimation = document.getElementById('mod-icon-animation');
                iconAnimation.src = modData.icon || 'https://firebasestorage.googleapis.com/v0/b/giria-games.appspot.com/o/default-mod-icon.png?alt=media';
                iconContainer.classList.add('active');

                await new Promise(resolve => setTimeout(resolve, 3500));
                iconContainer.style.transition = 'opacity 0.5s ease';
                iconContainer.style.opacity = '0';
                await new Promise(resolve => setTimeout(resolve, 500));
                iconContainer.classList.remove('active');
                iconContainer.style.opacity = '';

                popupOverlay.classList.add('active');
            } catch (error) {
                // Silently fail or handle error appropriately
            }
        }

        // Função para verificar e exibir mods disponíveis para o usuário
        async function checkAndDisplayMods() {
            try {
                if (!auth.currentUser) {
                    return;
                }

                const userId = auth.currentUser.uid;
                const modsCollection = collection(db, 'mods');
                const modsQuery = query(modsCollection, where("ativo", "==", "yes"));
                const modsSnapshot = await getDocs(modsQuery);

                if (modsSnapshot.empty) {
                    return;
                }

                const now = new Date();
                let modFound = false;

                for (const modDoc of modsSnapshot.docs) {
                    const modData = modDoc.data();
                    let isInDateRange = false;

                    if (modData.dataInicioNovoMod && modData.dataFimNovoMod) {
                        try {
                            const isStartDateTimestamp = typeof modData.dataInicioNovoMod.toDate === 'function';
                            const isEndDateTimestamp = typeof modData.dataFimNovoMod.toDate === 'function';
                            if (isStartDateTimestamp && isEndDateTimestamp) {
                                const startDate = modData.dataInicioNovoMod.toDate();
                                const endDate = modData.dataFimNovoMod.toDate();
                                isInDateRange = now >= startDate && now <= endDate;
                            }
                        } catch (dateError) {
                            isInDateRange = false;
                        }
                    }

                    let isForUser = true;
                    if (modData.multiUsersMod) {
                        isForUser = !modData.multiUsersMod.includes(userId);
                    }

                    if (isInDateRange && isForUser) {
                        modFound = true;
                        openModPopup(modDoc.id);
                        break;
                    }
                }
            } catch (error) {
                // Silently fail or handle error appropriately
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userInfo = await getUserStatus(user.uid);
                if (userInfo && userInfo.aceite === "Yes") {
                    currentUserStatus = userInfo.estatuto;
                    await setupPageAccess();
                    loadActiveGames();
                    document.body.style.display = 'block';
                    await checkAndDisplayMods();
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // Adicionar event listeners para o popup de mod
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('mod-popup-close') || event.target.closest('.mod-popup-close')) {
                document.getElementById('mod-popup-overlay').classList.remove('active');
            }
        });

        document.getElementById('mod-popup-overlay').addEventListener('click', function(event) {
            if (event.target === this) {
                this.classList.remove('active');
            }
        });

    </script>
</body>
</html>
